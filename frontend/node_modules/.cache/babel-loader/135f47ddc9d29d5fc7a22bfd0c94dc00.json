{"remainingRequest":"/Users/huntermedlen/Work/WebApps/music-trainer/node_modules/babel-loader/lib/index.js!/Users/huntermedlen/Work/WebApps/music-trainer/src/webmidi.js","dependencies":[{"path":"/Users/huntermedlen/Work/WebApps/music-trainer/src/webmidi.js","mtime":1588452799777},{"path":"/Users/huntermedlen/Work/WebApps/music-trainer/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/huntermedlen/Work/WebApps/music-trainer/node_modules/babel-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:cmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmNvbmNhdCIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmV2ZXJ5Iik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuZmlsdGVyIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuZm9yLWVhY2giKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5pbmRleC1vZiIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmlzLWFycmF5Iik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkubWFwIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuc3BsaWNlIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuZnVuY3Rpb24uYmluZCIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmZ1bmN0aW9uLm5hbWUiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5udW1iZXIudG8tZml4ZWQiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5vYmplY3QuZGVmaW5lLXByb3BlcnRpZXMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5vYmplY3QudG8tc3RyaW5nIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMucGFyc2UtZmxvYXQiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5wYXJzZS1pbnQiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5yZWdleHAuZXhlYyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnN0cmluZy5pdGVyYXRvciIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnN0cmluZy5tYXRjaCIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL3dlYi5kb20tY29sbGVjdGlvbnMuZm9yLWVhY2giKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy93ZWIuZG9tLWNvbGxlY3Rpb25zLml0ZXJhdG9yIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvd2ViLnRpbWVycyIpOwoKdmFyIF90eXBlb2YgPSByZXF1aXJlKCIvVXNlcnMvaHVudGVybWVkbGVuL1dvcmsvV2ViQXBwcy9tdXNpYy10cmFpbmVyL25vZGVfbW9kdWxlcy9AYmFiZWwvcnVudGltZS9oZWxwZXJzL3R5cGVvZiIpOwoKKGZ1bmN0aW9uIChzY29wZSkgewogICJ1c2Ugc3RyaWN0IjsKICAvKioKICAgKiBUaGUgYFdlYk1pZGlgIG9iamVjdCBtYWtlcyBpdCBlYXNpZXIgdG8gd29yayB3aXRoIHRoZSBXZWIgTUlESSBBUEkuIEJhc2ljYWxseSwgaXQgc2ltcGxpZmllcwogICAqIHR3byB0aGluZ3M6IHNlbmRpbmcgb3V0Z29pbmcgTUlESSBtZXNzYWdlcyBhbmQgcmVhY3RpbmcgdG8gaW5jb21pbmcgTUlESSBtZXNzYWdlcy4KICAgKgogICAqIFNlbmRpbmcgTUlESSBtZXNzYWdlcyBpcyBkb25lIHZpYSBhbiBgT3V0cHV0YCBvYmplY3QuIEFsbCBhdmFpbGFibGUgb3V0cHV0cyBjYW4gYmUgYWNjZXNzZWQgaW4KICAgKiB0aGUgYFdlYk1pZGkub3V0cHV0c2AgYXJyYXkuIFRoZXJlIGlzIG9uZSBgT3V0cHV0YCBvYmplY3QgZm9yIGVhY2ggb3V0cHV0IHBvcnQgYXZhaWxhYmxlIG9uCiAgICogeW91ciBzeXN0ZW0uIFNpbWlsYXJseSwgcmVhY3RpbmcgdG8gTUlESSBtZXNzYWdlcyBhcyB0aGV5IGFyZSBjb21pbmcgaW4gaXMgc2ltcGx5IGEgbWF0dGVyIG9mCiAgICogYWRkaW5nIGEgbGlzdGVuZXIgdG8gYW4gYElucHV0YCBvYmplY3QuIFNpbWlsYXJseSwgYWxsIGlucHV0cyBjYW4gYmUgZm91bmQgaW4gdGhlCiAgICogYFdlYk1pZGkuaW5wdXRzYCBhcnJheS4KICAgKgogICAqIFBsZWFzZSBub3RlIHRoYXQgYSBzaW5nbGUgaGFyZHdhcmUgZGV2aWNlIG1pZ2h0IGNyZWF0ZSBtb3JlIHRoYW4gb25lIGlucHV0IGFuZC9vciBvdXRwdXQgcG9ydHMuCiAgICoKICAgKiAjIyMjIFNlbmRpbmcgbWVzc2FnZXMKICAgKgogICAqIFRvIHNlbmQgTUlESSBtZXNzYWdlcywgeW91IHNpbXBseSBuZWVkIHRvIGNhbGwgdGhlIGRlc2lyZWQgbWV0aG9kIChgcGxheU5vdGUoKWAsCiAgICogYHNlbmRQaXRjaEJlbmQoKWAsIGBzdG9wTm90ZSgpYCwgZXRjLikgZnJvbSBhbiBgT3V0cHV0YCBvYmplY3QgYW5kIHBhc3MgaW4gdGhlIGFwcHJvcHJpYXRlCiAgICogcGFyYW1ldGVycy4gQWxsIHRoZSBuYXRpdmUgTUlESSBjb21tdW5pY2F0aW9uIHdpbGwgYmUgaGFuZGxlZCBmb3IgeW91LiBUaGUgb25seSBhZGRpdGlvbmFsCiAgICogdGhpbmcgdGhhdCBuZWVkcyB0byBiZSBkb25lIGlzIHRvIGZpcnN0IGVuYWJsZSBgV2ViTWlkaWAuIEhlcmUgaXMgYW4gZXhhbXBsZToKICAgKgogICAqICAgICAgV2ViTWlkaS5lbmFibGUoZnVuY3Rpb24oZXJyKSB7CiAgICogICAgICAgIGlmIChlcnIpIGNvbnNvbGUubG9nKCJBbiBlcnJvciBvY2N1cnJlZCIsIGVycik7CiAgICogICAgICAgIFdlYk1pZGkub3V0cHV0c1swXS5wbGF5Tm90ZSgiQzMiKTsKICAgKiAgICAgIH0pOwogICAqCiAgICogVGhlIGNvZGUgYWJvdmUsIGNhbGxzIHRoZSBgV2ViTWlkaS5lbmFibGUoKWAgbWV0aG9kLiBVcG9uIHN1Y2Nlc3MsIHRoaXMgbWV0aG9kIGV4ZWN1dGVzIHRoZQogICAqIGNhbGxiYWNrIGZ1bmN0aW9uIHNwZWNpZmllZCBhcyBhIHBhcmFtZXRlci4gSW4gdGhpcyBjYXNlLCB0aGUgY2FsbGJhY2sgY2FsbHMgdGhlIGBwbGF5bm90ZSgpYAogICAqIGZ1bmN0aW9uIHRvIHBsYXkgYSAzcmQgb2N0YXZlIEMgb24gdGhlIGZpcnN0IGF2YWlsYWJsZSBvdXRwdXQgcG9ydC4KICAgKgogICAqICMjIyMgUmVjZWl2aW5nIG1lc3NhZ2VzCiAgICoKICAgKiBSZWNlaXZpbmcgbWVzc2FnZXMgaXMganVzdCBhcyBlYXN5LiBZb3Ugc2ltcGx5IGhhdmUgdG8gc2V0IGEgY2FsbGJhY2sgZnVuY3Rpb24gdG8gYmUgdHJpZ2dlcmVkCiAgICogd2hlbiBhIHNwZWNpZmljIE1JREkgbWVzc2FnZSBpcyByZWNlaXZlZC4gRm9yIGV4YW1wbGUsIGhlcmUicyBob3cgdG8gbGlzdGVuIGZvciBwaXRjaCBiZW5kCiAgICogZXZlbnRzIG9uIHRoZSBmaXJzdCBpbnB1dCBwb3J0OgogICAqCiAgICogICAgICBXZWJNaWRpLmVuYWJsZShmdW5jdGlvbihlcnIpIHsKICAgKiAgICAgICAgaWYgKGVycikgY29uc29sZS5sb2coIkFuIGVycm9yIG9jY3VycmVkIiwgZXJyKTsKICAgKgogICAqICAgICAgICBXZWJNaWRpLmlucHV0c1swXS5hZGRMaXN0ZW5lcigicGl0Y2hiZW5kIiwgImFsbCIsIGZ1bmN0aW9uKGUpIHsKICAgKiAgICAgICAgICBjb25zb2xlLmxvZygiUGl0Y2ggdmFsdWU6ICIgKyBlLnZhbHVlKTsKICAgKiAgICAgICAgfSk7CiAgICoKICAgKiAgICAgIH0pOwogICAqCiAgICogQXMgeW91IGNhbiBzZWUsIHRoaXMgbGlicmFyeSBpcyBtdWNoIGVhc2llciB0byB1c2UgdGhhbiB0aGUgbmF0aXZlIFdlYiBNSURJIEFQSS4gTm8gbmVlZCB0bwogICAqIG1hbnVhbGx5IGNyYWZ0IG9yIGRlY29kZSBiaW5hcnkgTUlESSBtZXNzYWdlcyBhbnltb3JlIQogICAqCiAgICogQGNsYXNzIFdlYk1pZGkKICAgKiBAc3RhdGljCiAgICoKICAgKiBAdGhyb3dzIEVycm9yIFdlYk1pZGkgaXMgYSBzaW5nbGV0b24sIGl0IGNhbm5vdCBiZSBpbnN0YW50aWF0ZWQgZGlyZWN0bHkuCiAgICoKICAgKiBAdG9kbyAgU3dpdGNoIGF3YXkgZnJvbSB5dWlkb2MgKGRlcHJlY2F0ZWQpIHRvIGJlIGFibGUgdG8gc2VydmUgZG9jIG92ZXIgaHR0cHMKICAgKiBAdG9kbyAgWXVpZG9jIGRvZXMgbm90IGFsbG93IG11bHRpcGxlIGV4Y2VwdGlvbnMgKEB0aHJvd3MpIGZvciBhIHNpbmdsZSBtZXRob2QgPyEKICAgKgogICAqLwoKICBmdW5jdGlvbiBXZWJNaWRpKCkgewogICAgLy8gU2luZ2xldG9uLiBQcmV2ZW50IGluc3RhbnRpYXRpb24gdGhyb3VnaCBXZWJNaWRpLl9fcHJvdG9fXy5jb25zdHJ1Y3RvcigpCiAgICBpZiAoV2ViTWlkaS5wcm90b3R5cGUuX3NpbmdsZXRvbikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIldlYk1pZGkgaXMgYSBzaW5nbGV0b24sIGl0IGNhbm5vdCBiZSBpbnN0YW50aWF0ZWQgZGlyZWN0bHkuIik7CiAgICB9CgogICAgV2ViTWlkaS5wcm90b3R5cGUuX3NpbmdsZXRvbiA9IHRoaXM7IC8vIE1JREkgaW5wdXRzIGFuZCBvdXRwdXRzCgogICAgdGhpcy5faW5wdXRzID0gW107CiAgICB0aGlzLl9vdXRwdXRzID0gW107IC8vIE9iamVjdCB0byBob2xkIGFsbCB1c2VyLWRlZmluZWQgaGFuZGxlcnMgZm9yIGludGVyZmFjZS13aWRlIGV2ZW50cyAoY29ubmVjdGVkLCBkaXNjb25uZWN0ZWQsCiAgICAvLyBldGMuKQoKICAgIHRoaXMuX3VzZXJIYW5kbGVycyA9IHt9OyAvLyBBcnJheSBvZiBzdGF0ZWNoYW5nZSBldmVudHMgdG8gcHJvY2Vzcy4gVGhlc2UgZXZlbnRzIG11c3QgYmUgcGFyc2VkIHN5bmNocm9ub3VzbHkgc28gdGhleSBkbwogICAgLy8gbm90IG92ZXJyaWRlIGVhY2ggb3RoZXIuCgogICAgdGhpcy5fc3RhdGVDaGFuZ2VRdWV1ZSA9IFtdOyAvLyBJbmRpY2F0ZXMgd2hldGhlciB3ZSBhcmUgY3VycmVudGx5IHByb2Nlc3NpbmcgYSBzdGF0ZWNoYW5nZSBldmVudCAoaW4gd2hpY2ggY2FzZSBuZXcgZXZlbnRzCiAgICAvLyBhcmUgdG8gYmUgcXVldWVkKS4KCiAgICB0aGlzLl9wcm9jZXNzaW5nU3RhdGVDaGFuZ2UgPSBmYWxzZTsgLy8gRXZlbnRzIHRyaWdnZXJlZCBhdCB0aGUgaW50ZXJmYWNlIGxldmVsIChXZWJNaWRpKQoKICAgIHRoaXMuX21pZGlJbnRlcmZhY2VFdmVudHMgPSBbImNvbm5lY3RlZCIsICJkaXNjb25uZWN0ZWQiXTsgLy8gdGhlIGN1cnJlbnQgbnJwbnMgYmVpbmcgY29uc3RydWN0ZWQsIGJ5IGNoYW5uZWwKCiAgICB0aGlzLl9ucnBuQnVmZmVyID0gW1tdLCBbXSwgW10sIFtdLCBbXSwgW10sIFtdLCBbXSwgW10sIFtdLCBbXSwgW10sIFtdLCBbXSwgW10sIFtdXTsgLy8gRW5hYmxlL0Rpc2FibGUgTlJQTiBldmVudCBkaXNwYXRjaAoKICAgIHRoaXMuX25ycG5FdmVudHNFbmFibGVkID0gdHJ1ZTsgLy8gTlJQTiBtZXNzYWdlIHR5cGVzCgogICAgdGhpcy5fbnJwblR5cGVzID0gWyJlbnRyeSIsICJpbmNyZW1lbnQiLCAiZGVjcmVtZW50Il07IC8vIE5vdGVzIGFuZCBzZW1pdG9uZXMgZm9yIG5vdGUgZ3Vlc3NpbmcKCiAgICB0aGlzLl9ub3RlcyA9IFsiQyIsICJDIyIsICJEIiwgIkQjIiwgIkUiLCAiRiIsICJGIyIsICJHIiwgIkcjIiwgIkEiLCAiQSMiLCAiQiJdOwogICAgdGhpcy5fc2VtaXRvbmVzID0gewogICAgICBDOiAwLAogICAgICBEOiAyLAogICAgICBFOiA0LAogICAgICBGOiA1LAogICAgICBHOiA3LAogICAgICBBOiA5LAogICAgICBCOiAxMQogICAgfTsgLy8gRGVmaW5lIHNvbWUgInN0YXRpYyIgcHJvcGVydGllcwoKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKHRoaXMsIHsKICAgICAgLyoqCiAgICAgICAqIFtyZWFkLW9ubHldIExpc3Qgb2YgdmFsaWQgTUlESSBzeXN0ZW0gbWVzc2FnZXMgYW5kIG1hdGNoaW5nIGhleGFkZWNpbWFsIHZhbHVlcy4KICAgICAgICoKICAgICAgICogTm90ZTogdmFsdWVzIDI0OSBhbmQgMjUzIGFyZSBhY3R1YWxseSBkaXNwYXRjaGVkIGJ5IHRoZSBXZWIgTUlESSBBUEkgYnV0IEkgZG8gbm90IGtub3cgd2hhdAogICAgICAgKiB0aGV5IGFyZSB1c2VkIGZvci4gVGhleSBhcmUgbm90IHBhcnQgb2YgdGhlIG9ubGluZQogICAgICAgKiBbTUlESSAxLjAgc3BlY10oaHR0cDovL3d3dy5taWRpLm9yZy90ZWNoc3BlY3MvbWlkaW1lc3NhZ2VzLnBocCkuCiAgICAgICAqCiAgICAgICAqIEBwcm9wZXJ0eSBNSURJX1NZU1RFTV9NRVNTQUdFUwogICAgICAgKiBAdHlwZSBPYmplY3QKICAgICAgICogQHN0YXRpYwogICAgICAgKgogICAgICAgKiBAc2luY2UgMi4wLjAKICAgICAgICovCiAgICAgIE1JRElfU1lTVEVNX01FU1NBR0VTOiB7CiAgICAgICAgdmFsdWU6IHsKICAgICAgICAgIC8vIFN5c3RlbSBjb21tb24gbWVzc2FnZXMKICAgICAgICAgIHN5c2V4OiAweEYwLAogICAgICAgICAgLy8gMjQwCiAgICAgICAgICB0aW1lY29kZTogMHhGMSwKICAgICAgICAgIC8vIDI0MQogICAgICAgICAgc29uZ3Bvc2l0aW9uOiAweEYyLAogICAgICAgICAgLy8gMjQyCiAgICAgICAgICBzb25nc2VsZWN0OiAweEYzLAogICAgICAgICAgLy8gMjQzCiAgICAgICAgICB0dW5pbmdyZXF1ZXN0OiAweEY2LAogICAgICAgICAgLy8gMjQ2CiAgICAgICAgICBzeXNleGVuZDogMHhGNywKICAgICAgICAgIC8vIDI0NyAobmV2ZXIgYWN0dWFsbHkgcmVjZWl2ZWQgLSBzaW1wbHkgZW5kcyBhIHN5c2V4KQogICAgICAgICAgLy8gU3lzdGVtIHJlYWwtdGltZSBtZXNzYWdlcwogICAgICAgICAgY2xvY2s6IDB4RjgsCiAgICAgICAgICAvLyAyNDgKICAgICAgICAgIHN0YXJ0OiAweEZBLAogICAgICAgICAgLy8gMjUwCiAgICAgICAgICAiY29udGludWUiOiAweEZCLAogICAgICAgICAgLy8gMjUxCiAgICAgICAgICBzdG9wOiAweEZDLAogICAgICAgICAgLy8gMjUyCiAgICAgICAgICBhY3RpdmVzZW5zaW5nOiAweEZFLAogICAgICAgICAgLy8gMjU0CiAgICAgICAgICByZXNldDogMHhGRiwKICAgICAgICAgIC8vIDI1NQogICAgICAgICAgLy8gQ3VzdG9tIFdlYk1pZGkuanMgbWVzc2FnZXMKICAgICAgICAgIG1pZGltZXNzYWdlOiAwLAogICAgICAgICAgdW5rbm93bnN5c3RlbW1lc3NhZ2U6IC0xCiAgICAgICAgfSwKICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlCiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogW3JlYWQtb25seV0gQW4gb2JqZWN0IGNvbnRhaW5pbmcgcHJvcGVydGllcyBmb3IgZWFjaCBNSURJIGNoYW5uZWwgbWVzc2FnZXMgYW5kIHRoZWlyCiAgICAgICAqIGFzc29jaWF0ZWQgaGV4YWRlY2ltYWwgdmFsdWUuCiAgICAgICAqCiAgICAgICAqIEBwcm9wZXJ0eSBNSURJX0NIQU5ORUxfTUVTU0FHRVMKICAgICAgICogQHR5cGUgT2JqZWN0CiAgICAgICAqIEBzdGF0aWMKICAgICAgICoKICAgICAgICogQHNpbmNlIDIuMC4wCiAgICAgICAqLwogICAgICBNSURJX0NIQU5ORUxfTUVTU0FHRVM6IHsKICAgICAgICB2YWx1ZTogewogICAgICAgICAgbm90ZW9mZjogMHg4LAogICAgICAgICAgLy8gOAogICAgICAgICAgbm90ZW9uOiAweDksCiAgICAgICAgICAvLyA5CiAgICAgICAgICBrZXlhZnRlcnRvdWNoOiAweEEsCiAgICAgICAgICAvLyAxMAogICAgICAgICAgY29udHJvbGNoYW5nZTogMHhCLAogICAgICAgICAgLy8gMTEKICAgICAgICAgIGNoYW5uZWxtb2RlOiAweEIsCiAgICAgICAgICAvLyAxMQogICAgICAgICAgbnJwbjogMHhCLAogICAgICAgICAgLy8gMTEKICAgICAgICAgIHByb2dyYW1jaGFuZ2U6IDB4QywKICAgICAgICAgIC8vIDEyCiAgICAgICAgICBjaGFubmVsYWZ0ZXJ0b3VjaDogMHhELAogICAgICAgICAgLy8gMTMKICAgICAgICAgIHBpdGNoYmVuZDogMHhFIC8vIDE0CgogICAgICAgIH0sCiAgICAgICAgd3JpdGFibGU6IGZhbHNlLAogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIFtyZWFkLW9ubHldIEFuIG9iamVjdCBjb250YWluaW5nIHByb3BlcnRpZXMgZm9yIGVhY2ggcmVnaXN0ZXJlZCBwYXJhbWV0ZXJzIGFuZCB0aGVpcgogICAgICAgKiBhc3NvY2lhdGVkIHBhaXIgb2YgaGV4YWRlY2ltYWwgdmFsdWVzLiBNSURJIHJlZ2lzdGVyZWQgcGFyYW1ldGVycyBleHRlbmQgdGhlIG9yaWdpbmFsIGxpc3QKICAgICAgICogb2YgY29udHJvbCBjaGFuZ2UgbWVzc2FnZXMgKGEuay5hLiBDQyBtZXNzYWdlcykuIEN1cnJlbnRseSwgdGhlcmUgYXJlIG9ubHkgYSBsaW1pdGVkIG51bWJlcgogICAgICAgKiBvZiB0aGVtLgogICAgICAgKgogICAgICAgKiBAcHJvcGVydHkgTUlESV9SRUdJU1RFUkVEX1BBUkFNRVRFUgogICAgICAgKiBAdHlwZSBPYmplY3QKICAgICAgICogQHN0YXRpYwogICAgICAgKgogICAgICAgKiBAc2luY2UgMi4wLjAKICAgICAgICovCiAgICAgIE1JRElfUkVHSVNURVJFRF9QQVJBTUVURVI6IHsKICAgICAgICB2YWx1ZTogewogICAgICAgICAgcGl0Y2hiZW5kcmFuZ2U6IFsweDAwLCAweDAwXSwKICAgICAgICAgIGNoYW5uZWxmaW5ldHVuaW5nOiBbMHgwMCwgMHgwMV0sCiAgICAgICAgICBjaGFubmVsY29hcnNldHVuaW5nOiBbMHgwMCwgMHgwMl0sCiAgICAgICAgICB0dW5pbmdwcm9ncmFtOiBbMHgwMCwgMHgwM10sCiAgICAgICAgICB0dW5pbmdiYW5rOiBbMHgwMCwgMHgwNF0sCiAgICAgICAgICBtb2R1bGF0aW9ucmFuZ2U6IFsweDAwLCAweDA1XSwKICAgICAgICAgIGF6aW11dGhhbmdsZTogWzB4M0QsIDB4MDBdLAogICAgICAgICAgZWxldmF0aW9uYW5nbGU6IFsweDNELCAweDAxXSwKICAgICAgICAgIGdhaW46IFsweDNELCAweDAyXSwKICAgICAgICAgIGRpc3RhbmNlcmF0aW86IFsweDNELCAweDAzXSwKICAgICAgICAgIG1heGltdW1kaXN0YW5jZTogWzB4M0QsIDB4MDRdLAogICAgICAgICAgbWF4aW11bWRpc3RhbmNlZ2FpbjogWzB4M0QsIDB4MDVdLAogICAgICAgICAgcmVmZXJlbmNlZGlzdGFuY2VyYXRpbzogWzB4M0QsIDB4MDZdLAogICAgICAgICAgcGFuc3ByZWFkYW5nbGU6IFsweDNELCAweDA3XSwKICAgICAgICAgIHJvbGxhbmdsZTogWzB4M0QsIDB4MDhdCiAgICAgICAgfSwKICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlCiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogW3JlYWQtb25seV0gQW4gb2JqZWN0IGNvbnRhaW5pbmcgcHJvcGVydGllcyBmb3IgZWFjaCBNSURJIGNvbnRyb2wgY2hhbmdlIG1lc3NhZ2VzIChhLmsuYS4KICAgICAgICogQ0MgbWVzc2FnZXMpIGFuZCB0aGVpciBhc3NvY2lhdGVkIGhleGFkZWNpbWFsIHZhbHVlLgogICAgICAgKgogICAgICAgKiBAcHJvcGVydHkgTUlESV9DT05UUk9MX0NIQU5HRV9NRVNTQUdFUwogICAgICAgKiBAdHlwZSBPYmplY3QKICAgICAgICogQHN0YXRpYwogICAgICAgKgogICAgICAgKiBAc2luY2UgMi4wLjAKICAgICAgICovCiAgICAgIE1JRElfQ09OVFJPTF9DSEFOR0VfTUVTU0FHRVM6IHsKICAgICAgICB2YWx1ZTogewogICAgICAgICAgYmFua3NlbGVjdGNvYXJzZTogMCwKICAgICAgICAgIG1vZHVsYXRpb253aGVlbGNvYXJzZTogMSwKICAgICAgICAgIGJyZWF0aGNvbnRyb2xsZXJjb2Fyc2U6IDIsCiAgICAgICAgICBmb290Y29udHJvbGxlcmNvYXJzZTogNCwKICAgICAgICAgIHBvcnRhbWVudG90aW1lY29hcnNlOiA1LAogICAgICAgICAgZGF0YWVudHJ5Y29hcnNlOiA2LAogICAgICAgICAgdm9sdW1lY29hcnNlOiA3LAogICAgICAgICAgYmFsYW5jZWNvYXJzZTogOCwKICAgICAgICAgIHBhbmNvYXJzZTogMTAsCiAgICAgICAgICBleHByZXNzaW9uY29hcnNlOiAxMSwKICAgICAgICAgIGVmZmVjdGNvbnRyb2wxY29hcnNlOiAxMiwKICAgICAgICAgIGVmZmVjdGNvbnRyb2wyY29hcnNlOiAxMywKICAgICAgICAgIGdlbmVyYWxwdXJwb3Nlc2xpZGVyMTogMTYsCiAgICAgICAgICBnZW5lcmFscHVycG9zZXNsaWRlcjI6IDE3LAogICAgICAgICAgZ2VuZXJhbHB1cnBvc2VzbGlkZXIzOiAxOCwKICAgICAgICAgIGdlbmVyYWxwdXJwb3Nlc2xpZGVyNDogMTksCiAgICAgICAgICBiYW5rc2VsZWN0ZmluZTogMzIsCiAgICAgICAgICBtb2R1bGF0aW9ud2hlZWxmaW5lOiAzMywKICAgICAgICAgIGJyZWF0aGNvbnRyb2xsZXJmaW5lOiAzNCwKICAgICAgICAgIGZvb3Rjb250cm9sbGVyZmluZTogMzYsCiAgICAgICAgICBwb3J0YW1lbnRvdGltZWZpbmU6IDM3LAogICAgICAgICAgZGF0YWVudHJ5ZmluZTogMzgsCiAgICAgICAgICB2b2x1bWVmaW5lOiAzOSwKICAgICAgICAgIGJhbGFuY2VmaW5lOiA0MCwKICAgICAgICAgIHBhbmZpbmU6IDQyLAogICAgICAgICAgZXhwcmVzc2lvbmZpbmU6IDQzLAogICAgICAgICAgZWZmZWN0Y29udHJvbDFmaW5lOiA0NCwKICAgICAgICAgIGVmZmVjdGNvbnRyb2wyZmluZTogNDUsCiAgICAgICAgICBob2xkcGVkYWw6IDY0LAogICAgICAgICAgcG9ydGFtZW50bzogNjUsCiAgICAgICAgICBzdXN0ZW51dG9wZWRhbDogNjYsCiAgICAgICAgICBzb2Z0cGVkYWw6IDY3LAogICAgICAgICAgbGVnYXRvcGVkYWw6IDY4LAogICAgICAgICAgaG9sZDJwZWRhbDogNjksCiAgICAgICAgICBzb3VuZHZhcmlhdGlvbjogNzAsCiAgICAgICAgICByZXNvbmFuY2U6IDcxLAogICAgICAgICAgc291bmRyZWxlYXNldGltZTogNzIsCiAgICAgICAgICBzb3VuZGF0dGFja3RpbWU6IDczLAogICAgICAgICAgYnJpZ2h0bmVzczogNzQsCiAgICAgICAgICBzb3VuZGNvbnRyb2w2OiA3NSwKICAgICAgICAgIHNvdW5kY29udHJvbDc6IDc2LAogICAgICAgICAgc291bmRjb250cm9sODogNzcsCiAgICAgICAgICBzb3VuZGNvbnRyb2w5OiA3OCwKICAgICAgICAgIHNvdW5kY29udHJvbDEwOiA3OSwKICAgICAgICAgIGdlbmVyYWxwdXJwb3NlYnV0dG9uMTogODAsCiAgICAgICAgICBnZW5lcmFscHVycG9zZWJ1dHRvbjI6IDgxLAogICAgICAgICAgZ2VuZXJhbHB1cnBvc2VidXR0b24zOiA4MiwKICAgICAgICAgIGdlbmVyYWxwdXJwb3NlYnV0dG9uNDogODMsCiAgICAgICAgICByZXZlcmJsZXZlbDogOTEsCiAgICAgICAgICB0cmVtb2xvbGV2ZWw6IDkyLAogICAgICAgICAgY2hvcnVzbGV2ZWw6IDkzLAogICAgICAgICAgY2VsZXN0ZWxldmVsOiA5NCwKICAgICAgICAgIHBoYXNlcmxldmVsOiA5NSwKICAgICAgICAgIGRhdGFidXR0b25pbmNyZW1lbnQ6IDk2LAogICAgICAgICAgZGF0YWJ1dHRvbmRlY3JlbWVudDogOTcsCiAgICAgICAgICBub25yZWdpc3RlcmVkcGFyYW1ldGVyY29hcnNlOiA5OCwKICAgICAgICAgIG5vbnJlZ2lzdGVyZWRwYXJhbWV0ZXJmaW5lOiA5OSwKICAgICAgICAgIHJlZ2lzdGVyZWRwYXJhbWV0ZXJjb2Fyc2U6IDEwMCwKICAgICAgICAgIHJlZ2lzdGVyZWRwYXJhbWV0ZXJmaW5lOiAxMDEKICAgICAgICB9LAogICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBbcmVhZC1vbmx5XSBBbiBvYmplY3QgY29udGFpbmluZyBwcm9wZXJ0aWVzIGZvciBNSURJIGNvbnRyb2wgY2hhbmdlIG1lc3NhZ2VzCiAgICAgICAqIHRoYXQgbWFrZSB1cCBOUlBOIG1lc3NhZ2VzCiAgICAgICAqCiAgICAgICAqIEBwcm9wZXJ0eSBNSURJX05SUE5fTUVTU0FHRVMKICAgICAgICogQHR5cGUgT2JqZWN0CiAgICAgICAqIEBzdGF0aWMKICAgICAgICoKICAgICAgICogQHNpbmNlIDIuMC4wCiAgICAgICAqLwogICAgICBNSURJX05SUE5fTUVTU0FHRVM6IHsKICAgICAgICB2YWx1ZTogewogICAgICAgICAgZW50cnltc2I6IDYsCiAgICAgICAgICBlbnRyeWxzYjogMzgsCiAgICAgICAgICBpbmNyZW1lbnQ6IDk2LAogICAgICAgICAgZGVjcmVtZW50OiA5NywKICAgICAgICAgIHBhcmFtbHNiOiA5OCwKICAgICAgICAgIHBhcmFtbXNiOiA5OSwKICAgICAgICAgIG51bGxhY3RpdmVwYXJhbWV0ZXI6IDEyNwogICAgICAgIH0sCiAgICAgICAgd3JpdGFibGU6IGZhbHNlLAogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIFtyZWFkLW9ubHldIExpc3Qgb2YgTUlESSBjaGFubmVsIG1vZGUgbWVzc2FnZXMgYXMgZGVmaW5lZCBpbiB0aGUgb2ZmaWNpYWwgTUlESQogICAgICAgKiBzcGVjaWZpY2F0aW9uLgogICAgICAgKgogICAgICAgKiBAcHJvcGVydHkgTUlESV9DSEFOTkVMX01PREVfTUVTU0FHRVMKICAgICAgICogQHR5cGUgT2JqZWN0CiAgICAgICAqIEBzdGF0aWMKICAgICAgICoKICAgICAgICogQHNpbmNlIDIuMC4wCiAgICAgICAqLwogICAgICBNSURJX0NIQU5ORUxfTU9ERV9NRVNTQUdFUzogewogICAgICAgIHZhbHVlOiB7CiAgICAgICAgICBhbGxzb3VuZG9mZjogMTIwLAogICAgICAgICAgcmVzZXRhbGxjb250cm9sbGVyczogMTIxLAogICAgICAgICAgbG9jYWxjb250cm9sOiAxMjIsCiAgICAgICAgICBhbGxub3Rlc29mZjogMTIzLAogICAgICAgICAgb21uaW1vZGVvZmY6IDEyNCwKICAgICAgICAgIG9tbmltb2Rlb246IDEyNSwKICAgICAgICAgIG1vbm9tb2Rlb246IDEyNiwKICAgICAgICAgIHBvbHltb2Rlb246IDEyNwogICAgICAgIH0sCiAgICAgICAgd3JpdGFibGU6IGZhbHNlLAogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEFuIGludGVnZXIgdG8gb2Zmc2V0IHRoZSBvY3RhdmUgYm90aCBpbiBpbmJvdW5kIGFuZCBvdXRib3VuZCBtZXNzYWdlcy4gQnkgZGVmYXVsdCwgbWlkZGxlIEMKICAgICAgICogKE1JREkgbm90ZSBudW1iZXIgNjApIGlzIHBsYWNlZCBvbiB0aGUgNHRoIG9jdGF2ZSAoQzQpLgogICAgICAgKgogICAgICAgKiBJZiwgZm9yIGV4YW1wbGUsIGBvY3RhdmVPZmZzZXRgIGlzIHNldCB0byAyLCBNSURJIG5vdGUgbnVtYmVyIDYwIHdpbGwgYmUgcmVwb3J0ZWQgYXMgQzYuIElmCiAgICAgICAqIGBvY3RhdmVPZmZzZXRgIGlzIHNldCB0byAtMSwgTUlESSBub3RlIG51bWJlciA2MCB3aWxsIGJlIHJlcG9ydGVkIGFzIEMzLgogICAgICAgKgogICAgICAgKiBAcHJvcGVydHkgb2N0YXZlT2Zmc2V0CiAgICAgICAqIEB0eXBlIE51bWJlcgogICAgICAgKiBAc3RhdGljCiAgICAgICAqCiAgICAgICAqIEBzaW5jZSAyLjEKICAgICAgICovCiAgICAgIG9jdGF2ZU9mZnNldDogewogICAgICAgIHZhbHVlOiAwLAogICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZQogICAgICB9CiAgICB9KTsgLy8gRGVmaW5lIGdldHRlcnMvc2V0dGVycwoKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKHRoaXMsIHsKICAgICAgLyoqCiAgICAgICAqIFtyZWFkLW9ubHldIEluZGljYXRlcyB3aGV0aGVyIHRoZSBlbnZpcm9ubWVudCBzdXBwb3J0cyB0aGUgV2ViIE1JREkgQVBJIG9yIG5vdC4KICAgICAgICoKICAgICAgICogTm90ZTogaW4gZW52aXJvbm1lbnRzIHRoYXQgZG8gbm90IG9mZmVyIGJ1aWx0LWluIE1JREkgc3VwcG9ydCwgdGhpcyB3aWxsIHJlcG9ydCB0cnVlIGlmIHRoZQogICAgICAgKiBgbmF2aWdhdG9yLnJlcXVlc3RNSURJQWNjZXNzYCBmdW5jdGlvbiBpcyBhdmFpbGFibGUuIEZvciBleGFtcGxlLCBpZiB5b3UgaGF2ZSBpbnN0YWxsZWQKICAgICAgICogV2ViTUlESUFQSVNoaW0gYnV0IG5vIHBsdWdpbiwgdGhpcyBwcm9wZXJ0eSB3aWxsIGJlIHRydWUgZXZlbiB0aG91Z2ggYWN0dWFsIHN1cHBvcnQgbWlnaHQKICAgICAgICogbm90IGJlIHRoZXJlLgogICAgICAgKgogICAgICAgKiBAcHJvcGVydHkgc3VwcG9ydGVkCiAgICAgICAqIEB0eXBlIEJvb2xlYW4KICAgICAgICogQHN0YXRpYwogICAgICAgKi8KICAgICAgc3VwcG9ydGVkOiB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgIHJldHVybiAicmVxdWVzdE1JRElBY2Nlc3MiIGluIG5hdmlnYXRvcjsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogW3JlYWQtb25seV0gSW5kaWNhdGVzIHdoZXRoZXIgdGhlIGludGVyZmFjZSB0byB0aGUgaG9zdCJzIE1JREkgc3Vic3lzdGVtIGlzIGN1cnJlbnRseQogICAgICAgKiBlbmFibGVkLgogICAgICAgKgogICAgICAgKiBAcHJvcGVydHkgZW5hYmxlZAogICAgICAgKiBAdHlwZSBCb29sZWFuCiAgICAgICAqIEBzdGF0aWMKICAgICAgICovCiAgICAgIGVuYWJsZWQ6IHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIHRoaXNbImludGVyZmFjZSJdICE9PSB1bmRlZmluZWQ7CiAgICAgICAgfS5iaW5kKHRoaXMpCiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogW3JlYWQtb25seV0gQW4gYXJyYXkgb2YgYWxsIGN1cnJlbnRseSBhdmFpbGFibGUgTUlESSBpbnB1dCBwb3J0cy4KICAgICAgICoKICAgICAgICogQHByb3BlcnR5IGlucHV0cwogICAgICAgKiBAdHlwZSB7QXJyYXl9CiAgICAgICAqIEBzdGF0aWMKICAgICAgICovCiAgICAgIGlucHV0czogewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5faW5wdXRzOwogICAgICAgIH0uYmluZCh0aGlzKQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIFtyZWFkLW9ubHldIEFuIGFycmF5IG9mIGFsbCBjdXJyZW50bHkgYXZhaWxhYmxlIE1JREkgb3V0cHV0IHBvcnRzLgogICAgICAgKgogICAgICAgKiBAcHJvcGVydHkgb3V0cHV0cwogICAgICAgKiBAdHlwZSB7QXJyYXl9CiAgICAgICAqIEBzdGF0aWMKICAgICAgICovCiAgICAgIG91dHB1dHM6IHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIHRoaXMuX291dHB1dHM7CiAgICAgICAgfS5iaW5kKHRoaXMpCiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogW3JlYWQtb25seV0gSW5kaWNhdGVzIHdoZXRoZXIgdGhlIGludGVyZmFjZSB0byB0aGUgaG9zdCJzIE1JREkgc3Vic3lzdGVtIGlzIGN1cnJlbnRseQogICAgICAgKiBhY3RpdmUuCiAgICAgICAqCiAgICAgICAqIEBwcm9wZXJ0eSBzeXNleEVuYWJsZWQKICAgICAgICogQHR5cGUgQm9vbGVhbgogICAgICAgKiBAc3RhdGljCiAgICAgICAqLwogICAgICBzeXNleEVuYWJsZWQ6IHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuICEhKHRoaXNbImludGVyZmFjZSJdICYmIHRoaXNbImludGVyZmFjZSJdLnN5c2V4RW5hYmxlZCk7CiAgICAgICAgfS5iaW5kKHRoaXMpCiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogW3JlYWQtb25seV0gSW5kaWNhdGVzIHdoZXRoZXIgV2ViTWlkaSBzaG91bGQgZGlzcGF0Y2ggTm9uLVJlZ2lzdGVyZWQKICAgICAgICogUGFyYW1ldGVyIE51bWJlciBldmVudHMgKHdoaWNoIGFyZSBnZW5lcmFsbHkgZ3JvdXBzIG9mIENDIG1lc3NhZ2VzKQogICAgICAgKiBJZiBjb3JyZWN0IHNlcXVlbmNlcyBvZiBDQyBtZXNzYWdlcyBhcmUgcmVjZWl2ZWQsIE5SUE4gZXZlbnRzIHdpbGwKICAgICAgICogZmlyZS4gVGhlIGZpcnN0IG91dCBvZiBvcmRlciBOUlBOIENDIHdpbGwgZmFsbCB0aHJvdWdoIHRoZSBjb2xsZWN0b3IKICAgICAgICogbG9naWMgYW5kIGFsbCBDQyBtZXNzYWdlcyBidWZmZXJlZCB3aWxsIGJlIGRpc2NhcmRlZCBhcyBpbmNvbXBsZXRlLgogICAgICAgKgogICAgICAgKiBAcHJvcGVydHkgbnJwbkV2ZW50c0VuYWJsZWQKICAgICAgICogQHR5cGUgQm9vbGVhbgogICAgICAgKiBAc3RhdGljCiAgICAgICAqLwogICAgICBucnBuRXZlbnRzRW5hYmxlZDogewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gISF0aGlzLl9ucnBuRXZlbnRzRW5hYmxlZDsKICAgICAgICB9LmJpbmQodGhpcyksCiAgICAgICAgc2V0OiBmdW5jdGlvbiBzZXQoZW5hYmxlZCkgewogICAgICAgICAgdGhpcy5fbnJwbkV2ZW50c0VuYWJsZWQgPSBlbmFibGVkOwogICAgICAgICAgcmV0dXJuIHRoaXMuX25ycG5FdmVudHNFbmFibGVkOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBbcmVhZC1vbmx5XSBOUlBOIG1lc3NhZ2UgdHlwZXMKICAgICAgICoKICAgICAgICogQHByb3BlcnR5IG5ycG5UeXBlcwogICAgICAgKiBAdHlwZSBBcnJheQogICAgICAgKiBAc3RhdGljCiAgICAgICAqLwogICAgICBucnBuVHlwZXM6IHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIHRoaXMuX25ycG5UeXBlczsKICAgICAgICB9LmJpbmQodGhpcykKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBbcmVhZC1vbmx5XSBDdXJyZW50IE1JREkgcGVyZm9ybWFuY2UgdGltZSBpbiBtaWxsaXNlY29uZHMuIFRoaXMgY2FuIGJlIHVzZWQgdG8gcXVldWUgZXZlbnRzCiAgICAgICAqIGluIHRoZSBmdXR1cmUuCiAgICAgICAqCiAgICAgICAqIEBwcm9wZXJ0eSB0aW1lCiAgICAgICAqIEB0eXBlIERPTUhpZ2hSZXNUaW1lU3RhbXAKICAgICAgICogQHN0YXRpYwogICAgICAgKi8KICAgICAgdGltZTogewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICByZXR1cm4gcGVyZm9ybWFuY2Uubm93KCk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9IC8vIFdlYk1pZGkgaXMgYSBzaW5nbGV0b24gc28gd2UgaW5zdGFudGlhdGUgaXQgb3Vyc2VsdmVzIGFuZCBrZWVwIGl0IGluIGEgdmFyIGZvciBpbnRlcm5hbAogIC8vIHJlZmVyZW5jZS4KCgogIHZhciB3bSA9IG5ldyBXZWJNaWRpKCk7CiAgLyoqCiAgICogQ2hlY2tzIGlmIHRoZSBXZWIgTUlESSBBUEkgaXMgYXZhaWxhYmxlIGFuZCB0aGVuIHRyaWVzIHRvIGNvbm5lY3QgdG8gdGhlIGhvc3QncyBNSURJIHN1YnN5c3RlbS4KICAgKiBUaGlzIGlzIGFuIGFzeW5jaHJvbm91cyBvcGVyYXRpb24uIFdoZW4gaXQncyBkb25lLCB0aGUgc3BlY2lmaWVkIGhhbmRsZXIgY2FsbGJhY2sgd2lsbCBiZQogICAqIGV4ZWN1dGVkLiBJZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHdpbGwgcmVjZWl2ZSBhbiBgRXJyb3JgIG9iamVjdCBhcyBpdHMKICAgKiBzb2xlIHBhcmFtZXRlci4KICAgKgogICAqIFRvIGVuYWJsZSB0aGUgdXNlIG9mIHN5c3RlbSBleGNsdXNpdmUgbWVzc2FnZXMsIHRoZSBgc3lzZXhgIHBhcmFtZXRlciBzaG91bGQgYmUgc2V0IHRvIHRydWUuCiAgICogSG93ZXZlciwgdW5kZXIgc29tZSBlbnZpcm9ubWVudHMgKGUuZy4gSmF6ei1QbHVnaW4pLCB0aGUgc3lzZXggcGFyYW1ldGVyIGlzIGlnbm9yZWQgYW5kIHN5c2V4CiAgICogaXMgYWx3YXlzIGVuYWJsZWQuCiAgICoKICAgKiBXYXJuaW5nOiBzdGFydGluZyB3aXRoIENocm9tZSB2NzcsIHRoZSBXZWIgTUlESSBBUEkgbXVzdCBiZSBob3N0ZWQgb24gYSBzZWN1cmUgb3JpZ2luCiAgICogKGBodHRwczovL2AsIGBsb2NhbGhvc3RgIG9yIGBmaWxlOi8vL2ApIGFuZCB0aGUgdXNlciB3aWxsIGFsd2F5cyBiZSBwcm9tcHRlZCB0byBhdXRob3JpemUgdGhlCiAgICogb3BlcmF0aW9uIChubyBtYXR0ZXIgaWYgYHN5c2V4YCBpcyByZXF1ZXN0ZWQgb3Igbm90KS4KICAgKgogICAqIEBtZXRob2QgZW5hYmxlCiAgICogQHN0YXRpYwogICAqCiAgICogQHBhcmFtIFtjYWxsYmFja10ge0Z1bmN0aW9ufSBBIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgdXBvbiBzdWNjZXNzLiBUaGlzIGZ1bmN0aW9uIHdpbGwgcmVjZWl2ZSBhbgogICAqIGBFcnJvcmAgb2JqZWN0IHVwb24gZmFpbHVyZSB0byBlbmFibGUgdGhlIFdlYiBNSURJIEFQSS4KICAgKiBAcGFyYW0gW3N5c2V4PWZhbHNlXSB7Qm9vbGVhbn0gV2hldGhlciB0byBlbmFibGUgTUlESSBzeXN0ZW0gZXhjbHVzaXZlIG1lc3NhZ2VzIG9yIG5vdC4KICAgKgogICAqIEB0aHJvd3MgRXJyb3IgVGhlIFdlYiBNSURJIEFQSSBpcyBub3Qgc3VwcG9ydGVkIGJ5IHlvdXIgYnJvd3Nlci4KICAgKiBAdGhyb3dzIEVycm9yIEphenotUGx1Z2luIG11c3QgYmUgaW5zdGFsbGVkIHRvIHVzZSBXZWJNSURJQVBJU2hpbS4KICAgKi8KCiAgV2ViTWlkaS5wcm90b3R5cGUuZW5hYmxlID0gZnVuY3Rpb24gKGNhbGxiYWNrLCBzeXNleCkgewogICAgLy8gV2h5IGFyZSB5b3Ugbm90IHVzaW5nIGEgUHJvbWlzZS1iYXNlZCBBUEkgZm9yIHRoZSBlbmFibGUoKSBtZXRob2Q/CiAgICAvLwogICAgLy8gU2hvcnQgYW5zd2VyOiBiZWNhdXNlIG9mIElFLgogICAgLy8KICAgIC8vIExvbmcgYW5zd2VyOgogICAgLy8KICAgIC8vIElFIDExIGFuZCBiZWxvdyBzdGlsbCBkbyBub3Qgc3VwcG9ydCBwcm9taXNlcy4gVGhlcmVmb3JlLCBXZWJNSURJQVBJU2hpbSBoYXMgdG8gaW1wbGVtZW50IGEKICAgIC8vIHNpbXBsZSBQcm9taXNlIGxvb2stYWxpa2Ugb2JqZWN0IHRvIGhhbmRsZSB0aGUgY2FsbCB0byByZXF1ZXN0TUlESUFjY2VzcygpLiBUaGlzIGxvb2stYWxpa2UKICAgIC8vIGlzIG5vdCBhIGZ1bGx5LWZsZWRnZWQgUHJvbWlzZSBvYmplY3QuIEl0IGRvZXMgbm90IHN1cHBvcnQgdXNpbmcgY2F0Y2goKSBmb3IgZXhhbXBsZS4gVGhpcwogICAgLy8gbWVhbnMgdGhhdCwgdG8gcHJvdmlkZSBhIHJlYWwgUHJvbWlzZS1iYXNlZCBpbnRlcmZhY2UgZm9yIHRoZSBlbmFibGUoKSBtZXRob2QsIHdlIHdvdWxkIG5lZWQKICAgIC8vIHRvIGFkZCBhIGRlcGVuZGVuY3kgaW4gdGhlIGZvcm0gb2YgYSBQcm9taXNlIHBvbHlmaWxsLiBTbywgdG8ga2VlcCB0aGluZ3Mgc2ltcGxlciwgd2Ugd2lsbAogICAgLy8gc3RpY2sgdG8gdGhlIGdvb2Qgb2xkIGNhbGxiYWNrIGJhc2VkIGVuYWJsZSgpIGZ1bmN0aW9uLgogICAgaWYgKHRoaXMuZW5hYmxlZCkgcmV0dXJuOwoKICAgIGlmICghdGhpcy5zdXBwb3J0ZWQpIHsKICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcigiVGhlIFdlYiBNSURJIEFQSSBpcyBub3Qgc3VwcG9ydGVkIGJ5IHlvdXIgYnJvd3Nlci4iKSk7CiAgICAgIH0KCiAgICAgIHJldHVybjsKICAgIH0KCiAgICBuYXZpZ2F0b3IucmVxdWVzdE1JRElBY2Nlc3MoewogICAgICBzeXNleDogc3lzZXgKICAgIH0pLnRoZW4oZnVuY3Rpb24gKG1pZGlBY2Nlc3MpIHsKICAgICAgdmFyIGV2ZW50cyA9IFtdLAogICAgICAgICAgcHJvbWlzZXMgPSBbXSwKICAgICAgICAgIHByb21pc2VUaW1lb3V0OwogICAgICB0aGlzWyJpbnRlcmZhY2UiXSA9IG1pZGlBY2Nlc3M7CgogICAgICB0aGlzLl9yZXNldEludGVyZmFjZVVzZXJIYW5kbGVycygpOyAvLyBXZSBzZXR1cCBhIHRlbXBvcmFyeSBgc3RhdGVjaGFuZ2VgIGhhbmRsZXIgdGhhdCB3aWxsIGNhdGNoIGFsbCBldmVudHMgdHJpZ2dlcmVkIHdoaWxlIHdlCiAgICAgIC8vIHNldHVwLiBUaG9zZSBldmVudHMgd2lsbCBiZSByZS10cmlnZ2VyZWQgYWZ0ZXIgY2FsbGluZyB0aGUgdXNlciJzIGNhbGxiYWNrLiBUaGlzIHdpbGwKICAgICAgLy8gYWxsb3cgdGhlIHVzZXIgdG8gbGlzdGVuIHRvICJjb25uZWN0ZWQiIGV2ZW50cyB3aGljaCBjYW4gYmUgdmVyeSBjb252ZW5pZW50LgoKCiAgICAgIHRoaXNbImludGVyZmFjZSJdLm9uc3RhdGVjaGFuZ2UgPSBmdW5jdGlvbiAoZSkgewogICAgICAgIGV2ZW50cy5wdXNoKGUpOwogICAgICB9OyAvLyBIZXJlIHdlIG1hbnVhbGx5IG9wZW4gdGhlIGlucHV0cyBhbmQgb3V0cHV0cy4gVXN1YWxseSwgdGhpcyBpcyBvcHRpb25hbC4gV2hlbiB0aGUgcG9ydHMKICAgICAgLy8gYXJlIG5vdCBleHBsaWNpdGVseSBvcGVuZWQsIHRoZXkgd2lsbCBiZSBvcGVuZWQgYXV0b21hdGljYWxseSAoYW5kIGFzeW5jaG9ub3VzbHkpIGJ5CiAgICAgIC8vIHNldHRpbmcgYSBsaXN0ZW5lciBvbiBgbWlkaW1lc3NhZ2VgIChNSURJSW5wdXQpIG9yIGNhbGxpbmcgYHNlbmQoKWAgKE1JRElPdXRwdXQpLgogICAgICAvLyBIb3dldmVyLCB3ZSBkbyBub3Qgd2FudCB0aGF0IGhlcmUuIFdlIHdhbnQgdG8gYmUgc3VyZSB0aGF0ICJjb25uZWN0ZWQiIGV2ZW50cyB3aWxsIGJlCiAgICAgIC8vIGF2YWlsYWJsZSBpbiB0aGUgdXNlciJzIGNhbGxiYWNrLiBTbywgd2hhdCB3ZSBkbyBpcyBvcGVuIGFsbCBpbnB1dCBhbmQgb3V0cHV0IHBvcnRzIGFuZAogICAgICAvLyB3YWl0IHVudGlsIGFsbCBwcm9taXNlcyBhcmUgcmVzb2x2ZWQuIFRoZW4sIHdlIHJlLXRyaWdnZXIgdGhlIGV2ZW50cyBhZnRlciB0aGUgdXNlciJzCiAgICAgIC8vIGNhbGxiYWNrIGhhcyBiZWVuIGV4ZWN1dGVkLiBUaGlzIHNlZW1zIGxpa2UgdGhlIG1vc3Qgc2Vuc2libGUgYW5kIHByYWN0aWNhbCB3YXkuCgoKICAgICAgdmFyIGlucHV0cyA9IG1pZGlBY2Nlc3MuaW5wdXRzLnZhbHVlcygpOwoKICAgICAgZm9yICh2YXIgaW5wdXQgPSBpbnB1dHMubmV4dCgpOyBpbnB1dCAmJiAhaW5wdXQuZG9uZTsgaW5wdXQgPSBpbnB1dHMubmV4dCgpKSB7CiAgICAgICAgcHJvbWlzZXMucHVzaChpbnB1dC52YWx1ZS5vcGVuKCkpOwogICAgICB9CgogICAgICB2YXIgb3V0cHV0cyA9IG1pZGlBY2Nlc3Mub3V0cHV0cy52YWx1ZXMoKTsKCiAgICAgIGZvciAodmFyIG91dHB1dCA9IG91dHB1dHMubmV4dCgpOyBvdXRwdXQgJiYgIW91dHB1dC5kb25lOyBvdXRwdXQgPSBvdXRwdXRzLm5leHQoKSkgewogICAgICAgIHByb21pc2VzLnB1c2gob3V0cHV0LnZhbHVlLm9wZW4oKSk7CiAgICAgIH0gLy8gU2luY2UgdGhpcyBsaWJyYXJ5IG1pZ2h0IGJlIHVzZWQgaW4gZW52aXJvbm1lbnRzIHdpdGhvdXQgc3VwcG9ydCBmb3IgcHJvbWlzZXMgKHN1Y2ggYXMKICAgICAgLy8gSmF6ei1NaWRpKSBvciBpbiBlbnZpcm9ubWVudHMgdGhhdCBhcmUgbm90IHByb3Blcmx5IG9wZW5pbmcgdGhlIHBvcnRzIChzdWNoIGFzIFdlYiBNSURJCiAgICAgIC8vIEJyb3dzZXIpLCB3ZSBmYWxsIGJhY2sgdG8gYSB0aW1lci1iYXNlZCBhcHByb2FjaCBpZiB0aGUgcHJvbWlzZS1iYXNlZCBhcHByb2FjaCBmYWlscy4KCgogICAgICBmdW5jdGlvbiBvblBvcnRzT3BlbigpIHsKICAgICAgICBjbGVhclRpbWVvdXQocHJvbWlzZVRpbWVvdXQpOwoKICAgICAgICB0aGlzLl91cGRhdGVJbnB1dHNBbmRPdXRwdXRzKCk7CgogICAgICAgIHRoaXNbImludGVyZmFjZSJdLm9uc3RhdGVjaGFuZ2UgPSB0aGlzLl9vbkludGVyZmFjZVN0YXRlQ2hhbmdlLmJpbmQodGhpcyk7IC8vIFdlIGV4ZWN1dGUgdGhlIGNhbGxiYWNrIGFuZCB0aGVuIHJlLXRyaWdnZXIgdGhlIHN0YXRlY2hhbmdlIGV2ZW50cy4KCiAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgY2FsbGJhY2suY2FsbCh0aGlzKTsKICAgICAgICB9CgogICAgICAgIGV2ZW50cy5mb3JFYWNoKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgdGhpcy5fb25JbnRlcmZhY2VTdGF0ZUNoYW5nZShldmVudCk7CiAgICAgICAgfS5iaW5kKHRoaXMpKTsKICAgICAgfQoKICAgICAgcHJvbWlzZVRpbWVvdXQgPSBzZXRUaW1lb3V0KG9uUG9ydHNPcGVuLmJpbmQodGhpcyksIDIwMCk7CgogICAgICBpZiAoUHJvbWlzZSkgewogICAgICAgIFByb21pc2UuYWxsKHByb21pc2VzKVsiY2F0Y2giXShmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICBjb25zb2xlLndhcm4oZXJyKTsKICAgICAgICB9KS50aGVuKG9uUG9ydHNPcGVuLmJpbmQodGhpcykpOwogICAgICB9IC8vIFdoZW4gTUlESSBhY2Nlc3MgaXMgcmVxdWVzdGVkLCBhbGwgaW5wdXQgYW5kIG91dHB1dCBwb3J0cyBoYXZlIHRoZWlyICJzdGF0ZSIgc2V0IHRvCiAgICAgIC8vICJjb25uZWN0ZWQiLiBIb3dldmVyLCB0aGUgdmFsdWUgb2YgdGhlaXIgImNvbm5lY3Rpb24iIHByb3BlcnR5IGlzICJjbG9zZWQiLgogICAgICAvLwogICAgICAvLyBBIGBNSURJSW5wdXRgIGJlY29tZXMgYG9wZW5gIHdoZW4geW91IGV4cGxpY2l0ZWx5IGNhbGwgaXRzIGBvcGVuKClgIG1ldGhvZCBvciB3aGVuIHlvdQogICAgICAvLyBhc3NpZ24gYSBsaXN0ZW5lciB0byBpdHMgYG9ubWlkaW1lc3NhZ2VgIHByb3BlcnR5LiBBIGBNSURJT3V0cHV0YCBiZWNvbWVzIGBvcGVuYCB3aGVuIHlvdQogICAgICAvLyB1c2UgdGhlIGBzZW5kKClgIG1ldGhvZCBvciB3aGVuIHlvdSBjYW4gZXhwbGljaXRlbHkgY2FsbCBpdHMgYG9wZW4oKWAgbWV0aG9kLgogICAgICAvLwogICAgICAvLyBDYWxsaW5nIGBfdXBkYXRlSW5wdXRzQW5kT3V0cHV0cygpYCBhdHRhY2hlcyBsaXN0ZW5lcnMgdG8gYWxsIGlucHV0cy4gQXMgcGVyIHRoZSBzcGVjLAogICAgICAvLyB0aGlzIHRyaWdnZXJzIGEgYHN0YXRlY2hhbmdlYCBldmVudCBvbiBNSURJQWNjZXNzLgoKICAgIH0uYmluZCh0aGlzKSwgZnVuY3Rpb24gKGVycikgewogICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgY2FsbGJhY2suY2FsbCh0aGlzLCBlcnIpOwogICAgICB9CiAgICB9LmJpbmQodGhpcykpOwogIH07CiAgLyoqCiAgICogQ29tcGxldGVseSBkaXNhYmxlcyBgV2ViTWlkaWAgYnkgdW5saW5raW5nIHRoZSBNSURJIHN1YnN5c3RlbSJzIGludGVyZmFjZSBhbmQgZGVzdHJveWluZyBhbGwKICAgKiBgSW5wdXRgIGFuZCBgT3V0cHV0YCBvYmplY3RzIHRoYXQgbWF5IGJlIGF2YWlsYWJsZS4gVGhpcyBhbHNvIG1lYW5zIHRoYXQgYW55IGxpc3RlbmVyIHRoYXQgbWF5CiAgICogaGF2ZSBiZWVuIGRlZmluZWQgb24gYElucHV0YCBvciBgT3V0cHV0YCBvYmplY3RzIHdpbGwgYmUgZGVzdHJveWVkLgogICAqCiAgICogQG1ldGhvZCBkaXNhYmxlCiAgICogQHN0YXRpYwogICAqCiAgICogQHNpbmNlIDIuMC4wCiAgICovCgoKICBXZWJNaWRpLnByb3RvdHlwZS5kaXNhYmxlID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCF0aGlzLnN1cHBvcnRlZCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBXZWIgTUlESSBBUEkgaXMgbm90IHN1cHBvcnRlZCBieSB5b3VyIGJyb3dzZXIuIik7CiAgICB9CgogICAgaWYgKHRoaXNbImludGVyZmFjZSJdKSB0aGlzWyJpbnRlcmZhY2UiXS5vbnN0YXRlY2hhbmdlID0gdW5kZWZpbmVkOwogICAgdGhpc1siaW50ZXJmYWNlIl0gPSB1bmRlZmluZWQ7IC8vIGFsc28gcmVzZXRzIGVuYWJsZWQsIHN5c2V4RW5hYmxlZCwgbnJwbkV2ZW50c0VuYWJsZWQKCiAgICB0aGlzLl9pbnB1dHMgPSBbXTsKICAgIHRoaXMuX291dHB1dHMgPSBbXTsKICAgIHRoaXMuX25ycG5FdmVudHNFbmFibGVkID0gdHJ1ZTsKCiAgICB0aGlzLl9yZXNldEludGVyZmFjZVVzZXJIYW5kbGVycygpOwogIH07CiAgLyoqCiAgICogQWRkcyBhbiBldmVudCBsaXN0ZW5lciBvbiB0aGUgYFdlYk1pZGlgIG9iamVjdCB0aGF0IHdpbGwgdHJpZ2dlciBhIGZ1bmN0aW9uIGNhbGxiYWNrIHdoZW4gdGhlCiAgICogc3BlY2lmaWVkIGV2ZW50IGhhcHBlbnMuCiAgICoKICAgKiBXZWJNaWRpIG11c3QgYmUgZW5hYmxlZCBiZWZvcmUgYWRkaW5nIGV2ZW50IGxpc3RlbmVycy4KICAgKgogICAqIEN1cnJlbnRseSwgb25seSBvbmUgZXZlbnQgaXMgYmVpbmcgZGlzcGF0Y2hlZCBieSB0aGUgYFdlYk1pZGlgIG9iamVjdDoKICAgKgogICAqICAgICoge3sjY3Jvc3NMaW5rICJXZWJNaWRpL3N0YXRlY2hhbmdlOmV2ZW50In19c3RhdGVjaGFuZ2V7ey9jcm9zc0xpbmt9fQogICAqCiAgICogQG1ldGhvZCBhZGRMaXN0ZW5lcgogICAqIEBzdGF0aWMKICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfSBUaGUgdHlwZSBvZiB0aGUgZXZlbnQuCiAgICoKICAgKiBAcGFyYW0gbGlzdGVuZXIge0Z1bmN0aW9ufSBBIGNhbGxiYWNrIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgd2hlbiB0aGUgc3BlY2lmaWVkIGV2ZW50IGlzIGRldGVjdGVkLgogICAqIFRoaXMgZnVuY3Rpb24gd2lsbCByZWNlaXZlIGFuIGV2ZW50IHBhcmFtZXRlciBvYmplY3QuIEZvciBkZXRhaWxzIG9uIHRoaXMgb2JqZWN0InMgcHJvcGVydGllcywKICAgKiBjaGVjayBvdXQgdGhlIGRvY3VtZW50YXRpb24gZm9yIHRoZSB2YXJpb3VzIGV2ZW50cyAobGlua3MgYWJvdmUpLgogICAqCiAgICogQHRocm93cyB7RXJyb3J9IFdlYk1pZGkgbXVzdCBiZSBlbmFibGVkIGJlZm9yZSBhZGRpbmcgZXZlbnQgbGlzdGVuZXJzLgogICAqIEB0aHJvd3Mge1R5cGVFcnJvcn0gVGhlIHNwZWNpZmllZCBldmVudCB0eXBlIGlzIG5vdCBzdXBwb3J0ZWQuCiAgICogQHRocm93cyB7VHlwZUVycm9yfSBUaGUgImxpc3RlbmVyIiBwYXJhbWV0ZXIgbXVzdCBiZSBhIGZ1bmN0aW9uLgogICAqCiAgICogQHJldHVybiB7V2ViTWlkaX0gUmV0dXJucyB0aGUgYFdlYk1pZGlgIG9iamVjdCBzbyBtZXRob2RzIGNhbiBiZSBjaGFpbmVkLgogICAqLwoKCiAgV2ViTWlkaS5wcm90b3R5cGUuYWRkTGlzdGVuZXIgPSBmdW5jdGlvbiAodHlwZSwgbGlzdGVuZXIpIHsKICAgIGlmICghdGhpcy5lbmFibGVkKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiV2ViTWlkaSBtdXN0IGJlIGVuYWJsZWQgYmVmb3JlIGFkZGluZyBldmVudCBsaXN0ZW5lcnMuIik7CiAgICB9CgogICAgaWYgKHR5cGVvZiBsaXN0ZW5lciAhPT0gImZ1bmN0aW9uIikgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJUaGUgJ2xpc3RlbmVyJyBwYXJhbWV0ZXIgbXVzdCBiZSBhIGZ1bmN0aW9uLiIpOwogICAgfQoKICAgIGlmICh0aGlzLl9taWRpSW50ZXJmYWNlRXZlbnRzLmluZGV4T2YodHlwZSkgPj0gMCkgewogICAgICB0aGlzLl91c2VySGFuZGxlcnNbdHlwZV0ucHVzaChsaXN0ZW5lcik7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJUaGUgc3BlY2lmaWVkIGV2ZW50IHR5cGUgaXMgbm90IHN1cHBvcnRlZC4iKTsKICAgIH0KCiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIENoZWNrcyBpZiB0aGUgc3BlY2lmaWVkIGV2ZW50IHR5cGUgaXMgYWxyZWFkeSBkZWZpbmVkIHRvIHRyaWdnZXIgdGhlIHNwZWNpZmllZCBsaXN0ZW5lcgogICAqIGZ1bmN0aW9uLgogICAqCiAgICogQG1ldGhvZCBoYXNMaXN0ZW5lcgogICAqIEBzdGF0aWMKICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSB0eXBlIG9mIHRoZSBldmVudC4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBsaXN0ZW5lciBUaGUgY2FsbGJhY2sgZnVuY3Rpb24gdG8gY2hlY2sgZm9yLgogICAqCiAgICogQHRocm93cyB7RXJyb3J9IFdlYk1pZGkgbXVzdCBiZSBlbmFibGVkIGJlZm9yZSBjaGVja2luZyBldmVudCBsaXN0ZW5lcnMuCiAgICogQHRocm93cyB7VHlwZUVycm9yfSBUaGUgImxpc3RlbmVyIiBwYXJhbWV0ZXIgbXVzdCBiZSBhIGZ1bmN0aW9uLgogICAqIEB0aHJvd3Mge1R5cGVFcnJvcn0gVGhlIHNwZWNpZmllZCBldmVudCB0eXBlIGlzIG5vdCBzdXBwb3J0ZWQuCiAgICoKICAgKiBAcmV0dXJuIHtCb29sZWFufSBCb29sZWFuIHZhbHVlIGluZGljYXRpbmcgd2hldGhlciBvciBub3QgYSBjYWxsYmFjayBpcyBhbHJlYWR5IGRlZmluZWQgZm9yCiAgICogdGhpcyBldmVudCB0eXBlLgogICAqLwoKCiAgV2ViTWlkaS5wcm90b3R5cGUuaGFzTGlzdGVuZXIgPSBmdW5jdGlvbiAodHlwZSwgbGlzdGVuZXIpIHsKICAgIGlmICghdGhpcy5lbmFibGVkKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiV2ViTWlkaSBtdXN0IGJlIGVuYWJsZWQgYmVmb3JlIGNoZWNraW5nIGV2ZW50IGxpc3RlbmVycy4iKTsKICAgIH0KCiAgICBpZiAodHlwZW9mIGxpc3RlbmVyICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlRoZSAnbGlzdGVuZXInIHBhcmFtZXRlciBtdXN0IGJlIGEgZnVuY3Rpb24uIik7CiAgICB9CgogICAgaWYgKHRoaXMuX21pZGlJbnRlcmZhY2VFdmVudHMuaW5kZXhPZih0eXBlKSA+PSAwKSB7CiAgICAgIGZvciAodmFyIG8gPSAwOyBvIDwgdGhpcy5fdXNlckhhbmRsZXJzW3R5cGVdLmxlbmd0aDsgbysrKSB7CiAgICAgICAgaWYgKHRoaXMuX3VzZXJIYW5kbGVyc1t0eXBlXVtvXSA9PT0gbGlzdGVuZXIpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVGhlIHNwZWNpZmllZCBldmVudCB0eXBlIGlzIG5vdCBzdXBwb3J0ZWQuIik7CiAgICB9CgogICAgcmV0dXJuIGZhbHNlOwogIH07CiAgLyoqCiAgICogUmVtb3ZlcyB0aGUgc3BlY2lmaWVkIGxpc3RlbmVyKHMpLiBJZiB0aGUgYGxpc3RlbmVyYCBwYXJhbWV0ZXIgaXMgbGVmdCB1bmRlZmluZWQsIGFsbCBsaXN0ZW5lcnMKICAgKiBmb3IgdGhlIHNwZWNpZmllZCBgdHlwZWAgd2lsbCBiZSByZW1vdmVkLiBJZiBib3RoIHRoZSBgbGlzdGVuZXJgIGFuZCB0aGUgYHR5cGVgIHBhcmFtZXRlcnMgYXJlCiAgICogb21pdHRlZCwgYWxsIGxpc3RlbmVycyBhdHRhY2hlZCB0byB0aGUgYFdlYk1pZGlgIG9iamVjdCB3aWxsIGJlIHJlbW92ZWQuCiAgICoKICAgKiBAbWV0aG9kIHJlbW92ZUxpc3RlbmVyCiAgICogQHN0YXRpYwogICAqIEBjaGFpbmFibGUKICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBbdHlwZV0gVGhlIHR5cGUgb2YgdGhlIGV2ZW50LgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtsaXN0ZW5lcl0gVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHRvIGNoZWNrIGZvci4KICAgKgogICAqIEB0aHJvd3Mge0Vycm9yfSBXZWJNaWRpIG11c3QgYmUgZW5hYmxlZCBiZWZvcmUgcmVtb3ZpbmcgZXZlbnQgbGlzdGVuZXJzLgogICAqIEB0aHJvd3Mge1R5cGVFcnJvcn0gVGhlICJsaXN0ZW5lciIgcGFyYW1ldGVyIG11c3QgYmUgYSBmdW5jdGlvbi4KICAgKiBAdGhyb3dzIHtUeXBlRXJyb3J9IFRoZSBzcGVjaWZpZWQgZXZlbnQgdHlwZSBpcyBub3Qgc3VwcG9ydGVkLgogICAqCiAgICogQHJldHVybiB7V2ViTWlkaX0gVGhlIGBXZWJNaWRpYCBvYmplY3QgZm9yIGVhc3kgbWV0aG9kIGNoYWluaW5nLgogICAqLwoKCiAgV2ViTWlkaS5wcm90b3R5cGUucmVtb3ZlTGlzdGVuZXIgPSBmdW5jdGlvbiAodHlwZSwgbGlzdGVuZXIpIHsKICAgIGlmICghdGhpcy5lbmFibGVkKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiV2ViTWlkaSBtdXN0IGJlIGVuYWJsZWQgYmVmb3JlIHJlbW92aW5nIGV2ZW50IGxpc3RlbmVycy4iKTsKICAgIH0KCiAgICBpZiAobGlzdGVuZXIgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgbGlzdGVuZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVGhlICdsaXN0ZW5lcicgcGFyYW1ldGVyIG11c3QgYmUgYSBmdW5jdGlvbi4iKTsKICAgIH0KCiAgICBpZiAodGhpcy5fbWlkaUludGVyZmFjZUV2ZW50cy5pbmRleE9mKHR5cGUpID49IDApIHsKICAgICAgaWYgKGxpc3RlbmVyKSB7CiAgICAgICAgZm9yICh2YXIgbyA9IDA7IG8gPCB0aGlzLl91c2VySGFuZGxlcnNbdHlwZV0ubGVuZ3RoOyBvKyspIHsKICAgICAgICAgIGlmICh0aGlzLl91c2VySGFuZGxlcnNbdHlwZV1bb10gPT09IGxpc3RlbmVyKSB7CiAgICAgICAgICAgIHRoaXMuX3VzZXJIYW5kbGVyc1t0eXBlXS5zcGxpY2UobywgMSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX3VzZXJIYW5kbGVyc1t0eXBlXSA9IFtdOwogICAgICB9CiAgICB9IGVsc2UgaWYgKHR5cGUgPT09IHVuZGVmaW5lZCkgewogICAgICB0aGlzLl9yZXNldEludGVyZmFjZVVzZXJIYW5kbGVycygpOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVGhlIHNwZWNpZmllZCBldmVudCB0eXBlIGlzIG5vdCBzdXBwb3J0ZWQuIik7CiAgICB9CgogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBSZXR1cm5zIGEgc2FuaXRpemVkIGFycmF5IG9mIHZhbGlkIE1JREkgY2hhbm5lbCBudW1iZXJzICgxLTE2KS4gVGhlIHBhcmFtZXRlciBzaG91bGQgYmUgb25lIG9mCiAgICogdGhlIGZvbGxvd2luZzoKICAgKgogICAqICogYSBzaW5nbGUgaW50ZWdlcgogICAqICogYW4gYXJyYXkgb2YgaW50ZWdlcnMKICAgKiAqIHRoZSBzcGVjaWFsIHZhbHVlIGAiYWxsImAKICAgKiAqIHRoZSBzcGVjaWFsIHZhbHVlIGAibm9uZSJgCiAgICoKICAgKiBQYXNzaW5nIGAiYWxsImAgb3IgYHVuZGVmaW5lZGAgYXMgYSBwYXJhbWV0ZXIgdG8gdGhpcyBmdW5jdGlvbiByZXN1bHRzIGluIGFsbCBjaGFubmVscyBiZWluZwogICAqIHJldHVybmVkICgxLTE2KS4gUGFzc2luZyBgIm5vbmUiYCByZXN1bHRzIGluIG5vIGNoYW5uZWwgYmVpbmcgcmV0dXJuZWQgKGFzIGFuIGVtcHR5IGFycmF5KS4KICAgKgogICAqIE5vdGU6IHBhcmFtZXRlcnMgdGhhdCBjYW5ub3Qgc3VjY2Vzc2Z1bGx5IGJlIHBhcnNlZCB0byBpbnRlZ2VycyBiZXR3ZWVuIDEgYW5kIDE2IGFyZSBzaWxlbnRseQogICAqIGlnbm9yZWQuCiAgICoKICAgKiBAbWV0aG9kIHRvTUlESUNoYW5uZWxzCiAgICogQHN0YXRpYwogICAqCiAgICogQHBhcmFtIFtjaGFubmVsPSJhbGwiXSB7TnVtYmVyfEFycmF5fCJhbGwifCJub25lIn0KICAgKiBAcmV0dXJucyB7QXJyYXl9IEFuIGFycmF5IG9mIDAgb3IgbW9yZSB2YWxpZCBNSURJIGNoYW5uZWwgbnVtYmVycwogICAqLwoKCiAgV2ViTWlkaS5wcm90b3R5cGUudG9NSURJQ2hhbm5lbHMgPSBmdW5jdGlvbiAoY2hhbm5lbCkgewogICAgdmFyIGNoYW5uZWxzOwoKICAgIGlmIChjaGFubmVsID09PSAiYWxsIiB8fCBjaGFubmVsID09PSB1bmRlZmluZWQpIHsKICAgICAgY2hhbm5lbHMgPSBbImFsbCJdOwogICAgfSBlbHNlIGlmIChjaGFubmVsID09PSAibm9uZSIpIHsKICAgICAgY2hhbm5lbHMgPSBbXTsKICAgICAgcmV0dXJuIGNoYW5uZWxzOwogICAgfSBlbHNlIGlmICghQXJyYXkuaXNBcnJheShjaGFubmVsKSkgewogICAgICBjaGFubmVscyA9IFtjaGFubmVsXTsKICAgIH0gZWxzZSB7CiAgICAgIGNoYW5uZWxzID0gY2hhbm5lbDsKICAgIH0gLy8gSW4gb3JkZXIgdG8gcHJlc2VydmUgYmFja3dhcmRzLWNvbXBhdGliaWxpdHksIHdlIGxldCB0aGlzIGFzc2lnbm1lbnQgYXMgaXQgaXMuCgoKICAgIGlmIChjaGFubmVscy5pbmRleE9mKCJhbGwiKSA+IC0xKSB7CiAgICAgIGNoYW5uZWxzID0gWzEsIDIsIDMsIDQsIDUsIDYsIDcsIDgsIDksIDEwLCAxMSwgMTIsIDEzLCAxNCwgMTUsIDE2XTsKICAgIH0KCiAgICByZXR1cm4gY2hhbm5lbHMubWFwKGZ1bmN0aW9uIChjaCkgewogICAgICByZXR1cm4gcGFyc2VJbnQoY2gpOwogICAgfSkuZmlsdGVyKGZ1bmN0aW9uIChjaCkgewogICAgICByZXR1cm4gY2ggPj0gMSAmJiBjaCA8PSAxNjsKICAgIH0pOwogIH07CiAgLyoqCiAgICoKICAgKiBSZXR1cm5zIHRoZSBgSW5wdXRgIG9iamVjdCB0aGF0IG1hdGNoZXMgdGhlIHNwZWNpZmllZCBJRCBzdHJpbmcgb3IgYGZhbHNlYCBpZiBubyBtYXRjaGluZyBpbnB1dAogICAqIGlzIGZvdW5kLiBBcyBwZXIgdGhlIFdlYiBNSURJIEFQSSBzcGVjaWZpY2F0aW9uLCBJRHMgYXJlIHN0cmluZ3MgKG5vdCBpbnRlZ2VycykuCiAgICoKICAgKiBQbGVhc2Ugbm90ZSB0aGF0IElEcyBjaGFuZ2UgZnJvbSBvbmUgaG9zdCB0byBhbm90aGVyLiBGb3IgZXhhbXBsZSwgQ2hyb21lIGRvZXMgbm90IHVzZSB0aGUgc2FtZQogICAqIGtpbmQgb2YgSURzIGFzIEphenotUGx1Z2luLgogICAqCiAgICogQG1ldGhvZCBnZXRJbnB1dEJ5SWQKICAgKiBAc3RhdGljCiAgICoKICAgKiBAcGFyYW0gaWQge1N0cmluZ30gVGhlIElEIHN0cmluZyBvZiB0aGUgcG9ydC4gSURzIGNhbiBiZSB2aWV3ZWQgYnkgbG9va2luZyBhdCB0aGUKICAgKiBgV2ViTWlkaS5pbnB1dHNgIGFycmF5LgogICAqCiAgICogQHJldHVybnMge0lucHV0fGZhbHNlfSBBIE1JRElJbnB1dCBwb3J0IG1hdGNoaW5nIHRoZSBzcGVjaWZpZWQgSUQgc3RyaW5nLiBJZiBubyBtYXRjaGluZyBwb3J0CiAgICogY2FuIGJlIGZvdW5kLCB0aGUgbWV0aG9kIHJldHVybnMgYGZhbHNlYC4KICAgKgogICAqIEB0aHJvd3MgRXJyb3IgV2ViTWlkaSBpcyBub3QgZW5hYmxlZC4KICAgKgogICAqIEBzaW5jZSAyLjAuMAogICAqLwoKCiAgV2ViTWlkaS5wcm90b3R5cGUuZ2V0SW5wdXRCeUlkID0gZnVuY3Rpb24gKGlkKSB7CiAgICBpZiAoIXRoaXMuZW5hYmxlZCkgdGhyb3cgbmV3IEVycm9yKCJXZWJNaWRpIGlzIG5vdCBlbmFibGVkLiIpOwogICAgaWQgPSBTdHJpbmcoaWQpOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5pbnB1dHMubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKHRoaXMuaW5wdXRzW2ldLmlkID09PSBpZCkgcmV0dXJuIHRoaXMuaW5wdXRzW2ldOwogICAgfQoKICAgIHJldHVybiBmYWxzZTsKICB9OwogIC8qKgogICAqIFJldHVybnMgdGhlIGBPdXRwdXRgIG9iamVjdCB0aGF0IG1hdGNoZXMgdGhlIHNwZWNpZmllZCBJRCBzdHJpbmcgb3IgYGZhbHNlYCBpZiBubyBtYXRjaGluZwogICAqIG91dHB1dCBpcyBmb3VuZC4gQXMgcGVyIHRoZSBXZWIgTUlESSBBUEkgc3BlY2lmaWNhdGlvbiwgSURzIGFyZSBzdHJpbmdzIChub3QgaW50ZWdlcnMpLgogICAqCiAgICogUGxlYXNlIG5vdGUgdGhhdCBJRHMgY2hhbmdlIGZyb20gb25lIGhvc3QgdG8gYW5vdGhlci4gRm9yIGV4YW1wbGUsIENocm9tZSBkb2VzIG5vdCB1c2UgdGhlIHNhbWUKICAgKiBraW5kIG9mIElEcyBhcyBKYXp6LVBsdWdpbi4KICAgKgogICAqIEBtZXRob2QgZ2V0T3V0cHV0QnlJZAogICAqIEBzdGF0aWMKICAgKgogICAqIEBwYXJhbSBpZCB7U3RyaW5nfSBUaGUgSUQgc3RyaW5nIG9mIHRoZSBwb3J0LiBJRHMgY2FuIGJlIHZpZXdlZCBieSBsb29raW5nIGF0IHRoZQogICAqIGBXZWJNaWRpLm91dHB1dHNgIGFycmF5LgogICAqCiAgICogQHJldHVybnMge091dHB1dHxmYWxzZX0gQSBNSURJT3V0cHV0IHBvcnQgbWF0Y2hpbmcgdGhlIHNwZWNpZmllZCBJRCBzdHJpbmcuIElmIG5vIG1hdGNoaW5nIHBvcnQKICAgKiBjYW4gYmUgZm91bmQsIHRoZSBtZXRob2QgcmV0dXJucyBgZmFsc2VgLgogICAqCiAgICogQHRocm93cyBFcnJvciBXZWJNaWRpIGlzIG5vdCBlbmFibGVkLgogICAqCiAgICogQHNpbmNlIDIuMC4wCiAgICovCgoKICBXZWJNaWRpLnByb3RvdHlwZS5nZXRPdXRwdXRCeUlkID0gZnVuY3Rpb24gKGlkKSB7CiAgICBpZiAoIXRoaXMuZW5hYmxlZCkgdGhyb3cgbmV3IEVycm9yKCJXZWJNaWRpIGlzIG5vdCBlbmFibGVkLiIpOwogICAgaWQgPSBTdHJpbmcoaWQpOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5vdXRwdXRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh0aGlzLm91dHB1dHNbaV0uaWQgPT09IGlkKSByZXR1cm4gdGhpcy5vdXRwdXRzW2ldOwogICAgfQoKICAgIHJldHVybiBmYWxzZTsKICB9OwogIC8qKgogICAqIFJldHVybnMgdGhlIGZpcnN0IE1JREkgYElucHV0YCB3aG9zZSBuYW1lICpjb250YWlucyogdGhlIHNwZWNpZmllZCBzdHJpbmcuCiAgICoKICAgKiBQbGVhc2Ugbm90ZSB0aGF0IHRoZSBwb3J0IG5hbWVzIGNoYW5nZSBmcm9tIG9uZSBob3N0IHRvIGFub3RoZXIuIEZvciBleGFtcGxlLCBDaHJvbWUgZG9lcwogICAqIG5vdCByZXBvcnQgcG9ydCBuYW1lcyBpbiB0aGUgc2FtZSB3YXkgYXMgdGhlIEphenotUGx1Z2luIGRvZXMuCiAgICoKICAgKiBAbWV0aG9kIGdldElucHV0QnlOYW1lCiAgICogQHN0YXRpYwogICAqCiAgICogQHBhcmFtIG5hbWUge1N0cmluZ30gVGhlIG5hbWUgb2YgYSBNSURJIGlucHV0IHBvcnQgc3VjaCBhcyB0aG9zZSB2aXNpYmxlIGluIHRoZQogICAqIGBXZWJNaWRpLmlucHV0c2AgYXJyYXkuCiAgICoKICAgKiBAcmV0dXJucyB7SW5wdXR8RmFsc2V9IFRoZSBgSW5wdXRgIHRoYXQgd2FzIGZvdW5kIG9yIGBmYWxzZWAgaWYgbm8gaW5wdXQgbWF0Y2hlZCB0aGUgc3BlY2lmaWVkCiAgICogbmFtZS4KICAgKgogICAqIEB0aHJvd3MgRXJyb3IgV2ViTWlkaSBpcyBub3QgZW5hYmxlZC4KICAgKiBAdGhyb3dzIFR5cGVFcnJvciBUaGUgbmFtZSBtdXN0IGJlIGEgc3RyaW5nLgogICAqCiAgICogQHNpbmNlIDIuMC4wCiAgICovCgoKICBXZWJNaWRpLnByb3RvdHlwZS5nZXRJbnB1dEJ5TmFtZSA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICBpZiAoIXRoaXMuZW5hYmxlZCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIldlYk1pZGkgaXMgbm90IGVuYWJsZWQuIik7CiAgICB9CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmlucHV0cy5sZW5ndGg7IGkrKykgewogICAgICBpZiAofnRoaXMuaW5wdXRzW2ldLm5hbWUuaW5kZXhPZihuYW1lKSkgewogICAgICAgIHJldHVybiB0aGlzLmlucHV0c1tpXTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBmYWxzZTsKICB9OwogIC8qKgogICAqIFJldHVybnMgdGhlIG9jdGF2ZSBudW1iZXIgZm9yIHRoZSBzcGVjaWZpZWQgTUlESSBub3RlIG51bWJlciAoMC0xMjcpLiBCeSBkZWZhdWx0LCB0aGUgdmFsdWUgaXMKICAgKiBiYXNlZCBvbiBtaWRkbGUgQyAobm90ZSBudW1iZXIgNjApIGJlaW5nIHBsYWNlZCBvbiB0aGUgNHRoIG9jdGF2ZSAoQzQpLiBIb3dldmVyLCBieSB1c2luZyB0aGUKICAgKiA8YSBocmVmPSIjcHJvcGVydHlfb2N0YXZlT2Zmc2V0Ij5vY3RhdmVPZmZzZXQ8L2E+IHByb3BlcnR5LCB5b3UgY2FuIG9mZnNldCB0aGUgcmVzdWx0IGFzIG11Y2gKICAgKiBhcyB5b3Ugd2FudC4KICAgKgogICAqIEBtZXRob2QgZ2V0T2N0YXZlCiAgICogQHN0YXRpYwogICAqCiAgICogQHBhcmFtIG51bWJlciB7TnVtYmVyfSBBbiBpbnRlZ2VyIHJlcHJlc2VudGluZyBhIHZhbGlkIE1JREkgbm90ZSBudW1iZXIgKGJldHdlZW4gMCBhbmQgMTI3KS4KICAgKgogICAqIEByZXR1cm5zIHtOdW1iZXJ9IFRoZSBvY3RhdmUgKGFzIGEgc2lnbmVkIGludGVnZXIpIG9yIGB1bmRlZmluZWRgLgogICAqCiAgICogQHNpbmNlIDIuMC4wLXJjLjYKICAgKi8KCgogIFdlYk1pZGkucHJvdG90eXBlLmdldE9jdGF2ZSA9IGZ1bmN0aW9uIChudW1iZXIpIHsKICAgIGlmIChudW1iZXIgIT0gbnVsbCAmJiBudW1iZXIgPj0gMCAmJiBudW1iZXIgPD0gMTI3KSB7CiAgICAgIHJldHVybiBNYXRoLmZsb29yKE1hdGguZmxvb3IobnVtYmVyKSAvIDEyIC0gMSkgKyBNYXRoLmZsb29yKHdtLm9jdGF2ZU9mZnNldCk7CiAgICB9CiAgfTsKICAvKioKICAgKiBSZXR1cm5zIHRoZSBmaXJzdCBNSURJIGBPdXRwdXRgIHRoYXQgbWF0Y2hlcyB0aGUgc3BlY2lmaWVkIG5hbWUuCiAgICoKICAgKiBQbGVhc2Ugbm90ZSB0aGF0IHRoZSBwb3J0IG5hbWVzIGNoYW5nZSBmcm9tIG9uZSBob3N0IHRvIGFub3RoZXIuIEZvciBleGFtcGxlLCBDaHJvbWUgZG9lcwogICAqIG5vdCByZXBvcnQgcG9ydCBuYW1lcyBpbiB0aGUgc2FtZSB3YXkgYXMgdGhlIEphenotUGx1Z2luIGRvZXMuCiAgICoKICAgKiBAbWV0aG9kIGdldE91dHB1dEJ5TmFtZQogICAqIEBzdGF0aWMKICAgKgogICAqIEBwYXJhbSBuYW1lIHtTdHJpbmd9IFRoZSBuYW1lIG9mIGEgTUlESSBvdXRwdXQgcG9ydCBzdWNoIGFzIHRob3NlIHZpc2libGUgaW4gdGhlCiAgICogYFdlYk1pZGkub3V0cHV0c2AgYXJyYXkuCiAgICoKICAgKiBAcmV0dXJucyB7T3V0cHV0fEZhbHNlfSBUaGUgYE91dHB1dGAgdGhhdCB3YXMgZm91bmQgb3IgYGZhbHNlYCBpZiBubyBvdXRwdXQgbWF0Y2hlZCB0aGUKICAgKiBzcGVjaWZpZWQgbmFtZS4KICAgKgogICAqIEB0aHJvd3MgRXJyb3IgV2ViTWlkaSBpcyBub3QgZW5hYmxlZC4KICAgKgogICAqIEBzaW5jZSAyLjAuMAogICAqLwoKCiAgV2ViTWlkaS5wcm90b3R5cGUuZ2V0T3V0cHV0QnlOYW1lID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgIGlmICghdGhpcy5lbmFibGVkKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiV2ViTWlkaSBpcyBub3QgZW5hYmxlZC4iKTsKICAgIH0KCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMub3V0cHV0cy5sZW5ndGg7IGkrKykgewogICAgICBpZiAofnRoaXMub3V0cHV0c1tpXS5uYW1lLmluZGV4T2YobmFtZSkpIHsKICAgICAgICByZXR1cm4gdGhpcy5vdXRwdXRzW2ldOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGZhbHNlOwogIH07CiAgLyoqCiAgICogUmV0dXJucyBhIHZhbGlkIE1JREkgbm90ZSBudW1iZXIgKDAtMTI3KSBnaXZlbiB0aGUgc3BlY2lmaWVkIGlucHV0LiBUaGUgaW5wdXQgdXN1YWxseSBpcyBhIG5vdGUKICAgKiBuYW1lIChDMywgRiM0LCBELTIsIEc4LCBldGMuKS4gSWYgYW4gaW50ZWdlciBiZXR3ZWVuIDAgYW5kIDEyNywgaXQgd2lsbCBzaW1wbHkgYmUgcmV0dXJuZWQgYXMKICAgKiBpcy4KICAgKgogICAqIEBtZXRob2QgZ3Vlc3NOb3RlTnVtYmVyCiAgICogQHN0YXRpYwogICAqCiAgICogQHBhcmFtIGlucHV0IHtOdW1iZXJ8U3RyaW5nfSBBIHN0cmluZyB0byBleHRyYWN0IHRoZSBub3RlIG51bWJlciBmcm9tLiBBbiBpbnRlZ2VyIGNhbiBhbHNvIGJlCiAgICogdXNlZCwgaW4gd2hpY2ggY2FzZSBpdCB3aWxsIHNpbXBseSBiZSByZXR1cm5lZCAoaWYgYmV0d2VlbiAwIGFuZCAxMjcpLgogICAqIEB0aHJvd3Mge0Vycm9yfSBJbnZhbGlkIGlucHV0IHZhbHVlCiAgICogQHJldHVybnMge051bWJlcn0gQSB2YWxpZCBNSURJIG5vdGUgbnVtYmVyICgwLTEyNykuCiAgICovCgoKICBXZWJNaWRpLnByb3RvdHlwZS5ndWVzc05vdGVOdW1iZXIgPSBmdW5jdGlvbiAoaW5wdXQpIHsKICAgIHZhciBvdXRwdXQgPSBmYWxzZTsKCiAgICBpZiAoaW5wdXQgJiYgaW5wdXQudG9GaXhlZCAmJiBpbnB1dCA+PSAwICYmIGlucHV0IDw9IDEyNykgewogICAgICAvLyB1aW50CiAgICAgIG91dHB1dCA9IE1hdGgucm91bmQoaW5wdXQpOwogICAgfSBlbHNlIGlmIChwYXJzZUludChpbnB1dCkgPj0gMCAmJiBwYXJzZUludChpbnB1dCkgPD0gMTI3KSB7CiAgICAgIC8vIHVpbnQgYXMgc3RyaW5nCiAgICAgIG91dHB1dCA9IHBhcnNlSW50KGlucHV0KTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGlucHV0ID09PSAic3RyaW5nIiB8fCBpbnB1dCBpbnN0YW5jZW9mIFN0cmluZykgewogICAgICAvLyBzdHJpbmcKICAgICAgb3V0cHV0ID0gdGhpcy5ub3RlTmFtZVRvTnVtYmVyKGlucHV0KTsKICAgIH0KCiAgICBpZiAob3V0cHV0ID09PSBmYWxzZSkgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGlucHV0IHZhbHVlICgiICsgaW5wdXQgKyAiKS4iKTsKICAgIHJldHVybiBvdXRwdXQ7CiAgfTsKICAvKioKICAgKiBSZXR1cm5zIGEgTUlESSBub3RlIG51bWJlciBtYXRjaGluZyB0aGUgbm90ZSBuYW1lIHBhc3NlZCBpbiB0aGUgZm9ybSBvZiBhIHN0cmluZyBwYXJhbWV0ZXIuIFRoZQogICAqIG5vdGUgbmFtZSBtdXN0IGluY2x1ZGUgdGhlIG9jdGF2ZSBudW1iZXIuIFRoZSBuYW1lIGNhbiBhbHNvIG9wdGlvbmFsbHkgaW5jbHVkZSBhIHNoYXJwICgjKSwKICAgKiBhIGRvdWJsZSBzaGFycCAoIyMpLCBhIGZsYXQgKGIpIG9yIGEgZG91YmxlIGZsYXQgKGJiKSBzeW1ib2w6IEM1LCBHNCwgRCMtMSwgRjAsIEdiNywgRWItMSwKICAgKiBBYmI0LCBCIyM2LCBldGMuCiAgICoKICAgKiBOb3RlIHRoYXQsIGluIGNvbnZlcnRpbmcgbm90ZSBuYW1lcyB0byBudW1iZXJzLCBDNCBpcyBjb25zaWRlcmVkIHRvIGJlIG1pZGRsZSBDIChNSURJIG5vdGUKICAgKiBudW1iZXIgNjApIGFzIHBlciB0aGUgc2NpZW50aWZpYyBwaXRjaCBub3RhdGlvbiBzdGFuZGFyZC4KICAgKgogICAqIEFsc28gbm90ZSB0aGF0IHRoZSByZXN1bHRpbmcgbm90ZSBudW1iZXIgaXMgb2Zmc2V0IGJ5IHRoZSBgb2N0YXZlT2Zmc2V0YCB2YWx1ZSAoaWYgbm90IHplcm8pLgogICAqIEZvciBleGFtcGxlLCBpZiB5b3UgcGFzcyBpbiAiQzQiIGFuZCB0aGUgYG9jdGF2ZU9mZnNldGAgdmFsdWUgaXMgMiB0aGUgcmVzdWx0aW5nIE1JREkgbm90ZQogICAqIG51bWJlciB3aWxsIGJlIDM2LgogICAqCiAgICogQG1ldGhvZCBub3RlTmFtZVRvTnVtYmVyCiAgICogQHN0YXRpYwogICAqCiAgICogQHBhcmFtIG5hbWUge1N0cmluZ30gVGhlIG5hbWUgb2YgdGhlIG5vdGUgaW4gdGhlIGZvcm0gb2YgYSBsZXR0ZXIsIGZvbGxvd2VkIGJ5IGFuIG9wdGlvbmFsICIjIiwKICAgKiAiIyMiLCAiYiIgb3IgImJiIiBmb2xsb3dlZCBieSB0aGUgb2N0YXZlIG51bWJlci4KICAgKgogICAqIEB0aHJvd3Mge1JhbmdlRXJyb3J9IEludmFsaWQgbm90ZSBuYW1lLgogICAqIEB0aHJvd3Mge1JhbmdlRXJyb3J9IEludmFsaWQgbm90ZSBuYW1lIG9yIG5vdGUgb3V0c2lkZSB2YWxpZCByYW5nZS4KICAgKiBAcmV0dXJuIHtOdW1iZXJ9IFRoZSBNSURJIG5vdGUgbnVtYmVyIChiZXR3ZWVuIDAgYW5kIDEyNykKICAgKi8KCgogIFdlYk1pZGkucHJvdG90eXBlLm5vdGVOYW1lVG9OdW1iZXIgPSBmdW5jdGlvbiAobmFtZSkgewogICAgaWYgKHR5cGVvZiBuYW1lICE9PSAic3RyaW5nIikgbmFtZSA9ICIiOwogICAgdmFyIG1hdGNoZXMgPSBuYW1lLm1hdGNoKC8oW0NERUZHQUJdKSgjezAsMn18YnswLDJ9KSgtP1xkKykvaSk7CiAgICBpZiAoIW1hdGNoZXMpIHRocm93IG5ldyBSYW5nZUVycm9yKCJJbnZhbGlkIG5vdGUgbmFtZS4iKTsKCiAgICB2YXIgc2VtaXRvbmVzID0gd20uX3NlbWl0b25lc1ttYXRjaGVzWzFdLnRvVXBwZXJDYXNlKCldOwoKICAgIHZhciBvY3RhdmUgPSBwYXJzZUludChtYXRjaGVzWzNdKTsKICAgIHZhciByZXN1bHQgPSAob2N0YXZlICsgMSAtIE1hdGguZmxvb3Iod20ub2N0YXZlT2Zmc2V0KSkgKiAxMiArIHNlbWl0b25lczsKCiAgICBpZiAobWF0Y2hlc1syXS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoImIiKSA+IC0xKSB7CiAgICAgIHJlc3VsdCAtPSBtYXRjaGVzWzJdLmxlbmd0aDsKICAgIH0gZWxzZSBpZiAobWF0Y2hlc1syXS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoIiMiKSA+IC0xKSB7CiAgICAgIHJlc3VsdCArPSBtYXRjaGVzWzJdLmxlbmd0aDsKICAgIH0KCiAgICBpZiAocmVzdWx0IDwgMCB8fCByZXN1bHQgPiAxMjcpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIkludmFsaWQgbm90ZSBuYW1lIG9yIG5vdGUgb3V0c2lkZSB2YWxpZCByYW5nZS4iKTsKICAgIH0KCiAgICByZXR1cm4gcmVzdWx0OwogIH07CiAgLyoqCiAgICogQG1ldGhvZCBfdXBkYXRlSW5wdXRzQW5kT3V0cHV0cwogICAqIEBzdGF0aWMKICAgKiBAcHJvdGVjdGVkCiAgICovCgoKICBXZWJNaWRpLnByb3RvdHlwZS5fdXBkYXRlSW5wdXRzQW5kT3V0cHV0cyA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuX3VwZGF0ZUlucHV0cygpOwoKICAgIHRoaXMuX3VwZGF0ZU91dHB1dHMoKTsKICB9OwogIC8qKgogICAqIEBtZXRob2QgX3VwZGF0ZUlucHV0cwogICAqIEBzdGF0aWMKICAgKiBAcHJvdGVjdGVkCiAgICovCgoKICBXZWJNaWRpLnByb3RvdHlwZS5fdXBkYXRlSW5wdXRzID0gZnVuY3Rpb24gKCkgewogICAgLy8gQ2hlY2sgZm9yIGl0ZW1zIHRvIHJlbW92ZSBmcm9tIHRoZSBleGlzdGluZyBhcnJheSAoYmVjYXVzZSB0aGV5IGFyZSBubyBsb25nZXIgYmVpbmcgcmVwb3J0ZWQKICAgIC8vIGJ5IHRoZSBNSURJIGJhY2stZW5kKS4KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5faW5wdXRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciByZW1vdmUgPSB0cnVlOwogICAgICB2YXIgdXBkYXRlZCA9IHRoaXNbImludGVyZmFjZSJdLmlucHV0cy52YWx1ZXMoKTsKCiAgICAgIGZvciAodmFyIGlucHV0ID0gdXBkYXRlZC5uZXh0KCk7IGlucHV0ICYmICFpbnB1dC5kb25lOyBpbnB1dCA9IHVwZGF0ZWQubmV4dCgpKSB7CiAgICAgICAgaWYgKHRoaXMuX2lucHV0c1tpXS5fbWlkaUlucHV0ID09PSBpbnB1dC52YWx1ZSkgewogICAgICAgICAgcmVtb3ZlID0gZmFsc2U7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChyZW1vdmUpIHsKICAgICAgICB0aGlzLl9pbnB1dHMuc3BsaWNlKGksIDEpOwogICAgICB9CiAgICB9IC8vIENoZWNrIGZvciBpdGVtcyB0byBhZGQgaW4gdGhlIGV4aXN0aW5nIGlucHV0cyBhcnJheSBiZWNhdXNlIHRoZXkganVzdCBhcHBlYXJlZCBpbiB0aGUgTUlESQogICAgLy8gYmFjay1lbmQgaW5wdXRzIGxpc3QuIFdlIG11c3QgY2hlY2sgZm9yIHRoZSBleGlzdGVuY2Ugb2YgdGhpcy5pbnRlcmZhY2UgYmVjYXVzZSBpdCBtaWdodAogICAgLy8gaGF2ZSBiZWVuIGNsb3NlZCB2aWEgV2ViTWlkaS5kaXNhYmxlKCkuCgoKICAgIHRoaXNbImludGVyZmFjZSJdICYmIHRoaXNbImludGVyZmFjZSJdLmlucHV0cy5mb3JFYWNoKGZ1bmN0aW9uIChuSW5wdXQpIHsKICAgICAgdmFyIGFkZCA9IHRydWU7CgogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHRoaXMuX2lucHV0cy5sZW5ndGg7IGorKykgewogICAgICAgIGlmICh0aGlzLl9pbnB1dHNbal0uX21pZGlJbnB1dCA9PT0gbklucHV0KSB7CiAgICAgICAgICBhZGQgPSBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChhZGQpIHsKICAgICAgICB0aGlzLl9pbnB1dHMucHVzaChuZXcgSW5wdXQobklucHV0KSk7CiAgICAgIH0KICAgIH0uYmluZCh0aGlzKSk7CiAgfTsKICAvKioKICAgKiBAbWV0aG9kIF91cGRhdGVPdXRwdXRzCiAgICogQHN0YXRpYwogICAqIEBwcm90ZWN0ZWQKICAgKi8KCgogIFdlYk1pZGkucHJvdG90eXBlLl91cGRhdGVPdXRwdXRzID0gZnVuY3Rpb24gKCkgewogICAgLy8gQ2hlY2sgZm9yIGl0ZW1zIHRvIHJlbW92ZSBmcm9tIHRoZSBleGlzdGluZyBhcnJheSAoYmVjYXVzZSB0aGV5IGFyZSBubyBsb25nZXIgYmVpbmcgcmVwb3J0ZWQKICAgIC8vIGJ5IHRoZSBNSURJIGJhY2stZW5kKS4KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fb3V0cHV0cy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgcmVtb3ZlID0gdHJ1ZTsKICAgICAgdmFyIHVwZGF0ZWQgPSB0aGlzWyJpbnRlcmZhY2UiXS5vdXRwdXRzLnZhbHVlcygpOwoKICAgICAgZm9yICh2YXIgb3V0cHV0ID0gdXBkYXRlZC5uZXh0KCk7IG91dHB1dCAmJiAhb3V0cHV0LmRvbmU7IG91dHB1dCA9IHVwZGF0ZWQubmV4dCgpKSB7CiAgICAgICAgaWYgKHRoaXMuX291dHB1dHNbaV0uX21pZGlPdXRwdXQgPT09IG91dHB1dC52YWx1ZSkgewogICAgICAgICAgcmVtb3ZlID0gZmFsc2U7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChyZW1vdmUpIHsKICAgICAgICB0aGlzLl9vdXRwdXRzLnNwbGljZShpLCAxKTsKICAgICAgfQogICAgfSAvLyBDaGVjayBmb3IgaXRlbXMgdG8gYWRkIGluIHRoZSBleGlzdGluZyBpbnB1dHMgYXJyYXkgYmVjYXVzZSB0aGV5IGp1c3QgYXBwZWFyZWQgaW4gdGhlIE1JREkKICAgIC8vIGJhY2stZW5kIG91dHB1dHMgbGlzdC4gV2UgbXVzdCBjaGVjayBmb3IgdGhlIGV4aXN0ZW5jZSBvZiB0aGlzLmludGVyZmFjZSBiZWNhdXNlIGl0IG1pZ2h0CiAgICAvLyBoYXZlIGJlZW4gY2xvc2VkIHZpYSBXZWJNaWRpLmRpc2FibGUoKS4KCgogICAgdGhpc1siaW50ZXJmYWNlIl0gJiYgdGhpc1siaW50ZXJmYWNlIl0ub3V0cHV0cy5mb3JFYWNoKGZ1bmN0aW9uIChuT3V0cHV0KSB7CiAgICAgIHZhciBhZGQgPSB0cnVlOwoKICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCB0aGlzLl9vdXRwdXRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgaWYgKHRoaXMuX291dHB1dHNbal0uX21pZGlPdXRwdXQgPT09IG5PdXRwdXQpIHsKICAgICAgICAgIGFkZCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGFkZCkgewogICAgICAgIHRoaXMuX291dHB1dHMucHVzaChuZXcgT3V0cHV0KG5PdXRwdXQpKTsKICAgICAgfQogICAgfS5iaW5kKHRoaXMpKTsKICB9OwogIC8qKgogICAqIEBtZXRob2QgX29uSW50ZXJmYWNlU3RhdGVDaGFuZ2UKICAgKiBAc3RhdGljCiAgICogQHByb3RlY3RlZAogICAqLwoKCiAgV2ViTWlkaS5wcm90b3R5cGUuX29uSW50ZXJmYWNlU3RhdGVDaGFuZ2UgPSBmdW5jdGlvbiAoZSkgewogICAgdGhpcy5fdXBkYXRlSW5wdXRzQW5kT3V0cHV0cygpOwogICAgLyoqCiAgICAgKiBFdmVudCBlbWl0dGVkIHdoZW4gYSBNSURJIHBvcnQgYmVjb21lcyBhdmFpbGFibGUuIFRoaXMgZXZlbnQgaXMgdHlwaWNhbGx5IGZpcmVkIHdoZW5ldmVyIGEKICAgICAqIE1JREkgZGV2aWNlIGlzIHBsdWdnZWQgaW4uIFBsZWFzZSBub3RlIHRoYXQgaXQgbWF5IGZpcmUgc2V2ZXJhbCB0aW1lcyBpZiBhIGRldmljZSBwb3NzZXNzZXMKICAgICAqIG11bHRpcGxlIGlucHV0L291dHB1dCBwb3J0cy4KICAgICAqCiAgICAgKiBAZXZlbnQgY29ubmVjdGVkCiAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQKICAgICAqIEBwYXJhbSB7TnVtYmVyfSBldmVudC50aW1lc3RhbXAgVGhlIHRpbWVzdGFtcCB3aGVuIHRoZSBldmVudCBvY2N1cnJlZCAoaW4gbWlsbGlzZWNvbmRzIHNpbmNlCiAgICAgKiB0aGUgZXBvY2gpLgogICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50LnR5cGUgVGhlIHR5cGUgb2YgZXZlbnQgdGhhdCBvY2N1cnJlZC4KICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudC5wb3J0IFRoZSBhY3R1YWwgYElucHV0YCBvciBgT3V0cHV0YCBvYmplY3QgYXNzb2NpYXRlZCB0byB0aGUgZXZlbnQuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEV2ZW50IGVtaXR0ZWQgd2hlbiBhIE1JREkgcG9ydCBiZWNvbWVzIHVuYXZhaWxhYmxlLiBUaGlzIGV2ZW50IGlzIHR5cGljYWxseSBmaXJlZCB3aGVuZXZlciBhCiAgICAgKiBNSURJIGRldmljZSBpcyB1bnBsdWdnZWQuIFBsZWFzZSBub3RlIHRoYXQgaXQgbWF5IGZpcmUgc2V2ZXJhbCB0aW1lcyBpZiBhIGRldmljZSBwb3NzZXNzZXMKICAgICAqIG11bHRpcGxlIGlucHV0L291dHB1dCBwb3J0cy4KICAgICAqCiAgICAgKiBAZXZlbnQgZGlzY29ubmVjdGVkCiAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQKICAgICAqIEBwYXJhbSB7TnVtYmVyfSBldmVudC50aW1lc3RhbXAgVGhlIHRpbWVzdGFtcCB3aGVuIHRoZSBldmVudCBvY2N1cnJlZCAoaW4gbWlsbGlzZWNvbmRzIHNpbmNlCiAgICAgKiB0aGUgZXBvY2gpLgogICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50LnR5cGUgVGhlIHR5cGUgb2YgZXZlbnQgdGhhdCBvY2N1cnJlZC4KICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudC5wb3J0IEFuIGdlbmVyaWMgb2JqZWN0IGNvbnRhaW5pbmcgZGV0YWlscyBhYm91dCB0aGUgcG9ydCB0aGF0IHRyaWdnZXJlZAogICAgICogdGhlIGV2ZW50LgogICAgICovCgoKICAgIHZhciBldmVudCA9IHsKICAgICAgdGltZXN0YW1wOiBlLnRpbWVTdGFtcCwKICAgICAgdHlwZTogZS5wb3J0LnN0YXRlCiAgICB9OwoKICAgIGlmICh0aGlzWyJpbnRlcmZhY2UiXSAmJiBlLnBvcnQuc3RhdGUgPT09ICJjb25uZWN0ZWQiKSB7CiAgICAgIGlmIChlLnBvcnQudHlwZSA9PT0gIm91dHB1dCIpIHsKICAgICAgICBldmVudC5wb3J0ID0gdGhpcy5nZXRPdXRwdXRCeUlkKGUucG9ydC5pZCk7CiAgICAgIH0gZWxzZSBpZiAoZS5wb3J0LnR5cGUgPT09ICJpbnB1dCIpIHsKICAgICAgICBldmVudC5wb3J0ID0gdGhpcy5nZXRJbnB1dEJ5SWQoZS5wb3J0LmlkKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZXZlbnQucG9ydCA9IHsKICAgICAgICBjb25uZWN0aW9uOiAiY2xvc2VkIiwKICAgICAgICBpZDogZS5wb3J0LmlkLAogICAgICAgIG1hbnVmYWN0dXJlcjogZS5wb3J0Lm1hbnVmYWN0dXJlciwKICAgICAgICBuYW1lOiBlLnBvcnQubmFtZSwKICAgICAgICBzdGF0ZTogZS5wb3J0LnN0YXRlLAogICAgICAgIHR5cGU6IGUucG9ydC50eXBlCiAgICAgIH07CiAgICB9CgogICAgdGhpcy5fdXNlckhhbmRsZXJzW2UucG9ydC5zdGF0ZV0uZm9yRWFjaChmdW5jdGlvbiAoaGFuZGxlcikgewogICAgICBoYW5kbGVyKGV2ZW50KTsKICAgIH0pOwogIH07CiAgLyoqCiAgICogQG1ldGhvZCBfcmVzZXRJbnRlcmZhY2VVc2VySGFuZGxlcnMKICAgKiBAc3RhdGljCiAgICogQHByb3RlY3RlZAogICAqLwoKCiAgV2ViTWlkaS5wcm90b3R5cGUuX3Jlc2V0SW50ZXJmYWNlVXNlckhhbmRsZXJzID0gZnVuY3Rpb24gKCkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9taWRpSW50ZXJmYWNlRXZlbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHRoaXMuX3VzZXJIYW5kbGVyc1t0aGlzLl9taWRpSW50ZXJmYWNlRXZlbnRzW2ldXSA9IFtdOwogICAgfQogIH07CiAgLyoqCiAgICogVGhlIGBJbnB1dGAgb2JqZWN0IHJlcHJlc2VudHMgYSBNSURJIGlucHV0IHBvcnQgb24gdGhlIGhvc3Qgc3lzdGVtLiBUaGlzIG9iamVjdCBpcyBjcmVhdGVkIGJ5CiAgICogdGhlIE1JREkgc3Vic3lzdGVtIGFuZCBjYW5ub3QgYmUgaW5zdGFudGlhdGVkIGRpcmVjdGx5LgogICAqCiAgICogWW91IHdpbGwgZmluZCBhbGwgYXZhaWxhYmxlIGBJbnB1dGAgb2JqZWN0cyBpbiB0aGUgYFdlYk1pZGkuaW5wdXRzYCBhcnJheS4KICAgKgogICAqIEBjbGFzcyBJbnB1dAogICAqIEBwYXJhbSB7TUlESUlucHV0fSBtaWRpSW5wdXQgYE1JRElJbnB1dGAgb2JqZWN0CiAgICovCgoKICBmdW5jdGlvbiBJbnB1dChtaWRpSW5wdXQpIHsKICAgIHZhciB0aGF0ID0gdGhpczsgLy8gVXNlci1kZWZpbmVkIGhhbmRsZXJzIGxpc3QKCiAgICB0aGlzLl91c2VySGFuZGxlcnMgPSB7CiAgICAgIGNoYW5uZWw6IHt9LAogICAgICBzeXN0ZW06IHt9CiAgICB9OyAvLyBSZWZlcmVuY2UgdG8gdGhlIGFjdHVhbCBNSURJSW5wdXQgb2JqZWN0CgogICAgdGhpcy5fbWlkaUlucHV0ID0gbWlkaUlucHV0OwogICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXModGhpcywgewogICAgICAvKioKICAgICAgICogW3JlYWQtb25seV0gU3RhdHVzIG9mIHRoZSBNSURJIHBvcnQicyBjb25uZWN0aW9uIChgcGVuZGluZ2AsIGBvcGVuYCBvciBgY2xvc2VkYCkKICAgICAgICoKICAgICAgICogQHByb3BlcnR5IGNvbm5lY3Rpb24KICAgICAgICogQHR5cGUgU3RyaW5nCiAgICAgICAqLwogICAgICBjb25uZWN0aW9uOiB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgIHJldHVybiB0aGF0Ll9taWRpSW5wdXQuY29ubmVjdGlvbjsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogW3JlYWQtb25seV0gSUQgc3RyaW5nIG9mIHRoZSBNSURJIHBvcnQuIFRoZSBJRCBpcyBob3N0LXNwZWNpZmljLiBEbyBub3QgZXhwZWN0IHRoZSBzYW1lIElECiAgICAgICAqIG9uIGRpZmZlcmVudCBwbGF0Zm9ybXMuIEZvciBleGFtcGxlLCBHb29nbGUgQ2hyb21lIGFuZCB0aGUgSmF6ei1QbHVnaW4gcmVwb3J0IGNvbXBsZXRlbHkKICAgICAgICogZGlmZmVyZW50IElEcyBmb3IgdGhlIHNhbWUgcG9ydC4KICAgICAgICoKICAgICAgICogQHByb3BlcnR5IGlkCiAgICAgICAqIEB0eXBlIFN0cmluZwogICAgICAgKi8KICAgICAgaWQ6IHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgcmV0dXJuIHRoYXQuX21pZGlJbnB1dC5pZDsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogW3JlYWQtb25seV0gTmFtZSBvZiB0aGUgbWFudWZhY3R1cmVyIG9mIHRoZSBkZXZpY2UgdGhhdCBtYWtlcyB0aGlzIHBvcnQgYXZhaWxhYmxlLgogICAgICAgKgogICAgICAgKiBAcHJvcGVydHkgbWFudWZhY3R1cmVyCiAgICAgICAqIEB0eXBlIFN0cmluZwogICAgICAgKi8KICAgICAgbWFudWZhY3R1cmVyOiB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgIHJldHVybiB0aGF0Ll9taWRpSW5wdXQubWFudWZhY3R1cmVyOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBbcmVhZC1vbmx5XSBOYW1lIG9mIHRoZSBNSURJIHBvcnQKICAgICAgICoKICAgICAgICogQHByb3BlcnR5IG5hbWUKICAgICAgICogQHR5cGUgU3RyaW5nCiAgICAgICAqLwogICAgICBuYW1lOiB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgIHJldHVybiB0aGF0Ll9taWRpSW5wdXQubmFtZTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogW3JlYWQtb25seV0gU3RhdGUgb2YgdGhlIE1JREkgcG9ydCAoYGNvbm5lY3RlZGAgb3IgYGRpc2Nvbm5lY3RlZGApCiAgICAgICAqCiAgICAgICAqIEBwcm9wZXJ0eSBzdGF0ZQogICAgICAgKiBAdHlwZSBTdHJpbmcKICAgICAgICovCiAgICAgIHN0YXRlOiB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgIHJldHVybiB0aGF0Ll9taWRpSW5wdXQuc3RhdGU7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIFtyZWFkLW9ubHldIFR5cGUgb2YgdGhlIE1JREkgcG9ydCAoYGlucHV0YCkKICAgICAgICoKICAgICAgICogQHByb3BlcnR5IHR5cGUKICAgICAgICogQHR5cGUgU3RyaW5nCiAgICAgICAqLwogICAgICB0eXBlOiB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgIHJldHVybiB0aGF0Ll9taWRpSW5wdXQudHlwZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwoKICAgIHRoaXMuX2luaXRpYWxpemVVc2VySGFuZGxlcnMoKTsKCiAgICB0aGlzLl9taWRpSW5wdXQub25taWRpbWVzc2FnZSA9IHRoaXMuX29uTWlkaU1lc3NhZ2UuYmluZCh0aGlzKTsKICB9CiAgLyoqCiAgICogQWRkcyBhbiBldmVudCBsaXN0ZW5lciB0byB0aGUgYElucHV0YCB0aGF0IHdpbGwgdHJpZ2dlciBhIGZ1bmN0aW9uIGNhbGxiYWNrIHdoZW4gdGhlIHNwZWNpZmllZAogICAqIGV2ZW50IGhhcHBlbnMuIFRoZSBldmVudHMgdGhhdCBhcmUgZGlzcGF0Y2hlZCBjYW4gYmUgY2hhbm5lbC1zcGVjaWZpYyBvciBJbnB1dC13aWRlLgogICAqCiAgICogSGVyZSBpcyBhIGxpc3Qgb2YgZXZlbnRzIHRoYXQgYXJlIGRpc3BhdGNoZWQgYnkgYElucHV0YCBvYmplY3RzIGFuZCB0aGF0IGNhbiBiZSBsaXN0ZW5lZCB0by4KICAgKgogICAqIENoYW5uZWwtc3BlY2lmaWMgTUlESSBldmVudHM6CiAgICoKICAgKiAgICAqIHt7I2Nyb3NzTGluayAiSW5wdXQvbm90ZW9mZjpldmVudCJ9fW5vdGVvZmZ7ey9jcm9zc0xpbmt9fQogICAqICAgICoge3sjY3Jvc3NMaW5rICJJbnB1dC9ub3Rlb246ZXZlbnQifX1ub3Rlb257ey9jcm9zc0xpbmt9fQogICAqICAgICoge3sjY3Jvc3NMaW5rICJJbnB1dC9rZXlhZnRlcnRvdWNoOmV2ZW50In19a2V5YWZ0ZXJ0b3VjaHt7L2Nyb3NzTGlua319CiAgICogICAgKiB7eyNjcm9zc0xpbmsgIklucHV0L2NvbnRyb2xjaGFuZ2U6ZXZlbnQifX1jb250cm9sY2hhbmdle3svY3Jvc3NMaW5rfX0KICAgKiAgICAqIHt7I2Nyb3NzTGluayAiSW5wdXQvbnJwbjpldmVudCJ9fW5ycG57ey9jcm9zc0xpbmt9fQogICAqICAgICoge3sjY3Jvc3NMaW5rICJJbnB1dC9jaGFubmVsbW9kZTpldmVudCJ9fWNoYW5uZWxtb2Rle3svY3Jvc3NMaW5rfX0KICAgKiAgICAqIHt7I2Nyb3NzTGluayAiSW5wdXQvcHJvZ3JhbWNoYW5nZTpldmVudCJ9fXByb2dyYW1jaGFuZ2V7ey9jcm9zc0xpbmt9fQogICAqICAgICoge3sjY3Jvc3NMaW5rICJJbnB1dC9jaGFubmVsYWZ0ZXJ0b3VjaDpldmVudCJ9fWNoYW5uZWxhZnRlcnRvdWNoe3svY3Jvc3NMaW5rfX0KICAgKiAgICAqIHt7I2Nyb3NzTGluayAiSW5wdXQvcGl0Y2hiZW5kOmV2ZW50In19cGl0Y2hiZW5ke3svY3Jvc3NMaW5rfX0KICAgKgogICAqIElucHV0LXdpZGUgTUlESSBldmVudHM6CiAgICoKICAgKiAgICAqIHt7I2Nyb3NzTGluayAiSW5wdXQvc3lzZXg6ZXZlbnQifX1zeXNleHt7L2Nyb3NzTGlua319CiAgICogICAgKiB7eyNjcm9zc0xpbmsgIklucHV0L3RpbWVjb2RlOmV2ZW50In19dGltZWNvZGV7ey9jcm9zc0xpbmt9fQogICAqICAgICoge3sjY3Jvc3NMaW5rICJJbnB1dC9zb25ncG9zaXRpb246ZXZlbnQifX1zb25ncG9zaXRpb257ey9jcm9zc0xpbmt9fQogICAqICAgICoge3sjY3Jvc3NMaW5rICJJbnB1dC9zb25nc2VsZWN0OmV2ZW50In19c29uZ3NlbGVjdHt7L2Nyb3NzTGlua319CiAgICogICAgKiB7eyNjcm9zc0xpbmsgIklucHV0L3R1bmluZ3JlcXVlc3Q6ZXZlbnQifX10dW5pbmdyZXF1ZXN0e3svY3Jvc3NMaW5rfX0KICAgKiAgICAqIHt7I2Nyb3NzTGluayAiSW5wdXQvY2xvY2s6ZXZlbnQifX1jbG9ja3t7L2Nyb3NzTGlua319CiAgICogICAgKiB7eyNjcm9zc0xpbmsgIklucHV0L3N0YXJ0OmV2ZW50In19c3RhcnR7ey9jcm9zc0xpbmt9fQogICAqICAgICoge3sjY3Jvc3NMaW5rICJJbnB1dC9jb250aW51ZTpldmVudCJ9fWNvbnRpbnVle3svY3Jvc3NMaW5rfX0KICAgKiAgICAqIHt7I2Nyb3NzTGluayAiSW5wdXQvc3RvcDpldmVudCJ9fXN0b3B7ey9jcm9zc0xpbmt9fQogICAqICAgICoge3sjY3Jvc3NMaW5rICJJbnB1dC9hY3RpdmVzZW5zaW5nOmV2ZW50In19YWN0aXZlc2Vuc2luZ3t7L2Nyb3NzTGlua319CiAgICogICAgKiB7eyNjcm9zc0xpbmsgIklucHV0L3Jlc2V0OmV2ZW50In19cmVzZXR7ey9jcm9zc0xpbmt9fQogICAqICAgICoge3sjY3Jvc3NMaW5rICJJbnB1dC9taWRpbWVzc2FnZTpldmVudCJ9fW1pZGltZXNzYWdle3svY3Jvc3NMaW5rfX0KICAgKiAgICAqIHt7I2Nyb3NzTGluayAiSW5wdXQvdW5rbm93bnN5c3RlbW1lc3NhZ2U6ZXZlbnQifX11bmtub3duc3lzdGVtbWVzc2FnZXt7L2Nyb3NzTGlua319CiAgICoKICAgKiBGb3IgZGV2aWNlLXdpZGUgZXZlbnRzLCB0aGUgYGNoYW5uZWxgIHBhcmFtZXRlciB3aWxsIGJlIHNpbGVudGx5IGlnbm9yZWQuIFlvdSBjYW4gc2ltcGx5IHVzZQogICAqIGB1bmRlZmluZWRgIGluIHRoYXQgY2FzZS4KICAgKgogICAqIElmIHlvdSB3YW50IHRvIHZpZXcgYWxsIGluY29taW5nIE1JREkgdHJhZmZpYywgeW91IGNhbiBsaXN0ZW4gdG8gdGhlIGlucHV0LXdpZGUgYG1pZGltZXNzYWdlYAogICAqIGV2ZW50LiBUaGlzIGV2ZW50IGlzIGRpc3BhdGNoZWQgZm9yIGV2ZXJ5IHNpbmdsZSBtZXNzYWdlIHRoYXQgaXMgcmVjZWl2ZWQgb24gdGhhdCBpbnB1dC4KICAgKgogICAqIEBtZXRob2QgYWRkTGlzdGVuZXIKICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfSBUaGUgdHlwZSBvZiB0aGUgZXZlbnQuCiAgICoKICAgKiBAcGFyYW0gY2hhbm5lbCB7TnVtYmVyfEFycmF5fFN0cmluZ30gVGhlIE1JREkgY2hhbm5lbCB0byBsaXN0ZW4gb24gKGludGVnZXIgYmV0d2VlbiAxIGFuZCAxNikuCiAgICogWW91IGNhbiBhbHNvIHNwZWNpZnkgYW4gYXJyYXkgb2YgY2hhbm5lbCBudW1iZXJzIG9yIHRoZSB2YWx1ZSAiYWxsIiAob3IgbGVhdmUgaXQgdW5kZWZpbmVkIGZvcgogICAqIGlucHV0LXdpZGUgZXZlbnRzKS4KICAgKgogICAqIEBwYXJhbSBsaXN0ZW5lciB7RnVuY3Rpb259IEEgY2FsbGJhY2sgZnVuY3Rpb24gdG8gZXhlY3V0ZSB3aGVuIHRoZSBzcGVjaWZpZWQgZXZlbnQgaXMgZGV0ZWN0ZWQuCiAgICogVGhpcyBmdW5jdGlvbiB3aWxsIHJlY2VpdmUgYW4gZXZlbnQgcGFyYW1ldGVyIG9iamVjdC4gRm9yIGRldGFpbHMgb24gdGhpcyBvYmplY3QicyBwcm9wZXJ0aWVzLAogICAqIGNoZWNrIG91dCB0aGUgZG9jdW1lbnRhdGlvbiBmb3IgdGhlIHZhcmlvdXMgZXZlbnRzIChsaW5rcyBhYm92ZSkuCiAgICoKICAgKiBAdGhyb3dzIHtSYW5nZUVycm9yfSBUaGUgImNoYW5uZWwiIHBhcmFtZXRlciBpcyBpbnZhbGlkLgogICAqIEB0aHJvd3Mge1R5cGVFcnJvcn0gVGhlICJsaXN0ZW5lciIgcGFyYW1ldGVyIG11c3QgYmUgYSBmdW5jdGlvbi4KICAgKiBAdGhyb3dzIHtUeXBlRXJyb3J9IFRoZSBzcGVjaWZpZWQgZXZlbnQgdHlwZSBpcyBub3Qgc3VwcG9ydGVkLgogICAqCiAgICogQHJldHVybiB7V2ViTWlkaX0gUmV0dXJucyB0aGUgYFdlYk1pZGlgIG9iamVjdCBzbyBtZXRob2RzIGNhbiBiZSBjaGFpbmVkLgogICAqLwoKCiAgSW5wdXQucHJvdG90eXBlLmFkZExpc3RlbmVyID0gZnVuY3Rpb24gKHR5cGUsIGNoYW5uZWwsIGxpc3RlbmVyKSB7CiAgICB2YXIgdGhhdCA9IHRoaXM7CgogICAgaWYgKGNoYW5uZWwgPT09IHVuZGVmaW5lZCkgewogICAgICBjaGFubmVsID0gImFsbCI7CiAgICB9CgogICAgaWYgKCFBcnJheS5pc0FycmF5KGNoYW5uZWwpKSB7CiAgICAgIGNoYW5uZWwgPSBbY2hhbm5lbF07CiAgICB9IC8vIENoZWNrIGlmIGNoYW5uZWwgZW50cmllcyBhcmUgdmFsaWQKCgogICAgY2hhbm5lbC5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIGlmIChpdGVtICE9PSAiYWxsIiAmJiAhKGl0ZW0gPj0gMSAmJiBpdGVtIDw9IDE2KSkgewogICAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJUaGUgJ2NoYW5uZWwnIHBhcmFtZXRlciBpcyBpbnZhbGlkLiIpOwogICAgICB9CiAgICB9KTsKCiAgICBpZiAodHlwZW9mIGxpc3RlbmVyICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlRoZSAnbGlzdGVuZXInIHBhcmFtZXRlciBtdXN0IGJlIGEgZnVuY3Rpb24uIik7CiAgICB9CgogICAgaWYgKHdtLk1JRElfU1lTVEVNX01FU1NBR0VTW3R5cGVdICE9PSB1bmRlZmluZWQpIHsKICAgICAgaWYgKCF0aGlzLl91c2VySGFuZGxlcnMuc3lzdGVtW3R5cGVdKSB0aGlzLl91c2VySGFuZGxlcnMuc3lzdGVtW3R5cGVdID0gW107CgogICAgICB0aGlzLl91c2VySGFuZGxlcnMuc3lzdGVtW3R5cGVdLnB1c2gobGlzdGVuZXIpOwogICAgfSBlbHNlIGlmICh3bS5NSURJX0NIQU5ORUxfTUVTU0FHRVNbdHlwZV0gIT09IHVuZGVmaW5lZCkgewogICAgICAvLyBJZiAiYWxsIiBpcyBwcmVzZW50IGFueXdoZXJlIGluIHRoZSBjaGFubmVsIGFycmF5LCB1c2UgYWxsIDE2IGNoYW5uZWxzCiAgICAgIGlmIChjaGFubmVsLmluZGV4T2YoImFsbCIpID4gLTEpIHsKICAgICAgICBjaGFubmVsID0gW107CgogICAgICAgIGZvciAodmFyIGogPSAxOyBqIDw9IDE2OyBqKyspIHsKICAgICAgICAgIGNoYW5uZWwucHVzaChqKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5fdXNlckhhbmRsZXJzLmNoYW5uZWxbdHlwZV0pIHsKICAgICAgICB0aGlzLl91c2VySGFuZGxlcnMuY2hhbm5lbFt0eXBlXSA9IFtdOwogICAgICB9IC8vIFB1c2ggYWxsIGNoYW5uZWwgbGlzdGVuZXJzIGluIHRoZSBhcnJheQoKCiAgICAgIGNoYW5uZWwuZm9yRWFjaChmdW5jdGlvbiAoY2gpIHsKICAgICAgICBpZiAoIXRoYXQuX3VzZXJIYW5kbGVycy5jaGFubmVsW3R5cGVdW2NoXSkgewogICAgICAgICAgdGhhdC5fdXNlckhhbmRsZXJzLmNoYW5uZWxbdHlwZV1bY2hdID0gW107CiAgICAgICAgfQoKICAgICAgICB0aGF0Ll91c2VySGFuZGxlcnMuY2hhbm5lbFt0eXBlXVtjaF0ucHVzaChsaXN0ZW5lcik7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVGhlIHNwZWNpZmllZCBldmVudCB0eXBlIGlzIG5vdCBzdXBwb3J0ZWQuIik7CiAgICB9CgogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBUaGlzIGlzIGFuIGFsaWFzIHRvIHRoZSB7eyNjcm9zc0xpbmsgIklucHV0L2FkZExpc3RlbmVyIn19SW5wdXQuYWRkTGlzdGVuZXIoKXt7L2Nyb3NzTGlua319CiAgICogZnVuY3Rpb24uCiAgICoKICAgKiBAbWV0aG9kIG9uCiAgICogQHNpbmNlIDIuMC4wCiAgICovCgoKICBJbnB1dC5wcm90b3R5cGUub24gPSBJbnB1dC5wcm90b3R5cGUuYWRkTGlzdGVuZXI7CiAgLyoqCiAgICogQ2hlY2tzIGlmIHRoZSBzcGVjaWZpZWQgZXZlbnQgdHlwZSBpcyBhbHJlYWR5IGRlZmluZWQgdG8gdHJpZ2dlciB0aGUgbGlzdGVuZXIgZnVuY3Rpb24gb24gdGhlCiAgICogc3BlY2lmaWVkIGNoYW5uZWwocykuIElmIG1vcmUgdGhhbiBvbmUgY2hhbm5lbCBpcyBzcGVjaWZpZWQsIHRoZSBmdW5jdGlvbiB3aWxsIHJldHVybiBgdHJ1ZWAKICAgKiBvbmx5IGlmIGFsbCBjaGFubmVscyBoYXZlIHRoZSBsaXN0ZW5lciBkZWZpbmVkLgogICAqCiAgICogRm9yIGRldmljZS13aWRlIGV2ZW50cyAoYHN5c2V4YCwgYHN0YXJ0YCwgZXRjLiksIHRoZSBgY2hhbm5lbGAgcGFyYW1ldGVyIGlzIHNpbGVudGx5IGlnbm9yZWQuCiAgICogV2Ugc3VnZ2VzdCB5b3UgdXNlIGB1bmRlZmluZWRgIGluIHN1Y2ggY2FzZXMuCiAgICoKICAgKiBAbWV0aG9kIGhhc0xpc3RlbmVyCiAgICoKICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfSBUaGUgdHlwZSBvZiB0aGUgZXZlbnQuCiAgICogQHBhcmFtIGNoYW5uZWwge051bWJlcnxBcnJheXxTdHJpbmd9IFRoZSBNSURJIGNoYW5uZWwgdG8gY2hlY2sgb24gKGJldHdlZW4gMSBhbmQgMTYpLiBZb3UKICAgKiBjYW4gYWxzbyBzcGVjaWZ5IGFuIGFycmF5IG9mIGNoYW5uZWwgbnVtYmVycyBvciB0aGUgc3RyaW5nICJhbGwiLgogICAqIEBwYXJhbSBsaXN0ZW5lciB7RnVuY3Rpb259IFRoZSBjYWxsYmFjayBmdW5jdGlvbiB0byBjaGVjayBmb3IuCiAgICoKICAgKiBAdGhyb3dzIHtUeXBlRXJyb3J9IFRoZSAibGlzdGVuZXIiIHBhcmFtZXRlciBtdXN0IGJlIGEgZnVuY3Rpb24uCiAgICoKICAgKiBAcmV0dXJuIHtCb29sZWFufSBCb29sZWFuIHZhbHVlIGluZGljYXRpbmcgd2hldGhlciBvciBub3QgdGhlIGNoYW5uZWwocykgYWxyZWFkeSBoYXZlIHRoaXMKICAgKiBsaXN0ZW5lciBkZWZpbmVkLgogICAqLwoKICBJbnB1dC5wcm90b3R5cGUuaGFzTGlzdGVuZXIgPSBmdW5jdGlvbiAodHlwZSwgY2hhbm5lbCwgbGlzdGVuZXIpIHsKICAgIHZhciB0aGF0ID0gdGhpczsKCiAgICBpZiAodHlwZW9mIGxpc3RlbmVyICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlRoZSAnbGlzdGVuZXInIHBhcmFtZXRlciBtdXN0IGJlIGEgZnVuY3Rpb24uIik7CiAgICB9CgogICAgaWYgKGNoYW5uZWwgPT09IHVuZGVmaW5lZCkgewogICAgICBjaGFubmVsID0gImFsbCI7CiAgICB9CgogICAgaWYgKGNoYW5uZWwuY29uc3RydWN0b3IgIT09IEFycmF5KSB7CiAgICAgIGNoYW5uZWwgPSBbY2hhbm5lbF07CiAgICB9CgogICAgaWYgKHdtLk1JRElfU1lTVEVNX01FU1NBR0VTW3R5cGVdICE9PSB1bmRlZmluZWQpIHsKICAgICAgZm9yICh2YXIgbyA9IDA7IG8gPCB0aGlzLl91c2VySGFuZGxlcnMuc3lzdGVtW3R5cGVdLmxlbmd0aDsgbysrKSB7CiAgICAgICAgaWYgKHRoaXMuX3VzZXJIYW5kbGVycy5zeXN0ZW1bdHlwZV1bb10gPT09IGxpc3RlbmVyKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSBpZiAod20uTUlESV9DSEFOTkVMX01FU1NBR0VTW3R5cGVdICE9PSB1bmRlZmluZWQpIHsKICAgICAgLy8gSWYgImFsbCIgaXMgcHJlc2VudCBhbnl3aGVyZSBpbiB0aGUgY2hhbm5lbCBhcnJheSwgdXNlIGFsbCAxNiBjaGFubmVscwogICAgICBpZiAoY2hhbm5lbC5pbmRleE9mKCJhbGwiKSA+IC0xKSB7CiAgICAgICAgY2hhbm5lbCA9IFtdOwoKICAgICAgICBmb3IgKHZhciBqID0gMTsgaiA8PSAxNjsgaisrKSB7CiAgICAgICAgICBjaGFubmVsLnB1c2goaik7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoIXRoaXMuX3VzZXJIYW5kbGVycy5jaGFubmVsW3R5cGVdKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9IC8vIEdvIHRocm91Z2ggYWxsIHNwZWNpZmllZCBjaGFubmVscwoKCiAgICAgIHJldHVybiBjaGFubmVsLmV2ZXJ5KGZ1bmN0aW9uIChjaE51bSkgewogICAgICAgIHZhciBsaXN0ZW5lcnMgPSB0aGF0Ll91c2VySGFuZGxlcnMuY2hhbm5lbFt0eXBlXVtjaE51bV07CiAgICAgICAgcmV0dXJuIGxpc3RlbmVycyAmJiBsaXN0ZW5lcnMuaW5kZXhPZihsaXN0ZW5lcikgPiAtMTsKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIGZhbHNlOwogIH07CiAgLyoqCiAgICogUmVtb3ZlcyB0aGUgc3BlY2lmaWVkIGxpc3RlbmVyIGZyb20gdGhlIHNwZWNpZmllZCBjaGFubmVsKHMpLiBJZiB0aGUgYGxpc3RlbmVyYCBwYXJhbWV0ZXIgaXMKICAgKiBsZWZ0IHVuZGVmaW5lZCwgYWxsIGxpc3RlbmVycyBmb3IgdGhlIHNwZWNpZmllZCBgdHlwZWAgd2lsbCBiZSByZW1vdmVkIGZyb20gYWxsIGNoYW5uZWxzLiBJZgogICAqIHRoZSBgY2hhbm5lbGAgaXMgYWxzbyBvbWl0dGVkLCBhbGwgbGlzdGVuZXJzIG9mIHRoZSBzcGVjaWZpZWQgdHlwZSB3aWxsIGJlIHJlbW92ZWQgZnJvbSBhbGwKICAgKiBjaGFubmVscy4gSWYgbm8gcGFyYW1ldGVycyBhcmUgZGVmaW5lZCwgYWxsIGxpc3RlbmVycyBhdHRhY2hlZCB0byBhbnkgY2hhbm5lbCBvZiB0aGUgYElucHV0YAogICAqIHdpbGwgYmUgcmVtb3ZlZC4KICAgKgogICAqIEZvciBkZXZpY2Utd2lkZSBldmVudHMgKGBzeXNleGAsIGBzdGFydGAsIGV0Yy4pLCB0aGUgYGNoYW5uZWxgIHBhcmFtZXRlciBpcyBzaWxlbnRseSBpZ25vcmVkLgogICAqIFlvdSBjYW4gdXNlIGB1bmRlZmluZWRgIGluIHN1Y2ggY2FzZXMuCiAgICoKICAgKiBAbWV0aG9kIHJlbW92ZUxpc3RlbmVyCiAgICogQGNoYWluYWJsZQogICAqCiAgICogQHBhcmFtIFt0eXBlXSB7U3RyaW5nfSBUaGUgdHlwZSBvZiB0aGUgZXZlbnQuCiAgICogQHBhcmFtIFtjaGFubmVsXSB7TnVtYmVyfFN0cmluZ3xBcnJheX0gVGhlIE1JREkgY2hhbm5lbChzKSB0byBjaGVjayBvbi4gSXQgY2FuIGJlIGEgdWludAogICAqIChiZXR3ZWVuIDEgYW5kIDE2KSBhbiBhcnJheSBvZiBjaGFubmVsIG51bWJlcnMgb3IgdGhlIHNwZWNpYWwgdmFsdWUgImFsbCIuCiAgICogQHBhcmFtIFtsaXN0ZW5lcl0ge0Z1bmN0aW9ufSBUaGUgY2FsbGJhY2sgZnVuY3Rpb24gdG8gY2hlY2sgZm9yLgogICAqCiAgICogQHRocm93cyB7VHlwZUVycm9yfSBUaGUgc3BlY2lmaWVkIGV2ZW50IHR5cGUgaXMgbm90IHN1cHBvcnRlZC4KICAgKiBAdGhyb3dzIHtUeXBlRXJyb3J9IFRoZSAibGlzdGVuZXIiIHBhcmFtZXRlciBtdXN0IGJlIGEgZnVuY3Rpb24uLgogICAqCiAgICogQHJldHVybiB7SW5wdXR9IFRoZSBgSW5wdXRgIG9iamVjdCBmb3IgZWFzeSBtZXRob2QgY2hhaW5pbmcuCiAgICovCgoKICBJbnB1dC5wcm90b3R5cGUucmVtb3ZlTGlzdGVuZXIgPSBmdW5jdGlvbiAodHlwZSwgY2hhbm5lbCwgbGlzdGVuZXIpIHsKICAgIHZhciB0aGF0ID0gdGhpczsKCiAgICBpZiAobGlzdGVuZXIgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgbGlzdGVuZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVGhlICdsaXN0ZW5lcicgcGFyYW1ldGVyIG11c3QgYmUgYSBmdW5jdGlvbi4iKTsKICAgIH0KCiAgICBpZiAoY2hhbm5lbCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGNoYW5uZWwgPSAiYWxsIjsKICAgIH0KCiAgICBpZiAoY2hhbm5lbC5jb25zdHJ1Y3RvciAhPT0gQXJyYXkpIHsKICAgICAgY2hhbm5lbCA9IFtjaGFubmVsXTsKICAgIH0KCiAgICBpZiAod20uTUlESV9TWVNURU1fTUVTU0FHRVNbdHlwZV0gIT09IHVuZGVmaW5lZCkgewogICAgICBpZiAobGlzdGVuZXIgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHRoaXMuX3VzZXJIYW5kbGVycy5zeXN0ZW1bdHlwZV0gPSBbXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmb3IgKHZhciBvID0gMDsgbyA8IHRoaXMuX3VzZXJIYW5kbGVycy5zeXN0ZW1bdHlwZV0ubGVuZ3RoOyBvKyspIHsKICAgICAgICAgIGlmICh0aGlzLl91c2VySGFuZGxlcnMuc3lzdGVtW3R5cGVdW29dID09PSBsaXN0ZW5lcikgewogICAgICAgICAgICB0aGlzLl91c2VySGFuZGxlcnMuc3lzdGVtW3R5cGVdLnNwbGljZShvLCAxKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSBpZiAod20uTUlESV9DSEFOTkVMX01FU1NBR0VTW3R5cGVdICE9PSB1bmRlZmluZWQpIHsKICAgICAgLy8gSWYgImFsbCIgaXMgcHJlc2VudCBhbnl3aGVyZSBpbiB0aGUgY2hhbm5lbCBhcnJheSwgdXNlIGFsbCAxNiBjaGFubmVscwogICAgICBpZiAoY2hhbm5lbC5pbmRleE9mKCJhbGwiKSA+IC0xKSB7CiAgICAgICAgY2hhbm5lbCA9IFtdOwoKICAgICAgICBmb3IgKHZhciBqID0gMTsgaiA8PSAxNjsgaisrKSB7CiAgICAgICAgICBjaGFubmVsLnB1c2goaik7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoIXRoaXMuX3VzZXJIYW5kbGVycy5jaGFubmVsW3R5cGVdKSB7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0gLy8gR28gdGhyb3VnaCBhbGwgc3BlY2lmaWVkIGNoYW5uZWxzCgoKICAgICAgY2hhbm5lbC5mb3JFYWNoKGZ1bmN0aW9uIChjaE51bSkgewogICAgICAgIHZhciBsaXN0ZW5lcnMgPSB0aGF0Ll91c2VySGFuZGxlcnMuY2hhbm5lbFt0eXBlXVtjaE51bV07CgogICAgICAgIGlmICghbGlzdGVuZXJzKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAobGlzdGVuZXIgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgdGhhdC5fdXNlckhhbmRsZXJzLmNoYW5uZWxbdHlwZV1bY2hOdW1dID0gW107CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZvciAodmFyIGwgPSAwOyBsIDwgbGlzdGVuZXJzLmxlbmd0aDsgbCsrKSB7CiAgICAgICAgICAgIGlmIChsaXN0ZW5lcnNbbF0gPT09IGxpc3RlbmVyKSB7CiAgICAgICAgICAgICAgbGlzdGVuZXJzLnNwbGljZShsLCAxKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKHR5cGUgPT09IHVuZGVmaW5lZCkgewogICAgICB0aGlzLl9pbml0aWFsaXplVXNlckhhbmRsZXJzKCk7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJUaGUgc3BlY2lmaWVkIGV2ZW50IHR5cGUgaXMgbm90IHN1cHBvcnRlZC4iKTsKICAgIH0KCiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIEBtZXRob2QgX2luaXRpYWxpemVVc2VySGFuZGxlcnMKICAgKiBAcHJvdGVjdGVkCiAgICovCgoKICBJbnB1dC5wcm90b3R5cGUuX2luaXRpYWxpemVVc2VySGFuZGxlcnMgPSBmdW5jdGlvbiAoKSB7CiAgICBmb3IgKHZhciBwcm9wMSBpbiB3bS5NSURJX0NIQU5ORUxfTUVTU0FHRVMpIHsKICAgICAgaWYgKHdtLk1JRElfQ0hBTk5FTF9NRVNTQUdFUy5oYXNPd25Qcm9wZXJ0eShwcm9wMSkpIHsKICAgICAgICB0aGlzLl91c2VySGFuZGxlcnMuY2hhbm5lbFtwcm9wMV0gPSB7fTsKICAgICAgfQogICAgfQoKICAgIGZvciAodmFyIHByb3AyIGluIHdtLk1JRElfU1lTVEVNX01FU1NBR0VTKSB7CiAgICAgIGlmICh3bS5NSURJX1NZU1RFTV9NRVNTQUdFUy5oYXNPd25Qcm9wZXJ0eShwcm9wMikpIHsKICAgICAgICB0aGlzLl91c2VySGFuZGxlcnMuc3lzdGVtW3Byb3AyXSA9IFtdOwogICAgICB9CiAgICB9CiAgfTsKICAvKioKICAgKiBAbWV0aG9kIF9vbk1pZGlNZXNzYWdlCiAgICogQHByb3RlY3RlZAogICAqLwoKCiAgSW5wdXQucHJvdG90eXBlLl9vbk1pZGlNZXNzYWdlID0gZnVuY3Rpb24gKGUpIHsKICAgIC8vIEV4ZWN1dGUgIm1pZGltZXNzYWdlIiBsaXN0ZW5lcnMgKGlmIGFueSkKICAgIGlmICh0aGlzLl91c2VySGFuZGxlcnMuc3lzdGVtWyJtaWRpbWVzc2FnZSJdLmxlbmd0aCA+IDApIHsKICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgIHRhcmdldDogdGhpcywKICAgICAgICBkYXRhOiBlLmRhdGEsCiAgICAgICAgdGltZXN0YW1wOiBlLnRpbWVTdGFtcCwKICAgICAgICB0eXBlOiAibWlkaW1lc3NhZ2UiCiAgICAgIH07CiAgICAgIC8qKgogICAgICAgKiBFdmVudCBlbWl0dGVkIHdoZW4gYSBNSURJIG1lc3NhZ2UgaXMgcmVjZWl2ZWQuIFRoaXMgc2hvdWxkIGJlIHVzZWQgcHJpbWFyaWx5IGZvciBkZWJ1Z2dpbmcKICAgICAgICogcHVycG9zZXMuCiAgICAgICAqCiAgICAgICAqIEBldmVudCBtaWRpbWVzc2FnZQogICAgICAgKgogICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQKICAgICAgICogQHBhcmFtIHtJbnB1dH0gZXZlbnQudGFyZ2V0IFRoZSBgSW5wdXRgIHRoYXQgdHJpZ2dlcmVkIHRoZSBldmVudC4KICAgICAgICogQHBhcmFtIHtVaW50OEFycmF5fSBldmVudC5kYXRhIFRoZSByYXcgTUlESSBtZXNzYWdlIGFzIGFuIGFycmF5IG9mIDggYml0IHZhbHVlcy4KICAgICAgICogQHBhcmFtIHt1aW50fSBldmVudC50aW1lc3RhbXAgVGhlIHRpbWVzdGFtcCB3aGVuIHRoZSBldmVudCBvY2N1cnJlZCAoaW4gbWlsbGlzZWNvbmRzIHNpbmNlCiAgICAgICAqIHRoZSBbVW5peCBFcG9jaF0oaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvVW5peF90aW1lKSkuCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudC50eXBlIFRoZSB0eXBlIG9mIGV2ZW50IHRoYXQgb2NjdXJyZWQuCiAgICAgICAqIEBzaW5jZSAyLjEKICAgICAgICovCgogICAgICB0aGlzLl91c2VySGFuZGxlcnMuc3lzdGVtWyJtaWRpbWVzc2FnZSJdLmZvckVhY2goZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgY2FsbGJhY2soZXZlbnQpOwogICAgICB9KTsKICAgIH0KCiAgICBpZiAoZS5kYXRhWzBdIDwgMjQwKSB7CiAgICAgIC8vIGNoYW5uZWwtc3BlY2lmaWMgbWVzc2FnZQogICAgICB0aGlzLl9wYXJzZUNoYW5uZWxFdmVudChlKTsKCiAgICAgIHRoaXMuX3BhcnNlTnJwbkV2ZW50KGUpOwogICAgfSBlbHNlIGlmIChlLmRhdGFbMF0gPD0gMjU1KSB7CiAgICAgIC8vIHN5c3RlbSBtZXNzYWdlCiAgICAgIHRoaXMuX3BhcnNlU3lzdGVtRXZlbnQoZSk7CiAgICB9CiAgfTsKICAvKioKICAgKiBQYXJzZXMgY2hhbm5lbCBldmVudHMgYW5kIGNvbnN0cnVjdHMgTlJQTiBtZXNzYWdlIHBhcnRzIGluIHZhbGlkIHNlcXVlbmNlcy4KICAgKiBLZWVwcyBhIHNlcGFyYXRlIE5SUE4gYnVmZmVyIGZvciBlYWNoIGNoYW5uZWwuCiAgICogRW1pdHMgYW4gZXZlbnQgYWZ0ZXIgaXQgcmVjZWl2ZXMgdGhlIGZpbmFsIENDIHBhcnRzIG1zYiAxMjcgbHNiIDEyNy4KICAgKiBJZiBhIG1lc3NhZ2UgaXMgaW5jb21wbGV0ZSBhbmQgb3RoZXIgbWVzc2FnZXMgYXJlIHJlY2VpdmVkIGJlZm9yZQogICAqIHRoZSBmaW5hbCAxMjcgYnl0ZXMsIHRoZSBpbmNvbXBsZXRlIG1lc3NhZ2UgaXMgY2xlYXJlZC4KICAgKiBAbWV0aG9kIF9wYXJzZU5ycG5FdmVudAogICAqIEBwYXJhbSBlIEV2ZW50CiAgICogQHByb3RlY3RlZAogICAqLwoKCiAgSW5wdXQucHJvdG90eXBlLl9wYXJzZU5ycG5FdmVudCA9IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgY29tbWFuZCA9IGUuZGF0YVswXSA+PiA0OwogICAgdmFyIGNoYW5uZWxCdWZmZXJJbmRleCA9IGUuZGF0YVswXSAmIDB4ZjsgLy8gdXNlIHRoaXMgZm9yIGluZGV4IG9mIGNoYW5uZWwgaW4gX25ycG5CdWZmZXIKCiAgICB2YXIgY2hhbm5lbCA9IGNoYW5uZWxCdWZmZXJJbmRleCArIDE7CiAgICB2YXIgZGF0YTEsIGRhdGEyOwoKICAgIGlmIChlLmRhdGEubGVuZ3RoID4gMSkgewogICAgICBkYXRhMSA9IGUuZGF0YVsxXTsKICAgICAgZGF0YTIgPSBlLmRhdGEubGVuZ3RoID4gMiA/IGUuZGF0YVsyXSA6IHVuZGVmaW5lZDsKICAgIH0gLy8gbnJwbiBkaXNhYmxlZAoKCiAgICBpZiAoIXdtLm5ycG5FdmVudHNFbmFibGVkKSB7CiAgICAgIHJldHVybjsKICAgIH0gLy8gbnJwbiBlbmFibGVkLCBtZXNzYWdlIG5vdCB2YWxpZCBmb3IgbnJwbgoKCiAgICBpZiAoIShjb21tYW5kID09PSB3bS5NSURJX0NIQU5ORUxfTUVTU0FHRVMuY29udHJvbGNoYW5nZSAmJiAoZGF0YTEgPj0gd20uTUlESV9OUlBOX01FU1NBR0VTLmluY3JlbWVudCAmJiBkYXRhMSA8PSB3bS5NSURJX05SUE5fTUVTU0FHRVMucGFyYW1tc2IgfHwgZGF0YTEgPT09IHdtLk1JRElfTlJQTl9NRVNTQUdFUy5lbnRyeW1zYiB8fCBkYXRhMSA9PT0gd20uTUlESV9OUlBOX01FU1NBR0VTLmVudHJ5bHNiKSkpIHsKICAgICAgcmV0dXJuOwogICAgfSAvLyBzZXQgdXAgYSBDQyBldmVudCB0byBwYXJzZSBhcyBOUlBOIHBhcnQKCgogICAgdmFyIGNjRXZlbnQgPSB7CiAgICAgIHRhcmdldDogdGhpcywKICAgICAgdHlwZTogImNvbnRyb2xjaGFuZ2UiLAogICAgICBkYXRhOiBlLmRhdGEsCiAgICAgIHRpbWVzdGFtcDogZS50aW1lU3RhbXAsCiAgICAgIGNoYW5uZWw6IGNoYW5uZWwsCiAgICAgIGNvbnRyb2xsZXI6IHsKICAgICAgICBudW1iZXI6IGRhdGExLAogICAgICAgIG5hbWU6IHRoaXMuZ2V0Q2NOYW1lQnlOdW1iZXIoZGF0YTEpCiAgICAgIH0sCiAgICAgIHZhbHVlOiBkYXRhMgogICAgfTsKCiAgICBpZiAoIC8vIGlmIHdlIGdldCBhIHN0YXJ0aW5nIE1TQihDQzk5IC0gMC0xMjYpIHZzIGFuIGVuZCBNU0IoQ0M5OSAtIDEyNykKICAgIC8vIGRlc3Ryb3kgaW5jbG9tcGxldGUgTlJQTiBhbmQgYmVnaW4gYnVpbGRpbmcgYWdhaW4KICAgIGNjRXZlbnQuY29udHJvbGxlci5udW1iZXIgPT09IHdtLk1JRElfTlJQTl9NRVNTQUdFUy5wYXJhbW1zYiAmJiBjY0V2ZW50LnZhbHVlICE9IHdtLk1JRElfTlJQTl9NRVNTQUdFUy5udWxsYWN0aXZlcGFyYW1ldGVyKSB7CiAgICAgIHdtLl9ucnBuQnVmZmVyW2NoYW5uZWxCdWZmZXJJbmRleF0gPSBbXTsKICAgICAgd20uX25ycG5CdWZmZXJbY2hhbm5lbEJ1ZmZlckluZGV4XVswXSA9IGNjRXZlbnQ7CiAgICB9IGVsc2UgaWYgKCAvLyBhZGQgdGhlIHBhcmFtIExTQgogICAgd20uX25ycG5CdWZmZXJbY2hhbm5lbEJ1ZmZlckluZGV4XS5sZW5ndGggPT09IDEgJiYgY2NFdmVudC5jb250cm9sbGVyLm51bWJlciA9PT0gd20uTUlESV9OUlBOX01FU1NBR0VTLnBhcmFtbHNiKSB7CiAgICAgIHdtLl9ucnBuQnVmZmVyW2NoYW5uZWxCdWZmZXJJbmRleF0ucHVzaChjY0V2ZW50KTsKICAgIH0gZWxzZSBpZiAoIC8vIGFkZCBkYXRhIGluYy9kZWMgb3IgdmFsdWUgTVNCIGZvciAxNGJpdAogICAgd20uX25ycG5CdWZmZXJbY2hhbm5lbEJ1ZmZlckluZGV4XS5sZW5ndGggPT09IDIgJiYgKGNjRXZlbnQuY29udHJvbGxlci5udW1iZXIgPT09IHdtLk1JRElfTlJQTl9NRVNTQUdFUy5pbmNyZW1lbnQgfHwgY2NFdmVudC5jb250cm9sbGVyLm51bWJlciA9PT0gd20uTUlESV9OUlBOX01FU1NBR0VTLmRlY3JlbWVudCB8fCBjY0V2ZW50LmNvbnRyb2xsZXIubnVtYmVyID09PSB3bS5NSURJX05SUE5fTUVTU0FHRVMuZW50cnltc2IpKSB7CiAgICAgIHdtLl9ucnBuQnVmZmVyW2NoYW5uZWxCdWZmZXJJbmRleF0ucHVzaChjY0V2ZW50KTsKICAgIH0gZWxzZSBpZiAoIC8vIGlmIHdlIGhhdmUgYSB2YWx1ZSBNU0IsIG9ubHkgYWRkIGFuIExTQiB0byBwYWlyIHdpdGggdGhhdAogICAgd20uX25ycG5CdWZmZXJbY2hhbm5lbEJ1ZmZlckluZGV4XS5sZW5ndGggPT09IDMgJiYgd20uX25ycG5CdWZmZXJbY2hhbm5lbEJ1ZmZlckluZGV4XVsyXS5udW1iZXIgPT09IHdtLk1JRElfTlJQTl9NRVNTQUdFUy5lbnRyeW1zYiAmJiBjY0V2ZW50LmNvbnRyb2xsZXIubnVtYmVyID09PSB3bS5NSURJX05SUE5fTUVTU0FHRVMuZW50cnlsc2IpIHsKICAgICAgd20uX25ycG5CdWZmZXJbY2hhbm5lbEJ1ZmZlckluZGV4XS5wdXNoKGNjRXZlbnQpOwogICAgfSBlbHNlIGlmICggLy8gYWRkIGFuIGVuZCBNU0IoQ0M5OSAtIDEyNykKICAgIHdtLl9ucnBuQnVmZmVyW2NoYW5uZWxCdWZmZXJJbmRleF0ubGVuZ3RoID49IDMgJiYgd20uX25ycG5CdWZmZXJbY2hhbm5lbEJ1ZmZlckluZGV4XS5sZW5ndGggPD0gNCAmJiBjY0V2ZW50LmNvbnRyb2xsZXIubnVtYmVyID09PSB3bS5NSURJX05SUE5fTUVTU0FHRVMucGFyYW1tc2IgJiYgY2NFdmVudC52YWx1ZSA9PT0gd20uTUlESV9OUlBOX01FU1NBR0VTLm51bGxhY3RpdmVwYXJhbWV0ZXIpIHsKICAgICAgd20uX25ycG5CdWZmZXJbY2hhbm5lbEJ1ZmZlckluZGV4XS5wdXNoKGNjRXZlbnQpOwogICAgfSBlbHNlIGlmICggLy8gYWRkIGFuIGVuZCBMU0IoQ0M5OSAtIDEyNykKICAgIHdtLl9ucnBuQnVmZmVyW2NoYW5uZWxCdWZmZXJJbmRleF0ubGVuZ3RoID49IDQgJiYgd20uX25ycG5CdWZmZXJbY2hhbm5lbEJ1ZmZlckluZGV4XS5sZW5ndGggPD0gNSAmJiBjY0V2ZW50LmNvbnRyb2xsZXIubnVtYmVyID09PSB3bS5NSURJX05SUE5fTUVTU0FHRVMucGFyYW1sc2IgJiYgY2NFdmVudC52YWx1ZSA9PT0gd20uTUlESV9OUlBOX01FU1NBR0VTLm51bGxhY3RpdmVwYXJhbWV0ZXIpIHsKICAgICAgd20uX25ycG5CdWZmZXJbY2hhbm5lbEJ1ZmZlckluZGV4XS5wdXNoKGNjRXZlbnQpOyAvLyBub3cgd2UgaGF2ZSBhIGZ1bGwgaW5jIG9yIGRlYyBOUlBOIG1lc3NhZ2UsIGxldHMgY3JlYXRlIHRoYXQgZXZlbnQhCgoKICAgICAgdmFyIHJhd0RhdGEgPSBbXTsKCiAgICAgIHdtLl9ucnBuQnVmZmVyW2NoYW5uZWxCdWZmZXJJbmRleF0uZm9yRWFjaChmdW5jdGlvbiAoZXYpIHsKICAgICAgICByYXdEYXRhLnB1c2goZXYuZGF0YSk7CiAgICAgIH0pOwoKICAgICAgdmFyIG5ycG5OdW1iZXIgPSB3bS5fbnJwbkJ1ZmZlcltjaGFubmVsQnVmZmVySW5kZXhdWzBdLnZhbHVlIDw8IDcgfCB3bS5fbnJwbkJ1ZmZlcltjaGFubmVsQnVmZmVySW5kZXhdWzFdLnZhbHVlOwogICAgICB2YXIgbnJwblZhbHVlID0gd20uX25ycG5CdWZmZXJbY2hhbm5lbEJ1ZmZlckluZGV4XVsyXS52YWx1ZTsKCiAgICAgIGlmICh3bS5fbnJwbkJ1ZmZlcltjaGFubmVsQnVmZmVySW5kZXhdLmxlbmd0aCA9PT0gNikgewogICAgICAgIG5ycG5WYWx1ZSA9IHdtLl9ucnBuQnVmZmVyW2NoYW5uZWxCdWZmZXJJbmRleF1bMl0udmFsdWUgPDwgNyB8IHdtLl9ucnBuQnVmZmVyW2NoYW5uZWxCdWZmZXJJbmRleF1bM10udmFsdWU7CiAgICAgIH0KCiAgICAgIHZhciBucnBuQ29udHJvbGxlclR5cGUgPSAiIjsKCiAgICAgIHN3aXRjaCAod20uX25ycG5CdWZmZXJbY2hhbm5lbEJ1ZmZlckluZGV4XVsyXS5jb250cm9sbGVyLm51bWJlcikgewogICAgICAgIGNhc2Ugd20uTUlESV9OUlBOX01FU1NBR0VTLmVudHJ5bXNiOgogICAgICAgICAgbnJwbkNvbnRyb2xsZXJUeXBlID0gd20uX25ycG5UeXBlc1swXTsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlIHdtLk1JRElfTlJQTl9NRVNTQUdFUy5pbmNyZW1lbnQ6CiAgICAgICAgICBucnBuQ29udHJvbGxlclR5cGUgPSB3bS5fbnJwblR5cGVzWzFdOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2Ugd20uTUlESV9OUlBOX01FU1NBR0VTLmRlY3JlbWVudDoKICAgICAgICAgIG5ycG5Db250cm9sbGVyVHlwZSA9IHdtLl9ucnBuVHlwZXNbMl07CiAgICAgICAgICBicmVhazsKCiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIE5QUk4gdHlwZSB3YXMgdW5pZGVudGlmaWFibGUuIik7CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIEV2ZW50IGVtaXR0ZWQgd2hlbiBhIHZhbGlkIE5SUE4gbWVzc2FnZSBzZXF1ZW5jZSBoYXMgYmVlbiByZWNlaXZlZCBvbiBhIHNwZWNpZmljIGRldmljZSBhbmQKICAgICAgICogY2hhbm5lbC4KICAgICAgICoKICAgICAgICogQGV2ZW50IG5ycG4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50CiAgICAgICAqIEBwYXJhbSB7SW5wdXR9IGV2ZW50LnRhcmdldCBUaGUgYElucHV0YCB0aGF0IHRyaWdnZXJlZCB0aGUgZXZlbnQuCiAgICAgICAqIEBwYXJhbSB7QXJyYXl9IGV2ZW50LmRhdGEgVGhlIHJhdyBNSURJIG1lc3NhZ2UgYXMgYXJyYXlzIG9mIDggYml0IHZhbHVlcyggVWludDhBcnJheSApLgogICAgICAgKiBAcGFyYW0ge051bWJlcn0gZXZlbnQudGltZXN0YW1wIFRoZSB0aW1lIHdoZW4gdGhlIGV2ZW50IG9jY3VycmVkIChpbiBtaWxsaXNlY29uZHMpCiAgICAgICAqIEBwYXJhbSB7dWludH0gZXZlbnQuY2hhbm5lbCBUaGUgY2hhbm5lbCB3aGVyZSB0aGUgZXZlbnQgb2NjdXJyZWQgKGJldHdlZW4gMSBhbmQgMTYpLgogICAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnQudHlwZSBUaGUgdHlwZSBvZiBldmVudCB0aGF0IG9jY3VycmVkLgogICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQuY29udHJvbGxlcgogICAgICAgKiBAcGFyYW0ge3VpbnR9IGV2ZW50LmNvbnRyb2xsZXIubnVtYmVyIFRoZSBudW1iZXIgb2YgdGhlIE5SUE4uCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudC5jb250cm9sbGVyLm5hbWUgVGhlIHVzdWFsIG5hbWUgb3IgZnVuY3Rpb24gb2YgdGhlIGNvbnRyb2xsZXIuCiAgICAgICAqIEBwYXJhbSB7dWludH0gZXZlbnQudmFsdWUgVGhlIHZhbHVlIHJlY2VpdmVkIChiZXR3ZWVuIDAgYW5kIDY1NTM1KS4KICAgICAgICovCgoKICAgICAgdmFyIG5ycG5FdmVudCA9IHsKICAgICAgICB0aW1lc3RhbXA6IGNjRXZlbnQudGltZXN0YW1wLAogICAgICAgIGNoYW5uZWw6IGNjRXZlbnQuY2hhbm5lbCwKICAgICAgICB0eXBlOiAibnJwbiIsCiAgICAgICAgZGF0YTogcmF3RGF0YSwKICAgICAgICBjb250cm9sbGVyOiB7CiAgICAgICAgICBudW1iZXI6IG5ycG5OdW1iZXIsCiAgICAgICAgICB0eXBlOiBucnBuQ29udHJvbGxlclR5cGUsCiAgICAgICAgICBuYW1lOiAiTm9uLVJlZ2lzdGVyZWQgUGFyYW1ldGVyICIgKyBucnBuTnVtYmVyCiAgICAgICAgfSwKICAgICAgICB2YWx1ZTogbnJwblZhbHVlCiAgICAgIH07IC8vIG5vdyB3ZSBhcmUgZG9uZSBidWlsZGluZyBhbiBOUlBOLCBzbyBjbGVhciB0aGUgTlJQTiBidWZmZXIgZm9yIHRoaXMgY2hhbm5lbAoKICAgICAgd20uX25ycG5CdWZmZXJbY2hhbm5lbEJ1ZmZlckluZGV4XSA9IFtdOyAvLyBJZiBzb21lIGNhbGxiYWNrcyBoYXZlIGJlZW4gZGVmaW5lZCBmb3IgdGhpcyBldmVudCwgb24gdGhhdCBkZXZpY2UgYW5kIGNoYW5uZWwsIGV4ZWN1dGUKICAgICAgLy8gdGhlbS4KCiAgICAgIGlmICh0aGlzLl91c2VySGFuZGxlcnMuY2hhbm5lbFtucnBuRXZlbnQudHlwZV0gJiYgdGhpcy5fdXNlckhhbmRsZXJzLmNoYW5uZWxbbnJwbkV2ZW50LnR5cGVdW25ycG5FdmVudC5jaGFubmVsXSkgewogICAgICAgIHRoaXMuX3VzZXJIYW5kbGVycy5jaGFubmVsW25ycG5FdmVudC50eXBlXVtucnBuRXZlbnQuY2hhbm5lbF0uZm9yRWFjaChmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgIGNhbGxiYWNrKG5ycG5FdmVudCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIC8vIHNvbWV0aGluZyBkaWRuJ3QgbWF0Y2gsIGNsZWFyIHRoZSBpbmNvbXBsZXRlIE5SUE4gbWVzc2FnZSBieQogICAgICB3bS5fbnJwbkJ1ZmZlcltjaGFubmVsQnVmZmVySW5kZXhdID0gW107CiAgICB9CiAgfTsKICAvKioKICAgKiBAbWV0aG9kIF9wYXJzZUNoYW5uZWxFdmVudAogICAqIEBwYXJhbSBlIEV2ZW50CiAgICogQHByb3RlY3RlZAogICAqLwoKCiAgSW5wdXQucHJvdG90eXBlLl9wYXJzZUNoYW5uZWxFdmVudCA9IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgY29tbWFuZCA9IGUuZGF0YVswXSA+PiA0OwogICAgdmFyIGNoYW5uZWwgPSAoZS5kYXRhWzBdICYgMHhmKSArIDE7CiAgICB2YXIgZGF0YTEsIGRhdGEyOwoKICAgIGlmIChlLmRhdGEubGVuZ3RoID4gMSkgewogICAgICBkYXRhMSA9IGUuZGF0YVsxXTsKICAgICAgZGF0YTIgPSBlLmRhdGEubGVuZ3RoID4gMiA/IGUuZGF0YVsyXSA6IHVuZGVmaW5lZDsKICAgIH0gLy8gUmV0dXJuZWQgZXZlbnQKCgogICAgdmFyIGV2ZW50ID0gewogICAgICB0YXJnZXQ6IHRoaXMsCiAgICAgIGRhdGE6IGUuZGF0YSwKICAgICAgdGltZXN0YW1wOiBlLnRpbWVTdGFtcCwKICAgICAgY2hhbm5lbDogY2hhbm5lbAogICAgfTsKCiAgICBpZiAoY29tbWFuZCA9PT0gd20uTUlESV9DSEFOTkVMX01FU1NBR0VTLm5vdGVvZmYgfHwgY29tbWFuZCA9PT0gd20uTUlESV9DSEFOTkVMX01FU1NBR0VTLm5vdGVvbiAmJiBkYXRhMiA9PT0gMCkgewogICAgICAvKioKICAgICAgICogRXZlbnQgZW1pdHRlZCB3aGVuIGEgbm90ZSBvZmYgTUlESSBtZXNzYWdlIGhhcyBiZWVuIHJlY2VpdmVkIG9uIGEgc3BlY2lmaWMgZGV2aWNlIGFuZAogICAgICAgKiBjaGFubmVsLgogICAgICAgKgogICAgICAgKiBAZXZlbnQgbm90ZW9mZgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQKICAgICAgICogQHBhcmFtIHtJbnB1dH0gZXZlbnQudGFyZ2V0IFRoZSBgSW5wdXRgIHRoYXQgdHJpZ2dlcmVkIHRoZSBldmVudC4KICAgICAgICogQHBhcmFtIHtVaW50OEFycmF5fSBldmVudC5kYXRhIFRoZSByYXcgTUlESSBtZXNzYWdlIGFzIGFuIGFycmF5IG9mIDggYml0IHZhbHVlcy4KICAgICAgICogQHBhcmFtIHtOdW1iZXJ9IGV2ZW50LnRpbWVzdGFtcCBUaGUgdGltZSB3aGVuIHRoZSBldmVudCBvY2N1cnJlZCAoaW4gbWlsbGlzZWNvbmRzKQogICAgICAgKiBAcGFyYW0ge3VpbnR9IGV2ZW50LmNoYW5uZWwgVGhlIGNoYW5uZWwgd2hlcmUgdGhlIGV2ZW50IG9jY3VycmVkIChiZXR3ZWVuIDEgYW5kIDE2KS4KICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50LnR5cGUgVGhlIHR5cGUgb2YgZXZlbnQgdGhhdCBvY2N1cnJlZC4KICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50Lm5vdGUKICAgICAgICogQHBhcmFtIHt1aW50fSBldmVudC5ub3RlLm51bWJlciBUaGUgTUlESSBub3RlIG51bWJlci4KICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50Lm5vdGUubmFtZSBUaGUgdXN1YWwgbm90ZSBuYW1lIChDLCBDIywgRCwgRCMsIGV0Yy4pLgogICAgICAgKiBAcGFyYW0ge3VpbnR9IGV2ZW50Lm5vdGUub2N0YXZlIFRoZSBvY3RhdmUgKGJldHdlZW4gLTIgYW5kIDgpLgogICAgICAgKiBAcGFyYW0ge051bWJlcn0gZXZlbnQudmVsb2NpdHkgVGhlIHJlbGVhc2UgdmVsb2NpdHkgKGJldHdlZW4gMCBhbmQgMSkuCiAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSBldmVudC5yYXdWZWxvY2l0eSBUaGUgYXR0YWNrIHZlbG9jaXR5IGV4cHJlc3NlZCBhcyBhIDctYml0IGludGVnZXIgKGJldHdlZW4KICAgICAgICogMCBhbmQgMTI3KS4KICAgICAgICovCiAgICAgIGV2ZW50LnR5cGUgPSAibm90ZW9mZiI7CiAgICAgIGV2ZW50Lm5vdGUgPSB7CiAgICAgICAgbnVtYmVyOiBkYXRhMSwKICAgICAgICBuYW1lOiB3bS5fbm90ZXNbZGF0YTEgJSAxMl0sCiAgICAgICAgb2N0YXZlOiB3bS5nZXRPY3RhdmUoZGF0YTEpCiAgICAgIH07CiAgICAgIGV2ZW50LnZlbG9jaXR5ID0gZGF0YTIgLyAxMjc7CiAgICAgIGV2ZW50LnJhd1ZlbG9jaXR5ID0gZGF0YTI7CiAgICB9IGVsc2UgaWYgKGNvbW1hbmQgPT09IHdtLk1JRElfQ0hBTk5FTF9NRVNTQUdFUy5ub3Rlb24pIHsKICAgICAgLyoqCiAgICAgICAqIEV2ZW50IGVtaXR0ZWQgd2hlbiBhIG5vdGUgb24gTUlESSBtZXNzYWdlIGhhcyBiZWVuIHJlY2VpdmVkIG9uIGEgc3BlY2lmaWMgZGV2aWNlIGFuZAogICAgICAgKiBjaGFubmVsLgogICAgICAgKgogICAgICAgKiBAZXZlbnQgbm90ZW9uCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudAogICAgICAgKiBAcGFyYW0ge0lucHV0fSBldmVudC50YXJnZXQgVGhlIGBJbnB1dGAgdGhhdCB0cmlnZ2VyZWQgdGhlIGV2ZW50LgogICAgICAgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGV2ZW50LmRhdGEgVGhlIHJhdyBNSURJIG1lc3NhZ2UgYXMgYW4gYXJyYXkgb2YgOCBiaXQgdmFsdWVzLgogICAgICAgKiBAcGFyYW0ge051bWJlcn0gZXZlbnQudGltZXN0YW1wIFRoZSB0aW1lIHdoZW4gdGhlIGV2ZW50IG9jY3VycmVkIChpbiBtaWxsaXNlY29uZHMpCiAgICAgICAqIEBwYXJhbSB7dWludH0gZXZlbnQuY2hhbm5lbCBUaGUgY2hhbm5lbCB3aGVyZSB0aGUgZXZlbnQgb2NjdXJyZWQgKGJldHdlZW4gMSBhbmQgMTYpLgogICAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnQudHlwZSBUaGUgdHlwZSBvZiBldmVudCB0aGF0IG9jY3VycmVkLgogICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQubm90ZQogICAgICAgKiBAcGFyYW0ge3VpbnR9IGV2ZW50Lm5vdGUubnVtYmVyIFRoZSBNSURJIG5vdGUgbnVtYmVyLgogICAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnQubm90ZS5uYW1lIFRoZSB1c3VhbCBub3RlIG5hbWUgKEMsIEMjLCBELCBEIywgZXRjLikuCiAgICAgICAqIEBwYXJhbSB7dWludH0gZXZlbnQubm90ZS5vY3RhdmUgVGhlIG9jdGF2ZSAoYmV0d2VlbiAtMiBhbmQgOCkuCiAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSBldmVudC52ZWxvY2l0eSBUaGUgYXR0YWNrIHZlbG9jaXR5IChiZXR3ZWVuIDAgYW5kIDEpLgogICAgICAgKiBAcGFyYW0ge051bWJlcn0gZXZlbnQucmF3VmVsb2NpdHkgVGhlIGF0dGFjayB2ZWxvY2l0eSBleHByZXNzZWQgYXMgYSA3LWJpdCBpbnRlZ2VyIChiZXR3ZWVuCiAgICAgICAqIDAgYW5kIDEyNykuCiAgICAgICAqLwogICAgICBldmVudC50eXBlID0gIm5vdGVvbiI7CiAgICAgIGV2ZW50Lm5vdGUgPSB7CiAgICAgICAgbnVtYmVyOiBkYXRhMSwKICAgICAgICBuYW1lOiB3bS5fbm90ZXNbZGF0YTEgJSAxMl0sCiAgICAgICAgb2N0YXZlOiB3bS5nZXRPY3RhdmUoZGF0YTEpCiAgICAgIH07CiAgICAgIGV2ZW50LnZlbG9jaXR5ID0gZGF0YTIgLyAxMjc7CiAgICAgIGV2ZW50LnJhd1ZlbG9jaXR5ID0gZGF0YTI7CiAgICB9IGVsc2UgaWYgKGNvbW1hbmQgPT09IHdtLk1JRElfQ0hBTk5FTF9NRVNTQUdFUy5rZXlhZnRlcnRvdWNoKSB7CiAgICAgIC8qKgogICAgICAgKiBFdmVudCBlbWl0dGVkIHdoZW4gYSBrZXktc3BlY2lmaWMgYWZ0ZXJ0b3VjaCBNSURJIG1lc3NhZ2UgaGFzIGJlZW4gcmVjZWl2ZWQgb24gYSBzcGVjaWZpYwogICAgICAgKiBkZXZpY2UgYW5kIGNoYW5uZWwuCiAgICAgICAqCiAgICAgICAqIEBldmVudCBrZXlhZnRlcnRvdWNoCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudAogICAgICAgKiBAcGFyYW0ge0lucHV0fSBldmVudC50YXJnZXQgVGhlIGBJbnB1dGAgdGhhdCB0cmlnZ2VyZWQgdGhlIGV2ZW50LgogICAgICAgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGV2ZW50LmRhdGEgVGhlIHJhdyBNSURJIG1lc3NhZ2UgYXMgYW4gYXJyYXkgb2YgOCBiaXQgdmFsdWVzLgogICAgICAgKiBAcGFyYW0ge051bWJlcn0gZXZlbnQudGltZXN0YW1wIFRoZSB0aW1lIHdoZW4gdGhlIGV2ZW50IG9jY3VycmVkIChpbiBtaWxsaXNlY29uZHMpCiAgICAgICAqIEBwYXJhbSB7dWludH0gZXZlbnQuY2hhbm5lbCBUaGUgY2hhbm5lbCB3aGVyZSB0aGUgZXZlbnQgb2NjdXJyZWQgKGJldHdlZW4gMSBhbmQgMTYpLgogICAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnQudHlwZSBUaGUgdHlwZSBvZiBldmVudCB0aGF0IG9jY3VycmVkLgogICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQubm90ZQogICAgICAgKiBAcGFyYW0ge3VpbnR9IGV2ZW50Lm5vdGUubnVtYmVyIFRoZSBNSURJIG5vdGUgbnVtYmVyLgogICAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnQubm90ZS5uYW1lIFRoZSB1c3VhbCBub3RlIG5hbWUgKEMsIEMjLCBELCBEIywgZXRjLikuCiAgICAgICAqIEBwYXJhbSB7dWludH0gZXZlbnQubm90ZS5vY3RhdmUgVGhlIG9jdGF2ZSAoYmV0d2VlbiAtMiBhbmQgOCkuCiAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSBldmVudC52YWx1ZSBUaGUgYWZ0ZXJ0b3VjaCBhbW91bnQgKGJldHdlZW4gMCBhbmQgMSkuCiAgICAgICAqLwogICAgICBldmVudC50eXBlID0gImtleWFmdGVydG91Y2giOwogICAgICBldmVudC5ub3RlID0gewogICAgICAgIG51bWJlcjogZGF0YTEsCiAgICAgICAgbmFtZTogd20uX25vdGVzW2RhdGExICUgMTJdLAogICAgICAgIG9jdGF2ZTogd20uZ2V0T2N0YXZlKGRhdGExKQogICAgICB9OwogICAgICBldmVudC52YWx1ZSA9IGRhdGEyIC8gMTI3OwogICAgfSBlbHNlIGlmIChjb21tYW5kID09PSB3bS5NSURJX0NIQU5ORUxfTUVTU0FHRVMuY29udHJvbGNoYW5nZSAmJiBkYXRhMSA+PSAwICYmIGRhdGExIDw9IDExOSkgewogICAgICAvKioKICAgICAgICogRXZlbnQgZW1pdHRlZCB3aGVuIGEgY29udHJvbCBjaGFuZ2UgTUlESSBtZXNzYWdlIGhhcyBiZWVuIHJlY2VpdmVkIG9uIGEgc3BlY2lmaWMgZGV2aWNlIGFuZAogICAgICAgKiBjaGFubmVsLgogICAgICAgKgogICAgICAgKiBAZXZlbnQgY29udHJvbGNoYW5nZQogICAgICAgKgogICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQKICAgICAgICogQHBhcmFtIHtJbnB1dH0gZXZlbnQudGFyZ2V0IFRoZSBgSW5wdXRgIHRoYXQgdHJpZ2dlcmVkIHRoZSBldmVudC4KICAgICAgICogQHBhcmFtIHtVaW50OEFycmF5fSBldmVudC5kYXRhIFRoZSByYXcgTUlESSBtZXNzYWdlIGFzIGFuIGFycmF5IG9mIDggYml0IHZhbHVlcy4KICAgICAgICogQHBhcmFtIHtOdW1iZXJ9IGV2ZW50LnRpbWVzdGFtcCBUaGUgdGltZSB3aGVuIHRoZSBldmVudCBvY2N1cnJlZCAoaW4gbWlsbGlzZWNvbmRzKQogICAgICAgKiBAcGFyYW0ge3VpbnR9IGV2ZW50LmNoYW5uZWwgVGhlIGNoYW5uZWwgd2hlcmUgdGhlIGV2ZW50IG9jY3VycmVkIChiZXR3ZWVuIDEgYW5kIDE2KS4KICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50LnR5cGUgVGhlIHR5cGUgb2YgZXZlbnQgdGhhdCBvY2N1cnJlZC4KICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50LmNvbnRyb2xsZXIKICAgICAgICogQHBhcmFtIHt1aW50fSBldmVudC5jb250cm9sbGVyLm51bWJlciBUaGUgbnVtYmVyIG9mIHRoZSBjb250cm9sbGVyLgogICAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnQuY29udHJvbGxlci5uYW1lIFRoZSB1c3VhbCBuYW1lIG9yIGZ1bmN0aW9uIG9mIHRoZSBjb250cm9sbGVyLgogICAgICAgKiBAcGFyYW0ge3VpbnR9IGV2ZW50LnZhbHVlIFRoZSB2YWx1ZSByZWNlaXZlZCAoYmV0d2VlbiAwIGFuZCAxMjcpLgogICAgICAgKi8KICAgICAgZXZlbnQudHlwZSA9ICJjb250cm9sY2hhbmdlIjsKICAgICAgZXZlbnQuY29udHJvbGxlciA9IHsKICAgICAgICBudW1iZXI6IGRhdGExLAogICAgICAgIG5hbWU6IHRoaXMuZ2V0Q2NOYW1lQnlOdW1iZXIoZGF0YTEpCiAgICAgIH07CiAgICAgIGV2ZW50LnZhbHVlID0gZGF0YTI7CiAgICB9IGVsc2UgaWYgKGNvbW1hbmQgPT09IHdtLk1JRElfQ0hBTk5FTF9NRVNTQUdFUy5jaGFubmVsbW9kZSAmJiBkYXRhMSA+PSAxMjAgJiYgZGF0YTEgPD0gMTI3KSB7CiAgICAgIC8qKgogICAgICAgKiBFdmVudCBlbWl0dGVkIHdoZW4gYSBjaGFubmVsIG1vZGUgTUlESSBtZXNzYWdlIGhhcyBiZWVuIHJlY2VpdmVkIG9uIGEgc3BlY2lmaWMgZGV2aWNlIGFuZAogICAgICAgKiBjaGFubmVsLgogICAgICAgKgogICAgICAgKiBAZXZlbnQgY2hhbm5lbG1vZGUKICAgICAgICoKICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50CiAgICAgICAqIEBwYXJhbSB7SW5wdXR9IGV2ZW50LnRhcmdldCBUaGUgYElucHV0YCB0aGF0IHRyaWdnZXJlZCB0aGUgZXZlbnQuCiAgICAgICAqIEBwYXJhbSB7VWludDhBcnJheX0gZXZlbnQuZGF0YSBUaGUgcmF3IE1JREkgbWVzc2FnZSBhcyBhbiBhcnJheSBvZiA4IGJpdCB2YWx1ZXMuCiAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSBldmVudC50aW1lc3RhbXAgVGhlIHRpbWUgd2hlbiB0aGUgZXZlbnQgb2NjdXJyZWQgKGluIG1pbGxpc2Vjb25kcykKICAgICAgICogQHBhcmFtIHt1aW50fSBldmVudC5jaGFubmVsIFRoZSBjaGFubmVsIHdoZXJlIHRoZSBldmVudCBvY2N1cnJlZCAoYmV0d2VlbiAxIGFuZCAxNikuCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudC50eXBlIFRoZSB0eXBlIG9mIGV2ZW50IHRoYXQgb2NjdXJyZWQuCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudC5jb250cm9sbGVyCiAgICAgICAqIEBwYXJhbSB7dWludH0gZXZlbnQuY29udHJvbGxlci5udW1iZXIgVGhlIG51bWJlciBvZiB0aGUgY29udHJvbGxlci4KICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50LmNvbnRyb2xsZXIubmFtZSBUaGUgdXN1YWwgbmFtZSBvciBmdW5jdGlvbiBvZiB0aGUgY29udHJvbGxlci4KICAgICAgICogQHBhcmFtIHt1aW50fSBldmVudC52YWx1ZSBUaGUgdmFsdWUgcmVjZWl2ZWQgKGJldHdlZW4gMCBhbmQgMTI3KS4KICAgICAgICovCiAgICAgIGV2ZW50LnR5cGUgPSAiY2hhbm5lbG1vZGUiOwogICAgICBldmVudC5jb250cm9sbGVyID0gewogICAgICAgIG51bWJlcjogZGF0YTEsCiAgICAgICAgbmFtZTogdGhpcy5nZXRDaGFubmVsTW9kZUJ5TnVtYmVyKGRhdGExKQogICAgICB9OwogICAgICBldmVudC52YWx1ZSA9IGRhdGEyOwogICAgfSBlbHNlIGlmIChjb21tYW5kID09PSB3bS5NSURJX0NIQU5ORUxfTUVTU0FHRVMucHJvZ3JhbWNoYW5nZSkgewogICAgICAvKioKICAgICAgICogRXZlbnQgZW1pdHRlZCB3aGVuIGEgcHJvZ3JhbSBjaGFuZ2UgTUlESSBtZXNzYWdlIGhhcyBiZWVuIHJlY2VpdmVkIG9uIGEgc3BlY2lmaWMgZGV2aWNlIGFuZAogICAgICAgKiBjaGFubmVsLgogICAgICAgKgogICAgICAgKiBAZXZlbnQgcHJvZ3JhbWNoYW5nZQogICAgICAgKgogICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQKICAgICAgICogQHBhcmFtIHtJbnB1dH0gZXZlbnQudGFyZ2V0IFRoZSBgSW5wdXRgIHRoYXQgdHJpZ2dlcmVkIHRoZSBldmVudC4KICAgICAgICogQHBhcmFtIHtVaW50OEFycmF5fSBldmVudC5kYXRhIFRoZSByYXcgTUlESSBtZXNzYWdlIGFzIGFuIGFycmF5IG9mIDggYml0IHZhbHVlcy4KICAgICAgICogQHBhcmFtIHtOdW1iZXJ9IGV2ZW50LnRpbWVzdGFtcCBUaGUgdGltZSB3aGVuIHRoZSBldmVudCBvY2N1cnJlZCAoaW4gbWlsbGlzZWNvbmRzKQogICAgICAgKiBAcGFyYW0ge3VpbnR9IGV2ZW50LmNoYW5uZWwgVGhlIGNoYW5uZWwgd2hlcmUgdGhlIGV2ZW50IG9jY3VycmVkIChiZXR3ZWVuIDEgYW5kIDE2KS4KICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50LnR5cGUgVGhlIHR5cGUgb2YgZXZlbnQgdGhhdCBvY2N1cnJlZC4KICAgICAgICogQHBhcmFtIHt1aW50fSBldmVudC52YWx1ZSBUaGUgdmFsdWUgcmVjZWl2ZWQgKGJldHdlZW4gMCBhbmQgMTI3KS4KICAgICAgICovCiAgICAgIGV2ZW50LnR5cGUgPSAicHJvZ3JhbWNoYW5nZSI7CiAgICAgIGV2ZW50LnZhbHVlID0gZGF0YTE7CiAgICB9IGVsc2UgaWYgKGNvbW1hbmQgPT09IHdtLk1JRElfQ0hBTk5FTF9NRVNTQUdFUy5jaGFubmVsYWZ0ZXJ0b3VjaCkgewogICAgICAvKioKICAgICAgICogRXZlbnQgZW1pdHRlZCB3aGVuIGEgY2hhbm5lbC13aWRlIGFmdGVydG91Y2ggTUlESSBtZXNzYWdlIGhhcyBiZWVuIHJlY2VpdmVkIG9uIGEgc3BlY2lmaWMKICAgICAgICogZGV2aWNlIGFuZCBjaGFubmVsLgogICAgICAgKgogICAgICAgKiBAZXZlbnQgY2hhbm5lbGFmdGVydG91Y2gKICAgICAgICoKICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50CiAgICAgICAqIEBwYXJhbSB7SW5wdXR9IGV2ZW50LnRhcmdldCBUaGUgYElucHV0YCB0aGF0IHRyaWdnZXJlZCB0aGUgZXZlbnQuCiAgICAgICAqIEBwYXJhbSB7VWludDhBcnJheX0gZXZlbnQuZGF0YSBUaGUgcmF3IE1JREkgbWVzc2FnZSBhcyBhbiBhcnJheSBvZiA4IGJpdCB2YWx1ZXMuCiAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSBldmVudC50aW1lc3RhbXAgVGhlIHRpbWUgd2hlbiB0aGUgZXZlbnQgb2NjdXJyZWQgKGluIG1pbGxpc2Vjb25kcykKICAgICAgICogQHBhcmFtIHt1aW50fSBldmVudC5jaGFubmVsIFRoZSBjaGFubmVsIHdoZXJlIHRoZSBldmVudCBvY2N1cnJlZCAoYmV0d2VlbiAxIGFuZCAxNikuCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudC50eXBlIFRoZSB0eXBlIG9mIGV2ZW50IHRoYXQgb2NjdXJyZWQuCiAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSBldmVudC52YWx1ZSBUaGUgYWZ0ZXJ0b3VjaCB2YWx1ZSByZWNlaXZlZCAoYmV0d2VlbiAwIGFuZCAxKS4KICAgICAgICovCiAgICAgIGV2ZW50LnR5cGUgPSAiY2hhbm5lbGFmdGVydG91Y2giOwogICAgICBldmVudC52YWx1ZSA9IGRhdGExIC8gMTI3OwogICAgfSBlbHNlIGlmIChjb21tYW5kID09PSB3bS5NSURJX0NIQU5ORUxfTUVTU0FHRVMucGl0Y2hiZW5kKSB7CiAgICAgIC8qKgogICAgICAgKiBFdmVudCBlbWl0dGVkIHdoZW4gYSBwaXRjaCBiZW5kIE1JREkgbWVzc2FnZSBoYXMgYmVlbiByZWNlaXZlZCBvbiBhIHNwZWNpZmljIGRldmljZSBhbmQKICAgICAgICogY2hhbm5lbC4KICAgICAgICoKICAgICAgICogQGV2ZW50IHBpdGNoYmVuZAogICAgICAgKgogICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQKICAgICAgICogQHBhcmFtIHtJbnB1dH0gZXZlbnQudGFyZ2V0IFRoZSBgSW5wdXRgIHRoYXQgdHJpZ2dlcmVkIHRoZSBldmVudC4KICAgICAgICogQHBhcmFtIHtVaW50OEFycmF5fSBldmVudC5kYXRhIFRoZSByYXcgTUlESSBtZXNzYWdlIGFzIGFuIGFycmF5IG9mIDggYml0IHZhbHVlcy4KICAgICAgICogQHBhcmFtIHtOdW1iZXJ9IGV2ZW50LnRpbWVzdGFtcCBUaGUgdGltZSB3aGVuIHRoZSBldmVudCBvY2N1cnJlZCAoaW4gbWlsbGlzZWNvbmRzKQogICAgICAgKiBAcGFyYW0ge3VpbnR9IGV2ZW50LmNoYW5uZWwgVGhlIGNoYW5uZWwgd2hlcmUgdGhlIGV2ZW50IG9jY3VycmVkIChiZXR3ZWVuIDEgYW5kIDE2KS4KICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50LnR5cGUgVGhlIHR5cGUgb2YgZXZlbnQgdGhhdCBvY2N1cnJlZC4KICAgICAgICogQHBhcmFtIHtOdW1iZXJ9IGV2ZW50LnZhbHVlIFRoZSBwaXRjaCBiZW5kIHZhbHVlIHJlY2VpdmVkIChiZXR3ZWVuIC0xIGFuZCAxKS4KICAgICAgICovCiAgICAgIGV2ZW50LnR5cGUgPSAicGl0Y2hiZW5kIjsKICAgICAgZXZlbnQudmFsdWUgPSAoKGRhdGEyIDw8IDcpICsgZGF0YTEgLSA4MTkyKSAvIDgxOTI7CiAgICB9IGVsc2UgewogICAgICBldmVudC50eXBlID0gInVua25vd25jaGFubmVsbWVzc2FnZSI7CiAgICB9IC8vIElmIHNvbWUgY2FsbGJhY2tzIGhhdmUgYmVlbiBkZWZpbmVkIGZvciB0aGlzIGV2ZW50LCBvbiB0aGF0IGRldmljZSBhbmQgY2hhbm5lbCwgZXhlY3V0ZSB0aGVtLgoKCiAgICBpZiAodGhpcy5fdXNlckhhbmRsZXJzLmNoYW5uZWxbZXZlbnQudHlwZV0gJiYgdGhpcy5fdXNlckhhbmRsZXJzLmNoYW5uZWxbZXZlbnQudHlwZV1bY2hhbm5lbF0pIHsKICAgICAgdGhpcy5fdXNlckhhbmRsZXJzLmNoYW5uZWxbZXZlbnQudHlwZV1bY2hhbm5lbF0uZm9yRWFjaChmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICBjYWxsYmFjayhldmVudCk7CiAgICAgIH0pOwogICAgfQogIH07CiAgLyoqCiAgICogUmV0dXJucyB0aGUgbmFtZSBvZiBhIGNvbnRyb2wgY2hhbmdlIG1lc3NhZ2UgbWF0Y2hpbmcgdGhlIHNwZWNpZmllZCBudW1iZXIuIElmIG5vIG1hdGNoIGlzCiAgICogZm91bmQsIHRoZSBmdW5jdGlvbiByZXR1cm5zIGB1bmRlZmluZWRgLgogICAqCiAgICogQG1ldGhvZCBnZXRDY05hbWVCeU51bWJlcgogICAqCiAgICogQHBhcmFtIG51bWJlciB7TnVtYmVyfSBUaGUgbnVtYmVyIG9mIHRoZSBjb250cm9sIGNoYW5nZSBtZXNzYWdlLgogICAqIEByZXR1cm5zIHtTdHJpbmd8dW5kZWZpbmVkfSBUaGUgbWF0Y2hpbmcgY29udHJvbCBjaGFuZ2UgbmFtZSBvciBgdW5kZWZpbmVkYC4KICAgKgogICAqIEB0aHJvd3MgUmFuZ2VFcnJvciBUaGUgY29udHJvbCBjaGFuZ2UgbnVtYmVyIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxMTkuCiAgICoKICAgKiBAc2luY2UgMi4wLjAKICAgKi8KCgogIElucHV0LnByb3RvdHlwZS5nZXRDY05hbWVCeU51bWJlciA9IGZ1bmN0aW9uIChudW1iZXIpIHsKICAgIG51bWJlciA9IE1hdGguZmxvb3IobnVtYmVyKTsKCiAgICBpZiAoIShudW1iZXIgPj0gMCAmJiBudW1iZXIgPD0gMTE5KSkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigiVGhlIGNvbnRyb2wgY2hhbmdlIG51bWJlciBtdXN0IGJlIGJldHdlZW4gMCBhbmQgMTE5LiIpOwogICAgfQoKICAgIGZvciAodmFyIGNjIGluIHdtLk1JRElfQ09OVFJPTF9DSEFOR0VfTUVTU0FHRVMpIHsKICAgICAgaWYgKHdtLk1JRElfQ09OVFJPTF9DSEFOR0VfTUVTU0FHRVMuaGFzT3duUHJvcGVydHkoY2MpICYmIG51bWJlciA9PT0gd20uTUlESV9DT05UUk9MX0NIQU5HRV9NRVNTQUdFU1tjY10pIHsKICAgICAgICByZXR1cm4gY2M7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdW5kZWZpbmVkOwogIH07CiAgLyoqCiAgICogUmV0dXJucyB0aGUgY2hhbm5lbCBtb2RlIG5hbWUgbWF0Y2hpbmcgdGhlIHNwZWNpZmllZCBudW1iZXIuIElmIG5vIG1hdGNoIGlzIGZvdW5kLCB0aGUgZnVuY3Rpb24KICAgKiByZXR1cm5zIGB1bmRlZmluZWRgLgogICAqCiAgICogQG1ldGhvZCBnZXRDaGFubmVsTW9kZUJ5TnVtYmVyCiAgICoKICAgKiBAcGFyYW0gbnVtYmVyIHtOdW1iZXJ9IFRoZSBudW1iZXIgb2YgdGhlIGNoYW5uZWwgbW9kZSBtZXNzYWdlLgogICAqIEByZXR1cm5zIHtTdHJpbmd8dW5kZWZpbmVkfSBUaGUgbWF0Y2hpbmcgY2hhbm5lbCBtb2RlIG1lc3NhZ2UicyBuYW1lIG9yIGB1bmRlZmluZWRgOwogICAqCiAgICogQHRocm93cyBSYW5nZUVycm9yIFRoZSBjaGFubmVsIG1vZGUgbnVtYmVyIG11c3QgYmUgYmV0d2VlbiAxMjAgYW5kIDEyNy4KICAgKgogICAqIEBzaW5jZSAyLjAuMAogICAqLwoKCiAgSW5wdXQucHJvdG90eXBlLmdldENoYW5uZWxNb2RlQnlOdW1iZXIgPSBmdW5jdGlvbiAobnVtYmVyKSB7CiAgICBudW1iZXIgPSBNYXRoLmZsb29yKG51bWJlcik7CgogICAgaWYgKCEobnVtYmVyID49IDEyMCAmJiBzdGF0dXMgPD0gMTI3KSkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigiVGhlIGNvbnRyb2wgY2hhbmdlIG51bWJlciBtdXN0IGJlIGJldHdlZW4gMTIwIGFuZCAxMjcuIik7CiAgICB9CgogICAgZm9yICh2YXIgY20gaW4gd20uTUlESV9DSEFOTkVMX01PREVfTUVTU0FHRVMpIHsKICAgICAgaWYgKHdtLk1JRElfQ0hBTk5FTF9NT0RFX01FU1NBR0VTLmhhc093blByb3BlcnR5KGNtKSAmJiBudW1iZXIgPT09IHdtLk1JRElfQ0hBTk5FTF9NT0RFX01FU1NBR0VTW2NtXSkgewogICAgICAgIHJldHVybiBjbTsKICAgICAgfQogICAgfQogIH07CiAgLyoqCiAgICogQG1ldGhvZCBfcGFyc2VTeXN0ZW1FdmVudAogICAqIEBwcm90ZWN0ZWQKICAgKi8KCgogIElucHV0LnByb3RvdHlwZS5fcGFyc2VTeXN0ZW1FdmVudCA9IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgY29tbWFuZCA9IGUuZGF0YVswXTsgLy8gUmV0dXJuZWQgZXZlbnQKCiAgICB2YXIgZXZlbnQgPSB7CiAgICAgIHRhcmdldDogdGhpcywKICAgICAgZGF0YTogZS5kYXRhLAogICAgICB0aW1lc3RhbXA6IGUudGltZVN0YW1wCiAgICB9OwoKICAgIGlmIChjb21tYW5kID09PSB3bS5NSURJX1NZU1RFTV9NRVNTQUdFUy5zeXNleCkgewogICAgICAvKioKICAgICAgICogRXZlbnQgZW1pdHRlZCB3aGVuIGEgc3lzdGVtIGV4Y2x1c2l2ZSBNSURJIG1lc3NhZ2UgaGFzIGJlZW4gcmVjZWl2ZWQuIFlvdSBzaG91bGQgbm90ZSB0aGF0LAogICAgICAgKiB0byByZWNlaXZlIGBzeXNleGAgZXZlbnRzLCB5b3UgbXVzdCBjYWxsIHRoZSBgV2ViTWlkaS5lbmFibGUoKWAgbWV0aG9kIHdpdGggYSBzZWNvbmQKICAgICAgICogcGFyYW1ldGVyIHNldCB0byBgdHJ1ZWA6CiAgICAgICAqCiAgICAgICAqICAgICBXZWJNaWRpLmVuYWJsZShmdW5jdGlvbihlcnIpIHsKICAgICAgICoKICAgICAgICogICAgICAgIGlmIChlcnIpIHsKICAgICAgICogICAgICAgICAgY29uc29sZS5sb2coIldlYk1pZGkgY291bGQgbm90IGJlIGVuYWJsZWQuIik7CiAgICAgICAqICAgICAgICB9CiAgICAgICAqCiAgICAgICAqICAgICAgICB2YXIgaW5wdXQgPSBXZWJNaWRpLmlucHV0c1swXTsKICAgICAgICoKICAgICAgICogICAgICAgIGlucHV0LmFkZExpc3RlbmVyKCJzeXNleCIsICJhbGwiLCBmdW5jdGlvbiAoZSkgewogICAgICAgKiAgICAgICAgICBjb25zb2xlLmxvZyhlKTsKICAgICAgICogICAgICAgIH0pOwogICAgICAgKgogICAgICAgKiAgICAgfSwgdHJ1ZSk7CiAgICAgICAqCiAgICAgICAqIEBldmVudCBzeXNleAogICAgICAgKgogICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQKICAgICAgICogQHBhcmFtIHtJbnB1dH0gZXZlbnQudGFyZ2V0IFRoZSBgSW5wdXRgIHRoYXQgdHJpZ2dlcmVkIHRoZSBldmVudC4KICAgICAgICogQHBhcmFtIHtVaW50OEFycmF5fSBldmVudC5kYXRhIFRoZSByYXcgTUlESSBtZXNzYWdlIGFzIGFuIGFycmF5IG9mIDggYml0IHZhbHVlcy4KICAgICAgICogQHBhcmFtIHtOdW1iZXJ9IGV2ZW50LnRpbWVzdGFtcCBUaGUgdGltZSB3aGVuIHRoZSBldmVudCBvY2N1cnJlZCAoaW4gbWlsbGlzZWNvbmRzKQogICAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnQudHlwZSBUaGUgdHlwZSBvZiBldmVudCB0aGF0IG9jY3VycmVkLgogICAgICAgKgogICAgICAgKi8KICAgICAgZXZlbnQudHlwZSA9ICJzeXNleCI7CiAgICB9IGVsc2UgaWYgKGNvbW1hbmQgPT09IHdtLk1JRElfU1lTVEVNX01FU1NBR0VTLnRpbWVjb2RlKSB7CiAgICAgIC8qKgogICAgICAgKiBFdmVudCBlbWl0dGVkIHdoZW4gYSBzeXN0ZW0gTUlESSB0aW1lIGNvZGUgcXVhcnRlciBmcmFtZSBtZXNzYWdlIGhhcyBiZWVuIHJlY2VpdmVkLgogICAgICAgKgogICAgICAgKiBAZXZlbnQgdGltZWNvZGUKICAgICAgICoKICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50CiAgICAgICAqIEBwYXJhbSB7SW5wdXR9IGV2ZW50LnRhcmdldCBUaGUgYElucHV0YCB0aGF0IHRyaWdnZXJlZCB0aGUgZXZlbnQuCiAgICAgICAqIEBwYXJhbSB7VWludDhBcnJheX0gZXZlbnQuZGF0YSBUaGUgcmF3IE1JREkgbWVzc2FnZSBhcyBhbiBhcnJheSBvZiA4IGJpdCB2YWx1ZXMuCiAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSBldmVudC50aW1lc3RhbXAgVGhlIHRpbWUgd2hlbiB0aGUgZXZlbnQgb2NjdXJyZWQgKGluIG1pbGxpc2Vjb25kcykKICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50LnR5cGUgVGhlIHR5cGUgb2YgZXZlbnQgdGhhdCBvY2N1cnJlZC4KICAgICAgICovCiAgICAgIGV2ZW50LnR5cGUgPSAidGltZWNvZGUiOwogICAgfSBlbHNlIGlmIChjb21tYW5kID09PSB3bS5NSURJX1NZU1RFTV9NRVNTQUdFUy5zb25ncG9zaXRpb24pIHsKICAgICAgLyoqCiAgICAgICAqIEV2ZW50IGVtaXR0ZWQgd2hlbiBhIHN5c3RlbSBzb25nIHBvc2l0aW9uIHBvaW50ZXIgTUlESSBtZXNzYWdlIGhhcyBiZWVuIHJlY2VpdmVkLgogICAgICAgKgogICAgICAgKiBAZXZlbnQgc29uZ3Bvc2l0aW9uCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudAogICAgICAgKiBAcGFyYW0ge0lucHV0fSBldmVudC50YXJnZXQgVGhlIGBJbnB1dGAgdGhhdCB0cmlnZ2VyZWQgdGhlIGV2ZW50LgogICAgICAgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGV2ZW50LmRhdGEgVGhlIHJhdyBNSURJIG1lc3NhZ2UgYXMgYW4gYXJyYXkgb2YgOCBiaXQgdmFsdWVzLgogICAgICAgKiBAcGFyYW0ge051bWJlcn0gZXZlbnQudGltZXN0YW1wIFRoZSB0aW1lIHdoZW4gdGhlIGV2ZW50IG9jY3VycmVkIChpbiBtaWxsaXNlY29uZHMpCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudC50eXBlIFRoZSB0eXBlIG9mIGV2ZW50IHRoYXQgb2NjdXJyZWQuCiAgICAgICAqLwogICAgICBldmVudC50eXBlID0gInNvbmdwb3NpdGlvbiI7CiAgICB9IGVsc2UgaWYgKGNvbW1hbmQgPT09IHdtLk1JRElfU1lTVEVNX01FU1NBR0VTLnNvbmdzZWxlY3QpIHsKICAgICAgLyoqCiAgICAgICAqIEV2ZW50IGVtaXR0ZWQgd2hlbiBhIHN5c3RlbSBzb25nIHNlbGVjdCBNSURJIG1lc3NhZ2UgaGFzIGJlZW4gcmVjZWl2ZWQuCiAgICAgICAqCiAgICAgICAqIEBldmVudCBzb25nc2VsZWN0CiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudAogICAgICAgKiBAcGFyYW0ge0lucHV0fSBldmVudC50YXJnZXQgVGhlIGBJbnB1dGAgdGhhdCB0cmlnZ2VyZWQgdGhlIGV2ZW50LgogICAgICAgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGV2ZW50LmRhdGEgVGhlIHJhdyBNSURJIG1lc3NhZ2UgYXMgYW4gYXJyYXkgb2YgOCBiaXQgdmFsdWVzLgogICAgICAgKiBAcGFyYW0ge051bWJlcn0gZXZlbnQudGltZXN0YW1wIFRoZSB0aW1lIHdoZW4gdGhlIGV2ZW50IG9jY3VycmVkIChpbiBtaWxsaXNlY29uZHMpCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudC50eXBlIFRoZSB0eXBlIG9mIGV2ZW50IHRoYXQgb2NjdXJyZWQuCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudC5zb25nIFNvbmcgKG9yIHNlcXVlbmNlKSBudW1iZXIgdG8gc2VsZWN0LgogICAgICAgKi8KICAgICAgZXZlbnQudHlwZSA9ICJzb25nc2VsZWN0IjsKICAgICAgZXZlbnQuc29uZyA9IGUuZGF0YVsxXTsKICAgIH0gZWxzZSBpZiAoY29tbWFuZCA9PT0gd20uTUlESV9TWVNURU1fTUVTU0FHRVMudHVuaW5ncmVxdWVzdCkgewogICAgICAvKioKICAgICAgICogRXZlbnQgZW1pdHRlZCB3aGVuIGEgc3lzdGVtIHR1bmUgcmVxdWVzdCBNSURJIG1lc3NhZ2UgaGFzIGJlZW4gcmVjZWl2ZWQuCiAgICAgICAqCiAgICAgICAqIEBldmVudCB0dW5pbmdyZXF1ZXN0CiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudAogICAgICAgKiBAcGFyYW0ge0lucHV0fSBldmVudC50YXJnZXQgVGhlIGBJbnB1dGAgdGhhdCB0cmlnZ2VyZWQgdGhlIGV2ZW50LgogICAgICAgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGV2ZW50LmRhdGEgICAgIFRoZSByYXcgTUlESSBtZXNzYWdlIGFzIGFuIGFycmF5IG9mIDggYml0CiAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzLgogICAgICAgKiBAcGFyYW0ge051bWJlcn0gZXZlbnQudGltZXN0YW1wIFRoZSB0aW1lIHdoZW4gdGhlIGV2ZW50IG9jY3VycmVkIChpbiBtaWxsaXNlY29uZHMpCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudC50eXBlICAgICAgICAgVGhlIHR5cGUgb2YgZXZlbnQgdGhhdCBvY2N1cnJlZC4KICAgICAgICovCiAgICAgIGV2ZW50LnR5cGUgPSAidHVuaW5ncmVxdWVzdCI7CiAgICB9IGVsc2UgaWYgKGNvbW1hbmQgPT09IHdtLk1JRElfU1lTVEVNX01FU1NBR0VTLmNsb2NrKSB7CiAgICAgIC8qKgogICAgICAgKiBFdmVudCBlbWl0dGVkIHdoZW4gYSBzeXN0ZW0gdGltaW5nIGNsb2NrIE1JREkgbWVzc2FnZSBoYXMgYmVlbiByZWNlaXZlZC4KICAgICAgICoKICAgICAgICogQGV2ZW50IGNsb2NrCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudAogICAgICAgKiBAcGFyYW0ge0lucHV0fSBldmVudC50YXJnZXQgVGhlIGBJbnB1dGAgdGhhdCB0cmlnZ2VyZWQgdGhlIGV2ZW50LgogICAgICAgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGV2ZW50LmRhdGEgICAgIFRoZSByYXcgTUlESSBtZXNzYWdlIGFzIGFuIGFycmF5IG9mIDggYml0CiAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzLgogICAgICAgKiBAcGFyYW0ge051bWJlcn0gZXZlbnQudGltZXN0YW1wIFRoZSB0aW1lIHdoZW4gdGhlIGV2ZW50IG9jY3VycmVkIChpbiBtaWxsaXNlY29uZHMpCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudC50eXBlICAgICAgICAgVGhlIHR5cGUgb2YgZXZlbnQgdGhhdCBvY2N1cnJlZC4KICAgICAgICovCiAgICAgIGV2ZW50LnR5cGUgPSAiY2xvY2siOwogICAgfSBlbHNlIGlmIChjb21tYW5kID09PSB3bS5NSURJX1NZU1RFTV9NRVNTQUdFUy5zdGFydCkgewogICAgICAvKioKICAgICAgICogRXZlbnQgZW1pdHRlZCB3aGVuIGEgc3lzdGVtIHN0YXJ0IE1JREkgbWVzc2FnZSBoYXMgYmVlbiByZWNlaXZlZC4KICAgICAgICoKICAgICAgICogQGV2ZW50IHN0YXJ0CiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudAogICAgICAgKiBAcGFyYW0ge0lucHV0fSBldmVudC50YXJnZXQgVGhlIGBJbnB1dGAgdGhhdCB0cmlnZ2VyZWQgdGhlIGV2ZW50LgogICAgICAgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGV2ZW50LmRhdGEgICAgIFRoZSByYXcgTUlESSBtZXNzYWdlIGFzIGFuIGFycmF5IG9mIDggYml0CiAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzLgogICAgICAgKiBAcGFyYW0ge051bWJlcn0gZXZlbnQudGltZXN0YW1wIFRoZSB0aW1lIHdoZW4gdGhlIGV2ZW50IG9jY3VycmVkIChpbiBtaWxsaXNlY29uZHMpCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudC50eXBlICAgICAgICAgVGhlIHR5cGUgb2YgZXZlbnQgdGhhdCBvY2N1cnJlZC4KICAgICAgICovCiAgICAgIGV2ZW50LnR5cGUgPSAic3RhcnQiOwogICAgfSBlbHNlIGlmIChjb21tYW5kID09PSB3bS5NSURJX1NZU1RFTV9NRVNTQUdFU1siY29udGludWUiXSkgewogICAgICAvKioKICAgICAgICogRXZlbnQgZW1pdHRlZCB3aGVuIGEgc3lzdGVtIGNvbnRpbnVlIE1JREkgbWVzc2FnZSBoYXMgYmVlbiByZWNlaXZlZC4KICAgICAgICoKICAgICAgICogQGV2ZW50IGNvbnRpbnVlCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudAogICAgICAgKiBAcGFyYW0ge0lucHV0fSBldmVudC50YXJnZXQgVGhlIGBJbnB1dGAgdGhhdCB0cmlnZ2VyZWQgdGhlIGV2ZW50LgogICAgICAgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGV2ZW50LmRhdGEgICAgIFRoZSByYXcgTUlESSBtZXNzYWdlIGFzIGFuIGFycmF5IG9mIDggYml0CiAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzLgogICAgICAgKiBAcGFyYW0ge051bWJlcn0gZXZlbnQudGltZXN0YW1wIFRoZSB0aW1lIHdoZW4gdGhlIGV2ZW50IG9jY3VycmVkIChpbiBtaWxsaXNlY29uZHMpCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudC50eXBlICAgICAgICAgVGhlIHR5cGUgb2YgZXZlbnQgdGhhdCBvY2N1cnJlZC4KICAgICAgICovCiAgICAgIGV2ZW50LnR5cGUgPSAiY29udGludWUiOwogICAgfSBlbHNlIGlmIChjb21tYW5kID09PSB3bS5NSURJX1NZU1RFTV9NRVNTQUdFUy5zdG9wKSB7CiAgICAgIC8qKgogICAgICAgKiBFdmVudCBlbWl0dGVkIHdoZW4gYSBzeXN0ZW0gc3RvcCBNSURJIG1lc3NhZ2UgaGFzIGJlZW4gcmVjZWl2ZWQuCiAgICAgICAqCiAgICAgICAqIEBldmVudCBzdG9wCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudAogICAgICAgKiBAcGFyYW0ge0lucHV0fSBldmVudC50YXJnZXQgVGhlIGBJbnB1dGAgdGhhdCB0cmlnZ2VyZWQgdGhlIGV2ZW50LgogICAgICAgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGV2ZW50LmRhdGEgICAgIFRoZSByYXcgTUlESSBtZXNzYWdlIGFzIGFuIGFycmF5IG9mIDggYml0CiAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzLgogICAgICAgKiBAcGFyYW0ge051bWJlcn0gZXZlbnQudGltZXN0YW1wIFRoZSB0aW1lIHdoZW4gdGhlIGV2ZW50IG9jY3VycmVkIChpbiBtaWxsaXNlY29uZHMpCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudC50eXBlICAgICAgICAgVGhlIHR5cGUgb2YgZXZlbnQgdGhhdCBvY2N1cnJlZC4KICAgICAgICovCiAgICAgIGV2ZW50LnR5cGUgPSAic3RvcCI7CiAgICB9IGVsc2UgaWYgKGNvbW1hbmQgPT09IHdtLk1JRElfU1lTVEVNX01FU1NBR0VTLmFjdGl2ZXNlbnNpbmcpIHsKICAgICAgLyoqCiAgICAgICAqIEV2ZW50IGVtaXR0ZWQgd2hlbiBhIHN5c3RlbSBhY3RpdmUgc2Vuc2luZyBNSURJIG1lc3NhZ2UgaGFzIGJlZW4gcmVjZWl2ZWQuCiAgICAgICAqCiAgICAgICAqIEBldmVudCBhY3RpdmVzZW5zaW5nCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudAogICAgICAgKiBAcGFyYW0ge0lucHV0fSBldmVudC50YXJnZXQgVGhlIGBJbnB1dGAgdGhhdCB0cmlnZ2VyZWQgdGhlIGV2ZW50LgogICAgICAgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGV2ZW50LmRhdGEgICAgIFRoZSByYXcgTUlESSBtZXNzYWdlIGFzIGFuIGFycmF5IG9mIDggYml0IHZhbHVlcy4KICAgICAgICogQHBhcmFtIHtOdW1iZXJ9IGV2ZW50LnRpbWVzdGFtcCBUaGUgdGltZSB3aGVuIHRoZSBldmVudCBvY2N1cnJlZCAoaW4gbWlsbGlzZWNvbmRzKQogICAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnQudHlwZSAgICAgICAgIFRoZSB0eXBlIG9mIGV2ZW50IHRoYXQgb2NjdXJyZWQuCiAgICAgICAqLwogICAgICBldmVudC50eXBlID0gImFjdGl2ZXNlbnNpbmciOwogICAgfSBlbHNlIGlmIChjb21tYW5kID09PSB3bS5NSURJX1NZU1RFTV9NRVNTQUdFUy5yZXNldCkgewogICAgICAvKioKICAgICAgICogRXZlbnQgZW1pdHRlZCB3aGVuIGEgc3lzdGVtIHJlc2V0IE1JREkgbWVzc2FnZSBoYXMgYmVlbiByZWNlaXZlZC4KICAgICAgICoKICAgICAgICogQGV2ZW50IHJlc2V0CiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudAogICAgICAgKiBAcGFyYW0ge0lucHV0fSBldmVudC50YXJnZXQgVGhlIGBJbnB1dGAgdGhhdCB0cmlnZ2VyZWQgdGhlIGV2ZW50LgogICAgICAgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGV2ZW50LmRhdGEgICAgIFRoZSByYXcgTUlESSBtZXNzYWdlIGFzIGFuIGFycmF5IG9mIDggYml0IHZhbHVlcy4KICAgICAgICogQHBhcmFtIHtOdW1iZXJ9IGV2ZW50LnRpbWVzdGFtcCBUaGUgdGltZSB3aGVuIHRoZSBldmVudCBvY2N1cnJlZCAoaW4gbWlsbGlzZWNvbmRzKQogICAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnQudHlwZSAgICAgICAgIFRoZSB0eXBlIG9mIGV2ZW50IHRoYXQgb2NjdXJyZWQuCiAgICAgICAqLwogICAgICBldmVudC50eXBlID0gInJlc2V0IjsKICAgIH0gZWxzZSB7CiAgICAgIC8qKgogICAgICAgKiBFdmVudCBlbWl0dGVkIHdoZW4gYW4gdW5rbm93biBzeXN0ZW0gTUlESSBtZXNzYWdlIGhhcyBiZWVuIHJlY2VpdmVkLiBJdCBjb3VsZCBiZSwgZm9yCiAgICAgICAqIGV4YW1wbGUsIG9uZSBvZiB0aGUgdW5kZWZpbmVkL3Jlc2VydmVkIG1lc3NhZ2VzLgogICAgICAgKgogICAgICAgKiBAZXZlbnQgdW5rbm93bnN5c3RlbW1lc3NhZ2UKICAgICAgICoKICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50CiAgICAgICAqIEBwYXJhbSB7SW5wdXR9IGV2ZW50LnRhcmdldCBUaGUgYElucHV0YCB0aGF0IHRyaWdnZXJlZCB0aGUgZXZlbnQuCiAgICAgICAqIEBwYXJhbSB7VWludDhBcnJheX0gZXZlbnQuZGF0YSBUaGUgcmF3IE1JREkgbWVzc2FnZSBhcyBhbiBhcnJheSBvZiA4IGJpdCB2YWx1ZXMuCiAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSBldmVudC50aW1lc3RhbXAgVGhlIHRpbWUgd2hlbiB0aGUgZXZlbnQgb2NjdXJyZWQgKGluIG1pbGxpc2Vjb25kcykKICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50LnR5cGUgVGhlIHR5cGUgb2YgZXZlbnQgdGhhdCBvY2N1cnJlZC4KICAgICAgICovCiAgICAgIGV2ZW50LnR5cGUgPSAidW5rbm93bnN5c3RlbW1lc3NhZ2UiOwogICAgfSAvLyBJZiBzb21lIGNhbGxiYWNrcyBoYXZlIGJlZW4gZGVmaW5lZCBmb3IgdGhpcyBldmVudCwgZXhlY3V0ZSB0aGVtLgoKCiAgICBpZiAodGhpcy5fdXNlckhhbmRsZXJzLnN5c3RlbVtldmVudC50eXBlXSkgewogICAgICB0aGlzLl91c2VySGFuZGxlcnMuc3lzdGVtW2V2ZW50LnR5cGVdLmZvckVhY2goZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgY2FsbGJhY2soZXZlbnQpOwogICAgICB9KTsKICAgIH0KICB9OwogIC8qKgogICAqIFRoZSBgT3V0cHV0YCBvYmplY3QgcmVwcmVzZW50cyBhIE1JREkgb3V0cHV0IHBvcnQgb24gdGhlIGhvc3Qgc3lzdGVtLiBUaGlzIG9iamVjdCBpcyBjcmVhdGVkIGJ5CiAgICogdGhlIE1JREkgc3Vic3lzdGVtIGFuZCBjYW5ub3QgYmUgaW5zdGFudGlhdGVkIGRpcmVjdGx5LgogICAqCiAgICogWW91IHdpbGwgZmluZCBhbGwgYXZhaWxhYmxlIGBPdXRwdXRgIG9iamVjdHMgaW4gdGhlIGBXZWJNaWRpLm91dHB1dHNgIGFycmF5LgogICAqCiAgICogQGNsYXNzIE91dHB1dAogICAqIEBwYXJhbSB7TUlESU91dHB1dH0gbWlkaU91dHB1dCBBY3R1YWwgYE1JRElPdXRwdXRgIG9iamVjdCBhcyBkZWZpbmVkIGJ5IHRoZSBNSURJIHN1YnN5c3RlbQogICAqLwoKCiAgZnVuY3Rpb24gT3V0cHV0KG1pZGlPdXRwdXQpIHsKICAgIHZhciB0aGF0ID0gdGhpczsKICAgIHRoaXMuX21pZGlPdXRwdXQgPSBtaWRpT3V0cHV0OwogICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXModGhpcywgewogICAgICAvKioKICAgICAgICogW3JlYWQtb25seV0gU3RhdHVzIG9mIHRoZSBNSURJIHBvcnQicyBjb25uZWN0aW9uCiAgICAgICAqCiAgICAgICAqIEBwcm9wZXJ0eSBjb25uZWN0aW9uCiAgICAgICAqIEB0eXBlIFN0cmluZwogICAgICAgKi8KICAgICAgY29ubmVjdGlvbjogewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICByZXR1cm4gdGhhdC5fbWlkaU91dHB1dC5jb25uZWN0aW9uOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBbcmVhZC1vbmx5XSBJRCBzdHJpbmcgb2YgdGhlIE1JREkgcG9ydAogICAgICAgKgogICAgICAgKiBAcHJvcGVydHkgaWQKICAgICAgICogQHR5cGUgU3RyaW5nCiAgICAgICAqLwogICAgICBpZDogewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICByZXR1cm4gdGhhdC5fbWlkaU91dHB1dC5pZDsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogW3JlYWQtb25seV0gTWFudWZhY3R1cmVyIG9mIHRoZSBkZXZpY2UgdG8gd2hpY2ggdGhpcyBwb3J0IGJlbG9uZ3MKICAgICAgICoKICAgICAgICogQHByb3BlcnR5IG1hbnVmYWN0dXJlcgogICAgICAgKiBAdHlwZSBTdHJpbmcKICAgICAgICovCiAgICAgIG1hbnVmYWN0dXJlcjogewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICByZXR1cm4gdGhhdC5fbWlkaU91dHB1dC5tYW51ZmFjdHVyZXI7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIFtyZWFkLW9ubHldIE5hbWUgb2YgdGhlIE1JREkgcG9ydAogICAgICAgKgogICAgICAgKiBAcHJvcGVydHkgbmFtZQogICAgICAgKiBAdHlwZSBTdHJpbmcKICAgICAgICovCiAgICAgIG5hbWU6IHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgcmV0dXJuIHRoYXQuX21pZGlPdXRwdXQubmFtZTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogW3JlYWQtb25seV0gU3RhdGUgb2YgdGhlIE1JREkgcG9ydAogICAgICAgKgogICAgICAgKiBAcHJvcGVydHkgc3RhdGUKICAgICAgICogQHR5cGUgU3RyaW5nCiAgICAgICAqLwogICAgICBzdGF0ZTogewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICByZXR1cm4gdGhhdC5fbWlkaU91dHB1dC5zdGF0ZTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogW3JlYWQtb25seV0gVHlwZSBvZiB0aGUgTUlESSBwb3J0IChgb3V0cHV0YCkKICAgICAgICoKICAgICAgICogQHByb3BlcnR5IHN0YXRlCiAgICAgICAqIEB0eXBlIFN0cmluZwogICAgICAgKi8KICAgICAgdHlwZTogewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICByZXR1cm4gdGhhdC5fbWlkaU91dHB1dC50eXBlOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQogIC8qKgogICAqIFNlbmRzIGEgTUlESSBtZXNzYWdlIG9uIHRoZSBNSURJIG91dHB1dCBwb3J0LCBhdCB0aGUgc2NoZWR1bGVkIHRpbWVzdGFtcC4KICAgKgogICAqIFVubGVzcywgeW91IGFyZSBmYW1pbGlhciB3aXRoIHRoZSBkZXRhaWxzIG9mIHRoZSBNSURJIG1lc3NhZ2UgZm9ybWF0LCB5b3Ugc2hvdWxkIG5vdCB1c2UgdGhpcwogICAqIG1ldGhvZCBkaXJlY3RseS4gSW5zdGVhZCwgdXNlIG9uZSBvZiB0aGUgc2ltcGxlciBoZWxwZXIgbWV0aG9kczogYHBsYXlOb3RlKClgLCBgc3RvcE5vdGUoKWAsCiAgICogYHNlbmRDb250cm9sQ2hhbmdlKClgLCBgc2VuZFN5c3RlbU1lc3NhZ2UoKWAsIGV0Yy4KICAgKgogICAqIERldGFpbHMgb24gdGhlIGZvcm1hdCBvZiBNSURJIG1lc3NhZ2VzIGFyZSBhdmFpbGFibGUgaW4gdGhlCiAgICogPGEgaHJlZj0iaHR0cDovL3d3dy5taWRpLm9yZy90ZWNoc3BlY3MvbWlkaW1lc3NhZ2VzLnBocCI+c3VtbWFyeSBvZiBNSURJIG1lc3NhZ2VzPC9hPiBvZiB0aGUKICAgKiBNSURJIE1hbnVmYWN0dXJlcnMgQXNzb2NpYXRpb24uCiAgICoKICAgKiBAbWV0aG9kIHNlbmQKICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0gc3RhdHVzIHtOdW1iZXJ9IFRoZSBNSURJIHN0YXR1cyBieXRlIG9mIHRoZSBtZXNzYWdlICgxMjgtMjU1KS4KICAgKgogICAqIEBwYXJhbSBbZGF0YT1bXV0ge0FycmF5fSBBbiBhcnJheSBvZiB1aW50cyBmb3IgdGhlIG1lc3NhZ2UuIFRoZSBudW1iZXIgb2YgZGF0YSBieXRlcyB2YXJpZXMKICAgKiBkZXBlbmRpbmcgb24gdGhlIHN0YXR1cyBieXRlLiBJdCBpcyBwZXJmZWN0bHkgbGVnYWwgdG8gc2VuZCBubyBkYXRhIGZvciBzb21lIG1lc3NhZ2UgdHlwZXMgKHVzZQogICAqIHVuZGVmaW5lZCBvciBhbiBlbXB0eSBhcnJheSBpbiB0aGlzIGNhc2UpLiBFYWNoIGJ5dGUgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDI1NS4KICAgKgogICAqIEBwYXJhbSBbdGltZXN0YW1wPTBdIHtET01IaWdoUmVzVGltZVN0YW1wfSBUaGUgdGltZXN0YW1wIGF0IHdoaWNoIHRvIHNlbmQgdGhlIG1lc3NhZ2UuIFlvdSBjYW4KICAgKiB1c2UgYFdlYk1pZGkudGltZWAgdG8gcmV0cmlldmUgdGhlIGN1cnJlbnQgdGltZXN0YW1wLiBUbyBzZW5kIGltbWVkaWF0ZWx5LCBsZWF2ZSBibGFuayBvciB1c2UKICAgKiAwLgogICAqCiAgICogQHRocm93cyB7UmFuZ2VFcnJvcn0gVGhlIHN0YXR1cyBieXRlIG11c3QgYmUgYW4gaW50ZWdlciBiZXR3ZWVuIDEyOCAoMHg4MCkgYW5kIDI1NSAoMHhGRikuCiAgICogQHRocm93cyB7UmFuZ2VFcnJvcn0gRGF0YSBieXRlcyBtdXN0IGJlIGludGVnZXJzIGJldHdlZW4gMCAoMHgwMCkgYW5kIDI1NSAoMHg3RikuCiAgICoKICAgKiBAcmV0dXJuIHtPdXRwdXR9IFJldHVybnMgdGhlIGBPdXRwdXRgIG9iamVjdCBzbyBtZXRob2RzIGNhbiBiZSBjaGFpbmVkLgogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24gKHN0YXR1cywgZGF0YSwgdGltZXN0YW1wKSB7CiAgICBpZiAoIShzdGF0dXMgPj0gMTI4ICYmIHN0YXR1cyA8PSAyNTUpKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJUaGUgc3RhdHVzIGJ5dGUgbXVzdCBiZSBhbiBpbnRlZ2VyIGJldHdlZW4gMTI4ICgweDgwKSBhbmQgMjU1ICgweEZGKS4iKTsKICAgIH0KCiAgICBpZiAoZGF0YSA9PT0gdW5kZWZpbmVkKSBkYXRhID0gW107CiAgICBpZiAoIUFycmF5LmlzQXJyYXkoZGF0YSkpIGRhdGEgPSBbZGF0YV07CiAgICB2YXIgbWVzc2FnZSA9IFtdOwogICAgZGF0YS5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIHZhciBwYXJzZWQgPSBNYXRoLmZsb29yKGl0ZW0pOyAvLyBtYW5kYXRvcnkgYmVjYXVzZSBvZiAibnVsbCIKCiAgICAgIGlmIChwYXJzZWQgPj0gMCAmJiBwYXJzZWQgPD0gMjU1KSB7CiAgICAgICAgbWVzc2FnZS5wdXNoKHBhcnNlZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIkRhdGEgYnl0ZXMgbXVzdCBiZSBpbnRlZ2VycyBiZXR3ZWVuIDAgKDB4MDApIGFuZCAyNTUgKDB4RkYpLiIpOwogICAgICB9CiAgICB9KTsKCiAgICB0aGlzLl9taWRpT3V0cHV0LnNlbmQoW3N0YXR1c10uY29uY2F0KG1lc3NhZ2UpLCBwYXJzZUZsb2F0KHRpbWVzdGFtcCkgfHwgMCk7CgogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBTZW5kcyBhIE1JREkgKnN5c3RlbSBleGNsdXNpdmUqIChzeXNleCkgbWVzc2FnZS4gVGhlIGdlbmVyYXRlZCBtZXNzYWdlIHdpbGwgYXV0b21hdGljYWxseSBiZQogICAqIHByZXBlbmRlZCB3aXRoIHRoZSAqc3lzZXgqIGJ5dGUgKDB4RjApIGFuZCB0ZXJtaW5hdGVkIHdpdGggdGhlICplbmQgb2Ygc3lzZXgqIGJ5dGUgKDB4RjcpLgogICAqCiAgICogVG8gdXNlIHRoZSBgc2VuZFN5c2V4KClgIG1ldGhvZCwgc3lzdGVtIGV4Y2x1c2l2ZSBtZXNzYWdlIHN1cHBvcnQgbXVzdCBoYXZlIGJlZW4gZW5hYmxlZC4gVG8KICAgKiBkbyBzbywgeW91IG11c3QgcGFzcyBgdHJ1ZWAgYXMgdGhlIHNlY29uZCBwYXJhbWV0ZXIgdG8gYFdlYk1pZGkuZW5hYmxlKClgOgogICAqCiAgICogICAgIFdlYk1pZGkuZW5hYmxlKGZ1bmN0aW9uIChlcnIpIHsKICAgKiAgICAgICAgIGlmIChlcnIpIHsKICAgKiAgICAgICAgICAgICBjb25zb2xlLndhcm4oZXJyKTsKICAgKiAgICAgICAgIH0gZWxzZSB7CiAgICogICAgICAgICAgICAgY29uc29sZS5sb2coIlN5c2V4IGlzIGVuYWJsZWQhIik7CiAgICogICAgICAgICB9CiAgICogICAgIH0sIHRydWUpOwogICAqCiAgICogTm90ZSB0aGF0LCBkZXBlbmRpbmcgb24gYnJvd3NlciwgdmVyc2lvbiBhbmQgcGxhdGZvcm0sIGl0IG1heSBiZSBuZWNlc3NhcnkgdG8gc2VydmUgdGhlIHBhZ2UKICAgKiBvdmVyIEhUVFBTIHRvIGVuYWJsZSBzeXNleCBzdXBwb3J0LgogICAqCiAgICogIyMjIyBFeGFtcGxlcwogICAqCiAgICogSWYgeW91IHdhbnQgdG8gc2VuZCBhIHN5c2V4IG1lc3NhZ2UgdG8gYSBLb3JnIGRldmljZSBjb25uZWN0ZWQgdG8gdGhlIGZpcnN0IG91dHB1dCwgeW91IHdvdWxkCiAgICogdXNlIHRoZSBmb2xsb3dpbmcgY29kZToKICAgKgogICAqICAgICBXZWJNaWRpLm91dHB1dHNbMF0uc2VuZFN5c2V4KDB4NDIsIFsweDEsIDB4MiwgMHgzLCAweDQsIDB4NV0pOwogICAqCiAgICogVGhlIHBhcmFtZXRlcnMgY2FuIGJlIHNwZWNpZmllZCB1c2luZyBhbnkgbnVtYmVyIG5vdGF0aW9uIChkZWNpbWFsLCBoZXgsIGJpbmFyeSwgZXRjLikuCiAgICogVGhlcmVmb3JlLCB0aGUgY29kZSBiZWxvdyBpcyBlcXVpdmFsZW50IHRvIHRoZSBjb2RlIGFib3ZlOgogICAqCiAgICogICAgIFdlYk1pZGkub3V0cHV0c1swXS5zZW5kU3lzZXgoNjYsIFsxLCAyLCAzLCA0LCA1XSk7CiAgICoKICAgKiBUaGUgYWJvdmUgY29kZSBzZW5kcyB0aGUgYnl0ZSB2YWx1ZXMgMSwgMiwgMywgNCBhbmQgNSB0byBLb3JnIGRldmljZXMgKGhleCA0MiBpcyB0aGUgc2FtZSBhcwogICAqIGRlY2ltYWwgNjYpLgogICAqCiAgICogU29tZSBtYW51ZmFjdHVyZXJzIGFyZSBpZGVudGlmaWVkIHVzaW5nIDMgYnl0ZXMuIEluIHRoaXMgY2FzZSwgeW91IHdvdWxkIHVzZSBhIDMtcG9zaXRpb24gYXJyYXkKICAgKiBhcyB0aGUgZmlyc3QgcGFyYW1ldGVyLiBGb3IgZXhhbXBsZSwgdG8gc2VuZCB0aGUgc2FtZSBzeXNleCBtZXNzYWdlIHRvIGEKICAgKiAqTmF0aXZlIEluc3RydW1lbnRzKiBkZXZpY2U6CiAgICoKICAgKiAgICAgV2ViTWlkaS5vdXRwdXRzWzBdLnNlbmRTeXNleChbMHgwMCwgMHgyMSwgMHgwOV0sIFsweDEsIDB4MiwgMHgzLCAweDQsIDB4NV0pOwogICAqCiAgICogVGhlcmUgaXMgbm8gbGltaXQgZm9yIHRoZSBsZW5ndGggb2YgdGhlIGRhdGEgYXJyYXkuIEhvd2V2ZXIsIGl0IGlzIGdlbmVyYWxseSBzdWdnZXN0ZWQgdG8ga2VlcAogICAqIHN5c3RlbSBleGNsdXNpdmUgbWVzc2FnZXMgdG8gNjRLYiBvciBsZXNzLgogICAqCiAgICogQG1ldGhvZCBzZW5kU3lzZXgKICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0gbWFudWZhY3R1cmVyIHtOdW1iZXJ8QXJyYXl9IEFuIHVuc2lnbmVkIGludGVnZXIgb3IgYW4gYXJyYXkgb2YgdGhyZWUgdW5zaWduZWQgaW50ZWdlcnMKICAgKiBiZXR3ZWVuIDAgYW5kIDEyNyB0aGF0IGlkZW50aWZ5IHRoZSB0YXJnZXRlZCBtYW51ZmFjdHVyZXIuIFRoZSAqTUlESSBNYW51ZmFjdHVyZXJzIEFzc29jaWF0aW9uKgogICAqIG1haW50YWlucyBhIGZ1bGwgbGlzdCBvZgogICAqIFtNYW51ZmFjdHVyZXIgSUQgTnVtYmVyc10oaHR0cHM6Ly93d3cubWlkaS5vcmcvc3BlY2lmaWNhdGlvbnMvaXRlbS9tYW51ZmFjdHVyZXItaWQtbnVtYmVycykuCiAgICoKICAgKiBAcGFyYW0gW2RhdGE9W11dIHtBcnJheX0gQW4gYXJyYXkgb2YgdWludHMgYmV0d2VlbiAwIGFuZCAxMjcuIFRoaXMgaXMgdGhlIGRhdGEgeW91IHdpc2ggdG8KICAgKiB0cmFuc2Zlci4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucz17fV0KICAgKgogICAqIEBwYXJhbSB7RE9NSGlnaFJlc1RpbWVTdGFtcHxTdHJpbmd9IFtvcHRpb25zLnRpbWU9dW5kZWZpbmVkXSBUaGlzIHZhbHVlIGNhbiBiZSBvbmUgb2YgdHdvCiAgICogdGhpbmdzLiBJZiB0aGUgdmFsdWUgaXMgYSBzdHJpbmcgc3RhcnRpbmcgd2l0aCB0aGUgKyBzaWduIGFuZCBmb2xsb3dlZCBieSBhIG51bWJlciwgdGhlIHJlcXVlc3QKICAgKiB3aWxsIGJlIGRlbGF5ZWQgYnkgdGhlIHNwZWNpZmllZCBudW1iZXIgKGluIG1pbGxpc2Vjb25kcykuIE90aGVyd2lzZSwgdGhlIHZhbHVlIGlzIGNvbnNpZGVyZWQgYQogICAqIHRpbWVzdGFtcCBhbmQgdGhlIHJlcXVlc3Qgd2lsbCBiZSBzY2hlZHVsZWQgYXQgdGhhdCB0aW1lc3RhbXAuIFRoZSBgRE9NSGlnaFJlc1RpbWVTdGFtcGAgdmFsdWUKICAgKiBpcyByZWxhdGl2ZSB0byB0aGUgbmF2aWdhdGlvbiBzdGFydCBvZiB0aGUgZG9jdW1lbnQuIFRvIHJldHJpZXZlIHRoZSBjdXJyZW50IHRpbWUsIHlvdSBjYW4gdXNlCiAgICogYFdlYk1pZGkudGltZWAuIElmIGB0aW1lYCBpcyBub3QgcHJlc2VudCBvciBpcyBzZXQgdG8gYSB0aW1lIGluIHRoZSBwYXN0LCB0aGUgcmVxdWVzdCBpcyB0byBiZQogICAqIHNlbnQgYXMgc29vbiBhcyBwb3NzaWJsZS4KICAgKgogICAqIEB0aHJvdyBTeXNleCBtZXNzYWdlIHN1cHBvcnQgbXVzdCBmaXJzdCBiZSBhY3RpdmF0ZWQuCiAgICogQHRocm93IFRoZSBkYXRhIGJ5dGVzIG9mIGEgc3lzZXggbWVzc2FnZSBtdXN0IGJlIGludGVnZXJzIGJldHdlZW4gMCAoMHgwMCkgYW5kIDEyNyAoMHg3RikuCiAgICoKICAgKiBAcmV0dXJuIHtPdXRwdXR9IFJldHVybnMgdGhlIGBPdXRwdXRgIG9iamVjdCBzbyBtZXRob2RzIGNhbiBiZSBjaGFpbmVkLgogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5zZW5kU3lzZXggPSBmdW5jdGlvbiAobWFudWZhY3R1cmVyLCBkYXRhLCBvcHRpb25zKSB7CiAgICBpZiAoIXdtLnN5c2V4RW5hYmxlZCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlN5c2V4IG1lc3NhZ2Ugc3VwcG9ydCBtdXN0IGZpcnN0IGJlIGFjdGl2YXRlZC4iKTsKICAgIH0KCiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIG1hbnVmYWN0dXJlciA9IFtdLmNvbmNhdChtYW51ZmFjdHVyZXIpOwogICAgZGF0YS5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIGlmIChpdGVtIDwgMCB8fCBpdGVtID4gMTI3KSB7CiAgICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIlRoZSBkYXRhIGJ5dGVzIG9mIGEgc3lzZXggbWVzc2FnZSBtdXN0IGJlIGludGVnZXJzIGJldHdlZW4gMCAoMHgwMCkgYW5kIDEyNyAoMHg3RikuIik7CiAgICAgIH0KICAgIH0pOwogICAgZGF0YSA9IG1hbnVmYWN0dXJlci5jb25jYXQoZGF0YSwgd20uTUlESV9TWVNURU1fTUVTU0FHRVMuc3lzZXhlbmQpOwogICAgdGhpcy5zZW5kKHdtLk1JRElfU1lTVEVNX01FU1NBR0VTLnN5c2V4LCBkYXRhLCB0aGlzLl9wYXJzZVRpbWVQYXJhbWV0ZXIob3B0aW9ucy50aW1lKSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIFNlbmRzIGEgKk1JREkgVGltZWNvZGUgUXVhcnRlciBGcmFtZSogbWVzc2FnZS4gUGxlYXNlIG5vdGUgdGhhdCBubyBwcm9jZXNzaW5nIGlzIGJlaW5nIGRvbmUgb24KICAgKiB0aGUgZGF0YS4gSXQgaXMgdXAgdG8gdGhlIGRldmVsb3BlciB0byBmb3JtYXQgdGhlIGRhdGEgYWNjb3JkaW5nIHRvIHRoZQogICAqIFtNSURJIFRpbWVjb2RlXShodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9NSURJX3RpbWVjb2RlKSBmb3JtYXQuCiAgICoKICAgKiBAbWV0aG9kIHNlbmRUaW1lY29kZVF1YXJ0ZXJGcmFtZQogICAqIEBjaGFpbmFibGUKICAgKgogICAqIEBwYXJhbSB2YWx1ZSB7TnVtYmVyfSBUaGUgcXVhcnRlciBmcmFtZSBtZXNzYWdlIGNvbnRlbnQgKGludGVnZXIgYmV0d2VlbiAwIGFuZCAxMjcpLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zPXt9XQogICAqCiAgICogQHBhcmFtIHtET01IaWdoUmVzVGltZVN0YW1wfFN0cmluZ30gW29wdGlvbnMudGltZT11bmRlZmluZWRdIFRoaXMgdmFsdWUgY2FuIGJlIG9uZSBvZiB0d28KICAgKiB0aGluZ3MuIElmIHRoZSB2YWx1ZSBpcyBhIHN0cmluZyBzdGFydGluZyB3aXRoIHRoZSArIHNpZ24gYW5kIGZvbGxvd2VkIGJ5IGEgbnVtYmVyLCB0aGUgcmVxdWVzdAogICAqIHdpbGwgYmUgZGVsYXllZCBieSB0aGUgc3BlY2lmaWVkIG51bWJlciAoaW4gbWlsbGlzZWNvbmRzKS4gT3RoZXJ3aXNlLCB0aGUgdmFsdWUgaXMgY29uc2lkZXJlZCBhCiAgICogdGltZXN0YW1wIGFuZCB0aGUgcmVxdWVzdCB3aWxsIGJlIHNjaGVkdWxlZCBhdCB0aGF0IHRpbWVzdGFtcC4gVGhlIGBET01IaWdoUmVzVGltZVN0YW1wYCB2YWx1ZQogICAqIGlzIHJlbGF0aXZlIHRvIHRoZSBuYXZpZ2F0aW9uIHN0YXJ0IG9mIHRoZSBkb2N1bWVudC4gVG8gcmV0cmlldmUgdGhlIGN1cnJlbnQgdGltZSwgeW91IGNhbiB1c2UKICAgKiBgV2ViTWlkaS50aW1lYC4gSWYgYHRpbWVgIGlzIG5vdCBwcmVzZW50IG9yIGlzIHNldCB0byBhIHRpbWUgaW4gdGhlIHBhc3QsIHRoZSByZXF1ZXN0IGlzIHRvIGJlCiAgICogc2VudCBhcyBzb29uIGFzIHBvc3NpYmxlLgogICAqCiAgICogQHJldHVybiB7T3V0cHV0fSBSZXR1cm5zIHRoZSBgT3V0cHV0YCBvYmplY3Qgc28gbWV0aG9kcyBjYW4gYmUgY2hhaW5lZC4KICAgKi8KCgogIE91dHB1dC5wcm90b3R5cGUuc2VuZFRpbWVjb2RlUXVhcnRlckZyYW1lID0gZnVuY3Rpb24gKHZhbHVlLCBvcHRpb25zKSB7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHRoaXMuc2VuZCh3bS5NSURJX1NZU1RFTV9NRVNTQUdFUy50aW1lY29kZSwgdmFsdWUsIHRoaXMuX3BhcnNlVGltZVBhcmFtZXRlcihvcHRpb25zLnRpbWUpKTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgLyoqCiAgICogU2VuZHMgYSAqU29uZyBQb3NpdGlvbiogTUlESSBtZXNzYWdlLiBUaGUgdmFsdWUgaXMgZXhwcmVzc2VkIGluIE1JREkgYmVhdHMgKGJldHdlZW4gMCBhbmQKICAgKiAxNjM4Mykgd2hpY2ggYXJlIDE2dGggbm90ZS4gUG9zaXRpb24gMCBpcyBhbHdheXMgdGhlIHN0YXJ0IG9mIHRoZSBzb25nLgogICAqCiAgICogQG1ldGhvZCBzZW5kU29uZ1Bvc2l0aW9uCiAgICogQGNoYWluYWJsZQogICAqCiAgICogQHBhcmFtIFt2YWx1ZT0wXSB7TnVtYmVyfSBUaGUgTUlESSBiZWF0IHRvIGN1ZSB0byAoaW50IGJldHdlZW4gMCBhbmQgMTYzODMpLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zPXt9XQogICAqCiAgICogQHBhcmFtIHtET01IaWdoUmVzVGltZVN0YW1wfFN0cmluZ30gW29wdGlvbnMudGltZT11bmRlZmluZWRdIFRoaXMgdmFsdWUgY2FuIGJlIG9uZSBvZiB0d28KICAgKiB0aGluZ3MuIElmIHRoZSB2YWx1ZSBpcyBhIHN0cmluZyBzdGFydGluZyB3aXRoIHRoZSArIHNpZ24gYW5kIGZvbGxvd2VkIGJ5IGEgbnVtYmVyLCB0aGUgcmVxdWVzdAogICAqIHdpbGwgYmUgZGVsYXllZCBieSB0aGUgc3BlY2lmaWVkIG51bWJlciAoaW4gbWlsbGlzZWNvbmRzKS4gT3RoZXJ3aXNlLCB0aGUgdmFsdWUgaXMgY29uc2lkZXJlZCBhCiAgICogdGltZXN0YW1wIGFuZCB0aGUgcmVxdWVzdCB3aWxsIGJlIHNjaGVkdWxlZCBhdCB0aGF0IHRpbWVzdGFtcC4gVGhlIGBET01IaWdoUmVzVGltZVN0YW1wYCB2YWx1ZQogICAqIGlzIHJlbGF0aXZlIHRvIHRoZSBuYXZpZ2F0aW9uIHN0YXJ0IG9mIHRoZSBkb2N1bWVudC4gVG8gcmV0cmlldmUgdGhlIGN1cnJlbnQgdGltZSwgeW91IGNhbiB1c2UKICAgKiBgV2ViTWlkaS50aW1lYC4gSWYgYHRpbWVgIGlzIG5vdCBwcmVzZW50IG9yIGlzIHNldCB0byBhIHRpbWUgaW4gdGhlIHBhc3QsIHRoZSByZXF1ZXN0IGlzIHRvIGJlCiAgICogc2VudCBhcyBzb29uIGFzIHBvc3NpYmxlLgogICAqCiAgICogQHJldHVybiB7T3V0cHV0fSBSZXR1cm5zIHRoZSBgT3V0cHV0YCBvYmplY3Qgc28gbWV0aG9kcyBjYW4gYmUgY2hhaW5lZC4KICAgKi8KCgogIE91dHB1dC5wcm90b3R5cGUuc2VuZFNvbmdQb3NpdGlvbiA9IGZ1bmN0aW9uICh2YWx1ZSwgb3B0aW9ucykgewogICAgdmFsdWUgPSBNYXRoLmZsb29yKHZhbHVlKSB8fCAwOwogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB2YXIgbXNiID0gdmFsdWUgPj4gNyAmIDB4N0Y7CiAgICB2YXIgbHNiID0gdmFsdWUgJiAweDdGOwogICAgdGhpcy5zZW5kKHdtLk1JRElfU1lTVEVNX01FU1NBR0VTLnNvbmdwb3NpdGlvbiwgW21zYiwgbHNiXSwgdGhpcy5fcGFyc2VUaW1lUGFyYW1ldGVyKG9wdGlvbnMudGltZSkpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBTZW5kcyBhICpTb25nIFNlbGVjdCogTUlESSBtZXNzYWdlLiBCZXdhcmUgdGhhdCBzb21lIGRldmljZXMgd2lsbCBkaXNwbGF5IHBvc2l0aW9uIDAgYXMKICAgKiBwb3NpdGlvbiAxIGZvciB1c2VyLWZyaWVuZGx5bmVzcy4KICAgKgogICAqIEBtZXRob2Qgc2VuZFNvbmdTZWxlY3QKICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0gdmFsdWUge051bWJlcn0gVGhlIG51bWJlciBvZiB0aGUgc29uZyB0byBzZWxlY3QgKGludGVnZXIgYmV0d2VlbiAwIGFuZCAxMjcpLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zPXt9XQogICAqCiAgICogQHBhcmFtIHtET01IaWdoUmVzVGltZVN0YW1wfFN0cmluZ30gW29wdGlvbnMudGltZT11bmRlZmluZWRdIFRoaXMgdmFsdWUgY2FuIGJlIG9uZSBvZiB0d28KICAgKiB0aGluZ3MuIElmIHRoZSB2YWx1ZSBpcyBhIHN0cmluZyBzdGFydGluZyB3aXRoIHRoZSArIHNpZ24gYW5kIGZvbGxvd2VkIGJ5IGEgbnVtYmVyLCB0aGUgcmVxdWVzdAogICAqIHdpbGwgYmUgZGVsYXllZCBieSB0aGUgc3BlY2lmaWVkIG51bWJlciAoaW4gbWlsbGlzZWNvbmRzKS4gT3RoZXJ3aXNlLCB0aGUgdmFsdWUgaXMgY29uc2lkZXJlZCBhCiAgICogdGltZXN0YW1wIGFuZCB0aGUgcmVxdWVzdCB3aWxsIGJlIHNjaGVkdWxlZCBhdCB0aGF0IHRpbWVzdGFtcC4gVGhlIGBET01IaWdoUmVzVGltZVN0YW1wYCB2YWx1ZQogICAqIGlzIHJlbGF0aXZlIHRvIHRoZSBuYXZpZ2F0aW9uIHN0YXJ0IG9mIHRoZSBkb2N1bWVudC4gVG8gcmV0cmlldmUgdGhlIGN1cnJlbnQgdGltZSwgeW91IGNhbiB1c2UKICAgKiBgV2ViTWlkaS50aW1lYC4gSWYgYHRpbWVgIGlzIG5vdCBwcmVzZW50IG9yIGlzIHNldCB0byBhIHRpbWUgaW4gdGhlIHBhc3QsIHRoZSByZXF1ZXN0IGlzIHRvIGJlCiAgICogc2VudCBhcyBzb29uIGFzIHBvc3NpYmxlLgogICAqCiAgICogQHRocm93cyBUaGUgc29uZyBudW1iZXIgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDEyNy4KICAgKgogICAqIEByZXR1cm4ge091dHB1dH0gUmV0dXJucyB0aGUgYE91dHB1dGAgb2JqZWN0IHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICovCgoKICBPdXRwdXQucHJvdG90eXBlLnNlbmRTb25nU2VsZWN0ID0gZnVuY3Rpb24gKHZhbHVlLCBvcHRpb25zKSB7CiAgICB2YWx1ZSA9IE1hdGguZmxvb3IodmFsdWUpOwogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgaWYgKCEodmFsdWUgPj0gMCAmJiB2YWx1ZSA8PSAxMjcpKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJUaGUgc29uZyBudW1iZXIgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDEyNy4iKTsKICAgIH0KCiAgICB0aGlzLnNlbmQod20uTUlESV9TWVNURU1fTUVTU0FHRVMuc29uZ3NlbGVjdCwgW3ZhbHVlXSwgdGhpcy5fcGFyc2VUaW1lUGFyYW1ldGVyKG9wdGlvbnMudGltZSkpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBTZW5kcyBhICpNSURJIHR1bmluZyByZXF1ZXN0KiByZWFsLXRpbWUgbWVzc2FnZS4KICAgKgogICAqIE5vdGU6IHRoZXJlIGlzIGN1cnJlbnRseSBhIGJ1ZyBpbiBDaHJvbWUicyBNSURJIGltcGxlbWVudGF0aW9uLiBJZiB5b3UgdHJ5IHRvIHVzZSB0aGlzCiAgICogZnVuY3Rpb24sIENocm9tZSB3aWxsIGFjdHVhbGx5IHRocm93IGEgIk1lc3NhZ2UgaXMgaW5jb21wbGV0ZSIgZXJyb3IuIFRoZSBidWcgaXMKICAgKiBbc2NoZWR1bGVkIHRvIGJlIGZpeGVkXShodHRwczovL2J1Z3MuY2hyb21pdW0ub3JnL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD02MTAxMTYpLgogICAqCiAgICogQG1ldGhvZCBzZW5kVHVuaW5nUmVxdWVzdAogICAqIEBjaGFpbmFibGUKICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucz17fV0KICAgKgogICAqIEBwYXJhbSB7RE9NSGlnaFJlc1RpbWVTdGFtcHxTdHJpbmd9IFtvcHRpb25zLnRpbWU9dW5kZWZpbmVkXSBUaGlzIHZhbHVlIGNhbiBiZSBvbmUgb2YgdHdvCiAgICogdGhpbmdzLiBJZiB0aGUgdmFsdWUgaXMgYSBzdHJpbmcgc3RhcnRpbmcgd2l0aCB0aGUgKyBzaWduIGFuZCBmb2xsb3dlZCBieSBhIG51bWJlciwgdGhlIHJlcXVlc3QKICAgKiB3aWxsIGJlIGRlbGF5ZWQgYnkgdGhlIHNwZWNpZmllZCBudW1iZXIgKGluIG1pbGxpc2Vjb25kcykuIE90aGVyd2lzZSwgdGhlIHZhbHVlIGlzIGNvbnNpZGVyZWQgYQogICAqIHRpbWVzdGFtcCBhbmQgdGhlIHJlcXVlc3Qgd2lsbCBiZSBzY2hlZHVsZWQgYXQgdGhhdCB0aW1lc3RhbXAuIFRoZSBgRE9NSGlnaFJlc1RpbWVTdGFtcGAgdmFsdWUKICAgKiBpcyByZWxhdGl2ZSB0byB0aGUgbmF2aWdhdGlvbiBzdGFydCBvZiB0aGUgZG9jdW1lbnQuIFRvIHJldHJpZXZlIHRoZSBjdXJyZW50IHRpbWUsIHlvdSBjYW4gdXNlCiAgICogYFdlYk1pZGkudGltZWAuIElmIGB0aW1lYCBpcyBub3QgcHJlc2VudCBvciBpcyBzZXQgdG8gYSB0aW1lIGluIHRoZSBwYXN0LCB0aGUgcmVxdWVzdCBpcyB0byBiZQogICAqIHNlbnQgYXMgc29vbiBhcyBwb3NzaWJsZS4KICAgKgogICAqIEByZXR1cm4ge091dHB1dH0gUmV0dXJucyB0aGUgYE91dHB1dGAgb2JqZWN0IHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICovCgoKICBPdXRwdXQucHJvdG90eXBlLnNlbmRUdW5pbmdSZXF1ZXN0ID0gZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgdGhpcy5zZW5kKHdtLk1JRElfU1lTVEVNX01FU1NBR0VTLnR1bmluZ3JlcXVlc3QsIHVuZGVmaW5lZCwgdGhpcy5fcGFyc2VUaW1lUGFyYW1ldGVyKG9wdGlvbnMudGltZSkpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBTZW5kcyBhICpNSURJIENsb2NrKiByZWFsLXRpbWUgbWVzc2FnZS4gQWNjb3JkaW5nIHRvIHRoZSBzdGFuZGFyZCwgdGhlcmUgYXJlIDI0IE1JREkgQ2xvY2tzCiAgICogZm9yIGV2ZXJ5IHF1YXJ0ZXIgbm90ZS4KICAgKgogICAqIEBtZXRob2Qgc2VuZENsb2NrCiAgICogQGNoYWluYWJsZQogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zPXt9XQogICAqCiAgICogQHBhcmFtIHtET01IaWdoUmVzVGltZVN0YW1wfFN0cmluZ30gW29wdGlvbnMudGltZT11bmRlZmluZWRdIFRoaXMgdmFsdWUgY2FuIGJlIG9uZSBvZiB0d28KICAgKiB0aGluZ3MuIElmIHRoZSB2YWx1ZSBpcyBhIHN0cmluZyBzdGFydGluZyB3aXRoIHRoZSArIHNpZ24gYW5kIGZvbGxvd2VkIGJ5IGEgbnVtYmVyLCB0aGUgcmVxdWVzdAogICAqIHdpbGwgYmUgZGVsYXllZCBieSB0aGUgc3BlY2lmaWVkIG51bWJlciAoaW4gbWlsbGlzZWNvbmRzKS4gT3RoZXJ3aXNlLCB0aGUgdmFsdWUgaXMgY29uc2lkZXJlZCBhCiAgICogdGltZXN0YW1wIGFuZCB0aGUgcmVxdWVzdCB3aWxsIGJlIHNjaGVkdWxlZCBhdCB0aGF0IHRpbWVzdGFtcC4gVGhlIGBET01IaWdoUmVzVGltZVN0YW1wYCB2YWx1ZQogICAqIGlzIHJlbGF0aXZlIHRvIHRoZSBuYXZpZ2F0aW9uIHN0YXJ0IG9mIHRoZSBkb2N1bWVudC4gVG8gcmV0cmlldmUgdGhlIGN1cnJlbnQgdGltZSwgeW91IGNhbiB1c2UKICAgKiBgV2ViTWlkaS50aW1lYC4gSWYgYHRpbWVgIGlzIG5vdCBwcmVzZW50IG9yIGlzIHNldCB0byBhIHRpbWUgaW4gdGhlIHBhc3QsIHRoZSByZXF1ZXN0IGlzIHRvIGJlCiAgICogc2VudCBhcyBzb29uIGFzIHBvc3NpYmxlLgogICAqCiAgICogQHJldHVybiB7T3V0cHV0fSBSZXR1cm5zIHRoZSBgT3V0cHV0YCBvYmplY3Qgc28gbWV0aG9kcyBjYW4gYmUgY2hhaW5lZC4KICAgKi8KCgogIE91dHB1dC5wcm90b3R5cGUuc2VuZENsb2NrID0gZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgdGhpcy5zZW5kKHdtLk1JRElfU1lTVEVNX01FU1NBR0VTLmNsb2NrLCB1bmRlZmluZWQsIHRoaXMuX3BhcnNlVGltZVBhcmFtZXRlcihvcHRpb25zLnRpbWUpKTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgLyoqCiAgICogU2VuZHMgYSAqU3RhcnQqIHJlYWwtdGltZSBtZXNzYWdlLiBBIE1JREkgU3RhcnQgbWVzc2FnZSBzdGFydHMgdGhlIHBsYXliYWNrIG9mIHRoZSBjdXJyZW50CiAgICogc29uZyBhdCBiZWF0IDAuIFRvIHN0YXJ0IHBsYXliYWNrIGVsc2V3aGVyZSBpbiB0aGUgc29uZywgdXNlIHRoZSBgc2VuZENvbnRpbnVlKClgIGZ1bmN0aW9uLgogICAqCiAgICogQG1ldGhvZCBzZW5kU3RhcnQKICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dCiAgICoKICAgKiBAcGFyYW0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB8U3RyaW5nfSBbb3B0aW9ucy50aW1lPXVuZGVmaW5lZF0gVGhpcyB2YWx1ZSBjYW4gYmUgb25lIG9mIHR3bwogICAqIHRoaW5ncy4gSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHN0YXJ0aW5nIHdpdGggdGhlICsgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsIHRoZSByZXF1ZXN0CiAgICogd2lsbCBiZSBkZWxheWVkIGJ5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIChpbiBtaWxsaXNlY29uZHMpLiBPdGhlcndpc2UsIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEKICAgKiB0aW1lc3RhbXAgYW5kIHRoZSByZXF1ZXN0IHdpbGwgYmUgc2NoZWR1bGVkIGF0IHRoYXQgdGltZXN0YW1wLiBUaGUgYERPTUhpZ2hSZXNUaW1lU3RhbXBgIHZhbHVlCiAgICogaXMgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LiBUbyByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lLCB5b3UgY2FuIHVzZQogICAqIGBXZWJNaWRpLnRpbWVgLiBJZiBgdGltZWAgaXMgbm90IHByZXNlbnQgb3IgaXMgc2V0IHRvIGEgdGltZSBpbiB0aGUgcGFzdCwgdGhlIHJlcXVlc3QgaXMgdG8gYmUKICAgKiBzZW50IGFzIHNvb24gYXMgcG9zc2libGUuCiAgICoKICAgKiBAcmV0dXJuIHtPdXRwdXR9IFJldHVybnMgdGhlIGBPdXRwdXRgIG9iamVjdCBzbyBtZXRob2RzIGNhbiBiZSBjaGFpbmVkLgogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5zZW5kU3RhcnQgPSBmdW5jdGlvbiAob3B0aW9ucykgewogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB0aGlzLnNlbmQod20uTUlESV9TWVNURU1fTUVTU0FHRVMuc3RhcnQsIHVuZGVmaW5lZCwgdGhpcy5fcGFyc2VUaW1lUGFyYW1ldGVyKG9wdGlvbnMudGltZSkpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBTZW5kcyBhICpDb250aW51ZSogcmVhbC10aW1lIG1lc3NhZ2UuIFRoaXMgcmVzdW1lcyBzb25nIHBsYXliYWNrIHdoZXJlIGl0IHdhcyBwcmV2aW91c2x5CiAgICogc3RvcHBlZCBvciB3aGVyZSBpdCB3YXMgbGFzdCBjdWVkIHdpdGggYSBzb25nIHBvc2l0aW9uIG1lc3NhZ2UuIFRvIHN0YXJ0IHBsYXliYWNrIGZyb20gdGhlCiAgICogc3RhcnQsIHVzZSB0aGUgYHNlbmRTdGFydCgpYCBmdW5jdGlvbi4KICAgKgogICAqIEBtZXRob2Qgc2VuZENvbnRpbnVlCiAgICogQGNoYWluYWJsZQogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zPXt9XQogICAqCiAgICogQHBhcmFtIHtET01IaWdoUmVzVGltZVN0YW1wfFN0cmluZ30gW29wdGlvbnMudGltZT11bmRlZmluZWRdIFRoaXMgdmFsdWUgY2FuIGJlIG9uZSBvZiB0d28KICAgKiB0aGluZ3MuIElmIHRoZSB2YWx1ZSBpcyBhIHN0cmluZyBzdGFydGluZyB3aXRoIHRoZSArIHNpZ24gYW5kIGZvbGxvd2VkIGJ5IGEgbnVtYmVyLCB0aGUgcmVxdWVzdAogICAqIHdpbGwgYmUgZGVsYXllZCBieSB0aGUgc3BlY2lmaWVkIG51bWJlciAoaW4gbWlsbGlzZWNvbmRzKS4gT3RoZXJ3aXNlLCB0aGUgdmFsdWUgaXMgY29uc2lkZXJlZCBhCiAgICogdGltZXN0YW1wIGFuZCB0aGUgcmVxdWVzdCB3aWxsIGJlIHNjaGVkdWxlZCBhdCB0aGF0IHRpbWVzdGFtcC4gVGhlIGBET01IaWdoUmVzVGltZVN0YW1wYCB2YWx1ZQogICAqIGlzIHJlbGF0aXZlIHRvIHRoZSBuYXZpZ2F0aW9uIHN0YXJ0IG9mIHRoZSBkb2N1bWVudC4gVG8gcmV0cmlldmUgdGhlIGN1cnJlbnQgdGltZSwgeW91IGNhbiB1c2UKICAgKiBgV2ViTWlkaS50aW1lYC4gSWYgYHRpbWVgIGlzIG5vdCBwcmVzZW50IG9yIGlzIHNldCB0byBhIHRpbWUgaW4gdGhlIHBhc3QsIHRoZSByZXF1ZXN0IGlzIHRvIGJlCiAgICogc2VudCBhcyBzb29uIGFzIHBvc3NpYmxlLgogICAqCiAgICogQHJldHVybiB7V2ViTWlkaX0gUmV0dXJucyB0aGUgYFdlYk1pZGlgIG9iamVjdCBzbyBtZXRob2RzIGNhbiBiZSBjaGFpbmVkLgogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5zZW5kQ29udGludWUgPSBmdW5jdGlvbiAob3B0aW9ucykgewogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB0aGlzLnNlbmQod20uTUlESV9TWVNURU1fTUVTU0FHRVNbImNvbnRpbnVlIl0sIHVuZGVmaW5lZCwgdGhpcy5fcGFyc2VUaW1lUGFyYW1ldGVyKG9wdGlvbnMudGltZSkpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBTZW5kcyBhICpTdG9wKiByZWFsLXRpbWUgbWVzc2FnZS4gVGhpcyB0ZWxscyB0aGUgZGV2aWNlIGNvbm5lY3RlZCB0byB0aGlzIHBvcnQgdG8gc3RvcCBwbGF5YmFjawogICAqIGltbWVkaWF0ZWx5IChvciBhdCB0aGUgc2NoZWR1bGVkIHRpbWUpLgogICAqCiAgICogQG1ldGhvZCBzZW5kU3RvcAogICAqIEBjaGFpbmFibGUKICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucz17fV0KICAgKgogICAqIEBwYXJhbSB7RE9NSGlnaFJlc1RpbWVTdGFtcHxTdHJpbmd9IFtvcHRpb25zLnRpbWU9dW5kZWZpbmVkXSBUaGlzIHZhbHVlIGNhbiBiZSBvbmUgb2YgdHdvCiAgICogdGhpbmdzLiBJZiB0aGUgdmFsdWUgaXMgYSBzdHJpbmcgc3RhcnRpbmcgd2l0aCB0aGUgKyBzaWduIGFuZCBmb2xsb3dlZCBieSBhIG51bWJlciwgdGhlIHJlcXVlc3QKICAgKiB3aWxsIGJlIGRlbGF5ZWQgYnkgdGhlIHNwZWNpZmllZCBudW1iZXIgKGluIG1pbGxpc2Vjb25kcykuIE90aGVyd2lzZSwgdGhlIHZhbHVlIGlzIGNvbnNpZGVyZWQgYQogICAqIHRpbWVzdGFtcCBhbmQgdGhlIHJlcXVlc3Qgd2lsbCBiZSBzY2hlZHVsZWQgYXQgdGhhdCB0aW1lc3RhbXAuIFRoZSBgRE9NSGlnaFJlc1RpbWVTdGFtcGAgdmFsdWUKICAgKiBpcyByZWxhdGl2ZSB0byB0aGUgbmF2aWdhdGlvbiBzdGFydCBvZiB0aGUgZG9jdW1lbnQuIFRvIHJldHJpZXZlIHRoZSBjdXJyZW50IHRpbWUsIHlvdSBjYW4gdXNlCiAgICogYFdlYk1pZGkudGltZWAuIElmIGB0aW1lYCBpcyBub3QgcHJlc2VudCBvciBpcyBzZXQgdG8gYSB0aW1lIGluIHRoZSBwYXN0LCB0aGUgcmVxdWVzdCBpcyB0byBiZQogICAqIHNlbnQgYXMgc29vbiBhcyBwb3NzaWJsZS4KICAgKgogICAqIEByZXR1cm4ge091dHB1dH0gUmV0dXJucyB0aGUgYE91dHB1dGAgb2JqZWN0IHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICovCgoKICBPdXRwdXQucHJvdG90eXBlLnNlbmRTdG9wID0gZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgdGhpcy5zZW5kKHdtLk1JRElfU1lTVEVNX01FU1NBR0VTLnN0b3AsIHVuZGVmaW5lZCwgdGhpcy5fcGFyc2VUaW1lUGFyYW1ldGVyKG9wdGlvbnMudGltZSkpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBTZW5kcyBhbiAqQWN0aXZlIFNlbnNpbmcqIHJlYWwtdGltZSBtZXNzYWdlLiBUaGlzIHRlbGxzIHRoZSBkZXZpY2UgY29ubmVjdGVkIHRvIHRoaXMgcG9ydCB0aGF0CiAgICogdGhlIGNvbm5lY3Rpb24gaXMgc3RpbGwgZ29vZC4gQWN0aXZlIHNlbnNpbmcgbWVzc2FnZXMgc2hvdWxkIGJlIHNlbnQgZXZlcnkgMzAwIG1zIGlmIHRoZXJlIHdhcwogICAqIG5vIG90aGVyIGFjdGl2aXR5IG9uIHRoZSBNSURJIHBvcnQuCiAgICoKICAgKiBAbWV0aG9kIHNlbmRBY3RpdmVTZW5zaW5nCiAgICogQGNoYWluYWJsZQogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zPXt9XQogICAqCiAgICogQHBhcmFtIHtET01IaWdoUmVzVGltZVN0YW1wfFN0cmluZ30gW29wdGlvbnMudGltZT11bmRlZmluZWRdIFRoaXMgdmFsdWUgY2FuIGJlIG9uZSBvZiB0d28KICAgKiB0aGluZ3MuIElmIHRoZSB2YWx1ZSBpcyBhIHN0cmluZyBzdGFydGluZyB3aXRoIHRoZSArIHNpZ24gYW5kIGZvbGxvd2VkIGJ5IGEgbnVtYmVyLCB0aGUgcmVxdWVzdAogICAqIHdpbGwgYmUgZGVsYXllZCBieSB0aGUgc3BlY2lmaWVkIG51bWJlciAoaW4gbWlsbGlzZWNvbmRzKS4gT3RoZXJ3aXNlLCB0aGUgdmFsdWUgaXMgY29uc2lkZXJlZCBhCiAgICogdGltZXN0YW1wIGFuZCB0aGUgcmVxdWVzdCB3aWxsIGJlIHNjaGVkdWxlZCBhdCB0aGF0IHRpbWVzdGFtcC4gVGhlIGBET01IaWdoUmVzVGltZVN0YW1wYCB2YWx1ZQogICAqIGlzIHJlbGF0aXZlIHRvIHRoZSBuYXZpZ2F0aW9uIHN0YXJ0IG9mIHRoZSBkb2N1bWVudC4gVG8gcmV0cmlldmUgdGhlIGN1cnJlbnQgdGltZSwgeW91IGNhbiB1c2UKICAgKiBgV2ViTWlkaS50aW1lYC4gSWYgYHRpbWVgIGlzIG5vdCBwcmVzZW50IG9yIGlzIHNldCB0byBhIHRpbWUgaW4gdGhlIHBhc3QsIHRoZSByZXF1ZXN0IGlzIHRvIGJlCiAgICogc2VudCBhcyBzb29uIGFzIHBvc3NpYmxlLgogICAqCiAgICogQHJldHVybiB7T3V0cHV0fSBSZXR1cm5zIHRoZSBgT3V0cHV0YCBvYmplY3Qgc28gbWV0aG9kcyBjYW4gYmUgY2hhaW5lZC4KICAgKi8KCgogIE91dHB1dC5wcm90b3R5cGUuc2VuZEFjdGl2ZVNlbnNpbmcgPSBmdW5jdGlvbiAob3B0aW9ucykgewogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB0aGlzLnNlbmQod20uTUlESV9TWVNURU1fTUVTU0FHRVMuYWN0aXZlc2Vuc2luZywgW10sIHRoaXMuX3BhcnNlVGltZVBhcmFtZXRlcihvcHRpb25zLnRpbWUpKTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgLyoqCiAgICogU2VuZHMgKlJlc2V0KiByZWFsLXRpbWUgbWVzc2FnZS4gVGhpcyB0ZWxscyB0aGUgZGV2aWNlIGNvbm5lY3RlZCB0byB0aGlzIHBvcnQgdGhhdCBpcyBzaG91bGQKICAgKiByZXNldCBpdHNlbGYgdG8gYSBkZWZhdWx0IHN0YXRlLgogICAqCiAgICogQG1ldGhvZCBzZW5kUmVzZXQKICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dCiAgICoKICAgKiBAcGFyYW0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB8U3RyaW5nfSBbb3B0aW9ucy50aW1lPXVuZGVmaW5lZF0gVGhpcyB2YWx1ZSBjYW4gYmUgb25lIG9mIHR3bwogICAqIHRoaW5ncy4gSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHN0YXJ0aW5nIHdpdGggdGhlICsgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsIHRoZSByZXF1ZXN0CiAgICogd2lsbCBiZSBkZWxheWVkIGJ5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIChpbiBtaWxsaXNlY29uZHMpLiBPdGhlcndpc2UsIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEKICAgKiB0aW1lc3RhbXAgYW5kIHRoZSByZXF1ZXN0IHdpbGwgYmUgc2NoZWR1bGVkIGF0IHRoYXQgdGltZXN0YW1wLiBUaGUgYERPTUhpZ2hSZXNUaW1lU3RhbXBgIHZhbHVlCiAgICogaXMgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LiBUbyByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lLCB5b3UgY2FuIHVzZQogICAqIGBXZWJNaWRpLnRpbWVgLiBJZiBgdGltZWAgaXMgbm90IHByZXNlbnQgb3IgaXMgc2V0IHRvIGEgdGltZSBpbiB0aGUgcGFzdCwgdGhlIHJlcXVlc3QgaXMgdG8gYmUKICAgKiBzZW50IGFzIHNvb24gYXMgcG9zc2libGUuCiAgICoKICAgKiBAcmV0dXJuIHtPdXRwdXR9IFJldHVybnMgdGhlIGBPdXRwdXRgIG9iamVjdCBzbyBtZXRob2RzIGNhbiBiZSBjaGFpbmVkLgogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5zZW5kUmVzZXQgPSBmdW5jdGlvbiAob3B0aW9ucykgewogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB0aGlzLnNlbmQod20uTUlESV9TWVNURU1fTUVTU0FHRVMucmVzZXQsIHVuZGVmaW5lZCwgdGhpcy5fcGFyc2VUaW1lUGFyYW1ldGVyKG9wdGlvbnMudGltZSkpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBTZW5kcyBhIE1JREkgKipub3RlIG9mZioqIG1lc3NhZ2UgdG8gdGhlIHNwZWNpZmllZCBjaGFubmVsKHMpIGZvciBhIHNpbmdsZSBub3RlIG9yIG11bHRpcGxlCiAgICogc2ltdWx0YW5lb3VzIG5vdGVzIChjaG9yZCkuIFlvdSBjYW4gZGVsYXkgdGhlIGV4ZWN1dGlvbiBvZiB0aGUgKipub3RlIG9mZioqIGNvbW1hbmQgYnkgdXNpbmcKICAgKiB0aGUgYHRpbWVgIHByb3BlcnR5IG9mIHRoZSBgb3B0aW9uc2AgcGFyYW1ldGVyIChpbiBtaWxsaXNlY29uZHMpLgogICAqCiAgICogQG1ldGhvZCBzdG9wTm90ZQogICAqIEBjaGFpbmFibGUKICAgKgogICAqIEBwYXJhbSBub3RlIHtOdW1iZXJ8QXJyYXl8U3RyaW5nfSAgVGhlIG5vdGUocykgeW91IHdpc2ggdG8gc3RvcC4gVGhlIG5vdGVzIGNhbiBiZSBzcGVjaWZpZWQgaW4KICAgKiBvbmUgb2YgdGhyZWUgd2F5cy4gVGhlIGZpcnN0IHdheSBpcyBieSB1c2luZyB0aGUgTUlESSBub3RlIG51bWJlciAoYW4gaW50ZWdlciBiZXR3ZWVuIGAwYCBhbmQKICAgKiBgMTI3YCkuIFRoZSBzZWNvbmQgd2F5IGlzIGJ5IHVzaW5nIHRoZSBub3RlIG5hbWUgZm9sbG93ZWQgYnkgdGhlIG9jdGF2ZSAoQzMsIEcjNCwgRi0xLCBEYjcpLgogICAqIFRoZSBvY3RhdmUgcmFuZ2Ugc2hvdWxkIGJlIGJldHdlZW4gLTIgYW5kIDguIFRoZSBsb3dlc3Qgbm90ZSBpcyBDLTIgKE1JREkgbm90ZSBudW1iZXIgMCkgYW5kCiAgICogdGhlIGhpZ2hlc3Qgbm90ZSBpcyBHOCAoTUlESSBub3RlIG51bWJlciAxMjcpLiBJdCBpcyBhbHNvIHBvc3NpYmxlIHRvIHNwZWNpZnkgYW4gYXJyYXkgb2Ygbm90ZQogICAqIG51bWJlcnMgYW5kL29yIG5hbWVzLiBUaGUgZmluYWwgd2F5IGlzIHRvIHVzZSB0aGUgc3BlY2lhbCB2YWx1ZSBgYWxsYCB0byBzZW5kIGFuICJhbGxub3Rlc29mZiIKICAgKiBjaGFubmVsIG1lc3NhZ2UuCiAgICoKICAgKiBAcGFyYW0gW2NoYW5uZWw9YWxsXSB7TnVtYmVyfEFycmF5fFN0cmluZ30gVGhlIE1JREkgY2hhbm5lbCBudW1iZXIgKGJldHdlZW4gYDFgIGFuZCBgMTZgKSBvciBhbgogICAqIGFycmF5IG9mIGNoYW5uZWwgbnVtYmVycy4gSWYgdGhlIHNwZWNpYWwgdmFsdWUgYGFsbGAgaXMgdXNlZCAoZGVmYXVsdCksIHRoZSBtZXNzYWdlIHdpbGwgYmUKICAgKiBzZW50IHRvIGFsbCAxNiBjaGFubmVscy4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucz17fV0KICAgKgogICAqIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMucmF3VmVsb2NpdHk9ZmFsc2VdIENvbnRyb2xzIHdoZXRoZXIgdGhlIHJlbGVhc2UgdmVsb2NpdHkgaXMgc2V0IHVzaW5nCiAgICogYW4gaW50ZWdlciBiZXR3ZWVuIGAwYCBhbmQgYDEyN2AgKGB0cnVlYCkgb3IgYSBkZWNpbWFsIG51bWJlciBiZXR3ZWVuIGAwYCBhbmQgYDFgIChgZmFsc2VgLAogICAqIGRlZmF1bHQpLgogICAqCiAgICogQHBhcmFtIHtET01IaWdoUmVzVGltZVN0YW1wfFN0cmluZ30gW29wdGlvbnMudGltZT11bmRlZmluZWRdIFRoaXMgdmFsdWUgY2FuIGJlIG9uZSBvZiB0d28KICAgKiB0aGluZ3MuIElmIHRoZSB2YWx1ZSBpcyBhIHN0cmluZyBzdGFydGluZyB3aXRoIHRoZSArIHNpZ24gYW5kIGZvbGxvd2VkIGJ5IGEgbnVtYmVyLCB0aGUgcmVxdWVzdAogICAqIHdpbGwgYmUgZGVsYXllZCBieSB0aGUgc3BlY2lmaWVkIG51bWJlciAoaW4gbWlsbGlzZWNvbmRzKS4gT3RoZXJ3aXNlLCB0aGUgdmFsdWUgaXMgY29uc2lkZXJlZCBhCiAgICogdGltZXN0YW1wIGFuZCB0aGUgcmVxdWVzdCB3aWxsIGJlIHNjaGVkdWxlZCBhdCB0aGF0IHRpbWVzdGFtcC4gVGhlIGBET01IaWdoUmVzVGltZVN0YW1wYCB2YWx1ZQogICAqIGlzIHJlbGF0aXZlIHRvIHRoZSBuYXZpZ2F0aW9uIHN0YXJ0IG9mIHRoZSBkb2N1bWVudC4gVG8gcmV0cmlldmUgdGhlIGN1cnJlbnQgdGltZSwgeW91IGNhbiB1c2UKICAgKiBgV2ViTWlkaS50aW1lYC4gSWYgYHRpbWVgIGlzIG5vdCBwcmVzZW50IG9yIGlzIHNldCB0byBhIHRpbWUgaW4gdGhlIHBhc3QsIHRoZSByZXF1ZXN0IGlzIHRvIGJlCiAgICogc2VudCBhcyBzb29uIGFzIHBvc3NpYmxlLgogICAqCiAgICogQHBhcmFtIHtOdW1iZXJ9IFtvcHRpb25zLnZlbG9jaXR5PTAuNV0gVGhlIHZlbG9jaXR5IGF0IHdoaWNoIHRvIHJlbGVhc2UgdGhlIG5vdGUgKGJldHdlZW4gYDBgCiAgICogYW5kIGAxYCkuIElmIHRoZSBgcmF3VmVsb2NpdHlgIG9wdGlvbiBpcyBgdHJ1ZWAsIHRoZSB2YWx1ZSBzaG91bGQgYmUgc3BlY2lmaWVkIGFzIGFuIGludGVnZXIKICAgKiBiZXR3ZWVuIGAwYCBhbmQgYDEyN2AuIEFuIGludmFsaWQgdmVsb2NpdHkgdmFsdWUgd2lsbCBzaWxlbnRseSB0cmlnZ2VyIHRoZSBkZWZhdWx0IG9mIGAwLjVgLgogICAqIE5vdGUgdGhhdCB3aGVuIHRoZSBmaXJzdCBwYXJhbWV0ZXIgdG8gYHN0b3BOb3RlKClgIGlzIGBhbGxgLCB0aGUgcmVsZWFzZSB2ZWxvY2l0eSBpcyBzaWxlbnRseQogICAqIGlnbm9yZWQuCiAgICoKICAgKiBAcmV0dXJuIHtPdXRwdXR9IFJldHVybnMgdGhlIGBPdXRwdXRgIG9iamVjdCBzbyBtZXRob2RzIGNhbiBiZSBjaGFpbmVkLgogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5zdG9wTm90ZSA9IGZ1bmN0aW9uIChub3RlLCBjaGFubmVsLCBvcHRpb25zKSB7CiAgICBpZiAobm90ZSA9PT0gImFsbCIpIHsKICAgICAgcmV0dXJuIHRoaXMuc2VuZENoYW5uZWxNb2RlKCJhbGxub3Rlc29mZiIsIDAsIGNoYW5uZWwsIG9wdGlvbnMpOwogICAgfQoKICAgIHZhciBuVmVsb2NpdHkgPSA2NDsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgIGlmIChvcHRpb25zLnJhd1ZlbG9jaXR5KSB7CiAgICAgIGlmICghaXNOYU4ob3B0aW9ucy52ZWxvY2l0eSkgJiYgb3B0aW9ucy52ZWxvY2l0eSA+PSAwICYmIG9wdGlvbnMudmVsb2NpdHkgPD0gMTI3KSB7CiAgICAgICAgblZlbG9jaXR5ID0gb3B0aW9ucy52ZWxvY2l0eTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKCFpc05hTihvcHRpb25zLnZlbG9jaXR5KSAmJiBvcHRpb25zLnZlbG9jaXR5ID49IDAgJiYgb3B0aW9ucy52ZWxvY2l0eSA8PSAxKSB7CiAgICAgICAgblZlbG9jaXR5ID0gb3B0aW9ucy52ZWxvY2l0eSAqIDEyNzsKICAgICAgfQogICAgfSAvLyBTZW5kIG5vdGUgb2ZmIG1lc3NhZ2VzCgoKICAgIHRoaXMuX2NvbnZlcnROb3RlVG9BcnJheShub3RlKS5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIHdtLnRvTUlESUNoYW5uZWxzKGNoYW5uZWwpLmZvckVhY2goZnVuY3Rpb24gKGNoKSB7CiAgICAgICAgdGhpcy5zZW5kKCh3bS5NSURJX0NIQU5ORUxfTUVTU0FHRVMubm90ZW9mZiA8PCA0KSArIChjaCAtIDEpLCBbaXRlbSwgTWF0aC5yb3VuZChuVmVsb2NpdHkpXSwgdGhpcy5fcGFyc2VUaW1lUGFyYW1ldGVyKG9wdGlvbnMudGltZSkpOwogICAgICB9LmJpbmQodGhpcykpOwogICAgfS5iaW5kKHRoaXMpKTsKCiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIFJlcXVlc3RzIHRoZSBwbGF5YmFjayBvZiBhIHNpbmdsZSBub3RlIG9yIG11bHRpcGxlIG5vdGVzIG9uIHRoZSBzcGVjaWZpZWQgY2hhbm5lbChzKS4gWW91IGNhbgogICAqIGRlbGF5IHRoZSBleGVjdXRpb24gb2YgdGhlICoqbm90ZSBvbioqIGNvbW1hbmQgYnkgdXNpbmcgdGhlIGB0aW1lYCBwcm9wZXJ0eSBvZiB0aGUgYG9wdGlvbnNgCiAgICogcGFyYW1ldGVyIChtaWxsaXNlY29uZHMpLgogICAqCiAgICogSWYgbm8gZHVyYXRpb24gaXMgc3BlY2lmaWVkIGluIHRoZSBgb3B0aW9uc2AsIHRoZSBub3RlIHdpbGwgcGxheSB1bnRpbCBhIG1hdGNoaW5nICoqbm90ZSBvZmYqKgogICAqIGlzIHNlbnQuIElmIGEgZHVyYXRpb24gaXMgc3BlY2lmaWVkLCBhICoqbm90ZSBvZmYqKiB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgc2VudCBhZnRlciBzYWlkCiAgICogZHVyYXRpb24uCiAgICoKICAgKiBOb3RlOiBBcyBwZXIgdGhlIE1JREkgc3RhbmRhcmQsIGEgKipub3RlIG9uKiogZXZlbnQgd2l0aCBhIHZlbG9jaXR5IG9mIGAwYCBpcyBjb25zaWRlcmVkIHRvIGJlCiAgICogYSAqKm5vdGUgb2ZmKiouCiAgICoKICAgKiBAbWV0aG9kIHBsYXlOb3RlCiAgICogQGNoYWluYWJsZQogICAqCiAgICogQHBhcmFtIG5vdGUge051bWJlcnxTdHJpbmd8QXJyYXl9ICBUaGUgbm90ZShzKSB5b3Ugd2lzaCB0byBwbGF5LiBUaGUgbm90ZXMgY2FuIGJlIHNwZWNpZmllZCBpbgogICAqIG9uZSBvZiB0d28gd2F5cy4gVGhlIGZpcnN0IHdheSBpcyBieSB1c2luZyB0aGUgTUlESSBub3RlIG51bWJlciAoYW4gaW50ZWdlciBiZXR3ZWVuIDAgYW5kIDEyNykuCiAgICogVGhlIHNlY29uZCB3YXkgaXMgYnkgdXNpbmcgdGhlIG5vdGUgbmFtZSBmb2xsb3dlZCBieSB0aGUgb2N0YXZlIChDMywgRyM0LCBGLTEsIERiNykuIFRoZSBvY3RhdmUKICAgKiByYW5nZSBzaG91bGQgYmUgYmV0d2VlbiAtMiBhbmQgOC4gVGhlIGxvd2VzdCBub3RlIGlzIEMtMiAoTUlESSBub3RlIG51bWJlciAwKSBhbmQgdGhlIGhpZ2hlc3QKICAgKiBub3RlIGlzIEc4IChNSURJIG5vdGUgbnVtYmVyIDEyNykuIEl0IGlzIGFsc28gcG9zc2libGUgdG8gc3BlY2lmeSBhbiBhcnJheSBvZiBub3RlIG51bWJlcnMKICAgKiBhbmQvb3IgbmFtZXMuCiAgICoKICAgKiBAcGFyYW0gW2NoYW5uZWw9YWxsXSB7TnVtYmVyfEFycmF5fFN0cmluZ30gVGhlIE1JREkgY2hhbm5lbCBudW1iZXIgKGJldHdlZW4gYDFgIGFuZCBgMTZgKSBvciBhbgogICAqIGFycmF5IG9mIGNoYW5uZWwgbnVtYmVycy4gSWYgdGhlIHNwZWNpYWwgdmFsdWUgKiphbGwqKiBpcyB1c2VkIChkZWZhdWx0KSwgdGhlIG1lc3NhZ2Ugd2lsbCBiZQogICAqIHNlbnQgdG8gYWxsIDE2IGNoYW5uZWxzLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zPXt9XQogICAqCiAgICogQHBhcmFtIHtOdW1iZXJ9IFtvcHRpb25zLmR1cmF0aW9uPXVuZGVmaW5lZF0gVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgKGludGVnZXIpIHRvIHdhaXQKICAgKiBiZWZvcmUgc2VuZGluZyBhIG1hdGNoaW5nICoqbm90ZSBvZmYqKiBldmVudC4gSWYgbGVmdCB1bmRlZmluZWQsIG9ubHkgYSAqKm5vdGUgb24qKiBtZXNzYWdlIGlzCiAgICogc2VudC4KICAgKgogICAqIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMucmF3VmVsb2NpdHk9ZmFsc2VdIENvbnRyb2xzIHdoZXRoZXIgdGhlIGF0dGFjayBhbmQgcmVsZWFzZSB2ZWxvY2l0aWVzCiAgICogYXJlIHNldCB1c2luZyBpbnRlZ2VycyBiZXR3ZWVuIGAwYCBhbmQgYDEyN2AgKGB0cnVlYCkgb3IgYSBkZWNpbWFsIG51bWJlciBiZXR3ZWVuIGAwYCBhbmQgYDFgCiAgICogKGBmYWxzZWAsIGRlZmF1bHQpLgogICAqCiAgICogQHBhcmFtIHtOdW1iZXJ9IFtvcHRpb25zLnJlbGVhc2U9MC41XSBUaGUgdmVsb2NpdHkgYXQgd2hpY2ggdG8gcmVsZWFzZSB0aGUgbm90ZSAoYmV0d2VlbiBgMGAKICAgKiBhbmQgYDFgKS4gSWYgdGhlIGByYXdWZWxvY2l0eWAgb3B0aW9uIGlzIGB0cnVlYCwgdGhlIHZhbHVlIHNob3VsZCBiZSBzcGVjaWZpZWQgYXMgYW4gaW50ZWdlcgogICAqIGJldHdlZW4gYDBgIGFuZCBgMTI3YC4gQW4gaW52YWxpZCB2ZWxvY2l0eSB2YWx1ZSB3aWxsIHNpbGVudGx5IHRyaWdnZXIgdGhlIGRlZmF1bHQgb2YgYDAuNWAuCiAgICogVGhpcyBpcyBvbmx5IHVzZWQgd2l0aCB0aGUgKipub3RlIG9mZioqIGV2ZW50IHRyaWdnZXJlZCB3aGVuIGBvcHRpb25zLmR1cmF0aW9uYCBpcyBzZXQuCiAgICoKICAgKiBAcGFyYW0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB8U3RyaW5nfSBbb3B0aW9ucy50aW1lPXVuZGVmaW5lZF0gVGhpcyB2YWx1ZSBjYW4gYmUgb25lIG9mIHR3bwogICAqIHRoaW5ncy4gSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHN0YXJ0aW5nIHdpdGggdGhlICsgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsIHRoZSByZXF1ZXN0CiAgICogd2lsbCBiZSBkZWxheWVkIGJ5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIChpbiBtaWxsaXNlY29uZHMpLiBPdGhlcndpc2UsIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEKICAgKiB0aW1lc3RhbXAgYW5kIHRoZSByZXF1ZXN0IHdpbGwgYmUgc2NoZWR1bGVkIGF0IHRoYXQgdGltZXN0YW1wLiBUaGUgYERPTUhpZ2hSZXNUaW1lU3RhbXBgIHZhbHVlCiAgICogaXMgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LiBUbyByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lLCB5b3UgY2FuIHVzZQogICAqIGBXZWJNaWRpLnRpbWVgLiBJZiBgdGltZWAgaXMgbm90IHByZXNlbnQgb3IgaXMgc2V0IHRvIGEgdGltZSBpbiB0aGUgcGFzdCwgdGhlIHJlcXVlc3QgaXMgdG8gYmUKICAgKiBzZW50IGFzIHNvb24gYXMgcG9zc2libGUuCiAgICoKICAgKiBAcGFyYW0ge051bWJlcn0gW29wdGlvbnMudmVsb2NpdHk9MC41XSBUaGUgdmVsb2NpdHkgYXQgd2hpY2ggdG8gcGxheSB0aGUgbm90ZSAoYmV0d2VlbiBgMGAgYW5kCiAgICogYDFgKS4gSWYgdGhlIGByYXdWZWxvY2l0eWAgb3B0aW9uIGlzIGB0cnVlYCwgdGhlIHZhbHVlIHNob3VsZCBiZSBzcGVjaWZpZWQgYXMgYW4gaW50ZWdlcgogICAqIGJldHdlZW4gYDBgIGFuZCBgMTI3YC4gQW4gaW52YWxpZCB2ZWxvY2l0eSB2YWx1ZSB3aWxsIHNpbGVudGx5IHRyaWdnZXIgdGhlIGRlZmF1bHQgb2YgYDAuNWAuCiAgICoKICAgKiBAcmV0dXJuIHtPdXRwdXR9IFJldHVybnMgdGhlIGBPdXRwdXRgIG9iamVjdCBzbyBtZXRob2RzIGNhbiBiZSBjaGFpbmVkLgogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5wbGF5Tm90ZSA9IGZ1bmN0aW9uIChub3RlLCBjaGFubmVsLCBvcHRpb25zKSB7CiAgICB2YXIgdGltZSwKICAgICAgICBuVmVsb2NpdHkgPSA2NDsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgIGlmIChvcHRpb25zLnJhd1ZlbG9jaXR5KSB7CiAgICAgIGlmICghaXNOYU4ob3B0aW9ucy52ZWxvY2l0eSkgJiYgb3B0aW9ucy52ZWxvY2l0eSA+PSAwICYmIG9wdGlvbnMudmVsb2NpdHkgPD0gMTI3KSB7CiAgICAgICAgblZlbG9jaXR5ID0gb3B0aW9ucy52ZWxvY2l0eTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKCFpc05hTihvcHRpb25zLnZlbG9jaXR5KSAmJiBvcHRpb25zLnZlbG9jaXR5ID49IDAgJiYgb3B0aW9ucy52ZWxvY2l0eSA8PSAxKSB7CiAgICAgICAgblZlbG9jaXR5ID0gb3B0aW9ucy52ZWxvY2l0eSAqIDEyNzsKICAgICAgfQogICAgfQoKICAgIHRpbWUgPSB0aGlzLl9wYXJzZVRpbWVQYXJhbWV0ZXIob3B0aW9ucy50aW1lKTsgLy8gU2VuZCBub3RlIG9uIG1lc3NhZ2VzCgogICAgdGhpcy5fY29udmVydE5vdGVUb0FycmF5KG5vdGUpLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgd20udG9NSURJQ2hhbm5lbHMoY2hhbm5lbCkuZm9yRWFjaChmdW5jdGlvbiAoY2gpIHsKICAgICAgICB0aGlzLnNlbmQoKHdtLk1JRElfQ0hBTk5FTF9NRVNTQUdFUy5ub3Rlb24gPDwgNCkgKyAoY2ggLSAxKSwgW2l0ZW0sIE1hdGgucm91bmQoblZlbG9jaXR5KV0sIHRpbWUpOwogICAgICB9LmJpbmQodGhpcykpOwogICAgfS5iaW5kKHRoaXMpKTsgLy8gU2VuZCBub3RlIG9mZiBtZXNzYWdlcyAob25seSBpZiBhIHZhbGlkIGR1cmF0aW9uIGhhcyBiZWVuIGRlZmluZWQpCgoKICAgIGlmICghaXNOYU4ob3B0aW9ucy5kdXJhdGlvbikpIHsKICAgICAgaWYgKG9wdGlvbnMuZHVyYXRpb24gPD0gMCkgewogICAgICAgIG9wdGlvbnMuZHVyYXRpb24gPSAwOwogICAgICB9CgogICAgICB2YXIgblJlbGVhc2UgPSA2NDsKCiAgICAgIGlmIChvcHRpb25zLnJhd1ZlbG9jaXR5KSB7CiAgICAgICAgaWYgKCFpc05hTihvcHRpb25zLnJlbGVhc2UpICYmIG9wdGlvbnMucmVsZWFzZSA+PSAwICYmIG9wdGlvbnMucmVsZWFzZSA8PSAxMjcpIHsKICAgICAgICAgIG5SZWxlYXNlID0gb3B0aW9ucy5yZWxlYXNlOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoIWlzTmFOKG9wdGlvbnMucmVsZWFzZSkgJiYgb3B0aW9ucy5yZWxlYXNlID49IDAgJiYgb3B0aW9ucy5yZWxlYXNlIDw9IDEpIHsKICAgICAgICAgIG5SZWxlYXNlID0gb3B0aW9ucy5yZWxlYXNlICogMTI3OwogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy5fY29udmVydE5vdGVUb0FycmF5KG5vdGUpLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICB3bS50b01JRElDaGFubmVscyhjaGFubmVsKS5mb3JFYWNoKGZ1bmN0aW9uIChjaCkgewogICAgICAgICAgdGhpcy5zZW5kKCh3bS5NSURJX0NIQU5ORUxfTUVTU0FHRVMubm90ZW9mZiA8PCA0KSArIChjaCAtIDEpLCBbaXRlbSwgTWF0aC5yb3VuZChuUmVsZWFzZSldLCAodGltZSB8fCB3bS50aW1lKSArIG9wdGlvbnMuZHVyYXRpb24pOwogICAgICAgIH0uYmluZCh0aGlzKSk7CiAgICAgIH0uYmluZCh0aGlzKSk7CiAgICB9CgogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBTZW5kcyBhIE1JREkgYGtleSBhZnRlcnRvdWNoYCBtZXNzYWdlIHRvIHRoZSBzcGVjaWZpZWQgY2hhbm5lbChzKSBhdCB0aGUgc2NoZWR1bGVkIHRpbWUuIFRoaXMKICAgKiBpcyBhIGtleS1zcGVjaWZpYyBhZnRlcnRvdWNoLiBGb3IgYSBjaGFubmVsLXdpZGUgYWZ0ZXJ0b3VjaCBtZXNzYWdlLCB1c2UKICAgKiB7eyNjcm9zc0xpbmsgIldlYk1pZGkvc2VuZENoYW5uZWxBZnRlcnRvdWNoOm1ldGhvZCJ9fXNlbmRDaGFubmVsQWZ0ZXJ0b3VjaCgpe3svY3Jvc3NMaW5rfX0uCiAgICoKICAgKiBAbWV0aG9kIHNlbmRLZXlBZnRlcnRvdWNoCiAgICogQGNoYWluYWJsZQogICAqCiAgICogQHBhcmFtIG5vdGUge051bWJlcnxTdHJpbmd8QXJyYXl9ICBUaGUgbm90ZSBmb3Igd2hpY2ggeW91IGFyZSBzZW5kaW5nIGFuIGFmdGVydG91Y2ggdmFsdWUuIFRoZQogICAqIG5vdGVzIGNhbiBiZSBzcGVjaWZpZWQgaW4gb25lIG9mIHR3byB3YXlzLiBUaGUgZmlyc3Qgd2F5IGlzIGJ5IHVzaW5nIHRoZSBNSURJIG5vdGUgbnVtYmVyIChhbgogICAqIGludGVnZXIgYmV0d2VlbiAwIGFuZCAxMjcpLiBUaGUgc2Vjb25kIHdheSBpcyBieSB1c2luZyB0aGUgbm90ZSBuYW1lIGZvbGxvd2VkIGJ5IHRoZSBvY3RhdmUKICAgKiAoQzMsIEcjNCwgRi0xLCBEYjcpLiBUaGUgb2N0YXZlIHJhbmdlIHNob3VsZCBiZSBiZXR3ZWVuIC0yIGFuZCA4LiBUaGUgbG93ZXN0IG5vdGUgaXMgQy0yIChNSURJCiAgICogbm90ZSBudW1iZXIgMCkgYW5kIHRoZSBoaWdoZXN0IG5vdGUgaXMgRzggKE1JREkgbm90ZSBudW1iZXIgMTI3KS4gSXQgaXMgYWxzbyBwb3NzaWJsZSB0byB1c2UKICAgKiBhbiBhcnJheSBvZiBub3RlIG5hbWVzIGFuZC9vciBudW1iZXJzLgogICAqCiAgICogQHBhcmFtIFtjaGFubmVsPWFsbF0ge051bWJlcnxBcnJheXxTdHJpbmd9IFRoZSBNSURJIGNoYW5uZWwgbnVtYmVyIChiZXR3ZWVuIDEgYW5kIDE2KSBvciBhbgogICAqIGFycmF5IG9mIGNoYW5uZWwgbnVtYmVycy4gSWYgdGhlIHNwZWNpYWwgdmFsdWUgImFsbCIgaXMgdXNlZCwgdGhlIG1lc3NhZ2Ugd2lsbCBiZSBzZW50IHRvIGFsbAogICAqIDE2IGNoYW5uZWxzLgogICAqCiAgICogQHBhcmFtIHtOdW1iZXJ9IFtwcmVzc3VyZT0wLjVdIFRoZSBwcmVzc3VyZSBsZXZlbCB0byBzZW5kIChiZXR3ZWVuIDAgYW5kIDEpLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zPXt9XQogICAqCiAgICogQHBhcmFtIHtET01IaWdoUmVzVGltZVN0YW1wfFN0cmluZ30gW29wdGlvbnMudGltZT11bmRlZmluZWRdIFRoaXMgdmFsdWUgY2FuIGJlIG9uZSBvZiB0d28KICAgKiB0aGluZ3MuIElmIHRoZSB2YWx1ZSBpcyBhIHN0cmluZyBzdGFydGluZyB3aXRoIHRoZSArIHNpZ24gYW5kIGZvbGxvd2VkIGJ5IGEgbnVtYmVyLCB0aGUgcmVxdWVzdAogICAqIHdpbGwgYmUgZGVsYXllZCBieSB0aGUgc3BlY2lmaWVkIG51bWJlciAoaW4gbWlsbGlzZWNvbmRzKS4gT3RoZXJ3aXNlLCB0aGUgdmFsdWUgaXMgY29uc2lkZXJlZCBhCiAgICogdGltZXN0YW1wIGFuZCB0aGUgcmVxdWVzdCB3aWxsIGJlIHNjaGVkdWxlZCBhdCB0aGF0IHRpbWVzdGFtcC4gVGhlIGBET01IaWdoUmVzVGltZVN0YW1wYCB2YWx1ZQogICAqIGlzIHJlbGF0aXZlIHRvIHRoZSBuYXZpZ2F0aW9uIHN0YXJ0IG9mIHRoZSBkb2N1bWVudC4gVG8gcmV0cmlldmUgdGhlIGN1cnJlbnQgdGltZSwgeW91IGNhbiB1c2UKICAgKiBgV2ViTWlkaS50aW1lYC4gSWYgYHRpbWVgIGlzIG5vdCBwcmVzZW50IG9yIGlzIHNldCB0byBhIHRpbWUgaW4gdGhlIHBhc3QsIHRoZSByZXF1ZXN0IGlzIHRvIGJlCiAgICogc2VudCBhcyBzb29uIGFzIHBvc3NpYmxlLgogICAqCiAgICogQHRocm93cyB7UmFuZ2VFcnJvcn0gVGhlIGNoYW5uZWwgbXVzdCBiZSBiZXR3ZWVuIDEgYW5kIDE2LgogICAqCiAgICogQHJldHVybiB7T3V0cHV0fSBSZXR1cm5zIHRoZSBgT3V0cHV0YCBvYmplY3Qgc28gbWV0aG9kcyBjYW4gYmUgY2hhaW5lZC4KICAgKi8KCgogIE91dHB1dC5wcm90b3R5cGUuc2VuZEtleUFmdGVydG91Y2ggPSBmdW5jdGlvbiAobm90ZSwgY2hhbm5lbCwgcHJlc3N1cmUsIG9wdGlvbnMpIHsKICAgIHZhciB0aGF0ID0gdGhpczsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgIGlmIChjaGFubmVsIDwgMSB8fCBjaGFubmVsID4gMTYpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIlRoZSBjaGFubmVsIG11c3QgYmUgYmV0d2VlbiAxIGFuZCAxNi4iKTsKICAgIH0KCiAgICBpZiAoaXNOYU4ocHJlc3N1cmUpIHx8IHByZXNzdXJlIDwgMCB8fCBwcmVzc3VyZSA+IDEpIHsKICAgICAgcHJlc3N1cmUgPSAwLjU7CiAgICB9CgogICAgdmFyIG5QcmVzc3VyZSA9IE1hdGgucm91bmQocHJlc3N1cmUgKiAxMjcpOwoKICAgIHRoaXMuX2NvbnZlcnROb3RlVG9BcnJheShub3RlKS5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIHdtLnRvTUlESUNoYW5uZWxzKGNoYW5uZWwpLmZvckVhY2goZnVuY3Rpb24gKGNoKSB7CiAgICAgICAgdGhhdC5zZW5kKCh3bS5NSURJX0NIQU5ORUxfTUVTU0FHRVMua2V5YWZ0ZXJ0b3VjaCA8PCA0KSArIChjaCAtIDEpLCBbaXRlbSwgblByZXNzdXJlXSwgdGhhdC5fcGFyc2VUaW1lUGFyYW1ldGVyKG9wdGlvbnMudGltZSkpOwogICAgICB9KTsKICAgIH0pOwoKICAgIHJldHVybiB0aGlzOwogIH07CiAgLyoqCiAgICogU2VuZHMgYSBNSURJIGBjb250cm9sIGNoYW5nZWAgbWVzc2FnZSAoYS5rLmEuIENDIG1lc3NhZ2UpIHRvIHRoZSBzcGVjaWZpZWQgY2hhbm5lbChzKSBhdCB0aGUKICAgKiBzY2hlZHVsZWQgdGltZS4gVGhlIGNvbnRyb2wgY2hhbmdlIG1lc3NhZ2UgdG8gc2VuZCBjYW4gYmUgc3BlY2lmaWVkIG51bWVyaWNhbGx5IG9yIGJ5IHVzaW5nIG9uZQogICAqIG9mIHRoZSBmb2xsb3dpbmcgY29tbW9uIG5hbWVzOgogICAqCiAgICogICogYGJhbmtzZWxlY3Rjb2Fyc2VgICgjMCkKICAgKiAgKiBgbW9kdWxhdGlvbndoZWVsY29hcnNlYCAoIzEpCiAgICogICogYGJyZWF0aGNvbnRyb2xsZXJjb2Fyc2VgICgjMikKICAgKiAgKiBgZm9vdGNvbnRyb2xsZXJjb2Fyc2VgICgjNCkKICAgKiAgKiBgcG9ydGFtZW50b3RpbWVjb2Fyc2VgICgjNSkKICAgKiAgKiBgZGF0YWVudHJ5Y29hcnNlYCAoIzYpCiAgICogICogYHZvbHVtZWNvYXJzZWAgKCM3KQogICAqICAqIGBiYWxhbmNlY29hcnNlYCAoIzgpCiAgICogICogYHBhbmNvYXJzZWAgKCMxMCkKICAgKiAgKiBgZXhwcmVzc2lvbmNvYXJzZWAgKCMxMSkKICAgKiAgKiBgZWZmZWN0Y29udHJvbDFjb2Fyc2VgICgjMTIpCiAgICogICogYGVmZmVjdGNvbnRyb2wyY29hcnNlYCAoIzEzKQogICAqICAqIGBnZW5lcmFscHVycG9zZXNsaWRlcjFgICgjMTYpCiAgICogICogYGdlbmVyYWxwdXJwb3Nlc2xpZGVyMmAgKCMxNykKICAgKiAgKiBgZ2VuZXJhbHB1cnBvc2VzbGlkZXIzYCAoIzE4KQogICAqICAqIGBnZW5lcmFscHVycG9zZXNsaWRlcjRgICgjMTkpCiAgICogICogYGJhbmtzZWxlY3RmaW5lYCAoIzMyKQogICAqICAqIGBtb2R1bGF0aW9ud2hlZWxmaW5lYCAoIzMzKQogICAqICAqIGBicmVhdGhjb250cm9sbGVyZmluZWAgKCMzNCkKICAgKiAgKiBgZm9vdGNvbnRyb2xsZXJmaW5lYCAoIzM2KQogICAqICAqIGBwb3J0YW1lbnRvdGltZWZpbmVgICgjMzcpCiAgICogICogYGRhdGFlbnRyeWZpbmVgICgjMzgpCiAgICogICogYHZvbHVtZWZpbmVgICgjMzkpCiAgICogICogYGJhbGFuY2VmaW5lYCAoIzQwKQogICAqICAqIGBwYW5maW5lYCAoIzQyKQogICAqICAqIGBleHByZXNzaW9uZmluZWAgKCM0MykKICAgKiAgKiBgZWZmZWN0Y29udHJvbDFmaW5lYCAoIzQ0KQogICAqICAqIGBlZmZlY3Rjb250cm9sMmZpbmVgICgjNDUpCiAgICogICogYGhvbGRwZWRhbGAgKCM2NCkKICAgKiAgKiBgcG9ydGFtZW50b2AgKCM2NSkKICAgKiAgKiBgc3VzdGVudXRvcGVkYWxgICgjNjYpCiAgICogICogYHNvZnRwZWRhbGAgKCM2NykKICAgKiAgKiBgbGVnYXRvcGVkYWxgICgjNjgpCiAgICogICogYGhvbGQycGVkYWxgICgjNjkpCiAgICogICogYHNvdW5kdmFyaWF0aW9uYCAoIzcwKQogICAqICAqIGByZXNvbmFuY2VgICgjNzEpCiAgICogICogYHNvdW5kcmVsZWFzZXRpbWVgICgjNzIpCiAgICogICogYHNvdW5kYXR0YWNrdGltZWAgKCM3MykKICAgKiAgKiBgYnJpZ2h0bmVzc2AgKCM3NCkKICAgKiAgKiBgc291bmRjb250cm9sNmAgKCM3NSkKICAgKiAgKiBgc291bmRjb250cm9sN2AgKCM3NikKICAgKiAgKiBgc291bmRjb250cm9sOGAgKCM3NykKICAgKiAgKiBgc291bmRjb250cm9sOWAgKCM3OCkKICAgKiAgKiBgc291bmRjb250cm9sMTBgICgjNzkpCiAgICogICogYGdlbmVyYWxwdXJwb3NlYnV0dG9uMWAgKCM4MCkKICAgKiAgKiBgZ2VuZXJhbHB1cnBvc2VidXR0b24yYCAoIzgxKQogICAqICAqIGBnZW5lcmFscHVycG9zZWJ1dHRvbjNgICgjODIpCiAgICogICogYGdlbmVyYWxwdXJwb3NlYnV0dG9uNGAgKCM4MykKICAgKiAgKiBgcmV2ZXJibGV2ZWxgICgjOTEpCiAgICogICogYHRyZW1vbG9sZXZlbGAgKCM5MikKICAgKiAgKiBgY2hvcnVzbGV2ZWxgICgjOTMpCiAgICogICogYGNlbGVzdGVsZXZlbGAgKCM5NCkKICAgKiAgKiBgcGhhc2VybGV2ZWxgICgjOTUpCiAgICogICogYGRhdGFidXR0b25pbmNyZW1lbnRgICgjOTYpCiAgICogICogYGRhdGFidXR0b25kZWNyZW1lbnRgICgjOTcpCiAgICogICogYG5vbnJlZ2lzdGVyZWRwYXJhbWV0ZXJjb2Fyc2VgICgjOTgpCiAgICogICogYG5vbnJlZ2lzdGVyZWRwYXJhbWV0ZXJmaW5lYCAoIzk5KQogICAqICAqIGByZWdpc3RlcmVkcGFyYW1ldGVyY29hcnNlYCAoIzEwMCkKICAgKiAgKiBgcmVnaXN0ZXJlZHBhcmFtZXRlcmZpbmVgICgjMTAxKQogICAqCiAgICogTm90ZTogYXMgeW91IGNhbiBzZWUgYWJvdmUsIG5vdCBhbGwgY29udHJvbCBjaGFuZ2UgbWVzc2FnZSBoYXZlIGEgbWF0Y2hpbmcgY29tbW9uIG5hbWUuIFRoaXMKICAgKiBkb2VzIG5vdCBtZWFuIHlvdSBjYW5ub3QgdXNlIHRoZSBvdGhlcnMuIEl0IHNpbXBseSBtZWFucyB5b3Ugd2lsbCBuZWVkIHRvIHVzZSB0aGVpciBudW1iZXIKICAgKiBpbnN0ZWFkIG9mIHRoZWlyIG5hbWUuCiAgICoKICAgKiBUbyB2aWV3IGEgbGlzdCBvZiBhbGwgYXZhaWxhYmxlIGBjb250cm9sIGNoYW5nZWAgbWVzc2FnZXMsIHBsZWFzZSBjb25zdWx0ICJUYWJsZSAzIC0gQ29udHJvbAogICAqIENoYW5nZSBNZXNzYWdlcyIgZnJvbSB0aGUgW01JREkgTWVzc2FnZXNdKAogICAqIGh0dHBzOi8vd3d3Lm1pZGkub3JnL3NwZWNpZmljYXRpb25zL2l0ZW0vdGFibGUtMy1jb250cm9sLWNoYW5nZS1tZXNzYWdlcy1kYXRhLWJ5dGVzLTIpCiAgICogc3BlY2lmaWNhdGlvbi4KICAgKgogICAqIEBtZXRob2Qgc2VuZENvbnRyb2xDaGFuZ2UKICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0gY29udHJvbGxlciB7TnVtYmVyfFN0cmluZ30gVGhlIE1JREkgY29udHJvbGxlciBudW1iZXIgKDAtMTE5KSBvciBuYW1lLgogICAqCiAgICogQHBhcmFtIFt2YWx1ZT0wXSB7TnVtYmVyfSBUaGUgdmFsdWUgdG8gc2VuZCAoMC0xMjcpLgogICAqCiAgICogQHBhcmFtIFtjaGFubmVsPWFsbF0ge051bWJlcnxBcnJheXxTdHJpbmd9IFRoZSBNSURJIGNoYW5uZWwgbnVtYmVyIChiZXR3ZWVuIDEgYW5kIDE2KSBvciBhbgogICAqIGFycmF5IG9mIGNoYW5uZWwgbnVtYmVycy4gSWYgdGhlIHNwZWNpYWwgdmFsdWUgImFsbCIgaXMgdXNlZCwgdGhlIG1lc3NhZ2Ugd2lsbCBiZSBzZW50IHRvIGFsbAogICAqIDE2IGNoYW5uZWxzLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zPXt9XQogICAqCiAgICogQHBhcmFtIHtET01IaWdoUmVzVGltZVN0YW1wfFN0cmluZ30gW29wdGlvbnMudGltZT11bmRlZmluZWRdIFRoaXMgdmFsdWUgY2FuIGJlIG9uZSBvZiB0d28KICAgKiB0aGluZ3MuIElmIHRoZSB2YWx1ZSBpcyBhIHN0cmluZyBzdGFydGluZyB3aXRoIHRoZSArIHNpZ24gYW5kIGZvbGxvd2VkIGJ5IGEgbnVtYmVyLCB0aGUgcmVxdWVzdAogICAqIHdpbGwgYmUgZGVsYXllZCBieSB0aGUgc3BlY2lmaWVkIG51bWJlciAoaW4gbWlsbGlzZWNvbmRzKS4gT3RoZXJ3aXNlLCB0aGUgdmFsdWUgaXMgY29uc2lkZXJlZCBhCiAgICogdGltZXN0YW1wIGFuZCB0aGUgcmVxdWVzdCB3aWxsIGJlIHNjaGVkdWxlZCBhdCB0aGF0IHRpbWVzdGFtcC4gVGhlIGBET01IaWdoUmVzVGltZVN0YW1wYCB2YWx1ZQogICAqIGlzIHJlbGF0aXZlIHRvIHRoZSBuYXZpZ2F0aW9uIHN0YXJ0IG9mIHRoZSBkb2N1bWVudC4gVG8gcmV0cmlldmUgdGhlIGN1cnJlbnQgdGltZSwgeW91IGNhbiB1c2UKICAgKiBgV2ViTWlkaS50aW1lYC4gSWYgYHRpbWVgIGlzIG5vdCBwcmVzZW50IG9yIGlzIHNldCB0byBhIHRpbWUgaW4gdGhlIHBhc3QsIHRoZSByZXF1ZXN0IGlzIHRvIGJlCiAgICogc2VudCBhcyBzb29uIGFzIHBvc3NpYmxlLgogICAqCiAgICogQHRocm93cyB7UmFuZ2VFcnJvcn0gQ29udHJvbGxlciBudW1iZXJzIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxMTkuCiAgICogQHRocm93cyB7UmFuZ2VFcnJvcn0gVmFsdWUgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDEyNy4KICAgKgogICAqIEByZXR1cm4ge091dHB1dH0gUmV0dXJucyB0aGUgYE91dHB1dGAgb2JqZWN0IHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICovCgoKICBPdXRwdXQucHJvdG90eXBlLnNlbmRDb250cm9sQ2hhbmdlID0gZnVuY3Rpb24gKGNvbnRyb2xsZXIsIHZhbHVlLCBjaGFubmVsLCBvcHRpb25zKSB7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICBpZiAodHlwZW9mIGNvbnRyb2xsZXIgPT09ICJzdHJpbmciKSB7CiAgICAgIGNvbnRyb2xsZXIgPSB3bS5NSURJX0NPTlRST0xfQ0hBTkdFX01FU1NBR0VTW2NvbnRyb2xsZXJdOwogICAgICBpZiAoY29udHJvbGxlciA9PT0gdW5kZWZpbmVkKSB0aHJvdyBuZXcgVHlwZUVycm9yKCJJbnZhbGlkIGNvbnRyb2xsZXIgbmFtZS4iKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnRyb2xsZXIgPSBNYXRoLmZsb29yKGNvbnRyb2xsZXIpOwoKICAgICAgaWYgKCEoY29udHJvbGxlciA+PSAwICYmIGNvbnRyb2xsZXIgPD0gMTE5KSkgewogICAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJDb250cm9sbGVyIG51bWJlcnMgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDExOS4iKTsKICAgICAgfQogICAgfQoKICAgIHZhbHVlID0gTWF0aC5mbG9vcih2YWx1ZSkgfHwgMDsKCiAgICBpZiAoISh2YWx1ZSA+PSAwICYmIHZhbHVlIDw9IDEyNykpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIkNvbnRyb2xsZXIgdmFsdWUgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDEyNy4iKTsKICAgIH0KCiAgICB3bS50b01JRElDaGFubmVscyhjaGFubmVsKS5mb3JFYWNoKGZ1bmN0aW9uIChjaCkgewogICAgICB0aGlzLnNlbmQoKHdtLk1JRElfQ0hBTk5FTF9NRVNTQUdFUy5jb250cm9sY2hhbmdlIDw8IDQpICsgKGNoIC0gMSksIFtjb250cm9sbGVyLCB2YWx1ZV0sIHRoaXMuX3BhcnNlVGltZVBhcmFtZXRlcihvcHRpb25zLnRpbWUpKTsKICAgIH0uYmluZCh0aGlzKSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIFNlbGVjdHMgYSBNSURJIHJlZ2lzdGVyZWQgcGFyYW1ldGVyIHNvIGl0IGlzIGFmZmVjdGVkIGJ5IGRhdGEgZW50cnksIGRhdGEgaW5jcmVtZW50IGFuZCBkYXRhCiAgICogZGVjcmVtZW50IG1lc3NhZ2VzLgogICAqCiAgICogQG1ldGhvZCBfc2VsZWN0UmVnaXN0ZXJlZFBhcmFtZXRlcgogICAqIEBwcm90ZWN0ZWQKICAgKgogICAqIEBwYXJhbSBwYXJhbWV0ZXIge0FycmF5fSBBIHR3by1wb3NpdGlvbiBhcnJheSBzcGVjaWZ5aW5nIHRoZSB0d28gY29udHJvbCBieXRlcyAoMHg2NSwgMHg2NCkKICAgKiB0aGF0IGlkZW50aWZ5IHRoZSByZWdpc3RlcmVkIHBhcmFtZXRlci4KICAgKiBAcGFyYW0gY2hhbm5lbAogICAqIEBwYXJhbSB0aW1lCiAgICoKICAgKiBAcmV0dXJucyB7T3V0cHV0fQogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5fc2VsZWN0UmVnaXN0ZXJlZFBhcmFtZXRlciA9IGZ1bmN0aW9uIChwYXJhbWV0ZXIsIGNoYW5uZWwsIHRpbWUpIHsKICAgIHZhciB0aGF0ID0gdGhpczsKICAgIHBhcmFtZXRlclswXSA9IE1hdGguZmxvb3IocGFyYW1ldGVyWzBdKTsKCiAgICBpZiAoIShwYXJhbWV0ZXJbMF0gPj0gMCAmJiBwYXJhbWV0ZXJbMF0gPD0gMTI3KSkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigiVGhlIGNvbnRyb2w2NSB2YWx1ZSBtdXN0IGJlIGJldHdlZW4gMCBhbmQgMTI3Iik7CiAgICB9CgogICAgcGFyYW1ldGVyWzFdID0gTWF0aC5mbG9vcihwYXJhbWV0ZXJbMV0pOwoKICAgIGlmICghKHBhcmFtZXRlclsxXSA+PSAwICYmIHBhcmFtZXRlclsxXSA8PSAxMjcpKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJUaGUgY29udHJvbDY0IHZhbHVlIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxMjciKTsKICAgIH0KCiAgICB3bS50b01JRElDaGFubmVscyhjaGFubmVsKS5mb3JFYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgdGhhdC5zZW5kQ29udHJvbENoYW5nZSgweDY1LCBwYXJhbWV0ZXJbMF0sIGNoYW5uZWwsIHsKICAgICAgICB0aW1lOiB0aW1lCiAgICAgIH0pOwogICAgICB0aGF0LnNlbmRDb250cm9sQ2hhbmdlKDB4NjQsIHBhcmFtZXRlclsxXSwgY2hhbm5lbCwgewogICAgICAgIHRpbWU6IHRpbWUKICAgICAgfSk7CiAgICB9KTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgLyoqCiAgICogU2VsZWN0cyBhIE1JREkgbm9uLXJlZ2lzdGVyZWQgcGFyYW1ldGVyIHNvIGl0IGlzIGFmZmVjdGVkIGJ5IGRhdGEgZW50cnksIGRhdGEgaW5jcmVtZW50IGFuZAogICAqIGRhdGEgZGVjcmVtZW50IG1lc3NhZ2VzLgogICAqCiAgICogQG1ldGhvZCBfc2VsZWN0Tm9uUmVnaXN0ZXJlZFBhcmFtZXRlcgogICAqIEBwcm90ZWN0ZWQKICAgKgogICAqIEBwYXJhbSBwYXJhbWV0ZXIge0FycmF5fSBBIHR3by1wb3NpdGlvbiBhcnJheSBzcGVjaWZ5aW5nIHRoZSB0d28gY29udHJvbCBieXRlcyAoMHg2MywgMHg2MikKICAgKiB0aGF0IGlkZW50aWZ5IHRoZSByZWdpc3RlcmVkIHBhcmFtZXRlci4KICAgKiBAcGFyYW0gY2hhbm5lbAogICAqIEBwYXJhbSB0aW1lCiAgICoKICAgKiBAcmV0dXJucyB7T3V0cHV0fQogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5fc2VsZWN0Tm9uUmVnaXN0ZXJlZFBhcmFtZXRlciA9IGZ1bmN0aW9uIChwYXJhbWV0ZXIsIGNoYW5uZWwsIHRpbWUpIHsKICAgIHZhciB0aGF0ID0gdGhpczsKICAgIHBhcmFtZXRlclswXSA9IE1hdGguZmxvb3IocGFyYW1ldGVyWzBdKTsKCiAgICBpZiAoIShwYXJhbWV0ZXJbMF0gPj0gMCAmJiBwYXJhbWV0ZXJbMF0gPD0gMTI3KSkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigiVGhlIGNvbnRyb2w2MyB2YWx1ZSBtdXN0IGJlIGJldHdlZW4gMCBhbmQgMTI3Iik7CiAgICB9CgogICAgcGFyYW1ldGVyWzFdID0gTWF0aC5mbG9vcihwYXJhbWV0ZXJbMV0pOwoKICAgIGlmICghKHBhcmFtZXRlclsxXSA+PSAwICYmIHBhcmFtZXRlclsxXSA8PSAxMjcpKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJUaGUgY29udHJvbDYyIHZhbHVlIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxMjciKTsKICAgIH0KCiAgICB3bS50b01JRElDaGFubmVscyhjaGFubmVsKS5mb3JFYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgdGhhdC5zZW5kQ29udHJvbENoYW5nZSgweDYzLCBwYXJhbWV0ZXJbMF0sIGNoYW5uZWwsIHsKICAgICAgICB0aW1lOiB0aW1lCiAgICAgIH0pOwogICAgICB0aGF0LnNlbmRDb250cm9sQ2hhbmdlKDB4NjIsIHBhcmFtZXRlclsxXSwgY2hhbm5lbCwgewogICAgICAgIHRpbWU6IHRpbWUKICAgICAgfSk7CiAgICB9KTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgLyoqCiAgICogU2V0cyB0aGUgdmFsdWUgb2YgdGhlIGN1cnJlbnRseSBzZWxlY3RlZCBNSURJIHJlZ2lzdGVyZWQgcGFyYW1ldGVyLgogICAqCiAgICogQG1ldGhvZCBfc2V0Q3VycmVudFJlZ2lzdGVyZWRQYXJhbWV0ZXIKICAgKiBAcHJvdGVjdGVkCiAgICoKICAgKiBAcGFyYW0gZGF0YSB7aW50fEFycmF5fQogICAqIEBwYXJhbSBjaGFubmVsCiAgICogQHBhcmFtIHRpbWUKICAgKgogICAqIEByZXR1cm5zIHtPdXRwdXR9CiAgICovCgoKICBPdXRwdXQucHJvdG90eXBlLl9zZXRDdXJyZW50UmVnaXN0ZXJlZFBhcmFtZXRlciA9IGZ1bmN0aW9uIChkYXRhLCBjaGFubmVsLCB0aW1lKSB7CiAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICBkYXRhID0gW10uY29uY2F0KGRhdGEpOwogICAgZGF0YVswXSA9IE1hdGguZmxvb3IoZGF0YVswXSk7CgogICAgaWYgKCEoZGF0YVswXSA+PSAwICYmIGRhdGFbMF0gPD0gMTI3KSkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigiVGhlIG1zYiB2YWx1ZSBtdXN0IGJlIGJldHdlZW4gMCBhbmQgMTI3Iik7CiAgICB9CgogICAgd20udG9NSURJQ2hhbm5lbHMoY2hhbm5lbCkuZm9yRWFjaChmdW5jdGlvbiAoKSB7CiAgICAgIHRoYXQuc2VuZENvbnRyb2xDaGFuZ2UoMHgwNiwgZGF0YVswXSwgY2hhbm5lbCwgewogICAgICAgIHRpbWU6IHRpbWUKICAgICAgfSk7CiAgICB9KTsKICAgIGRhdGFbMV0gPSBNYXRoLmZsb29yKGRhdGFbMV0pOwoKICAgIGlmIChkYXRhWzFdID49IDAgJiYgZGF0YVsxXSA8PSAxMjcpIHsKICAgICAgd20udG9NSURJQ2hhbm5lbHMoY2hhbm5lbCkuZm9yRWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhhdC5zZW5kQ29udHJvbENoYW5nZSgweDI2LCBkYXRhWzFdLCBjaGFubmVsLCB7CiAgICAgICAgICB0aW1lOiB0aW1lCiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQoKICAgIHJldHVybiB0aGlzOwogIH07CiAgLyoqCiAgICogRGVzZWxlY3RzIHRoZSBjdXJyZW50bHkgYWN0aXZlIE1JREkgcmVnaXN0ZXJlZCBwYXJhbWV0ZXIgc28gaXQgaXMgbm8gbG9uZ2VyIGFmZmVjdGVkIGJ5IGRhdGEKICAgKiBlbnRyeSwgZGF0YSBpbmNyZW1lbnQgYW5kIGRhdGEgZGVjcmVtZW50IG1lc3NhZ2VzLgogICAqCiAgICogQ3VycmVudCBiZXN0IHByYWN0aWNlIHJlY29tbWVuZHMgZG9pbmcgdGhhdCBhZnRlciBlYWNoIGNhbGwgdG8KICAgKiBgX3NldEN1cnJlbnRSZWdpc3RlcmVkUGFyYW1ldGVyKClgLgogICAqCiAgICogQG1ldGhvZCBfZGVzZWxlY3RSZWdpc3RlcmVkUGFyYW1ldGVyCiAgICogQHByb3RlY3RlZAogICAqCiAgICogQHBhcmFtIGNoYW5uZWwKICAgKiBAcGFyYW0gdGltZQogICAqCiAgICogQHJldHVybnMge091dHB1dH0KICAgKi8KCgogIE91dHB1dC5wcm90b3R5cGUuX2Rlc2VsZWN0UmVnaXN0ZXJlZFBhcmFtZXRlciA9IGZ1bmN0aW9uIChjaGFubmVsLCB0aW1lKSB7CiAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICB3bS50b01JRElDaGFubmVscyhjaGFubmVsKS5mb3JFYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgdGhhdC5zZW5kQ29udHJvbENoYW5nZSgweDY1LCAweDdGLCBjaGFubmVsLCB7CiAgICAgICAgdGltZTogdGltZQogICAgICB9KTsKICAgICAgdGhhdC5zZW5kQ29udHJvbENoYW5nZSgweDY0LCAweDdGLCBjaGFubmVsLCB7CiAgICAgICAgdGltZTogdGltZQogICAgICB9KTsKICAgIH0pOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBTZXRzIHRoZSBzcGVjaWZpZWQgTUlESSByZWdpc3RlcmVkIHBhcmFtZXRlciB0byB0aGUgZGVzaXJlZCB2YWx1ZS4gVGhlIHZhbHVlIGlzIGRlZmluZWQgd2l0aAogICAqIHVwIHRvIHR3byBieXRlcyBvZiBkYXRhIHRoYXQgZWFjaCBjYW4gZ28gZnJvbSAwIHRvIDEyNy4KICAgKgogICAqID5Vbmxlc3MgeW91IGFyZSB2ZXJ5IGZhbWlsaWFyIHdpdGggdGhlIE1JREkgc3RhbmRhcmQgeW91IHByb2JhYmx5IHNob3VsZCBmYXZvdXIgb25lIG9mIHRoZQogICAqID5zaW1wbGVyIHRvIHVzZSBmdW5jdGlvbnMgc3VjaCBhczogYHNldFBpdGNoYmVuZFJhbmdlKClgLCBgc2V0TW9kdWxhdGlvblJhbmdlKClgLAogICAqID5gc2V0TWFzdGVyVHVuaW5nKClgLCBldGMuCiAgICoKICAgKiBNSURJIHJlZ2lzdGVyZWQgcGFyYW1ldGVycyBleHRlbmQgdGhlIG9yaWdpbmFsIGxpc3Qgb2YgY29udHJvbCBjaGFuZ2UgbWVzc2FnZXMuIEN1cnJlbnRseSwKICAgKiB0aGVyZSBhcmUgb25seSBhIGxpbWl0ZWQgbnVtYmVyIG9mIHRoZW0uIEhlcmUgYXJlIHRoZSBvcmlnaW5hbCByZWdpc3RlcmVkIHBhcmFtZXRlcnMgd2l0aCB0aGUKICAgKiBpZGVudGlmaWVyIHRoYXQgY2FuIGJlIHVzZWQgYXMgdGhlIGZpcnN0IHBhcmFtZXRlciBvZiB0aGlzIGZ1bmN0aW9uOgogICAqCiAgICogICogUGl0Y2hiZW5kIFJhbmdlICgweDAwLCAweDAwKTogYHBpdGNoYmVuZHJhbmdlYAogICAqICAqIENoYW5uZWwgRmluZSBUdW5pbmcgKDB4MDAsIDB4MDEpOiBgY2hhbm5lbGZpbmV0dW5pbmdgCiAgICogICogQ2hhbm5lbCBDb2Fyc2UgVHVuaW5nICgweDAwLCAweDAyKTogYGNoYW5uZWxjb2Fyc2V0dW5pbmdgCiAgICogICogVHVuaW5nIFByb2dyYW0gKDB4MDAsIDB4MDMpOiBgdHVuaW5ncHJvZ3JhbWAKICAgKiAgKiBUdW5pbmcgQmFuayAoMHgwMCwgMHgwNCk6IGB0dW5pbmdiYW5rYAogICAqICAqIE1vZHVsYXRpb24gUmFuZ2UgKDB4MDAsIDB4MDUpOiBgbW9kdWxhdGlvbnJhbmdlYAogICAqCiAgICogTm90ZSB0aGF0IHRoZSAqKlR1bmluZyBQcm9ncmFtKiogYW5kICoqVHVuaW5nIEJhbmsqKiBwYXJhbWV0ZXJzIGFyZSBwYXJ0IG9mIHRoZSAqTUlESSBUdW5pbmcKICAgKiBTdGFuZGFyZCosIHdoaWNoIGlzIG5vdCB3aWRlbHkgaW1wbGVtZW50ZWQuCiAgICoKICAgKiBBbm90aGVyIHNldCBvZiBleHRyYSBwYXJhbWV0ZXJzIGhhdmUgYmVlbiBsYXRlciBhZGRlZCBmb3IgM0Qgc291bmQgY29udHJvbGxlcnMuIFRoZXkgYXJlOgogICAqCiAgICogICogQXppbXV0aCBBbmdsZSAoMHgzRCwgMHgwMCk6IGBhemltdXRoYW5nbGVgCiAgICogICogRWxldmF0aW9uIEFuZ2xlICgweDNELCAweDAxKTogYGVsZXZhdGlvbmFuZ2xlYAogICAqICAqIEdhaW4gKDB4M0QsIDB4MDIpOiBgZ2FpbmAKICAgKiAgKiBEaXN0YW5jZSBSYXRpbyAoMHgzRCwgMHgwMyk6IGBkaXN0YW5jZXJhdGlvYAogICAqICAqIE1heGltdW0gRGlzdGFuY2UgKDB4M0QsIDB4MDQpOiBgbWF4aW11bWRpc3RhbmNlYAogICAqICAqIE1heGltdW0gRGlzdGFuY2UgR2FpbiAoMHgzRCwgMHgwNSk6IGBtYXhpbXVtZGlzdGFuY2VnYWluYAogICAqICAqIFJlZmVyZW5jZSBEaXN0YW5jZSBSYXRpbyAoMHgzRCwgMHgwNik6IGByZWZlcmVuY2VkaXN0YW5jZXJhdGlvYAogICAqICAqIFBhbiBTcHJlYWQgQW5nbGUgKDB4M0QsIDB4MDcpOiBgcGFuc3ByZWFkYW5nbGVgCiAgICogICogUm9sbCBBbmdsZSAoMHgzRCwgMHgwOCk6IGByb2xsYW5nbGVgCiAgICoKICAgKiBAbWV0aG9kIHNldFJlZ2lzdGVyZWRQYXJhbWV0ZXIKICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0gcGFyYW1ldGVyIHtTdHJpbmd8QXJyYXl9IEEgc3RyaW5nIGlkZW50aWZ5aW5nIHRoZSBwYXJhbWV0ZXIicyBuYW1lIChzZWUgYWJvdmUpIG9yIGEKICAgKiB0d28tcG9zaXRpb24gYXJyYXkgc3BlY2lmeWluZyB0aGUgdHdvIGNvbnRyb2wgYnl0ZXMgKDB4NjUsIDB4NjQpIHRoYXQgaWRlbnRpZnkgdGhlIHJlZ2lzdGVyZWQKICAgKiBwYXJhbWV0ZXIuCiAgICoKICAgKiBAcGFyYW0gW2RhdGE9W11dIHtOdW1iZXJ8QXJyYXl9IEFuIHNpbmdsZSBpbnRlZ2VyIG9yIGFuIGFycmF5IG9mIGludGVnZXJzIHdpdGggYSBtYXhpbXVtIGxlbmd0aAogICAqIG9mIDIgc3BlY2lmeWluZyB0aGUgZGVzaXJlZCBkYXRhLgogICAqCiAgICogQHBhcmFtIFtjaGFubmVsPWFsbF0ge051bWJlcnxBcnJheXxTdHJpbmd9IFRoZSBNSURJIGNoYW5uZWwgbnVtYmVyIChiZXR3ZWVuIDEgYW5kIDE2KSBvciBhbgogICAqIGFycmF5IG9mIGNoYW5uZWwgbnVtYmVycy4gSWYgdGhlIHNwZWNpYWwgdmFsdWUgImFsbCIgaXMgdXNlZCwgdGhlIG1lc3NhZ2Ugd2lsbCBiZSBzZW50IHRvIGFsbAogICAqIDE2IGNoYW5uZWxzLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zPXt9XQogICAqCiAgICogQHBhcmFtIHtET01IaWdoUmVzVGltZVN0YW1wfFN0cmluZ30gW29wdGlvbnMudGltZT11bmRlZmluZWRdIFRoaXMgdmFsdWUgY2FuIGJlIG9uZSBvZiB0d28KICAgKiB0aGluZ3MuIElmIHRoZSB2YWx1ZSBpcyBhIHN0cmluZyBzdGFydGluZyB3aXRoIHRoZSArIHNpZ24gYW5kIGZvbGxvd2VkIGJ5IGEgbnVtYmVyLCB0aGUgcmVxdWVzdAogICAqIHdpbGwgYmUgZGVsYXllZCBieSB0aGUgc3BlY2lmaWVkIG51bWJlciAoaW4gbWlsbGlzZWNvbmRzKS4gT3RoZXJ3aXNlLCB0aGUgdmFsdWUgaXMgY29uc2lkZXJlZCBhCiAgICogdGltZXN0YW1wIGFuZCB0aGUgcmVxdWVzdCB3aWxsIGJlIHNjaGVkdWxlZCBhdCB0aGF0IHRpbWVzdGFtcC4gVGhlIGBET01IaWdoUmVzVGltZVN0YW1wYCB2YWx1ZQogICAqIGlzIHJlbGF0aXZlIHRvIHRoZSBuYXZpZ2F0aW9uIHN0YXJ0IG9mIHRoZSBkb2N1bWVudC4gVG8gcmV0cmlldmUgdGhlIGN1cnJlbnQgdGltZSwgeW91IGNhbiB1c2UKICAgKiBgV2ViTWlkaS50aW1lYC4gSWYgYHRpbWVgIGlzIG5vdCBwcmVzZW50IG9yIGlzIHNldCB0byBhIHRpbWUgaW4gdGhlIHBhc3QsIHRoZSByZXF1ZXN0IGlzIHRvIGJlCiAgICogc2VudCBhcyBzb29uIGFzIHBvc3NpYmxlLgogICAqCiAgICogQHJldHVybnMge091dHB1dH0gUmV0dXJucyB0aGUgYE91dHB1dGAgb2JqZWN0IHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICovCgoKICBPdXRwdXQucHJvdG90eXBlLnNldFJlZ2lzdGVyZWRQYXJhbWV0ZXIgPSBmdW5jdGlvbiAocGFyYW1ldGVyLCBkYXRhLCBjaGFubmVsLCBvcHRpb25zKSB7CiAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICBpZiAoIUFycmF5LmlzQXJyYXkocGFyYW1ldGVyKSkgewogICAgICBpZiAoIXdtLk1JRElfUkVHSVNURVJFRF9QQVJBTUVURVJbcGFyYW1ldGVyXSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIHNwZWNpZmllZCBwYXJhbWV0ZXIgaXMgbm90IGF2YWlsYWJsZS4iKTsKICAgICAgfQoKICAgICAgcGFyYW1ldGVyID0gd20uTUlESV9SRUdJU1RFUkVEX1BBUkFNRVRFUltwYXJhbWV0ZXJdOwogICAgfQoKICAgIHdtLnRvTUlESUNoYW5uZWxzKGNoYW5uZWwpLmZvckVhY2goZnVuY3Rpb24gKCkgewogICAgICB0aGF0Ll9zZWxlY3RSZWdpc3RlcmVkUGFyYW1ldGVyKHBhcmFtZXRlciwgY2hhbm5lbCwgb3B0aW9ucy50aW1lKTsKCiAgICAgIHRoYXQuX3NldEN1cnJlbnRSZWdpc3RlcmVkUGFyYW1ldGVyKGRhdGEsIGNoYW5uZWwsIG9wdGlvbnMudGltZSk7CgogICAgICB0aGF0Ll9kZXNlbGVjdFJlZ2lzdGVyZWRQYXJhbWV0ZXIoY2hhbm5lbCwgb3B0aW9ucy50aW1lKTsKICAgIH0pOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBTZXRzIGEgbm9uLXJlZ2lzdGVyZWQgcGFyYW1ldGVyIHRvIHRoZSBzcGVjaWZpZWQgdmFsdWUuIFRoZSBOUlBOIGlzIHNlbGVjdGVkIGJ5IHBhc3NpbmcgaW4gYQogICAqIHR3by1wb3NpdGlvbiBhcnJheSBzcGVjaWZ5aW5nIHRoZSB2YWx1ZXMgb2YgdGhlIHR3byBjb250cm9sIGJ5dGVzLiBUaGUgdmFsdWUgaXMgc3BlY2lmaWVkIGJ5CiAgICogcGFzc2luZyBpbiBhbiBzaW5nbGUgaW50ZWdlciAobW9zdCBjYXNlcykgb3IgYW4gYXJyYXkgb2YgdHdvIGludGVnZXJzLgogICAqCiAgICogTlJQTnMgYXJlIG5vdCBzdGFuZGFyZGl6ZWQgaW4gYW55IHdheS4gRWFjaCBtYW51ZmFjdHVyZXIgaXMgZnJlZSB0byBpbXBsZW1lbnQgdGhlbSBhbnkgd2F5CiAgICogdGhleSBzZWUgZml0LiBGb3IgZXhhbXBsZSwgYWNjb3JkaW5nIHRvIHRoZSBSb2xhbmQgR1Mgc3BlY2lmaWNhdGlvbiwgeW91IGNhbiBjb250cm9sIHRoZQogICAqICoqdmlicmF0byByYXRlKiogdXNpbmcgTlJQTiAoMSwgOCkuIFRoZXJlZm9yZSwgdG8gc2V0IHRoZSAqKnZpYnJhdG8gcmF0ZSoqIHZhbHVlIHRvICoqMTIzKiogeW91CiAgICogd291bGQgdXNlOgogICAqCiAgICogICAgIFdlYk1pZGkub3V0cHV0c1swXS5zZXROb25SZWdpc3RlcmVkUGFyYW1ldGVyKFsxLCA4XSwgMTIzKTsKICAgKgogICAqIE9idmlvdXNseSwgeW91IHNob3VsZCBzZWxlY3QgYSBjaGFubmVsIHNvIHRoZSBtZXNzYWdlIGlzIG5vdCBzZW50IHRvIGFsbCBjaGFubmVscy4gRm9yCiAgICogaW5zdGFuY2UsIHRvIHNlbmQgdG8gY2hhbm5lbCAxIG9mIHRoZSBmaXJzdCBvdXRwdXQgcG9ydCwgeW91IHdvdWxkIHVzZToKICAgKgogICAqICAgICBXZWJNaWRpLm91dHB1dHNbMF0uc2V0Tm9uUmVnaXN0ZXJlZFBhcmFtZXRlcihbMSwgOF0sIDEyMywgMSk7CiAgICoKICAgKiBJbiBzb21lIHJhcmVyIGNhc2VzLCB5b3UgbmVlZCB0byBzZW5kIHR3byB2YWx1ZXMgd2l0aCB5b3VyIE5SUE4gbWVzc2FnZXMuIEluIHN1Y2ggY2FzZXMsIHlvdQogICAqIHdvdWxkIHVzZSBhIDItcG9zaXRpb24gYXJyYXkuIEZvciBleGFtcGxlLCBmb3IgaXRzICoqQ2xvY2tCUE0qKiBwYXJhbWV0ZXIgKDIsIDYzKSwgTm92YXRpb24KICAgKiB1c2VzIGEgMTQtYml0IHZhbHVlIHRoYXQgY29tYmluZXMgYW4gTVNCIGFuZCBhbiBMU0IgKDctYml0IHZhbHVlcykuIFNvLCBmb3IgZXhhbXBsZSwgaWYgdGhlCiAgICogdmFsdWUgdG8gc2VuZCB3YXMgMTAsIHlvdSBjb3VsZCB1c2U6CiAgICoKICAgKiAgICAgV2ViTWlkaS5vdXRwdXRzWzBdLnNldE5vblJlZ2lzdGVyZWRQYXJhbWV0ZXIoWzIsIDYzXSwgWzAsIDEwXSk7CiAgICoKICAgKiBGb3IgZnVydGhlciBpbXBsZW1lbnRhdGlvbiBkZXRhaWxzLCByZWZlciB0byB0aGUgbWFudWZhY3R1cmVyInMgZG9jdW1lbnRhdGlvbi4KICAgKgogICAqIEBtZXRob2Qgc2V0Tm9uUmVnaXN0ZXJlZFBhcmFtZXRlcgogICAqIEBjaGFpbmFibGUKICAgKgogICAqIEBwYXJhbSBwYXJhbWV0ZXIge0FycmF5fSBBIHR3by1wb3NpdGlvbiBhcnJheSBzcGVjaWZ5aW5nIHRoZSB0d28gY29udHJvbCBieXRlcyAoMHg2MywKICAgKiAweDYyKSB0aGF0IGlkZW50aWZ5IHRoZSBub24tcmVnaXN0ZXJlZCBwYXJhbWV0ZXIuCiAgICoKICAgKiBAcGFyYW0gW2RhdGE9W11dIHtOdW1iZXJ8QXJyYXl9IEFuIGludGVnZXIgb3IgYW4gYXJyYXkgb2YgaW50ZWdlcnMgd2l0aCBhIGxlbmd0aCBvZiAxIG9yIDIKICAgKiBzcGVjaWZ5aW5nIHRoZSBkZXNpcmVkIGRhdGEuCiAgICoKICAgKiBAcGFyYW0gW2NoYW5uZWw9YWxsXSB7TnVtYmVyfEFycmF5fFN0cmluZ30gVGhlIE1JREkgY2hhbm5lbCBudW1iZXIgKGJldHdlZW4gMSBhbmQgMTYpIG9yIGFuCiAgICogYXJyYXkgb2YgY2hhbm5lbCBudW1iZXJzLiBJZiB0aGUgc3BlY2lhbCB2YWx1ZSAiYWxsIiBpcyB1c2VkLCB0aGUgbWVzc2FnZSB3aWxsIGJlIHNlbnQgdG8gYWxsCiAgICogMTYgY2hhbm5lbHMuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dCiAgICoKICAgKiBAcGFyYW0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB8U3RyaW5nfSBbb3B0aW9ucy50aW1lPXVuZGVmaW5lZF0gVGhpcyB2YWx1ZSBjYW4gYmUgb25lIG9mIHR3bwogICAqIHRoaW5ncy4gSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHN0YXJ0aW5nIHdpdGggdGhlICsgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsIHRoZSByZXF1ZXN0CiAgICogd2lsbCBiZSBkZWxheWVkIGJ5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIChpbiBtaWxsaXNlY29uZHMpLiBPdGhlcndpc2UsIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEKICAgKiB0aW1lc3RhbXAgYW5kIHRoZSByZXF1ZXN0IHdpbGwgYmUgc2NoZWR1bGVkIGF0IHRoYXQgdGltZXN0YW1wLiBUaGUgYERPTUhpZ2hSZXNUaW1lU3RhbXBgIHZhbHVlCiAgICogaXMgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LiBUbyByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lLCB5b3UgY2FuIHVzZQogICAqIGBXZWJNaWRpLnRpbWVgLiBJZiBgdGltZWAgaXMgbm90IHByZXNlbnQgb3IgaXMgc2V0IHRvIGEgdGltZSBpbiB0aGUgcGFzdCwgdGhlIHJlcXVlc3QgaXMgdG8gYmUKICAgKiBzZW50IGFzIHNvb24gYXMgcG9zc2libGUuCiAgICoKICAgKiBAcmV0dXJucyB7T3V0cHV0fSBSZXR1cm5zIHRoZSBgT3V0cHV0YCBvYmplY3Qgc28gbWV0aG9kcyBjYW4gYmUgY2hhaW5lZC4KICAgKi8KCgogIE91dHB1dC5wcm90b3R5cGUuc2V0Tm9uUmVnaXN0ZXJlZFBhcmFtZXRlciA9IGZ1bmN0aW9uIChwYXJhbWV0ZXIsIGRhdGEsIGNoYW5uZWwsIG9wdGlvbnMpIHsKICAgIHZhciB0aGF0ID0gdGhpczsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgIGlmICghKHBhcmFtZXRlclswXSA+PSAwICYmIHBhcmFtZXRlclswXSA8PSAxMjcpIHx8ICEocGFyYW1ldGVyWzFdID49IDAgJiYgcGFyYW1ldGVyWzFdIDw9IDEyNykpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJQb3NpdGlvbiAwIGFuZCAxIG9mIHRoZSAyLXBvc2l0aW9uIHBhcmFtZXRlciBhcnJheSBtdXN0IGJvdGggYmUgYmV0d2VlbiAwIGFuZCAxMjcuIik7CiAgICB9CgogICAgZGF0YSA9IFtdLmNvbmNhdChkYXRhKTsKICAgIHdtLnRvTUlESUNoYW5uZWxzKGNoYW5uZWwpLmZvckVhY2goZnVuY3Rpb24gKCkgewogICAgICB0aGF0Ll9zZWxlY3ROb25SZWdpc3RlcmVkUGFyYW1ldGVyKHBhcmFtZXRlciwgY2hhbm5lbCwgb3B0aW9ucy50aW1lKTsKCiAgICAgIHRoYXQuX3NldEN1cnJlbnRSZWdpc3RlcmVkUGFyYW1ldGVyKGRhdGEsIGNoYW5uZWwsIG9wdGlvbnMudGltZSk7CgogICAgICB0aGF0Ll9kZXNlbGVjdFJlZ2lzdGVyZWRQYXJhbWV0ZXIoY2hhbm5lbCwgb3B0aW9ucy50aW1lKTsKICAgIH0pOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBJbmNyZW1lbnRzIHRoZSBzcGVjaWZpZWQgTUlESSByZWdpc3RlcmVkIHBhcmFtZXRlciBieSAxLiBGb3IgbW9yZSBzcGVjaWZpYyBNSURJIHVzYWdlCiAgICogaW5mb3JtYXRpb24sIGNoZWNrIG91dCBbUlAtMThdKGh0dHA6Ly9kZXYubWlkaS5vcmcvdGVjaHNwZWNzL3JwMTgucGhwKSByZWdhcmRpbmcgdGhlIHVzYWdlIG9mCiAgICogaW5jcmVtZW50IGFuZCBkZWNyZW1lbnQgY29udHJvbGxlcnMuCiAgICoKICAgKiA+VW5sZXNzIHlvdSBhcmUgdmVyeSBmYW1pbGlhciB3aXRoIHRoZSBNSURJIHN0YW5kYXJkIHlvdSBwcm9iYWJseSBzaG91bGQgZmF2b3VyIG9uZSBvZiB0aGUKICAgKiA+c2ltcGxlciB0byB1c2UgZnVuY3Rpb25zIHN1Y2ggYXM6IGBzZXRQaXRjaGJlbmRSYW5nZSgpYCwgYHNldE1vZHVsYXRpb25SYW5nZSgpYCwKICAgKiA+YHNldE1hc3RlclR1bmluZygpYCwgZXRjLgogICAqCiAgICogSGVyZSBpcyB0aGUgZnVsbCBsaXN0IG9mIHBhcmFtZXRlciBuYW1lcyB0aGF0IGNhbiBiZSB1c2VkIHdpdGggdGhpcyBmdW5jdGlvbjoKICAgKgogICAqICAqIFBpdGNoYmVuZCBSYW5nZSAoMHgwMCwgMHgwMCk6IGBwaXRjaGJlbmRyYW5nZWAKICAgKiAgKiBDaGFubmVsIEZpbmUgVHVuaW5nICgweDAwLCAweDAxKTogYGNoYW5uZWxmaW5ldHVuaW5nYAogICAqICAqIENoYW5uZWwgQ29hcnNlIFR1bmluZyAoMHgwMCwgMHgwMik6IGBjaGFubmVsY29hcnNldHVuaW5nYAogICAqICAqIFR1bmluZyBQcm9ncmFtICgweDAwLCAweDAzKTogYHR1bmluZ3Byb2dyYW1gCiAgICogICogVHVuaW5nIEJhbmsgKDB4MDAsIDB4MDQpOiBgdHVuaW5nYmFua2AKICAgKiAgKiBNb2R1bGF0aW9uIFJhbmdlICgweDAwLCAweDA1KTogYG1vZHVsYXRpb25yYW5nZWAKICAgKiAgKiBBemltdXRoIEFuZ2xlICgweDNELCAweDAwKTogYGF6aW11dGhhbmdsZWAKICAgKiAgKiBFbGV2YXRpb24gQW5nbGUgKDB4M0QsIDB4MDEpOiBgZWxldmF0aW9uYW5nbGVgCiAgICogICogR2FpbiAoMHgzRCwgMHgwMik6IGBnYWluYAogICAqICAqIERpc3RhbmNlIFJhdGlvICgweDNELCAweDAzKTogYGRpc3RhbmNlcmF0aW9gCiAgICogICogTWF4aW11bSBEaXN0YW5jZSAoMHgzRCwgMHgwNCk6IGBtYXhpbXVtZGlzdGFuY2VgCiAgICogICogTWF4aW11bSBEaXN0YW5jZSBHYWluICgweDNELCAweDA1KTogYG1heGltdW1kaXN0YW5jZWdhaW5gCiAgICogICogUmVmZXJlbmNlIERpc3RhbmNlIFJhdGlvICgweDNELCAweDA2KTogYHJlZmVyZW5jZWRpc3RhbmNlcmF0aW9gCiAgICogICogUGFuIFNwcmVhZCBBbmdsZSAoMHgzRCwgMHgwNyk6IGBwYW5zcHJlYWRhbmdsZWAKICAgKiAgKiBSb2xsIEFuZ2xlICgweDNELCAweDA4KTogYHJvbGxhbmdsZWAKICAgKgogICAqIEBtZXRob2QgaW5jcmVtZW50UmVnaXN0ZXJlZFBhcmFtZXRlcgogICAqIEBjaGFpbmFibGUKICAgKgogICAqIEBwYXJhbSBwYXJhbWV0ZXIge1N0cmluZ3xBcnJheX0gQSBzdHJpbmcgaWRlbnRpZnlpbmcgdGhlIHBhcmFtZXRlciJzIG5hbWUgKHNlZSBhYm92ZSkgb3IgYQogICAqIHR3by1wb3NpdGlvbiBhcnJheSBzcGVjaWZ5aW5nIHRoZSB0d28gY29udHJvbCBieXRlcyAoMHg2NSwgMHg2NCkgdGhhdCBpZGVudGlmeSB0aGUgcmVnaXN0ZXJlZAogICAqIHBhcmFtZXRlci4KICAgKgogICAqIEBwYXJhbSBbY2hhbm5lbD1hbGxdIHt1aW50fEFycmF5fFN0cmluZ30gVGhlIE1JREkgY2hhbm5lbCBudW1iZXIgKGJldHdlZW4gMSBhbmQgMTYpIG9yIGFuCiAgICogYXJyYXkgb2YgY2hhbm5lbCBudW1iZXJzLiBJZiB0aGUgc3BlY2lhbCB2YWx1ZSAiYWxsIiBpcyB1c2VkLCB0aGUgbWVzc2FnZSB3aWxsIGJlIHNlbnQgdG8gYWxsCiAgICogMTYgY2hhbm5lbHMuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dCiAgICoKICAgKiBAcGFyYW0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB8U3RyaW5nfSBbb3B0aW9ucy50aW1lPXVuZGVmaW5lZF0gVGhpcyB2YWx1ZSBjYW4gYmUgb25lIG9mIHR3bwogICAqIHRoaW5ncy4gSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHN0YXJ0aW5nIHdpdGggdGhlICsgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsIHRoZSByZXF1ZXN0CiAgICogd2lsbCBiZSBkZWxheWVkIGJ5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIChpbiBtaWxsaXNlY29uZHMpLiBPdGhlcndpc2UsIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEKICAgKiB0aW1lc3RhbXAgYW5kIHRoZSByZXF1ZXN0IHdpbGwgYmUgc2NoZWR1bGVkIGF0IHRoYXQgdGltZXN0YW1wLiBUaGUgYERPTUhpZ2hSZXNUaW1lU3RhbXBgIHZhbHVlCiAgICogaXMgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LiBUbyByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lLCB5b3UgY2FuIHVzZQogICAqIGBXZWJNaWRpLnRpbWVgLiBJZiBgdGltZWAgaXMgbm90IHByZXNlbnQgb3IgaXMgc2V0IHRvIGEgdGltZSBpbiB0aGUgcGFzdCwgdGhlIHJlcXVlc3QgaXMgdG8gYmUKICAgKiBzZW50IGFzIHNvb24gYXMgcG9zc2libGUuCiAgICoKICAgKiBAdGhyb3dzIEVycm9yIFRoZSBzcGVjaWZpZWQgcGFyYW1ldGVyIGlzIG5vdCBhdmFpbGFibGUuCiAgICoKICAgKiBAcmV0dXJucyB7T3V0cHV0fSBSZXR1cm5zIHRoZSBgT3V0cHV0YCBvYmplY3Qgc28gbWV0aG9kcyBjYW4gYmUgY2hhaW5lZC4KICAgKi8KCgogIE91dHB1dC5wcm90b3R5cGUuaW5jcmVtZW50UmVnaXN0ZXJlZFBhcmFtZXRlciA9IGZ1bmN0aW9uIChwYXJhbWV0ZXIsIGNoYW5uZWwsIG9wdGlvbnMpIHsKICAgIHZhciB0aGF0ID0gdGhpczsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgIGlmICghQXJyYXkuaXNBcnJheShwYXJhbWV0ZXIpKSB7CiAgICAgIGlmICghd20uTUlESV9SRUdJU1RFUkVEX1BBUkFNRVRFUltwYXJhbWV0ZXJdKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgc3BlY2lmaWVkIHBhcmFtZXRlciBpcyBub3QgYXZhaWxhYmxlLiIpOwogICAgICB9CgogICAgICBwYXJhbWV0ZXIgPSB3bS5NSURJX1JFR0lTVEVSRURfUEFSQU1FVEVSW3BhcmFtZXRlcl07CiAgICB9CgogICAgd20udG9NSURJQ2hhbm5lbHMoY2hhbm5lbCkuZm9yRWFjaChmdW5jdGlvbiAoKSB7CiAgICAgIHRoYXQuX3NlbGVjdFJlZ2lzdGVyZWRQYXJhbWV0ZXIocGFyYW1ldGVyLCBjaGFubmVsLCBvcHRpb25zLnRpbWUpOwoKICAgICAgdGhhdC5zZW5kQ29udHJvbENoYW5nZSgweDYwLCAwLCBjaGFubmVsLCB7CiAgICAgICAgdGltZTogb3B0aW9ucy50aW1lCiAgICAgIH0pOwoKICAgICAgdGhhdC5fZGVzZWxlY3RSZWdpc3RlcmVkUGFyYW1ldGVyKGNoYW5uZWwsIG9wdGlvbnMudGltZSk7CiAgICB9KTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgLyoqCiAgICogRGVjcmVtZW50cyB0aGUgc3BlY2lmaWVkIE1JREkgcmVnaXN0ZXJlZCBwYXJhbWV0ZXIgYnkgMS4gRm9yIG1vcmUgc3BlY2lmaWMgTUlESSB1c2FnZQogICAqIGluZm9ybWF0aW9uLCBjaGVjayBvdXQgW1JQLTE4XShodHRwOi8vZGV2Lm1pZGkub3JnL3RlY2hzcGVjcy9ycDE4LnBocCkgcmVnYXJkaW5nIHRoZSB1c2FnZSBvZgogICAqIGluY3JlbWVudCBhbmQgZGVjcmVtZW50IGNvbnRyb2xsZXJzLgogICAqCiAgICogPlVubGVzcyB5b3UgYXJlIHZlcnkgZmFtaWxpYXIgd2l0aCB0aGUgTUlESSBzdGFuZGFyZCB5b3UgcHJvYmFibHkgc2hvdWxkIGZhdm91ciBvbmUgb2YgdGhlCiAgICogPnNpbXBsZXIgdG8gdXNlIGZ1bmN0aW9ucyBzdWNoIGFzOiBgc2V0UGl0Y2hiZW5kUmFuZ2UoKWAsIGBzZXRNb2R1bGF0aW9uUmFuZ2UoKWAsCiAgICogPmBzZXRNYXN0ZXJUdW5pbmcoKWAsIGV0Yy4KICAgKgogICAqIEhlcmUgaXMgdGhlIGZ1bGwgbGlzdCBvZiBwYXJhbWV0ZXIgbmFtZXMgdGhhdCBjYW4gYmUgdXNlZCB3aXRoIHRoaXMgZnVuY3Rpb246CiAgICoKICAgKiAgKiBQaXRjaGJlbmQgUmFuZ2UgKDB4MDAsIDB4MDApOiBgcGl0Y2hiZW5kcmFuZ2VgCiAgICogICogQ2hhbm5lbCBGaW5lIFR1bmluZyAoMHgwMCwgMHgwMSk6IGBjaGFubmVsZmluZXR1bmluZ2AKICAgKiAgKiBDaGFubmVsIENvYXJzZSBUdW5pbmcgKDB4MDAsIDB4MDIpOiBgY2hhbm5lbGNvYXJzZXR1bmluZ2AKICAgKiAgKiBUdW5pbmcgUHJvZ3JhbSAoMHgwMCwgMHgwMyk6IGB0dW5pbmdwcm9ncmFtYAogICAqICAqIFR1bmluZyBCYW5rICgweDAwLCAweDA0KTogYHR1bmluZ2JhbmtgCiAgICogICogTW9kdWxhdGlvbiBSYW5nZSAoMHgwMCwgMHgwNSk6IGBtb2R1bGF0aW9ucmFuZ2VgCiAgICogICogQXppbXV0aCBBbmdsZSAoMHgzRCwgMHgwMCk6IGBhemltdXRoYW5nbGVgCiAgICogICogRWxldmF0aW9uIEFuZ2xlICgweDNELCAweDAxKTogYGVsZXZhdGlvbmFuZ2xlYAogICAqICAqIEdhaW4gKDB4M0QsIDB4MDIpOiBgZ2FpbmAKICAgKiAgKiBEaXN0YW5jZSBSYXRpbyAoMHgzRCwgMHgwMyk6IGBkaXN0YW5jZXJhdGlvYAogICAqICAqIE1heGltdW0gRGlzdGFuY2UgKDB4M0QsIDB4MDQpOiBgbWF4aW11bWRpc3RhbmNlYAogICAqICAqIE1heGltdW0gRGlzdGFuY2UgR2FpbiAoMHgzRCwgMHgwNSk6IGBtYXhpbXVtZGlzdGFuY2VnYWluYAogICAqICAqIFJlZmVyZW5jZSBEaXN0YW5jZSBSYXRpbyAoMHgzRCwgMHgwNik6IGByZWZlcmVuY2VkaXN0YW5jZXJhdGlvYAogICAqICAqIFBhbiBTcHJlYWQgQW5nbGUgKDB4M0QsIDB4MDcpOiBgcGFuc3ByZWFkYW5nbGVgCiAgICogICogUm9sbCBBbmdsZSAoMHgzRCwgMHgwOCk6IGByb2xsYW5nbGVgCiAgICoKICAgKiBAbWV0aG9kIGRlY3JlbWVudFJlZ2lzdGVyZWRQYXJhbWV0ZXIKICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0gcGFyYW1ldGVyIHtTdHJpbmd8QXJyYXl9IEEgc3RyaW5nIGlkZW50aWZ5aW5nIHRoZSBwYXJhbWV0ZXIicyBuYW1lIChzZWUgYWJvdmUpIG9yIGEKICAgKiB0d28tcG9zaXRpb24gYXJyYXkgc3BlY2lmeWluZyB0aGUgdHdvIGNvbnRyb2wgYnl0ZXMgKDB4NjUsIDB4NjQpIHRoYXQgaWRlbnRpZnkgdGhlIHJlZ2lzdGVyZWQKICAgKiBwYXJhbWV0ZXIuCiAgICoKICAgKiBAcGFyYW0gW2NoYW5uZWw9YWxsXSB7TnVtYmVyfEFycmF5fFN0cmluZ30gVGhlIE1JREkgY2hhbm5lbCBudW1iZXIgKGJldHdlZW4gMSBhbmQgMTYpIG9yIGFuCiAgICogYXJyYXkgb2YgY2hhbm5lbCBudW1iZXJzLiBJZiB0aGUgc3BlY2lhbCB2YWx1ZSAiYWxsIiBpcyB1c2VkLCB0aGUgbWVzc2FnZSB3aWxsIGJlIHNlbnQgdG8gYWxsCiAgICogMTYgY2hhbm5lbHMuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dCiAgICoKICAgKiBAcGFyYW0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB8U3RyaW5nfSBbb3B0aW9ucy50aW1lPXVuZGVmaW5lZF0gVGhpcyB2YWx1ZSBjYW4gYmUgb25lIG9mIHR3bwogICAqIHRoaW5ncy4gSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHN0YXJ0aW5nIHdpdGggdGhlICsgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsIHRoZSByZXF1ZXN0CiAgICogd2lsbCBiZSBkZWxheWVkIGJ5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIChpbiBtaWxsaXNlY29uZHMpLiBPdGhlcndpc2UsIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEKICAgKiB0aW1lc3RhbXAgYW5kIHRoZSByZXF1ZXN0IHdpbGwgYmUgc2NoZWR1bGVkIGF0IHRoYXQgdGltZXN0YW1wLiBUaGUgYERPTUhpZ2hSZXNUaW1lU3RhbXBgIHZhbHVlCiAgICogaXMgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LiBUbyByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lLCB5b3UgY2FuIHVzZQogICAqIGBXZWJNaWRpLnRpbWVgLiBJZiBgdGltZWAgaXMgbm90IHByZXNlbnQgb3IgaXMgc2V0IHRvIGEgdGltZSBpbiB0aGUgcGFzdCwgdGhlIHJlcXVlc3QgaXMgdG8gYmUKICAgKiBzZW50IGFzIHNvb24gYXMgcG9zc2libGUuCiAgICoKICAgKiBAdGhyb3dzIFR5cGVFcnJvciBUaGUgc3BlY2lmaWVkIHBhcmFtZXRlciBpcyBub3QgYXZhaWxhYmxlLgogICAqCiAgICogQHJldHVybnMge091dHB1dH0gUmV0dXJucyB0aGUgYE91dHB1dGAgb2JqZWN0IHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICovCgoKICBPdXRwdXQucHJvdG90eXBlLmRlY3JlbWVudFJlZ2lzdGVyZWRQYXJhbWV0ZXIgPSBmdW5jdGlvbiAocGFyYW1ldGVyLCBjaGFubmVsLCBvcHRpb25zKSB7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICBpZiAoIUFycmF5LmlzQXJyYXkocGFyYW1ldGVyKSkgewogICAgICBpZiAoIXdtLk1JRElfUkVHSVNURVJFRF9QQVJBTUVURVJbcGFyYW1ldGVyXSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlRoZSBzcGVjaWZpZWQgcGFyYW1ldGVyIGlzIG5vdCBhdmFpbGFibGUuIik7CiAgICAgIH0KCiAgICAgIHBhcmFtZXRlciA9IHdtLk1JRElfUkVHSVNURVJFRF9QQVJBTUVURVJbcGFyYW1ldGVyXTsKICAgIH0KCiAgICB3bS50b01JRElDaGFubmVscyhjaGFubmVsKS5mb3JFYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5fc2VsZWN0UmVnaXN0ZXJlZFBhcmFtZXRlcihwYXJhbWV0ZXIsIGNoYW5uZWwsIG9wdGlvbnMudGltZSk7CgogICAgICB0aGlzLnNlbmRDb250cm9sQ2hhbmdlKDB4NjEsIDAsIGNoYW5uZWwsIHsKICAgICAgICB0aW1lOiBvcHRpb25zLnRpbWUKICAgICAgfSk7CgogICAgICB0aGlzLl9kZXNlbGVjdFJlZ2lzdGVyZWRQYXJhbWV0ZXIoY2hhbm5lbCwgb3B0aW9ucy50aW1lKTsKICAgIH0uYmluZCh0aGlzKSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIFNlbmRzIGEgcGl0Y2ggYmVuZCByYW5nZSBtZXNzYWdlIHRvIHRoZSBzcGVjaWZpZWQgY2hhbm5lbChzKSBhdCB0aGUgc2NoZWR1bGVkIHRpbWUgc28gdGhhdCB0aGV5CiAgICogYWRqdXN0IHRoZSByYW5nZSB1c2VkIGJ5IHRoZWlyIHBpdGNoIGJlbmQgbGV2ZXIuIFRoZSByYW5nZSBjYW4gYmUgc3BlY2lmaWVkIHdpdGggdGhlCiAgICogYHNlbWl0b25lc2AgcGFyYW1ldGVyLCB0aGUgYGNlbnRzYCBwYXJhbWV0ZXIgb3IgYnkgc3BlY2lmeWluZyBib3RoIHBhcmFtZXRlcnMgYXQgdGhlIHNhbWUgdGltZS4KICAgKgogICAqIEBtZXRob2Qgc2V0UGl0Y2hCZW5kUmFuZ2UKICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0gW3NlbWl0b25lcz0wXSB7TnVtYmVyfSBUaGUgZGVzaXJlZCBhZGp1c3RtZW50IHZhbHVlIGluIHNlbWl0b25lcyAoaW50ZWdlciBiZXR3ZWVuCiAgICogMC0xMjcpLiBXaGlsZSBub3RoaW5nIGltcG9zZXMgdGhhdCBpbiB0aGUgc3BlY2lmaWNhdGlvbiwgaXQgaXMgdmVyeSBjb21tb24gZm9yIG1hbnVmYWN0dXJlcnMgdG8KICAgKiBsaW1pdCB0aGUgcmFuZ2UgdG8gMiBvY3RhdmVzICgtMTIgc2VtaXRvbmVzIHRvIDEyIHNlbWl0b25lcykuCiAgICoKICAgKiBAcGFyYW0gW2NlbnRzPTBdIHtOdW1iZXJ9IFRoZSBkZXNpcmVkIGFkanVzdG1lbnQgdmFsdWUgaW4gY2VudHMgKGludGVnZXIgYmV0d2VlbiAwLTEyNykuCiAgICoKICAgKiBAcGFyYW0gW2NoYW5uZWw9YWxsXSB7TnVtYmVyfEFycmF5fFN0cmluZ30gVGhlIE1JREkgY2hhbm5lbCBudW1iZXIgKGJldHdlZW4gMSBhbmQgMTYpIG9yIGFuCiAgICogYXJyYXkgb2YgY2hhbm5lbCBudW1iZXJzLiBJZiB0aGUgc3BlY2lhbCB2YWx1ZSAiYWxsIiBpcyB1c2VkLCB0aGUgbWVzc2FnZSB3aWxsIGJlIHNlbnQgdG8gYWxsCiAgICogMTYgY2hhbm5lbHMuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dCiAgICoKICAgKiBAcGFyYW0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB8U3RyaW5nfSBbb3B0aW9ucy50aW1lPXVuZGVmaW5lZF0gVGhpcyB2YWx1ZSBjYW4gYmUgb25lIG9mIHR3bwogICAqIHRoaW5ncy4gSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHN0YXJ0aW5nIHdpdGggdGhlICsgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsIHRoZSByZXF1ZXN0CiAgICogd2lsbCBiZSBkZWxheWVkIGJ5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIChpbiBtaWxsaXNlY29uZHMpLiBPdGhlcndpc2UsIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEKICAgKiB0aW1lc3RhbXAgYW5kIHRoZSByZXF1ZXN0IHdpbGwgYmUgc2NoZWR1bGVkIGF0IHRoYXQgdGltZXN0YW1wLiBUaGUgYERPTUhpZ2hSZXNUaW1lU3RhbXBgIHZhbHVlCiAgICogaXMgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LiBUbyByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lLCB5b3UgY2FuIHVzZQogICAqIGBXZWJNaWRpLnRpbWVgLiBJZiBgdGltZWAgaXMgbm90IHByZXNlbnQgb3IgaXMgc2V0IHRvIGEgdGltZSBpbiB0aGUgcGFzdCwgdGhlIHJlcXVlc3QgaXMgdG8gYmUKICAgKiBzZW50IGFzIHNvb24gYXMgcG9zc2libGUuCiAgICoKICAgKiBAdGhyb3dzIHtSYW5nZUVycm9yfSBUaGUgc2VtaXRvbmVzIHZhbHVlIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxMjcuCiAgICogQHRocm93cyB7UmFuZ2VFcnJvcn0gVGhlIGNlbnRzIHZhbHVlIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxMjcuCiAgICoKICAgKiBAcmV0dXJuIHtPdXRwdXR9IFJldHVybnMgdGhlIGBPdXRwdXRgIG9iamVjdCBzbyBtZXRob2RzIGNhbiBiZSBjaGFpbmVkLgogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5zZXRQaXRjaEJlbmRSYW5nZSA9IGZ1bmN0aW9uIChzZW1pdG9uZXMsIGNlbnRzLCBjaGFubmVsLCBvcHRpb25zKSB7CiAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHNlbWl0b25lcyA9IE1hdGguZmxvb3Ioc2VtaXRvbmVzKSB8fCAwOwoKICAgIGlmICghKHNlbWl0b25lcyA+PSAwICYmIHNlbWl0b25lcyA8PSAxMjcpKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJUaGUgc2VtaXRvbmVzIHZhbHVlIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxMjciKTsKICAgIH0KCiAgICBjZW50cyA9IE1hdGguZmxvb3IoY2VudHMpIHx8IDA7CgogICAgaWYgKCEoY2VudHMgPj0gMCAmJiBjZW50cyA8PSAxMjcpKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJUaGUgY2VudHMgdmFsdWUgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDEyNyIpOwogICAgfQoKICAgIHdtLnRvTUlESUNoYW5uZWxzKGNoYW5uZWwpLmZvckVhY2goZnVuY3Rpb24gKCkgewogICAgICB0aGF0LnNldFJlZ2lzdGVyZWRQYXJhbWV0ZXIoInBpdGNoYmVuZHJhbmdlIiwgW3NlbWl0b25lcywgY2VudHNdLCBjaGFubmVsLCB7CiAgICAgICAgdGltZTogb3B0aW9ucy50aW1lCiAgICAgIH0pOwogICAgfSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIFNlbmRzIGEgbW9kdWxhdGlvbiBkZXB0aCByYW5nZSBtZXNzYWdlIHRvIHRoZSBzcGVjaWZpZWQgY2hhbm5lbChzKSBzbyB0aGF0IHRoZXkgYWRqdXN0IHRoZQogICAqIGRlcHRoIG9mIHRoZWlyIG1vZHVsYXRpb24gd2hlZWwicyByYW5nZS4gVGhlIHJhbmdlIGNhbiBiZSBzcGVjaWZpZWQgd2l0aCB0aGUgYHNlbWl0b25lc2AKICAgKiBwYXJhbWV0ZXIsIHRoZSBgY2VudHNgIHBhcmFtZXRlciBvciBieSBzcGVjaWZ5aW5nIGJvdGggcGFyYW1ldGVycyBhdCB0aGUgc2FtZSB0aW1lLgogICAqCiAgICogQG1ldGhvZCBzZXRNb2R1bGF0aW9uUmFuZ2UKICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0gW3NlbWl0b25lcz0wXSB7TnVtYmVyfSBUaGUgZGVzaXJlZCBhZGp1c3RtZW50IHZhbHVlIGluIHNlbWl0b25lcyAoaW50ZWdlciBiZXR3ZWVuCiAgICogMC0xMjcpLgogICAqCiAgICogQHBhcmFtIFtjZW50cz0wXSB7TnVtYmVyfSBUaGUgZGVzaXJlZCBhZGp1c3RtZW50IHZhbHVlIGluIGNlbnRzICgwLTEyNykuCiAgICoKICAgKiBAcGFyYW0gW2NoYW5uZWw9YWxsXSB7TnVtYmVyfEFycmF5fFN0cmluZ30gVGhlIE1JREkgY2hhbm5lbCBudW1iZXIgKGJldHdlZW4gMSBhbmQgMTYpIG9yIGFuCiAgICogYXJyYXkgb2YgY2hhbm5lbCBudW1iZXJzLiBJZiB0aGUgc3BlY2lhbCB2YWx1ZSAiYWxsIiBpcyB1c2VkLCB0aGUgbWVzc2FnZSB3aWxsIGJlIHNlbnQgdG8gYWxsCiAgICogMTYgY2hhbm5lbHMuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dCiAgICoKICAgKiBAcGFyYW0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB8U3RyaW5nfSBbb3B0aW9ucy50aW1lPXVuZGVmaW5lZF0gVGhpcyB2YWx1ZSBjYW4gYmUgb25lIG9mIHR3bwogICAqIHRoaW5ncy4gSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHN0YXJ0aW5nIHdpdGggdGhlICsgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsIHRoZSByZXF1ZXN0CiAgICogd2lsbCBiZSBkZWxheWVkIGJ5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIChpbiBtaWxsaXNlY29uZHMpLiBPdGhlcndpc2UsIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEKICAgKiB0aW1lc3RhbXAgYW5kIHRoZSByZXF1ZXN0IHdpbGwgYmUgc2NoZWR1bGVkIGF0IHRoYXQgdGltZXN0YW1wLiBUaGUgYERPTUhpZ2hSZXNUaW1lU3RhbXBgIHZhbHVlCiAgICogaXMgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LiBUbyByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lLCB5b3UgY2FuIHVzZQogICAqIGBXZWJNaWRpLnRpbWVgLiBJZiBgdGltZWAgaXMgbm90IHByZXNlbnQgb3IgaXMgc2V0IHRvIGEgdGltZSBpbiB0aGUgcGFzdCwgdGhlIHJlcXVlc3QgaXMgdG8gYmUKICAgKiBzZW50IGFzIHNvb24gYXMgcG9zc2libGUuCiAgICoKICAgKiBAdGhyb3dzIHtSYW5nZUVycm9yfSBUaGUgc2VtaXRvbmVzIHZhbHVlIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxMjcuCiAgICogQHRocm93cyB7UmFuZ2VFcnJvcn0gVGhlIGNlbnRzIHZhbHVlIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxMjcuCiAgICoKICAgKiBAcmV0dXJuIHtPdXRwdXR9IFJldHVybnMgdGhlIGBPdXRwdXRgIG9iamVjdCBzbyBtZXRob2RzIGNhbiBiZSBjaGFpbmVkLgogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5zZXRNb2R1bGF0aW9uUmFuZ2UgPSBmdW5jdGlvbiAoc2VtaXRvbmVzLCBjZW50cywgY2hhbm5lbCwgb3B0aW9ucykgewogICAgdmFyIHRoYXQgPSB0aGlzOwogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICBzZW1pdG9uZXMgPSBNYXRoLmZsb29yKHNlbWl0b25lcykgfHwgMDsKCiAgICBpZiAoIShzZW1pdG9uZXMgPj0gMCAmJiBzZW1pdG9uZXMgPD0gMTI3KSkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigiVGhlIHNlbWl0b25lcyB2YWx1ZSBtdXN0IGJlIGJldHdlZW4gMCBhbmQgMTI3Iik7CiAgICB9CgogICAgY2VudHMgPSBNYXRoLmZsb29yKGNlbnRzKSB8fCAwOwoKICAgIGlmICghKGNlbnRzID49IDAgJiYgY2VudHMgPD0gMTI3KSkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigiVGhlIGNlbnRzIHZhbHVlIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxMjciKTsKICAgIH0KCiAgICB3bS50b01JRElDaGFubmVscyhjaGFubmVsKS5mb3JFYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgdGhhdC5zZXRSZWdpc3RlcmVkUGFyYW1ldGVyKCJtb2R1bGF0aW9ucmFuZ2UiLCBbc2VtaXRvbmVzLCBjZW50c10sIGNoYW5uZWwsIHsKICAgICAgICB0aW1lOiBvcHRpb25zLnRpbWUKICAgICAgfSk7CiAgICB9KTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgLyoqCiAgICogU2VuZHMgYSBtYXN0ZXIgdHVuaW5nIG1lc3NhZ2UgdG8gdGhlIHNwZWNpZmllZCBjaGFubmVsKHMpLiBUaGUgdmFsdWUgaXMgZGVjaW1hbCBhbmQgbXVzdCBiZQogICAqIGxhcmdlciB0aGFuIC02NSBzZW1pdG9uZXMgYW5kIHNtYWxsZXIgdGhhbiA2NCBzZW1pdG9uZXMuCiAgICoKICAgKiA+QmVjYXVzZSBvZiB0aGUgd2F5IHRoZSBNSURJIHNwZWNpZmljYXRpb24gd29ya3MsIHRoZSBkZWNpbWFsIHBvcnRpb24gb2YgdGhlIHZhbHVlIHdpbGwgYmUKICAgKiA+ZW5jb2RlZCB3aXRoIGEgcmVzb2x1dGlvbiBvZiAxNGJpdC4gVGhlIGludGVnZXIgcG9ydGlvbiBtdXN0IGJlIGJldHdlZW4gLTY0IGFuZCA2MwogICAqID5pbmNsdXNpdmVseS4gRm9yIHRob3NlIGZhbWlsaWFyIHdpdGggdGhlIE1JREkgcHJvdG9jb2wsIHRoaXMgZnVuY3Rpb24gYWN0dWFsbHkgZ2VuZXJhdGVzCiAgICogPioqTWFzdGVyIENvYXJzZSBUdW5pbmcqKiBhbmQgKipNYXN0ZXIgRmluZSBUdW5pbmcqKiBSUE4gbWVzc2FnZXMuCiAgICoKICAgKiBAbWV0aG9kIHNldE1hc3RlclR1bmluZwogICAqIEBjaGFpbmFibGUKICAgKgogICAqIEBwYXJhbSBbdmFsdWU9MC4wXSB7TnVtYmVyfSBUaGUgZGVzaXJlZCBkZWNpbWFsIGFkanVzdG1lbnQgdmFsdWUgaW4gc2VtaXRvbmVzICgtNjUgPCB4IDwgNjQpCiAgICoKICAgKiBAcGFyYW0gW2NoYW5uZWw9YWxsXSB7TnVtYmVyfEFycmF5fFN0cmluZ30gVGhlIE1JREkgY2hhbm5lbCBudW1iZXIgKGJldHdlZW4gMSBhbmQgMTYpIG9yIGFuCiAgICogYXJyYXkgb2YgY2hhbm5lbCBudW1iZXJzLiBJZiB0aGUgc3BlY2lhbCB2YWx1ZSAiYWxsIiBpcyB1c2VkLCB0aGUgbWVzc2FnZSB3aWxsIGJlIHNlbnQgdG8gYWxsCiAgICogMTYgY2hhbm5lbHMuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dCiAgICoKICAgKiBAcGFyYW0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB8U3RyaW5nfSBbb3B0aW9ucy50aW1lPXVuZGVmaW5lZF0gVGhpcyB2YWx1ZSBjYW4gYmUgb25lIG9mIHR3bwogICAqIHRoaW5ncy4gSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHN0YXJ0aW5nIHdpdGggdGhlICsgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsIHRoZSByZXF1ZXN0CiAgICogd2lsbCBiZSBkZWxheWVkIGJ5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIChpbiBtaWxsaXNlY29uZHMpLiBPdGhlcndpc2UsIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEKICAgKiB0aW1lc3RhbXAgYW5kIHRoZSByZXF1ZXN0IHdpbGwgYmUgc2NoZWR1bGVkIGF0IHRoYXQgdGltZXN0YW1wLiBUaGUgYERPTUhpZ2hSZXNUaW1lU3RhbXBgIHZhbHVlCiAgICogaXMgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LiBUbyByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lLCB5b3UgY2FuIHVzZQogICAqIGBXZWJNaWRpLnRpbWVgLiBJZiBgdGltZWAgaXMgbm90IHByZXNlbnQgb3IgaXMgc2V0IHRvIGEgdGltZSBpbiB0aGUgcGFzdCwgdGhlIHJlcXVlc3QgaXMgdG8gYmUKICAgKiBzZW50IGFzIHNvb24gYXMgcG9zc2libGUuCiAgICoKICAgKiBAdGhyb3dzIHtSYW5nZUVycm9yfSBUaGUgdmFsdWUgbXVzdCBiZSBhIGRlY2ltYWwgbnVtYmVyIGJldHdlZW4gbGFyZ2VyIHRoYW4gLTY1IGFuZCBzbWFsbGVyCiAgICogdGhhbiA2NC4KICAgKgogICAqIEByZXR1cm4ge091dHB1dH0gUmV0dXJucyB0aGUgYE91dHB1dGAgb2JqZWN0IHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICovCgoKICBPdXRwdXQucHJvdG90eXBlLnNldE1hc3RlclR1bmluZyA9IGZ1bmN0aW9uICh2YWx1ZSwgY2hhbm5lbCwgb3B0aW9ucykgewogICAgdmFyIHRoYXQgPSB0aGlzOwogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB2YWx1ZSA9IHBhcnNlRmxvYXQodmFsdWUpIHx8IDAuMDsKCiAgICBpZiAodmFsdWUgPD0gLTY1IHx8IHZhbHVlID49IDY0KSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJUaGUgdmFsdWUgbXVzdCBiZSBhIGRlY2ltYWwgbnVtYmVyIGxhcmdlciB0aGFuIC02NSBhbmQgc21hbGxlciB0aGFuIDY0LiIpOwogICAgfQoKICAgIHZhciBjb2Fyc2UgPSBNYXRoLmZsb29yKHZhbHVlKSArIDY0OwogICAgdmFyIGZpbmUgPSB2YWx1ZSAtIE1hdGguZmxvb3IodmFsdWUpOyAvLyBDYWxjdWxhdGUgTVNCIGFuZCBMU0IgZm9yIGZpbmUgYWRqdXN0bWVudCAoMTRiaXQgcmVzb2x1dGlvbikKCiAgICBmaW5lID0gTWF0aC5yb3VuZCgoZmluZSArIDEpIC8gMiAqIDE2MzgzKTsKICAgIHZhciBtc2IgPSBmaW5lID4+IDcgJiAweDdGOwogICAgdmFyIGxzYiA9IGZpbmUgJiAweDdGOwogICAgd20udG9NSURJQ2hhbm5lbHMoY2hhbm5lbCkuZm9yRWFjaChmdW5jdGlvbiAoKSB7CiAgICAgIHRoYXQuc2V0UmVnaXN0ZXJlZFBhcmFtZXRlcigiY2hhbm5lbGNvYXJzZXR1bmluZyIsIGNvYXJzZSwgY2hhbm5lbCwgewogICAgICAgIHRpbWU6IG9wdGlvbnMudGltZQogICAgICB9KTsKICAgICAgdGhhdC5zZXRSZWdpc3RlcmVkUGFyYW1ldGVyKCJjaGFubmVsZmluZXR1bmluZyIsIFttc2IsIGxzYl0sIGNoYW5uZWwsIHsKICAgICAgICB0aW1lOiBvcHRpb25zLnRpbWUKICAgICAgfSk7CiAgICB9KTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgLyoqCiAgICogU2V0cyB0aGUgTUlESSB0dW5pbmcgcHJvZ3JhbSB0byB1c2UuIE5vdGUgdGhhdCB0aGUgKipUdW5pbmcgUHJvZ3JhbSoqIHBhcmFtZXRlciBpcyBwYXJ0IG9mIHRoZQogICAqICpNSURJIFR1bmluZyBTdGFuZGFyZCosIHdoaWNoIGlzIG5vdCB3aWRlbHkgaW1wbGVtZW50ZWQuCiAgICoKICAgKiBAbWV0aG9kIHNldFR1bmluZ1Byb2dyYW0KICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0gdmFsdWUge051bWJlcn0gVGhlIGRlc2lyZWQgdHVuaW5nIHByb2dyYW0gKDAtMTI3KS4KICAgKgogICAqIEBwYXJhbSBbY2hhbm5lbD1hbGxdIHtOdW1iZXJ8QXJyYXl8U3RyaW5nfSBUaGUgTUlESSBjaGFubmVsIG51bWJlciAoYmV0d2VlbiAxIGFuZCAxNikgb3IgYW4KICAgKiBhcnJheSBvZiBjaGFubmVsIG51bWJlcnMuIElmIHRoZSBzcGVjaWFsIHZhbHVlICJhbGwiIGlzIHVzZWQsIHRoZSBtZXNzYWdlIHdpbGwgYmUgc2VudCB0byBhbGwKICAgKiAxNiBjaGFubmVscy4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucz17fV0KICAgKgogICAqIEBwYXJhbSB7RE9NSGlnaFJlc1RpbWVTdGFtcHxTdHJpbmd9IFtvcHRpb25zLnRpbWU9dW5kZWZpbmVkXSBUaGlzIHZhbHVlIGNhbiBiZSBvbmUgb2YgdHdvCiAgICogdGhpbmdzLiBJZiB0aGUgdmFsdWUgaXMgYSBzdHJpbmcgc3RhcnRpbmcgd2l0aCB0aGUgKyBzaWduIGFuZCBmb2xsb3dlZCBieSBhIG51bWJlciwgdGhlIHJlcXVlc3QKICAgKiB3aWxsIGJlIGRlbGF5ZWQgYnkgdGhlIHNwZWNpZmllZCBudW1iZXIgKGluIG1pbGxpc2Vjb25kcykuIE90aGVyd2lzZSwgdGhlIHZhbHVlIGlzIGNvbnNpZGVyZWQgYQogICAqIHRpbWVzdGFtcCBhbmQgdGhlIHJlcXVlc3Qgd2lsbCBiZSBzY2hlZHVsZWQgYXQgdGhhdCB0aW1lc3RhbXAuIFRoZSBgRE9NSGlnaFJlc1RpbWVTdGFtcGAgdmFsdWUKICAgKiBpcyByZWxhdGl2ZSB0byB0aGUgbmF2aWdhdGlvbiBzdGFydCBvZiB0aGUgZG9jdW1lbnQuIFRvIHJldHJpZXZlIHRoZSBjdXJyZW50IHRpbWUsIHlvdSBjYW4gdXNlCiAgICogYFdlYk1pZGkudGltZWAuIElmIGB0aW1lYCBpcyBub3QgcHJlc2VudCBvciBpcyBzZXQgdG8gYSB0aW1lIGluIHRoZSBwYXN0LCB0aGUgcmVxdWVzdCBpcyB0byBiZQogICAqIHNlbnQgYXMgc29vbiBhcyBwb3NzaWJsZS4KICAgKgogICAqIEB0aHJvd3Mge1JhbmdlRXJyb3J9IFRoZSBwcm9ncmFtIHZhbHVlIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxMjcuCiAgICoKICAgKiBAcmV0dXJuIHtPdXRwdXR9IFJldHVybnMgdGhlIGBPdXRwdXRgIG9iamVjdCBzbyBtZXRob2RzIGNhbiBiZSBjaGFpbmVkLgogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5zZXRUdW5pbmdQcm9ncmFtID0gZnVuY3Rpb24gKHZhbHVlLCBjaGFubmVsLCBvcHRpb25zKSB7CiAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHZhbHVlID0gTWF0aC5mbG9vcih2YWx1ZSk7CgogICAgaWYgKCEodmFsdWUgPj0gMCAmJiB2YWx1ZSA8PSAxMjcpKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJUaGUgcHJvZ3JhbSB2YWx1ZSBtdXN0IGJlIGJldHdlZW4gMCBhbmQgMTI3Iik7CiAgICB9CgogICAgd20udG9NSURJQ2hhbm5lbHMoY2hhbm5lbCkuZm9yRWFjaChmdW5jdGlvbiAoKSB7CiAgICAgIHRoYXQuc2V0UmVnaXN0ZXJlZFBhcmFtZXRlcigidHVuaW5ncHJvZ3JhbSIsIHZhbHVlLCBjaGFubmVsLCB7CiAgICAgICAgdGltZTogb3B0aW9ucy50aW1lCiAgICAgIH0pOwogICAgfSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIFNldHMgdGhlIE1JREkgdHVuaW5nIGJhbmsgdG8gdXNlLiBOb3RlIHRoYXQgdGhlICoqVHVuaW5nIEJhbmsqKiBwYXJhbWV0ZXIgaXMgcGFydCBvZiB0aGUKICAgKiAqTUlESSBUdW5pbmcgU3RhbmRhcmQqLCB3aGljaCBpcyBub3Qgd2lkZWx5IGltcGxlbWVudGVkLgogICAqCiAgICogQG1ldGhvZCBzZXRUdW5pbmdCYW5rCiAgICogQGNoYWluYWJsZQogICAqCiAgICogQHBhcmFtIHZhbHVlIHtOdW1iZXJ9IFRoZSBkZXNpcmVkIHR1bmluZyBiYW5rICgwLTEyNykuCiAgICoKICAgKiBAcGFyYW0gW2NoYW5uZWw9YWxsXSB7TnVtYmVyfEFycmF5fFN0cmluZ30gVGhlIE1JREkgY2hhbm5lbCBudW1iZXIgKGJldHdlZW4gMSBhbmQgMTYpIG9yIGFuCiAgICogYXJyYXkgb2YgY2hhbm5lbCBudW1iZXJzLiBJZiB0aGUgc3BlY2lhbCB2YWx1ZSAiYWxsIiBpcyB1c2VkLCB0aGUgbWVzc2FnZSB3aWxsIGJlIHNlbnQgdG8gYWxsCiAgICogMTYgY2hhbm5lbHMuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dCiAgICoKICAgKiBAcGFyYW0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB8U3RyaW5nfSBbb3B0aW9ucy50aW1lPXVuZGVmaW5lZF0gVGhpcyB2YWx1ZSBjYW4gYmUgb25lIG9mIHR3bwogICAqIHRoaW5ncy4gSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHN0YXJ0aW5nIHdpdGggdGhlICsgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsIHRoZSByZXF1ZXN0CiAgICogd2lsbCBiZSBkZWxheWVkIGJ5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIChpbiBtaWxsaXNlY29uZHMpLiBPdGhlcndpc2UsIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEKICAgKiB0aW1lc3RhbXAgYW5kIHRoZSByZXF1ZXN0IHdpbGwgYmUgc2NoZWR1bGVkIGF0IHRoYXQgdGltZXN0YW1wLiBUaGUgYERPTUhpZ2hSZXNUaW1lU3RhbXBgIHZhbHVlCiAgICogaXMgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LiBUbyByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lLCB5b3UgY2FuIHVzZQogICAqIGBXZWJNaWRpLnRpbWVgLiBJZiBgdGltZWAgaXMgbm90IHByZXNlbnQgb3IgaXMgc2V0IHRvIGEgdGltZSBpbiB0aGUgcGFzdCwgdGhlIHJlcXVlc3QgaXMgdG8gYmUKICAgKiBzZW50IGFzIHNvb24gYXMgcG9zc2libGUuCiAgICoKICAgKiBAdGhyb3dzIHtSYW5nZUVycm9yfSBUaGUgYmFuayB2YWx1ZSBtdXN0IGJlIGJldHdlZW4gMCBhbmQgMTI3LgogICAqCiAgICogQHJldHVybiB7T3V0cHV0fSBSZXR1cm5zIHRoZSBgT3V0cHV0YCBvYmplY3Qgc28gbWV0aG9kcyBjYW4gYmUgY2hhaW5lZC4KICAgKi8KCgogIE91dHB1dC5wcm90b3R5cGUuc2V0VHVuaW5nQmFuayA9IGZ1bmN0aW9uICh2YWx1ZSwgY2hhbm5lbCwgb3B0aW9ucykgewogICAgdmFyIHRoYXQgPSB0aGlzOwogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB2YWx1ZSA9IE1hdGguZmxvb3IodmFsdWUpIHx8IDA7CgogICAgaWYgKCEodmFsdWUgPj0gMCAmJiB2YWx1ZSA8PSAxMjcpKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJUaGUgYmFuayB2YWx1ZSBtdXN0IGJlIGJldHdlZW4gMCBhbmQgMTI3Iik7CiAgICB9CgogICAgd20udG9NSURJQ2hhbm5lbHMoY2hhbm5lbCkuZm9yRWFjaChmdW5jdGlvbiAoKSB7CiAgICAgIHRoYXQuc2V0UmVnaXN0ZXJlZFBhcmFtZXRlcigidHVuaW5nYmFuayIsIHZhbHVlLCBjaGFubmVsLCB7CiAgICAgICAgdGltZTogb3B0aW9ucy50aW1lCiAgICAgIH0pOwogICAgfSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIFNlbmRzIGEgTUlESSBgY2hhbm5lbCBtb2RlYCBtZXNzYWdlIHRvIHRoZSBzcGVjaWZpZWQgY2hhbm5lbChzKS4gVGhlIGNoYW5uZWwgbW9kZSBtZXNzYWdlIHRvCiAgICogc2VuZCBjYW4gYmUgc3BlY2lmaWVkIG51bWVyaWNhbGx5IG9yIGJ5IHVzaW5nIG9uZSBvZiB0aGUgZm9sbG93aW5nIGNvbW1vbiBuYW1lczoKICAgKgogICAqICAgKiBgYWxsc291bmRvZmZgICgjMTIwKQogICAqICAgKiBgcmVzZXRhbGxjb250cm9sbGVyc2AgKCMxMjEpCiAgICogICAqIGBsb2NhbGNvbnRyb2xgICgjMTIyKQogICAqICAgKiBgYWxsbm90ZXNvZmZgICgjMTIzKQogICAqICAgKiBgb21uaW1vZGVvZmZgICgjMTI0KQogICAqICAgKiBgb21uaW1vZGVvbmAgKCMxMjUpCiAgICogICAqIGBtb25vbW9kZW9uYCAoIzEyNikKICAgKiAgICogYHBvbHltb2Rlb25gICgjMTI3KQogICAqCiAgICogSXQgc2hvdWxkIGJlIG5vdGVkIHRoYXQsIHBlciB0aGUgTUlESSBzcGVjaWZpY2F0aW9uLCBvbmx5IGBsb2NhbGNvbnRyb2xgIGFuZCBgbW9ub21vZGVvbmAgbWF5CiAgICogcmVxdWlyZSBhIHZhbHVlIHRoYXQicyBub3QgemVyby4gRm9yIHRoYXQgcmVhc29uLCB0aGUgYHZhbHVlYCBwYXJhbWV0ZXIgaXMgb3B0aW9uYWwgYW5kCiAgICogZGVmYXVsdHMgdG8gMC4KICAgKgogICAqIEBtZXRob2Qgc2VuZENoYW5uZWxNb2RlCiAgICogQGNoYWluYWJsZQogICAqCiAgICogQHBhcmFtIGNvbW1hbmQge051bWJlcnxTdHJpbmd9IFRoZSBudW1lcmljYWwgaWRlbnRpZmllciBvZiB0aGUgY2hhbm5lbCBtb2RlIG1lc3NhZ2UgKGludGVnZXIKICAgKiBiZXR3ZWVuIDEyMC0xMjcpIG9yIGl0cyBuYW1lIGFzIGEgc3RyaW5nLgogICAqIEBwYXJhbSBbdmFsdWU9MF0ge051bWJlcn0gVGhlIHZhbHVlIHRvIHNlbmQgKGludGVnZXIgYmV0d2VlbiAwLTEyNykuCiAgICogQHBhcmFtIFtjaGFubmVsPWFsbF0ge051bWJlcnxBcnJheXxTdHJpbmd9IFRoZSBNSURJIGNoYW5uZWwgbnVtYmVyIChiZXR3ZWVuIDEgYW5kIDE2KSBvciBhbgogICAqIGFycmF5IG9mIGNoYW5uZWwgbnVtYmVycy4gSWYgdGhlIHNwZWNpYWwgdmFsdWUgImFsbCIgaXMgdXNlZCwgdGhlIG1lc3NhZ2Ugd2lsbCBiZSBzZW50IHRvIGFsbAogICAqIDE2IGNoYW5uZWxzLgogICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucz17fV0KICAgKiBAcGFyYW0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB8U3RyaW5nfSBbb3B0aW9ucy50aW1lPXVuZGVmaW5lZF0gVGhpcyB2YWx1ZSBjYW4gYmUgb25lIG9mIHR3bwogICAqIHRoaW5ncy4gSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHN0YXJ0aW5nIHdpdGggdGhlICsgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsIHRoZSByZXF1ZXN0CiAgICogd2lsbCBiZSBkZWxheWVkIGJ5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIChpbiBtaWxsaXNlY29uZHMpLiBPdGhlcndpc2UsIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEKICAgKiB0aW1lc3RhbXAgYW5kIHRoZSByZXF1ZXN0IHdpbGwgYmUgc2NoZWR1bGVkIGF0IHRoYXQgdGltZXN0YW1wLiBUaGUgYERPTUhpZ2hSZXNUaW1lU3RhbXBgIHZhbHVlCiAgICogaXMgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LiBUbyByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lLCB5b3UgY2FuIHVzZQogICAqIGBXZWJNaWRpLnRpbWVgLiBJZiBgdGltZWAgaXMgbm90IHByZXNlbnQgb3IgaXMgc2V0IHRvIGEgdGltZSBpbiB0aGUgcGFzdCwgdGhlIHJlcXVlc3QgaXMgdG8gYmUKICAgKiBzZW50IGFzIHNvb24gYXMgcG9zc2libGUuCiAgICoKICAgKiBAdGhyb3dzIHtUeXBlRXJyb3J9IEludmFsaWQgY2hhbm5lbCBtb2RlIG1lc3NhZ2UgbmFtZS4KICAgKiBAdGhyb3dzIHtSYW5nZUVycm9yfSBDaGFubmVsIG1vZGUgY29udHJvbGxlciBudW1iZXJzIG11c3QgYmUgYmV0d2VlbiAxMjAgYW5kIDEyNy4KICAgKiBAdGhyb3dzIHtSYW5nZUVycm9yfSBWYWx1ZSBtdXN0IGJlIGFuIGludGVnZXIgYmV0d2VlbiAwIGFuZCAxMjcuCiAgICoKICAgKiBAcmV0dXJuIHtPdXRwdXR9IFJldHVybnMgdGhlIGBPdXRwdXRgIG9iamVjdCBzbyBtZXRob2RzIGNhbiBiZSBjaGFpbmVkLgogICAqCiAgICovCgoKICBPdXRwdXQucHJvdG90eXBlLnNlbmRDaGFubmVsTW9kZSA9IGZ1bmN0aW9uIChjb21tYW5kLCB2YWx1ZSwgY2hhbm5lbCwgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgaWYgKHR5cGVvZiBjb21tYW5kID09PSAic3RyaW5nIikgewogICAgICBjb21tYW5kID0gd20uTUlESV9DSEFOTkVMX01PREVfTUVTU0FHRVNbY29tbWFuZF07CgogICAgICBpZiAoIWNvbW1hbmQpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJJbnZhbGlkIGNoYW5uZWwgbW9kZSBtZXNzYWdlIG5hbWUuIik7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGNvbW1hbmQgPSBNYXRoLmZsb29yKGNvbW1hbmQpOwoKICAgICAgaWYgKCEoY29tbWFuZCA+PSAxMjAgJiYgY29tbWFuZCA8PSAxMjcpKSB7CiAgICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIkNoYW5uZWwgbW9kZSBudW1lcmljYWwgaWRlbnRpZmllcnMgbXVzdCBiZSBiZXR3ZWVuIDEyMCBhbmQgMTI3LiIpOwogICAgICB9CiAgICB9CgogICAgdmFsdWUgPSBNYXRoLmZsb29yKHZhbHVlKSB8fCAwOwoKICAgIGlmICh2YWx1ZSA8IDAgfHwgdmFsdWUgPiAxMjcpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIlZhbHVlIG11c3QgYmUgYW4gaW50ZWdlciBiZXR3ZWVuIDAgYW5kIDEyNy4iKTsKICAgIH0KCiAgICB3bS50b01JRElDaGFubmVscyhjaGFubmVsKS5mb3JFYWNoKGZ1bmN0aW9uIChjaCkgewogICAgICB0aGlzLnNlbmQoKHdtLk1JRElfQ0hBTk5FTF9NRVNTQUdFUy5jaGFubmVsbW9kZSA8PCA0KSArIChjaCAtIDEpLCBbY29tbWFuZCwgdmFsdWVdLCB0aGlzLl9wYXJzZVRpbWVQYXJhbWV0ZXIob3B0aW9ucy50aW1lKSk7CiAgICB9LmJpbmQodGhpcykpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBTZW5kcyBhIE1JREkgYHByb2dyYW0gY2hhbmdlYCBtZXNzYWdlIHRvIHRoZSBzcGVjaWZpZWQgY2hhbm5lbChzKSBhdCB0aGUgc2NoZWR1bGVkIHRpbWUuCiAgICoKICAgKiBAbWV0aG9kIHNlbmRQcm9ncmFtQ2hhbmdlCiAgICogQGNoYWluYWJsZQogICAqCiAgICogQHBhcmFtIHByb2dyYW0ge051bWJlcn0gVGhlIE1JREkgcGF0Y2ggKHByb2dyYW0pIG51bWJlciAoMC0xMjcpCiAgICoKICAgKiBAcGFyYW0gW2NoYW5uZWw9YWxsXSB7TnVtYmVyfEFycmF5fFN0cmluZ30gVGhlIE1JREkgY2hhbm5lbCBudW1iZXIgKGJldHdlZW4gMSBhbmQgMTYpIG9yIGFuCiAgICogYXJyYXkgb2YgY2hhbm5lbCBudW1iZXJzLiBJZiB0aGUgc3BlY2lhbCB2YWx1ZSAiYWxsIiBpcyB1c2VkLCB0aGUgbWVzc2FnZSB3aWxsIGJlIHNlbnQgdG8gYWxsCiAgICogMTYgY2hhbm5lbHMuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dCiAgICoKICAgKiBAcGFyYW0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB8U3RyaW5nfSBbb3B0aW9ucy50aW1lPXVuZGVmaW5lZF0gVGhpcyB2YWx1ZSBjYW4gYmUgb25lIG9mIHR3bwogICAqIHRoaW5ncy4gSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHN0YXJ0aW5nIHdpdGggdGhlICsgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsIHRoZSByZXF1ZXN0CiAgICogd2lsbCBiZSBkZWxheWVkIGJ5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIChpbiBtaWxsaXNlY29uZHMpLiBPdGhlcndpc2UsIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEKICAgKiB0aW1lc3RhbXAgYW5kIHRoZSByZXF1ZXN0IHdpbGwgYmUgc2NoZWR1bGVkIGF0IHRoYXQgdGltZXN0YW1wLiBUaGUgYERPTUhpZ2hSZXNUaW1lU3RhbXBgIHZhbHVlCiAgICogaXMgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LiBUbyByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lLCB5b3UgY2FuIHVzZQogICAqIGBXZWJNaWRpLnRpbWVgLiBJZiBgdGltZWAgaXMgbm90IHByZXNlbnQgb3IgaXMgc2V0IHRvIGEgdGltZSBpbiB0aGUgcGFzdCwgdGhlIHJlcXVlc3QgaXMgdG8gYmUKICAgKiBzZW50IGFzIHNvb24gYXMgcG9zc2libGUuCiAgICoKICAgKiBAdGhyb3dzIHtSYW5nZUVycm9yfSBQcm9ncmFtIG51bWJlcnMgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDEyNy4KICAgKgogICAqIEByZXR1cm4ge091dHB1dH0gUmV0dXJucyB0aGUgYE91dHB1dGAgb2JqZWN0IHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICoKICAgKi8KCgogIE91dHB1dC5wcm90b3R5cGUuc2VuZFByb2dyYW1DaGFuZ2UgPSBmdW5jdGlvbiAocHJvZ3JhbSwgY2hhbm5lbCwgb3B0aW9ucykgewogICAgdmFyIHRoYXQgPSB0aGlzOwogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICBwcm9ncmFtID0gTWF0aC5mbG9vcihwcm9ncmFtKTsKCiAgICBpZiAoaXNOYU4ocHJvZ3JhbSkgfHwgcHJvZ3JhbSA8IDAgfHwgcHJvZ3JhbSA+IDEyNykgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigiUHJvZ3JhbSBudW1iZXJzIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxMjcuIik7CiAgICB9CgogICAgd20udG9NSURJQ2hhbm5lbHMoY2hhbm5lbCkuZm9yRWFjaChmdW5jdGlvbiAoY2gpIHsKICAgICAgdGhhdC5zZW5kKCh3bS5NSURJX0NIQU5ORUxfTUVTU0FHRVMucHJvZ3JhbWNoYW5nZSA8PCA0KSArIChjaCAtIDEpLCBbcHJvZ3JhbV0sIHRoYXQuX3BhcnNlVGltZVBhcmFtZXRlcihvcHRpb25zLnRpbWUpKTsKICAgIH0pOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBTZW5kcyBhIE1JREkgYGNoYW5uZWwgYWZ0ZXJ0b3VjaGAgbWVzc2FnZSB0byB0aGUgc3BlY2lmaWVkIGNoYW5uZWwocykuIEZvciBrZXktc3BlY2lmaWMKICAgKiBhZnRlcnRvdWNoLCB5b3Ugc2hvdWxkIGluc3RlYWQgdXNlIGBzZW5kS2V5QWZ0ZXJ0b3VjaCgpYC4KICAgKgogICAqIEBtZXRob2Qgc2VuZENoYW5uZWxBZnRlcnRvdWNoCiAgICogQGNoYWluYWJsZQogICAqCiAgICogQHBhcmFtIFtwcmVzc3VyZT0wLjVdIHtOdW1iZXJ9IFRoZSBwcmVzc3VyZSBsZXZlbCAoYmV0d2VlbiAwIGFuZCAxKS4gQW4gaW52YWxpZCBwcmVzc3VyZSB2YWx1ZQogICAqIHdpbGwgc2lsZW50bHkgdHJpZ2dlciB0aGUgZGVmYXVsdCBiZWhhdmlvdXIuCiAgICoKICAgKiBAcGFyYW0gW2NoYW5uZWw9YWxsXSB7TnVtYmVyfEFycmF5fFN0cmluZ30gIFRoZSBNSURJIGNoYW5uZWwgbnVtYmVyIChiZXR3ZWVuIDEgYW5kIDE2KSBvcgogICAqIGFuIGFycmF5IG9mIGNoYW5uZWwgbnVtYmVycy4gSWYgdGhlIHNwZWNpYWwgdmFsdWUgImFsbCIgaXMgdXNlZCwgdGhlIG1lc3NhZ2Ugd2lsbCBiZSBzZW50IHRvCiAgICogYWxsIDE2IGNoYW5uZWxzLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zPXt9XQogICAqCiAgICogQHBhcmFtIHtET01IaWdoUmVzVGltZVN0YW1wfFN0cmluZ30gW29wdGlvbnMudGltZT11bmRlZmluZWRdIFRoaXMgdmFsdWUgY2FuIGJlIG9uZSBvZiB0d28KICAgKiB0aGluZ3MuIElmIHRoZSB2YWx1ZSBpcyBhIHN0cmluZyBzdGFydGluZyB3aXRoIHRoZSArIHNpZ24gYW5kIGZvbGxvd2VkIGJ5IGEgbnVtYmVyLCB0aGUgcmVxdWVzdAogICAqIHdpbGwgYmUgZGVsYXllZCBieSB0aGUgc3BlY2lmaWVkIG51bWJlciAoaW4gbWlsbGlzZWNvbmRzKS4gT3RoZXJ3aXNlLCB0aGUgdmFsdWUgaXMgY29uc2lkZXJlZCBhCiAgICogdGltZXN0YW1wIGFuZCB0aGUgcmVxdWVzdCB3aWxsIGJlIHNjaGVkdWxlZCBhdCB0aGF0IHRpbWVzdGFtcC4gVGhlIGBET01IaWdoUmVzVGltZVN0YW1wYCB2YWx1ZQogICAqIGlzIHJlbGF0aXZlIHRvIHRoZSBuYXZpZ2F0aW9uIHN0YXJ0IG9mIHRoZSBkb2N1bWVudC4gVG8gcmV0cmlldmUgdGhlIGN1cnJlbnQgdGltZSwgeW91IGNhbiB1c2UKICAgKiBgV2ViTWlkaS50aW1lYC4gSWYgYHRpbWVgIGlzIG5vdCBwcmVzZW50IG9yIGlzIHNldCB0byBhIHRpbWUgaW4gdGhlIHBhc3QsIHRoZSByZXF1ZXN0IGlzIHRvIGJlCiAgICogc2VudCBhcyBzb29uIGFzIHBvc3NpYmxlLgogICAqCiAgICogQHJldHVybiB7T3V0cHV0fSBSZXR1cm5zIHRoZSBgT3V0cHV0YCBvYmplY3Qgc28gbWV0aG9kcyBjYW4gYmUgY2hhaW5lZC4KICAgKi8KCgogIE91dHB1dC5wcm90b3R5cGUuc2VuZENoYW5uZWxBZnRlcnRvdWNoID0gZnVuY3Rpb24gKHByZXNzdXJlLCBjaGFubmVsLCBvcHRpb25zKSB7CiAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHByZXNzdXJlID0gcGFyc2VGbG9hdChwcmVzc3VyZSk7CgogICAgaWYgKGlzTmFOKHByZXNzdXJlKSB8fCBwcmVzc3VyZSA8IDAgfHwgcHJlc3N1cmUgPiAxKSB7CiAgICAgIHByZXNzdXJlID0gMC41OwogICAgfQoKICAgIHZhciBuUHJlc3N1cmUgPSBNYXRoLnJvdW5kKHByZXNzdXJlICogMTI3KTsKICAgIHdtLnRvTUlESUNoYW5uZWxzKGNoYW5uZWwpLmZvckVhY2goZnVuY3Rpb24gKGNoKSB7CiAgICAgIHRoYXQuc2VuZCgod20uTUlESV9DSEFOTkVMX01FU1NBR0VTLmNoYW5uZWxhZnRlcnRvdWNoIDw8IDQpICsgKGNoIC0gMSksIFtuUHJlc3N1cmVdLCB0aGF0Ll9wYXJzZVRpbWVQYXJhbWV0ZXIob3B0aW9ucy50aW1lKSk7CiAgICB9KTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgLyoqCiAgICogU2VuZHMgYSBNSURJIGBwaXRjaCBiZW5kYCBtZXNzYWdlIHRvIHRoZSBzcGVjaWZpZWQgY2hhbm5lbChzKSBhdCB0aGUgc2NoZWR1bGVkIHRpbWUuCiAgICoKICAgKiBAbWV0aG9kIHNlbmRQaXRjaEJlbmQKICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0gYmVuZCB7TnVtYmVyfSBUaGUgaW50ZW5zaXR5IGxldmVsIG9mIHRoZSBiZW5kIChiZXR3ZWVuIC0xIGFuZCAxKS4gQSB2YWx1ZSBvZiB6ZXJvIG1lYW5zCiAgICogbm8gYmVuZC4KICAgKgogICAqIEBwYXJhbSBbY2hhbm5lbD1hbGxdIHtOdW1iZXJ8QXJyYXl8U3RyaW5nfSAgVGhlIE1JREkgY2hhbm5lbCBudW1iZXIgKGJldHdlZW4gMSBhbmQgMTYpIG9yIGFuCiAgICogYXJyYXkgb2YgY2hhbm5lbCBudW1iZXJzLiBJZiB0aGUgc3BlY2lhbCB2YWx1ZSAiYWxsIiBpcyB1c2VkLCB0aGUgbWVzc2FnZSB3aWxsIGJlIHNlbnQgdG8gYWxsCiAgICogMTYgY2hhbm5lbHMuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dCiAgICoKICAgKiBAcGFyYW0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB8U3RyaW5nfSBbb3B0aW9ucy50aW1lPXVuZGVmaW5lZF0gVGhpcyB2YWx1ZSBjYW4gYmUgb25lIG9mIHR3bwogICAqIHRoaW5ncy4gSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHN0YXJ0aW5nIHdpdGggdGhlICsgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsIHRoZSByZXF1ZXN0CiAgICogd2lsbCBiZSBkZWxheWVkIGJ5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIChpbiBtaWxsaXNlY29uZHMpLiBPdGhlcndpc2UsIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEKICAgKiB0aW1lc3RhbXAgYW5kIHRoZSByZXF1ZXN0IHdpbGwgYmUgc2NoZWR1bGVkIGF0IHRoYXQgdGltZXN0YW1wLiBUaGUgYERPTUhpZ2hSZXNUaW1lU3RhbXBgIHZhbHVlCiAgICogaXMgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LiBUbyByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lLCB5b3UgY2FuIHVzZQogICAqIGBXZWJNaWRpLnRpbWVgLiBJZiBgdGltZWAgaXMgbm90IHByZXNlbnQgb3IgaXMgc2V0IHRvIGEgdGltZSBpbiB0aGUgcGFzdCwgdGhlIHJlcXVlc3QgaXMgdG8gYmUKICAgKiBzZW50IGFzIHNvb24gYXMgcG9zc2libGUuCiAgICoKICAgKiBAdGhyb3dzIHtSYW5nZUVycm9yfSBQaXRjaCBiZW5kIHZhbHVlIG11c3QgYmUgYmV0d2VlbiAtMSBhbmQgMS4KICAgKgogICAqIEByZXR1cm4ge091dHB1dH0gUmV0dXJucyB0aGUgYE91dHB1dGAgb2JqZWN0IHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICovCgoKICBPdXRwdXQucHJvdG90eXBlLnNlbmRQaXRjaEJlbmQgPSBmdW5jdGlvbiAoYmVuZCwgY2hhbm5lbCwgb3B0aW9ucykgewogICAgdmFyIHRoYXQgPSB0aGlzOwogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgaWYgKGlzTmFOKGJlbmQpIHx8IGJlbmQgPCAtMSB8fCBiZW5kID4gMSkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigiUGl0Y2ggYmVuZCB2YWx1ZSBtdXN0IGJlIGJldHdlZW4gLTEgYW5kIDEuIik7CiAgICB9CgogICAgdmFyIG5MZXZlbCA9IE1hdGgucm91bmQoKGJlbmQgKyAxKSAvIDIgKiAxNjM4Myk7CiAgICB2YXIgbXNiID0gbkxldmVsID4+IDcgJiAweDdGOwogICAgdmFyIGxzYiA9IG5MZXZlbCAmIDB4N0Y7CiAgICB3bS50b01JRElDaGFubmVscyhjaGFubmVsKS5mb3JFYWNoKGZ1bmN0aW9uIChjaCkgewogICAgICB0aGF0LnNlbmQoKHdtLk1JRElfQ0hBTk5FTF9NRVNTQUdFUy5waXRjaGJlbmQgPDwgNCkgKyAoY2ggLSAxKSwgW2xzYiwgbXNiXSwgdGhhdC5fcGFyc2VUaW1lUGFyYW1ldGVyKG9wdGlvbnMudGltZSkpOwogICAgfSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIFJldHVybnMgYSB0aW1lc3RhbXAsIHJlbGF0aXZlIHRvIHRoZSBuYXZpZ2F0aW9uIHN0YXJ0IG9mIHRoZSBkb2N1bWVudCwgZGVyaXZlZCBmcm9tIHRoZSBgdGltZWAKICAgKiBwYXJhbWV0ZXIuIElmIHRoZSBwYXJhbWV0ZXIgaXMgYSBzdHJpbmcgc3RhcnRpbmcgd2l0aCB0aGUgIisiIHNpZ24gYW5kIGZvbGxvd2VkIGJ5IGEgbnVtYmVyLAogICAqIHRoZSByZXN1bHRpbmcgdmFsdWUgd2lsbCBiZSB0aGUgc3VtIG9mIHRoZSBjdXJyZW50IHRpbWVzdGFtcCBwbHVzIHRoYXQgbnVtYmVyLiBPdGhlcndpc2UsIHRoZQogICAqIHZhbHVlIHdpbGwgYmUgcmV0dXJuZWQgYXMgaXMuCiAgICoKICAgKiBJZiB0aGUgY2FsY3VsYXRlZCByZXR1cm4gdmFsdWUgaXMgMCwgbGVzcyB0aGFuIHplcm8gb3IgYW4gb3RoZXJ3aXNlIGludmFsaWQgdmFsdWUsIGB1bmRlZmluZWRgCiAgICogd2lsbCBiZSByZXR1cm5lZC4KICAgKgogICAqIEBtZXRob2QgX3BhcnNlVGltZVBhcmFtZXRlcgogICAqIEBwYXJhbSBbdGltZV0ge051bWJlcnxTdHJpbmd9CiAgICogQHJldHVybiBET01IaWdoUmVzVGltZVN0YW1wCiAgICogQHByb3RlY3RlZAogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5fcGFyc2VUaW1lUGFyYW1ldGVyID0gZnVuY3Rpb24gKHRpbWUpIHsKICAgIHZhciB2YWx1ZSwKICAgICAgICBwYXJzZWQgPSBwYXJzZUZsb2F0KHRpbWUpOwoKICAgIGlmICh0eXBlb2YgdGltZSA9PT0gInN0cmluZyIgJiYgdGltZS5zdWJzdHJpbmcoMCwgMSkgPT09ICIrIikgewogICAgICBpZiAocGFyc2VkICYmIHBhcnNlZCA+IDApIHZhbHVlID0gd20udGltZSArIHBhcnNlZDsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChwYXJzZWQgPiB3bS50aW1lKSB2YWx1ZSA9IHBhcnNlZDsKICAgIH0KCiAgICByZXR1cm4gdmFsdWU7CiAgfTsKICAvKioKICAgKiBDb252ZXJ0cyBhbiBpbnB1dCB2YWx1ZSAod2hpY2ggY2FuIGJlIGEgdWludCwgYSBzdHJpbmcgb3IgYW4gYXJyYXkgb2YgdGhlIHByZXZpb3VzIHR3bykgdG8gYW4KICAgKiBhcnJheSBvZiBNSURJIG5vdGUgbnVtYmVycy4KICAgKgogICAqIEBtZXRob2QgX2NvbnZlcnROb3RlVG9BcnJheQogICAqIEBwYXJhbSBbbm90ZV0ge051bWJlcnxBcnJheXxTdHJpbmd9CiAgICogQHJldHVybnMge0FycmF5fQogICAqIEBwcm90ZWN0ZWQKICAgKi8KCgogIE91dHB1dC5wcm90b3R5cGUuX2NvbnZlcnROb3RlVG9BcnJheSA9IGZ1bmN0aW9uIChub3RlKSB7CiAgICB2YXIgbm90ZXMgPSBbXTsKCiAgICBpZiAoIUFycmF5LmlzQXJyYXkobm90ZSkpIHsKICAgICAgbm90ZSA9IFtub3RlXTsKICAgIH0KCiAgICBub3RlLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgbm90ZXMucHVzaCh3bS5ndWVzc05vdGVOdW1iZXIoaXRlbSkpOwogICAgfSk7CiAgICByZXR1cm4gbm90ZXM7CiAgfTsgLy8gQ2hlY2sgaWYgUmVxdWlyZUpTL0FNRCBpcyB1c2VkLiBJZiBpdCBpcywgdXNlIGl0IHRvIGRlZmluZSBvdXIgbW9kdWxlIGluc3RlYWQgb2YKICAvLyBwb2xsdXRpbmcgdGhlIGdsb2JhbCBzcGFjZS4KCgogIGlmICh0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIF90eXBlb2YoZGVmaW5lLmFtZCkgPT09ICJvYmplY3QiKSB7CiAgICBkZWZpbmUoW10sIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHdtOwogICAgfSk7CiAgfSBlbHNlIGlmICh0eXBlb2YgbW9kdWxlICE9PSAidW5kZWZpbmVkIiAmJiBtb2R1bGUuZXhwb3J0cykgewogICAgbW9kdWxlLmV4cG9ydHMgPSB3bTsKICB9IGVsc2UgewogICAgaWYgKCFzY29wZS5XZWJNaWRpKSB7CiAgICAgIHNjb3BlLldlYk1pZGkgPSB3bTsKICAgIH0KICB9Cn0pKHRoaXMpOw=="},{"version":3,"sources":["/Users/huntermedlen/Work/WebApps/music-trainer/src/webmidi.js"],"names":["scope","WebMidi","prototype","_singleton","Error","_inputs","_outputs","_userHandlers","_stateChangeQueue","_processingStateChange","_midiInterfaceEvents","_nrpnBuffer","_nrpnEventsEnabled","_nrpnTypes","_notes","_semitones","C","D","E","F","G","A","B","Object","defineProperties","MIDI_SYSTEM_MESSAGES","value","sysex","timecode","songposition","songselect","tuningrequest","sysexend","clock","start","stop","activesensing","reset","midimessage","unknownsystemmessage","writable","enumerable","configurable","MIDI_CHANNEL_MESSAGES","noteoff","noteon","keyaftertouch","controlchange","channelmode","nrpn","programchange","channelaftertouch","pitchbend","MIDI_REGISTERED_PARAMETER","pitchbendrange","channelfinetuning","channelcoarsetuning","tuningprogram","tuningbank","modulationrange","azimuthangle","elevationangle","gain","distanceratio","maximumdistance","maximumdistancegain","referencedistanceratio","panspreadangle","rollangle","MIDI_CONTROL_CHANGE_MESSAGES","bankselectcoarse","modulationwheelcoarse","breathcontrollercoarse","footcontrollercoarse","portamentotimecoarse","dataentrycoarse","volumecoarse","balancecoarse","pancoarse","expressioncoarse","effectcontrol1coarse","effectcontrol2coarse","generalpurposeslider1","generalpurposeslider2","generalpurposeslider3","generalpurposeslider4","bankselectfine","modulationwheelfine","breathcontrollerfine","footcontrollerfine","portamentotimefine","dataentryfine","volumefine","balancefine","panfine","expressionfine","effectcontrol1fine","effectcontrol2fine","holdpedal","portamento","sustenutopedal","softpedal","legatopedal","hold2pedal","soundvariation","resonance","soundreleasetime","soundattacktime","brightness","soundcontrol6","soundcontrol7","soundcontrol8","soundcontrol9","soundcontrol10","generalpurposebutton1","generalpurposebutton2","generalpurposebutton3","generalpurposebutton4","reverblevel","tremololevel","choruslevel","celestelevel","phaserlevel","databuttonincrement","databuttondecrement","nonregisteredparametercoarse","nonregisteredparameterfine","registeredparametercoarse","registeredparameterfine","MIDI_NRPN_MESSAGES","entrymsb","entrylsb","increment","decrement","paramlsb","parammsb","nullactiveparameter","MIDI_CHANNEL_MODE_MESSAGES","allsoundoff","resetallcontrollers","localcontrol","allnotesoff","omnimodeoff","omnimodeon","monomodeon","polymodeon","octaveOffset","supported","get","navigator","enabled","undefined","bind","inputs","outputs","sysexEnabled","nrpnEventsEnabled","set","nrpnTypes","time","performance","now","wm","enable","callback","requestMIDIAccess","then","midiAccess","events","promises","promiseTimeout","_resetInterfaceUserHandlers","onstatechange","e","push","values","input","next","done","open","output","onPortsOpen","clearTimeout","_updateInputsAndOutputs","_onInterfaceStateChange","call","forEach","event","setTimeout","Promise","all","err","console","warn","disable","addListener","type","listener","TypeError","indexOf","hasListener","o","length","removeListener","splice","toMIDIChannels","channel","channels","Array","isArray","map","ch","parseInt","filter","getInputById","id","String","i","getOutputById","getInputByName","name","getOctave","number","Math","floor","getOutputByName","guessNoteNumber","toFixed","round","noteNameToNumber","matches","match","RangeError","semitones","toUpperCase","octave","result","toLowerCase","_updateInputs","_updateOutputs","remove","updated","_midiInput","nInput","add","j","Input","_midiOutput","nOutput","Output","timestamp","timeStamp","port","state","connection","manufacturer","handler","midiInput","that","system","_initializeUserHandlers","onmidimessage","_onMidiMessage","item","on","constructor","every","chNum","listeners","l","prop1","hasOwnProperty","prop2","target","data","_parseChannelEvent","_parseNrpnEvent","_parseSystemEvent","command","channelBufferIndex","data1","data2","ccEvent","controller","getCcNameByNumber","rawData","ev","nrpnNumber","nrpnValue","nrpnControllerType","nrpnEvent","note","velocity","rawVelocity","getChannelModeByNumber","cc","status","cm","song","midiOutput","send","message","parsed","concat","parseFloat","sendSysex","options","_parseTimeParameter","sendTimecodeQuarterFrame","sendSongPosition","msb","lsb","sendSongSelect","sendTuningRequest","sendClock","sendStart","sendContinue","sendStop","sendActiveSensing","sendReset","stopNote","sendChannelMode","nVelocity","isNaN","_convertNoteToArray","playNote","duration","nRelease","release","sendKeyAftertouch","pressure","nPressure","sendControlChange","_selectRegisteredParameter","parameter","_selectNonRegisteredParameter","_setCurrentRegisteredParameter","_deselectRegisteredParameter","setRegisteredParameter","setNonRegisteredParameter","incrementRegisteredParameter","decrementRegisteredParameter","setPitchBendRange","cents","setModulationRange","setMasterTuning","coarse","fine","setTuningProgram","setTuningBank","sendProgramChange","program","sendChannelAftertouch","sendPitchBend","bend","nLevel","substring","notes","define","amd","module","exports"],"mappings":"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","sourcesContent":["(function(scope) {\n\n  \"use strict\";\n\n  /**\n   * The `WebMidi` object makes it easier to work with the Web MIDI API. Basically, it simplifies\n   * two things: sending outgoing MIDI messages and reacting to incoming MIDI messages.\n   *\n   * Sending MIDI messages is done via an `Output` object. All available outputs can be accessed in\n   * the `WebMidi.outputs` array. There is one `Output` object for each output port available on\n   * your system. Similarly, reacting to MIDI messages as they are coming in is simply a matter of\n   * adding a listener to an `Input` object. Similarly, all inputs can be found in the\n   * `WebMidi.inputs` array.\n   *\n   * Please note that a single hardware device might create more than one input and/or output ports.\n   *\n   * #### Sending messages\n   *\n   * To send MIDI messages, you simply need to call the desired method (`playNote()`,\n   * `sendPitchBend()`, `stopNote()`, etc.) from an `Output` object and pass in the appropriate\n   * parameters. All the native MIDI communication will be handled for you. The only additional\n   * thing that needs to be done is to first enable `WebMidi`. Here is an example:\n   *\n   *      WebMidi.enable(function(err) {\n   *        if (err) console.log(\"An error occurred\", err);\n   *        WebMidi.outputs[0].playNote(\"C3\");\n   *      });\n   *\n   * The code above, calls the `WebMidi.enable()` method. Upon success, this method executes the\n   * callback function specified as a parameter. In this case, the callback calls the `playnote()`\n   * function to play a 3rd octave C on the first available output port.\n   *\n   * #### Receiving messages\n   *\n   * Receiving messages is just as easy. You simply have to set a callback function to be triggered\n   * when a specific MIDI message is received. For example, here\"s how to listen for pitch bend\n   * events on the first input port:\n   *\n   *      WebMidi.enable(function(err) {\n   *        if (err) console.log(\"An error occurred\", err);\n   *\n   *        WebMidi.inputs[0].addListener(\"pitchbend\", \"all\", function(e) {\n   *          console.log(\"Pitch value: \" + e.value);\n   *        });\n   *\n   *      });\n   *\n   * As you can see, this library is much easier to use than the native Web MIDI API. No need to\n   * manually craft or decode binary MIDI messages anymore!\n   *\n   * @class WebMidi\n   * @static\n   *\n   * @throws Error WebMidi is a singleton, it cannot be instantiated directly.\n   *\n   * @todo  Switch away from yuidoc (deprecated) to be able to serve doc over https\n   * @todo  Yuidoc does not allow multiple exceptions (@throws) for a single method ?!\n   *\n   */\n  function WebMidi() {\n\n    // Singleton. Prevent instantiation through WebMidi.__proto__.constructor()\n    if (WebMidi.prototype._singleton) {\n      throw new Error(\"WebMidi is a singleton, it cannot be instantiated directly.\");\n    }\n    WebMidi.prototype._singleton = this;\n\n    // MIDI inputs and outputs\n    this._inputs = [];\n    this._outputs = [];\n\n    // Object to hold all user-defined handlers for interface-wide events (connected, disconnected,\n    // etc.)\n    this._userHandlers = {};\n\n    // Array of statechange events to process. These events must be parsed synchronously so they do\n    // not override each other.\n    this._stateChangeQueue = [];\n\n    // Indicates whether we are currently processing a statechange event (in which case new events\n    // are to be queued).\n    this._processingStateChange = false;\n\n    // Events triggered at the interface level (WebMidi)\n    this._midiInterfaceEvents = [\"connected\", \"disconnected\"];\n\n    // the current nrpns being constructed, by channel\n    this._nrpnBuffer = [[],[],[],[], [],[],[],[], [],[],[],[], [],[],[],[]];\n\n    // Enable/Disable NRPN event dispatch\n    this._nrpnEventsEnabled = true;\n\n    // NRPN message types\n    this._nrpnTypes = [\"entry\", \"increment\", \"decrement\"];\n\n    // Notes and semitones for note guessing\n    this._notes = [\"C\", \"C#\", \"D\", \"D#\", \"E\", \"F\", \"F#\", \"G\", \"G#\", \"A\", \"A#\", \"B\"];\n    this._semitones = {C: 0, D: 2, E: 4, F: 5, G: 7, A: 9, B: 11 };\n\n    // Define some \"static\" properties\n    Object.defineProperties(this, {\n\n      /**\n       * [read-only] List of valid MIDI system messages and matching hexadecimal values.\n       *\n       * Note: values 249 and 253 are actually dispatched by the Web MIDI API but I do not know what\n       * they are used for. They are not part of the online\n       * [MIDI 1.0 spec](http://www.midi.org/techspecs/midimessages.php).\n       *\n       * @property MIDI_SYSTEM_MESSAGES\n       * @type Object\n       * @static\n       *\n       * @since 2.0.0\n       */\n      MIDI_SYSTEM_MESSAGES: {\n        value: {\n\n          // System common messages\n          sysex: 0xF0,            // 240\n          timecode: 0xF1,         // 241\n          songposition: 0xF2,     // 242\n          songselect: 0xF3,       // 243\n          tuningrequest: 0xF6,    // 246\n          sysexend: 0xF7,         // 247 (never actually received - simply ends a sysex)\n\n          // System real-time messages\n          clock: 0xF8,            // 248\n          start: 0xFA,            // 250\n          continue: 0xFB,         // 251\n          stop: 0xFC,             // 252\n          activesensing: 0xFE,    // 254\n          reset: 0xFF,            // 255\n\n          // Custom WebMidi.js messages\n          midimessage: 0,\n          unknownsystemmessage: -1\n        },\n        writable: false,\n        enumerable: true,\n        configurable: false\n      },\n\n      /**\n       * [read-only] An object containing properties for each MIDI channel messages and their\n       * associated hexadecimal value.\n       *\n       * @property MIDI_CHANNEL_MESSAGES\n       * @type Object\n       * @static\n       *\n       * @since 2.0.0\n       */\n      MIDI_CHANNEL_MESSAGES: {\n        value: {\n          noteoff: 0x8,           // 8\n          noteon: 0x9,            // 9\n          keyaftertouch: 0xA,     // 10\n          controlchange: 0xB,     // 11\n          channelmode: 0xB,       // 11\n          nrpn: 0xB,              // 11\n          programchange: 0xC,     // 12\n          channelaftertouch: 0xD, // 13\n          pitchbend: 0xE          // 14\n        },\n        writable: false,\n        enumerable: true,\n        configurable: false\n      },\n\n      /**\n       * [read-only] An object containing properties for each registered parameters and their\n       * associated pair of hexadecimal values. MIDI registered parameters extend the original list\n       * of control change messages (a.k.a. CC messages). Currently, there are only a limited number\n       * of them.\n       *\n       * @property MIDI_REGISTERED_PARAMETER\n       * @type Object\n       * @static\n       *\n       * @since 2.0.0\n       */\n      MIDI_REGISTERED_PARAMETER: {\n        value: {\n          pitchbendrange: [0x00, 0x00],\n          channelfinetuning: [0x00, 0x01],\n          channelcoarsetuning: [0x00, 0x02],\n          tuningprogram: [0x00, 0x03],\n          tuningbank: [0x00, 0x04],\n          modulationrange: [0x00, 0x05],\n\n          azimuthangle: [0x3D, 0x00],\n          elevationangle: [0x3D, 0x01],\n          gain: [0x3D, 0x02],\n          distanceratio: [0x3D, 0x03],\n          maximumdistance: [0x3D, 0x04],\n          maximumdistancegain: [0x3D, 0x05],\n          referencedistanceratio: [0x3D, 0x06],\n          panspreadangle: [0x3D, 0x07],\n          rollangle: [0x3D, 0x08]\n        },\n        writable: false,\n        enumerable: true,\n        configurable: false\n      },\n\n      /**\n       * [read-only] An object containing properties for each MIDI control change messages (a.k.a.\n       * CC messages) and their associated hexadecimal value.\n       *\n       * @property MIDI_CONTROL_CHANGE_MESSAGES\n       * @type Object\n       * @static\n       *\n       * @since 2.0.0\n       */\n      MIDI_CONTROL_CHANGE_MESSAGES: {\n        value: {\n          bankselectcoarse: 0,\n          modulationwheelcoarse: 1,\n          breathcontrollercoarse: 2,\n          footcontrollercoarse: 4,\n          portamentotimecoarse: 5,\n          dataentrycoarse: 6,\n          volumecoarse: 7,\n          balancecoarse: 8,\n          pancoarse: 10,\n          expressioncoarse: 11,\n          effectcontrol1coarse: 12,\n          effectcontrol2coarse: 13,\n          generalpurposeslider1: 16,\n          generalpurposeslider2: 17,\n          generalpurposeslider3: 18,\n          generalpurposeslider4: 19,\n          bankselectfine: 32,\n          modulationwheelfine: 33,\n          breathcontrollerfine: 34,\n          footcontrollerfine: 36,\n          portamentotimefine: 37,\n          dataentryfine: 38,\n          volumefine: 39,\n          balancefine: 40,\n          panfine: 42,\n          expressionfine: 43,\n          effectcontrol1fine: 44,\n          effectcontrol2fine: 45,\n          holdpedal: 64,\n          portamento: 65,\n          sustenutopedal: 66,\n          softpedal: 67,\n          legatopedal: 68,\n          hold2pedal: 69,\n          soundvariation: 70,\n          resonance: 71,\n          soundreleasetime: 72,\n          soundattacktime: 73,\n          brightness: 74,\n          soundcontrol6: 75,\n          soundcontrol7: 76,\n          soundcontrol8: 77,\n          soundcontrol9: 78,\n          soundcontrol10: 79,\n          generalpurposebutton1: 80,\n          generalpurposebutton2: 81,\n          generalpurposebutton3: 82,\n          generalpurposebutton4: 83,\n          reverblevel: 91,\n          tremololevel: 92,\n          choruslevel: 93,\n          celestelevel: 94,\n          phaserlevel: 95,\n          databuttonincrement: 96,\n          databuttondecrement: 97,\n          nonregisteredparametercoarse: 98,\n          nonregisteredparameterfine: 99,\n          registeredparametercoarse: 100,\n          registeredparameterfine: 101\n        },\n        writable: false,\n        enumerable: true,\n        configurable: false\n      },\n\n      /**\n       * [read-only] An object containing properties for MIDI control change messages\n       * that make up NRPN messages\n       *\n       * @property MIDI_NRPN_MESSAGES\n       * @type Object\n       * @static\n       *\n       * @since 2.0.0\n       */\n      MIDI_NRPN_MESSAGES: {\n        value: {\n          entrymsb: 6,\n          entrylsb: 38,\n          increment: 96,\n          decrement: 97,\n          paramlsb: 98,\n          parammsb: 99,\n          nullactiveparameter: 127\n        },\n        writable: false,\n        enumerable: true,\n        configurable: false\n      },\n\n      /**\n       * [read-only] List of MIDI channel mode messages as defined in the official MIDI\n       * specification.\n       *\n       * @property MIDI_CHANNEL_MODE_MESSAGES\n       * @type Object\n       * @static\n       *\n       * @since 2.0.0\n       */\n      MIDI_CHANNEL_MODE_MESSAGES: {\n        value: {\n          allsoundoff: 120,\n          resetallcontrollers: 121,\n          localcontrol: 122,\n          allnotesoff: 123,\n          omnimodeoff: 124,\n          omnimodeon: 125,\n          monomodeon: 126,\n          polymodeon: 127\n        },\n        writable: false,\n        enumerable: true,\n        configurable: false\n      },\n\n      /**\n       * An integer to offset the octave both in inbound and outbound messages. By default, middle C\n       * (MIDI note number 60) is placed on the 4th octave (C4).\n       *\n       * If, for example, `octaveOffset` is set to 2, MIDI note number 60 will be reported as C6. If\n       * `octaveOffset` is set to -1, MIDI note number 60 will be reported as C3.\n       *\n       * @property octaveOffset\n       * @type Number\n       * @static\n       *\n       * @since 2.1\n       */\n      octaveOffset: {\n        value: 0,\n        writable: true,\n        enumerable: true,\n        configurable: false\n      }\n\n    });\n\n    // Define getters/setters\n    Object.defineProperties(this, {\n\n      /**\n       * [read-only] Indicates whether the environment supports the Web MIDI API or not.\n       *\n       * Note: in environments that do not offer built-in MIDI support, this will report true if the\n       * `navigator.requestMIDIAccess` function is available. For example, if you have installed\n       * WebMIDIAPIShim but no plugin, this property will be true even though actual support might\n       * not be there.\n       *\n       * @property supported\n       * @type Boolean\n       * @static\n       */\n      supported: {\n        enumerable: true,\n        get: function() {\n          return \"requestMIDIAccess\" in navigator;\n        }\n      },\n\n      /**\n       * [read-only] Indicates whether the interface to the host\"s MIDI subsystem is currently\n       * enabled.\n       *\n       * @property enabled\n       * @type Boolean\n       * @static\n       */\n      enabled: {\n        enumerable: true,\n        get: function() {\n          return this.interface !== undefined;\n        }.bind(this)\n      },\n\n      /**\n       * [read-only] An array of all currently available MIDI input ports.\n       *\n       * @property inputs\n       * @type {Array}\n       * @static\n       */\n      inputs: {\n        enumerable: true,\n        get: function() {\n          return this._inputs;\n        }.bind(this)\n      },\n\n      /**\n       * [read-only] An array of all currently available MIDI output ports.\n       *\n       * @property outputs\n       * @type {Array}\n       * @static\n       */\n      outputs: {\n        enumerable: true,\n        get: function() {\n          return this._outputs;\n        }.bind(this)\n      },\n\n      /**\n       * [read-only] Indicates whether the interface to the host\"s MIDI subsystem is currently\n       * active.\n       *\n       * @property sysexEnabled\n       * @type Boolean\n       * @static\n       */\n      sysexEnabled: {\n        enumerable: true,\n        get: function() {\n          return !!(this.interface && this.interface.sysexEnabled);\n        }.bind(this)\n      },\n\n      /**\n       * [read-only] Indicates whether WebMidi should dispatch Non-Registered\n       * Parameter Number events (which are generally groups of CC messages)\n       * If correct sequences of CC messages are received, NRPN events will\n       * fire. The first out of order NRPN CC will fall through the collector\n       * logic and all CC messages buffered will be discarded as incomplete.\n       *\n       * @property nrpnEventsEnabled\n       * @type Boolean\n       * @static\n       */\n      nrpnEventsEnabled: {\n        enumerable: true,\n        get: function() {\n          return !!(this._nrpnEventsEnabled);\n        }.bind(this),\n        set: function(enabled) {\n          this._nrpnEventsEnabled = enabled;\n          return this._nrpnEventsEnabled;\n        }\n      },\n\n      /**\n       * [read-only] NRPN message types\n       *\n       * @property nrpnTypes\n       * @type Array\n       * @static\n       */\n      nrpnTypes: {\n        enumerable: true,\n        get: function() {\n          return this._nrpnTypes;\n        }.bind(this)\n      },\n\n      /**\n       * [read-only] Current MIDI performance time in milliseconds. This can be used to queue events\n       * in the future.\n       *\n       * @property time\n       * @type DOMHighResTimeStamp\n       * @static\n       */\n      time: {\n        enumerable: true,\n        get: function() {\n          return performance.now();\n        }\n      }\n\n    });\n\n  }\n\n  // WebMidi is a singleton so we instantiate it ourselves and keep it in a var for internal\n  // reference.\n  var wm = new WebMidi();\n\n  /**\n   * Checks if the Web MIDI API is available and then tries to connect to the host's MIDI subsystem.\n   * This is an asynchronous operation. When it's done, the specified handler callback will be\n   * executed. If an error occurred, the callback function will receive an `Error` object as its\n   * sole parameter.\n   *\n   * To enable the use of system exclusive messages, the `sysex` parameter should be set to true.\n   * However, under some environments (e.g. Jazz-Plugin), the sysex parameter is ignored and sysex\n   * is always enabled.\n   *\n   * Warning: starting with Chrome v77, the Web MIDI API must be hosted on a secure origin\n   * (`https://`, `localhost` or `file:///`) and the user will always be prompted to authorize the\n   * operation (no matter if `sysex` is requested or not).\n   *\n   * @method enable\n   * @static\n   *\n   * @param [callback] {Function} A function to execute upon success. This function will receive an\n   * `Error` object upon failure to enable the Web MIDI API.\n   * @param [sysex=false] {Boolean} Whether to enable MIDI system exclusive messages or not.\n   *\n   * @throws Error The Web MIDI API is not supported by your browser.\n   * @throws Error Jazz-Plugin must be installed to use WebMIDIAPIShim.\n   */\n  WebMidi.prototype.enable = function(callback, sysex) {\n\n    // Why are you not using a Promise-based API for the enable() method?\n    //\n    // Short answer: because of IE.\n    //\n    // Long answer:\n    //\n    // IE 11 and below still do not support promises. Therefore, WebMIDIAPIShim has to implement a\n    // simple Promise look-alike object to handle the call to requestMIDIAccess(). This look-alike\n    // is not a fully-fledged Promise object. It does not support using catch() for example. This\n    // means that, to provide a real Promise-based interface for the enable() method, we would need\n    // to add a dependency in the form of a Promise polyfill. So, to keep things simpler, we will\n    // stick to the good old callback based enable() function.\n\n    if (this.enabled) return;\n\n    if ( !this.supported) {\n\n      if (typeof callback === \"function\") {\n        callback( new Error(\"The Web MIDI API is not supported by your browser.\") );\n      }\n\n      return;\n\n    }\n\n    navigator.requestMIDIAccess({sysex: sysex}).then(\n\n      function(midiAccess) {\n\n        var events = [],\n          promises = [],\n          promiseTimeout;\n\n        this.interface = midiAccess;\n        this._resetInterfaceUserHandlers();\n\n        // We setup a temporary `statechange` handler that will catch all events triggered while we\n        // setup. Those events will be re-triggered after calling the user\"s callback. This will\n        // allow the user to listen to \"connected\" events which can be very convenient.\n        this.interface.onstatechange = function (e) {\n          events.push(e);\n        };\n\n        // Here we manually open the inputs and outputs. Usually, this is optional. When the ports\n        // are not explicitely opened, they will be opened automatically (and asynchonously) by\n        // setting a listener on `midimessage` (MIDIInput) or calling `send()` (MIDIOutput).\n        // However, we do not want that here. We want to be sure that \"connected\" events will be\n        // available in the user\"s callback. So, what we do is open all input and output ports and\n        // wait until all promises are resolved. Then, we re-trigger the events after the user\"s\n        // callback has been executed. This seems like the most sensible and practical way.\n        var inputs = midiAccess.inputs.values();\n        for (var input = inputs.next(); input && !input.done; input = inputs.next()) {\n          promises.push(input.value.open());\n        }\n\n        var outputs = midiAccess.outputs.values();\n        for (var output = outputs.next(); output && !output.done; output = outputs.next()) {\n          promises.push(output.value.open());\n        }\n\n        // Since this library might be used in environments without support for promises (such as\n        // Jazz-Midi) or in environments that are not properly opening the ports (such as Web MIDI\n        // Browser), we fall back to a timer-based approach if the promise-based approach fails.\n        function onPortsOpen() {\n\n          clearTimeout(promiseTimeout);\n\n          this._updateInputsAndOutputs();\n          this.interface.onstatechange = this._onInterfaceStateChange.bind(this);\n\n          // We execute the callback and then re-trigger the statechange events.\n          if (typeof callback === \"function\") { callback.call(this); }\n\n          events.forEach(function (event) {\n            this._onInterfaceStateChange(event);\n          }.bind(this));\n\n        }\n\n        promiseTimeout = setTimeout(onPortsOpen.bind(this), 200);\n\n        if (Promise) {\n          Promise\n            .all(promises)\n            .catch(function(err) { console.warn(err); })\n            .then(onPortsOpen.bind(this));\n        }\n\n        // When MIDI access is requested, all input and output ports have their \"state\" set to\n        // \"connected\". However, the value of their \"connection\" property is \"closed\".\n        //\n        // A `MIDIInput` becomes `open` when you explicitely call its `open()` method or when you\n        // assign a listener to its `onmidimessage` property. A `MIDIOutput` becomes `open` when you\n        // use the `send()` method or when you can explicitely call its `open()` method.\n        //\n        // Calling `_updateInputsAndOutputs()` attaches listeners to all inputs. As per the spec,\n        // this triggers a `statechange` event on MIDIAccess.\n\n      }.bind(this),\n\n      function (err) {\n        if (typeof callback === \"function\") { callback.call(this, err); }\n      }.bind(this)\n\n    );\n\n  };\n\n  /**\n   * Completely disables `WebMidi` by unlinking the MIDI subsystem\"s interface and destroying all\n   * `Input` and `Output` objects that may be available. This also means that any listener that may\n   * have been defined on `Input` or `Output` objects will be destroyed.\n   *\n   * @method disable\n   * @static\n   *\n   * @since 2.0.0\n   */\n  WebMidi.prototype.disable = function() {\n\n    if ( !this.supported ) {\n      throw new Error(\"The Web MIDI API is not supported by your browser.\");\n    }\n\n    if (this.interface) this.interface.onstatechange = undefined;\n    this.interface = undefined; // also resets enabled, sysexEnabled, nrpnEventsEnabled\n    this._inputs = [];\n    this._outputs = [];\n    this._nrpnEventsEnabled = true;\n    this._resetInterfaceUserHandlers();\n\n  };\n\n  /**\n   * Adds an event listener on the `WebMidi` object that will trigger a function callback when the\n   * specified event happens.\n   *\n   * WebMidi must be enabled before adding event listeners.\n   *\n   * Currently, only one event is being dispatched by the `WebMidi` object:\n   *\n   *    * {{#crossLink \"WebMidi/statechange:event\"}}statechange{{/crossLink}}\n   *\n   * @method addListener\n   * @static\n   * @chainable\n   *\n   * @param type {String} The type of the event.\n   *\n   * @param listener {Function} A callback function to execute when the specified event is detected.\n   * This function will receive an event parameter object. For details on this object\"s properties,\n   * check out the documentation for the various events (links above).\n   *\n   * @throws {Error} WebMidi must be enabled before adding event listeners.\n   * @throws {TypeError} The specified event type is not supported.\n   * @throws {TypeError} The \"listener\" parameter must be a function.\n   *\n   * @return {WebMidi} Returns the `WebMidi` object so methods can be chained.\n   */\n  WebMidi.prototype.addListener = function(type, listener) {\n\n    if (!this.enabled) {\n      throw new Error(\"WebMidi must be enabled before adding event listeners.\");\n    }\n\n    if (typeof listener !== \"function\") {\n      throw new TypeError(\"The 'listener' parameter must be a function.\");\n    }\n\n    if (this._midiInterfaceEvents.indexOf(type) >= 0) {\n      this._userHandlers[type].push(listener);\n    } else {\n      throw new TypeError(\"The specified event type is not supported.\");\n    }\n\n    return this;\n\n  };\n\n  /**\n   * Checks if the specified event type is already defined to trigger the specified listener\n   * function.\n   *\n   * @method hasListener\n   * @static\n   *\n   * @param {String} type The type of the event.\n   * @param {Function} listener The callback function to check for.\n   *\n   * @throws {Error} WebMidi must be enabled before checking event listeners.\n   * @throws {TypeError} The \"listener\" parameter must be a function.\n   * @throws {TypeError} The specified event type is not supported.\n   *\n   * @return {Boolean} Boolean value indicating whether or not a callback is already defined for\n   * this event type.\n   */\n  WebMidi.prototype.hasListener = function(type, listener) {\n\n    if (!this.enabled) {\n      throw new Error(\"WebMidi must be enabled before checking event listeners.\");\n    }\n\n    if (typeof listener !== \"function\") {\n      throw new TypeError(\"The 'listener' parameter must be a function.\");\n    }\n\n    if (this._midiInterfaceEvents.indexOf(type) >= 0) {\n\n      for (var o = 0; o < this._userHandlers[type].length; o++) {\n        if (this._userHandlers[type][o] === listener) {\n          return true;\n        }\n      }\n\n    } else {\n      throw new TypeError(\"The specified event type is not supported.\");\n    }\n\n    return false;\n\n  };\n\n  /**\n   * Removes the specified listener(s). If the `listener` parameter is left undefined, all listeners\n   * for the specified `type` will be removed. If both the `listener` and the `type` parameters are\n   * omitted, all listeners attached to the `WebMidi` object will be removed.\n   *\n   * @method removeListener\n   * @static\n   * @chainable\n   *\n   * @param {String} [type] The type of the event.\n   * @param {Function} [listener] The callback function to check for.\n   *\n   * @throws {Error} WebMidi must be enabled before removing event listeners.\n   * @throws {TypeError} The \"listener\" parameter must be a function.\n   * @throws {TypeError} The specified event type is not supported.\n   *\n   * @return {WebMidi} The `WebMidi` object for easy method chaining.\n   */\n  WebMidi.prototype.removeListener = function(type, listener) {\n\n    if (!this.enabled) {\n      throw new Error(\"WebMidi must be enabled before removing event listeners.\");\n    }\n\n    if (listener !== undefined && typeof listener !== \"function\") {\n      throw new TypeError(\"The 'listener' parameter must be a function.\");\n    }\n\n    if (this._midiInterfaceEvents.indexOf(type) >= 0) {\n\n      if (listener) {\n\n        for (var o = 0; o < this._userHandlers[type].length; o++) {\n          if (this._userHandlers[type][o] === listener) {\n            this._userHandlers[type].splice(o, 1);\n          }\n        }\n\n      } else {\n        this._userHandlers[type] = [];\n      }\n\n    } else if (type === undefined) {\n\n      this._resetInterfaceUserHandlers();\n\n    } else {\n      throw new TypeError(\"The specified event type is not supported.\");\n    }\n\n    return this;\n\n  };\n\n  /**\n   * Returns a sanitized array of valid MIDI channel numbers (1-16). The parameter should be one of\n   * the following:\n   *\n   * * a single integer\n   * * an array of integers\n   * * the special value `\"all\"`\n   * * the special value `\"none\"`\n   *\n   * Passing `\"all\"` or `undefined` as a parameter to this function results in all channels being\n   * returned (1-16). Passing `\"none\"` results in no channel being returned (as an empty array).\n   *\n   * Note: parameters that cannot successfully be parsed to integers between 1 and 16 are silently\n   * ignored.\n   *\n   * @method toMIDIChannels\n   * @static\n   *\n   * @param [channel=\"all\"] {Number|Array|\"all\"|\"none\"}\n   * @returns {Array} An array of 0 or more valid MIDI channel numbers\n   */\n  WebMidi.prototype.toMIDIChannels = function(channel) {\n\n    var channels;\n\n    if (channel === \"all\" || channel === undefined) {\n      channels = [\"all\"];\n    } else if (channel === \"none\") {\n      channels = [];\n      return channels;\n    } else if (!Array.isArray(channel)) {\n      channels = [channel];\n    } else {\n      channels = channel;\n    }\n\n    // In order to preserve backwards-compatibility, we let this assignment as it is.\n    if (channels.indexOf(\"all\") > -1) {\n      channels = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16];\n    }\n\n    return channels\n      .map(function(ch) {\n        return parseInt(ch);\n      })\n      .filter(function(ch) {\n        return (ch >= 1 && ch <= 16);\n      });\n\n  };\n\n  /**\n   *\n   * Returns the `Input` object that matches the specified ID string or `false` if no matching input\n   * is found. As per the Web MIDI API specification, IDs are strings (not integers).\n   *\n   * Please note that IDs change from one host to another. For example, Chrome does not use the same\n   * kind of IDs as Jazz-Plugin.\n   *\n   * @method getInputById\n   * @static\n   *\n   * @param id {String} The ID string of the port. IDs can be viewed by looking at the\n   * `WebMidi.inputs` array.\n   *\n   * @returns {Input|false} A MIDIInput port matching the specified ID string. If no matching port\n   * can be found, the method returns `false`.\n   *\n   * @throws Error WebMidi is not enabled.\n   *\n   * @since 2.0.0\n   */\n  WebMidi.prototype.getInputById = function(id) {\n\n    if (!this.enabled) throw new Error(\"WebMidi is not enabled.\");\n\n    id = String(id);\n\n    for (var i = 0; i < this.inputs.length; i++) {\n      if (this.inputs[i].id === id) return this.inputs[i];\n    }\n\n    return false;\n\n  };\n\n  /**\n   * Returns the `Output` object that matches the specified ID string or `false` if no matching\n   * output is found. As per the Web MIDI API specification, IDs are strings (not integers).\n   *\n   * Please note that IDs change from one host to another. For example, Chrome does not use the same\n   * kind of IDs as Jazz-Plugin.\n   *\n   * @method getOutputById\n   * @static\n   *\n   * @param id {String} The ID string of the port. IDs can be viewed by looking at the\n   * `WebMidi.outputs` array.\n   *\n   * @returns {Output|false} A MIDIOutput port matching the specified ID string. If no matching port\n   * can be found, the method returns `false`.\n   *\n   * @throws Error WebMidi is not enabled.\n   *\n   * @since 2.0.0\n   */\n  WebMidi.prototype.getOutputById = function(id) {\n\n    if (!this.enabled) throw new Error(\"WebMidi is not enabled.\");\n\n    id = String(id);\n\n    for (var i = 0; i < this.outputs.length; i++) {\n      if (this.outputs[i].id === id) return this.outputs[i];\n    }\n\n    return false;\n\n  };\n\n  /**\n   * Returns the first MIDI `Input` whose name *contains* the specified string.\n   *\n   * Please note that the port names change from one host to another. For example, Chrome does\n   * not report port names in the same way as the Jazz-Plugin does.\n   *\n   * @method getInputByName\n   * @static\n   *\n   * @param name {String} The name of a MIDI input port such as those visible in the\n   * `WebMidi.inputs` array.\n   *\n   * @returns {Input|False} The `Input` that was found or `false` if no input matched the specified\n   * name.\n   *\n   * @throws Error WebMidi is not enabled.\n   * @throws TypeError The name must be a string.\n   *\n   * @since 2.0.0\n   */\n  WebMidi.prototype.getInputByName = function(name) {\n\n    if (!this.enabled) {\n      throw new Error(\"WebMidi is not enabled.\");\n    }\n\n    for (var i = 0; i < this.inputs.length; i++) {\n      if (~this.inputs[i].name.indexOf(name)) { return this.inputs[i]; }\n    }\n\n    return false;\n\n  };\n\n  /**\n   * Returns the octave number for the specified MIDI note number (0-127). By default, the value is\n   * based on middle C (note number 60) being placed on the 4th octave (C4). However, by using the\n   * <a href=\"#property_octaveOffset\">octaveOffset</a> property, you can offset the result as much\n   * as you want.\n   *\n   * @method getOctave\n   * @static\n   *\n   * @param number {Number} An integer representing a valid MIDI note number (between 0 and 127).\n   *\n   * @returns {Number} The octave (as a signed integer) or `undefined`.\n   *\n   * @since 2.0.0-rc.6\n   */\n  WebMidi.prototype.getOctave = function(number) {\n\n    if (number != null && number >= 0 && number <= 127) {\n      return Math.floor(Math.floor(number) / 12 - 1) + Math.floor(wm.octaveOffset);\n    }\n\n  };\n\n  /**\n   * Returns the first MIDI `Output` that matches the specified name.\n   *\n   * Please note that the port names change from one host to another. For example, Chrome does\n   * not report port names in the same way as the Jazz-Plugin does.\n   *\n   * @method getOutputByName\n   * @static\n   *\n   * @param name {String} The name of a MIDI output port such as those visible in the\n   * `WebMidi.outputs` array.\n   *\n   * @returns {Output|False} The `Output` that was found or `false` if no output matched the\n   * specified name.\n   *\n   * @throws Error WebMidi is not enabled.\n   *\n   * @since 2.0.0\n   */\n  WebMidi.prototype.getOutputByName = function(name) {\n\n    if (!this.enabled) {\n      throw new Error(\"WebMidi is not enabled.\");\n    }\n\n    for (var i = 0; i < this.outputs.length; i++) {\n      if (~this.outputs[i].name.indexOf(name)) { return this.outputs[i]; }\n    }\n\n    return false;\n\n  };\n\n  /**\n   * Returns a valid MIDI note number (0-127) given the specified input. The input usually is a note\n   * name (C3, F#4, D-2, G8, etc.). If an integer between 0 and 127, it will simply be returned as\n   * is.\n   *\n   * @method guessNoteNumber\n   * @static\n   *\n   * @param input {Number|String} A string to extract the note number from. An integer can also be\n   * used, in which case it will simply be returned (if between 0 and 127).\n   * @throws {Error} Invalid input value\n   * @returns {Number} A valid MIDI note number (0-127).\n   */\n  WebMidi.prototype.guessNoteNumber = function(input) {\n\n    var output = false;\n\n    if (input && input.toFixed && input >= 0 && input <= 127) {         // uint\n      output = Math.round(input);\n    } else if (parseInt(input) >= 0 && parseInt(input) <= 127) {        // uint as string\n      output = parseInt(input);\n    } else if (typeof input === \"string\" || input instanceof String) {  // string\n      output = this.noteNameToNumber(input);\n    }\n\n    if (output === false) throw new Error(\"Invalid input value (\" + input + \").\");\n    return output;\n\n  };\n\n  /**\n   * Returns a MIDI note number matching the note name passed in the form of a string parameter. The\n   * note name must include the octave number. The name can also optionally include a sharp (#),\n   * a double sharp (##), a flat (b) or a double flat (bb) symbol: C5, G4, D#-1, F0, Gb7, Eb-1,\n   * Abb4, B##6, etc.\n   *\n   * Note that, in converting note names to numbers, C4 is considered to be middle C (MIDI note\n   * number 60) as per the scientific pitch notation standard.\n   *\n   * Also note that the resulting note number is offset by the `octaveOffset` value (if not zero).\n   * For example, if you pass in \"C4\" and the `octaveOffset` value is 2 the resulting MIDI note\n   * number will be 36.\n   *\n   * @method noteNameToNumber\n   * @static\n   *\n   * @param name {String} The name of the note in the form of a letter, followed by an optional \"#\",\n   * \"##\", \"b\" or \"bb\" followed by the octave number.\n   *\n   * @throws {RangeError} Invalid note name.\n   * @throws {RangeError} Invalid note name or note outside valid range.\n   * @return {Number} The MIDI note number (between 0 and 127)\n   */\n  WebMidi.prototype.noteNameToNumber = function(name) {\n\n    if (typeof name !== \"string\") name = \"\";\n\n    var matches = name.match(/([CDEFGAB])(#{0,2}|b{0,2})(-?\\d+)/i);\n    if(!matches) throw new RangeError(\"Invalid note name.\");\n\n    var semitones = wm._semitones[matches[1].toUpperCase()];\n    var octave = parseInt(matches[3]);\n    var result = ((octave + 1 - Math.floor(wm.octaveOffset)) * 12) + semitones;\n\n\n    if (matches[2].toLowerCase().indexOf(\"b\") > -1) {\n      result -= matches[2].length;\n    } else if (matches[2].toLowerCase().indexOf(\"#\") > -1) {\n      result += matches[2].length;\n    }\n\n    if (result < 0 || result > 127) {\n      throw new RangeError(\"Invalid note name or note outside valid range.\");\n    }\n\n    return result;\n\n  };\n\n  /**\n   * @method _updateInputsAndOutputs\n   * @static\n   * @protected\n   */\n  WebMidi.prototype._updateInputsAndOutputs = function() {\n    this._updateInputs();\n    this._updateOutputs();\n  };\n\n  /**\n   * @method _updateInputs\n   * @static\n   * @protected\n   */\n  WebMidi.prototype._updateInputs = function() {\n\n    // Check for items to remove from the existing array (because they are no longer being reported\n    // by the MIDI back-end).\n    for (var i = 0; i < this._inputs.length; i++) {\n\n      var remove = true;\n\n      var updated = this.interface.inputs.values();\n      for (var input = updated.next(); input && !input.done; input = updated.next()) {\n        if (this._inputs[i]._midiInput === input.value) {\n          remove = false;\n          break;\n        }\n      }\n\n      if (remove) {\n        this._inputs.splice(i, 1);\n      }\n\n    }\n\n    // Check for items to add in the existing inputs array because they just appeared in the MIDI\n    // back-end inputs list. We must check for the existence of this.interface because it might\n    // have been closed via WebMidi.disable().\n    this.interface && this.interface.inputs.forEach(function (nInput) {\n\n      var add = true;\n\n      for (var j = 0; j < this._inputs.length; j++) {\n        if (this._inputs[j]._midiInput === nInput) {\n          add = false;\n        }\n      }\n\n      if (add) {\n        this._inputs.push( new Input(nInput) );\n      }\n\n    }.bind(this));\n\n  };\n\n  /**\n   * @method _updateOutputs\n   * @static\n   * @protected\n   */\n  WebMidi.prototype._updateOutputs = function() {\n\n    // Check for items to remove from the existing array (because they are no longer being reported\n    // by the MIDI back-end).\n    for (var i = 0; i < this._outputs.length; i++) {\n\n      var remove = true;\n\n      var updated = this.interface.outputs.values();\n      for (var output = updated.next(); output && !output.done; output = updated.next()) {\n        if (this._outputs[i]._midiOutput === output.value) {\n          remove = false;\n          break;\n        }\n      }\n\n      if (remove) {\n        this._outputs.splice(i, 1);\n      }\n\n    }\n\n    // Check for items to add in the existing inputs array because they just appeared in the MIDI\n    // back-end outputs list. We must check for the existence of this.interface because it might\n    // have been closed via WebMidi.disable().\n    this.interface && this.interface.outputs.forEach(function (nOutput) {\n\n      var add = true;\n\n      for (var j = 0; j < this._outputs.length; j++) {\n        if (this._outputs[j]._midiOutput === nOutput) {\n          add = false;\n        }\n      }\n\n      if (add) {\n        this._outputs.push( new Output(nOutput) );\n      }\n\n    }.bind(this));\n\n  };\n\n  /**\n   * @method _onInterfaceStateChange\n   * @static\n   * @protected\n   */\n  WebMidi.prototype._onInterfaceStateChange = function(e) {\n\n    this._updateInputsAndOutputs();\n\n    /**\n     * Event emitted when a MIDI port becomes available. This event is typically fired whenever a\n     * MIDI device is plugged in. Please note that it may fire several times if a device possesses\n     * multiple input/output ports.\n     *\n     * @event connected\n     * @param {Object} event\n     * @param {Number} event.timestamp The timestamp when the event occurred (in milliseconds since\n     * the epoch).\n     * @param {String} event.type The type of event that occurred.\n     * @param {String} event.port The actual `Input` or `Output` object associated to the event.\n     */\n\n    /**\n     * Event emitted when a MIDI port becomes unavailable. This event is typically fired whenever a\n     * MIDI device is unplugged. Please note that it may fire several times if a device possesses\n     * multiple input/output ports.\n     *\n     * @event disconnected\n     * @param {Object} event\n     * @param {Number} event.timestamp The timestamp when the event occurred (in milliseconds since\n     * the epoch).\n     * @param {String} event.type The type of event that occurred.\n     * @param {String} event.port An generic object containing details about the port that triggered\n     * the event.\n     */\n    var event = {\n      timestamp: e.timeStamp,\n      type: e.port.state\n    };\n\n    if (this.interface && e.port.state === \"connected\") {\n\n      if (e.port.type === \"output\") {\n        event.port = this.getOutputById(e.port.id);\n      } else if (e.port.type === \"input\") {\n        event.port = this.getInputById(e.port.id);\n      }\n\n    } else {\n\n      event.port = {\n        connection: \"closed\",\n        id: e.port.id,\n        manufacturer: e.port.manufacturer,\n        name: e.port.name,\n        state: e.port.state,\n        type: e.port.type\n      };\n\n    }\n\n    this._userHandlers[e.port.state].forEach(function (handler) {\n      handler(event);\n    });\n\n  };\n\n  /**\n   * @method _resetInterfaceUserHandlers\n   * @static\n   * @protected\n   */\n  WebMidi.prototype._resetInterfaceUserHandlers = function() {\n\n    for (var i = 0; i < this._midiInterfaceEvents.length; i++) {\n      this._userHandlers[this._midiInterfaceEvents[i]] = [];\n    }\n\n  };\n\n  /**\n   * The `Input` object represents a MIDI input port on the host system. This object is created by\n   * the MIDI subsystem and cannot be instantiated directly.\n   *\n   * You will find all available `Input` objects in the `WebMidi.inputs` array.\n   *\n   * @class Input\n   * @param {MIDIInput} midiInput `MIDIInput` object\n   */\n  function Input(midiInput) {\n\n    var that = this;\n\n    // User-defined handlers list\n    this._userHandlers = { channel: {}, system: {} };\n\n    // Reference to the actual MIDIInput object\n    this._midiInput = midiInput;\n\n    Object.defineProperties(this, {\n\n      /**\n       * [read-only] Status of the MIDI port\"s connection (`pending`, `open` or `closed`)\n       *\n       * @property connection\n       * @type String\n       */\n      connection: {\n        enumerable: true,\n        get: function () {\n          return that._midiInput.connection;\n        }\n      },\n\n      /**\n       * [read-only] ID string of the MIDI port. The ID is host-specific. Do not expect the same ID\n       * on different platforms. For example, Google Chrome and the Jazz-Plugin report completely\n       * different IDs for the same port.\n       *\n       * @property id\n       * @type String\n       */\n      id: {\n        enumerable: true,\n        get: function () {\n          return that._midiInput.id;\n        }\n      },\n\n      /**\n       * [read-only] Name of the manufacturer of the device that makes this port available.\n       *\n       * @property manufacturer\n       * @type String\n       */\n      manufacturer: {\n        enumerable: true,\n        get: function () {\n          return that._midiInput.manufacturer;\n        }\n      },\n\n      /**\n       * [read-only] Name of the MIDI port\n       *\n       * @property name\n       * @type String\n       */\n      name: {\n        enumerable: true,\n        get: function () {\n          return that._midiInput.name;\n        }\n      },\n\n      /**\n       * [read-only] State of the MIDI port (`connected` or `disconnected`)\n       *\n       * @property state\n       * @type String\n       */\n      state: {\n        enumerable: true,\n        get: function () {\n          return that._midiInput.state;\n        }\n      },\n\n      /**\n       * [read-only] Type of the MIDI port (`input`)\n       *\n       * @property type\n       * @type String\n       */\n      type: {\n        enumerable: true,\n        get: function () {\n          return that._midiInput.type;\n        }\n      }\n\n    });\n\n    this._initializeUserHandlers();\n    this._midiInput.onmidimessage = this._onMidiMessage.bind(this);\n\n  }\n\n  /**\n   * Adds an event listener to the `Input` that will trigger a function callback when the specified\n   * event happens. The events that are dispatched can be channel-specific or Input-wide.\n   *\n   * Here is a list of events that are dispatched by `Input` objects and that can be listened to.\n   *\n   * Channel-specific MIDI events:\n   *\n   *    * {{#crossLink \"Input/noteoff:event\"}}noteoff{{/crossLink}}\n   *    * {{#crossLink \"Input/noteon:event\"}}noteon{{/crossLink}}\n   *    * {{#crossLink \"Input/keyaftertouch:event\"}}keyaftertouch{{/crossLink}}\n   *    * {{#crossLink \"Input/controlchange:event\"}}controlchange{{/crossLink}}\n   *    * {{#crossLink \"Input/nrpn:event\"}}nrpn{{/crossLink}}\n   *    * {{#crossLink \"Input/channelmode:event\"}}channelmode{{/crossLink}}\n   *    * {{#crossLink \"Input/programchange:event\"}}programchange{{/crossLink}}\n   *    * {{#crossLink \"Input/channelaftertouch:event\"}}channelaftertouch{{/crossLink}}\n   *    * {{#crossLink \"Input/pitchbend:event\"}}pitchbend{{/crossLink}}\n   *\n   * Input-wide MIDI events:\n   *\n   *    * {{#crossLink \"Input/sysex:event\"}}sysex{{/crossLink}}\n   *    * {{#crossLink \"Input/timecode:event\"}}timecode{{/crossLink}}\n   *    * {{#crossLink \"Input/songposition:event\"}}songposition{{/crossLink}}\n   *    * {{#crossLink \"Input/songselect:event\"}}songselect{{/crossLink}}\n   *    * {{#crossLink \"Input/tuningrequest:event\"}}tuningrequest{{/crossLink}}\n   *    * {{#crossLink \"Input/clock:event\"}}clock{{/crossLink}}\n   *    * {{#crossLink \"Input/start:event\"}}start{{/crossLink}}\n   *    * {{#crossLink \"Input/continue:event\"}}continue{{/crossLink}}\n   *    * {{#crossLink \"Input/stop:event\"}}stop{{/crossLink}}\n   *    * {{#crossLink \"Input/activesensing:event\"}}activesensing{{/crossLink}}\n   *    * {{#crossLink \"Input/reset:event\"}}reset{{/crossLink}}\n   *    * {{#crossLink \"Input/midimessage:event\"}}midimessage{{/crossLink}}\n   *    * {{#crossLink \"Input/unknownsystemmessage:event\"}}unknownsystemmessage{{/crossLink}}\n   *\n   * For device-wide events, the `channel` parameter will be silently ignored. You can simply use\n   * `undefined` in that case.\n   *\n   * If you want to view all incoming MIDI traffic, you can listen to the input-wide `midimessage`\n   * event. This event is dispatched for every single message that is received on that input.\n   *\n   * @method addListener\n   * @chainable\n   *\n   * @param type {String} The type of the event.\n   *\n   * @param channel {Number|Array|String} The MIDI channel to listen on (integer between 1 and 16).\n   * You can also specify an array of channel numbers or the value \"all\" (or leave it undefined for\n   * input-wide events).\n   *\n   * @param listener {Function} A callback function to execute when the specified event is detected.\n   * This function will receive an event parameter object. For details on this object\"s properties,\n   * check out the documentation for the various events (links above).\n   *\n   * @throws {RangeError} The \"channel\" parameter is invalid.\n   * @throws {TypeError} The \"listener\" parameter must be a function.\n   * @throws {TypeError} The specified event type is not supported.\n   *\n   * @return {WebMidi} Returns the `WebMidi` object so methods can be chained.\n   */\n  Input.prototype.addListener = function(type, channel, listener) {\n\n    var that = this;\n\n    if (channel === undefined) { channel = \"all\"; }\n    if (!Array.isArray(channel)) { channel = [channel]; }\n\n    // Check if channel entries are valid\n    channel.forEach(function(item){\n      if (item !== \"all\" && !(item >= 1 && item <= 16)) {\n        throw new RangeError(\n          \"The 'channel' parameter is invalid.\"\n        );\n      }\n    });\n\n    if (typeof listener !== \"function\") {\n      throw new TypeError(\"The 'listener' parameter must be a function.\");\n    }\n\n    if (wm.MIDI_SYSTEM_MESSAGES[type] !== undefined) {\n\n      if (!this._userHandlers.system[type]) this._userHandlers.system[type] = [];\n      this._userHandlers.system[type].push(listener);\n\n    } else if (wm.MIDI_CHANNEL_MESSAGES[type] !== undefined) {\n\n      // If \"all\" is present anywhere in the channel array, use all 16 channels\n      if (channel.indexOf(\"all\") > -1) {\n        channel = [];\n        for (var j = 1; j <= 16; j++) { channel.push(j); }\n      }\n\n      if (!this._userHandlers.channel[type]) { this._userHandlers.channel[type] = []; }\n\n      // Push all channel listeners in the array\n      channel.forEach(function(ch){\n\n        if (!that._userHandlers.channel[type][ch]) {\n          that._userHandlers.channel[type][ch] = [];\n        }\n\n        that._userHandlers.channel[type][ch].push(listener);\n\n      });\n\n    } else {\n      throw new TypeError(\"The specified event type is not supported.\");\n    }\n\n    return this;\n\n  };\n\n  /**\n   * This is an alias to the {{#crossLink \"Input/addListener\"}}Input.addListener(){{/crossLink}}\n   * function.\n   *\n   * @method on\n   * @since 2.0.0\n   */\n  Input.prototype.on = Input.prototype.addListener;\n\n  /**\n   * Checks if the specified event type is already defined to trigger the listener function on the\n   * specified channel(s). If more than one channel is specified, the function will return `true`\n   * only if all channels have the listener defined.\n   *\n   * For device-wide events (`sysex`, `start`, etc.), the `channel` parameter is silently ignored.\n   * We suggest you use `undefined` in such cases.\n   *\n   * @method hasListener\n   *\n   * @param type {String} The type of the event.\n   * @param channel {Number|Array|String} The MIDI channel to check on (between 1 and 16). You\n   * can also specify an array of channel numbers or the string \"all\".\n   * @param listener {Function} The callback function to check for.\n   *\n   * @throws {TypeError} The \"listener\" parameter must be a function.\n   *\n   * @return {Boolean} Boolean value indicating whether or not the channel(s) already have this\n   * listener defined.\n   */\n  Input.prototype.hasListener = function(type, channel, listener) {\n\n    var that = this;\n\n    if (typeof listener !== \"function\") {\n      throw new TypeError(\"The 'listener' parameter must be a function.\");\n    }\n\n    if (channel === undefined) { channel = \"all\"; }\n    if (channel.constructor !== Array) { channel = [channel]; }\n\n    if (wm.MIDI_SYSTEM_MESSAGES[type] !== undefined) {\n\n      for (var o = 0; o < this._userHandlers.system[type].length; o++) {\n        if (this._userHandlers.system[type][o] === listener) { return true; }\n      }\n\n    } else if (wm.MIDI_CHANNEL_MESSAGES[type] !== undefined) {\n\n      // If \"all\" is present anywhere in the channel array, use all 16 channels\n      if (channel.indexOf(\"all\") > -1) {\n        channel = [];\n        for (var j = 1; j <= 16; j++) { channel.push(j); }\n      }\n\n      if (!this._userHandlers.channel[type]) { return false; }\n\n      // Go through all specified channels\n      return channel.every(function(chNum) {\n        var listeners = that._userHandlers.channel[type][chNum];\n        return listeners && listeners.indexOf(listener) > -1;\n      });\n\n    }\n\n    return false;\n\n  };\n\n  /**\n   * Removes the specified listener from the specified channel(s). If the `listener` parameter is\n   * left undefined, all listeners for the specified `type` will be removed from all channels. If\n   * the `channel` is also omitted, all listeners of the specified type will be removed from all\n   * channels. If no parameters are defined, all listeners attached to any channel of the `Input`\n   * will be removed.\n   *\n   * For device-wide events (`sysex`, `start`, etc.), the `channel` parameter is silently ignored.\n   * You can use `undefined` in such cases.\n   *\n   * @method removeListener\n   * @chainable\n   *\n   * @param [type] {String} The type of the event.\n   * @param [channel] {Number|String|Array} The MIDI channel(s) to check on. It can be a uint\n   * (between 1 and 16) an array of channel numbers or the special value \"all\".\n   * @param [listener] {Function} The callback function to check for.\n   *\n   * @throws {TypeError} The specified event type is not supported.\n   * @throws {TypeError} The \"listener\" parameter must be a function..\n   *\n   * @return {Input} The `Input` object for easy method chaining.\n   */\n  Input.prototype.removeListener = function(type, channel, listener) {\n\n    var that = this;\n\n    if (listener !== undefined && typeof listener !== \"function\") {\n      throw new TypeError(\"The 'listener' parameter must be a function.\");\n    }\n\n    if (channel === undefined) { channel = \"all\"; }\n    if (channel.constructor !== Array) { channel = [channel]; }\n\n    if (wm.MIDI_SYSTEM_MESSAGES[type] !== undefined) {\n\n      if (listener === undefined) {\n\n        this._userHandlers.system[type] = [];\n\n      } else {\n\n        for (var o = 0; o < this._userHandlers.system[type].length; o++) {\n          if (this._userHandlers.system[type][o] === listener) {\n            this._userHandlers.system[type].splice(o, 1);\n          }\n        }\n\n      }\n\n    } else if (wm.MIDI_CHANNEL_MESSAGES[type] !== undefined) {\n\n      // If \"all\" is present anywhere in the channel array, use all 16 channels\n      if (channel.indexOf(\"all\") > -1) {\n        channel = [];\n        for (var j = 1; j <= 16; j++) { channel.push(j); }\n      }\n\n      if (!this._userHandlers.channel[type]) { return this; }\n\n      // Go through all specified channels\n      channel.forEach(function(chNum) {\n        var listeners = that._userHandlers.channel[type][chNum];\n        if (!listeners) { return; }\n\n        if (listener === undefined) {\n          that._userHandlers.channel[type][chNum] = [];\n        } else {\n          for (var l = 0; l < listeners.length; l++) {\n            if (listeners[l] === listener) { listeners.splice(l, 1); }\n          }\n        }\n\n      });\n\n    } else if (type === undefined) {\n      this._initializeUserHandlers();\n    } else {\n      throw new TypeError(\"The specified event type is not supported.\");\n    }\n\n    return this;\n\n  };\n\n  /**\n   * @method _initializeUserHandlers\n   * @protected\n   */\n  Input.prototype._initializeUserHandlers = function() {\n\n    for (var prop1 in wm.MIDI_CHANNEL_MESSAGES) {\n      if (wm.MIDI_CHANNEL_MESSAGES.hasOwnProperty(prop1)) {\n        this._userHandlers.channel[prop1] = {};\n      }\n    }\n\n    for (var prop2 in wm.MIDI_SYSTEM_MESSAGES) {\n      if (wm.MIDI_SYSTEM_MESSAGES.hasOwnProperty(prop2)) {\n        this._userHandlers.system[prop2] = [];\n      }\n    }\n\n  };\n\n  /**\n   * @method _onMidiMessage\n   * @protected\n   */\n  Input.prototype._onMidiMessage = function(e) {\n\n    // Execute \"midimessage\" listeners (if any)\n    if (this._userHandlers.system[\"midimessage\"].length > 0) {\n\n      var event = {\n        target: this,\n        data: e.data,\n        timestamp: e.timeStamp,\n        type: \"midimessage\"\n      };\n\n      /**\n       * Event emitted when a MIDI message is received. This should be used primarily for debugging\n       * purposes.\n       *\n       * @event midimessage\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {uint} event.timestamp The timestamp when the event occurred (in milliseconds since\n       * the [Unix Epoch](https://en.wikipedia.org/wiki/Unix_time)).\n       * @param {String} event.type The type of event that occurred.\n       * @since 2.1\n       */\n      this._userHandlers.system[\"midimessage\"].forEach(\n        function(callback) { callback(event); }\n      );\n\n    }\n\n    if (e.data[0] < 240) {          // channel-specific message\n      this._parseChannelEvent(e);\n      this._parseNrpnEvent(e);\n    } else if (e.data[0] <= 255) {  // system message\n      this._parseSystemEvent(e);\n    }\n\n  };\n\n  /**\n   * Parses channel events and constructs NRPN message parts in valid sequences.\n   * Keeps a separate NRPN buffer for each channel.\n   * Emits an event after it receives the final CC parts msb 127 lsb 127.\n   * If a message is incomplete and other messages are received before\n   * the final 127 bytes, the incomplete message is cleared.\n   * @method _parseNrpnEvent\n   * @param e Event\n   * @protected\n   */\n  Input.prototype._parseNrpnEvent = function(e) {\n\n    var command = e.data[0] >> 4;\n    var channelBufferIndex = (e.data[0] & 0xf); // use this for index of channel in _nrpnBuffer\n    var channel = channelBufferIndex + 1;\n    var data1, data2;\n\n    if (e.data.length > 1) {\n      data1 = e.data[1];\n      data2 = e.data.length > 2 ? e.data[2] : undefined;\n    }\n\n    // nrpn disabled\n    if(!wm.nrpnEventsEnabled) {\n      return;\n    }\n\n    // nrpn enabled, message not valid for nrpn\n    if(\n      !(\n        command === wm.MIDI_CHANNEL_MESSAGES.controlchange &&\n        (\n          (data1 >= wm.MIDI_NRPN_MESSAGES.increment && data1 <= wm.MIDI_NRPN_MESSAGES.parammsb) ||\n          data1 === wm.MIDI_NRPN_MESSAGES.entrymsb ||\n          data1 === wm.MIDI_NRPN_MESSAGES.entrylsb\n        )\n      )\n    ) {\n      return;\n    }\n\n    // set up a CC event to parse as NRPN part\n    var ccEvent = {\n      target: this,\n      type: \"controlchange\",\n      data: e.data,\n      timestamp: e.timeStamp,\n      channel: channel,\n      controller: {\n        number: data1,\n        name: this.getCcNameByNumber(data1)\n      },\n      value: data2\n    };\n    if(\n      // if we get a starting MSB(CC99 - 0-126) vs an end MSB(CC99 - 127)\n      // destroy inclomplete NRPN and begin building again\n      ccEvent.controller.number === wm.MIDI_NRPN_MESSAGES.parammsb &&\n      ccEvent.value != wm.MIDI_NRPN_MESSAGES.nullactiveparameter\n    ) {\n      wm._nrpnBuffer[channelBufferIndex] = [];\n      wm._nrpnBuffer[channelBufferIndex][0] = ccEvent;\n    } else if(\n      // add the param LSB\n      wm._nrpnBuffer[channelBufferIndex].length === 1 &&\n        ccEvent.controller.number === wm.MIDI_NRPN_MESSAGES.paramlsb\n    ) {\n      wm._nrpnBuffer[channelBufferIndex].push(ccEvent);\n\n    } else if(\n      // add data inc/dec or value MSB for 14bit\n      wm._nrpnBuffer[channelBufferIndex].length === 2 &&\n        (ccEvent.controller.number === wm.MIDI_NRPN_MESSAGES.increment ||\n         ccEvent.controller.number === wm.MIDI_NRPN_MESSAGES.decrement ||\n         ccEvent.controller.number === wm.MIDI_NRPN_MESSAGES.entrymsb)\n    ) {\n      wm._nrpnBuffer[channelBufferIndex].push(ccEvent);\n\n    } else if(\n      // if we have a value MSB, only add an LSB to pair with that\n      wm._nrpnBuffer[channelBufferIndex].length === 3 &&\n        wm._nrpnBuffer[channelBufferIndex][2].number === wm.MIDI_NRPN_MESSAGES.entrymsb &&\n        ccEvent.controller.number === wm.MIDI_NRPN_MESSAGES.entrylsb\n    ) {\n      wm._nrpnBuffer[channelBufferIndex].push(ccEvent);\n\n    } else if(\n      // add an end MSB(CC99 - 127)\n      wm._nrpnBuffer[channelBufferIndex].length >= 3 &&\n      wm._nrpnBuffer[channelBufferIndex].length <= 4 &&\n        ccEvent.controller.number === wm.MIDI_NRPN_MESSAGES.parammsb &&\n        ccEvent.value === wm.MIDI_NRPN_MESSAGES.nullactiveparameter\n    ) {\n      wm._nrpnBuffer[channelBufferIndex].push(ccEvent);\n\n    } else if(\n      // add an end LSB(CC99 - 127)\n      wm._nrpnBuffer[channelBufferIndex].length >= 4 &&\n      wm._nrpnBuffer[channelBufferIndex].length <= 5 &&\n        ccEvent.controller.number === wm.MIDI_NRPN_MESSAGES.paramlsb &&\n        ccEvent.value === wm.MIDI_NRPN_MESSAGES.nullactiveparameter\n    ) {\n      wm._nrpnBuffer[channelBufferIndex].push(ccEvent);\n      // now we have a full inc or dec NRPN message, lets create that event!\n\n      var rawData = [];\n\n      wm._nrpnBuffer[channelBufferIndex].forEach(function(ev) {\n        rawData.push(ev.data);\n      });\n\n      var nrpnNumber = (wm._nrpnBuffer[channelBufferIndex][0].value<<7) |\n        (wm._nrpnBuffer[channelBufferIndex][1].value);\n      var nrpnValue = wm._nrpnBuffer[channelBufferIndex][2].value;\n      if(wm._nrpnBuffer[channelBufferIndex].length === 6) {\n        nrpnValue = (wm._nrpnBuffer[channelBufferIndex][2].value<<7) |\n          (wm._nrpnBuffer[channelBufferIndex][3].value);\n      }\n      var nrpnControllerType = \"\";\n      switch (wm._nrpnBuffer[channelBufferIndex][2].controller.number) {\n      case wm.MIDI_NRPN_MESSAGES.entrymsb:\n        nrpnControllerType = wm._nrpnTypes[0];\n        break;\n      case wm.MIDI_NRPN_MESSAGES.increment:\n        nrpnControllerType = wm._nrpnTypes[1];\n        break;\n      case wm.MIDI_NRPN_MESSAGES.decrement:\n        nrpnControllerType = wm._nrpnTypes[2];\n        break;\n      default:\n        throw new Error(\"The NPRN type was unidentifiable.\");\n      }\n\n      /**\n       * Event emitted when a valid NRPN message sequence has been received on a specific device and\n       * channel.\n       *\n       * @event nrpn\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Array} event.data The raw MIDI message as arrays of 8 bit values( Uint8Array ).\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {uint} event.channel The channel where the event occurred (between 1 and 16).\n       * @param {String} event.type The type of event that occurred.\n       * @param {Object} event.controller\n       * @param {uint} event.controller.number The number of the NRPN.\n       * @param {String} event.controller.name The usual name or function of the controller.\n       * @param {uint} event.value The value received (between 0 and 65535).\n       */\n\n      var nrpnEvent = {\n        timestamp: ccEvent.timestamp,\n        channel: ccEvent.channel,\n        type: \"nrpn\",\n        data: rawData,\n        controller: {\n          number: nrpnNumber,\n          type: nrpnControllerType,\n          name: \"Non-Registered Parameter \" + nrpnNumber\n        },\n        value: nrpnValue\n      };\n\n      // now we are done building an NRPN, so clear the NRPN buffer for this channel\n      wm._nrpnBuffer[channelBufferIndex] = [];\n      // If some callbacks have been defined for this event, on that device and channel, execute\n      // them.\n      if (\n        this._userHandlers.channel[nrpnEvent.type] &&\n        this._userHandlers.channel[nrpnEvent.type][nrpnEvent.channel]\n      ) {\n        this._userHandlers.channel[nrpnEvent.type][nrpnEvent.channel].forEach(\n          function(callback) { callback(nrpnEvent); }\n        );\n      }\n    } else {\n      // something didn't match, clear the incomplete NRPN message by\n      wm._nrpnBuffer[channelBufferIndex] = [];\n    }\n  };\n\n  /**\n   * @method _parseChannelEvent\n   * @param e Event\n   * @protected\n   */\n  Input.prototype._parseChannelEvent = function(e) {\n\n    var command = e.data[0] >> 4;\n    var channel = (e.data[0] & 0xf) + 1;\n    var data1, data2;\n\n    if (e.data.length > 1) {\n      data1 = e.data[1];\n      data2 = e.data.length > 2 ? e.data[2] : undefined;\n    }\n\n    // Returned event\n    var event = {\n      target: this,\n      data: e.data,\n      timestamp: e.timeStamp,\n      channel: channel\n    };\n\n    if (\n      command === wm.MIDI_CHANNEL_MESSAGES.noteoff ||\n      (command === wm.MIDI_CHANNEL_MESSAGES.noteon && data2 === 0)\n    ) {\n\n      /**\n       * Event emitted when a note off MIDI message has been received on a specific device and\n       * channel.\n       *\n       * @event noteoff\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {uint} event.channel The channel where the event occurred (between 1 and 16).\n       * @param {String} event.type The type of event that occurred.\n       * @param {Object} event.note\n       * @param {uint} event.note.number The MIDI note number.\n       * @param {String} event.note.name The usual note name (C, C#, D, D#, etc.).\n       * @param {uint} event.note.octave The octave (between -2 and 8).\n       * @param {Number} event.velocity The release velocity (between 0 and 1).\n       * @param {Number} event.rawVelocity The attack velocity expressed as a 7-bit integer (between\n       * 0 and 127).\n       */\n      event.type = \"noteoff\";\n      event.note = {\n        number: data1,\n        name: wm._notes[data1 % 12],\n        octave: wm.getOctave(data1)\n      };\n      event.velocity = data2 / 127;\n      event.rawVelocity = data2;\n\n    } else if (command === wm.MIDI_CHANNEL_MESSAGES.noteon) {\n\n      /**\n       * Event emitted when a note on MIDI message has been received on a specific device and\n       * channel.\n       *\n       * @event noteon\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {uint} event.channel The channel where the event occurred (between 1 and 16).\n       * @param {String} event.type The type of event that occurred.\n       * @param {Object} event.note\n       * @param {uint} event.note.number The MIDI note number.\n       * @param {String} event.note.name The usual note name (C, C#, D, D#, etc.).\n       * @param {uint} event.note.octave The octave (between -2 and 8).\n       * @param {Number} event.velocity The attack velocity (between 0 and 1).\n       * @param {Number} event.rawVelocity The attack velocity expressed as a 7-bit integer (between\n       * 0 and 127).\n       */\n      event.type = \"noteon\";\n      event.note = {\n        number: data1,\n        name: wm._notes[data1 % 12],\n        octave: wm.getOctave(data1)\n      };\n      event.velocity = data2 / 127;\n      event.rawVelocity = data2;\n\n    } else if (command === wm.MIDI_CHANNEL_MESSAGES.keyaftertouch) {\n\n      /**\n       * Event emitted when a key-specific aftertouch MIDI message has been received on a specific\n       * device and channel.\n       *\n       * @event keyaftertouch\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {uint} event.channel The channel where the event occurred (between 1 and 16).\n       * @param {String} event.type The type of event that occurred.\n       * @param {Object} event.note\n       * @param {uint} event.note.number The MIDI note number.\n       * @param {String} event.note.name The usual note name (C, C#, D, D#, etc.).\n       * @param {uint} event.note.octave The octave (between -2 and 8).\n       * @param {Number} event.value The aftertouch amount (between 0 and 1).\n       */\n      event.type = \"keyaftertouch\";\n      event.note = {\n        number: data1,\n        name: wm._notes[data1 % 12],\n        octave: wm.getOctave(data1)\n      };\n      event.value = data2 / 127;\n\n    } else if (\n      command === wm.MIDI_CHANNEL_MESSAGES.controlchange &&\n      data1 >= 0 && data1 <= 119\n    ) {\n\n      /**\n       * Event emitted when a control change MIDI message has been received on a specific device and\n       * channel.\n       *\n       * @event controlchange\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {uint} event.channel The channel where the event occurred (between 1 and 16).\n       * @param {String} event.type The type of event that occurred.\n       * @param {Object} event.controller\n       * @param {uint} event.controller.number The number of the controller.\n       * @param {String} event.controller.name The usual name or function of the controller.\n       * @param {uint} event.value The value received (between 0 and 127).\n       */\n      event.type = \"controlchange\";\n      event.controller = {\n        number: data1,\n        name: this.getCcNameByNumber(data1)\n      };\n      event.value = data2;\n\n    } else if (\n      command === wm.MIDI_CHANNEL_MESSAGES.channelmode &&\n      data1 >= 120 && data1 <= 127\n    ) {\n\n      /**\n       * Event emitted when a channel mode MIDI message has been received on a specific device and\n       * channel.\n       *\n       * @event channelmode\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {uint} event.channel The channel where the event occurred (between 1 and 16).\n       * @param {String} event.type The type of event that occurred.\n       * @param {Object} event.controller\n       * @param {uint} event.controller.number The number of the controller.\n       * @param {String} event.controller.name The usual name or function of the controller.\n       * @param {uint} event.value The value received (between 0 and 127).\n       */\n      event.type = \"channelmode\";\n      event.controller = {\n        number: data1,\n        name: this.getChannelModeByNumber(data1)\n      };\n      event.value = data2;\n\n    } else if (command === wm.MIDI_CHANNEL_MESSAGES.programchange) {\n\n      /**\n       * Event emitted when a program change MIDI message has been received on a specific device and\n       * channel.\n       *\n       * @event programchange\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {uint} event.channel The channel where the event occurred (between 1 and 16).\n       * @param {String} event.type The type of event that occurred.\n       * @param {uint} event.value The value received (between 0 and 127).\n       */\n      event.type = \"programchange\";\n      event.value = data1;\n\n    } else if (command === wm.MIDI_CHANNEL_MESSAGES.channelaftertouch) {\n\n      /**\n       * Event emitted when a channel-wide aftertouch MIDI message has been received on a specific\n       * device and channel.\n       *\n       * @event channelaftertouch\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {uint} event.channel The channel where the event occurred (between 1 and 16).\n       * @param {String} event.type The type of event that occurred.\n       * @param {Number} event.value The aftertouch value received (between 0 and 1).\n       */\n      event.type = \"channelaftertouch\";\n      event.value = data1 / 127;\n\n    } else if (command === wm.MIDI_CHANNEL_MESSAGES.pitchbend) {\n\n      /**\n       * Event emitted when a pitch bend MIDI message has been received on a specific device and\n       * channel.\n       *\n       * @event pitchbend\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {uint} event.channel The channel where the event occurred (between 1 and 16).\n       * @param {String} event.type The type of event that occurred.\n       * @param {Number} event.value The pitch bend value received (between -1 and 1).\n       */\n      event.type = \"pitchbend\";\n      event.value = ((data2 << 7) + data1 - 8192) / 8192;\n    } else {\n      event.type = \"unknownchannelmessage\";\n    }\n\n    // If some callbacks have been defined for this event, on that device and channel, execute them.\n    if (\n      this._userHandlers.channel[event.type] &&\n      this._userHandlers.channel[event.type][channel]\n    ) {\n\n      this._userHandlers.channel[event.type][channel].forEach(\n        function(callback) { callback(event); }\n      );\n    }\n\n  };\n\n  /**\n   * Returns the name of a control change message matching the specified number. If no match is\n   * found, the function returns `undefined`.\n   *\n   * @method getCcNameByNumber\n   *\n   * @param number {Number} The number of the control change message.\n   * @returns {String|undefined} The matching control change name or `undefined`.\n   *\n   * @throws RangeError The control change number must be between 0 and 119.\n   *\n   * @since 2.0.0\n   */\n  Input.prototype.getCcNameByNumber = function(number) {\n\n    number = Math.floor(number);\n\n    if ( !(number >= 0 && number <= 119) ) {\n      throw new RangeError(\"The control change number must be between 0 and 119.\");\n    }\n\n    for (var cc in wm.MIDI_CONTROL_CHANGE_MESSAGES) {\n\n      if (\n        wm.MIDI_CONTROL_CHANGE_MESSAGES.hasOwnProperty(cc) &&\n        number === wm.MIDI_CONTROL_CHANGE_MESSAGES[cc]\n      ) {\n        return cc;\n      }\n\n    }\n\n    return undefined;\n\n  };\n\n  /**\n   * Returns the channel mode name matching the specified number. If no match is found, the function\n   * returns `undefined`.\n   *\n   * @method getChannelModeByNumber\n   *\n   * @param number {Number} The number of the channel mode message.\n   * @returns {String|undefined} The matching channel mode message\"s name or `undefined`;\n   *\n   * @throws RangeError The channel mode number must be between 120 and 127.\n   *\n   * @since 2.0.0\n   */\n  Input.prototype.getChannelModeByNumber = function(number) {\n\n    number = Math.floor(number);\n\n    if ( !(number >= 120 && status <= 127) ) {\n      throw new RangeError(\"The control change number must be between 120 and 127.\");\n    }\n\n    for (var cm in wm.MIDI_CHANNEL_MODE_MESSAGES) {\n\n      if (\n        wm.MIDI_CHANNEL_MODE_MESSAGES.hasOwnProperty(cm) &&\n        number === wm.MIDI_CHANNEL_MODE_MESSAGES[cm]\n      ) {\n        return cm;\n      }\n\n    }\n\n  };\n\n  /**\n   * @method _parseSystemEvent\n   * @protected\n   */\n  Input.prototype._parseSystemEvent = function(e) {\n\n    var command = e.data[0];\n\n    // Returned event\n    var event = {\n      target: this,\n      data: e.data,\n      timestamp: e.timeStamp\n    };\n\n    if (command === wm.MIDI_SYSTEM_MESSAGES.sysex) {\n\n      /**\n       * Event emitted when a system exclusive MIDI message has been received. You should note that,\n       * to receive `sysex` events, you must call the `WebMidi.enable()` method with a second\n       * parameter set to `true`:\n       *\n       *     WebMidi.enable(function(err) {\n       *\n       *        if (err) {\n       *          console.log(\"WebMidi could not be enabled.\");\n       *        }\n       *\n       *        var input = WebMidi.inputs[0];\n       *\n       *        input.addListener(\"sysex\", \"all\", function (e) {\n       *          console.log(e);\n       *        });\n       *\n       *     }, true);\n       *\n       * @event sysex\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {String} event.type The type of event that occurred.\n       *\n       */\n      event.type = \"sysex\";\n\n    } else if (command === wm.MIDI_SYSTEM_MESSAGES.timecode) {\n\n      /**\n       * Event emitted when a system MIDI time code quarter frame message has been received.\n       *\n       * @event timecode\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {String} event.type The type of event that occurred.\n       */\n      event.type = \"timecode\";\n\n    } else if (command === wm.MIDI_SYSTEM_MESSAGES.songposition) {\n\n      /**\n       * Event emitted when a system song position pointer MIDI message has been received.\n       *\n       * @event songposition\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {String} event.type The type of event that occurred.\n       */\n      event.type = \"songposition\";\n\n    } else if (command === wm.MIDI_SYSTEM_MESSAGES.songselect) {\n\n      /**\n       * Event emitted when a system song select MIDI message has been received.\n       *\n       * @event songselect\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {String} event.type The type of event that occurred.\n       * @param {String} event.song Song (or sequence) number to select.\n       */\n      event.type = \"songselect\";\n      event.song = e.data[1];\n\n    } else if (command === wm.MIDI_SYSTEM_MESSAGES.tuningrequest) {\n\n      /**\n       * Event emitted when a system tune request MIDI message has been received.\n       *\n       * @event tuningrequest\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data     The raw MIDI message as an array of 8 bit\n       *                                    values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {String} event.type         The type of event that occurred.\n       */\n      event.type = \"tuningrequest\";\n\n    } else if (command === wm.MIDI_SYSTEM_MESSAGES.clock) {\n\n      /**\n       * Event emitted when a system timing clock MIDI message has been received.\n       *\n       * @event clock\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data     The raw MIDI message as an array of 8 bit\n       *                                    values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {String} event.type         The type of event that occurred.\n       */\n      event.type = \"clock\";\n\n    } else if (command === wm.MIDI_SYSTEM_MESSAGES.start) {\n\n      /**\n       * Event emitted when a system start MIDI message has been received.\n       *\n       * @event start\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data     The raw MIDI message as an array of 8 bit\n       *                                    values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {String} event.type         The type of event that occurred.\n       */\n      event.type = \"start\";\n\n    } else if (command === wm.MIDI_SYSTEM_MESSAGES.continue) {\n\n      /**\n       * Event emitted when a system continue MIDI message has been received.\n       *\n       * @event continue\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data     The raw MIDI message as an array of 8 bit\n       *                                    values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {String} event.type         The type of event that occurred.\n       */\n      event.type = \"continue\";\n\n    } else if (command === wm.MIDI_SYSTEM_MESSAGES.stop) {\n\n      /**\n       * Event emitted when a system stop MIDI message has been received.\n       *\n       * @event stop\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data     The raw MIDI message as an array of 8 bit\n       *                                    values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {String} event.type         The type of event that occurred.\n       */\n      event.type = \"stop\";\n\n    } else if (command === wm.MIDI_SYSTEM_MESSAGES.activesensing) {\n\n      /**\n       * Event emitted when a system active sensing MIDI message has been received.\n       *\n       * @event activesensing\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data     The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {String} event.type         The type of event that occurred.\n       */\n      event.type = \"activesensing\";\n\n    } else if (command === wm.MIDI_SYSTEM_MESSAGES.reset) {\n\n      /**\n       * Event emitted when a system reset MIDI message has been received.\n       *\n       * @event reset\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data     The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {String} event.type         The type of event that occurred.\n       */\n      event.type = \"reset\";\n\n    } else {\n\n      /**\n       * Event emitted when an unknown system MIDI message has been received. It could be, for\n       * example, one of the undefined/reserved messages.\n       *\n       * @event unknownsystemmessage\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {String} event.type The type of event that occurred.\n       */\n      event.type = \"unknownsystemmessage\";\n\n    }\n\n    // If some callbacks have been defined for this event, execute them.\n    if (this._userHandlers.system[event.type]) {\n      this._userHandlers.system[event.type].forEach(\n        function(callback) { callback(event); }\n      );\n    }\n\n  };\n\n  /**\n   * The `Output` object represents a MIDI output port on the host system. This object is created by\n   * the MIDI subsystem and cannot be instantiated directly.\n   *\n   * You will find all available `Output` objects in the `WebMidi.outputs` array.\n   *\n   * @class Output\n   * @param {MIDIOutput} midiOutput Actual `MIDIOutput` object as defined by the MIDI subsystem\n   */\n  function Output(midiOutput) {\n\n    var that = this;\n\n    this._midiOutput = midiOutput;\n\n    Object.defineProperties(this, {\n\n      /**\n       * [read-only] Status of the MIDI port\"s connection\n       *\n       * @property connection\n       * @type String\n       */\n      connection: {\n        enumerable: true,\n        get: function () {\n          return that._midiOutput.connection;\n        }\n      },\n\n      /**\n       * [read-only] ID string of the MIDI port\n       *\n       * @property id\n       * @type String\n       */\n      id: {\n        enumerable: true,\n        get: function () {\n          return that._midiOutput.id;\n        }\n      },\n\n      /**\n       * [read-only] Manufacturer of the device to which this port belongs\n       *\n       * @property manufacturer\n       * @type String\n       */\n      manufacturer: {\n        enumerable: true,\n        get: function () {\n          return that._midiOutput.manufacturer;\n        }\n      },\n\n      /**\n       * [read-only] Name of the MIDI port\n       *\n       * @property name\n       * @type String\n       */\n      name: {\n        enumerable: true,\n        get: function () {\n          return that._midiOutput.name;\n        }\n      },\n\n      /**\n       * [read-only] State of the MIDI port\n       *\n       * @property state\n       * @type String\n       */\n      state: {\n        enumerable: true,\n        get: function () {\n          return that._midiOutput.state;\n        }\n      },\n\n      /**\n       * [read-only] Type of the MIDI port (`output`)\n       *\n       * @property state\n       * @type String\n       */\n      type: {\n        enumerable: true,\n        get: function () {\n          return that._midiOutput.type;\n        }\n      }\n\n    });\n\n  }\n\n  /**\n   * Sends a MIDI message on the MIDI output port, at the scheduled timestamp.\n   *\n   * Unless, you are familiar with the details of the MIDI message format, you should not use this\n   * method directly. Instead, use one of the simpler helper methods: `playNote()`, `stopNote()`,\n   * `sendControlChange()`, `sendSystemMessage()`, etc.\n   *\n   * Details on the format of MIDI messages are available in the\n   * <a href=\"http://www.midi.org/techspecs/midimessages.php\">summary of MIDI messages</a> of the\n   * MIDI Manufacturers Association.\n   *\n   * @method send\n   * @chainable\n   *\n   * @param status {Number} The MIDI status byte of the message (128-255).\n   *\n   * @param [data=[]] {Array} An array of uints for the message. The number of data bytes varies\n   * depending on the status byte. It is perfectly legal to send no data for some message types (use\n   * undefined or an empty array in this case). Each byte must be between 0 and 255.\n   *\n   * @param [timestamp=0] {DOMHighResTimeStamp} The timestamp at which to send the message. You can\n   * use `WebMidi.time` to retrieve the current timestamp. To send immediately, leave blank or use\n   * 0.\n   *\n   * @throws {RangeError} The status byte must be an integer between 128 (0x80) and 255 (0xFF).\n   * @throws {RangeError} Data bytes must be integers between 0 (0x00) and 255 (0x7F).\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.send = function(status, data, timestamp) {\n\n    if ( !(status >= 128 && status <= 255) ) {\n      throw new RangeError(\"The status byte must be an integer between 128 (0x80) and 255 (0xFF).\");\n    }\n\n    if (data === undefined) data = [];\n    if ( !Array.isArray(data) ) data = [data];\n\n    var message = [];\n\n    data.forEach(function(item){\n\n      var parsed = Math.floor(item); // mandatory because of \"null\"\n\n      if (parsed >= 0 && parsed <= 255) {\n        message.push(parsed);\n      } else {\n        throw new RangeError(\"Data bytes must be integers between 0 (0x00) and 255 (0xFF).\");\n      }\n\n    });\n\n    this._midiOutput.send([status].concat(message), parseFloat(timestamp) || 0);\n\n    return this;\n\n  };\n\n  /**\n   * Sends a MIDI *system exclusive* (sysex) message. The generated message will automatically be\n   * prepended with the *sysex* byte (0xF0) and terminated with the *end of sysex* byte (0xF7).\n   *\n   * To use the `sendSysex()` method, system exclusive message support must have been enabled. To\n   * do so, you must pass `true` as the second parameter to `WebMidi.enable()`:\n   *\n   *     WebMidi.enable(function (err) {\n   *         if (err) {\n   *             console.warn(err);\n   *         } else {\n   *             console.log(\"Sysex is enabled!\");\n   *         }\n   *     }, true);\n   *\n   * Note that, depending on browser, version and platform, it may be necessary to serve the page\n   * over HTTPS to enable sysex support.\n   *\n   * #### Examples\n   *\n   * If you want to send a sysex message to a Korg device connected to the first output, you would\n   * use the following code:\n   *\n   *     WebMidi.outputs[0].sendSysex(0x42, [0x1, 0x2, 0x3, 0x4, 0x5]);\n   *\n   * The parameters can be specified using any number notation (decimal, hex, binary, etc.).\n   * Therefore, the code below is equivalent to the code above:\n   *\n   *     WebMidi.outputs[0].sendSysex(66, [1, 2, 3, 4, 5]);\n   *\n   * The above code sends the byte values 1, 2, 3, 4 and 5 to Korg devices (hex 42 is the same as\n   * decimal 66).\n   *\n   * Some manufacturers are identified using 3 bytes. In this case, you would use a 3-position array\n   * as the first parameter. For example, to send the same sysex message to a\n   * *Native Instruments* device:\n   *\n   *     WebMidi.outputs[0].sendSysex([0x00, 0x21, 0x09], [0x1, 0x2, 0x3, 0x4, 0x5]);\n   *\n   * There is no limit for the length of the data array. However, it is generally suggested to keep\n   * system exclusive messages to 64Kb or less.\n   *\n   * @method sendSysex\n   * @chainable\n   *\n   * @param manufacturer {Number|Array} An unsigned integer or an array of three unsigned integers\n   * between 0 and 127 that identify the targeted manufacturer. The *MIDI Manufacturers Association*\n   * maintains a full list of\n   * [Manufacturer ID Numbers](https://www.midi.org/specifications/item/manufacturer-id-numbers).\n   *\n   * @param [data=[]] {Array} An array of uints between 0 and 127. This is the data you wish to\n   * transfer.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throw Sysex message support must first be activated.\n   * @throw The data bytes of a sysex message must be integers between 0 (0x00) and 127 (0x7F).\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendSysex = function(manufacturer, data, options) {\n\n    if (!wm.sysexEnabled) {\n      throw new Error(\"Sysex message support must first be activated.\");\n    }\n\n    options = options || {};\n\n    manufacturer = [].concat(manufacturer);\n\n    data.forEach(function(item){\n      if (item < 0 || item > 127) {\n        throw new RangeError(\n          \"The data bytes of a sysex message must be integers between 0 (0x00) and 127 (0x7F).\"\n        );\n      }\n    });\n\n    data = manufacturer.concat(data, wm.MIDI_SYSTEM_MESSAGES.sysexend);\n    this.send(wm.MIDI_SYSTEM_MESSAGES.sysex, data, this._parseTimeParameter(options.time));\n\n    return this;\n\n  };\n\n  /**\n   * Sends a *MIDI Timecode Quarter Frame* message. Please note that no processing is being done on\n   * the data. It is up to the developer to format the data according to the\n   * [MIDI Timecode](https://en.wikipedia.org/wiki/MIDI_timecode) format.\n   *\n   * @method sendTimecodeQuarterFrame\n   * @chainable\n   *\n   * @param value {Number} The quarter frame message content (integer between 0 and 127).\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendTimecodeQuarterFrame = function(value, options) {\n    options = options || {};\n    this.send(wm.MIDI_SYSTEM_MESSAGES.timecode, value, this._parseTimeParameter(options.time));\n    return this;\n  };\n\n  /**\n   * Sends a *Song Position* MIDI message. The value is expressed in MIDI beats (between 0 and\n   * 16383) which are 16th note. Position 0 is always the start of the song.\n   *\n   * @method sendSongPosition\n   * @chainable\n   *\n   * @param [value=0] {Number} The MIDI beat to cue to (int between 0 and 16383).\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendSongPosition = function(value, options) {\n\n    value = Math.floor(value) || 0;\n\n    options = options || {};\n\n    var msb = (value >> 7) & 0x7F;\n    var lsb = value & 0x7F;\n\n    this.send(\n      wm.MIDI_SYSTEM_MESSAGES.songposition,\n      [msb, lsb],\n      this._parseTimeParameter(options.time)\n    );\n    return this;\n\n  };\n\n  /**\n   * Sends a *Song Select* MIDI message. Beware that some devices will display position 0 as\n   * position 1 for user-friendlyness.\n   *\n   * @method sendSongSelect\n   * @chainable\n   *\n   * @param value {Number} The number of the song to select (integer between 0 and 127).\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws The song number must be between 0 and 127.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendSongSelect = function(value, options) {\n\n    value = Math.floor(value);\n\n    options = options || {};\n\n    if ( !(value >= 0 && value <= 127) ) {\n      throw new RangeError(\"The song number must be between 0 and 127.\");\n    }\n\n    this.send(wm.MIDI_SYSTEM_MESSAGES.songselect, [value], this._parseTimeParameter(options.time));\n\n    return this;\n\n  };\n\n  /**\n   * Sends a *MIDI tuning request* real-time message.\n   *\n   * Note: there is currently a bug in Chrome\"s MIDI implementation. If you try to use this\n   * function, Chrome will actually throw a \"Message is incomplete\" error. The bug is\n   * [scheduled to be fixed](https://bugs.chromium.org/p/chromium/issues/detail?id=610116).\n   *\n   * @method sendTuningRequest\n   * @chainable\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendTuningRequest = function(options) {\n    options = options || {};\n    this.send(\n      wm.MIDI_SYSTEM_MESSAGES.tuningrequest,\n      undefined,\n      this._parseTimeParameter(options.time)\n    );\n    return this;\n  };\n\n  /**\n   * Sends a *MIDI Clock* real-time message. According to the standard, there are 24 MIDI Clocks\n   * for every quarter note.\n   *\n   * @method sendClock\n   * @chainable\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendClock = function(options) {\n    options = options || {};\n    this.send(wm.MIDI_SYSTEM_MESSAGES.clock, undefined, this._parseTimeParameter(options.time));\n    return this;\n  };\n\n  /**\n   * Sends a *Start* real-time message. A MIDI Start message starts the playback of the current\n   * song at beat 0. To start playback elsewhere in the song, use the `sendContinue()` function.\n   *\n   * @method sendStart\n   * @chainable\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendStart = function(options) {\n    options = options || {};\n    this.send(wm.MIDI_SYSTEM_MESSAGES.start, undefined, this._parseTimeParameter(options.time));\n    return this;\n  };\n\n  /**\n   * Sends a *Continue* real-time message. This resumes song playback where it was previously\n   * stopped or where it was last cued with a song position message. To start playback from the\n   * start, use the `sendStart()` function.\n   *\n   * @method sendContinue\n   * @chainable\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @return {WebMidi} Returns the `WebMidi` object so methods can be chained.\n   */\n  Output.prototype.sendContinue = function(options) {\n    options = options || {};\n    this.send(wm.MIDI_SYSTEM_MESSAGES.continue, undefined, this._parseTimeParameter(options.time));\n    return this;\n  };\n\n  /**\n   * Sends a *Stop* real-time message. This tells the device connected to this port to stop playback\n   * immediately (or at the scheduled time).\n   *\n   * @method sendStop\n   * @chainable\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendStop = function(options) {\n    options = options || {};\n    this.send(wm.MIDI_SYSTEM_MESSAGES.stop, undefined, this._parseTimeParameter(options.time));\n    return this;\n  };\n\n  /**\n   * Sends an *Active Sensing* real-time message. This tells the device connected to this port that\n   * the connection is still good. Active sensing messages should be sent every 300 ms if there was\n   * no other activity on the MIDI port.\n   *\n   * @method sendActiveSensing\n   * @chainable\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendActiveSensing = function(options) {\n    options = options || {};\n    this.send(\n      wm.MIDI_SYSTEM_MESSAGES.activesensing,\n      [],\n      this._parseTimeParameter(options.time)\n    );\n    return this;\n  };\n\n  /**\n   * Sends *Reset* real-time message. This tells the device connected to this port that is should\n   * reset itself to a default state.\n   *\n   * @method sendReset\n   * @chainable\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendReset = function(options) {\n    options = options || {};\n    this.send(wm.MIDI_SYSTEM_MESSAGES.reset, undefined, this._parseTimeParameter(options.time));\n    return this;\n  };\n\n  /**\n   * Sends a MIDI **note off** message to the specified channel(s) for a single note or multiple\n   * simultaneous notes (chord). You can delay the execution of the **note off** command by using\n   * the `time` property of the `options` parameter (in milliseconds).\n   *\n   * @method stopNote\n   * @chainable\n   *\n   * @param note {Number|Array|String}  The note(s) you wish to stop. The notes can be specified in\n   * one of three ways. The first way is by using the MIDI note number (an integer between `0` and\n   * `127`). The second way is by using the note name followed by the octave (C3, G#4, F-1, Db7).\n   * The octave range should be between -2 and 8. The lowest note is C-2 (MIDI note number 0) and\n   * the highest note is G8 (MIDI note number 127). It is also possible to specify an array of note\n   * numbers and/or names. The final way is to use the special value `all` to send an \"allnotesoff\"\n   * channel message.\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between `1` and `16`) or an\n   * array of channel numbers. If the special value `all` is used (default), the message will be\n   * sent to all 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {Boolean} [options.rawVelocity=false] Controls whether the release velocity is set using\n   * an integer between `0` and `127` (`true`) or a decimal number between `0` and `1` (`false`,\n   * default).\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @param {Number} [options.velocity=0.5] The velocity at which to release the note (between `0`\n   * and `1`). If the `rawVelocity` option is `true`, the value should be specified as an integer\n   * between `0` and `127`. An invalid velocity value will silently trigger the default of `0.5`.\n   * Note that when the first parameter to `stopNote()` is `all`, the release velocity is silently\n   * ignored.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.stopNote = function(note, channel, options) {\n\n    if (note === \"all\") {\n      return this.sendChannelMode(\"allnotesoff\", 0, channel, options);\n    }\n\n    var nVelocity = 64;\n\n    options = options || {};\n\n    if (options.rawVelocity) {\n\n      if (!isNaN(options.velocity) && options.velocity >= 0 && options.velocity <= 127) {\n        nVelocity = options.velocity;\n      }\n\n    } else {\n\n      if (!isNaN(options.velocity) && options.velocity >= 0 && options.velocity <= 1) {\n        nVelocity = options.velocity * 127;\n      }\n\n    }\n\n    // Send note off messages\n    this._convertNoteToArray(note).forEach(function(item) {\n\n      wm.toMIDIChannels(channel).forEach(function(ch) {\n\n        this.send(\n          (wm.MIDI_CHANNEL_MESSAGES.noteoff << 4) + (ch - 1),\n          [item, Math.round(nVelocity)],\n          this._parseTimeParameter(options.time)\n        );\n\n      }.bind(this));\n\n    }.bind(this));\n\n    return this;\n\n  };\n\n  /**\n   * Requests the playback of a single note or multiple notes on the specified channel(s). You can\n   * delay the execution of the **note on** command by using the `time` property of the `options`\n   * parameter (milliseconds).\n   *\n   * If no duration is specified in the `options`, the note will play until a matching **note off**\n   * is sent. If a duration is specified, a **note off** will be automatically sent after said\n   * duration.\n   *\n   * Note: As per the MIDI standard, a **note on** event with a velocity of `0` is considered to be\n   * a **note off**.\n   *\n   * @method playNote\n   * @chainable\n   *\n   * @param note {Number|String|Array}  The note(s) you wish to play. The notes can be specified in\n   * one of two ways. The first way is by using the MIDI note number (an integer between 0 and 127).\n   * The second way is by using the note name followed by the octave (C3, G#4, F-1, Db7). The octave\n   * range should be between -2 and 8. The lowest note is C-2 (MIDI note number 0) and the highest\n   * note is G8 (MIDI note number 127). It is also possible to specify an array of note numbers\n   * and/or names.\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between `1` and `16`) or an\n   * array of channel numbers. If the special value **all** is used (default), the message will be\n   * sent to all 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {Number} [options.duration=undefined] The number of milliseconds (integer) to wait\n   * before sending a matching **note off** event. If left undefined, only a **note on** message is\n   * sent.\n   *\n   * @param {Boolean} [options.rawVelocity=false] Controls whether the attack and release velocities\n   * are set using integers between `0` and `127` (`true`) or a decimal number between `0` and `1`\n   * (`false`, default).\n   *\n   * @param {Number} [options.release=0.5] The velocity at which to release the note (between `0`\n   * and `1`). If the `rawVelocity` option is `true`, the value should be specified as an integer\n   * between `0` and `127`. An invalid velocity value will silently trigger the default of `0.5`.\n   * This is only used with the **note off** event triggered when `options.duration` is set.\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @param {Number} [options.velocity=0.5] The velocity at which to play the note (between `0` and\n   * `1`). If the `rawVelocity` option is `true`, the value should be specified as an integer\n   * between `0` and `127`. An invalid velocity value will silently trigger the default of `0.5`.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.playNote = function(note, channel, options) {\n\n    var time,\n      nVelocity = 64;\n\n    options = options || {};\n\n    if (options.rawVelocity) {\n\n      if (!isNaN(options.velocity) && options.velocity >= 0 && options.velocity <= 127) {\n        nVelocity = options.velocity;\n      }\n\n    } else {\n\n      if (!isNaN(options.velocity) && options.velocity >= 0 && options.velocity <= 1) {\n        nVelocity = options.velocity * 127;\n      }\n\n    }\n\n    time = this._parseTimeParameter(options.time);\n\n    // Send note on messages\n    this._convertNoteToArray(note).forEach(function(item) {\n\n      wm.toMIDIChannels(channel).forEach(function(ch) {\n        this.send(\n          (wm.MIDI_CHANNEL_MESSAGES.noteon << 4) + (ch - 1),\n          [item, Math.round(nVelocity)],\n          time\n        );\n      }.bind(this));\n\n    }.bind(this));\n\n\n    // Send note off messages (only if a valid duration has been defined)\n    if (!isNaN(options.duration)) {\n\n      if (options.duration <= 0) { options.duration = 0; }\n\n      var nRelease = 64;\n\n      if (options.rawVelocity) {\n\n        if (!isNaN(options.release) && options.release >= 0 && options.release <= 127) {\n          nRelease = options.release;\n        }\n\n      } else {\n\n        if (!isNaN(options.release) && options.release >= 0 && options.release <= 1) {\n          nRelease = options.release * 127;\n        }\n\n      }\n\n      this._convertNoteToArray(note).forEach(function(item) {\n\n        wm.toMIDIChannels(channel).forEach(function(ch) {\n\n          this.send(\n            (wm.MIDI_CHANNEL_MESSAGES.noteoff << 4) + (ch - 1),\n            [item, Math.round(nRelease)],\n            (time || wm.time) + options.duration\n          );\n        }.bind(this));\n\n      }.bind(this));\n\n    }\n\n    return this;\n\n  };\n\n  /**\n   * Sends a MIDI `key aftertouch` message to the specified channel(s) at the scheduled time. This\n   * is a key-specific aftertouch. For a channel-wide aftertouch message, use\n   * {{#crossLink \"WebMidi/sendChannelAftertouch:method\"}}sendChannelAftertouch(){{/crossLink}}.\n   *\n   * @method sendKeyAftertouch\n   * @chainable\n   *\n   * @param note {Number|String|Array}  The note for which you are sending an aftertouch value. The\n   * notes can be specified in one of two ways. The first way is by using the MIDI note number (an\n   * integer between 0 and 127). The second way is by using the note name followed by the octave\n   * (C3, G#4, F-1, Db7). The octave range should be between -2 and 8. The lowest note is C-2 (MIDI\n   * note number 0) and the highest note is G8 (MIDI note number 127). It is also possible to use\n   * an array of note names and/or numbers.\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Number} [pressure=0.5] The pressure level to send (between 0 and 1).\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws {RangeError} The channel must be between 1 and 16.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendKeyAftertouch = function(note, channel, pressure, options) {\n\n    var that = this;\n\n    options = options || {};\n\n    if (channel < 1 || channel > 16) {\n      throw new RangeError(\"The channel must be between 1 and 16.\");\n    }\n\n    if (isNaN(pressure) || pressure < 0 || pressure > 1) {\n      pressure = 0.5;\n    }\n\n    var nPressure = Math.round(pressure * 127);\n\n    this._convertNoteToArray(note).forEach(function(item) {\n\n      wm.toMIDIChannels(channel).forEach(function(ch) {\n        that.send(\n          (wm.MIDI_CHANNEL_MESSAGES.keyaftertouch << 4) + (ch - 1),\n          [item, nPressure],\n          that._parseTimeParameter(options.time)\n        );\n      });\n\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Sends a MIDI `control change` message (a.k.a. CC message) to the specified channel(s) at the\n   * scheduled time. The control change message to send can be specified numerically or by using one\n   * of the following common names:\n   *\n   *  * `bankselectcoarse` (#0)\n   *  * `modulationwheelcoarse` (#1)\n   *  * `breathcontrollercoarse` (#2)\n   *  * `footcontrollercoarse` (#4)\n   *  * `portamentotimecoarse` (#5)\n   *  * `dataentrycoarse` (#6)\n   *  * `volumecoarse` (#7)\n   *  * `balancecoarse` (#8)\n   *  * `pancoarse` (#10)\n   *  * `expressioncoarse` (#11)\n   *  * `effectcontrol1coarse` (#12)\n   *  * `effectcontrol2coarse` (#13)\n   *  * `generalpurposeslider1` (#16)\n   *  * `generalpurposeslider2` (#17)\n   *  * `generalpurposeslider3` (#18)\n   *  * `generalpurposeslider4` (#19)\n   *  * `bankselectfine` (#32)\n   *  * `modulationwheelfine` (#33)\n   *  * `breathcontrollerfine` (#34)\n   *  * `footcontrollerfine` (#36)\n   *  * `portamentotimefine` (#37)\n   *  * `dataentryfine` (#38)\n   *  * `volumefine` (#39)\n   *  * `balancefine` (#40)\n   *  * `panfine` (#42)\n   *  * `expressionfine` (#43)\n   *  * `effectcontrol1fine` (#44)\n   *  * `effectcontrol2fine` (#45)\n   *  * `holdpedal` (#64)\n   *  * `portamento` (#65)\n   *  * `sustenutopedal` (#66)\n   *  * `softpedal` (#67)\n   *  * `legatopedal` (#68)\n   *  * `hold2pedal` (#69)\n   *  * `soundvariation` (#70)\n   *  * `resonance` (#71)\n   *  * `soundreleasetime` (#72)\n   *  * `soundattacktime` (#73)\n   *  * `brightness` (#74)\n   *  * `soundcontrol6` (#75)\n   *  * `soundcontrol7` (#76)\n   *  * `soundcontrol8` (#77)\n   *  * `soundcontrol9` (#78)\n   *  * `soundcontrol10` (#79)\n   *  * `generalpurposebutton1` (#80)\n   *  * `generalpurposebutton2` (#81)\n   *  * `generalpurposebutton3` (#82)\n   *  * `generalpurposebutton4` (#83)\n   *  * `reverblevel` (#91)\n   *  * `tremololevel` (#92)\n   *  * `choruslevel` (#93)\n   *  * `celestelevel` (#94)\n   *  * `phaserlevel` (#95)\n   *  * `databuttonincrement` (#96)\n   *  * `databuttondecrement` (#97)\n   *  * `nonregisteredparametercoarse` (#98)\n   *  * `nonregisteredparameterfine` (#99)\n   *  * `registeredparametercoarse` (#100)\n   *  * `registeredparameterfine` (#101)\n   *\n   * Note: as you can see above, not all control change message have a matching common name. This\n   * does not mean you cannot use the others. It simply means you will need to use their number\n   * instead of their name.\n   *\n   * To view a list of all available `control change` messages, please consult \"Table 3 - Control\n   * Change Messages\" from the [MIDI Messages](\n   * https://www.midi.org/specifications/item/table-3-control-change-messages-data-bytes-2)\n   * specification.\n   *\n   * @method sendControlChange\n   * @chainable\n   *\n   * @param controller {Number|String} The MIDI controller number (0-119) or name.\n   *\n   * @param [value=0] {Number} The value to send (0-127).\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws {RangeError} Controller numbers must be between 0 and 119.\n   * @throws {RangeError} Value must be between 0 and 127.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendControlChange = function(controller, value, channel, options) {\n\n    options = options || {};\n\n    if (typeof controller === \"string\") {\n\n      controller = wm.MIDI_CONTROL_CHANGE_MESSAGES[controller];\n      if (controller === undefined) throw new TypeError(\"Invalid controller name.\");\n\n    } else {\n\n      controller = Math.floor(controller);\n      if ( !(controller >= 0 && controller <= 119) ) {\n        throw new RangeError(\"Controller numbers must be between 0 and 119.\");\n      }\n\n    }\n\n    value = Math.floor(value) || 0;\n    if ( !(value >= 0 && value <= 127) ) {\n      throw new RangeError(\"Controller value must be between 0 and 127.\");\n    }\n\n    wm.toMIDIChannels(channel).forEach(function(ch) {\n      this.send(\n        (wm.MIDI_CHANNEL_MESSAGES.controlchange << 4) + (ch - 1),\n        [controller, value],\n        this._parseTimeParameter(options.time)\n      );\n    }.bind(this));\n\n    return this;\n\n  };\n\n  /**\n   * Selects a MIDI registered parameter so it is affected by data entry, data increment and data\n   * decrement messages.\n   *\n   * @method _selectRegisteredParameter\n   * @protected\n   *\n   * @param parameter {Array} A two-position array specifying the two control bytes (0x65, 0x64)\n   * that identify the registered parameter.\n   * @param channel\n   * @param time\n   *\n   * @returns {Output}\n   */\n  Output.prototype._selectRegisteredParameter = function(parameter, channel, time) {\n\n    var that = this;\n\n    parameter[0] = Math.floor(parameter[0]);\n    if ( !(parameter[0] >= 0 && parameter[0] <= 127) ) {\n      throw new RangeError(\"The control65 value must be between 0 and 127\");\n    }\n\n    parameter[1] = Math.floor(parameter[1]);\n    if ( !(parameter[1] >= 0 && parameter[1] <= 127) ) {\n      throw new RangeError(\"The control64 value must be between 0 and 127\");\n    }\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      that.sendControlChange(0x65, parameter[0], channel, {time: time});\n      that.sendControlChange(0x64, parameter[1], channel, {time: time});\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Selects a MIDI non-registered parameter so it is affected by data entry, data increment and\n   * data decrement messages.\n   *\n   * @method _selectNonRegisteredParameter\n   * @protected\n   *\n   * @param parameter {Array} A two-position array specifying the two control bytes (0x63, 0x62)\n   * that identify the registered parameter.\n   * @param channel\n   * @param time\n   *\n   * @returns {Output}\n   */\n  Output.prototype._selectNonRegisteredParameter = function(parameter, channel, time) {\n\n    var that = this;\n\n    parameter[0] = Math.floor(parameter[0]);\n    if ( !(parameter[0] >= 0 && parameter[0] <= 127) ) {\n      throw new RangeError(\"The control63 value must be between 0 and 127\");\n    }\n\n    parameter[1] = Math.floor(parameter[1]);\n    if ( !(parameter[1] >= 0 && parameter[1] <= 127) ) {\n      throw new RangeError(\"The control62 value must be between 0 and 127\");\n    }\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      that.sendControlChange(0x63, parameter[0], channel, {time: time});\n      that.sendControlChange(0x62, parameter[1], channel, {time: time});\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Sets the value of the currently selected MIDI registered parameter.\n   *\n   * @method _setCurrentRegisteredParameter\n   * @protected\n   *\n   * @param data {int|Array}\n   * @param channel\n   * @param time\n   *\n   * @returns {Output}\n   */\n  Output.prototype._setCurrentRegisteredParameter = function(data, channel, time) {\n\n    var that = this;\n\n    data = [].concat(data);\n\n    data[0] = Math.floor(data[0]);\n    if ( !(data[0] >= 0 && data[0] <= 127) ) {\n      throw new RangeError(\"The msb value must be between 0 and 127\");\n    }\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      that.sendControlChange(0x06, data[0], channel, {time: time});\n    });\n\n    data[1] = Math.floor(data[1]);\n    if(data[1] >= 0 && data[1] <= 127) {\n      wm.toMIDIChannels(channel).forEach(function() {\n        that.sendControlChange(0x26, data[1], channel, {time: time});\n      });\n    }\n\n    return this;\n\n  };\n\n  /**\n   * Deselects the currently active MIDI registered parameter so it is no longer affected by data\n   * entry, data increment and data decrement messages.\n   *\n   * Current best practice recommends doing that after each call to\n   * `_setCurrentRegisteredParameter()`.\n   *\n   * @method _deselectRegisteredParameter\n   * @protected\n   *\n   * @param channel\n   * @param time\n   *\n   * @returns {Output}\n   */\n  Output.prototype._deselectRegisteredParameter = function(channel, time) {\n\n    var that = this;\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      that.sendControlChange(0x65, 0x7F, channel, {time: time});\n      that.sendControlChange(0x64, 0x7F, channel, {time: time});\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Sets the specified MIDI registered parameter to the desired value. The value is defined with\n   * up to two bytes of data that each can go from 0 to 127.\n   *\n   * >Unless you are very familiar with the MIDI standard you probably should favour one of the\n   * >simpler to use functions such as: `setPitchbendRange()`, `setModulationRange()`,\n   * >`setMasterTuning()`, etc.\n   *\n   * MIDI registered parameters extend the original list of control change messages. Currently,\n   * there are only a limited number of them. Here are the original registered parameters with the\n   * identifier that can be used as the first parameter of this function:\n   *\n   *  * Pitchbend Range (0x00, 0x00): `pitchbendrange`\n   *  * Channel Fine Tuning (0x00, 0x01): `channelfinetuning`\n   *  * Channel Coarse Tuning (0x00, 0x02): `channelcoarsetuning`\n   *  * Tuning Program (0x00, 0x03): `tuningprogram`\n   *  * Tuning Bank (0x00, 0x04): `tuningbank`\n   *  * Modulation Range (0x00, 0x05): `modulationrange`\n   *\n   * Note that the **Tuning Program** and **Tuning Bank** parameters are part of the *MIDI Tuning\n   * Standard*, which is not widely implemented.\n   *\n   * Another set of extra parameters have been later added for 3D sound controllers. They are:\n   *\n   *  * Azimuth Angle (0x3D, 0x00): `azimuthangle`\n   *  * Elevation Angle (0x3D, 0x01): `elevationangle`\n   *  * Gain (0x3D, 0x02): `gain`\n   *  * Distance Ratio (0x3D, 0x03): `distanceratio`\n   *  * Maximum Distance (0x3D, 0x04): `maximumdistance`\n   *  * Maximum Distance Gain (0x3D, 0x05): `maximumdistancegain`\n   *  * Reference Distance Ratio (0x3D, 0x06): `referencedistanceratio`\n   *  * Pan Spread Angle (0x3D, 0x07): `panspreadangle`\n   *  * Roll Angle (0x3D, 0x08): `rollangle`\n   *\n   * @method setRegisteredParameter\n   * @chainable\n   *\n   * @param parameter {String|Array} A string identifying the parameter\"s name (see above) or a\n   * two-position array specifying the two control bytes (0x65, 0x64) that identify the registered\n   * parameter.\n   *\n   * @param [data=[]] {Number|Array} An single integer or an array of integers with a maximum length\n   * of 2 specifying the desired data.\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @returns {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.setRegisteredParameter = function(parameter, data, channel, options) {\n\n    var that = this;\n\n    options = options || {};\n\n    if ( !Array.isArray(parameter) ) {\n      if ( !wm.MIDI_REGISTERED_PARAMETER[parameter]) {\n        throw new Error(\"The specified parameter is not available.\");\n      }\n      parameter = wm.MIDI_REGISTERED_PARAMETER[parameter];\n    }\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      that._selectRegisteredParameter(parameter, channel, options.time);\n      that._setCurrentRegisteredParameter(data, channel, options.time);\n      that._deselectRegisteredParameter(channel, options.time);\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Sets a non-registered parameter to the specified value. The NRPN is selected by passing in a\n   * two-position array specifying the values of the two control bytes. The value is specified by\n   * passing in an single integer (most cases) or an array of two integers.\n   *\n   * NRPNs are not standardized in any way. Each manufacturer is free to implement them any way\n   * they see fit. For example, according to the Roland GS specification, you can control the\n   * **vibrato rate** using NRPN (1, 8). Therefore, to set the **vibrato rate** value to **123** you\n   * would use:\n   *\n   *     WebMidi.outputs[0].setNonRegisteredParameter([1, 8], 123);\n   *\n   * Obviously, you should select a channel so the message is not sent to all channels. For\n   * instance, to send to channel 1 of the first output port, you would use:\n   *\n   *     WebMidi.outputs[0].setNonRegisteredParameter([1, 8], 123, 1);\n   *\n   * In some rarer cases, you need to send two values with your NRPN messages. In such cases, you\n   * would use a 2-position array. For example, for its **ClockBPM** parameter (2, 63), Novation\n   * uses a 14-bit value that combines an MSB and an LSB (7-bit values). So, for example, if the\n   * value to send was 10, you could use:\n   *\n   *     WebMidi.outputs[0].setNonRegisteredParameter([2, 63], [0, 10]);\n   *\n   * For further implementation details, refer to the manufacturer\"s documentation.\n   *\n   * @method setNonRegisteredParameter\n   * @chainable\n   *\n   * @param parameter {Array} A two-position array specifying the two control bytes (0x63,\n   * 0x62) that identify the non-registered parameter.\n   *\n   * @param [data=[]] {Number|Array} An integer or an array of integers with a length of 1 or 2\n   * specifying the desired data.\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @returns {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.setNonRegisteredParameter = function(parameter, data, channel, options) {\n\n    var that = this;\n\n    options = options || {};\n\n    if (\n      !(parameter[0] >= 0 && parameter[0] <= 127) ||\n      !(parameter[1] >= 0 && parameter[1] <= 127)\n    ) {\n      throw new Error(\n        \"Position 0 and 1 of the 2-position parameter array must both be between 0 and 127.\"\n      );\n    }\n\n    data = [].concat(data);\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      that._selectNonRegisteredParameter(parameter, channel, options.time);\n      that._setCurrentRegisteredParameter(data, channel, options.time);\n      that._deselectRegisteredParameter(channel, options.time);\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Increments the specified MIDI registered parameter by 1. For more specific MIDI usage\n   * information, check out [RP-18](http://dev.midi.org/techspecs/rp18.php) regarding the usage of\n   * increment and decrement controllers.\n   *\n   * >Unless you are very familiar with the MIDI standard you probably should favour one of the\n   * >simpler to use functions such as: `setPitchbendRange()`, `setModulationRange()`,\n   * >`setMasterTuning()`, etc.\n   *\n   * Here is the full list of parameter names that can be used with this function:\n   *\n   *  * Pitchbend Range (0x00, 0x00): `pitchbendrange`\n   *  * Channel Fine Tuning (0x00, 0x01): `channelfinetuning`\n   *  * Channel Coarse Tuning (0x00, 0x02): `channelcoarsetuning`\n   *  * Tuning Program (0x00, 0x03): `tuningprogram`\n   *  * Tuning Bank (0x00, 0x04): `tuningbank`\n   *  * Modulation Range (0x00, 0x05): `modulationrange`\n   *  * Azimuth Angle (0x3D, 0x00): `azimuthangle`\n   *  * Elevation Angle (0x3D, 0x01): `elevationangle`\n   *  * Gain (0x3D, 0x02): `gain`\n   *  * Distance Ratio (0x3D, 0x03): `distanceratio`\n   *  * Maximum Distance (0x3D, 0x04): `maximumdistance`\n   *  * Maximum Distance Gain (0x3D, 0x05): `maximumdistancegain`\n   *  * Reference Distance Ratio (0x3D, 0x06): `referencedistanceratio`\n   *  * Pan Spread Angle (0x3D, 0x07): `panspreadangle`\n   *  * Roll Angle (0x3D, 0x08): `rollangle`\n   *\n   * @method incrementRegisteredParameter\n   * @chainable\n   *\n   * @param parameter {String|Array} A string identifying the parameter\"s name (see above) or a\n   * two-position array specifying the two control bytes (0x65, 0x64) that identify the registered\n   * parameter.\n   *\n   * @param [channel=all] {uint|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws Error The specified parameter is not available.\n   *\n   * @returns {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.incrementRegisteredParameter = function(parameter, channel, options) {\n\n    var that = this;\n\n    options = options || {};\n\n    if ( !Array.isArray(parameter) ) {\n      if ( !wm.MIDI_REGISTERED_PARAMETER[parameter]) {\n        throw new Error(\"The specified parameter is not available.\");\n      }\n      parameter = wm.MIDI_REGISTERED_PARAMETER[parameter];\n    }\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      that._selectRegisteredParameter(parameter, channel, options.time);\n      that.sendControlChange(0x60, 0, channel, {time: options.time});\n      that._deselectRegisteredParameter(channel, options.time);\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Decrements the specified MIDI registered parameter by 1. For more specific MIDI usage\n   * information, check out [RP-18](http://dev.midi.org/techspecs/rp18.php) regarding the usage of\n   * increment and decrement controllers.\n   *\n   * >Unless you are very familiar with the MIDI standard you probably should favour one of the\n   * >simpler to use functions such as: `setPitchbendRange()`, `setModulationRange()`,\n   * >`setMasterTuning()`, etc.\n   *\n   * Here is the full list of parameter names that can be used with this function:\n   *\n   *  * Pitchbend Range (0x00, 0x00): `pitchbendrange`\n   *  * Channel Fine Tuning (0x00, 0x01): `channelfinetuning`\n   *  * Channel Coarse Tuning (0x00, 0x02): `channelcoarsetuning`\n   *  * Tuning Program (0x00, 0x03): `tuningprogram`\n   *  * Tuning Bank (0x00, 0x04): `tuningbank`\n   *  * Modulation Range (0x00, 0x05): `modulationrange`\n   *  * Azimuth Angle (0x3D, 0x00): `azimuthangle`\n   *  * Elevation Angle (0x3D, 0x01): `elevationangle`\n   *  * Gain (0x3D, 0x02): `gain`\n   *  * Distance Ratio (0x3D, 0x03): `distanceratio`\n   *  * Maximum Distance (0x3D, 0x04): `maximumdistance`\n   *  * Maximum Distance Gain (0x3D, 0x05): `maximumdistancegain`\n   *  * Reference Distance Ratio (0x3D, 0x06): `referencedistanceratio`\n   *  * Pan Spread Angle (0x3D, 0x07): `panspreadangle`\n   *  * Roll Angle (0x3D, 0x08): `rollangle`\n   *\n   * @method decrementRegisteredParameter\n   * @chainable\n   *\n   * @param parameter {String|Array} A string identifying the parameter\"s name (see above) or a\n   * two-position array specifying the two control bytes (0x65, 0x64) that identify the registered\n   * parameter.\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws TypeError The specified parameter is not available.\n   *\n   * @returns {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.decrementRegisteredParameter = function(parameter, channel, options) {\n\n    options = options || {};\n\n    if ( !Array.isArray(parameter) ) {\n      if ( !wm.MIDI_REGISTERED_PARAMETER[parameter]) {\n        throw new TypeError(\"The specified parameter is not available.\");\n      }\n      parameter = wm.MIDI_REGISTERED_PARAMETER[parameter];\n    }\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      this._selectRegisteredParameter(parameter, channel, options.time);\n      this.sendControlChange(0x61, 0, channel, {time: options.time});\n      this._deselectRegisteredParameter(channel, options.time);\n    }.bind(this));\n\n    return this;\n\n  };\n\n  /**\n   * Sends a pitch bend range message to the specified channel(s) at the scheduled time so that they\n   * adjust the range used by their pitch bend lever. The range can be specified with the\n   * `semitones` parameter, the `cents` parameter or by specifying both parameters at the same time.\n   *\n   * @method setPitchBendRange\n   * @chainable\n   *\n   * @param [semitones=0] {Number} The desired adjustment value in semitones (integer between\n   * 0-127). While nothing imposes that in the specification, it is very common for manufacturers to\n   * limit the range to 2 octaves (-12 semitones to 12 semitones).\n   *\n   * @param [cents=0] {Number} The desired adjustment value in cents (integer between 0-127).\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws {RangeError} The semitones value must be between 0 and 127.\n   * @throws {RangeError} The cents value must be between 0 and 127.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.setPitchBendRange = function(semitones, cents, channel, options) {\n\n    var that = this;\n\n    options = options || {};\n\n    semitones = Math.floor(semitones) || 0;\n    if ( !(semitones >= 0 && semitones <= 127) ) {\n      throw new RangeError(\"The semitones value must be between 0 and 127\");\n    }\n\n    cents = Math.floor(cents) || 0;\n    if ( !(cents >= 0 && cents <= 127) ) {\n      throw new RangeError(\"The cents value must be between 0 and 127\");\n    }\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      that.setRegisteredParameter(\n        \"pitchbendrange\", [semitones, cents], channel, {time: options.time}\n      );\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Sends a modulation depth range message to the specified channel(s) so that they adjust the\n   * depth of their modulation wheel\"s range. The range can be specified with the `semitones`\n   * parameter, the `cents` parameter or by specifying both parameters at the same time.\n   *\n   * @method setModulationRange\n   * @chainable\n   *\n   * @param [semitones=0] {Number} The desired adjustment value in semitones (integer between\n   * 0-127).\n   *\n   * @param [cents=0] {Number} The desired adjustment value in cents (0-127).\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws {RangeError} The semitones value must be between 0 and 127.\n   * @throws {RangeError} The cents value must be between 0 and 127.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.setModulationRange = function(semitones, cents, channel, options) {\n\n    var that = this;\n\n    options = options || {};\n\n    semitones = Math.floor(semitones) || 0;\n    if ( !(semitones >= 0 && semitones <= 127) ) {\n      throw new RangeError(\"The semitones value must be between 0 and 127\");\n    }\n\n    cents = Math.floor(cents) || 0;\n    if ( !(cents >= 0 && cents <= 127) ) {\n      throw new RangeError(\"The cents value must be between 0 and 127\");\n    }\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      that.setRegisteredParameter(\n        \"modulationrange\", [semitones, cents], channel, {time: options.time}\n      );\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Sends a master tuning message to the specified channel(s). The value is decimal and must be\n   * larger than -65 semitones and smaller than 64 semitones.\n   *\n   * >Because of the way the MIDI specification works, the decimal portion of the value will be\n   * >encoded with a resolution of 14bit. The integer portion must be between -64 and 63\n   * >inclusively. For those familiar with the MIDI protocol, this function actually generates\n   * >**Master Coarse Tuning** and **Master Fine Tuning** RPN messages.\n   *\n   * @method setMasterTuning\n   * @chainable\n   *\n   * @param [value=0.0] {Number} The desired decimal adjustment value in semitones (-65 < x < 64)\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws {RangeError} The value must be a decimal number between larger than -65 and smaller\n   * than 64.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.setMasterTuning = function(value, channel, options) {\n\n    var that = this;\n\n    options = options || {};\n\n    value = parseFloat(value) || 0.0;\n\n    if (value <= -65 || value >= 64) {\n      throw new RangeError(\n        \"The value must be a decimal number larger than -65 and smaller than 64.\"\n      );\n    }\n\n    var coarse = Math.floor(value) + 64;\n    var fine = value - Math.floor(value);\n\n    // Calculate MSB and LSB for fine adjustment (14bit resolution)\n    fine = Math.round((fine + 1) / 2 * 16383);\n    var msb = (fine >> 7) & 0x7F;\n    var lsb = fine & 0x7F;\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      that.setRegisteredParameter(\"channelcoarsetuning\", coarse, channel, {time: options.time});\n      that.setRegisteredParameter(\"channelfinetuning\", [msb, lsb], channel, {time: options.time});\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Sets the MIDI tuning program to use. Note that the **Tuning Program** parameter is part of the\n   * *MIDI Tuning Standard*, which is not widely implemented.\n   *\n   * @method setTuningProgram\n   * @chainable\n   *\n   * @param value {Number} The desired tuning program (0-127).\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws {RangeError} The program value must be between 0 and 127.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.setTuningProgram = function(value, channel, options) {\n\n    var that = this;\n\n    options = options || {};\n\n    value = Math.floor(value);\n    if ( !(value >= 0 && value <= 127) ) {\n      throw new RangeError(\"The program value must be between 0 and 127\");\n    }\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      that.setRegisteredParameter(\"tuningprogram\", value, channel, {time: options.time});\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Sets the MIDI tuning bank to use. Note that the **Tuning Bank** parameter is part of the\n   * *MIDI Tuning Standard*, which is not widely implemented.\n   *\n   * @method setTuningBank\n   * @chainable\n   *\n   * @param value {Number} The desired tuning bank (0-127).\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws {RangeError} The bank value must be between 0 and 127.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.setTuningBank = function(value, channel, options) {\n\n    var that = this;\n\n    options = options || {};\n\n    value = Math.floor(value) || 0;\n    if ( !(value >= 0 && value <= 127) ) {\n      throw new RangeError(\"The bank value must be between 0 and 127\");\n    }\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      that.setRegisteredParameter(\"tuningbank\", value, channel, {time: options.time});\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Sends a MIDI `channel mode` message to the specified channel(s). The channel mode message to\n   * send can be specified numerically or by using one of the following common names:\n   *\n   *   * `allsoundoff` (#120)\n   *   * `resetallcontrollers` (#121)\n   *   * `localcontrol` (#122)\n   *   * `allnotesoff` (#123)\n   *   * `omnimodeoff` (#124)\n   *   * `omnimodeon` (#125)\n   *   * `monomodeon` (#126)\n   *   * `polymodeon` (#127)\n   *\n   * It should be noted that, per the MIDI specification, only `localcontrol` and `monomodeon` may\n   * require a value that\"s not zero. For that reason, the `value` parameter is optional and\n   * defaults to 0.\n   *\n   * @method sendChannelMode\n   * @chainable\n   *\n   * @param command {Number|String} The numerical identifier of the channel mode message (integer\n   * between 120-127) or its name as a string.\n   * @param [value=0] {Number} The value to send (integer between 0-127).\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   * @param {Object} [options={}]\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws {TypeError} Invalid channel mode message name.\n   * @throws {RangeError} Channel mode controller numbers must be between 120 and 127.\n   * @throws {RangeError} Value must be an integer between 0 and 127.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   *\n   */\n  Output.prototype.sendChannelMode = function(command, value, channel, options) {\n\n    options = options || {};\n\n    if (typeof command === \"string\") {\n\n      command = wm.MIDI_CHANNEL_MODE_MESSAGES[command];\n\n      if (!command) {\n        throw new TypeError(\"Invalid channel mode message name.\");\n      }\n\n    } else {\n\n      command = Math.floor(command);\n\n      if ( !(command >= 120 && command <= 127) ) {\n        throw new RangeError(\"Channel mode numerical identifiers must be between 120 and 127.\");\n      }\n\n    }\n\n    value = Math.floor(value) || 0;\n\n    if (value < 0 || value > 127) {\n      throw new RangeError(\"Value must be an integer between 0 and 127.\");\n    }\n\n    wm.toMIDIChannels(channel).forEach(function(ch) {\n\n      this.send(\n        (wm.MIDI_CHANNEL_MESSAGES.channelmode << 4) + (ch - 1),\n        [command, value],\n        this._parseTimeParameter(options.time)\n      );\n\n    }.bind(this));\n\n    return this;\n\n  };\n\n  /**\n   * Sends a MIDI `program change` message to the specified channel(s) at the scheduled time.\n   *\n   * @method sendProgramChange\n   * @chainable\n   *\n   * @param program {Number} The MIDI patch (program) number (0-127)\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws {RangeError} Program numbers must be between 0 and 127.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   *\n   */\n  Output.prototype.sendProgramChange = function(program, channel, options) {\n\n    var that = this;\n\n    options = options || {};\n\n    program = Math.floor(program);\n    if (isNaN(program) || program < 0 || program > 127) {\n      throw new RangeError(\"Program numbers must be between 0 and 127.\");\n    }\n\n    wm.toMIDIChannels(channel).forEach(function(ch) {\n      that.send(\n        (wm.MIDI_CHANNEL_MESSAGES.programchange << 4) + (ch - 1),\n        [program],\n        that._parseTimeParameter(options.time)\n      );\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Sends a MIDI `channel aftertouch` message to the specified channel(s). For key-specific\n   * aftertouch, you should instead use `sendKeyAftertouch()`.\n   *\n   * @method sendChannelAftertouch\n   * @chainable\n   *\n   * @param [pressure=0.5] {Number} The pressure level (between 0 and 1). An invalid pressure value\n   * will silently trigger the default behaviour.\n   *\n   * @param [channel=all] {Number|Array|String}  The MIDI channel number (between 1 and 16) or\n   * an array of channel numbers. If the special value \"all\" is used, the message will be sent to\n   * all 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendChannelAftertouch = function(pressure, channel, options) {\n\n    var that = this;\n\n    options = options || {};\n\n    pressure = parseFloat(pressure);\n    if (isNaN(pressure) || pressure < 0 || pressure > 1) { pressure = 0.5; }\n\n    var nPressure = Math.round(pressure * 127);\n\n    wm.toMIDIChannels(channel).forEach(function(ch) {\n      that.send(\n        (wm.MIDI_CHANNEL_MESSAGES.channelaftertouch << 4) + (ch - 1),\n        [nPressure],\n        that._parseTimeParameter(options.time)\n      );\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Sends a MIDI `pitch bend` message to the specified channel(s) at the scheduled time.\n   *\n   * @method sendPitchBend\n   * @chainable\n   *\n   * @param bend {Number} The intensity level of the bend (between -1 and 1). A value of zero means\n   * no bend.\n   *\n   * @param [channel=all] {Number|Array|String}  The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws {RangeError} Pitch bend value must be between -1 and 1.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendPitchBend = function(bend, channel, options) {\n\n    var that = this;\n\n    options = options || {};\n\n    if (isNaN(bend) || bend < -1 || bend > 1) {\n      throw new RangeError(\"Pitch bend value must be between -1 and 1.\");\n    }\n\n    var nLevel = Math.round((bend + 1) / 2 * 16383);\n    var msb = (nLevel >> 7) & 0x7F;\n    var lsb = nLevel & 0x7F;\n\n    wm.toMIDIChannels(channel).forEach(function(ch) {\n      that.send(\n        (wm.MIDI_CHANNEL_MESSAGES.pitchbend << 4) + (ch - 1),\n        [lsb, msb],\n        that._parseTimeParameter(options.time)\n      );\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Returns a timestamp, relative to the navigation start of the document, derived from the `time`\n   * parameter. If the parameter is a string starting with the \"+\" sign and followed by a number,\n   * the resulting value will be the sum of the current timestamp plus that number. Otherwise, the\n   * value will be returned as is.\n   *\n   * If the calculated return value is 0, less than zero or an otherwise invalid value, `undefined`\n   * will be returned.\n   *\n   * @method _parseTimeParameter\n   * @param [time] {Number|String}\n   * @return DOMHighResTimeStamp\n   * @protected\n   */\n  Output.prototype._parseTimeParameter = function(time) {\n\n    var value,\n      parsed = parseFloat(time);\n\n    if (typeof time === \"string\" && time.substring(0, 1) === \"+\") {\n      if (parsed && parsed > 0) value = wm.time + parsed;\n    } else {\n      if (parsed > wm.time) value = parsed;\n    }\n\n    return value;\n\n  };\n\n  /**\n   * Converts an input value (which can be a uint, a string or an array of the previous two) to an\n   * array of MIDI note numbers.\n   *\n   * @method _convertNoteToArray\n   * @param [note] {Number|Array|String}\n   * @returns {Array}\n   * @protected\n   */\n  Output.prototype._convertNoteToArray = function(note) {\n\n    var notes = [];\n\n    if ( !Array.isArray(note) ) { note = [note]; }\n\n    note.forEach(function(item) {\n      notes.push(wm.guessNoteNumber(item));\n    });\n\n    return notes;\n\n  };\n\n  // Check if RequireJS/AMD is used. If it is, use it to define our module instead of\n  // polluting the global space.\n  if ( typeof define === \"function\" && typeof define.amd === \"object\") {\n    define([], function () {\n      return wm;\n    });\n  } else if (typeof module !== \"undefined\" && module.exports) {\n    module.exports = wm;\n  } else {\n    if (!scope.WebMidi) { scope.WebMidi = wm; }\n  }\n\n}(this));\n"]}]}