{"remainingRequest":"/Users/huntermedlen/Programming/music-trainer/frontend/node_modules/babel-loader/lib/index.js!/Users/huntermedlen/Programming/music-trainer/frontend/src/webmidi.js","dependencies":[{"path":"/Users/huntermedlen/Programming/music-trainer/frontend/src/webmidi.js","mtime":1588452799777},{"path":"/Users/huntermedlen/Programming/music-trainer/frontend/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/huntermedlen/Programming/music-trainer/frontend/node_modules/babel-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:cmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmNvbmNhdCIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmV2ZXJ5Iik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuZmlsdGVyIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuZm9yLWVhY2giKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5pbmRleC1vZiIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmlzLWFycmF5Iik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkubWFwIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuc3BsaWNlIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuZnVuY3Rpb24uYmluZCIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmZ1bmN0aW9uLm5hbWUiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5udW1iZXIudG8tZml4ZWQiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5vYmplY3QuZGVmaW5lLXByb3BlcnRpZXMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5vYmplY3QudG8tc3RyaW5nIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMucGFyc2UtZmxvYXQiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5wYXJzZS1pbnQiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5yZWdleHAuZXhlYyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnN0cmluZy5pdGVyYXRvciIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnN0cmluZy5tYXRjaCIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL3dlYi5kb20tY29sbGVjdGlvbnMuZm9yLWVhY2giKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy93ZWIuZG9tLWNvbGxlY3Rpb25zLml0ZXJhdG9yIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvd2ViLnRpbWVycyIpOwoKdmFyIF90eXBlb2YgPSByZXF1aXJlKCIvVXNlcnMvaHVudGVybWVkbGVuL1Byb2dyYW1taW5nL211c2ljLXRyYWluZXIvZnJvbnRlbmQvbm9kZV9tb2R1bGVzL0BiYWJlbC9ydW50aW1lL2hlbHBlcnMvdHlwZW9mIik7CgooZnVuY3Rpb24gKHNjb3BlKSB7CiAgInVzZSBzdHJpY3QiOwogIC8qKgogICAqIFRoZSBgV2ViTWlkaWAgb2JqZWN0IG1ha2VzIGl0IGVhc2llciB0byB3b3JrIHdpdGggdGhlIFdlYiBNSURJIEFQSS4gQmFzaWNhbGx5LCBpdCBzaW1wbGlmaWVzCiAgICogdHdvIHRoaW5nczogc2VuZGluZyBvdXRnb2luZyBNSURJIG1lc3NhZ2VzIGFuZCByZWFjdGluZyB0byBpbmNvbWluZyBNSURJIG1lc3NhZ2VzLgogICAqCiAgICogU2VuZGluZyBNSURJIG1lc3NhZ2VzIGlzIGRvbmUgdmlhIGFuIGBPdXRwdXRgIG9iamVjdC4gQWxsIGF2YWlsYWJsZSBvdXRwdXRzIGNhbiBiZSBhY2Nlc3NlZCBpbgogICAqIHRoZSBgV2ViTWlkaS5vdXRwdXRzYCBhcnJheS4gVGhlcmUgaXMgb25lIGBPdXRwdXRgIG9iamVjdCBmb3IgZWFjaCBvdXRwdXQgcG9ydCBhdmFpbGFibGUgb24KICAgKiB5b3VyIHN5c3RlbS4gU2ltaWxhcmx5LCByZWFjdGluZyB0byBNSURJIG1lc3NhZ2VzIGFzIHRoZXkgYXJlIGNvbWluZyBpbiBpcyBzaW1wbHkgYSBtYXR0ZXIgb2YKICAgKiBhZGRpbmcgYSBsaXN0ZW5lciB0byBhbiBgSW5wdXRgIG9iamVjdC4gU2ltaWxhcmx5LCBhbGwgaW5wdXRzIGNhbiBiZSBmb3VuZCBpbiB0aGUKICAgKiBgV2ViTWlkaS5pbnB1dHNgIGFycmF5LgogICAqCiAgICogUGxlYXNlIG5vdGUgdGhhdCBhIHNpbmdsZSBoYXJkd2FyZSBkZXZpY2UgbWlnaHQgY3JlYXRlIG1vcmUgdGhhbiBvbmUgaW5wdXQgYW5kL29yIG91dHB1dCBwb3J0cy4KICAgKgogICAqICMjIyMgU2VuZGluZyBtZXNzYWdlcwogICAqCiAgICogVG8gc2VuZCBNSURJIG1lc3NhZ2VzLCB5b3Ugc2ltcGx5IG5lZWQgdG8gY2FsbCB0aGUgZGVzaXJlZCBtZXRob2QgKGBwbGF5Tm90ZSgpYCwKICAgKiBgc2VuZFBpdGNoQmVuZCgpYCwgYHN0b3BOb3RlKClgLCBldGMuKSBmcm9tIGFuIGBPdXRwdXRgIG9iamVjdCBhbmQgcGFzcyBpbiB0aGUgYXBwcm9wcmlhdGUKICAgKiBwYXJhbWV0ZXJzLiBBbGwgdGhlIG5hdGl2ZSBNSURJIGNvbW11bmljYXRpb24gd2lsbCBiZSBoYW5kbGVkIGZvciB5b3UuIFRoZSBvbmx5IGFkZGl0aW9uYWwKICAgKiB0aGluZyB0aGF0IG5lZWRzIHRvIGJlIGRvbmUgaXMgdG8gZmlyc3QgZW5hYmxlIGBXZWJNaWRpYC4gSGVyZSBpcyBhbiBleGFtcGxlOgogICAqCiAgICogICAgICBXZWJNaWRpLmVuYWJsZShmdW5jdGlvbihlcnIpIHsKICAgKiAgICAgICAgaWYgKGVycikgY29uc29sZS5sb2coIkFuIGVycm9yIG9jY3VycmVkIiwgZXJyKTsKICAgKiAgICAgICAgV2ViTWlkaS5vdXRwdXRzWzBdLnBsYXlOb3RlKCJDMyIpOwogICAqICAgICAgfSk7CiAgICoKICAgKiBUaGUgY29kZSBhYm92ZSwgY2FsbHMgdGhlIGBXZWJNaWRpLmVuYWJsZSgpYCBtZXRob2QuIFVwb24gc3VjY2VzcywgdGhpcyBtZXRob2QgZXhlY3V0ZXMgdGhlCiAgICogY2FsbGJhY2sgZnVuY3Rpb24gc3BlY2lmaWVkIGFzIGEgcGFyYW1ldGVyLiBJbiB0aGlzIGNhc2UsIHRoZSBjYWxsYmFjayBjYWxscyB0aGUgYHBsYXlub3RlKClgCiAgICogZnVuY3Rpb24gdG8gcGxheSBhIDNyZCBvY3RhdmUgQyBvbiB0aGUgZmlyc3QgYXZhaWxhYmxlIG91dHB1dCBwb3J0LgogICAqCiAgICogIyMjIyBSZWNlaXZpbmcgbWVzc2FnZXMKICAgKgogICAqIFJlY2VpdmluZyBtZXNzYWdlcyBpcyBqdXN0IGFzIGVhc3kuIFlvdSBzaW1wbHkgaGF2ZSB0byBzZXQgYSBjYWxsYmFjayBmdW5jdGlvbiB0byBiZSB0cmlnZ2VyZWQKICAgKiB3aGVuIGEgc3BlY2lmaWMgTUlESSBtZXNzYWdlIGlzIHJlY2VpdmVkLiBGb3IgZXhhbXBsZSwgaGVyZSJzIGhvdyB0byBsaXN0ZW4gZm9yIHBpdGNoIGJlbmQKICAgKiBldmVudHMgb24gdGhlIGZpcnN0IGlucHV0IHBvcnQ6CiAgICoKICAgKiAgICAgIFdlYk1pZGkuZW5hYmxlKGZ1bmN0aW9uKGVycikgewogICAqICAgICAgICBpZiAoZXJyKSBjb25zb2xlLmxvZygiQW4gZXJyb3Igb2NjdXJyZWQiLCBlcnIpOwogICAqCiAgICogICAgICAgIFdlYk1pZGkuaW5wdXRzWzBdLmFkZExpc3RlbmVyKCJwaXRjaGJlbmQiLCAiYWxsIiwgZnVuY3Rpb24oZSkgewogICAqICAgICAgICAgIGNvbnNvbGUubG9nKCJQaXRjaCB2YWx1ZTogIiArIGUudmFsdWUpOwogICAqICAgICAgICB9KTsKICAgKgogICAqICAgICAgfSk7CiAgICoKICAgKiBBcyB5b3UgY2FuIHNlZSwgdGhpcyBsaWJyYXJ5IGlzIG11Y2ggZWFzaWVyIHRvIHVzZSB0aGFuIHRoZSBuYXRpdmUgV2ViIE1JREkgQVBJLiBObyBuZWVkIHRvCiAgICogbWFudWFsbHkgY3JhZnQgb3IgZGVjb2RlIGJpbmFyeSBNSURJIG1lc3NhZ2VzIGFueW1vcmUhCiAgICoKICAgKiBAY2xhc3MgV2ViTWlkaQogICAqIEBzdGF0aWMKICAgKgogICAqIEB0aHJvd3MgRXJyb3IgV2ViTWlkaSBpcyBhIHNpbmdsZXRvbiwgaXQgY2Fubm90IGJlIGluc3RhbnRpYXRlZCBkaXJlY3RseS4KICAgKgogICAqIEB0b2RvICBTd2l0Y2ggYXdheSBmcm9tIHl1aWRvYyAoZGVwcmVjYXRlZCkgdG8gYmUgYWJsZSB0byBzZXJ2ZSBkb2Mgb3ZlciBodHRwcwogICAqIEB0b2RvICBZdWlkb2MgZG9lcyBub3QgYWxsb3cgbXVsdGlwbGUgZXhjZXB0aW9ucyAoQHRocm93cykgZm9yIGEgc2luZ2xlIG1ldGhvZCA/IQogICAqCiAgICovCgogIGZ1bmN0aW9uIFdlYk1pZGkoKSB7CiAgICAvLyBTaW5nbGV0b24uIFByZXZlbnQgaW5zdGFudGlhdGlvbiB0aHJvdWdoIFdlYk1pZGkuX19wcm90b19fLmNvbnN0cnVjdG9yKCkKICAgIGlmIChXZWJNaWRpLnByb3RvdHlwZS5fc2luZ2xldG9uKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiV2ViTWlkaSBpcyBhIHNpbmdsZXRvbiwgaXQgY2Fubm90IGJlIGluc3RhbnRpYXRlZCBkaXJlY3RseS4iKTsKICAgIH0KCiAgICBXZWJNaWRpLnByb3RvdHlwZS5fc2luZ2xldG9uID0gdGhpczsgLy8gTUlESSBpbnB1dHMgYW5kIG91dHB1dHMKCiAgICB0aGlzLl9pbnB1dHMgPSBbXTsKICAgIHRoaXMuX291dHB1dHMgPSBbXTsgLy8gT2JqZWN0IHRvIGhvbGQgYWxsIHVzZXItZGVmaW5lZCBoYW5kbGVycyBmb3IgaW50ZXJmYWNlLXdpZGUgZXZlbnRzIChjb25uZWN0ZWQsIGRpc2Nvbm5lY3RlZCwKICAgIC8vIGV0Yy4pCgogICAgdGhpcy5fdXNlckhhbmRsZXJzID0ge307IC8vIEFycmF5IG9mIHN0YXRlY2hhbmdlIGV2ZW50cyB0byBwcm9jZXNzLiBUaGVzZSBldmVudHMgbXVzdCBiZSBwYXJzZWQgc3luY2hyb25vdXNseSBzbyB0aGV5IGRvCiAgICAvLyBub3Qgb3ZlcnJpZGUgZWFjaCBvdGhlci4KCiAgICB0aGlzLl9zdGF0ZUNoYW5nZVF1ZXVlID0gW107IC8vIEluZGljYXRlcyB3aGV0aGVyIHdlIGFyZSBjdXJyZW50bHkgcHJvY2Vzc2luZyBhIHN0YXRlY2hhbmdlIGV2ZW50IChpbiB3aGljaCBjYXNlIG5ldyBldmVudHMKICAgIC8vIGFyZSB0byBiZSBxdWV1ZWQpLgoKICAgIHRoaXMuX3Byb2Nlc3NpbmdTdGF0ZUNoYW5nZSA9IGZhbHNlOyAvLyBFdmVudHMgdHJpZ2dlcmVkIGF0IHRoZSBpbnRlcmZhY2UgbGV2ZWwgKFdlYk1pZGkpCgogICAgdGhpcy5fbWlkaUludGVyZmFjZUV2ZW50cyA9IFsiY29ubmVjdGVkIiwgImRpc2Nvbm5lY3RlZCJdOyAvLyB0aGUgY3VycmVudCBucnBucyBiZWluZyBjb25zdHJ1Y3RlZCwgYnkgY2hhbm5lbAoKICAgIHRoaXMuX25ycG5CdWZmZXIgPSBbW10sIFtdLCBbXSwgW10sIFtdLCBbXSwgW10sIFtdLCBbXSwgW10sIFtdLCBbXSwgW10sIFtdLCBbXSwgW11dOyAvLyBFbmFibGUvRGlzYWJsZSBOUlBOIGV2ZW50IGRpc3BhdGNoCgogICAgdGhpcy5fbnJwbkV2ZW50c0VuYWJsZWQgPSB0cnVlOyAvLyBOUlBOIG1lc3NhZ2UgdHlwZXMKCiAgICB0aGlzLl9ucnBuVHlwZXMgPSBbImVudHJ5IiwgImluY3JlbWVudCIsICJkZWNyZW1lbnQiXTsgLy8gTm90ZXMgYW5kIHNlbWl0b25lcyBmb3Igbm90ZSBndWVzc2luZwoKICAgIHRoaXMuX25vdGVzID0gWyJDIiwgIkMjIiwgIkQiLCAiRCMiLCAiRSIsICJGIiwgIkYjIiwgIkciLCAiRyMiLCAiQSIsICJBIyIsICJCIl07CiAgICB0aGlzLl9zZW1pdG9uZXMgPSB7CiAgICAgIEM6IDAsCiAgICAgIEQ6IDIsCiAgICAgIEU6IDQsCiAgICAgIEY6IDUsCiAgICAgIEc6IDcsCiAgICAgIEE6IDksCiAgICAgIEI6IDExCiAgICB9OyAvLyBEZWZpbmUgc29tZSAic3RhdGljIiBwcm9wZXJ0aWVzCgogICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXModGhpcywgewogICAgICAvKioKICAgICAgICogW3JlYWQtb25seV0gTGlzdCBvZiB2YWxpZCBNSURJIHN5c3RlbSBtZXNzYWdlcyBhbmQgbWF0Y2hpbmcgaGV4YWRlY2ltYWwgdmFsdWVzLgogICAgICAgKgogICAgICAgKiBOb3RlOiB2YWx1ZXMgMjQ5IGFuZCAyNTMgYXJlIGFjdHVhbGx5IGRpc3BhdGNoZWQgYnkgdGhlIFdlYiBNSURJIEFQSSBidXQgSSBkbyBub3Qga25vdyB3aGF0CiAgICAgICAqIHRoZXkgYXJlIHVzZWQgZm9yLiBUaGV5IGFyZSBub3QgcGFydCBvZiB0aGUgb25saW5lCiAgICAgICAqIFtNSURJIDEuMCBzcGVjXShodHRwOi8vd3d3Lm1pZGkub3JnL3RlY2hzcGVjcy9taWRpbWVzc2FnZXMucGhwKS4KICAgICAgICoKICAgICAgICogQHByb3BlcnR5IE1JRElfU1lTVEVNX01FU1NBR0VTCiAgICAgICAqIEB0eXBlIE9iamVjdAogICAgICAgKiBAc3RhdGljCiAgICAgICAqCiAgICAgICAqIEBzaW5jZSAyLjAuMAogICAgICAgKi8KICAgICAgTUlESV9TWVNURU1fTUVTU0FHRVM6IHsKICAgICAgICB2YWx1ZTogewogICAgICAgICAgLy8gU3lzdGVtIGNvbW1vbiBtZXNzYWdlcwogICAgICAgICAgc3lzZXg6IDB4RjAsCiAgICAgICAgICAvLyAyNDAKICAgICAgICAgIHRpbWVjb2RlOiAweEYxLAogICAgICAgICAgLy8gMjQxCiAgICAgICAgICBzb25ncG9zaXRpb246IDB4RjIsCiAgICAgICAgICAvLyAyNDIKICAgICAgICAgIHNvbmdzZWxlY3Q6IDB4RjMsCiAgICAgICAgICAvLyAyNDMKICAgICAgICAgIHR1bmluZ3JlcXVlc3Q6IDB4RjYsCiAgICAgICAgICAvLyAyNDYKICAgICAgICAgIHN5c2V4ZW5kOiAweEY3LAogICAgICAgICAgLy8gMjQ3IChuZXZlciBhY3R1YWxseSByZWNlaXZlZCAtIHNpbXBseSBlbmRzIGEgc3lzZXgpCiAgICAgICAgICAvLyBTeXN0ZW0gcmVhbC10aW1lIG1lc3NhZ2VzCiAgICAgICAgICBjbG9jazogMHhGOCwKICAgICAgICAgIC8vIDI0OAogICAgICAgICAgc3RhcnQ6IDB4RkEsCiAgICAgICAgICAvLyAyNTAKICAgICAgICAgICJjb250aW51ZSI6IDB4RkIsCiAgICAgICAgICAvLyAyNTEKICAgICAgICAgIHN0b3A6IDB4RkMsCiAgICAgICAgICAvLyAyNTIKICAgICAgICAgIGFjdGl2ZXNlbnNpbmc6IDB4RkUsCiAgICAgICAgICAvLyAyNTQKICAgICAgICAgIHJlc2V0OiAweEZGLAogICAgICAgICAgLy8gMjU1CiAgICAgICAgICAvLyBDdXN0b20gV2ViTWlkaS5qcyBtZXNzYWdlcwogICAgICAgICAgbWlkaW1lc3NhZ2U6IDAsCiAgICAgICAgICB1bmtub3duc3lzdGVtbWVzc2FnZTogLTEKICAgICAgICB9LAogICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBbcmVhZC1vbmx5XSBBbiBvYmplY3QgY29udGFpbmluZyBwcm9wZXJ0aWVzIGZvciBlYWNoIE1JREkgY2hhbm5lbCBtZXNzYWdlcyBhbmQgdGhlaXIKICAgICAgICogYXNzb2NpYXRlZCBoZXhhZGVjaW1hbCB2YWx1ZS4KICAgICAgICoKICAgICAgICogQHByb3BlcnR5IE1JRElfQ0hBTk5FTF9NRVNTQUdFUwogICAgICAgKiBAdHlwZSBPYmplY3QKICAgICAgICogQHN0YXRpYwogICAgICAgKgogICAgICAgKiBAc2luY2UgMi4wLjAKICAgICAgICovCiAgICAgIE1JRElfQ0hBTk5FTF9NRVNTQUdFUzogewogICAgICAgIHZhbHVlOiB7CiAgICAgICAgICBub3Rlb2ZmOiAweDgsCiAgICAgICAgICAvLyA4CiAgICAgICAgICBub3Rlb246IDB4OSwKICAgICAgICAgIC8vIDkKICAgICAgICAgIGtleWFmdGVydG91Y2g6IDB4QSwKICAgICAgICAgIC8vIDEwCiAgICAgICAgICBjb250cm9sY2hhbmdlOiAweEIsCiAgICAgICAgICAvLyAxMQogICAgICAgICAgY2hhbm5lbG1vZGU6IDB4QiwKICAgICAgICAgIC8vIDExCiAgICAgICAgICBucnBuOiAweEIsCiAgICAgICAgICAvLyAxMQogICAgICAgICAgcHJvZ3JhbWNoYW5nZTogMHhDLAogICAgICAgICAgLy8gMTIKICAgICAgICAgIGNoYW5uZWxhZnRlcnRvdWNoOiAweEQsCiAgICAgICAgICAvLyAxMwogICAgICAgICAgcGl0Y2hiZW5kOiAweEUgLy8gMTQKCiAgICAgICAgfSwKICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlCiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogW3JlYWQtb25seV0gQW4gb2JqZWN0IGNvbnRhaW5pbmcgcHJvcGVydGllcyBmb3IgZWFjaCByZWdpc3RlcmVkIHBhcmFtZXRlcnMgYW5kIHRoZWlyCiAgICAgICAqIGFzc29jaWF0ZWQgcGFpciBvZiBoZXhhZGVjaW1hbCB2YWx1ZXMuIE1JREkgcmVnaXN0ZXJlZCBwYXJhbWV0ZXJzIGV4dGVuZCB0aGUgb3JpZ2luYWwgbGlzdAogICAgICAgKiBvZiBjb250cm9sIGNoYW5nZSBtZXNzYWdlcyAoYS5rLmEuIENDIG1lc3NhZ2VzKS4gQ3VycmVudGx5LCB0aGVyZSBhcmUgb25seSBhIGxpbWl0ZWQgbnVtYmVyCiAgICAgICAqIG9mIHRoZW0uCiAgICAgICAqCiAgICAgICAqIEBwcm9wZXJ0eSBNSURJX1JFR0lTVEVSRURfUEFSQU1FVEVSCiAgICAgICAqIEB0eXBlIE9iamVjdAogICAgICAgKiBAc3RhdGljCiAgICAgICAqCiAgICAgICAqIEBzaW5jZSAyLjAuMAogICAgICAgKi8KICAgICAgTUlESV9SRUdJU1RFUkVEX1BBUkFNRVRFUjogewogICAgICAgIHZhbHVlOiB7CiAgICAgICAgICBwaXRjaGJlbmRyYW5nZTogWzB4MDAsIDB4MDBdLAogICAgICAgICAgY2hhbm5lbGZpbmV0dW5pbmc6IFsweDAwLCAweDAxXSwKICAgICAgICAgIGNoYW5uZWxjb2Fyc2V0dW5pbmc6IFsweDAwLCAweDAyXSwKICAgICAgICAgIHR1bmluZ3Byb2dyYW06IFsweDAwLCAweDAzXSwKICAgICAgICAgIHR1bmluZ2Jhbms6IFsweDAwLCAweDA0XSwKICAgICAgICAgIG1vZHVsYXRpb25yYW5nZTogWzB4MDAsIDB4MDVdLAogICAgICAgICAgYXppbXV0aGFuZ2xlOiBbMHgzRCwgMHgwMF0sCiAgICAgICAgICBlbGV2YXRpb25hbmdsZTogWzB4M0QsIDB4MDFdLAogICAgICAgICAgZ2FpbjogWzB4M0QsIDB4MDJdLAogICAgICAgICAgZGlzdGFuY2VyYXRpbzogWzB4M0QsIDB4MDNdLAogICAgICAgICAgbWF4aW11bWRpc3RhbmNlOiBbMHgzRCwgMHgwNF0sCiAgICAgICAgICBtYXhpbXVtZGlzdGFuY2VnYWluOiBbMHgzRCwgMHgwNV0sCiAgICAgICAgICByZWZlcmVuY2VkaXN0YW5jZXJhdGlvOiBbMHgzRCwgMHgwNl0sCiAgICAgICAgICBwYW5zcHJlYWRhbmdsZTogWzB4M0QsIDB4MDddLAogICAgICAgICAgcm9sbGFuZ2xlOiBbMHgzRCwgMHgwOF0KICAgICAgICB9LAogICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBbcmVhZC1vbmx5XSBBbiBvYmplY3QgY29udGFpbmluZyBwcm9wZXJ0aWVzIGZvciBlYWNoIE1JREkgY29udHJvbCBjaGFuZ2UgbWVzc2FnZXMgKGEuay5hLgogICAgICAgKiBDQyBtZXNzYWdlcykgYW5kIHRoZWlyIGFzc29jaWF0ZWQgaGV4YWRlY2ltYWwgdmFsdWUuCiAgICAgICAqCiAgICAgICAqIEBwcm9wZXJ0eSBNSURJX0NPTlRST0xfQ0hBTkdFX01FU1NBR0VTCiAgICAgICAqIEB0eXBlIE9iamVjdAogICAgICAgKiBAc3RhdGljCiAgICAgICAqCiAgICAgICAqIEBzaW5jZSAyLjAuMAogICAgICAgKi8KICAgICAgTUlESV9DT05UUk9MX0NIQU5HRV9NRVNTQUdFUzogewogICAgICAgIHZhbHVlOiB7CiAgICAgICAgICBiYW5rc2VsZWN0Y29hcnNlOiAwLAogICAgICAgICAgbW9kdWxhdGlvbndoZWVsY29hcnNlOiAxLAogICAgICAgICAgYnJlYXRoY29udHJvbGxlcmNvYXJzZTogMiwKICAgICAgICAgIGZvb3Rjb250cm9sbGVyY29hcnNlOiA0LAogICAgICAgICAgcG9ydGFtZW50b3RpbWVjb2Fyc2U6IDUsCiAgICAgICAgICBkYXRhZW50cnljb2Fyc2U6IDYsCiAgICAgICAgICB2b2x1bWVjb2Fyc2U6IDcsCiAgICAgICAgICBiYWxhbmNlY29hcnNlOiA4LAogICAgICAgICAgcGFuY29hcnNlOiAxMCwKICAgICAgICAgIGV4cHJlc3Npb25jb2Fyc2U6IDExLAogICAgICAgICAgZWZmZWN0Y29udHJvbDFjb2Fyc2U6IDEyLAogICAgICAgICAgZWZmZWN0Y29udHJvbDJjb2Fyc2U6IDEzLAogICAgICAgICAgZ2VuZXJhbHB1cnBvc2VzbGlkZXIxOiAxNiwKICAgICAgICAgIGdlbmVyYWxwdXJwb3Nlc2xpZGVyMjogMTcsCiAgICAgICAgICBnZW5lcmFscHVycG9zZXNsaWRlcjM6IDE4LAogICAgICAgICAgZ2VuZXJhbHB1cnBvc2VzbGlkZXI0OiAxOSwKICAgICAgICAgIGJhbmtzZWxlY3RmaW5lOiAzMiwKICAgICAgICAgIG1vZHVsYXRpb253aGVlbGZpbmU6IDMzLAogICAgICAgICAgYnJlYXRoY29udHJvbGxlcmZpbmU6IDM0LAogICAgICAgICAgZm9vdGNvbnRyb2xsZXJmaW5lOiAzNiwKICAgICAgICAgIHBvcnRhbWVudG90aW1lZmluZTogMzcsCiAgICAgICAgICBkYXRhZW50cnlmaW5lOiAzOCwKICAgICAgICAgIHZvbHVtZWZpbmU6IDM5LAogICAgICAgICAgYmFsYW5jZWZpbmU6IDQwLAogICAgICAgICAgcGFuZmluZTogNDIsCiAgICAgICAgICBleHByZXNzaW9uZmluZTogNDMsCiAgICAgICAgICBlZmZlY3Rjb250cm9sMWZpbmU6IDQ0LAogICAgICAgICAgZWZmZWN0Y29udHJvbDJmaW5lOiA0NSwKICAgICAgICAgIGhvbGRwZWRhbDogNjQsCiAgICAgICAgICBwb3J0YW1lbnRvOiA2NSwKICAgICAgICAgIHN1c3RlbnV0b3BlZGFsOiA2NiwKICAgICAgICAgIHNvZnRwZWRhbDogNjcsCiAgICAgICAgICBsZWdhdG9wZWRhbDogNjgsCiAgICAgICAgICBob2xkMnBlZGFsOiA2OSwKICAgICAgICAgIHNvdW5kdmFyaWF0aW9uOiA3MCwKICAgICAgICAgIHJlc29uYW5jZTogNzEsCiAgICAgICAgICBzb3VuZHJlbGVhc2V0aW1lOiA3MiwKICAgICAgICAgIHNvdW5kYXR0YWNrdGltZTogNzMsCiAgICAgICAgICBicmlnaHRuZXNzOiA3NCwKICAgICAgICAgIHNvdW5kY29udHJvbDY6IDc1LAogICAgICAgICAgc291bmRjb250cm9sNzogNzYsCiAgICAgICAgICBzb3VuZGNvbnRyb2w4OiA3NywKICAgICAgICAgIHNvdW5kY29udHJvbDk6IDc4LAogICAgICAgICAgc291bmRjb250cm9sMTA6IDc5LAogICAgICAgICAgZ2VuZXJhbHB1cnBvc2VidXR0b24xOiA4MCwKICAgICAgICAgIGdlbmVyYWxwdXJwb3NlYnV0dG9uMjogODEsCiAgICAgICAgICBnZW5lcmFscHVycG9zZWJ1dHRvbjM6IDgyLAogICAgICAgICAgZ2VuZXJhbHB1cnBvc2VidXR0b240OiA4MywKICAgICAgICAgIHJldmVyYmxldmVsOiA5MSwKICAgICAgICAgIHRyZW1vbG9sZXZlbDogOTIsCiAgICAgICAgICBjaG9ydXNsZXZlbDogOTMsCiAgICAgICAgICBjZWxlc3RlbGV2ZWw6IDk0LAogICAgICAgICAgcGhhc2VybGV2ZWw6IDk1LAogICAgICAgICAgZGF0YWJ1dHRvbmluY3JlbWVudDogOTYsCiAgICAgICAgICBkYXRhYnV0dG9uZGVjcmVtZW50OiA5NywKICAgICAgICAgIG5vbnJlZ2lzdGVyZWRwYXJhbWV0ZXJjb2Fyc2U6IDk4LAogICAgICAgICAgbm9ucmVnaXN0ZXJlZHBhcmFtZXRlcmZpbmU6IDk5LAogICAgICAgICAgcmVnaXN0ZXJlZHBhcmFtZXRlcmNvYXJzZTogMTAwLAogICAgICAgICAgcmVnaXN0ZXJlZHBhcmFtZXRlcmZpbmU6IDEwMQogICAgICAgIH0sCiAgICAgICAgd3JpdGFibGU6IGZhbHNlLAogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIFtyZWFkLW9ubHldIEFuIG9iamVjdCBjb250YWluaW5nIHByb3BlcnRpZXMgZm9yIE1JREkgY29udHJvbCBjaGFuZ2UgbWVzc2FnZXMKICAgICAgICogdGhhdCBtYWtlIHVwIE5SUE4gbWVzc2FnZXMKICAgICAgICoKICAgICAgICogQHByb3BlcnR5IE1JRElfTlJQTl9NRVNTQUdFUwogICAgICAgKiBAdHlwZSBPYmplY3QKICAgICAgICogQHN0YXRpYwogICAgICAgKgogICAgICAgKiBAc2luY2UgMi4wLjAKICAgICAgICovCiAgICAgIE1JRElfTlJQTl9NRVNTQUdFUzogewogICAgICAgIHZhbHVlOiB7CiAgICAgICAgICBlbnRyeW1zYjogNiwKICAgICAgICAgIGVudHJ5bHNiOiAzOCwKICAgICAgICAgIGluY3JlbWVudDogOTYsCiAgICAgICAgICBkZWNyZW1lbnQ6IDk3LAogICAgICAgICAgcGFyYW1sc2I6IDk4LAogICAgICAgICAgcGFyYW1tc2I6IDk5LAogICAgICAgICAgbnVsbGFjdGl2ZXBhcmFtZXRlcjogMTI3CiAgICAgICAgfSwKICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlCiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogW3JlYWQtb25seV0gTGlzdCBvZiBNSURJIGNoYW5uZWwgbW9kZSBtZXNzYWdlcyBhcyBkZWZpbmVkIGluIHRoZSBvZmZpY2lhbCBNSURJCiAgICAgICAqIHNwZWNpZmljYXRpb24uCiAgICAgICAqCiAgICAgICAqIEBwcm9wZXJ0eSBNSURJX0NIQU5ORUxfTU9ERV9NRVNTQUdFUwogICAgICAgKiBAdHlwZSBPYmplY3QKICAgICAgICogQHN0YXRpYwogICAgICAgKgogICAgICAgKiBAc2luY2UgMi4wLjAKICAgICAgICovCiAgICAgIE1JRElfQ0hBTk5FTF9NT0RFX01FU1NBR0VTOiB7CiAgICAgICAgdmFsdWU6IHsKICAgICAgICAgIGFsbHNvdW5kb2ZmOiAxMjAsCiAgICAgICAgICByZXNldGFsbGNvbnRyb2xsZXJzOiAxMjEsCiAgICAgICAgICBsb2NhbGNvbnRyb2w6IDEyMiwKICAgICAgICAgIGFsbG5vdGVzb2ZmOiAxMjMsCiAgICAgICAgICBvbW5pbW9kZW9mZjogMTI0LAogICAgICAgICAgb21uaW1vZGVvbjogMTI1LAogICAgICAgICAgbW9ub21vZGVvbjogMTI2LAogICAgICAgICAgcG9seW1vZGVvbjogMTI3CiAgICAgICAgfSwKICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlCiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQW4gaW50ZWdlciB0byBvZmZzZXQgdGhlIG9jdGF2ZSBib3RoIGluIGluYm91bmQgYW5kIG91dGJvdW5kIG1lc3NhZ2VzLiBCeSBkZWZhdWx0LCBtaWRkbGUgQwogICAgICAgKiAoTUlESSBub3RlIG51bWJlciA2MCkgaXMgcGxhY2VkIG9uIHRoZSA0dGggb2N0YXZlIChDNCkuCiAgICAgICAqCiAgICAgICAqIElmLCBmb3IgZXhhbXBsZSwgYG9jdGF2ZU9mZnNldGAgaXMgc2V0IHRvIDIsIE1JREkgbm90ZSBudW1iZXIgNjAgd2lsbCBiZSByZXBvcnRlZCBhcyBDNi4gSWYKICAgICAgICogYG9jdGF2ZU9mZnNldGAgaXMgc2V0IHRvIC0xLCBNSURJIG5vdGUgbnVtYmVyIDYwIHdpbGwgYmUgcmVwb3J0ZWQgYXMgQzMuCiAgICAgICAqCiAgICAgICAqIEBwcm9wZXJ0eSBvY3RhdmVPZmZzZXQKICAgICAgICogQHR5cGUgTnVtYmVyCiAgICAgICAqIEBzdGF0aWMKICAgICAgICoKICAgICAgICogQHNpbmNlIDIuMQogICAgICAgKi8KICAgICAgb2N0YXZlT2Zmc2V0OiB7CiAgICAgICAgdmFsdWU6IDAsCiAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlCiAgICAgIH0KICAgIH0pOyAvLyBEZWZpbmUgZ2V0dGVycy9zZXR0ZXJzCgogICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXModGhpcywgewogICAgICAvKioKICAgICAgICogW3JlYWQtb25seV0gSW5kaWNhdGVzIHdoZXRoZXIgdGhlIGVudmlyb25tZW50IHN1cHBvcnRzIHRoZSBXZWIgTUlESSBBUEkgb3Igbm90LgogICAgICAgKgogICAgICAgKiBOb3RlOiBpbiBlbnZpcm9ubWVudHMgdGhhdCBkbyBub3Qgb2ZmZXIgYnVpbHQtaW4gTUlESSBzdXBwb3J0LCB0aGlzIHdpbGwgcmVwb3J0IHRydWUgaWYgdGhlCiAgICAgICAqIGBuYXZpZ2F0b3IucmVxdWVzdE1JRElBY2Nlc3NgIGZ1bmN0aW9uIGlzIGF2YWlsYWJsZS4gRm9yIGV4YW1wbGUsIGlmIHlvdSBoYXZlIGluc3RhbGxlZAogICAgICAgKiBXZWJNSURJQVBJU2hpbSBidXQgbm8gcGx1Z2luLCB0aGlzIHByb3BlcnR5IHdpbGwgYmUgdHJ1ZSBldmVuIHRob3VnaCBhY3R1YWwgc3VwcG9ydCBtaWdodAogICAgICAgKiBub3QgYmUgdGhlcmUuCiAgICAgICAqCiAgICAgICAqIEBwcm9wZXJ0eSBzdXBwb3J0ZWQKICAgICAgICogQHR5cGUgQm9vbGVhbgogICAgICAgKiBAc3RhdGljCiAgICAgICAqLwogICAgICBzdXBwb3J0ZWQ6IHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgcmV0dXJuICJyZXF1ZXN0TUlESUFjY2VzcyIgaW4gbmF2aWdhdG9yOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBbcmVhZC1vbmx5XSBJbmRpY2F0ZXMgd2hldGhlciB0aGUgaW50ZXJmYWNlIHRvIHRoZSBob3N0InMgTUlESSBzdWJzeXN0ZW0gaXMgY3VycmVudGx5CiAgICAgICAqIGVuYWJsZWQuCiAgICAgICAqCiAgICAgICAqIEBwcm9wZXJ0eSBlbmFibGVkCiAgICAgICAqIEB0eXBlIEJvb2xlYW4KICAgICAgICogQHN0YXRpYwogICAgICAgKi8KICAgICAgZW5hYmxlZDogewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gdGhpc1siaW50ZXJmYWNlIl0gIT09IHVuZGVmaW5lZDsKICAgICAgICB9LmJpbmQodGhpcykKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBbcmVhZC1vbmx5XSBBbiBhcnJheSBvZiBhbGwgY3VycmVudGx5IGF2YWlsYWJsZSBNSURJIGlucHV0IHBvcnRzLgogICAgICAgKgogICAgICAgKiBAcHJvcGVydHkgaW5wdXRzCiAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICogQHN0YXRpYwogICAgICAgKi8KICAgICAgaW5wdXRzOiB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9pbnB1dHM7CiAgICAgICAgfS5iaW5kKHRoaXMpCiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogW3JlYWQtb25seV0gQW4gYXJyYXkgb2YgYWxsIGN1cnJlbnRseSBhdmFpbGFibGUgTUlESSBvdXRwdXQgcG9ydHMuCiAgICAgICAqCiAgICAgICAqIEBwcm9wZXJ0eSBvdXRwdXRzCiAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICogQHN0YXRpYwogICAgICAgKi8KICAgICAgb3V0cHV0czogewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fb3V0cHV0czsKICAgICAgICB9LmJpbmQodGhpcykKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBbcmVhZC1vbmx5XSBJbmRpY2F0ZXMgd2hldGhlciB0aGUgaW50ZXJmYWNlIHRvIHRoZSBob3N0InMgTUlESSBzdWJzeXN0ZW0gaXMgY3VycmVudGx5CiAgICAgICAqIGFjdGl2ZS4KICAgICAgICoKICAgICAgICogQHByb3BlcnR5IHN5c2V4RW5hYmxlZAogICAgICAgKiBAdHlwZSBCb29sZWFuCiAgICAgICAqIEBzdGF0aWMKICAgICAgICovCiAgICAgIHN5c2V4RW5hYmxlZDogewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gISEodGhpc1siaW50ZXJmYWNlIl0gJiYgdGhpc1siaW50ZXJmYWNlIl0uc3lzZXhFbmFibGVkKTsKICAgICAgICB9LmJpbmQodGhpcykKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBbcmVhZC1vbmx5XSBJbmRpY2F0ZXMgd2hldGhlciBXZWJNaWRpIHNob3VsZCBkaXNwYXRjaCBOb24tUmVnaXN0ZXJlZAogICAgICAgKiBQYXJhbWV0ZXIgTnVtYmVyIGV2ZW50cyAod2hpY2ggYXJlIGdlbmVyYWxseSBncm91cHMgb2YgQ0MgbWVzc2FnZXMpCiAgICAgICAqIElmIGNvcnJlY3Qgc2VxdWVuY2VzIG9mIENDIG1lc3NhZ2VzIGFyZSByZWNlaXZlZCwgTlJQTiBldmVudHMgd2lsbAogICAgICAgKiBmaXJlLiBUaGUgZmlyc3Qgb3V0IG9mIG9yZGVyIE5SUE4gQ0Mgd2lsbCBmYWxsIHRocm91Z2ggdGhlIGNvbGxlY3RvcgogICAgICAgKiBsb2dpYyBhbmQgYWxsIENDIG1lc3NhZ2VzIGJ1ZmZlcmVkIHdpbGwgYmUgZGlzY2FyZGVkIGFzIGluY29tcGxldGUuCiAgICAgICAqCiAgICAgICAqIEBwcm9wZXJ0eSBucnBuRXZlbnRzRW5hYmxlZAogICAgICAgKiBAdHlwZSBCb29sZWFuCiAgICAgICAqIEBzdGF0aWMKICAgICAgICovCiAgICAgIG5ycG5FdmVudHNFbmFibGVkOiB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiAhIXRoaXMuX25ycG5FdmVudHNFbmFibGVkOwogICAgICAgIH0uYmluZCh0aGlzKSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uIHNldChlbmFibGVkKSB7CiAgICAgICAgICB0aGlzLl9ucnBuRXZlbnRzRW5hYmxlZCA9IGVuYWJsZWQ7CiAgICAgICAgICByZXR1cm4gdGhpcy5fbnJwbkV2ZW50c0VuYWJsZWQ7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIFtyZWFkLW9ubHldIE5SUE4gbWVzc2FnZSB0eXBlcwogICAgICAgKgogICAgICAgKiBAcHJvcGVydHkgbnJwblR5cGVzCiAgICAgICAqIEB0eXBlIEFycmF5CiAgICAgICAqIEBzdGF0aWMKICAgICAgICovCiAgICAgIG5ycG5UeXBlczogewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fbnJwblR5cGVzOwogICAgICAgIH0uYmluZCh0aGlzKQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIFtyZWFkLW9ubHldIEN1cnJlbnQgTUlESSBwZXJmb3JtYW5jZSB0aW1lIGluIG1pbGxpc2Vjb25kcy4gVGhpcyBjYW4gYmUgdXNlZCB0byBxdWV1ZSBldmVudHMKICAgICAgICogaW4gdGhlIGZ1dHVyZS4KICAgICAgICoKICAgICAgICogQHByb3BlcnR5IHRpbWUKICAgICAgICogQHR5cGUgRE9NSGlnaFJlc1RpbWVTdGFtcAogICAgICAgKiBAc3RhdGljCiAgICAgICAqLwogICAgICB0aW1lOiB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgIHJldHVybiBwZXJmb3JtYW5jZS5ub3coKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0gLy8gV2ViTWlkaSBpcyBhIHNpbmdsZXRvbiBzbyB3ZSBpbnN0YW50aWF0ZSBpdCBvdXJzZWx2ZXMgYW5kIGtlZXAgaXQgaW4gYSB2YXIgZm9yIGludGVybmFsCiAgLy8gcmVmZXJlbmNlLgoKCiAgdmFyIHdtID0gbmV3IFdlYk1pZGkoKTsKICAvKioKICAgKiBDaGVja3MgaWYgdGhlIFdlYiBNSURJIEFQSSBpcyBhdmFpbGFibGUgYW5kIHRoZW4gdHJpZXMgdG8gY29ubmVjdCB0byB0aGUgaG9zdCdzIE1JREkgc3Vic3lzdGVtLgogICAqIFRoaXMgaXMgYW4gYXN5bmNocm9ub3VzIG9wZXJhdGlvbi4gV2hlbiBpdCdzIGRvbmUsIHRoZSBzcGVjaWZpZWQgaGFuZGxlciBjYWxsYmFjayB3aWxsIGJlCiAgICogZXhlY3V0ZWQuIElmIGFuIGVycm9yIG9jY3VycmVkLCB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gd2lsbCByZWNlaXZlIGFuIGBFcnJvcmAgb2JqZWN0IGFzIGl0cwogICAqIHNvbGUgcGFyYW1ldGVyLgogICAqCiAgICogVG8gZW5hYmxlIHRoZSB1c2Ugb2Ygc3lzdGVtIGV4Y2x1c2l2ZSBtZXNzYWdlcywgdGhlIGBzeXNleGAgcGFyYW1ldGVyIHNob3VsZCBiZSBzZXQgdG8gdHJ1ZS4KICAgKiBIb3dldmVyLCB1bmRlciBzb21lIGVudmlyb25tZW50cyAoZS5nLiBKYXp6LVBsdWdpbiksIHRoZSBzeXNleCBwYXJhbWV0ZXIgaXMgaWdub3JlZCBhbmQgc3lzZXgKICAgKiBpcyBhbHdheXMgZW5hYmxlZC4KICAgKgogICAqIFdhcm5pbmc6IHN0YXJ0aW5nIHdpdGggQ2hyb21lIHY3NywgdGhlIFdlYiBNSURJIEFQSSBtdXN0IGJlIGhvc3RlZCBvbiBhIHNlY3VyZSBvcmlnaW4KICAgKiAoYGh0dHBzOi8vYCwgYGxvY2FsaG9zdGAgb3IgYGZpbGU6Ly8vYCkgYW5kIHRoZSB1c2VyIHdpbGwgYWx3YXlzIGJlIHByb21wdGVkIHRvIGF1dGhvcml6ZSB0aGUKICAgKiBvcGVyYXRpb24gKG5vIG1hdHRlciBpZiBgc3lzZXhgIGlzIHJlcXVlc3RlZCBvciBub3QpLgogICAqCiAgICogQG1ldGhvZCBlbmFibGUKICAgKiBAc3RhdGljCiAgICoKICAgKiBAcGFyYW0gW2NhbGxiYWNrXSB7RnVuY3Rpb259IEEgZnVuY3Rpb24gdG8gZXhlY3V0ZSB1cG9uIHN1Y2Nlc3MuIFRoaXMgZnVuY3Rpb24gd2lsbCByZWNlaXZlIGFuCiAgICogYEVycm9yYCBvYmplY3QgdXBvbiBmYWlsdXJlIHRvIGVuYWJsZSB0aGUgV2ViIE1JREkgQVBJLgogICAqIEBwYXJhbSBbc3lzZXg9ZmFsc2VdIHtCb29sZWFufSBXaGV0aGVyIHRvIGVuYWJsZSBNSURJIHN5c3RlbSBleGNsdXNpdmUgbWVzc2FnZXMgb3Igbm90LgogICAqCiAgICogQHRocm93cyBFcnJvciBUaGUgV2ViIE1JREkgQVBJIGlzIG5vdCBzdXBwb3J0ZWQgYnkgeW91ciBicm93c2VyLgogICAqIEB0aHJvd3MgRXJyb3IgSmF6ei1QbHVnaW4gbXVzdCBiZSBpbnN0YWxsZWQgdG8gdXNlIFdlYk1JRElBUElTaGltLgogICAqLwoKICBXZWJNaWRpLnByb3RvdHlwZS5lbmFibGUgPSBmdW5jdGlvbiAoY2FsbGJhY2ssIHN5c2V4KSB7CiAgICAvLyBXaHkgYXJlIHlvdSBub3QgdXNpbmcgYSBQcm9taXNlLWJhc2VkIEFQSSBmb3IgdGhlIGVuYWJsZSgpIG1ldGhvZD8KICAgIC8vCiAgICAvLyBTaG9ydCBhbnN3ZXI6IGJlY2F1c2Ugb2YgSUUuCiAgICAvLwogICAgLy8gTG9uZyBhbnN3ZXI6CiAgICAvLwogICAgLy8gSUUgMTEgYW5kIGJlbG93IHN0aWxsIGRvIG5vdCBzdXBwb3J0IHByb21pc2VzLiBUaGVyZWZvcmUsIFdlYk1JRElBUElTaGltIGhhcyB0byBpbXBsZW1lbnQgYQogICAgLy8gc2ltcGxlIFByb21pc2UgbG9vay1hbGlrZSBvYmplY3QgdG8gaGFuZGxlIHRoZSBjYWxsIHRvIHJlcXVlc3RNSURJQWNjZXNzKCkuIFRoaXMgbG9vay1hbGlrZQogICAgLy8gaXMgbm90IGEgZnVsbHktZmxlZGdlZCBQcm9taXNlIG9iamVjdC4gSXQgZG9lcyBub3Qgc3VwcG9ydCB1c2luZyBjYXRjaCgpIGZvciBleGFtcGxlLiBUaGlzCiAgICAvLyBtZWFucyB0aGF0LCB0byBwcm92aWRlIGEgcmVhbCBQcm9taXNlLWJhc2VkIGludGVyZmFjZSBmb3IgdGhlIGVuYWJsZSgpIG1ldGhvZCwgd2Ugd291bGQgbmVlZAogICAgLy8gdG8gYWRkIGEgZGVwZW5kZW5jeSBpbiB0aGUgZm9ybSBvZiBhIFByb21pc2UgcG9seWZpbGwuIFNvLCB0byBrZWVwIHRoaW5ncyBzaW1wbGVyLCB3ZSB3aWxsCiAgICAvLyBzdGljayB0byB0aGUgZ29vZCBvbGQgY2FsbGJhY2sgYmFzZWQgZW5hYmxlKCkgZnVuY3Rpb24uCiAgICBpZiAodGhpcy5lbmFibGVkKSByZXR1cm47CgogICAgaWYgKCF0aGlzLnN1cHBvcnRlZCkgewogICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgY2FsbGJhY2sobmV3IEVycm9yKCJUaGUgV2ViIE1JREkgQVBJIGlzIG5vdCBzdXBwb3J0ZWQgYnkgeW91ciBicm93c2VyLiIpKTsKICAgICAgfQoKICAgICAgcmV0dXJuOwogICAgfQoKICAgIG5hdmlnYXRvci5yZXF1ZXN0TUlESUFjY2Vzcyh7CiAgICAgIHN5c2V4OiBzeXNleAogICAgfSkudGhlbihmdW5jdGlvbiAobWlkaUFjY2VzcykgewogICAgICB2YXIgZXZlbnRzID0gW10sCiAgICAgICAgICBwcm9taXNlcyA9IFtdLAogICAgICAgICAgcHJvbWlzZVRpbWVvdXQ7CiAgICAgIHRoaXNbImludGVyZmFjZSJdID0gbWlkaUFjY2VzczsKCiAgICAgIHRoaXMuX3Jlc2V0SW50ZXJmYWNlVXNlckhhbmRsZXJzKCk7IC8vIFdlIHNldHVwIGEgdGVtcG9yYXJ5IGBzdGF0ZWNoYW5nZWAgaGFuZGxlciB0aGF0IHdpbGwgY2F0Y2ggYWxsIGV2ZW50cyB0cmlnZ2VyZWQgd2hpbGUgd2UKICAgICAgLy8gc2V0dXAuIFRob3NlIGV2ZW50cyB3aWxsIGJlIHJlLXRyaWdnZXJlZCBhZnRlciBjYWxsaW5nIHRoZSB1c2VyInMgY2FsbGJhY2suIFRoaXMgd2lsbAogICAgICAvLyBhbGxvdyB0aGUgdXNlciB0byBsaXN0ZW4gdG8gImNvbm5lY3RlZCIgZXZlbnRzIHdoaWNoIGNhbiBiZSB2ZXJ5IGNvbnZlbmllbnQuCgoKICAgICAgdGhpc1siaW50ZXJmYWNlIl0ub25zdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgZXZlbnRzLnB1c2goZSk7CiAgICAgIH07IC8vIEhlcmUgd2UgbWFudWFsbHkgb3BlbiB0aGUgaW5wdXRzIGFuZCBvdXRwdXRzLiBVc3VhbGx5LCB0aGlzIGlzIG9wdGlvbmFsLiBXaGVuIHRoZSBwb3J0cwogICAgICAvLyBhcmUgbm90IGV4cGxpY2l0ZWx5IG9wZW5lZCwgdGhleSB3aWxsIGJlIG9wZW5lZCBhdXRvbWF0aWNhbGx5IChhbmQgYXN5bmNob25vdXNseSkgYnkKICAgICAgLy8gc2V0dGluZyBhIGxpc3RlbmVyIG9uIGBtaWRpbWVzc2FnZWAgKE1JRElJbnB1dCkgb3IgY2FsbGluZyBgc2VuZCgpYCAoTUlESU91dHB1dCkuCiAgICAgIC8vIEhvd2V2ZXIsIHdlIGRvIG5vdCB3YW50IHRoYXQgaGVyZS4gV2Ugd2FudCB0byBiZSBzdXJlIHRoYXQgImNvbm5lY3RlZCIgZXZlbnRzIHdpbGwgYmUKICAgICAgLy8gYXZhaWxhYmxlIGluIHRoZSB1c2VyInMgY2FsbGJhY2suIFNvLCB3aGF0IHdlIGRvIGlzIG9wZW4gYWxsIGlucHV0IGFuZCBvdXRwdXQgcG9ydHMgYW5kCiAgICAgIC8vIHdhaXQgdW50aWwgYWxsIHByb21pc2VzIGFyZSByZXNvbHZlZC4gVGhlbiwgd2UgcmUtdHJpZ2dlciB0aGUgZXZlbnRzIGFmdGVyIHRoZSB1c2VyInMKICAgICAgLy8gY2FsbGJhY2sgaGFzIGJlZW4gZXhlY3V0ZWQuIFRoaXMgc2VlbXMgbGlrZSB0aGUgbW9zdCBzZW5zaWJsZSBhbmQgcHJhY3RpY2FsIHdheS4KCgogICAgICB2YXIgaW5wdXRzID0gbWlkaUFjY2Vzcy5pbnB1dHMudmFsdWVzKCk7CgogICAgICBmb3IgKHZhciBpbnB1dCA9IGlucHV0cy5uZXh0KCk7IGlucHV0ICYmICFpbnB1dC5kb25lOyBpbnB1dCA9IGlucHV0cy5uZXh0KCkpIHsKICAgICAgICBwcm9taXNlcy5wdXNoKGlucHV0LnZhbHVlLm9wZW4oKSk7CiAgICAgIH0KCiAgICAgIHZhciBvdXRwdXRzID0gbWlkaUFjY2Vzcy5vdXRwdXRzLnZhbHVlcygpOwoKICAgICAgZm9yICh2YXIgb3V0cHV0ID0gb3V0cHV0cy5uZXh0KCk7IG91dHB1dCAmJiAhb3V0cHV0LmRvbmU7IG91dHB1dCA9IG91dHB1dHMubmV4dCgpKSB7CiAgICAgICAgcHJvbWlzZXMucHVzaChvdXRwdXQudmFsdWUub3BlbigpKTsKICAgICAgfSAvLyBTaW5jZSB0aGlzIGxpYnJhcnkgbWlnaHQgYmUgdXNlZCBpbiBlbnZpcm9ubWVudHMgd2l0aG91dCBzdXBwb3J0IGZvciBwcm9taXNlcyAoc3VjaCBhcwogICAgICAvLyBKYXp6LU1pZGkpIG9yIGluIGVudmlyb25tZW50cyB0aGF0IGFyZSBub3QgcHJvcGVybHkgb3BlbmluZyB0aGUgcG9ydHMgKHN1Y2ggYXMgV2ViIE1JREkKICAgICAgLy8gQnJvd3NlciksIHdlIGZhbGwgYmFjayB0byBhIHRpbWVyLWJhc2VkIGFwcHJvYWNoIGlmIHRoZSBwcm9taXNlLWJhc2VkIGFwcHJvYWNoIGZhaWxzLgoKCiAgICAgIGZ1bmN0aW9uIG9uUG9ydHNPcGVuKCkgewogICAgICAgIGNsZWFyVGltZW91dChwcm9taXNlVGltZW91dCk7CgogICAgICAgIHRoaXMuX3VwZGF0ZUlucHV0c0FuZE91dHB1dHMoKTsKCiAgICAgICAgdGhpc1siaW50ZXJmYWNlIl0ub25zdGF0ZWNoYW5nZSA9IHRoaXMuX29uSW50ZXJmYWNlU3RhdGVDaGFuZ2UuYmluZCh0aGlzKTsgLy8gV2UgZXhlY3V0ZSB0aGUgY2FsbGJhY2sgYW5kIHRoZW4gcmUtdHJpZ2dlciB0aGUgc3RhdGVjaGFuZ2UgZXZlbnRzLgoKICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBjYWxsYmFjay5jYWxsKHRoaXMpOwogICAgICAgIH0KCiAgICAgICAgZXZlbnRzLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICB0aGlzLl9vbkludGVyZmFjZVN0YXRlQ2hhbmdlKGV2ZW50KTsKICAgICAgICB9LmJpbmQodGhpcykpOwogICAgICB9CgogICAgICBwcm9taXNlVGltZW91dCA9IHNldFRpbWVvdXQob25Qb3J0c09wZW4uYmluZCh0aGlzKSwgMjAwKTsKCiAgICAgIGlmIChQcm9taXNlKSB7CiAgICAgICAgUHJvbWlzZS5hbGwocHJvbWlzZXMpWyJjYXRjaCJdKGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgIGNvbnNvbGUud2FybihlcnIpOwogICAgICAgIH0pLnRoZW4ob25Qb3J0c09wZW4uYmluZCh0aGlzKSk7CiAgICAgIH0gLy8gV2hlbiBNSURJIGFjY2VzcyBpcyByZXF1ZXN0ZWQsIGFsbCBpbnB1dCBhbmQgb3V0cHV0IHBvcnRzIGhhdmUgdGhlaXIgInN0YXRlIiBzZXQgdG8KICAgICAgLy8gImNvbm5lY3RlZCIuIEhvd2V2ZXIsIHRoZSB2YWx1ZSBvZiB0aGVpciAiY29ubmVjdGlvbiIgcHJvcGVydHkgaXMgImNsb3NlZCIuCiAgICAgIC8vCiAgICAgIC8vIEEgYE1JRElJbnB1dGAgYmVjb21lcyBgb3BlbmAgd2hlbiB5b3UgZXhwbGljaXRlbHkgY2FsbCBpdHMgYG9wZW4oKWAgbWV0aG9kIG9yIHdoZW4geW91CiAgICAgIC8vIGFzc2lnbiBhIGxpc3RlbmVyIHRvIGl0cyBgb25taWRpbWVzc2FnZWAgcHJvcGVydHkuIEEgYE1JRElPdXRwdXRgIGJlY29tZXMgYG9wZW5gIHdoZW4geW91CiAgICAgIC8vIHVzZSB0aGUgYHNlbmQoKWAgbWV0aG9kIG9yIHdoZW4geW91IGNhbiBleHBsaWNpdGVseSBjYWxsIGl0cyBgb3BlbigpYCBtZXRob2QuCiAgICAgIC8vCiAgICAgIC8vIENhbGxpbmcgYF91cGRhdGVJbnB1dHNBbmRPdXRwdXRzKClgIGF0dGFjaGVzIGxpc3RlbmVycyB0byBhbGwgaW5wdXRzLiBBcyBwZXIgdGhlIHNwZWMsCiAgICAgIC8vIHRoaXMgdHJpZ2dlcnMgYSBgc3RhdGVjaGFuZ2VgIGV2ZW50IG9uIE1JRElBY2Nlc3MuCgogICAgfS5iaW5kKHRoaXMpLCBmdW5jdGlvbiAoZXJyKSB7CiAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICBjYWxsYmFjay5jYWxsKHRoaXMsIGVycik7CiAgICAgIH0KICAgIH0uYmluZCh0aGlzKSk7CiAgfTsKICAvKioKICAgKiBDb21wbGV0ZWx5IGRpc2FibGVzIGBXZWJNaWRpYCBieSB1bmxpbmtpbmcgdGhlIE1JREkgc3Vic3lzdGVtInMgaW50ZXJmYWNlIGFuZCBkZXN0cm95aW5nIGFsbAogICAqIGBJbnB1dGAgYW5kIGBPdXRwdXRgIG9iamVjdHMgdGhhdCBtYXkgYmUgYXZhaWxhYmxlLiBUaGlzIGFsc28gbWVhbnMgdGhhdCBhbnkgbGlzdGVuZXIgdGhhdCBtYXkKICAgKiBoYXZlIGJlZW4gZGVmaW5lZCBvbiBgSW5wdXRgIG9yIGBPdXRwdXRgIG9iamVjdHMgd2lsbCBiZSBkZXN0cm95ZWQuCiAgICoKICAgKiBAbWV0aG9kIGRpc2FibGUKICAgKiBAc3RhdGljCiAgICoKICAgKiBAc2luY2UgMi4wLjAKICAgKi8KCgogIFdlYk1pZGkucHJvdG90eXBlLmRpc2FibGUgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIXRoaXMuc3VwcG9ydGVkKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIFdlYiBNSURJIEFQSSBpcyBub3Qgc3VwcG9ydGVkIGJ5IHlvdXIgYnJvd3Nlci4iKTsKICAgIH0KCiAgICBpZiAodGhpc1siaW50ZXJmYWNlIl0pIHRoaXNbImludGVyZmFjZSJdLm9uc3RhdGVjaGFuZ2UgPSB1bmRlZmluZWQ7CiAgICB0aGlzWyJpbnRlcmZhY2UiXSA9IHVuZGVmaW5lZDsgLy8gYWxzbyByZXNldHMgZW5hYmxlZCwgc3lzZXhFbmFibGVkLCBucnBuRXZlbnRzRW5hYmxlZAoKICAgIHRoaXMuX2lucHV0cyA9IFtdOwogICAgdGhpcy5fb3V0cHV0cyA9IFtdOwogICAgdGhpcy5fbnJwbkV2ZW50c0VuYWJsZWQgPSB0cnVlOwoKICAgIHRoaXMuX3Jlc2V0SW50ZXJmYWNlVXNlckhhbmRsZXJzKCk7CiAgfTsKICAvKioKICAgKiBBZGRzIGFuIGV2ZW50IGxpc3RlbmVyIG9uIHRoZSBgV2ViTWlkaWAgb2JqZWN0IHRoYXQgd2lsbCB0cmlnZ2VyIGEgZnVuY3Rpb24gY2FsbGJhY2sgd2hlbiB0aGUKICAgKiBzcGVjaWZpZWQgZXZlbnQgaGFwcGVucy4KICAgKgogICAqIFdlYk1pZGkgbXVzdCBiZSBlbmFibGVkIGJlZm9yZSBhZGRpbmcgZXZlbnQgbGlzdGVuZXJzLgogICAqCiAgICogQ3VycmVudGx5LCBvbmx5IG9uZSBldmVudCBpcyBiZWluZyBkaXNwYXRjaGVkIGJ5IHRoZSBgV2ViTWlkaWAgb2JqZWN0OgogICAqCiAgICogICAgKiB7eyNjcm9zc0xpbmsgIldlYk1pZGkvc3RhdGVjaGFuZ2U6ZXZlbnQifX1zdGF0ZWNoYW5nZXt7L2Nyb3NzTGlua319CiAgICoKICAgKiBAbWV0aG9kIGFkZExpc3RlbmVyCiAgICogQHN0YXRpYwogICAqIEBjaGFpbmFibGUKICAgKgogICAqIEBwYXJhbSB0eXBlIHtTdHJpbmd9IFRoZSB0eXBlIG9mIHRoZSBldmVudC4KICAgKgogICAqIEBwYXJhbSBsaXN0ZW5lciB7RnVuY3Rpb259IEEgY2FsbGJhY2sgZnVuY3Rpb24gdG8gZXhlY3V0ZSB3aGVuIHRoZSBzcGVjaWZpZWQgZXZlbnQgaXMgZGV0ZWN0ZWQuCiAgICogVGhpcyBmdW5jdGlvbiB3aWxsIHJlY2VpdmUgYW4gZXZlbnQgcGFyYW1ldGVyIG9iamVjdC4gRm9yIGRldGFpbHMgb24gdGhpcyBvYmplY3QicyBwcm9wZXJ0aWVzLAogICAqIGNoZWNrIG91dCB0aGUgZG9jdW1lbnRhdGlvbiBmb3IgdGhlIHZhcmlvdXMgZXZlbnRzIChsaW5rcyBhYm92ZSkuCiAgICoKICAgKiBAdGhyb3dzIHtFcnJvcn0gV2ViTWlkaSBtdXN0IGJlIGVuYWJsZWQgYmVmb3JlIGFkZGluZyBldmVudCBsaXN0ZW5lcnMuCiAgICogQHRocm93cyB7VHlwZUVycm9yfSBUaGUgc3BlY2lmaWVkIGV2ZW50IHR5cGUgaXMgbm90IHN1cHBvcnRlZC4KICAgKiBAdGhyb3dzIHtUeXBlRXJyb3J9IFRoZSAibGlzdGVuZXIiIHBhcmFtZXRlciBtdXN0IGJlIGEgZnVuY3Rpb24uCiAgICoKICAgKiBAcmV0dXJuIHtXZWJNaWRpfSBSZXR1cm5zIHRoZSBgV2ViTWlkaWAgb2JqZWN0IHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICovCgoKICBXZWJNaWRpLnByb3RvdHlwZS5hZGRMaXN0ZW5lciA9IGZ1bmN0aW9uICh0eXBlLCBsaXN0ZW5lcikgewogICAgaWYgKCF0aGlzLmVuYWJsZWQpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJXZWJNaWRpIG11c3QgYmUgZW5hYmxlZCBiZWZvcmUgYWRkaW5nIGV2ZW50IGxpc3RlbmVycy4iKTsKICAgIH0KCiAgICBpZiAodHlwZW9mIGxpc3RlbmVyICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlRoZSAnbGlzdGVuZXInIHBhcmFtZXRlciBtdXN0IGJlIGEgZnVuY3Rpb24uIik7CiAgICB9CgogICAgaWYgKHRoaXMuX21pZGlJbnRlcmZhY2VFdmVudHMuaW5kZXhPZih0eXBlKSA+PSAwKSB7CiAgICAgIHRoaXMuX3VzZXJIYW5kbGVyc1t0eXBlXS5wdXNoKGxpc3RlbmVyKTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlRoZSBzcGVjaWZpZWQgZXZlbnQgdHlwZSBpcyBub3Qgc3VwcG9ydGVkLiIpOwogICAgfQoKICAgIHJldHVybiB0aGlzOwogIH07CiAgLyoqCiAgICogQ2hlY2tzIGlmIHRoZSBzcGVjaWZpZWQgZXZlbnQgdHlwZSBpcyBhbHJlYWR5IGRlZmluZWQgdG8gdHJpZ2dlciB0aGUgc3BlY2lmaWVkIGxpc3RlbmVyCiAgICogZnVuY3Rpb24uCiAgICoKICAgKiBAbWV0aG9kIGhhc0xpc3RlbmVyCiAgICogQHN0YXRpYwogICAqCiAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHR5cGUgb2YgdGhlIGV2ZW50LgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGxpc3RlbmVyIFRoZSBjYWxsYmFjayBmdW5jdGlvbiB0byBjaGVjayBmb3IuCiAgICoKICAgKiBAdGhyb3dzIHtFcnJvcn0gV2ViTWlkaSBtdXN0IGJlIGVuYWJsZWQgYmVmb3JlIGNoZWNraW5nIGV2ZW50IGxpc3RlbmVycy4KICAgKiBAdGhyb3dzIHtUeXBlRXJyb3J9IFRoZSAibGlzdGVuZXIiIHBhcmFtZXRlciBtdXN0IGJlIGEgZnVuY3Rpb24uCiAgICogQHRocm93cyB7VHlwZUVycm9yfSBUaGUgc3BlY2lmaWVkIGV2ZW50IHR5cGUgaXMgbm90IHN1cHBvcnRlZC4KICAgKgogICAqIEByZXR1cm4ge0Jvb2xlYW59IEJvb2xlYW4gdmFsdWUgaW5kaWNhdGluZyB3aGV0aGVyIG9yIG5vdCBhIGNhbGxiYWNrIGlzIGFscmVhZHkgZGVmaW5lZCBmb3IKICAgKiB0aGlzIGV2ZW50IHR5cGUuCiAgICovCgoKICBXZWJNaWRpLnByb3RvdHlwZS5oYXNMaXN0ZW5lciA9IGZ1bmN0aW9uICh0eXBlLCBsaXN0ZW5lcikgewogICAgaWYgKCF0aGlzLmVuYWJsZWQpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJXZWJNaWRpIG11c3QgYmUgZW5hYmxlZCBiZWZvcmUgY2hlY2tpbmcgZXZlbnQgbGlzdGVuZXJzLiIpOwogICAgfQoKICAgIGlmICh0eXBlb2YgbGlzdGVuZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVGhlICdsaXN0ZW5lcicgcGFyYW1ldGVyIG11c3QgYmUgYSBmdW5jdGlvbi4iKTsKICAgIH0KCiAgICBpZiAodGhpcy5fbWlkaUludGVyZmFjZUV2ZW50cy5pbmRleE9mKHR5cGUpID49IDApIHsKICAgICAgZm9yICh2YXIgbyA9IDA7IG8gPCB0aGlzLl91c2VySGFuZGxlcnNbdHlwZV0ubGVuZ3RoOyBvKyspIHsKICAgICAgICBpZiAodGhpcy5fdXNlckhhbmRsZXJzW3R5cGVdW29dID09PSBsaXN0ZW5lcikgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJUaGUgc3BlY2lmaWVkIGV2ZW50IHR5cGUgaXMgbm90IHN1cHBvcnRlZC4iKTsKICAgIH0KCiAgICByZXR1cm4gZmFsc2U7CiAgfTsKICAvKioKICAgKiBSZW1vdmVzIHRoZSBzcGVjaWZpZWQgbGlzdGVuZXIocykuIElmIHRoZSBgbGlzdGVuZXJgIHBhcmFtZXRlciBpcyBsZWZ0IHVuZGVmaW5lZCwgYWxsIGxpc3RlbmVycwogICAqIGZvciB0aGUgc3BlY2lmaWVkIGB0eXBlYCB3aWxsIGJlIHJlbW92ZWQuIElmIGJvdGggdGhlIGBsaXN0ZW5lcmAgYW5kIHRoZSBgdHlwZWAgcGFyYW1ldGVycyBhcmUKICAgKiBvbWl0dGVkLCBhbGwgbGlzdGVuZXJzIGF0dGFjaGVkIHRvIHRoZSBgV2ViTWlkaWAgb2JqZWN0IHdpbGwgYmUgcmVtb3ZlZC4KICAgKgogICAqIEBtZXRob2QgcmVtb3ZlTGlzdGVuZXIKICAgKiBAc3RhdGljCiAgICogQGNoYWluYWJsZQogICAqCiAgICogQHBhcmFtIHtTdHJpbmd9IFt0eXBlXSBUaGUgdHlwZSBvZiB0aGUgZXZlbnQuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2xpc3RlbmVyXSBUaGUgY2FsbGJhY2sgZnVuY3Rpb24gdG8gY2hlY2sgZm9yLgogICAqCiAgICogQHRocm93cyB7RXJyb3J9IFdlYk1pZGkgbXVzdCBiZSBlbmFibGVkIGJlZm9yZSByZW1vdmluZyBldmVudCBsaXN0ZW5lcnMuCiAgICogQHRocm93cyB7VHlwZUVycm9yfSBUaGUgImxpc3RlbmVyIiBwYXJhbWV0ZXIgbXVzdCBiZSBhIGZ1bmN0aW9uLgogICAqIEB0aHJvd3Mge1R5cGVFcnJvcn0gVGhlIHNwZWNpZmllZCBldmVudCB0eXBlIGlzIG5vdCBzdXBwb3J0ZWQuCiAgICoKICAgKiBAcmV0dXJuIHtXZWJNaWRpfSBUaGUgYFdlYk1pZGlgIG9iamVjdCBmb3IgZWFzeSBtZXRob2QgY2hhaW5pbmcuCiAgICovCgoKICBXZWJNaWRpLnByb3RvdHlwZS5yZW1vdmVMaXN0ZW5lciA9IGZ1bmN0aW9uICh0eXBlLCBsaXN0ZW5lcikgewogICAgaWYgKCF0aGlzLmVuYWJsZWQpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJXZWJNaWRpIG11c3QgYmUgZW5hYmxlZCBiZWZvcmUgcmVtb3ZpbmcgZXZlbnQgbGlzdGVuZXJzLiIpOwogICAgfQoKICAgIGlmIChsaXN0ZW5lciAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBsaXN0ZW5lciAhPT0gImZ1bmN0aW9uIikgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJUaGUgJ2xpc3RlbmVyJyBwYXJhbWV0ZXIgbXVzdCBiZSBhIGZ1bmN0aW9uLiIpOwogICAgfQoKICAgIGlmICh0aGlzLl9taWRpSW50ZXJmYWNlRXZlbnRzLmluZGV4T2YodHlwZSkgPj0gMCkgewogICAgICBpZiAobGlzdGVuZXIpIHsKICAgICAgICBmb3IgKHZhciBvID0gMDsgbyA8IHRoaXMuX3VzZXJIYW5kbGVyc1t0eXBlXS5sZW5ndGg7IG8rKykgewogICAgICAgICAgaWYgKHRoaXMuX3VzZXJIYW5kbGVyc1t0eXBlXVtvXSA9PT0gbGlzdGVuZXIpIHsKICAgICAgICAgICAgdGhpcy5fdXNlckhhbmRsZXJzW3R5cGVdLnNwbGljZShvLCAxKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fdXNlckhhbmRsZXJzW3R5cGVdID0gW107CiAgICAgIH0KICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHRoaXMuX3Jlc2V0SW50ZXJmYWNlVXNlckhhbmRsZXJzKCk7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJUaGUgc3BlY2lmaWVkIGV2ZW50IHR5cGUgaXMgbm90IHN1cHBvcnRlZC4iKTsKICAgIH0KCiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIFJldHVybnMgYSBzYW5pdGl6ZWQgYXJyYXkgb2YgdmFsaWQgTUlESSBjaGFubmVsIG51bWJlcnMgKDEtMTYpLiBUaGUgcGFyYW1ldGVyIHNob3VsZCBiZSBvbmUgb2YKICAgKiB0aGUgZm9sbG93aW5nOgogICAqCiAgICogKiBhIHNpbmdsZSBpbnRlZ2VyCiAgICogKiBhbiBhcnJheSBvZiBpbnRlZ2VycwogICAqICogdGhlIHNwZWNpYWwgdmFsdWUgYCJhbGwiYAogICAqICogdGhlIHNwZWNpYWwgdmFsdWUgYCJub25lImAKICAgKgogICAqIFBhc3NpbmcgYCJhbGwiYCBvciBgdW5kZWZpbmVkYCBhcyBhIHBhcmFtZXRlciB0byB0aGlzIGZ1bmN0aW9uIHJlc3VsdHMgaW4gYWxsIGNoYW5uZWxzIGJlaW5nCiAgICogcmV0dXJuZWQgKDEtMTYpLiBQYXNzaW5nIGAibm9uZSJgIHJlc3VsdHMgaW4gbm8gY2hhbm5lbCBiZWluZyByZXR1cm5lZCAoYXMgYW4gZW1wdHkgYXJyYXkpLgogICAqCiAgICogTm90ZTogcGFyYW1ldGVycyB0aGF0IGNhbm5vdCBzdWNjZXNzZnVsbHkgYmUgcGFyc2VkIHRvIGludGVnZXJzIGJldHdlZW4gMSBhbmQgMTYgYXJlIHNpbGVudGx5CiAgICogaWdub3JlZC4KICAgKgogICAqIEBtZXRob2QgdG9NSURJQ2hhbm5lbHMKICAgKiBAc3RhdGljCiAgICoKICAgKiBAcGFyYW0gW2NoYW5uZWw9ImFsbCJdIHtOdW1iZXJ8QXJyYXl8ImFsbCJ8Im5vbmUifQogICAqIEByZXR1cm5zIHtBcnJheX0gQW4gYXJyYXkgb2YgMCBvciBtb3JlIHZhbGlkIE1JREkgY2hhbm5lbCBudW1iZXJzCiAgICovCgoKICBXZWJNaWRpLnByb3RvdHlwZS50b01JRElDaGFubmVscyA9IGZ1bmN0aW9uIChjaGFubmVsKSB7CiAgICB2YXIgY2hhbm5lbHM7CgogICAgaWYgKGNoYW5uZWwgPT09ICJhbGwiIHx8IGNoYW5uZWwgPT09IHVuZGVmaW5lZCkgewogICAgICBjaGFubmVscyA9IFsiYWxsIl07CiAgICB9IGVsc2UgaWYgKGNoYW5uZWwgPT09ICJub25lIikgewogICAgICBjaGFubmVscyA9IFtdOwogICAgICByZXR1cm4gY2hhbm5lbHM7CiAgICB9IGVsc2UgaWYgKCFBcnJheS5pc0FycmF5KGNoYW5uZWwpKSB7CiAgICAgIGNoYW5uZWxzID0gW2NoYW5uZWxdOwogICAgfSBlbHNlIHsKICAgICAgY2hhbm5lbHMgPSBjaGFubmVsOwogICAgfSAvLyBJbiBvcmRlciB0byBwcmVzZXJ2ZSBiYWNrd2FyZHMtY29tcGF0aWJpbGl0eSwgd2UgbGV0IHRoaXMgYXNzaWdubWVudCBhcyBpdCBpcy4KCgogICAgaWYgKGNoYW5uZWxzLmluZGV4T2YoImFsbCIpID4gLTEpIHsKICAgICAgY2hhbm5lbHMgPSBbMSwgMiwgMywgNCwgNSwgNiwgNywgOCwgOSwgMTAsIDExLCAxMiwgMTMsIDE0LCAxNSwgMTZdOwogICAgfQoKICAgIHJldHVybiBjaGFubmVscy5tYXAoZnVuY3Rpb24gKGNoKSB7CiAgICAgIHJldHVybiBwYXJzZUludChjaCk7CiAgICB9KS5maWx0ZXIoZnVuY3Rpb24gKGNoKSB7CiAgICAgIHJldHVybiBjaCA+PSAxICYmIGNoIDw9IDE2OwogICAgfSk7CiAgfTsKICAvKioKICAgKgogICAqIFJldHVybnMgdGhlIGBJbnB1dGAgb2JqZWN0IHRoYXQgbWF0Y2hlcyB0aGUgc3BlY2lmaWVkIElEIHN0cmluZyBvciBgZmFsc2VgIGlmIG5vIG1hdGNoaW5nIGlucHV0CiAgICogaXMgZm91bmQuIEFzIHBlciB0aGUgV2ViIE1JREkgQVBJIHNwZWNpZmljYXRpb24sIElEcyBhcmUgc3RyaW5ncyAobm90IGludGVnZXJzKS4KICAgKgogICAqIFBsZWFzZSBub3RlIHRoYXQgSURzIGNoYW5nZSBmcm9tIG9uZSBob3N0IHRvIGFub3RoZXIuIEZvciBleGFtcGxlLCBDaHJvbWUgZG9lcyBub3QgdXNlIHRoZSBzYW1lCiAgICoga2luZCBvZiBJRHMgYXMgSmF6ei1QbHVnaW4uCiAgICoKICAgKiBAbWV0aG9kIGdldElucHV0QnlJZAogICAqIEBzdGF0aWMKICAgKgogICAqIEBwYXJhbSBpZCB7U3RyaW5nfSBUaGUgSUQgc3RyaW5nIG9mIHRoZSBwb3J0LiBJRHMgY2FuIGJlIHZpZXdlZCBieSBsb29raW5nIGF0IHRoZQogICAqIGBXZWJNaWRpLmlucHV0c2AgYXJyYXkuCiAgICoKICAgKiBAcmV0dXJucyB7SW5wdXR8ZmFsc2V9IEEgTUlESUlucHV0IHBvcnQgbWF0Y2hpbmcgdGhlIHNwZWNpZmllZCBJRCBzdHJpbmcuIElmIG5vIG1hdGNoaW5nIHBvcnQKICAgKiBjYW4gYmUgZm91bmQsIHRoZSBtZXRob2QgcmV0dXJucyBgZmFsc2VgLgogICAqCiAgICogQHRocm93cyBFcnJvciBXZWJNaWRpIGlzIG5vdCBlbmFibGVkLgogICAqCiAgICogQHNpbmNlIDIuMC4wCiAgICovCgoKICBXZWJNaWRpLnByb3RvdHlwZS5nZXRJbnB1dEJ5SWQgPSBmdW5jdGlvbiAoaWQpIHsKICAgIGlmICghdGhpcy5lbmFibGVkKSB0aHJvdyBuZXcgRXJyb3IoIldlYk1pZGkgaXMgbm90IGVuYWJsZWQuIik7CiAgICBpZCA9IFN0cmluZyhpZCk7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmlucHV0cy5sZW5ndGg7IGkrKykgewogICAgICBpZiAodGhpcy5pbnB1dHNbaV0uaWQgPT09IGlkKSByZXR1cm4gdGhpcy5pbnB1dHNbaV07CiAgICB9CgogICAgcmV0dXJuIGZhbHNlOwogIH07CiAgLyoqCiAgICogUmV0dXJucyB0aGUgYE91dHB1dGAgb2JqZWN0IHRoYXQgbWF0Y2hlcyB0aGUgc3BlY2lmaWVkIElEIHN0cmluZyBvciBgZmFsc2VgIGlmIG5vIG1hdGNoaW5nCiAgICogb3V0cHV0IGlzIGZvdW5kLiBBcyBwZXIgdGhlIFdlYiBNSURJIEFQSSBzcGVjaWZpY2F0aW9uLCBJRHMgYXJlIHN0cmluZ3MgKG5vdCBpbnRlZ2VycykuCiAgICoKICAgKiBQbGVhc2Ugbm90ZSB0aGF0IElEcyBjaGFuZ2UgZnJvbSBvbmUgaG9zdCB0byBhbm90aGVyLiBGb3IgZXhhbXBsZSwgQ2hyb21lIGRvZXMgbm90IHVzZSB0aGUgc2FtZQogICAqIGtpbmQgb2YgSURzIGFzIEphenotUGx1Z2luLgogICAqCiAgICogQG1ldGhvZCBnZXRPdXRwdXRCeUlkCiAgICogQHN0YXRpYwogICAqCiAgICogQHBhcmFtIGlkIHtTdHJpbmd9IFRoZSBJRCBzdHJpbmcgb2YgdGhlIHBvcnQuIElEcyBjYW4gYmUgdmlld2VkIGJ5IGxvb2tpbmcgYXQgdGhlCiAgICogYFdlYk1pZGkub3V0cHV0c2AgYXJyYXkuCiAgICoKICAgKiBAcmV0dXJucyB7T3V0cHV0fGZhbHNlfSBBIE1JRElPdXRwdXQgcG9ydCBtYXRjaGluZyB0aGUgc3BlY2lmaWVkIElEIHN0cmluZy4gSWYgbm8gbWF0Y2hpbmcgcG9ydAogICAqIGNhbiBiZSBmb3VuZCwgdGhlIG1ldGhvZCByZXR1cm5zIGBmYWxzZWAuCiAgICoKICAgKiBAdGhyb3dzIEVycm9yIFdlYk1pZGkgaXMgbm90IGVuYWJsZWQuCiAgICoKICAgKiBAc2luY2UgMi4wLjAKICAgKi8KCgogIFdlYk1pZGkucHJvdG90eXBlLmdldE91dHB1dEJ5SWQgPSBmdW5jdGlvbiAoaWQpIHsKICAgIGlmICghdGhpcy5lbmFibGVkKSB0aHJvdyBuZXcgRXJyb3IoIldlYk1pZGkgaXMgbm90IGVuYWJsZWQuIik7CiAgICBpZCA9IFN0cmluZyhpZCk7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLm91dHB1dHMubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKHRoaXMub3V0cHV0c1tpXS5pZCA9PT0gaWQpIHJldHVybiB0aGlzLm91dHB1dHNbaV07CiAgICB9CgogICAgcmV0dXJuIGZhbHNlOwogIH07CiAgLyoqCiAgICogUmV0dXJucyB0aGUgZmlyc3QgTUlESSBgSW5wdXRgIHdob3NlIG5hbWUgKmNvbnRhaW5zKiB0aGUgc3BlY2lmaWVkIHN0cmluZy4KICAgKgogICAqIFBsZWFzZSBub3RlIHRoYXQgdGhlIHBvcnQgbmFtZXMgY2hhbmdlIGZyb20gb25lIGhvc3QgdG8gYW5vdGhlci4gRm9yIGV4YW1wbGUsIENocm9tZSBkb2VzCiAgICogbm90IHJlcG9ydCBwb3J0IG5hbWVzIGluIHRoZSBzYW1lIHdheSBhcyB0aGUgSmF6ei1QbHVnaW4gZG9lcy4KICAgKgogICAqIEBtZXRob2QgZ2V0SW5wdXRCeU5hbWUKICAgKiBAc3RhdGljCiAgICoKICAgKiBAcGFyYW0gbmFtZSB7U3RyaW5nfSBUaGUgbmFtZSBvZiBhIE1JREkgaW5wdXQgcG9ydCBzdWNoIGFzIHRob3NlIHZpc2libGUgaW4gdGhlCiAgICogYFdlYk1pZGkuaW5wdXRzYCBhcnJheS4KICAgKgogICAqIEByZXR1cm5zIHtJbnB1dHxGYWxzZX0gVGhlIGBJbnB1dGAgdGhhdCB3YXMgZm91bmQgb3IgYGZhbHNlYCBpZiBubyBpbnB1dCBtYXRjaGVkIHRoZSBzcGVjaWZpZWQKICAgKiBuYW1lLgogICAqCiAgICogQHRocm93cyBFcnJvciBXZWJNaWRpIGlzIG5vdCBlbmFibGVkLgogICAqIEB0aHJvd3MgVHlwZUVycm9yIFRoZSBuYW1lIG11c3QgYmUgYSBzdHJpbmcuCiAgICoKICAgKiBAc2luY2UgMi4wLjAKICAgKi8KCgogIFdlYk1pZGkucHJvdG90eXBlLmdldElucHV0QnlOYW1lID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgIGlmICghdGhpcy5lbmFibGVkKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiV2ViTWlkaSBpcyBub3QgZW5hYmxlZC4iKTsKICAgIH0KCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuaW5wdXRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh+dGhpcy5pbnB1dHNbaV0ubmFtZS5pbmRleE9mKG5hbWUpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5wdXRzW2ldOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGZhbHNlOwogIH07CiAgLyoqCiAgICogUmV0dXJucyB0aGUgb2N0YXZlIG51bWJlciBmb3IgdGhlIHNwZWNpZmllZCBNSURJIG5vdGUgbnVtYmVyICgwLTEyNykuIEJ5IGRlZmF1bHQsIHRoZSB2YWx1ZSBpcwogICAqIGJhc2VkIG9uIG1pZGRsZSBDIChub3RlIG51bWJlciA2MCkgYmVpbmcgcGxhY2VkIG9uIHRoZSA0dGggb2N0YXZlIChDNCkuIEhvd2V2ZXIsIGJ5IHVzaW5nIHRoZQogICAqIDxhIGhyZWY9IiNwcm9wZXJ0eV9vY3RhdmVPZmZzZXQiPm9jdGF2ZU9mZnNldDwvYT4gcHJvcGVydHksIHlvdSBjYW4gb2Zmc2V0IHRoZSByZXN1bHQgYXMgbXVjaAogICAqIGFzIHlvdSB3YW50LgogICAqCiAgICogQG1ldGhvZCBnZXRPY3RhdmUKICAgKiBAc3RhdGljCiAgICoKICAgKiBAcGFyYW0gbnVtYmVyIHtOdW1iZXJ9IEFuIGludGVnZXIgcmVwcmVzZW50aW5nIGEgdmFsaWQgTUlESSBub3RlIG51bWJlciAoYmV0d2VlbiAwIGFuZCAxMjcpLgogICAqCiAgICogQHJldHVybnMge051bWJlcn0gVGhlIG9jdGF2ZSAoYXMgYSBzaWduZWQgaW50ZWdlcikgb3IgYHVuZGVmaW5lZGAuCiAgICoKICAgKiBAc2luY2UgMi4wLjAtcmMuNgogICAqLwoKCiAgV2ViTWlkaS5wcm90b3R5cGUuZ2V0T2N0YXZlID0gZnVuY3Rpb24gKG51bWJlcikgewogICAgaWYgKG51bWJlciAhPSBudWxsICYmIG51bWJlciA+PSAwICYmIG51bWJlciA8PSAxMjcpIHsKICAgICAgcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5mbG9vcihudW1iZXIpIC8gMTIgLSAxKSArIE1hdGguZmxvb3Iod20ub2N0YXZlT2Zmc2V0KTsKICAgIH0KICB9OwogIC8qKgogICAqIFJldHVybnMgdGhlIGZpcnN0IE1JREkgYE91dHB1dGAgdGhhdCBtYXRjaGVzIHRoZSBzcGVjaWZpZWQgbmFtZS4KICAgKgogICAqIFBsZWFzZSBub3RlIHRoYXQgdGhlIHBvcnQgbmFtZXMgY2hhbmdlIGZyb20gb25lIGhvc3QgdG8gYW5vdGhlci4gRm9yIGV4YW1wbGUsIENocm9tZSBkb2VzCiAgICogbm90IHJlcG9ydCBwb3J0IG5hbWVzIGluIHRoZSBzYW1lIHdheSBhcyB0aGUgSmF6ei1QbHVnaW4gZG9lcy4KICAgKgogICAqIEBtZXRob2QgZ2V0T3V0cHV0QnlOYW1lCiAgICogQHN0YXRpYwogICAqCiAgICogQHBhcmFtIG5hbWUge1N0cmluZ30gVGhlIG5hbWUgb2YgYSBNSURJIG91dHB1dCBwb3J0IHN1Y2ggYXMgdGhvc2UgdmlzaWJsZSBpbiB0aGUKICAgKiBgV2ViTWlkaS5vdXRwdXRzYCBhcnJheS4KICAgKgogICAqIEByZXR1cm5zIHtPdXRwdXR8RmFsc2V9IFRoZSBgT3V0cHV0YCB0aGF0IHdhcyBmb3VuZCBvciBgZmFsc2VgIGlmIG5vIG91dHB1dCBtYXRjaGVkIHRoZQogICAqIHNwZWNpZmllZCBuYW1lLgogICAqCiAgICogQHRocm93cyBFcnJvciBXZWJNaWRpIGlzIG5vdCBlbmFibGVkLgogICAqCiAgICogQHNpbmNlIDIuMC4wCiAgICovCgoKICBXZWJNaWRpLnByb3RvdHlwZS5nZXRPdXRwdXRCeU5hbWUgPSBmdW5jdGlvbiAobmFtZSkgewogICAgaWYgKCF0aGlzLmVuYWJsZWQpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJXZWJNaWRpIGlzIG5vdCBlbmFibGVkLiIpOwogICAgfQoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5vdXRwdXRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh+dGhpcy5vdXRwdXRzW2ldLm5hbWUuaW5kZXhPZihuYW1lKSkgewogICAgICAgIHJldHVybiB0aGlzLm91dHB1dHNbaV07CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZmFsc2U7CiAgfTsKICAvKioKICAgKiBSZXR1cm5zIGEgdmFsaWQgTUlESSBub3RlIG51bWJlciAoMC0xMjcpIGdpdmVuIHRoZSBzcGVjaWZpZWQgaW5wdXQuIFRoZSBpbnB1dCB1c3VhbGx5IGlzIGEgbm90ZQogICAqIG5hbWUgKEMzLCBGIzQsIEQtMiwgRzgsIGV0Yy4pLiBJZiBhbiBpbnRlZ2VyIGJldHdlZW4gMCBhbmQgMTI3LCBpdCB3aWxsIHNpbXBseSBiZSByZXR1cm5lZCBhcwogICAqIGlzLgogICAqCiAgICogQG1ldGhvZCBndWVzc05vdGVOdW1iZXIKICAgKiBAc3RhdGljCiAgICoKICAgKiBAcGFyYW0gaW5wdXQge051bWJlcnxTdHJpbmd9IEEgc3RyaW5nIHRvIGV4dHJhY3QgdGhlIG5vdGUgbnVtYmVyIGZyb20uIEFuIGludGVnZXIgY2FuIGFsc28gYmUKICAgKiB1c2VkLCBpbiB3aGljaCBjYXNlIGl0IHdpbGwgc2ltcGx5IGJlIHJldHVybmVkIChpZiBiZXR3ZWVuIDAgYW5kIDEyNykuCiAgICogQHRocm93cyB7RXJyb3J9IEludmFsaWQgaW5wdXQgdmFsdWUKICAgKiBAcmV0dXJucyB7TnVtYmVyfSBBIHZhbGlkIE1JREkgbm90ZSBudW1iZXIgKDAtMTI3KS4KICAgKi8KCgogIFdlYk1pZGkucHJvdG90eXBlLmd1ZXNzTm90ZU51bWJlciA9IGZ1bmN0aW9uIChpbnB1dCkgewogICAgdmFyIG91dHB1dCA9IGZhbHNlOwoKICAgIGlmIChpbnB1dCAmJiBpbnB1dC50b0ZpeGVkICYmIGlucHV0ID49IDAgJiYgaW5wdXQgPD0gMTI3KSB7CiAgICAgIC8vIHVpbnQKICAgICAgb3V0cHV0ID0gTWF0aC5yb3VuZChpbnB1dCk7CiAgICB9IGVsc2UgaWYgKHBhcnNlSW50KGlucHV0KSA+PSAwICYmIHBhcnNlSW50KGlucHV0KSA8PSAxMjcpIHsKICAgICAgLy8gdWludCBhcyBzdHJpbmcKICAgICAgb3V0cHV0ID0gcGFyc2VJbnQoaW5wdXQpOwogICAgfSBlbHNlIGlmICh0eXBlb2YgaW5wdXQgPT09ICJzdHJpbmciIHx8IGlucHV0IGluc3RhbmNlb2YgU3RyaW5nKSB7CiAgICAgIC8vIHN0cmluZwogICAgICBvdXRwdXQgPSB0aGlzLm5vdGVOYW1lVG9OdW1iZXIoaW5wdXQpOwogICAgfQoKICAgIGlmIChvdXRwdXQgPT09IGZhbHNlKSB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgaW5wdXQgdmFsdWUgKCIgKyBpbnB1dCArICIpLiIpOwogICAgcmV0dXJuIG91dHB1dDsKICB9OwogIC8qKgogICAqIFJldHVybnMgYSBNSURJIG5vdGUgbnVtYmVyIG1hdGNoaW5nIHRoZSBub3RlIG5hbWUgcGFzc2VkIGluIHRoZSBmb3JtIG9mIGEgc3RyaW5nIHBhcmFtZXRlci4gVGhlCiAgICogbm90ZSBuYW1lIG11c3QgaW5jbHVkZSB0aGUgb2N0YXZlIG51bWJlci4gVGhlIG5hbWUgY2FuIGFsc28gb3B0aW9uYWxseSBpbmNsdWRlIGEgc2hhcnAgKCMpLAogICAqIGEgZG91YmxlIHNoYXJwICgjIyksIGEgZmxhdCAoYikgb3IgYSBkb3VibGUgZmxhdCAoYmIpIHN5bWJvbDogQzUsIEc0LCBEIy0xLCBGMCwgR2I3LCBFYi0xLAogICAqIEFiYjQsIEIjIzYsIGV0Yy4KICAgKgogICAqIE5vdGUgdGhhdCwgaW4gY29udmVydGluZyBub3RlIG5hbWVzIHRvIG51bWJlcnMsIEM0IGlzIGNvbnNpZGVyZWQgdG8gYmUgbWlkZGxlIEMgKE1JREkgbm90ZQogICAqIG51bWJlciA2MCkgYXMgcGVyIHRoZSBzY2llbnRpZmljIHBpdGNoIG5vdGF0aW9uIHN0YW5kYXJkLgogICAqCiAgICogQWxzbyBub3RlIHRoYXQgdGhlIHJlc3VsdGluZyBub3RlIG51bWJlciBpcyBvZmZzZXQgYnkgdGhlIGBvY3RhdmVPZmZzZXRgIHZhbHVlIChpZiBub3QgemVybykuCiAgICogRm9yIGV4YW1wbGUsIGlmIHlvdSBwYXNzIGluICJDNCIgYW5kIHRoZSBgb2N0YXZlT2Zmc2V0YCB2YWx1ZSBpcyAyIHRoZSByZXN1bHRpbmcgTUlESSBub3RlCiAgICogbnVtYmVyIHdpbGwgYmUgMzYuCiAgICoKICAgKiBAbWV0aG9kIG5vdGVOYW1lVG9OdW1iZXIKICAgKiBAc3RhdGljCiAgICoKICAgKiBAcGFyYW0gbmFtZSB7U3RyaW5nfSBUaGUgbmFtZSBvZiB0aGUgbm90ZSBpbiB0aGUgZm9ybSBvZiBhIGxldHRlciwgZm9sbG93ZWQgYnkgYW4gb3B0aW9uYWwgIiMiLAogICAqICIjIyIsICJiIiBvciAiYmIiIGZvbGxvd2VkIGJ5IHRoZSBvY3RhdmUgbnVtYmVyLgogICAqCiAgICogQHRocm93cyB7UmFuZ2VFcnJvcn0gSW52YWxpZCBub3RlIG5hbWUuCiAgICogQHRocm93cyB7UmFuZ2VFcnJvcn0gSW52YWxpZCBub3RlIG5hbWUgb3Igbm90ZSBvdXRzaWRlIHZhbGlkIHJhbmdlLgogICAqIEByZXR1cm4ge051bWJlcn0gVGhlIE1JREkgbm90ZSBudW1iZXIgKGJldHdlZW4gMCBhbmQgMTI3KQogICAqLwoKCiAgV2ViTWlkaS5wcm90b3R5cGUubm90ZU5hbWVUb051bWJlciA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICBpZiAodHlwZW9mIG5hbWUgIT09ICJzdHJpbmciKSBuYW1lID0gIiI7CiAgICB2YXIgbWF0Y2hlcyA9IG5hbWUubWF0Y2goLyhbQ0RFRkdBQl0pKCN7MCwyfXxiezAsMn0pKC0/XGQrKS9pKTsKICAgIGlmICghbWF0Y2hlcykgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIkludmFsaWQgbm90ZSBuYW1lLiIpOwoKICAgIHZhciBzZW1pdG9uZXMgPSB3bS5fc2VtaXRvbmVzW21hdGNoZXNbMV0udG9VcHBlckNhc2UoKV07CgogICAgdmFyIG9jdGF2ZSA9IHBhcnNlSW50KG1hdGNoZXNbM10pOwogICAgdmFyIHJlc3VsdCA9IChvY3RhdmUgKyAxIC0gTWF0aC5mbG9vcih3bS5vY3RhdmVPZmZzZXQpKSAqIDEyICsgc2VtaXRvbmVzOwoKICAgIGlmIChtYXRjaGVzWzJdLnRvTG93ZXJDYXNlKCkuaW5kZXhPZigiYiIpID4gLTEpIHsKICAgICAgcmVzdWx0IC09IG1hdGNoZXNbMl0ubGVuZ3RoOwogICAgfSBlbHNlIGlmIChtYXRjaGVzWzJdLnRvTG93ZXJDYXNlKCkuaW5kZXhPZigiIyIpID4gLTEpIHsKICAgICAgcmVzdWx0ICs9IG1hdGNoZXNbMl0ubGVuZ3RoOwogICAgfQoKICAgIGlmIChyZXN1bHQgPCAwIHx8IHJlc3VsdCA+IDEyNykgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigiSW52YWxpZCBub3RlIG5hbWUgb3Igbm90ZSBvdXRzaWRlIHZhbGlkIHJhbmdlLiIpOwogICAgfQoKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKICAvKioKICAgKiBAbWV0aG9kIF91cGRhdGVJbnB1dHNBbmRPdXRwdXRzCiAgICogQHN0YXRpYwogICAqIEBwcm90ZWN0ZWQKICAgKi8KCgogIFdlYk1pZGkucHJvdG90eXBlLl91cGRhdGVJbnB1dHNBbmRPdXRwdXRzID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5fdXBkYXRlSW5wdXRzKCk7CgogICAgdGhpcy5fdXBkYXRlT3V0cHV0cygpOwogIH07CiAgLyoqCiAgICogQG1ldGhvZCBfdXBkYXRlSW5wdXRzCiAgICogQHN0YXRpYwogICAqIEBwcm90ZWN0ZWQKICAgKi8KCgogIFdlYk1pZGkucHJvdG90eXBlLl91cGRhdGVJbnB1dHMgPSBmdW5jdGlvbiAoKSB7CiAgICAvLyBDaGVjayBmb3IgaXRlbXMgdG8gcmVtb3ZlIGZyb20gdGhlIGV4aXN0aW5nIGFycmF5IChiZWNhdXNlIHRoZXkgYXJlIG5vIGxvbmdlciBiZWluZyByZXBvcnRlZAogICAgLy8gYnkgdGhlIE1JREkgYmFjay1lbmQpLgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9pbnB1dHMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIHJlbW92ZSA9IHRydWU7CiAgICAgIHZhciB1cGRhdGVkID0gdGhpc1siaW50ZXJmYWNlIl0uaW5wdXRzLnZhbHVlcygpOwoKICAgICAgZm9yICh2YXIgaW5wdXQgPSB1cGRhdGVkLm5leHQoKTsgaW5wdXQgJiYgIWlucHV0LmRvbmU7IGlucHV0ID0gdXBkYXRlZC5uZXh0KCkpIHsKICAgICAgICBpZiAodGhpcy5faW5wdXRzW2ldLl9taWRpSW5wdXQgPT09IGlucHV0LnZhbHVlKSB7CiAgICAgICAgICByZW1vdmUgPSBmYWxzZTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHJlbW92ZSkgewogICAgICAgIHRoaXMuX2lucHV0cy5zcGxpY2UoaSwgMSk7CiAgICAgIH0KICAgIH0gLy8gQ2hlY2sgZm9yIGl0ZW1zIHRvIGFkZCBpbiB0aGUgZXhpc3RpbmcgaW5wdXRzIGFycmF5IGJlY2F1c2UgdGhleSBqdXN0IGFwcGVhcmVkIGluIHRoZSBNSURJCiAgICAvLyBiYWNrLWVuZCBpbnB1dHMgbGlzdC4gV2UgbXVzdCBjaGVjayBmb3IgdGhlIGV4aXN0ZW5jZSBvZiB0aGlzLmludGVyZmFjZSBiZWNhdXNlIGl0IG1pZ2h0CiAgICAvLyBoYXZlIGJlZW4gY2xvc2VkIHZpYSBXZWJNaWRpLmRpc2FibGUoKS4KCgogICAgdGhpc1siaW50ZXJmYWNlIl0gJiYgdGhpc1siaW50ZXJmYWNlIl0uaW5wdXRzLmZvckVhY2goZnVuY3Rpb24gKG5JbnB1dCkgewogICAgICB2YXIgYWRkID0gdHJ1ZTsKCiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdGhpcy5faW5wdXRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgaWYgKHRoaXMuX2lucHV0c1tqXS5fbWlkaUlucHV0ID09PSBuSW5wdXQpIHsKICAgICAgICAgIGFkZCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGFkZCkgewogICAgICAgIHRoaXMuX2lucHV0cy5wdXNoKG5ldyBJbnB1dChuSW5wdXQpKTsKICAgICAgfQogICAgfS5iaW5kKHRoaXMpKTsKICB9OwogIC8qKgogICAqIEBtZXRob2QgX3VwZGF0ZU91dHB1dHMKICAgKiBAc3RhdGljCiAgICogQHByb3RlY3RlZAogICAqLwoKCiAgV2ViTWlkaS5wcm90b3R5cGUuX3VwZGF0ZU91dHB1dHMgPSBmdW5jdGlvbiAoKSB7CiAgICAvLyBDaGVjayBmb3IgaXRlbXMgdG8gcmVtb3ZlIGZyb20gdGhlIGV4aXN0aW5nIGFycmF5IChiZWNhdXNlIHRoZXkgYXJlIG5vIGxvbmdlciBiZWluZyByZXBvcnRlZAogICAgLy8gYnkgdGhlIE1JREkgYmFjay1lbmQpLgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9vdXRwdXRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciByZW1vdmUgPSB0cnVlOwogICAgICB2YXIgdXBkYXRlZCA9IHRoaXNbImludGVyZmFjZSJdLm91dHB1dHMudmFsdWVzKCk7CgogICAgICBmb3IgKHZhciBvdXRwdXQgPSB1cGRhdGVkLm5leHQoKTsgb3V0cHV0ICYmICFvdXRwdXQuZG9uZTsgb3V0cHV0ID0gdXBkYXRlZC5uZXh0KCkpIHsKICAgICAgICBpZiAodGhpcy5fb3V0cHV0c1tpXS5fbWlkaU91dHB1dCA9PT0gb3V0cHV0LnZhbHVlKSB7CiAgICAgICAgICByZW1vdmUgPSBmYWxzZTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHJlbW92ZSkgewogICAgICAgIHRoaXMuX291dHB1dHMuc3BsaWNlKGksIDEpOwogICAgICB9CiAgICB9IC8vIENoZWNrIGZvciBpdGVtcyB0byBhZGQgaW4gdGhlIGV4aXN0aW5nIGlucHV0cyBhcnJheSBiZWNhdXNlIHRoZXkganVzdCBhcHBlYXJlZCBpbiB0aGUgTUlESQogICAgLy8gYmFjay1lbmQgb3V0cHV0cyBsaXN0LiBXZSBtdXN0IGNoZWNrIGZvciB0aGUgZXhpc3RlbmNlIG9mIHRoaXMuaW50ZXJmYWNlIGJlY2F1c2UgaXQgbWlnaHQKICAgIC8vIGhhdmUgYmVlbiBjbG9zZWQgdmlhIFdlYk1pZGkuZGlzYWJsZSgpLgoKCiAgICB0aGlzWyJpbnRlcmZhY2UiXSAmJiB0aGlzWyJpbnRlcmZhY2UiXS5vdXRwdXRzLmZvckVhY2goZnVuY3Rpb24gKG5PdXRwdXQpIHsKICAgICAgdmFyIGFkZCA9IHRydWU7CgogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHRoaXMuX291dHB1dHMubGVuZ3RoOyBqKyspIHsKICAgICAgICBpZiAodGhpcy5fb3V0cHV0c1tqXS5fbWlkaU91dHB1dCA9PT0gbk91dHB1dCkgewogICAgICAgICAgYWRkID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoYWRkKSB7CiAgICAgICAgdGhpcy5fb3V0cHV0cy5wdXNoKG5ldyBPdXRwdXQobk91dHB1dCkpOwogICAgICB9CiAgICB9LmJpbmQodGhpcykpOwogIH07CiAgLyoqCiAgICogQG1ldGhvZCBfb25JbnRlcmZhY2VTdGF0ZUNoYW5nZQogICAqIEBzdGF0aWMKICAgKiBAcHJvdGVjdGVkCiAgICovCgoKICBXZWJNaWRpLnByb3RvdHlwZS5fb25JbnRlcmZhY2VTdGF0ZUNoYW5nZSA9IGZ1bmN0aW9uIChlKSB7CiAgICB0aGlzLl91cGRhdGVJbnB1dHNBbmRPdXRwdXRzKCk7CiAgICAvKioKICAgICAqIEV2ZW50IGVtaXR0ZWQgd2hlbiBhIE1JREkgcG9ydCBiZWNvbWVzIGF2YWlsYWJsZS4gVGhpcyBldmVudCBpcyB0eXBpY2FsbHkgZmlyZWQgd2hlbmV2ZXIgYQogICAgICogTUlESSBkZXZpY2UgaXMgcGx1Z2dlZCBpbi4gUGxlYXNlIG5vdGUgdGhhdCBpdCBtYXkgZmlyZSBzZXZlcmFsIHRpbWVzIGlmIGEgZGV2aWNlIHBvc3Nlc3NlcwogICAgICogbXVsdGlwbGUgaW5wdXQvb3V0cHV0IHBvcnRzLgogICAgICoKICAgICAqIEBldmVudCBjb25uZWN0ZWQKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudAogICAgICogQHBhcmFtIHtOdW1iZXJ9IGV2ZW50LnRpbWVzdGFtcCBUaGUgdGltZXN0YW1wIHdoZW4gdGhlIGV2ZW50IG9jY3VycmVkIChpbiBtaWxsaXNlY29uZHMgc2luY2UKICAgICAqIHRoZSBlcG9jaCkuCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnQudHlwZSBUaGUgdHlwZSBvZiBldmVudCB0aGF0IG9jY3VycmVkLgogICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50LnBvcnQgVGhlIGFjdHVhbCBgSW5wdXRgIG9yIGBPdXRwdXRgIG9iamVjdCBhc3NvY2lhdGVkIHRvIHRoZSBldmVudC4KICAgICAqLwoKICAgIC8qKgogICAgICogRXZlbnQgZW1pdHRlZCB3aGVuIGEgTUlESSBwb3J0IGJlY29tZXMgdW5hdmFpbGFibGUuIFRoaXMgZXZlbnQgaXMgdHlwaWNhbGx5IGZpcmVkIHdoZW5ldmVyIGEKICAgICAqIE1JREkgZGV2aWNlIGlzIHVucGx1Z2dlZC4gUGxlYXNlIG5vdGUgdGhhdCBpdCBtYXkgZmlyZSBzZXZlcmFsIHRpbWVzIGlmIGEgZGV2aWNlIHBvc3Nlc3NlcwogICAgICogbXVsdGlwbGUgaW5wdXQvb3V0cHV0IHBvcnRzLgogICAgICoKICAgICAqIEBldmVudCBkaXNjb25uZWN0ZWQKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudAogICAgICogQHBhcmFtIHtOdW1iZXJ9IGV2ZW50LnRpbWVzdGFtcCBUaGUgdGltZXN0YW1wIHdoZW4gdGhlIGV2ZW50IG9jY3VycmVkIChpbiBtaWxsaXNlY29uZHMgc2luY2UKICAgICAqIHRoZSBlcG9jaCkuCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnQudHlwZSBUaGUgdHlwZSBvZiBldmVudCB0aGF0IG9jY3VycmVkLgogICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50LnBvcnQgQW4gZ2VuZXJpYyBvYmplY3QgY29udGFpbmluZyBkZXRhaWxzIGFib3V0IHRoZSBwb3J0IHRoYXQgdHJpZ2dlcmVkCiAgICAgKiB0aGUgZXZlbnQuCiAgICAgKi8KCgogICAgdmFyIGV2ZW50ID0gewogICAgICB0aW1lc3RhbXA6IGUudGltZVN0YW1wLAogICAgICB0eXBlOiBlLnBvcnQuc3RhdGUKICAgIH07CgogICAgaWYgKHRoaXNbImludGVyZmFjZSJdICYmIGUucG9ydC5zdGF0ZSA9PT0gImNvbm5lY3RlZCIpIHsKICAgICAgaWYgKGUucG9ydC50eXBlID09PSAib3V0cHV0IikgewogICAgICAgIGV2ZW50LnBvcnQgPSB0aGlzLmdldE91dHB1dEJ5SWQoZS5wb3J0LmlkKTsKICAgICAgfSBlbHNlIGlmIChlLnBvcnQudHlwZSA9PT0gImlucHV0IikgewogICAgICAgIGV2ZW50LnBvcnQgPSB0aGlzLmdldElucHV0QnlJZChlLnBvcnQuaWQpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBldmVudC5wb3J0ID0gewogICAgICAgIGNvbm5lY3Rpb246ICJjbG9zZWQiLAogICAgICAgIGlkOiBlLnBvcnQuaWQsCiAgICAgICAgbWFudWZhY3R1cmVyOiBlLnBvcnQubWFudWZhY3R1cmVyLAogICAgICAgIG5hbWU6IGUucG9ydC5uYW1lLAogICAgICAgIHN0YXRlOiBlLnBvcnQuc3RhdGUsCiAgICAgICAgdHlwZTogZS5wb3J0LnR5cGUKICAgICAgfTsKICAgIH0KCiAgICB0aGlzLl91c2VySGFuZGxlcnNbZS5wb3J0LnN0YXRlXS5mb3JFYWNoKGZ1bmN0aW9uIChoYW5kbGVyKSB7CiAgICAgIGhhbmRsZXIoZXZlbnQpOwogICAgfSk7CiAgfTsKICAvKioKICAgKiBAbWV0aG9kIF9yZXNldEludGVyZmFjZVVzZXJIYW5kbGVycwogICAqIEBzdGF0aWMKICAgKiBAcHJvdGVjdGVkCiAgICovCgoKICBXZWJNaWRpLnByb3RvdHlwZS5fcmVzZXRJbnRlcmZhY2VVc2VySGFuZGxlcnMgPSBmdW5jdGlvbiAoKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX21pZGlJbnRlcmZhY2VFdmVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgdGhpcy5fdXNlckhhbmRsZXJzW3RoaXMuX21pZGlJbnRlcmZhY2VFdmVudHNbaV1dID0gW107CiAgICB9CiAgfTsKICAvKioKICAgKiBUaGUgYElucHV0YCBvYmplY3QgcmVwcmVzZW50cyBhIE1JREkgaW5wdXQgcG9ydCBvbiB0aGUgaG9zdCBzeXN0ZW0uIFRoaXMgb2JqZWN0IGlzIGNyZWF0ZWQgYnkKICAgKiB0aGUgTUlESSBzdWJzeXN0ZW0gYW5kIGNhbm5vdCBiZSBpbnN0YW50aWF0ZWQgZGlyZWN0bHkuCiAgICoKICAgKiBZb3Ugd2lsbCBmaW5kIGFsbCBhdmFpbGFibGUgYElucHV0YCBvYmplY3RzIGluIHRoZSBgV2ViTWlkaS5pbnB1dHNgIGFycmF5LgogICAqCiAgICogQGNsYXNzIElucHV0CiAgICogQHBhcmFtIHtNSURJSW5wdXR9IG1pZGlJbnB1dCBgTUlESUlucHV0YCBvYmplY3QKICAgKi8KCgogIGZ1bmN0aW9uIElucHV0KG1pZGlJbnB1dCkgewogICAgdmFyIHRoYXQgPSB0aGlzOyAvLyBVc2VyLWRlZmluZWQgaGFuZGxlcnMgbGlzdAoKICAgIHRoaXMuX3VzZXJIYW5kbGVycyA9IHsKICAgICAgY2hhbm5lbDoge30sCiAgICAgIHN5c3RlbToge30KICAgIH07IC8vIFJlZmVyZW5jZSB0byB0aGUgYWN0dWFsIE1JRElJbnB1dCBvYmplY3QKCiAgICB0aGlzLl9taWRpSW5wdXQgPSBtaWRpSW5wdXQ7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyh0aGlzLCB7CiAgICAgIC8qKgogICAgICAgKiBbcmVhZC1vbmx5XSBTdGF0dXMgb2YgdGhlIE1JREkgcG9ydCJzIGNvbm5lY3Rpb24gKGBwZW5kaW5nYCwgYG9wZW5gIG9yIGBjbG9zZWRgKQogICAgICAgKgogICAgICAgKiBAcHJvcGVydHkgY29ubmVjdGlvbgogICAgICAgKiBAdHlwZSBTdHJpbmcKICAgICAgICovCiAgICAgIGNvbm5lY3Rpb246IHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgcmV0dXJuIHRoYXQuX21pZGlJbnB1dC5jb25uZWN0aW9uOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBbcmVhZC1vbmx5XSBJRCBzdHJpbmcgb2YgdGhlIE1JREkgcG9ydC4gVGhlIElEIGlzIGhvc3Qtc3BlY2lmaWMuIERvIG5vdCBleHBlY3QgdGhlIHNhbWUgSUQKICAgICAgICogb24gZGlmZmVyZW50IHBsYXRmb3Jtcy4gRm9yIGV4YW1wbGUsIEdvb2dsZSBDaHJvbWUgYW5kIHRoZSBKYXp6LVBsdWdpbiByZXBvcnQgY29tcGxldGVseQogICAgICAgKiBkaWZmZXJlbnQgSURzIGZvciB0aGUgc2FtZSBwb3J0LgogICAgICAgKgogICAgICAgKiBAcHJvcGVydHkgaWQKICAgICAgICogQHR5cGUgU3RyaW5nCiAgICAgICAqLwogICAgICBpZDogewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICByZXR1cm4gdGhhdC5fbWlkaUlucHV0LmlkOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBbcmVhZC1vbmx5XSBOYW1lIG9mIHRoZSBtYW51ZmFjdHVyZXIgb2YgdGhlIGRldmljZSB0aGF0IG1ha2VzIHRoaXMgcG9ydCBhdmFpbGFibGUuCiAgICAgICAqCiAgICAgICAqIEBwcm9wZXJ0eSBtYW51ZmFjdHVyZXIKICAgICAgICogQHR5cGUgU3RyaW5nCiAgICAgICAqLwogICAgICBtYW51ZmFjdHVyZXI6IHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgcmV0dXJuIHRoYXQuX21pZGlJbnB1dC5tYW51ZmFjdHVyZXI7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIFtyZWFkLW9ubHldIE5hbWUgb2YgdGhlIE1JREkgcG9ydAogICAgICAgKgogICAgICAgKiBAcHJvcGVydHkgbmFtZQogICAgICAgKiBAdHlwZSBTdHJpbmcKICAgICAgICovCiAgICAgIG5hbWU6IHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgcmV0dXJuIHRoYXQuX21pZGlJbnB1dC5uYW1lOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBbcmVhZC1vbmx5XSBTdGF0ZSBvZiB0aGUgTUlESSBwb3J0IChgY29ubmVjdGVkYCBvciBgZGlzY29ubmVjdGVkYCkKICAgICAgICoKICAgICAgICogQHByb3BlcnR5IHN0YXRlCiAgICAgICAqIEB0eXBlIFN0cmluZwogICAgICAgKi8KICAgICAgc3RhdGU6IHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgcmV0dXJuIHRoYXQuX21pZGlJbnB1dC5zdGF0ZTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogW3JlYWQtb25seV0gVHlwZSBvZiB0aGUgTUlESSBwb3J0IChgaW5wdXRgKQogICAgICAgKgogICAgICAgKiBAcHJvcGVydHkgdHlwZQogICAgICAgKiBAdHlwZSBTdHJpbmcKICAgICAgICovCiAgICAgIHR5cGU6IHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgcmV0dXJuIHRoYXQuX21pZGlJbnB1dC50eXBlOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CgogICAgdGhpcy5faW5pdGlhbGl6ZVVzZXJIYW5kbGVycygpOwoKICAgIHRoaXMuX21pZGlJbnB1dC5vbm1pZGltZXNzYWdlID0gdGhpcy5fb25NaWRpTWVzc2FnZS5iaW5kKHRoaXMpOwogIH0KICAvKioKICAgKiBBZGRzIGFuIGV2ZW50IGxpc3RlbmVyIHRvIHRoZSBgSW5wdXRgIHRoYXQgd2lsbCB0cmlnZ2VyIGEgZnVuY3Rpb24gY2FsbGJhY2sgd2hlbiB0aGUgc3BlY2lmaWVkCiAgICogZXZlbnQgaGFwcGVucy4gVGhlIGV2ZW50cyB0aGF0IGFyZSBkaXNwYXRjaGVkIGNhbiBiZSBjaGFubmVsLXNwZWNpZmljIG9yIElucHV0LXdpZGUuCiAgICoKICAgKiBIZXJlIGlzIGEgbGlzdCBvZiBldmVudHMgdGhhdCBhcmUgZGlzcGF0Y2hlZCBieSBgSW5wdXRgIG9iamVjdHMgYW5kIHRoYXQgY2FuIGJlIGxpc3RlbmVkIHRvLgogICAqCiAgICogQ2hhbm5lbC1zcGVjaWZpYyBNSURJIGV2ZW50czoKICAgKgogICAqICAgICoge3sjY3Jvc3NMaW5rICJJbnB1dC9ub3Rlb2ZmOmV2ZW50In19bm90ZW9mZnt7L2Nyb3NzTGlua319CiAgICogICAgKiB7eyNjcm9zc0xpbmsgIklucHV0L25vdGVvbjpldmVudCJ9fW5vdGVvbnt7L2Nyb3NzTGlua319CiAgICogICAgKiB7eyNjcm9zc0xpbmsgIklucHV0L2tleWFmdGVydG91Y2g6ZXZlbnQifX1rZXlhZnRlcnRvdWNoe3svY3Jvc3NMaW5rfX0KICAgKiAgICAqIHt7I2Nyb3NzTGluayAiSW5wdXQvY29udHJvbGNoYW5nZTpldmVudCJ9fWNvbnRyb2xjaGFuZ2V7ey9jcm9zc0xpbmt9fQogICAqICAgICoge3sjY3Jvc3NMaW5rICJJbnB1dC9ucnBuOmV2ZW50In19bnJwbnt7L2Nyb3NzTGlua319CiAgICogICAgKiB7eyNjcm9zc0xpbmsgIklucHV0L2NoYW5uZWxtb2RlOmV2ZW50In19Y2hhbm5lbG1vZGV7ey9jcm9zc0xpbmt9fQogICAqICAgICoge3sjY3Jvc3NMaW5rICJJbnB1dC9wcm9ncmFtY2hhbmdlOmV2ZW50In19cHJvZ3JhbWNoYW5nZXt7L2Nyb3NzTGlua319CiAgICogICAgKiB7eyNjcm9zc0xpbmsgIklucHV0L2NoYW5uZWxhZnRlcnRvdWNoOmV2ZW50In19Y2hhbm5lbGFmdGVydG91Y2h7ey9jcm9zc0xpbmt9fQogICAqICAgICoge3sjY3Jvc3NMaW5rICJJbnB1dC9waXRjaGJlbmQ6ZXZlbnQifX1waXRjaGJlbmR7ey9jcm9zc0xpbmt9fQogICAqCiAgICogSW5wdXQtd2lkZSBNSURJIGV2ZW50czoKICAgKgogICAqICAgICoge3sjY3Jvc3NMaW5rICJJbnB1dC9zeXNleDpldmVudCJ9fXN5c2V4e3svY3Jvc3NMaW5rfX0KICAgKiAgICAqIHt7I2Nyb3NzTGluayAiSW5wdXQvdGltZWNvZGU6ZXZlbnQifX10aW1lY29kZXt7L2Nyb3NzTGlua319CiAgICogICAgKiB7eyNjcm9zc0xpbmsgIklucHV0L3Nvbmdwb3NpdGlvbjpldmVudCJ9fXNvbmdwb3NpdGlvbnt7L2Nyb3NzTGlua319CiAgICogICAgKiB7eyNjcm9zc0xpbmsgIklucHV0L3NvbmdzZWxlY3Q6ZXZlbnQifX1zb25nc2VsZWN0e3svY3Jvc3NMaW5rfX0KICAgKiAgICAqIHt7I2Nyb3NzTGluayAiSW5wdXQvdHVuaW5ncmVxdWVzdDpldmVudCJ9fXR1bmluZ3JlcXVlc3R7ey9jcm9zc0xpbmt9fQogICAqICAgICoge3sjY3Jvc3NMaW5rICJJbnB1dC9jbG9jazpldmVudCJ9fWNsb2Nre3svY3Jvc3NMaW5rfX0KICAgKiAgICAqIHt7I2Nyb3NzTGluayAiSW5wdXQvc3RhcnQ6ZXZlbnQifX1zdGFydHt7L2Nyb3NzTGlua319CiAgICogICAgKiB7eyNjcm9zc0xpbmsgIklucHV0L2NvbnRpbnVlOmV2ZW50In19Y29udGludWV7ey9jcm9zc0xpbmt9fQogICAqICAgICoge3sjY3Jvc3NMaW5rICJJbnB1dC9zdG9wOmV2ZW50In19c3RvcHt7L2Nyb3NzTGlua319CiAgICogICAgKiB7eyNjcm9zc0xpbmsgIklucHV0L2FjdGl2ZXNlbnNpbmc6ZXZlbnQifX1hY3RpdmVzZW5zaW5ne3svY3Jvc3NMaW5rfX0KICAgKiAgICAqIHt7I2Nyb3NzTGluayAiSW5wdXQvcmVzZXQ6ZXZlbnQifX1yZXNldHt7L2Nyb3NzTGlua319CiAgICogICAgKiB7eyNjcm9zc0xpbmsgIklucHV0L21pZGltZXNzYWdlOmV2ZW50In19bWlkaW1lc3NhZ2V7ey9jcm9zc0xpbmt9fQogICAqICAgICoge3sjY3Jvc3NMaW5rICJJbnB1dC91bmtub3duc3lzdGVtbWVzc2FnZTpldmVudCJ9fXVua25vd25zeXN0ZW1tZXNzYWdle3svY3Jvc3NMaW5rfX0KICAgKgogICAqIEZvciBkZXZpY2Utd2lkZSBldmVudHMsIHRoZSBgY2hhbm5lbGAgcGFyYW1ldGVyIHdpbGwgYmUgc2lsZW50bHkgaWdub3JlZC4gWW91IGNhbiBzaW1wbHkgdXNlCiAgICogYHVuZGVmaW5lZGAgaW4gdGhhdCBjYXNlLgogICAqCiAgICogSWYgeW91IHdhbnQgdG8gdmlldyBhbGwgaW5jb21pbmcgTUlESSB0cmFmZmljLCB5b3UgY2FuIGxpc3RlbiB0byB0aGUgaW5wdXQtd2lkZSBgbWlkaW1lc3NhZ2VgCiAgICogZXZlbnQuIFRoaXMgZXZlbnQgaXMgZGlzcGF0Y2hlZCBmb3IgZXZlcnkgc2luZ2xlIG1lc3NhZ2UgdGhhdCBpcyByZWNlaXZlZCBvbiB0aGF0IGlucHV0LgogICAqCiAgICogQG1ldGhvZCBhZGRMaXN0ZW5lcgogICAqIEBjaGFpbmFibGUKICAgKgogICAqIEBwYXJhbSB0eXBlIHtTdHJpbmd9IFRoZSB0eXBlIG9mIHRoZSBldmVudC4KICAgKgogICAqIEBwYXJhbSBjaGFubmVsIHtOdW1iZXJ8QXJyYXl8U3RyaW5nfSBUaGUgTUlESSBjaGFubmVsIHRvIGxpc3RlbiBvbiAoaW50ZWdlciBiZXR3ZWVuIDEgYW5kIDE2KS4KICAgKiBZb3UgY2FuIGFsc28gc3BlY2lmeSBhbiBhcnJheSBvZiBjaGFubmVsIG51bWJlcnMgb3IgdGhlIHZhbHVlICJhbGwiIChvciBsZWF2ZSBpdCB1bmRlZmluZWQgZm9yCiAgICogaW5wdXQtd2lkZSBldmVudHMpLgogICAqCiAgICogQHBhcmFtIGxpc3RlbmVyIHtGdW5jdGlvbn0gQSBjYWxsYmFjayBmdW5jdGlvbiB0byBleGVjdXRlIHdoZW4gdGhlIHNwZWNpZmllZCBldmVudCBpcyBkZXRlY3RlZC4KICAgKiBUaGlzIGZ1bmN0aW9uIHdpbGwgcmVjZWl2ZSBhbiBldmVudCBwYXJhbWV0ZXIgb2JqZWN0LiBGb3IgZGV0YWlscyBvbiB0aGlzIG9iamVjdCJzIHByb3BlcnRpZXMsCiAgICogY2hlY2sgb3V0IHRoZSBkb2N1bWVudGF0aW9uIGZvciB0aGUgdmFyaW91cyBldmVudHMgKGxpbmtzIGFib3ZlKS4KICAgKgogICAqIEB0aHJvd3Mge1JhbmdlRXJyb3J9IFRoZSAiY2hhbm5lbCIgcGFyYW1ldGVyIGlzIGludmFsaWQuCiAgICogQHRocm93cyB7VHlwZUVycm9yfSBUaGUgImxpc3RlbmVyIiBwYXJhbWV0ZXIgbXVzdCBiZSBhIGZ1bmN0aW9uLgogICAqIEB0aHJvd3Mge1R5cGVFcnJvcn0gVGhlIHNwZWNpZmllZCBldmVudCB0eXBlIGlzIG5vdCBzdXBwb3J0ZWQuCiAgICoKICAgKiBAcmV0dXJuIHtXZWJNaWRpfSBSZXR1cm5zIHRoZSBgV2ViTWlkaWAgb2JqZWN0IHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICovCgoKICBJbnB1dC5wcm90b3R5cGUuYWRkTGlzdGVuZXIgPSBmdW5jdGlvbiAodHlwZSwgY2hhbm5lbCwgbGlzdGVuZXIpIHsKICAgIHZhciB0aGF0ID0gdGhpczsKCiAgICBpZiAoY2hhbm5lbCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGNoYW5uZWwgPSAiYWxsIjsKICAgIH0KCiAgICBpZiAoIUFycmF5LmlzQXJyYXkoY2hhbm5lbCkpIHsKICAgICAgY2hhbm5lbCA9IFtjaGFubmVsXTsKICAgIH0gLy8gQ2hlY2sgaWYgY2hhbm5lbCBlbnRyaWVzIGFyZSB2YWxpZAoKCiAgICBjaGFubmVsLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgaWYgKGl0ZW0gIT09ICJhbGwiICYmICEoaXRlbSA+PSAxICYmIGl0ZW0gPD0gMTYpKSB7CiAgICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIlRoZSAnY2hhbm5lbCcgcGFyYW1ldGVyIGlzIGludmFsaWQuIik7CiAgICAgIH0KICAgIH0pOwoKICAgIGlmICh0eXBlb2YgbGlzdGVuZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVGhlICdsaXN0ZW5lcicgcGFyYW1ldGVyIG11c3QgYmUgYSBmdW5jdGlvbi4iKTsKICAgIH0KCiAgICBpZiAod20uTUlESV9TWVNURU1fTUVTU0FHRVNbdHlwZV0gIT09IHVuZGVmaW5lZCkgewogICAgICBpZiAoIXRoaXMuX3VzZXJIYW5kbGVycy5zeXN0ZW1bdHlwZV0pIHRoaXMuX3VzZXJIYW5kbGVycy5zeXN0ZW1bdHlwZV0gPSBbXTsKCiAgICAgIHRoaXMuX3VzZXJIYW5kbGVycy5zeXN0ZW1bdHlwZV0ucHVzaChsaXN0ZW5lcik7CiAgICB9IGVsc2UgaWYgKHdtLk1JRElfQ0hBTk5FTF9NRVNTQUdFU1t0eXBlXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIC8vIElmICJhbGwiIGlzIHByZXNlbnQgYW55d2hlcmUgaW4gdGhlIGNoYW5uZWwgYXJyYXksIHVzZSBhbGwgMTYgY2hhbm5lbHMKICAgICAgaWYgKGNoYW5uZWwuaW5kZXhPZigiYWxsIikgPiAtMSkgewogICAgICAgIGNoYW5uZWwgPSBbXTsKCiAgICAgICAgZm9yICh2YXIgaiA9IDE7IGogPD0gMTY7IGorKykgewogICAgICAgICAgY2hhbm5lbC5wdXNoKGopOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKCF0aGlzLl91c2VySGFuZGxlcnMuY2hhbm5lbFt0eXBlXSkgewogICAgICAgIHRoaXMuX3VzZXJIYW5kbGVycy5jaGFubmVsW3R5cGVdID0gW107CiAgICAgIH0gLy8gUHVzaCBhbGwgY2hhbm5lbCBsaXN0ZW5lcnMgaW4gdGhlIGFycmF5CgoKICAgICAgY2hhbm5lbC5mb3JFYWNoKGZ1bmN0aW9uIChjaCkgewogICAgICAgIGlmICghdGhhdC5fdXNlckhhbmRsZXJzLmNoYW5uZWxbdHlwZV1bY2hdKSB7CiAgICAgICAgICB0aGF0Ll91c2VySGFuZGxlcnMuY2hhbm5lbFt0eXBlXVtjaF0gPSBbXTsKICAgICAgICB9CgogICAgICAgIHRoYXQuX3VzZXJIYW5kbGVycy5jaGFubmVsW3R5cGVdW2NoXS5wdXNoKGxpc3RlbmVyKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJUaGUgc3BlY2lmaWVkIGV2ZW50IHR5cGUgaXMgbm90IHN1cHBvcnRlZC4iKTsKICAgIH0KCiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIFRoaXMgaXMgYW4gYWxpYXMgdG8gdGhlIHt7I2Nyb3NzTGluayAiSW5wdXQvYWRkTGlzdGVuZXIifX1JbnB1dC5hZGRMaXN0ZW5lcigpe3svY3Jvc3NMaW5rfX0KICAgKiBmdW5jdGlvbi4KICAgKgogICAqIEBtZXRob2Qgb24KICAgKiBAc2luY2UgMi4wLjAKICAgKi8KCgogIElucHV0LnByb3RvdHlwZS5vbiA9IElucHV0LnByb3RvdHlwZS5hZGRMaXN0ZW5lcjsKICAvKioKICAgKiBDaGVja3MgaWYgdGhlIHNwZWNpZmllZCBldmVudCB0eXBlIGlzIGFscmVhZHkgZGVmaW5lZCB0byB0cmlnZ2VyIHRoZSBsaXN0ZW5lciBmdW5jdGlvbiBvbiB0aGUKICAgKiBzcGVjaWZpZWQgY2hhbm5lbChzKS4gSWYgbW9yZSB0aGFuIG9uZSBjaGFubmVsIGlzIHNwZWNpZmllZCwgdGhlIGZ1bmN0aW9uIHdpbGwgcmV0dXJuIGB0cnVlYAogICAqIG9ubHkgaWYgYWxsIGNoYW5uZWxzIGhhdmUgdGhlIGxpc3RlbmVyIGRlZmluZWQuCiAgICoKICAgKiBGb3IgZGV2aWNlLXdpZGUgZXZlbnRzIChgc3lzZXhgLCBgc3RhcnRgLCBldGMuKSwgdGhlIGBjaGFubmVsYCBwYXJhbWV0ZXIgaXMgc2lsZW50bHkgaWdub3JlZC4KICAgKiBXZSBzdWdnZXN0IHlvdSB1c2UgYHVuZGVmaW5lZGAgaW4gc3VjaCBjYXNlcy4KICAgKgogICAqIEBtZXRob2QgaGFzTGlzdGVuZXIKICAgKgogICAqIEBwYXJhbSB0eXBlIHtTdHJpbmd9IFRoZSB0eXBlIG9mIHRoZSBldmVudC4KICAgKiBAcGFyYW0gY2hhbm5lbCB7TnVtYmVyfEFycmF5fFN0cmluZ30gVGhlIE1JREkgY2hhbm5lbCB0byBjaGVjayBvbiAoYmV0d2VlbiAxIGFuZCAxNikuIFlvdQogICAqIGNhbiBhbHNvIHNwZWNpZnkgYW4gYXJyYXkgb2YgY2hhbm5lbCBudW1iZXJzIG9yIHRoZSBzdHJpbmcgImFsbCIuCiAgICogQHBhcmFtIGxpc3RlbmVyIHtGdW5jdGlvbn0gVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHRvIGNoZWNrIGZvci4KICAgKgogICAqIEB0aHJvd3Mge1R5cGVFcnJvcn0gVGhlICJsaXN0ZW5lciIgcGFyYW1ldGVyIG11c3QgYmUgYSBmdW5jdGlvbi4KICAgKgogICAqIEByZXR1cm4ge0Jvb2xlYW59IEJvb2xlYW4gdmFsdWUgaW5kaWNhdGluZyB3aGV0aGVyIG9yIG5vdCB0aGUgY2hhbm5lbChzKSBhbHJlYWR5IGhhdmUgdGhpcwogICAqIGxpc3RlbmVyIGRlZmluZWQuCiAgICovCgogIElucHV0LnByb3RvdHlwZS5oYXNMaXN0ZW5lciA9IGZ1bmN0aW9uICh0eXBlLCBjaGFubmVsLCBsaXN0ZW5lcikgewogICAgdmFyIHRoYXQgPSB0aGlzOwoKICAgIGlmICh0eXBlb2YgbGlzdGVuZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVGhlICdsaXN0ZW5lcicgcGFyYW1ldGVyIG11c3QgYmUgYSBmdW5jdGlvbi4iKTsKICAgIH0KCiAgICBpZiAoY2hhbm5lbCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGNoYW5uZWwgPSAiYWxsIjsKICAgIH0KCiAgICBpZiAoY2hhbm5lbC5jb25zdHJ1Y3RvciAhPT0gQXJyYXkpIHsKICAgICAgY2hhbm5lbCA9IFtjaGFubmVsXTsKICAgIH0KCiAgICBpZiAod20uTUlESV9TWVNURU1fTUVTU0FHRVNbdHlwZV0gIT09IHVuZGVmaW5lZCkgewogICAgICBmb3IgKHZhciBvID0gMDsgbyA8IHRoaXMuX3VzZXJIYW5kbGVycy5zeXN0ZW1bdHlwZV0ubGVuZ3RoOyBvKyspIHsKICAgICAgICBpZiAodGhpcy5fdXNlckhhbmRsZXJzLnN5c3RlbVt0eXBlXVtvXSA9PT0gbGlzdGVuZXIpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIGlmICh3bS5NSURJX0NIQU5ORUxfTUVTU0FHRVNbdHlwZV0gIT09IHVuZGVmaW5lZCkgewogICAgICAvLyBJZiAiYWxsIiBpcyBwcmVzZW50IGFueXdoZXJlIGluIHRoZSBjaGFubmVsIGFycmF5LCB1c2UgYWxsIDE2IGNoYW5uZWxzCiAgICAgIGlmIChjaGFubmVsLmluZGV4T2YoImFsbCIpID4gLTEpIHsKICAgICAgICBjaGFubmVsID0gW107CgogICAgICAgIGZvciAodmFyIGogPSAxOyBqIDw9IDE2OyBqKyspIHsKICAgICAgICAgIGNoYW5uZWwucHVzaChqKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5fdXNlckhhbmRsZXJzLmNoYW5uZWxbdHlwZV0pIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0gLy8gR28gdGhyb3VnaCBhbGwgc3BlY2lmaWVkIGNoYW5uZWxzCgoKICAgICAgcmV0dXJuIGNoYW5uZWwuZXZlcnkoZnVuY3Rpb24gKGNoTnVtKSB7CiAgICAgICAgdmFyIGxpc3RlbmVycyA9IHRoYXQuX3VzZXJIYW5kbGVycy5jaGFubmVsW3R5cGVdW2NoTnVtXTsKICAgICAgICByZXR1cm4gbGlzdGVuZXJzICYmIGxpc3RlbmVycy5pbmRleE9mKGxpc3RlbmVyKSA+IC0xOwogICAgICB9KTsKICAgIH0KCiAgICByZXR1cm4gZmFsc2U7CiAgfTsKICAvKioKICAgKiBSZW1vdmVzIHRoZSBzcGVjaWZpZWQgbGlzdGVuZXIgZnJvbSB0aGUgc3BlY2lmaWVkIGNoYW5uZWwocykuIElmIHRoZSBgbGlzdGVuZXJgIHBhcmFtZXRlciBpcwogICAqIGxlZnQgdW5kZWZpbmVkLCBhbGwgbGlzdGVuZXJzIGZvciB0aGUgc3BlY2lmaWVkIGB0eXBlYCB3aWxsIGJlIHJlbW92ZWQgZnJvbSBhbGwgY2hhbm5lbHMuIElmCiAgICogdGhlIGBjaGFubmVsYCBpcyBhbHNvIG9taXR0ZWQsIGFsbCBsaXN0ZW5lcnMgb2YgdGhlIHNwZWNpZmllZCB0eXBlIHdpbGwgYmUgcmVtb3ZlZCBmcm9tIGFsbAogICAqIGNoYW5uZWxzLiBJZiBubyBwYXJhbWV0ZXJzIGFyZSBkZWZpbmVkLCBhbGwgbGlzdGVuZXJzIGF0dGFjaGVkIHRvIGFueSBjaGFubmVsIG9mIHRoZSBgSW5wdXRgCiAgICogd2lsbCBiZSByZW1vdmVkLgogICAqCiAgICogRm9yIGRldmljZS13aWRlIGV2ZW50cyAoYHN5c2V4YCwgYHN0YXJ0YCwgZXRjLiksIHRoZSBgY2hhbm5lbGAgcGFyYW1ldGVyIGlzIHNpbGVudGx5IGlnbm9yZWQuCiAgICogWW91IGNhbiB1c2UgYHVuZGVmaW5lZGAgaW4gc3VjaCBjYXNlcy4KICAgKgogICAqIEBtZXRob2QgcmVtb3ZlTGlzdGVuZXIKICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0gW3R5cGVdIHtTdHJpbmd9IFRoZSB0eXBlIG9mIHRoZSBldmVudC4KICAgKiBAcGFyYW0gW2NoYW5uZWxdIHtOdW1iZXJ8U3RyaW5nfEFycmF5fSBUaGUgTUlESSBjaGFubmVsKHMpIHRvIGNoZWNrIG9uLiBJdCBjYW4gYmUgYSB1aW50CiAgICogKGJldHdlZW4gMSBhbmQgMTYpIGFuIGFycmF5IG9mIGNoYW5uZWwgbnVtYmVycyBvciB0aGUgc3BlY2lhbCB2YWx1ZSAiYWxsIi4KICAgKiBAcGFyYW0gW2xpc3RlbmVyXSB7RnVuY3Rpb259IFRoZSBjYWxsYmFjayBmdW5jdGlvbiB0byBjaGVjayBmb3IuCiAgICoKICAgKiBAdGhyb3dzIHtUeXBlRXJyb3J9IFRoZSBzcGVjaWZpZWQgZXZlbnQgdHlwZSBpcyBub3Qgc3VwcG9ydGVkLgogICAqIEB0aHJvd3Mge1R5cGVFcnJvcn0gVGhlICJsaXN0ZW5lciIgcGFyYW1ldGVyIG11c3QgYmUgYSBmdW5jdGlvbi4uCiAgICoKICAgKiBAcmV0dXJuIHtJbnB1dH0gVGhlIGBJbnB1dGAgb2JqZWN0IGZvciBlYXN5IG1ldGhvZCBjaGFpbmluZy4KICAgKi8KCgogIElucHV0LnByb3RvdHlwZS5yZW1vdmVMaXN0ZW5lciA9IGZ1bmN0aW9uICh0eXBlLCBjaGFubmVsLCBsaXN0ZW5lcikgewogICAgdmFyIHRoYXQgPSB0aGlzOwoKICAgIGlmIChsaXN0ZW5lciAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBsaXN0ZW5lciAhPT0gImZ1bmN0aW9uIikgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJUaGUgJ2xpc3RlbmVyJyBwYXJhbWV0ZXIgbXVzdCBiZSBhIGZ1bmN0aW9uLiIpOwogICAgfQoKICAgIGlmIChjaGFubmVsID09PSB1bmRlZmluZWQpIHsKICAgICAgY2hhbm5lbCA9ICJhbGwiOwogICAgfQoKICAgIGlmIChjaGFubmVsLmNvbnN0cnVjdG9yICE9PSBBcnJheSkgewogICAgICBjaGFubmVsID0gW2NoYW5uZWxdOwogICAgfQoKICAgIGlmICh3bS5NSURJX1NZU1RFTV9NRVNTQUdFU1t0eXBlXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIGlmIChsaXN0ZW5lciA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy5fdXNlckhhbmRsZXJzLnN5c3RlbVt0eXBlXSA9IFtdOwogICAgICB9IGVsc2UgewogICAgICAgIGZvciAodmFyIG8gPSAwOyBvIDwgdGhpcy5fdXNlckhhbmRsZXJzLnN5c3RlbVt0eXBlXS5sZW5ndGg7IG8rKykgewogICAgICAgICAgaWYgKHRoaXMuX3VzZXJIYW5kbGVycy5zeXN0ZW1bdHlwZV1bb10gPT09IGxpc3RlbmVyKSB7CiAgICAgICAgICAgIHRoaXMuX3VzZXJIYW5kbGVycy5zeXN0ZW1bdHlwZV0uc3BsaWNlKG8sIDEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIGlmICh3bS5NSURJX0NIQU5ORUxfTUVTU0FHRVNbdHlwZV0gIT09IHVuZGVmaW5lZCkgewogICAgICAvLyBJZiAiYWxsIiBpcyBwcmVzZW50IGFueXdoZXJlIGluIHRoZSBjaGFubmVsIGFycmF5LCB1c2UgYWxsIDE2IGNoYW5uZWxzCiAgICAgIGlmIChjaGFubmVsLmluZGV4T2YoImFsbCIpID4gLTEpIHsKICAgICAgICBjaGFubmVsID0gW107CgogICAgICAgIGZvciAodmFyIGogPSAxOyBqIDw9IDE2OyBqKyspIHsKICAgICAgICAgIGNoYW5uZWwucHVzaChqKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5fdXNlckhhbmRsZXJzLmNoYW5uZWxbdHlwZV0pIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSAvLyBHbyB0aHJvdWdoIGFsbCBzcGVjaWZpZWQgY2hhbm5lbHMKCgogICAgICBjaGFubmVsLmZvckVhY2goZnVuY3Rpb24gKGNoTnVtKSB7CiAgICAgICAgdmFyIGxpc3RlbmVycyA9IHRoYXQuX3VzZXJIYW5kbGVycy5jaGFubmVsW3R5cGVdW2NoTnVtXTsKCiAgICAgICAgaWYgKCFsaXN0ZW5lcnMpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmIChsaXN0ZW5lciA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB0aGF0Ll91c2VySGFuZGxlcnMuY2hhbm5lbFt0eXBlXVtjaE51bV0gPSBbXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yICh2YXIgbCA9IDA7IGwgPCBsaXN0ZW5lcnMubGVuZ3RoOyBsKyspIHsKICAgICAgICAgICAgaWYgKGxpc3RlbmVyc1tsXSA9PT0gbGlzdGVuZXIpIHsKICAgICAgICAgICAgICBsaXN0ZW5lcnMuc3BsaWNlKGwsIDEpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHRoaXMuX2luaXRpYWxpemVVc2VySGFuZGxlcnMoKTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlRoZSBzcGVjaWZpZWQgZXZlbnQgdHlwZSBpcyBub3Qgc3VwcG9ydGVkLiIpOwogICAgfQoKICAgIHJldHVybiB0aGlzOwogIH07CiAgLyoqCiAgICogQG1ldGhvZCBfaW5pdGlhbGl6ZVVzZXJIYW5kbGVycwogICAqIEBwcm90ZWN0ZWQKICAgKi8KCgogIElucHV0LnByb3RvdHlwZS5faW5pdGlhbGl6ZVVzZXJIYW5kbGVycyA9IGZ1bmN0aW9uICgpIHsKICAgIGZvciAodmFyIHByb3AxIGluIHdtLk1JRElfQ0hBTk5FTF9NRVNTQUdFUykgewogICAgICBpZiAod20uTUlESV9DSEFOTkVMX01FU1NBR0VTLmhhc093blByb3BlcnR5KHByb3AxKSkgewogICAgICAgIHRoaXMuX3VzZXJIYW5kbGVycy5jaGFubmVsW3Byb3AxXSA9IHt9OwogICAgICB9CiAgICB9CgogICAgZm9yICh2YXIgcHJvcDIgaW4gd20uTUlESV9TWVNURU1fTUVTU0FHRVMpIHsKICAgICAgaWYgKHdtLk1JRElfU1lTVEVNX01FU1NBR0VTLmhhc093blByb3BlcnR5KHByb3AyKSkgewogICAgICAgIHRoaXMuX3VzZXJIYW5kbGVycy5zeXN0ZW1bcHJvcDJdID0gW107CiAgICAgIH0KICAgIH0KICB9OwogIC8qKgogICAqIEBtZXRob2QgX29uTWlkaU1lc3NhZ2UKICAgKiBAcHJvdGVjdGVkCiAgICovCgoKICBJbnB1dC5wcm90b3R5cGUuX29uTWlkaU1lc3NhZ2UgPSBmdW5jdGlvbiAoZSkgewogICAgLy8gRXhlY3V0ZSAibWlkaW1lc3NhZ2UiIGxpc3RlbmVycyAoaWYgYW55KQogICAgaWYgKHRoaXMuX3VzZXJIYW5kbGVycy5zeXN0ZW1bIm1pZGltZXNzYWdlIl0ubGVuZ3RoID4gMCkgewogICAgICB2YXIgZXZlbnQgPSB7CiAgICAgICAgdGFyZ2V0OiB0aGlzLAogICAgICAgIGRhdGE6IGUuZGF0YSwKICAgICAgICB0aW1lc3RhbXA6IGUudGltZVN0YW1wLAogICAgICAgIHR5cGU6ICJtaWRpbWVzc2FnZSIKICAgICAgfTsKICAgICAgLyoqCiAgICAgICAqIEV2ZW50IGVtaXR0ZWQgd2hlbiBhIE1JREkgbWVzc2FnZSBpcyByZWNlaXZlZC4gVGhpcyBzaG91bGQgYmUgdXNlZCBwcmltYXJpbHkgZm9yIGRlYnVnZ2luZwogICAgICAgKiBwdXJwb3Nlcy4KICAgICAgICoKICAgICAgICogQGV2ZW50IG1pZGltZXNzYWdlCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudAogICAgICAgKiBAcGFyYW0ge0lucHV0fSBldmVudC50YXJnZXQgVGhlIGBJbnB1dGAgdGhhdCB0cmlnZ2VyZWQgdGhlIGV2ZW50LgogICAgICAgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGV2ZW50LmRhdGEgVGhlIHJhdyBNSURJIG1lc3NhZ2UgYXMgYW4gYXJyYXkgb2YgOCBiaXQgdmFsdWVzLgogICAgICAgKiBAcGFyYW0ge3VpbnR9IGV2ZW50LnRpbWVzdGFtcCBUaGUgdGltZXN0YW1wIHdoZW4gdGhlIGV2ZW50IG9jY3VycmVkIChpbiBtaWxsaXNlY29uZHMgc2luY2UKICAgICAgICogdGhlIFtVbml4IEVwb2NoXShodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Vbml4X3RpbWUpKS4KICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50LnR5cGUgVGhlIHR5cGUgb2YgZXZlbnQgdGhhdCBvY2N1cnJlZC4KICAgICAgICogQHNpbmNlIDIuMQogICAgICAgKi8KCiAgICAgIHRoaXMuX3VzZXJIYW5kbGVycy5zeXN0ZW1bIm1pZGltZXNzYWdlIl0uZm9yRWFjaChmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICBjYWxsYmFjayhldmVudCk7CiAgICAgIH0pOwogICAgfQoKICAgIGlmIChlLmRhdGFbMF0gPCAyNDApIHsKICAgICAgLy8gY2hhbm5lbC1zcGVjaWZpYyBtZXNzYWdlCiAgICAgIHRoaXMuX3BhcnNlQ2hhbm5lbEV2ZW50KGUpOwoKICAgICAgdGhpcy5fcGFyc2VOcnBuRXZlbnQoZSk7CiAgICB9IGVsc2UgaWYgKGUuZGF0YVswXSA8PSAyNTUpIHsKICAgICAgLy8gc3lzdGVtIG1lc3NhZ2UKICAgICAgdGhpcy5fcGFyc2VTeXN0ZW1FdmVudChlKTsKICAgIH0KICB9OwogIC8qKgogICAqIFBhcnNlcyBjaGFubmVsIGV2ZW50cyBhbmQgY29uc3RydWN0cyBOUlBOIG1lc3NhZ2UgcGFydHMgaW4gdmFsaWQgc2VxdWVuY2VzLgogICAqIEtlZXBzIGEgc2VwYXJhdGUgTlJQTiBidWZmZXIgZm9yIGVhY2ggY2hhbm5lbC4KICAgKiBFbWl0cyBhbiBldmVudCBhZnRlciBpdCByZWNlaXZlcyB0aGUgZmluYWwgQ0MgcGFydHMgbXNiIDEyNyBsc2IgMTI3LgogICAqIElmIGEgbWVzc2FnZSBpcyBpbmNvbXBsZXRlIGFuZCBvdGhlciBtZXNzYWdlcyBhcmUgcmVjZWl2ZWQgYmVmb3JlCiAgICogdGhlIGZpbmFsIDEyNyBieXRlcywgdGhlIGluY29tcGxldGUgbWVzc2FnZSBpcyBjbGVhcmVkLgogICAqIEBtZXRob2QgX3BhcnNlTnJwbkV2ZW50CiAgICogQHBhcmFtIGUgRXZlbnQKICAgKiBAcHJvdGVjdGVkCiAgICovCgoKICBJbnB1dC5wcm90b3R5cGUuX3BhcnNlTnJwbkV2ZW50ID0gZnVuY3Rpb24gKGUpIHsKICAgIHZhciBjb21tYW5kID0gZS5kYXRhWzBdID4+IDQ7CiAgICB2YXIgY2hhbm5lbEJ1ZmZlckluZGV4ID0gZS5kYXRhWzBdICYgMHhmOyAvLyB1c2UgdGhpcyBmb3IgaW5kZXggb2YgY2hhbm5lbCBpbiBfbnJwbkJ1ZmZlcgoKICAgIHZhciBjaGFubmVsID0gY2hhbm5lbEJ1ZmZlckluZGV4ICsgMTsKICAgIHZhciBkYXRhMSwgZGF0YTI7CgogICAgaWYgKGUuZGF0YS5sZW5ndGggPiAxKSB7CiAgICAgIGRhdGExID0gZS5kYXRhWzFdOwogICAgICBkYXRhMiA9IGUuZGF0YS5sZW5ndGggPiAyID8gZS5kYXRhWzJdIDogdW5kZWZpbmVkOwogICAgfSAvLyBucnBuIGRpc2FibGVkCgoKICAgIGlmICghd20ubnJwbkV2ZW50c0VuYWJsZWQpIHsKICAgICAgcmV0dXJuOwogICAgfSAvLyBucnBuIGVuYWJsZWQsIG1lc3NhZ2Ugbm90IHZhbGlkIGZvciBucnBuCgoKICAgIGlmICghKGNvbW1hbmQgPT09IHdtLk1JRElfQ0hBTk5FTF9NRVNTQUdFUy5jb250cm9sY2hhbmdlICYmIChkYXRhMSA+PSB3bS5NSURJX05SUE5fTUVTU0FHRVMuaW5jcmVtZW50ICYmIGRhdGExIDw9IHdtLk1JRElfTlJQTl9NRVNTQUdFUy5wYXJhbW1zYiB8fCBkYXRhMSA9PT0gd20uTUlESV9OUlBOX01FU1NBR0VTLmVudHJ5bXNiIHx8IGRhdGExID09PSB3bS5NSURJX05SUE5fTUVTU0FHRVMuZW50cnlsc2IpKSkgewogICAgICByZXR1cm47CiAgICB9IC8vIHNldCB1cCBhIENDIGV2ZW50IHRvIHBhcnNlIGFzIE5SUE4gcGFydAoKCiAgICB2YXIgY2NFdmVudCA9IHsKICAgICAgdGFyZ2V0OiB0aGlzLAogICAgICB0eXBlOiAiY29udHJvbGNoYW5nZSIsCiAgICAgIGRhdGE6IGUuZGF0YSwKICAgICAgdGltZXN0YW1wOiBlLnRpbWVTdGFtcCwKICAgICAgY2hhbm5lbDogY2hhbm5lbCwKICAgICAgY29udHJvbGxlcjogewogICAgICAgIG51bWJlcjogZGF0YTEsCiAgICAgICAgbmFtZTogdGhpcy5nZXRDY05hbWVCeU51bWJlcihkYXRhMSkKICAgICAgfSwKICAgICAgdmFsdWU6IGRhdGEyCiAgICB9OwoKICAgIGlmICggLy8gaWYgd2UgZ2V0IGEgc3RhcnRpbmcgTVNCKENDOTkgLSAwLTEyNikgdnMgYW4gZW5kIE1TQihDQzk5IC0gMTI3KQogICAgLy8gZGVzdHJveSBpbmNsb21wbGV0ZSBOUlBOIGFuZCBiZWdpbiBidWlsZGluZyBhZ2FpbgogICAgY2NFdmVudC5jb250cm9sbGVyLm51bWJlciA9PT0gd20uTUlESV9OUlBOX01FU1NBR0VTLnBhcmFtbXNiICYmIGNjRXZlbnQudmFsdWUgIT0gd20uTUlESV9OUlBOX01FU1NBR0VTLm51bGxhY3RpdmVwYXJhbWV0ZXIpIHsKICAgICAgd20uX25ycG5CdWZmZXJbY2hhbm5lbEJ1ZmZlckluZGV4XSA9IFtdOwogICAgICB3bS5fbnJwbkJ1ZmZlcltjaGFubmVsQnVmZmVySW5kZXhdWzBdID0gY2NFdmVudDsKICAgIH0gZWxzZSBpZiAoIC8vIGFkZCB0aGUgcGFyYW0gTFNCCiAgICB3bS5fbnJwbkJ1ZmZlcltjaGFubmVsQnVmZmVySW5kZXhdLmxlbmd0aCA9PT0gMSAmJiBjY0V2ZW50LmNvbnRyb2xsZXIubnVtYmVyID09PSB3bS5NSURJX05SUE5fTUVTU0FHRVMucGFyYW1sc2IpIHsKICAgICAgd20uX25ycG5CdWZmZXJbY2hhbm5lbEJ1ZmZlckluZGV4XS5wdXNoKGNjRXZlbnQpOwogICAgfSBlbHNlIGlmICggLy8gYWRkIGRhdGEgaW5jL2RlYyBvciB2YWx1ZSBNU0IgZm9yIDE0Yml0CiAgICB3bS5fbnJwbkJ1ZmZlcltjaGFubmVsQnVmZmVySW5kZXhdLmxlbmd0aCA9PT0gMiAmJiAoY2NFdmVudC5jb250cm9sbGVyLm51bWJlciA9PT0gd20uTUlESV9OUlBOX01FU1NBR0VTLmluY3JlbWVudCB8fCBjY0V2ZW50LmNvbnRyb2xsZXIubnVtYmVyID09PSB3bS5NSURJX05SUE5fTUVTU0FHRVMuZGVjcmVtZW50IHx8IGNjRXZlbnQuY29udHJvbGxlci5udW1iZXIgPT09IHdtLk1JRElfTlJQTl9NRVNTQUdFUy5lbnRyeW1zYikpIHsKICAgICAgd20uX25ycG5CdWZmZXJbY2hhbm5lbEJ1ZmZlckluZGV4XS5wdXNoKGNjRXZlbnQpOwogICAgfSBlbHNlIGlmICggLy8gaWYgd2UgaGF2ZSBhIHZhbHVlIE1TQiwgb25seSBhZGQgYW4gTFNCIHRvIHBhaXIgd2l0aCB0aGF0CiAgICB3bS5fbnJwbkJ1ZmZlcltjaGFubmVsQnVmZmVySW5kZXhdLmxlbmd0aCA9PT0gMyAmJiB3bS5fbnJwbkJ1ZmZlcltjaGFubmVsQnVmZmVySW5kZXhdWzJdLm51bWJlciA9PT0gd20uTUlESV9OUlBOX01FU1NBR0VTLmVudHJ5bXNiICYmIGNjRXZlbnQuY29udHJvbGxlci5udW1iZXIgPT09IHdtLk1JRElfTlJQTl9NRVNTQUdFUy5lbnRyeWxzYikgewogICAgICB3bS5fbnJwbkJ1ZmZlcltjaGFubmVsQnVmZmVySW5kZXhdLnB1c2goY2NFdmVudCk7CiAgICB9IGVsc2UgaWYgKCAvLyBhZGQgYW4gZW5kIE1TQihDQzk5IC0gMTI3KQogICAgd20uX25ycG5CdWZmZXJbY2hhbm5lbEJ1ZmZlckluZGV4XS5sZW5ndGggPj0gMyAmJiB3bS5fbnJwbkJ1ZmZlcltjaGFubmVsQnVmZmVySW5kZXhdLmxlbmd0aCA8PSA0ICYmIGNjRXZlbnQuY29udHJvbGxlci5udW1iZXIgPT09IHdtLk1JRElfTlJQTl9NRVNTQUdFUy5wYXJhbW1zYiAmJiBjY0V2ZW50LnZhbHVlID09PSB3bS5NSURJX05SUE5fTUVTU0FHRVMubnVsbGFjdGl2ZXBhcmFtZXRlcikgewogICAgICB3bS5fbnJwbkJ1ZmZlcltjaGFubmVsQnVmZmVySW5kZXhdLnB1c2goY2NFdmVudCk7CiAgICB9IGVsc2UgaWYgKCAvLyBhZGQgYW4gZW5kIExTQihDQzk5IC0gMTI3KQogICAgd20uX25ycG5CdWZmZXJbY2hhbm5lbEJ1ZmZlckluZGV4XS5sZW5ndGggPj0gNCAmJiB3bS5fbnJwbkJ1ZmZlcltjaGFubmVsQnVmZmVySW5kZXhdLmxlbmd0aCA8PSA1ICYmIGNjRXZlbnQuY29udHJvbGxlci5udW1iZXIgPT09IHdtLk1JRElfTlJQTl9NRVNTQUdFUy5wYXJhbWxzYiAmJiBjY0V2ZW50LnZhbHVlID09PSB3bS5NSURJX05SUE5fTUVTU0FHRVMubnVsbGFjdGl2ZXBhcmFtZXRlcikgewogICAgICB3bS5fbnJwbkJ1ZmZlcltjaGFubmVsQnVmZmVySW5kZXhdLnB1c2goY2NFdmVudCk7IC8vIG5vdyB3ZSBoYXZlIGEgZnVsbCBpbmMgb3IgZGVjIE5SUE4gbWVzc2FnZSwgbGV0cyBjcmVhdGUgdGhhdCBldmVudCEKCgogICAgICB2YXIgcmF3RGF0YSA9IFtdOwoKICAgICAgd20uX25ycG5CdWZmZXJbY2hhbm5lbEJ1ZmZlckluZGV4XS5mb3JFYWNoKGZ1bmN0aW9uIChldikgewogICAgICAgIHJhd0RhdGEucHVzaChldi5kYXRhKTsKICAgICAgfSk7CgogICAgICB2YXIgbnJwbk51bWJlciA9IHdtLl9ucnBuQnVmZmVyW2NoYW5uZWxCdWZmZXJJbmRleF1bMF0udmFsdWUgPDwgNyB8IHdtLl9ucnBuQnVmZmVyW2NoYW5uZWxCdWZmZXJJbmRleF1bMV0udmFsdWU7CiAgICAgIHZhciBucnBuVmFsdWUgPSB3bS5fbnJwbkJ1ZmZlcltjaGFubmVsQnVmZmVySW5kZXhdWzJdLnZhbHVlOwoKICAgICAgaWYgKHdtLl9ucnBuQnVmZmVyW2NoYW5uZWxCdWZmZXJJbmRleF0ubGVuZ3RoID09PSA2KSB7CiAgICAgICAgbnJwblZhbHVlID0gd20uX25ycG5CdWZmZXJbY2hhbm5lbEJ1ZmZlckluZGV4XVsyXS52YWx1ZSA8PCA3IHwgd20uX25ycG5CdWZmZXJbY2hhbm5lbEJ1ZmZlckluZGV4XVszXS52YWx1ZTsKICAgICAgfQoKICAgICAgdmFyIG5ycG5Db250cm9sbGVyVHlwZSA9ICIiOwoKICAgICAgc3dpdGNoICh3bS5fbnJwbkJ1ZmZlcltjaGFubmVsQnVmZmVySW5kZXhdWzJdLmNvbnRyb2xsZXIubnVtYmVyKSB7CiAgICAgICAgY2FzZSB3bS5NSURJX05SUE5fTUVTU0FHRVMuZW50cnltc2I6CiAgICAgICAgICBucnBuQ29udHJvbGxlclR5cGUgPSB3bS5fbnJwblR5cGVzWzBdOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2Ugd20uTUlESV9OUlBOX01FU1NBR0VTLmluY3JlbWVudDoKICAgICAgICAgIG5ycG5Db250cm9sbGVyVHlwZSA9IHdtLl9ucnBuVHlwZXNbMV07CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSB3bS5NSURJX05SUE5fTUVTU0FHRVMuZGVjcmVtZW50OgogICAgICAgICAgbnJwbkNvbnRyb2xsZXJUeXBlID0gd20uX25ycG5UeXBlc1syXTsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgTlBSTiB0eXBlIHdhcyB1bmlkZW50aWZpYWJsZS4iKTsKICAgICAgfQogICAgICAvKioKICAgICAgICogRXZlbnQgZW1pdHRlZCB3aGVuIGEgdmFsaWQgTlJQTiBtZXNzYWdlIHNlcXVlbmNlIGhhcyBiZWVuIHJlY2VpdmVkIG9uIGEgc3BlY2lmaWMgZGV2aWNlIGFuZAogICAgICAgKiBjaGFubmVsLgogICAgICAgKgogICAgICAgKiBAZXZlbnQgbnJwbgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQKICAgICAgICogQHBhcmFtIHtJbnB1dH0gZXZlbnQudGFyZ2V0IFRoZSBgSW5wdXRgIHRoYXQgdHJpZ2dlcmVkIHRoZSBldmVudC4KICAgICAgICogQHBhcmFtIHtBcnJheX0gZXZlbnQuZGF0YSBUaGUgcmF3IE1JREkgbWVzc2FnZSBhcyBhcnJheXMgb2YgOCBiaXQgdmFsdWVzKCBVaW50OEFycmF5ICkuCiAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSBldmVudC50aW1lc3RhbXAgVGhlIHRpbWUgd2hlbiB0aGUgZXZlbnQgb2NjdXJyZWQgKGluIG1pbGxpc2Vjb25kcykKICAgICAgICogQHBhcmFtIHt1aW50fSBldmVudC5jaGFubmVsIFRoZSBjaGFubmVsIHdoZXJlIHRoZSBldmVudCBvY2N1cnJlZCAoYmV0d2VlbiAxIGFuZCAxNikuCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudC50eXBlIFRoZSB0eXBlIG9mIGV2ZW50IHRoYXQgb2NjdXJyZWQuCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudC5jb250cm9sbGVyCiAgICAgICAqIEBwYXJhbSB7dWludH0gZXZlbnQuY29udHJvbGxlci5udW1iZXIgVGhlIG51bWJlciBvZiB0aGUgTlJQTi4KICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50LmNvbnRyb2xsZXIubmFtZSBUaGUgdXN1YWwgbmFtZSBvciBmdW5jdGlvbiBvZiB0aGUgY29udHJvbGxlci4KICAgICAgICogQHBhcmFtIHt1aW50fSBldmVudC52YWx1ZSBUaGUgdmFsdWUgcmVjZWl2ZWQgKGJldHdlZW4gMCBhbmQgNjU1MzUpLgogICAgICAgKi8KCgogICAgICB2YXIgbnJwbkV2ZW50ID0gewogICAgICAgIHRpbWVzdGFtcDogY2NFdmVudC50aW1lc3RhbXAsCiAgICAgICAgY2hhbm5lbDogY2NFdmVudC5jaGFubmVsLAogICAgICAgIHR5cGU6ICJucnBuIiwKICAgICAgICBkYXRhOiByYXdEYXRhLAogICAgICAgIGNvbnRyb2xsZXI6IHsKICAgICAgICAgIG51bWJlcjogbnJwbk51bWJlciwKICAgICAgICAgIHR5cGU6IG5ycG5Db250cm9sbGVyVHlwZSwKICAgICAgICAgIG5hbWU6ICJOb24tUmVnaXN0ZXJlZCBQYXJhbWV0ZXIgIiArIG5ycG5OdW1iZXIKICAgICAgICB9LAogICAgICAgIHZhbHVlOiBucnBuVmFsdWUKICAgICAgfTsgLy8gbm93IHdlIGFyZSBkb25lIGJ1aWxkaW5nIGFuIE5SUE4sIHNvIGNsZWFyIHRoZSBOUlBOIGJ1ZmZlciBmb3IgdGhpcyBjaGFubmVsCgogICAgICB3bS5fbnJwbkJ1ZmZlcltjaGFubmVsQnVmZmVySW5kZXhdID0gW107IC8vIElmIHNvbWUgY2FsbGJhY2tzIGhhdmUgYmVlbiBkZWZpbmVkIGZvciB0aGlzIGV2ZW50LCBvbiB0aGF0IGRldmljZSBhbmQgY2hhbm5lbCwgZXhlY3V0ZQogICAgICAvLyB0aGVtLgoKICAgICAgaWYgKHRoaXMuX3VzZXJIYW5kbGVycy5jaGFubmVsW25ycG5FdmVudC50eXBlXSAmJiB0aGlzLl91c2VySGFuZGxlcnMuY2hhbm5lbFtucnBuRXZlbnQudHlwZV1bbnJwbkV2ZW50LmNoYW5uZWxdKSB7CiAgICAgICAgdGhpcy5fdXNlckhhbmRsZXJzLmNoYW5uZWxbbnJwbkV2ZW50LnR5cGVdW25ycG5FdmVudC5jaGFubmVsXS5mb3JFYWNoKGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgY2FsbGJhY2sobnJwbkV2ZW50KTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gc29tZXRoaW5nIGRpZG4ndCBtYXRjaCwgY2xlYXIgdGhlIGluY29tcGxldGUgTlJQTiBtZXNzYWdlIGJ5CiAgICAgIHdtLl9ucnBuQnVmZmVyW2NoYW5uZWxCdWZmZXJJbmRleF0gPSBbXTsKICAgIH0KICB9OwogIC8qKgogICAqIEBtZXRob2QgX3BhcnNlQ2hhbm5lbEV2ZW50CiAgICogQHBhcmFtIGUgRXZlbnQKICAgKiBAcHJvdGVjdGVkCiAgICovCgoKICBJbnB1dC5wcm90b3R5cGUuX3BhcnNlQ2hhbm5lbEV2ZW50ID0gZnVuY3Rpb24gKGUpIHsKICAgIHZhciBjb21tYW5kID0gZS5kYXRhWzBdID4+IDQ7CiAgICB2YXIgY2hhbm5lbCA9IChlLmRhdGFbMF0gJiAweGYpICsgMTsKICAgIHZhciBkYXRhMSwgZGF0YTI7CgogICAgaWYgKGUuZGF0YS5sZW5ndGggPiAxKSB7CiAgICAgIGRhdGExID0gZS5kYXRhWzFdOwogICAgICBkYXRhMiA9IGUuZGF0YS5sZW5ndGggPiAyID8gZS5kYXRhWzJdIDogdW5kZWZpbmVkOwogICAgfSAvLyBSZXR1cm5lZCBldmVudAoKCiAgICB2YXIgZXZlbnQgPSB7CiAgICAgIHRhcmdldDogdGhpcywKICAgICAgZGF0YTogZS5kYXRhLAogICAgICB0aW1lc3RhbXA6IGUudGltZVN0YW1wLAogICAgICBjaGFubmVsOiBjaGFubmVsCiAgICB9OwoKICAgIGlmIChjb21tYW5kID09PSB3bS5NSURJX0NIQU5ORUxfTUVTU0FHRVMubm90ZW9mZiB8fCBjb21tYW5kID09PSB3bS5NSURJX0NIQU5ORUxfTUVTU0FHRVMubm90ZW9uICYmIGRhdGEyID09PSAwKSB7CiAgICAgIC8qKgogICAgICAgKiBFdmVudCBlbWl0dGVkIHdoZW4gYSBub3RlIG9mZiBNSURJIG1lc3NhZ2UgaGFzIGJlZW4gcmVjZWl2ZWQgb24gYSBzcGVjaWZpYyBkZXZpY2UgYW5kCiAgICAgICAqIGNoYW5uZWwuCiAgICAgICAqCiAgICAgICAqIEBldmVudCBub3Rlb2ZmCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudAogICAgICAgKiBAcGFyYW0ge0lucHV0fSBldmVudC50YXJnZXQgVGhlIGBJbnB1dGAgdGhhdCB0cmlnZ2VyZWQgdGhlIGV2ZW50LgogICAgICAgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGV2ZW50LmRhdGEgVGhlIHJhdyBNSURJIG1lc3NhZ2UgYXMgYW4gYXJyYXkgb2YgOCBiaXQgdmFsdWVzLgogICAgICAgKiBAcGFyYW0ge051bWJlcn0gZXZlbnQudGltZXN0YW1wIFRoZSB0aW1lIHdoZW4gdGhlIGV2ZW50IG9jY3VycmVkIChpbiBtaWxsaXNlY29uZHMpCiAgICAgICAqIEBwYXJhbSB7dWludH0gZXZlbnQuY2hhbm5lbCBUaGUgY2hhbm5lbCB3aGVyZSB0aGUgZXZlbnQgb2NjdXJyZWQgKGJldHdlZW4gMSBhbmQgMTYpLgogICAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnQudHlwZSBUaGUgdHlwZSBvZiBldmVudCB0aGF0IG9jY3VycmVkLgogICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQubm90ZQogICAgICAgKiBAcGFyYW0ge3VpbnR9IGV2ZW50Lm5vdGUubnVtYmVyIFRoZSBNSURJIG5vdGUgbnVtYmVyLgogICAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnQubm90ZS5uYW1lIFRoZSB1c3VhbCBub3RlIG5hbWUgKEMsIEMjLCBELCBEIywgZXRjLikuCiAgICAgICAqIEBwYXJhbSB7dWludH0gZXZlbnQubm90ZS5vY3RhdmUgVGhlIG9jdGF2ZSAoYmV0d2VlbiAtMiBhbmQgOCkuCiAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSBldmVudC52ZWxvY2l0eSBUaGUgcmVsZWFzZSB2ZWxvY2l0eSAoYmV0d2VlbiAwIGFuZCAxKS4KICAgICAgICogQHBhcmFtIHtOdW1iZXJ9IGV2ZW50LnJhd1ZlbG9jaXR5IFRoZSBhdHRhY2sgdmVsb2NpdHkgZXhwcmVzc2VkIGFzIGEgNy1iaXQgaW50ZWdlciAoYmV0d2VlbgogICAgICAgKiAwIGFuZCAxMjcpLgogICAgICAgKi8KICAgICAgZXZlbnQudHlwZSA9ICJub3Rlb2ZmIjsKICAgICAgZXZlbnQubm90ZSA9IHsKICAgICAgICBudW1iZXI6IGRhdGExLAogICAgICAgIG5hbWU6IHdtLl9ub3Rlc1tkYXRhMSAlIDEyXSwKICAgICAgICBvY3RhdmU6IHdtLmdldE9jdGF2ZShkYXRhMSkKICAgICAgfTsKICAgICAgZXZlbnQudmVsb2NpdHkgPSBkYXRhMiAvIDEyNzsKICAgICAgZXZlbnQucmF3VmVsb2NpdHkgPSBkYXRhMjsKICAgIH0gZWxzZSBpZiAoY29tbWFuZCA9PT0gd20uTUlESV9DSEFOTkVMX01FU1NBR0VTLm5vdGVvbikgewogICAgICAvKioKICAgICAgICogRXZlbnQgZW1pdHRlZCB3aGVuIGEgbm90ZSBvbiBNSURJIG1lc3NhZ2UgaGFzIGJlZW4gcmVjZWl2ZWQgb24gYSBzcGVjaWZpYyBkZXZpY2UgYW5kCiAgICAgICAqIGNoYW5uZWwuCiAgICAgICAqCiAgICAgICAqIEBldmVudCBub3Rlb24KICAgICAgICoKICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50CiAgICAgICAqIEBwYXJhbSB7SW5wdXR9IGV2ZW50LnRhcmdldCBUaGUgYElucHV0YCB0aGF0IHRyaWdnZXJlZCB0aGUgZXZlbnQuCiAgICAgICAqIEBwYXJhbSB7VWludDhBcnJheX0gZXZlbnQuZGF0YSBUaGUgcmF3IE1JREkgbWVzc2FnZSBhcyBhbiBhcnJheSBvZiA4IGJpdCB2YWx1ZXMuCiAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSBldmVudC50aW1lc3RhbXAgVGhlIHRpbWUgd2hlbiB0aGUgZXZlbnQgb2NjdXJyZWQgKGluIG1pbGxpc2Vjb25kcykKICAgICAgICogQHBhcmFtIHt1aW50fSBldmVudC5jaGFubmVsIFRoZSBjaGFubmVsIHdoZXJlIHRoZSBldmVudCBvY2N1cnJlZCAoYmV0d2VlbiAxIGFuZCAxNikuCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudC50eXBlIFRoZSB0eXBlIG9mIGV2ZW50IHRoYXQgb2NjdXJyZWQuCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudC5ub3RlCiAgICAgICAqIEBwYXJhbSB7dWludH0gZXZlbnQubm90ZS5udW1iZXIgVGhlIE1JREkgbm90ZSBudW1iZXIuCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudC5ub3RlLm5hbWUgVGhlIHVzdWFsIG5vdGUgbmFtZSAoQywgQyMsIEQsIEQjLCBldGMuKS4KICAgICAgICogQHBhcmFtIHt1aW50fSBldmVudC5ub3RlLm9jdGF2ZSBUaGUgb2N0YXZlIChiZXR3ZWVuIC0yIGFuZCA4KS4KICAgICAgICogQHBhcmFtIHtOdW1iZXJ9IGV2ZW50LnZlbG9jaXR5IFRoZSBhdHRhY2sgdmVsb2NpdHkgKGJldHdlZW4gMCBhbmQgMSkuCiAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSBldmVudC5yYXdWZWxvY2l0eSBUaGUgYXR0YWNrIHZlbG9jaXR5IGV4cHJlc3NlZCBhcyBhIDctYml0IGludGVnZXIgKGJldHdlZW4KICAgICAgICogMCBhbmQgMTI3KS4KICAgICAgICovCiAgICAgIGV2ZW50LnR5cGUgPSAibm90ZW9uIjsKICAgICAgZXZlbnQubm90ZSA9IHsKICAgICAgICBudW1iZXI6IGRhdGExLAogICAgICAgIG5hbWU6IHdtLl9ub3Rlc1tkYXRhMSAlIDEyXSwKICAgICAgICBvY3RhdmU6IHdtLmdldE9jdGF2ZShkYXRhMSkKICAgICAgfTsKICAgICAgZXZlbnQudmVsb2NpdHkgPSBkYXRhMiAvIDEyNzsKICAgICAgZXZlbnQucmF3VmVsb2NpdHkgPSBkYXRhMjsKICAgIH0gZWxzZSBpZiAoY29tbWFuZCA9PT0gd20uTUlESV9DSEFOTkVMX01FU1NBR0VTLmtleWFmdGVydG91Y2gpIHsKICAgICAgLyoqCiAgICAgICAqIEV2ZW50IGVtaXR0ZWQgd2hlbiBhIGtleS1zcGVjaWZpYyBhZnRlcnRvdWNoIE1JREkgbWVzc2FnZSBoYXMgYmVlbiByZWNlaXZlZCBvbiBhIHNwZWNpZmljCiAgICAgICAqIGRldmljZSBhbmQgY2hhbm5lbC4KICAgICAgICoKICAgICAgICogQGV2ZW50IGtleWFmdGVydG91Y2gKICAgICAgICoKICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50CiAgICAgICAqIEBwYXJhbSB7SW5wdXR9IGV2ZW50LnRhcmdldCBUaGUgYElucHV0YCB0aGF0IHRyaWdnZXJlZCB0aGUgZXZlbnQuCiAgICAgICAqIEBwYXJhbSB7VWludDhBcnJheX0gZXZlbnQuZGF0YSBUaGUgcmF3IE1JREkgbWVzc2FnZSBhcyBhbiBhcnJheSBvZiA4IGJpdCB2YWx1ZXMuCiAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSBldmVudC50aW1lc3RhbXAgVGhlIHRpbWUgd2hlbiB0aGUgZXZlbnQgb2NjdXJyZWQgKGluIG1pbGxpc2Vjb25kcykKICAgICAgICogQHBhcmFtIHt1aW50fSBldmVudC5jaGFubmVsIFRoZSBjaGFubmVsIHdoZXJlIHRoZSBldmVudCBvY2N1cnJlZCAoYmV0d2VlbiAxIGFuZCAxNikuCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudC50eXBlIFRoZSB0eXBlIG9mIGV2ZW50IHRoYXQgb2NjdXJyZWQuCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudC5ub3RlCiAgICAgICAqIEBwYXJhbSB7dWludH0gZXZlbnQubm90ZS5udW1iZXIgVGhlIE1JREkgbm90ZSBudW1iZXIuCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudC5ub3RlLm5hbWUgVGhlIHVzdWFsIG5vdGUgbmFtZSAoQywgQyMsIEQsIEQjLCBldGMuKS4KICAgICAgICogQHBhcmFtIHt1aW50fSBldmVudC5ub3RlLm9jdGF2ZSBUaGUgb2N0YXZlIChiZXR3ZWVuIC0yIGFuZCA4KS4KICAgICAgICogQHBhcmFtIHtOdW1iZXJ9IGV2ZW50LnZhbHVlIFRoZSBhZnRlcnRvdWNoIGFtb3VudCAoYmV0d2VlbiAwIGFuZCAxKS4KICAgICAgICovCiAgICAgIGV2ZW50LnR5cGUgPSAia2V5YWZ0ZXJ0b3VjaCI7CiAgICAgIGV2ZW50Lm5vdGUgPSB7CiAgICAgICAgbnVtYmVyOiBkYXRhMSwKICAgICAgICBuYW1lOiB3bS5fbm90ZXNbZGF0YTEgJSAxMl0sCiAgICAgICAgb2N0YXZlOiB3bS5nZXRPY3RhdmUoZGF0YTEpCiAgICAgIH07CiAgICAgIGV2ZW50LnZhbHVlID0gZGF0YTIgLyAxMjc7CiAgICB9IGVsc2UgaWYgKGNvbW1hbmQgPT09IHdtLk1JRElfQ0hBTk5FTF9NRVNTQUdFUy5jb250cm9sY2hhbmdlICYmIGRhdGExID49IDAgJiYgZGF0YTEgPD0gMTE5KSB7CiAgICAgIC8qKgogICAgICAgKiBFdmVudCBlbWl0dGVkIHdoZW4gYSBjb250cm9sIGNoYW5nZSBNSURJIG1lc3NhZ2UgaGFzIGJlZW4gcmVjZWl2ZWQgb24gYSBzcGVjaWZpYyBkZXZpY2UgYW5kCiAgICAgICAqIGNoYW5uZWwuCiAgICAgICAqCiAgICAgICAqIEBldmVudCBjb250cm9sY2hhbmdlCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudAogICAgICAgKiBAcGFyYW0ge0lucHV0fSBldmVudC50YXJnZXQgVGhlIGBJbnB1dGAgdGhhdCB0cmlnZ2VyZWQgdGhlIGV2ZW50LgogICAgICAgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGV2ZW50LmRhdGEgVGhlIHJhdyBNSURJIG1lc3NhZ2UgYXMgYW4gYXJyYXkgb2YgOCBiaXQgdmFsdWVzLgogICAgICAgKiBAcGFyYW0ge051bWJlcn0gZXZlbnQudGltZXN0YW1wIFRoZSB0aW1lIHdoZW4gdGhlIGV2ZW50IG9jY3VycmVkIChpbiBtaWxsaXNlY29uZHMpCiAgICAgICAqIEBwYXJhbSB7dWludH0gZXZlbnQuY2hhbm5lbCBUaGUgY2hhbm5lbCB3aGVyZSB0aGUgZXZlbnQgb2NjdXJyZWQgKGJldHdlZW4gMSBhbmQgMTYpLgogICAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnQudHlwZSBUaGUgdHlwZSBvZiBldmVudCB0aGF0IG9jY3VycmVkLgogICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQuY29udHJvbGxlcgogICAgICAgKiBAcGFyYW0ge3VpbnR9IGV2ZW50LmNvbnRyb2xsZXIubnVtYmVyIFRoZSBudW1iZXIgb2YgdGhlIGNvbnRyb2xsZXIuCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudC5jb250cm9sbGVyLm5hbWUgVGhlIHVzdWFsIG5hbWUgb3IgZnVuY3Rpb24gb2YgdGhlIGNvbnRyb2xsZXIuCiAgICAgICAqIEBwYXJhbSB7dWludH0gZXZlbnQudmFsdWUgVGhlIHZhbHVlIHJlY2VpdmVkIChiZXR3ZWVuIDAgYW5kIDEyNykuCiAgICAgICAqLwogICAgICBldmVudC50eXBlID0gImNvbnRyb2xjaGFuZ2UiOwogICAgICBldmVudC5jb250cm9sbGVyID0gewogICAgICAgIG51bWJlcjogZGF0YTEsCiAgICAgICAgbmFtZTogdGhpcy5nZXRDY05hbWVCeU51bWJlcihkYXRhMSkKICAgICAgfTsKICAgICAgZXZlbnQudmFsdWUgPSBkYXRhMjsKICAgIH0gZWxzZSBpZiAoY29tbWFuZCA9PT0gd20uTUlESV9DSEFOTkVMX01FU1NBR0VTLmNoYW5uZWxtb2RlICYmIGRhdGExID49IDEyMCAmJiBkYXRhMSA8PSAxMjcpIHsKICAgICAgLyoqCiAgICAgICAqIEV2ZW50IGVtaXR0ZWQgd2hlbiBhIGNoYW5uZWwgbW9kZSBNSURJIG1lc3NhZ2UgaGFzIGJlZW4gcmVjZWl2ZWQgb24gYSBzcGVjaWZpYyBkZXZpY2UgYW5kCiAgICAgICAqIGNoYW5uZWwuCiAgICAgICAqCiAgICAgICAqIEBldmVudCBjaGFubmVsbW9kZQogICAgICAgKgogICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQKICAgICAgICogQHBhcmFtIHtJbnB1dH0gZXZlbnQudGFyZ2V0IFRoZSBgSW5wdXRgIHRoYXQgdHJpZ2dlcmVkIHRoZSBldmVudC4KICAgICAgICogQHBhcmFtIHtVaW50OEFycmF5fSBldmVudC5kYXRhIFRoZSByYXcgTUlESSBtZXNzYWdlIGFzIGFuIGFycmF5IG9mIDggYml0IHZhbHVlcy4KICAgICAgICogQHBhcmFtIHtOdW1iZXJ9IGV2ZW50LnRpbWVzdGFtcCBUaGUgdGltZSB3aGVuIHRoZSBldmVudCBvY2N1cnJlZCAoaW4gbWlsbGlzZWNvbmRzKQogICAgICAgKiBAcGFyYW0ge3VpbnR9IGV2ZW50LmNoYW5uZWwgVGhlIGNoYW5uZWwgd2hlcmUgdGhlIGV2ZW50IG9jY3VycmVkIChiZXR3ZWVuIDEgYW5kIDE2KS4KICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50LnR5cGUgVGhlIHR5cGUgb2YgZXZlbnQgdGhhdCBvY2N1cnJlZC4KICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50LmNvbnRyb2xsZXIKICAgICAgICogQHBhcmFtIHt1aW50fSBldmVudC5jb250cm9sbGVyLm51bWJlciBUaGUgbnVtYmVyIG9mIHRoZSBjb250cm9sbGVyLgogICAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnQuY29udHJvbGxlci5uYW1lIFRoZSB1c3VhbCBuYW1lIG9yIGZ1bmN0aW9uIG9mIHRoZSBjb250cm9sbGVyLgogICAgICAgKiBAcGFyYW0ge3VpbnR9IGV2ZW50LnZhbHVlIFRoZSB2YWx1ZSByZWNlaXZlZCAoYmV0d2VlbiAwIGFuZCAxMjcpLgogICAgICAgKi8KICAgICAgZXZlbnQudHlwZSA9ICJjaGFubmVsbW9kZSI7CiAgICAgIGV2ZW50LmNvbnRyb2xsZXIgPSB7CiAgICAgICAgbnVtYmVyOiBkYXRhMSwKICAgICAgICBuYW1lOiB0aGlzLmdldENoYW5uZWxNb2RlQnlOdW1iZXIoZGF0YTEpCiAgICAgIH07CiAgICAgIGV2ZW50LnZhbHVlID0gZGF0YTI7CiAgICB9IGVsc2UgaWYgKGNvbW1hbmQgPT09IHdtLk1JRElfQ0hBTk5FTF9NRVNTQUdFUy5wcm9ncmFtY2hhbmdlKSB7CiAgICAgIC8qKgogICAgICAgKiBFdmVudCBlbWl0dGVkIHdoZW4gYSBwcm9ncmFtIGNoYW5nZSBNSURJIG1lc3NhZ2UgaGFzIGJlZW4gcmVjZWl2ZWQgb24gYSBzcGVjaWZpYyBkZXZpY2UgYW5kCiAgICAgICAqIGNoYW5uZWwuCiAgICAgICAqCiAgICAgICAqIEBldmVudCBwcm9ncmFtY2hhbmdlCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudAogICAgICAgKiBAcGFyYW0ge0lucHV0fSBldmVudC50YXJnZXQgVGhlIGBJbnB1dGAgdGhhdCB0cmlnZ2VyZWQgdGhlIGV2ZW50LgogICAgICAgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGV2ZW50LmRhdGEgVGhlIHJhdyBNSURJIG1lc3NhZ2UgYXMgYW4gYXJyYXkgb2YgOCBiaXQgdmFsdWVzLgogICAgICAgKiBAcGFyYW0ge051bWJlcn0gZXZlbnQudGltZXN0YW1wIFRoZSB0aW1lIHdoZW4gdGhlIGV2ZW50IG9jY3VycmVkIChpbiBtaWxsaXNlY29uZHMpCiAgICAgICAqIEBwYXJhbSB7dWludH0gZXZlbnQuY2hhbm5lbCBUaGUgY2hhbm5lbCB3aGVyZSB0aGUgZXZlbnQgb2NjdXJyZWQgKGJldHdlZW4gMSBhbmQgMTYpLgogICAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnQudHlwZSBUaGUgdHlwZSBvZiBldmVudCB0aGF0IG9jY3VycmVkLgogICAgICAgKiBAcGFyYW0ge3VpbnR9IGV2ZW50LnZhbHVlIFRoZSB2YWx1ZSByZWNlaXZlZCAoYmV0d2VlbiAwIGFuZCAxMjcpLgogICAgICAgKi8KICAgICAgZXZlbnQudHlwZSA9ICJwcm9ncmFtY2hhbmdlIjsKICAgICAgZXZlbnQudmFsdWUgPSBkYXRhMTsKICAgIH0gZWxzZSBpZiAoY29tbWFuZCA9PT0gd20uTUlESV9DSEFOTkVMX01FU1NBR0VTLmNoYW5uZWxhZnRlcnRvdWNoKSB7CiAgICAgIC8qKgogICAgICAgKiBFdmVudCBlbWl0dGVkIHdoZW4gYSBjaGFubmVsLXdpZGUgYWZ0ZXJ0b3VjaCBNSURJIG1lc3NhZ2UgaGFzIGJlZW4gcmVjZWl2ZWQgb24gYSBzcGVjaWZpYwogICAgICAgKiBkZXZpY2UgYW5kIGNoYW5uZWwuCiAgICAgICAqCiAgICAgICAqIEBldmVudCBjaGFubmVsYWZ0ZXJ0b3VjaAogICAgICAgKgogICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQKICAgICAgICogQHBhcmFtIHtJbnB1dH0gZXZlbnQudGFyZ2V0IFRoZSBgSW5wdXRgIHRoYXQgdHJpZ2dlcmVkIHRoZSBldmVudC4KICAgICAgICogQHBhcmFtIHtVaW50OEFycmF5fSBldmVudC5kYXRhIFRoZSByYXcgTUlESSBtZXNzYWdlIGFzIGFuIGFycmF5IG9mIDggYml0IHZhbHVlcy4KICAgICAgICogQHBhcmFtIHtOdW1iZXJ9IGV2ZW50LnRpbWVzdGFtcCBUaGUgdGltZSB3aGVuIHRoZSBldmVudCBvY2N1cnJlZCAoaW4gbWlsbGlzZWNvbmRzKQogICAgICAgKiBAcGFyYW0ge3VpbnR9IGV2ZW50LmNoYW5uZWwgVGhlIGNoYW5uZWwgd2hlcmUgdGhlIGV2ZW50IG9jY3VycmVkIChiZXR3ZWVuIDEgYW5kIDE2KS4KICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50LnR5cGUgVGhlIHR5cGUgb2YgZXZlbnQgdGhhdCBvY2N1cnJlZC4KICAgICAgICogQHBhcmFtIHtOdW1iZXJ9IGV2ZW50LnZhbHVlIFRoZSBhZnRlcnRvdWNoIHZhbHVlIHJlY2VpdmVkIChiZXR3ZWVuIDAgYW5kIDEpLgogICAgICAgKi8KICAgICAgZXZlbnQudHlwZSA9ICJjaGFubmVsYWZ0ZXJ0b3VjaCI7CiAgICAgIGV2ZW50LnZhbHVlID0gZGF0YTEgLyAxMjc7CiAgICB9IGVsc2UgaWYgKGNvbW1hbmQgPT09IHdtLk1JRElfQ0hBTk5FTF9NRVNTQUdFUy5waXRjaGJlbmQpIHsKICAgICAgLyoqCiAgICAgICAqIEV2ZW50IGVtaXR0ZWQgd2hlbiBhIHBpdGNoIGJlbmQgTUlESSBtZXNzYWdlIGhhcyBiZWVuIHJlY2VpdmVkIG9uIGEgc3BlY2lmaWMgZGV2aWNlIGFuZAogICAgICAgKiBjaGFubmVsLgogICAgICAgKgogICAgICAgKiBAZXZlbnQgcGl0Y2hiZW5kCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudAogICAgICAgKiBAcGFyYW0ge0lucHV0fSBldmVudC50YXJnZXQgVGhlIGBJbnB1dGAgdGhhdCB0cmlnZ2VyZWQgdGhlIGV2ZW50LgogICAgICAgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGV2ZW50LmRhdGEgVGhlIHJhdyBNSURJIG1lc3NhZ2UgYXMgYW4gYXJyYXkgb2YgOCBiaXQgdmFsdWVzLgogICAgICAgKiBAcGFyYW0ge051bWJlcn0gZXZlbnQudGltZXN0YW1wIFRoZSB0aW1lIHdoZW4gdGhlIGV2ZW50IG9jY3VycmVkIChpbiBtaWxsaXNlY29uZHMpCiAgICAgICAqIEBwYXJhbSB7dWludH0gZXZlbnQuY2hhbm5lbCBUaGUgY2hhbm5lbCB3aGVyZSB0aGUgZXZlbnQgb2NjdXJyZWQgKGJldHdlZW4gMSBhbmQgMTYpLgogICAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnQudHlwZSBUaGUgdHlwZSBvZiBldmVudCB0aGF0IG9jY3VycmVkLgogICAgICAgKiBAcGFyYW0ge051bWJlcn0gZXZlbnQudmFsdWUgVGhlIHBpdGNoIGJlbmQgdmFsdWUgcmVjZWl2ZWQgKGJldHdlZW4gLTEgYW5kIDEpLgogICAgICAgKi8KICAgICAgZXZlbnQudHlwZSA9ICJwaXRjaGJlbmQiOwogICAgICBldmVudC52YWx1ZSA9ICgoZGF0YTIgPDwgNykgKyBkYXRhMSAtIDgxOTIpIC8gODE5MjsKICAgIH0gZWxzZSB7CiAgICAgIGV2ZW50LnR5cGUgPSAidW5rbm93bmNoYW5uZWxtZXNzYWdlIjsKICAgIH0gLy8gSWYgc29tZSBjYWxsYmFja3MgaGF2ZSBiZWVuIGRlZmluZWQgZm9yIHRoaXMgZXZlbnQsIG9uIHRoYXQgZGV2aWNlIGFuZCBjaGFubmVsLCBleGVjdXRlIHRoZW0uCgoKICAgIGlmICh0aGlzLl91c2VySGFuZGxlcnMuY2hhbm5lbFtldmVudC50eXBlXSAmJiB0aGlzLl91c2VySGFuZGxlcnMuY2hhbm5lbFtldmVudC50eXBlXVtjaGFubmVsXSkgewogICAgICB0aGlzLl91c2VySGFuZGxlcnMuY2hhbm5lbFtldmVudC50eXBlXVtjaGFubmVsXS5mb3JFYWNoKGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgIGNhbGxiYWNrKGV2ZW50KTsKICAgICAgfSk7CiAgICB9CiAgfTsKICAvKioKICAgKiBSZXR1cm5zIHRoZSBuYW1lIG9mIGEgY29udHJvbCBjaGFuZ2UgbWVzc2FnZSBtYXRjaGluZyB0aGUgc3BlY2lmaWVkIG51bWJlci4gSWYgbm8gbWF0Y2ggaXMKICAgKiBmb3VuZCwgdGhlIGZ1bmN0aW9uIHJldHVybnMgYHVuZGVmaW5lZGAuCiAgICoKICAgKiBAbWV0aG9kIGdldENjTmFtZUJ5TnVtYmVyCiAgICoKICAgKiBAcGFyYW0gbnVtYmVyIHtOdW1iZXJ9IFRoZSBudW1iZXIgb2YgdGhlIGNvbnRyb2wgY2hhbmdlIG1lc3NhZ2UuCiAgICogQHJldHVybnMge1N0cmluZ3x1bmRlZmluZWR9IFRoZSBtYXRjaGluZyBjb250cm9sIGNoYW5nZSBuYW1lIG9yIGB1bmRlZmluZWRgLgogICAqCiAgICogQHRocm93cyBSYW5nZUVycm9yIFRoZSBjb250cm9sIGNoYW5nZSBudW1iZXIgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDExOS4KICAgKgogICAqIEBzaW5jZSAyLjAuMAogICAqLwoKCiAgSW5wdXQucHJvdG90eXBlLmdldENjTmFtZUJ5TnVtYmVyID0gZnVuY3Rpb24gKG51bWJlcikgewogICAgbnVtYmVyID0gTWF0aC5mbG9vcihudW1iZXIpOwoKICAgIGlmICghKG51bWJlciA+PSAwICYmIG51bWJlciA8PSAxMTkpKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJUaGUgY29udHJvbCBjaGFuZ2UgbnVtYmVyIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxMTkuIik7CiAgICB9CgogICAgZm9yICh2YXIgY2MgaW4gd20uTUlESV9DT05UUk9MX0NIQU5HRV9NRVNTQUdFUykgewogICAgICBpZiAod20uTUlESV9DT05UUk9MX0NIQU5HRV9NRVNTQUdFUy5oYXNPd25Qcm9wZXJ0eShjYykgJiYgbnVtYmVyID09PSB3bS5NSURJX0NPTlRST0xfQ0hBTkdFX01FU1NBR0VTW2NjXSkgewogICAgICAgIHJldHVybiBjYzsKICAgICAgfQogICAgfQoKICAgIHJldHVybiB1bmRlZmluZWQ7CiAgfTsKICAvKioKICAgKiBSZXR1cm5zIHRoZSBjaGFubmVsIG1vZGUgbmFtZSBtYXRjaGluZyB0aGUgc3BlY2lmaWVkIG51bWJlci4gSWYgbm8gbWF0Y2ggaXMgZm91bmQsIHRoZSBmdW5jdGlvbgogICAqIHJldHVybnMgYHVuZGVmaW5lZGAuCiAgICoKICAgKiBAbWV0aG9kIGdldENoYW5uZWxNb2RlQnlOdW1iZXIKICAgKgogICAqIEBwYXJhbSBudW1iZXIge051bWJlcn0gVGhlIG51bWJlciBvZiB0aGUgY2hhbm5lbCBtb2RlIG1lc3NhZ2UuCiAgICogQHJldHVybnMge1N0cmluZ3x1bmRlZmluZWR9IFRoZSBtYXRjaGluZyBjaGFubmVsIG1vZGUgbWVzc2FnZSJzIG5hbWUgb3IgYHVuZGVmaW5lZGA7CiAgICoKICAgKiBAdGhyb3dzIFJhbmdlRXJyb3IgVGhlIGNoYW5uZWwgbW9kZSBudW1iZXIgbXVzdCBiZSBiZXR3ZWVuIDEyMCBhbmQgMTI3LgogICAqCiAgICogQHNpbmNlIDIuMC4wCiAgICovCgoKICBJbnB1dC5wcm90b3R5cGUuZ2V0Q2hhbm5lbE1vZGVCeU51bWJlciA9IGZ1bmN0aW9uIChudW1iZXIpIHsKICAgIG51bWJlciA9IE1hdGguZmxvb3IobnVtYmVyKTsKCiAgICBpZiAoIShudW1iZXIgPj0gMTIwICYmIHN0YXR1cyA8PSAxMjcpKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJUaGUgY29udHJvbCBjaGFuZ2UgbnVtYmVyIG11c3QgYmUgYmV0d2VlbiAxMjAgYW5kIDEyNy4iKTsKICAgIH0KCiAgICBmb3IgKHZhciBjbSBpbiB3bS5NSURJX0NIQU5ORUxfTU9ERV9NRVNTQUdFUykgewogICAgICBpZiAod20uTUlESV9DSEFOTkVMX01PREVfTUVTU0FHRVMuaGFzT3duUHJvcGVydHkoY20pICYmIG51bWJlciA9PT0gd20uTUlESV9DSEFOTkVMX01PREVfTUVTU0FHRVNbY21dKSB7CiAgICAgICAgcmV0dXJuIGNtOwogICAgICB9CiAgICB9CiAgfTsKICAvKioKICAgKiBAbWV0aG9kIF9wYXJzZVN5c3RlbUV2ZW50CiAgICogQHByb3RlY3RlZAogICAqLwoKCiAgSW5wdXQucHJvdG90eXBlLl9wYXJzZVN5c3RlbUV2ZW50ID0gZnVuY3Rpb24gKGUpIHsKICAgIHZhciBjb21tYW5kID0gZS5kYXRhWzBdOyAvLyBSZXR1cm5lZCBldmVudAoKICAgIHZhciBldmVudCA9IHsKICAgICAgdGFyZ2V0OiB0aGlzLAogICAgICBkYXRhOiBlLmRhdGEsCiAgICAgIHRpbWVzdGFtcDogZS50aW1lU3RhbXAKICAgIH07CgogICAgaWYgKGNvbW1hbmQgPT09IHdtLk1JRElfU1lTVEVNX01FU1NBR0VTLnN5c2V4KSB7CiAgICAgIC8qKgogICAgICAgKiBFdmVudCBlbWl0dGVkIHdoZW4gYSBzeXN0ZW0gZXhjbHVzaXZlIE1JREkgbWVzc2FnZSBoYXMgYmVlbiByZWNlaXZlZC4gWW91IHNob3VsZCBub3RlIHRoYXQsCiAgICAgICAqIHRvIHJlY2VpdmUgYHN5c2V4YCBldmVudHMsIHlvdSBtdXN0IGNhbGwgdGhlIGBXZWJNaWRpLmVuYWJsZSgpYCBtZXRob2Qgd2l0aCBhIHNlY29uZAogICAgICAgKiBwYXJhbWV0ZXIgc2V0IHRvIGB0cnVlYDoKICAgICAgICoKICAgICAgICogICAgIFdlYk1pZGkuZW5hYmxlKGZ1bmN0aW9uKGVycikgewogICAgICAgKgogICAgICAgKiAgICAgICAgaWYgKGVycikgewogICAgICAgKiAgICAgICAgICBjb25zb2xlLmxvZygiV2ViTWlkaSBjb3VsZCBub3QgYmUgZW5hYmxlZC4iKTsKICAgICAgICogICAgICAgIH0KICAgICAgICoKICAgICAgICogICAgICAgIHZhciBpbnB1dCA9IFdlYk1pZGkuaW5wdXRzWzBdOwogICAgICAgKgogICAgICAgKiAgICAgICAgaW5wdXQuYWRkTGlzdGVuZXIoInN5c2V4IiwgImFsbCIsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAqICAgICAgICAgIGNvbnNvbGUubG9nKGUpOwogICAgICAgKiAgICAgICAgfSk7CiAgICAgICAqCiAgICAgICAqICAgICB9LCB0cnVlKTsKICAgICAgICoKICAgICAgICogQGV2ZW50IHN5c2V4CiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudAogICAgICAgKiBAcGFyYW0ge0lucHV0fSBldmVudC50YXJnZXQgVGhlIGBJbnB1dGAgdGhhdCB0cmlnZ2VyZWQgdGhlIGV2ZW50LgogICAgICAgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGV2ZW50LmRhdGEgVGhlIHJhdyBNSURJIG1lc3NhZ2UgYXMgYW4gYXJyYXkgb2YgOCBiaXQgdmFsdWVzLgogICAgICAgKiBAcGFyYW0ge051bWJlcn0gZXZlbnQudGltZXN0YW1wIFRoZSB0aW1lIHdoZW4gdGhlIGV2ZW50IG9jY3VycmVkIChpbiBtaWxsaXNlY29uZHMpCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudC50eXBlIFRoZSB0eXBlIG9mIGV2ZW50IHRoYXQgb2NjdXJyZWQuCiAgICAgICAqCiAgICAgICAqLwogICAgICBldmVudC50eXBlID0gInN5c2V4IjsKICAgIH0gZWxzZSBpZiAoY29tbWFuZCA9PT0gd20uTUlESV9TWVNURU1fTUVTU0FHRVMudGltZWNvZGUpIHsKICAgICAgLyoqCiAgICAgICAqIEV2ZW50IGVtaXR0ZWQgd2hlbiBhIHN5c3RlbSBNSURJIHRpbWUgY29kZSBxdWFydGVyIGZyYW1lIG1lc3NhZ2UgaGFzIGJlZW4gcmVjZWl2ZWQuCiAgICAgICAqCiAgICAgICAqIEBldmVudCB0aW1lY29kZQogICAgICAgKgogICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQKICAgICAgICogQHBhcmFtIHtJbnB1dH0gZXZlbnQudGFyZ2V0IFRoZSBgSW5wdXRgIHRoYXQgdHJpZ2dlcmVkIHRoZSBldmVudC4KICAgICAgICogQHBhcmFtIHtVaW50OEFycmF5fSBldmVudC5kYXRhIFRoZSByYXcgTUlESSBtZXNzYWdlIGFzIGFuIGFycmF5IG9mIDggYml0IHZhbHVlcy4KICAgICAgICogQHBhcmFtIHtOdW1iZXJ9IGV2ZW50LnRpbWVzdGFtcCBUaGUgdGltZSB3aGVuIHRoZSBldmVudCBvY2N1cnJlZCAoaW4gbWlsbGlzZWNvbmRzKQogICAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnQudHlwZSBUaGUgdHlwZSBvZiBldmVudCB0aGF0IG9jY3VycmVkLgogICAgICAgKi8KICAgICAgZXZlbnQudHlwZSA9ICJ0aW1lY29kZSI7CiAgICB9IGVsc2UgaWYgKGNvbW1hbmQgPT09IHdtLk1JRElfU1lTVEVNX01FU1NBR0VTLnNvbmdwb3NpdGlvbikgewogICAgICAvKioKICAgICAgICogRXZlbnQgZW1pdHRlZCB3aGVuIGEgc3lzdGVtIHNvbmcgcG9zaXRpb24gcG9pbnRlciBNSURJIG1lc3NhZ2UgaGFzIGJlZW4gcmVjZWl2ZWQuCiAgICAgICAqCiAgICAgICAqIEBldmVudCBzb25ncG9zaXRpb24KICAgICAgICoKICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50CiAgICAgICAqIEBwYXJhbSB7SW5wdXR9IGV2ZW50LnRhcmdldCBUaGUgYElucHV0YCB0aGF0IHRyaWdnZXJlZCB0aGUgZXZlbnQuCiAgICAgICAqIEBwYXJhbSB7VWludDhBcnJheX0gZXZlbnQuZGF0YSBUaGUgcmF3IE1JREkgbWVzc2FnZSBhcyBhbiBhcnJheSBvZiA4IGJpdCB2YWx1ZXMuCiAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSBldmVudC50aW1lc3RhbXAgVGhlIHRpbWUgd2hlbiB0aGUgZXZlbnQgb2NjdXJyZWQgKGluIG1pbGxpc2Vjb25kcykKICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50LnR5cGUgVGhlIHR5cGUgb2YgZXZlbnQgdGhhdCBvY2N1cnJlZC4KICAgICAgICovCiAgICAgIGV2ZW50LnR5cGUgPSAic29uZ3Bvc2l0aW9uIjsKICAgIH0gZWxzZSBpZiAoY29tbWFuZCA9PT0gd20uTUlESV9TWVNURU1fTUVTU0FHRVMuc29uZ3NlbGVjdCkgewogICAgICAvKioKICAgICAgICogRXZlbnQgZW1pdHRlZCB3aGVuIGEgc3lzdGVtIHNvbmcgc2VsZWN0IE1JREkgbWVzc2FnZSBoYXMgYmVlbiByZWNlaXZlZC4KICAgICAgICoKICAgICAgICogQGV2ZW50IHNvbmdzZWxlY3QKICAgICAgICoKICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50CiAgICAgICAqIEBwYXJhbSB7SW5wdXR9IGV2ZW50LnRhcmdldCBUaGUgYElucHV0YCB0aGF0IHRyaWdnZXJlZCB0aGUgZXZlbnQuCiAgICAgICAqIEBwYXJhbSB7VWludDhBcnJheX0gZXZlbnQuZGF0YSBUaGUgcmF3IE1JREkgbWVzc2FnZSBhcyBhbiBhcnJheSBvZiA4IGJpdCB2YWx1ZXMuCiAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSBldmVudC50aW1lc3RhbXAgVGhlIHRpbWUgd2hlbiB0aGUgZXZlbnQgb2NjdXJyZWQgKGluIG1pbGxpc2Vjb25kcykKICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50LnR5cGUgVGhlIHR5cGUgb2YgZXZlbnQgdGhhdCBvY2N1cnJlZC4KICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50LnNvbmcgU29uZyAob3Igc2VxdWVuY2UpIG51bWJlciB0byBzZWxlY3QuCiAgICAgICAqLwogICAgICBldmVudC50eXBlID0gInNvbmdzZWxlY3QiOwogICAgICBldmVudC5zb25nID0gZS5kYXRhWzFdOwogICAgfSBlbHNlIGlmIChjb21tYW5kID09PSB3bS5NSURJX1NZU1RFTV9NRVNTQUdFUy50dW5pbmdyZXF1ZXN0KSB7CiAgICAgIC8qKgogICAgICAgKiBFdmVudCBlbWl0dGVkIHdoZW4gYSBzeXN0ZW0gdHVuZSByZXF1ZXN0IE1JREkgbWVzc2FnZSBoYXMgYmVlbiByZWNlaXZlZC4KICAgICAgICoKICAgICAgICogQGV2ZW50IHR1bmluZ3JlcXVlc3QKICAgICAgICoKICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50CiAgICAgICAqIEBwYXJhbSB7SW5wdXR9IGV2ZW50LnRhcmdldCBUaGUgYElucHV0YCB0aGF0IHRyaWdnZXJlZCB0aGUgZXZlbnQuCiAgICAgICAqIEBwYXJhbSB7VWludDhBcnJheX0gZXZlbnQuZGF0YSAgICAgVGhlIHJhdyBNSURJIG1lc3NhZ2UgYXMgYW4gYXJyYXkgb2YgOCBiaXQKICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMuCiAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSBldmVudC50aW1lc3RhbXAgVGhlIHRpbWUgd2hlbiB0aGUgZXZlbnQgb2NjdXJyZWQgKGluIG1pbGxpc2Vjb25kcykKICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50LnR5cGUgICAgICAgICBUaGUgdHlwZSBvZiBldmVudCB0aGF0IG9jY3VycmVkLgogICAgICAgKi8KICAgICAgZXZlbnQudHlwZSA9ICJ0dW5pbmdyZXF1ZXN0IjsKICAgIH0gZWxzZSBpZiAoY29tbWFuZCA9PT0gd20uTUlESV9TWVNURU1fTUVTU0FHRVMuY2xvY2spIHsKICAgICAgLyoqCiAgICAgICAqIEV2ZW50IGVtaXR0ZWQgd2hlbiBhIHN5c3RlbSB0aW1pbmcgY2xvY2sgTUlESSBtZXNzYWdlIGhhcyBiZWVuIHJlY2VpdmVkLgogICAgICAgKgogICAgICAgKiBAZXZlbnQgY2xvY2sKICAgICAgICoKICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50CiAgICAgICAqIEBwYXJhbSB7SW5wdXR9IGV2ZW50LnRhcmdldCBUaGUgYElucHV0YCB0aGF0IHRyaWdnZXJlZCB0aGUgZXZlbnQuCiAgICAgICAqIEBwYXJhbSB7VWludDhBcnJheX0gZXZlbnQuZGF0YSAgICAgVGhlIHJhdyBNSURJIG1lc3NhZ2UgYXMgYW4gYXJyYXkgb2YgOCBiaXQKICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMuCiAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSBldmVudC50aW1lc3RhbXAgVGhlIHRpbWUgd2hlbiB0aGUgZXZlbnQgb2NjdXJyZWQgKGluIG1pbGxpc2Vjb25kcykKICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50LnR5cGUgICAgICAgICBUaGUgdHlwZSBvZiBldmVudCB0aGF0IG9jY3VycmVkLgogICAgICAgKi8KICAgICAgZXZlbnQudHlwZSA9ICJjbG9jayI7CiAgICB9IGVsc2UgaWYgKGNvbW1hbmQgPT09IHdtLk1JRElfU1lTVEVNX01FU1NBR0VTLnN0YXJ0KSB7CiAgICAgIC8qKgogICAgICAgKiBFdmVudCBlbWl0dGVkIHdoZW4gYSBzeXN0ZW0gc3RhcnQgTUlESSBtZXNzYWdlIGhhcyBiZWVuIHJlY2VpdmVkLgogICAgICAgKgogICAgICAgKiBAZXZlbnQgc3RhcnQKICAgICAgICoKICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50CiAgICAgICAqIEBwYXJhbSB7SW5wdXR9IGV2ZW50LnRhcmdldCBUaGUgYElucHV0YCB0aGF0IHRyaWdnZXJlZCB0aGUgZXZlbnQuCiAgICAgICAqIEBwYXJhbSB7VWludDhBcnJheX0gZXZlbnQuZGF0YSAgICAgVGhlIHJhdyBNSURJIG1lc3NhZ2UgYXMgYW4gYXJyYXkgb2YgOCBiaXQKICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMuCiAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSBldmVudC50aW1lc3RhbXAgVGhlIHRpbWUgd2hlbiB0aGUgZXZlbnQgb2NjdXJyZWQgKGluIG1pbGxpc2Vjb25kcykKICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50LnR5cGUgICAgICAgICBUaGUgdHlwZSBvZiBldmVudCB0aGF0IG9jY3VycmVkLgogICAgICAgKi8KICAgICAgZXZlbnQudHlwZSA9ICJzdGFydCI7CiAgICB9IGVsc2UgaWYgKGNvbW1hbmQgPT09IHdtLk1JRElfU1lTVEVNX01FU1NBR0VTWyJjb250aW51ZSJdKSB7CiAgICAgIC8qKgogICAgICAgKiBFdmVudCBlbWl0dGVkIHdoZW4gYSBzeXN0ZW0gY29udGludWUgTUlESSBtZXNzYWdlIGhhcyBiZWVuIHJlY2VpdmVkLgogICAgICAgKgogICAgICAgKiBAZXZlbnQgY29udGludWUKICAgICAgICoKICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50CiAgICAgICAqIEBwYXJhbSB7SW5wdXR9IGV2ZW50LnRhcmdldCBUaGUgYElucHV0YCB0aGF0IHRyaWdnZXJlZCB0aGUgZXZlbnQuCiAgICAgICAqIEBwYXJhbSB7VWludDhBcnJheX0gZXZlbnQuZGF0YSAgICAgVGhlIHJhdyBNSURJIG1lc3NhZ2UgYXMgYW4gYXJyYXkgb2YgOCBiaXQKICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMuCiAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSBldmVudC50aW1lc3RhbXAgVGhlIHRpbWUgd2hlbiB0aGUgZXZlbnQgb2NjdXJyZWQgKGluIG1pbGxpc2Vjb25kcykKICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50LnR5cGUgICAgICAgICBUaGUgdHlwZSBvZiBldmVudCB0aGF0IG9jY3VycmVkLgogICAgICAgKi8KICAgICAgZXZlbnQudHlwZSA9ICJjb250aW51ZSI7CiAgICB9IGVsc2UgaWYgKGNvbW1hbmQgPT09IHdtLk1JRElfU1lTVEVNX01FU1NBR0VTLnN0b3ApIHsKICAgICAgLyoqCiAgICAgICAqIEV2ZW50IGVtaXR0ZWQgd2hlbiBhIHN5c3RlbSBzdG9wIE1JREkgbWVzc2FnZSBoYXMgYmVlbiByZWNlaXZlZC4KICAgICAgICoKICAgICAgICogQGV2ZW50IHN0b3AKICAgICAgICoKICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50CiAgICAgICAqIEBwYXJhbSB7SW5wdXR9IGV2ZW50LnRhcmdldCBUaGUgYElucHV0YCB0aGF0IHRyaWdnZXJlZCB0aGUgZXZlbnQuCiAgICAgICAqIEBwYXJhbSB7VWludDhBcnJheX0gZXZlbnQuZGF0YSAgICAgVGhlIHJhdyBNSURJIG1lc3NhZ2UgYXMgYW4gYXJyYXkgb2YgOCBiaXQKICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMuCiAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSBldmVudC50aW1lc3RhbXAgVGhlIHRpbWUgd2hlbiB0aGUgZXZlbnQgb2NjdXJyZWQgKGluIG1pbGxpc2Vjb25kcykKICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50LnR5cGUgICAgICAgICBUaGUgdHlwZSBvZiBldmVudCB0aGF0IG9jY3VycmVkLgogICAgICAgKi8KICAgICAgZXZlbnQudHlwZSA9ICJzdG9wIjsKICAgIH0gZWxzZSBpZiAoY29tbWFuZCA9PT0gd20uTUlESV9TWVNURU1fTUVTU0FHRVMuYWN0aXZlc2Vuc2luZykgewogICAgICAvKioKICAgICAgICogRXZlbnQgZW1pdHRlZCB3aGVuIGEgc3lzdGVtIGFjdGl2ZSBzZW5zaW5nIE1JREkgbWVzc2FnZSBoYXMgYmVlbiByZWNlaXZlZC4KICAgICAgICoKICAgICAgICogQGV2ZW50IGFjdGl2ZXNlbnNpbmcKICAgICAgICoKICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50CiAgICAgICAqIEBwYXJhbSB7SW5wdXR9IGV2ZW50LnRhcmdldCBUaGUgYElucHV0YCB0aGF0IHRyaWdnZXJlZCB0aGUgZXZlbnQuCiAgICAgICAqIEBwYXJhbSB7VWludDhBcnJheX0gZXZlbnQuZGF0YSAgICAgVGhlIHJhdyBNSURJIG1lc3NhZ2UgYXMgYW4gYXJyYXkgb2YgOCBiaXQgdmFsdWVzLgogICAgICAgKiBAcGFyYW0ge051bWJlcn0gZXZlbnQudGltZXN0YW1wIFRoZSB0aW1lIHdoZW4gdGhlIGV2ZW50IG9jY3VycmVkIChpbiBtaWxsaXNlY29uZHMpCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudC50eXBlICAgICAgICAgVGhlIHR5cGUgb2YgZXZlbnQgdGhhdCBvY2N1cnJlZC4KICAgICAgICovCiAgICAgIGV2ZW50LnR5cGUgPSAiYWN0aXZlc2Vuc2luZyI7CiAgICB9IGVsc2UgaWYgKGNvbW1hbmQgPT09IHdtLk1JRElfU1lTVEVNX01FU1NBR0VTLnJlc2V0KSB7CiAgICAgIC8qKgogICAgICAgKiBFdmVudCBlbWl0dGVkIHdoZW4gYSBzeXN0ZW0gcmVzZXQgTUlESSBtZXNzYWdlIGhhcyBiZWVuIHJlY2VpdmVkLgogICAgICAgKgogICAgICAgKiBAZXZlbnQgcmVzZXQKICAgICAgICoKICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50CiAgICAgICAqIEBwYXJhbSB7SW5wdXR9IGV2ZW50LnRhcmdldCBUaGUgYElucHV0YCB0aGF0IHRyaWdnZXJlZCB0aGUgZXZlbnQuCiAgICAgICAqIEBwYXJhbSB7VWludDhBcnJheX0gZXZlbnQuZGF0YSAgICAgVGhlIHJhdyBNSURJIG1lc3NhZ2UgYXMgYW4gYXJyYXkgb2YgOCBiaXQgdmFsdWVzLgogICAgICAgKiBAcGFyYW0ge051bWJlcn0gZXZlbnQudGltZXN0YW1wIFRoZSB0aW1lIHdoZW4gdGhlIGV2ZW50IG9jY3VycmVkIChpbiBtaWxsaXNlY29uZHMpCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudC50eXBlICAgICAgICAgVGhlIHR5cGUgb2YgZXZlbnQgdGhhdCBvY2N1cnJlZC4KICAgICAgICovCiAgICAgIGV2ZW50LnR5cGUgPSAicmVzZXQiOwogICAgfSBlbHNlIHsKICAgICAgLyoqCiAgICAgICAqIEV2ZW50IGVtaXR0ZWQgd2hlbiBhbiB1bmtub3duIHN5c3RlbSBNSURJIG1lc3NhZ2UgaGFzIGJlZW4gcmVjZWl2ZWQuIEl0IGNvdWxkIGJlLCBmb3IKICAgICAgICogZXhhbXBsZSwgb25lIG9mIHRoZSB1bmRlZmluZWQvcmVzZXJ2ZWQgbWVzc2FnZXMuCiAgICAgICAqCiAgICAgICAqIEBldmVudCB1bmtub3duc3lzdGVtbWVzc2FnZQogICAgICAgKgogICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQKICAgICAgICogQHBhcmFtIHtJbnB1dH0gZXZlbnQudGFyZ2V0IFRoZSBgSW5wdXRgIHRoYXQgdHJpZ2dlcmVkIHRoZSBldmVudC4KICAgICAgICogQHBhcmFtIHtVaW50OEFycmF5fSBldmVudC5kYXRhIFRoZSByYXcgTUlESSBtZXNzYWdlIGFzIGFuIGFycmF5IG9mIDggYml0IHZhbHVlcy4KICAgICAgICogQHBhcmFtIHtOdW1iZXJ9IGV2ZW50LnRpbWVzdGFtcCBUaGUgdGltZSB3aGVuIHRoZSBldmVudCBvY2N1cnJlZCAoaW4gbWlsbGlzZWNvbmRzKQogICAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnQudHlwZSBUaGUgdHlwZSBvZiBldmVudCB0aGF0IG9jY3VycmVkLgogICAgICAgKi8KICAgICAgZXZlbnQudHlwZSA9ICJ1bmtub3duc3lzdGVtbWVzc2FnZSI7CiAgICB9IC8vIElmIHNvbWUgY2FsbGJhY2tzIGhhdmUgYmVlbiBkZWZpbmVkIGZvciB0aGlzIGV2ZW50LCBleGVjdXRlIHRoZW0uCgoKICAgIGlmICh0aGlzLl91c2VySGFuZGxlcnMuc3lzdGVtW2V2ZW50LnR5cGVdKSB7CiAgICAgIHRoaXMuX3VzZXJIYW5kbGVycy5zeXN0ZW1bZXZlbnQudHlwZV0uZm9yRWFjaChmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICBjYWxsYmFjayhldmVudCk7CiAgICAgIH0pOwogICAgfQogIH07CiAgLyoqCiAgICogVGhlIGBPdXRwdXRgIG9iamVjdCByZXByZXNlbnRzIGEgTUlESSBvdXRwdXQgcG9ydCBvbiB0aGUgaG9zdCBzeXN0ZW0uIFRoaXMgb2JqZWN0IGlzIGNyZWF0ZWQgYnkKICAgKiB0aGUgTUlESSBzdWJzeXN0ZW0gYW5kIGNhbm5vdCBiZSBpbnN0YW50aWF0ZWQgZGlyZWN0bHkuCiAgICoKICAgKiBZb3Ugd2lsbCBmaW5kIGFsbCBhdmFpbGFibGUgYE91dHB1dGAgb2JqZWN0cyBpbiB0aGUgYFdlYk1pZGkub3V0cHV0c2AgYXJyYXkuCiAgICoKICAgKiBAY2xhc3MgT3V0cHV0CiAgICogQHBhcmFtIHtNSURJT3V0cHV0fSBtaWRpT3V0cHV0IEFjdHVhbCBgTUlESU91dHB1dGAgb2JqZWN0IGFzIGRlZmluZWQgYnkgdGhlIE1JREkgc3Vic3lzdGVtCiAgICovCgoKICBmdW5jdGlvbiBPdXRwdXQobWlkaU91dHB1dCkgewogICAgdmFyIHRoYXQgPSB0aGlzOwogICAgdGhpcy5fbWlkaU91dHB1dCA9IG1pZGlPdXRwdXQ7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyh0aGlzLCB7CiAgICAgIC8qKgogICAgICAgKiBbcmVhZC1vbmx5XSBTdGF0dXMgb2YgdGhlIE1JREkgcG9ydCJzIGNvbm5lY3Rpb24KICAgICAgICoKICAgICAgICogQHByb3BlcnR5IGNvbm5lY3Rpb24KICAgICAgICogQHR5cGUgU3RyaW5nCiAgICAgICAqLwogICAgICBjb25uZWN0aW9uOiB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgIHJldHVybiB0aGF0Ll9taWRpT3V0cHV0LmNvbm5lY3Rpb247CiAgICAgICAgfQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIFtyZWFkLW9ubHldIElEIHN0cmluZyBvZiB0aGUgTUlESSBwb3J0CiAgICAgICAqCiAgICAgICAqIEBwcm9wZXJ0eSBpZAogICAgICAgKiBAdHlwZSBTdHJpbmcKICAgICAgICovCiAgICAgIGlkOiB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgIHJldHVybiB0aGF0Ll9taWRpT3V0cHV0LmlkOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBbcmVhZC1vbmx5XSBNYW51ZmFjdHVyZXIgb2YgdGhlIGRldmljZSB0byB3aGljaCB0aGlzIHBvcnQgYmVsb25ncwogICAgICAgKgogICAgICAgKiBAcHJvcGVydHkgbWFudWZhY3R1cmVyCiAgICAgICAqIEB0eXBlIFN0cmluZwogICAgICAgKi8KICAgICAgbWFudWZhY3R1cmVyOiB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgIHJldHVybiB0aGF0Ll9taWRpT3V0cHV0Lm1hbnVmYWN0dXJlcjsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogW3JlYWQtb25seV0gTmFtZSBvZiB0aGUgTUlESSBwb3J0CiAgICAgICAqCiAgICAgICAqIEBwcm9wZXJ0eSBuYW1lCiAgICAgICAqIEB0eXBlIFN0cmluZwogICAgICAgKi8KICAgICAgbmFtZTogewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICByZXR1cm4gdGhhdC5fbWlkaU91dHB1dC5uYW1lOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBbcmVhZC1vbmx5XSBTdGF0ZSBvZiB0aGUgTUlESSBwb3J0CiAgICAgICAqCiAgICAgICAqIEBwcm9wZXJ0eSBzdGF0ZQogICAgICAgKiBAdHlwZSBTdHJpbmcKICAgICAgICovCiAgICAgIHN0YXRlOiB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgIHJldHVybiB0aGF0Ll9taWRpT3V0cHV0LnN0YXRlOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBbcmVhZC1vbmx5XSBUeXBlIG9mIHRoZSBNSURJIHBvcnQgKGBvdXRwdXRgKQogICAgICAgKgogICAgICAgKiBAcHJvcGVydHkgc3RhdGUKICAgICAgICogQHR5cGUgU3RyaW5nCiAgICAgICAqLwogICAgICB0eXBlOiB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgIHJldHVybiB0aGF0Ll9taWRpT3V0cHV0LnR5cGU7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9CiAgLyoqCiAgICogU2VuZHMgYSBNSURJIG1lc3NhZ2Ugb24gdGhlIE1JREkgb3V0cHV0IHBvcnQsIGF0IHRoZSBzY2hlZHVsZWQgdGltZXN0YW1wLgogICAqCiAgICogVW5sZXNzLCB5b3UgYXJlIGZhbWlsaWFyIHdpdGggdGhlIGRldGFpbHMgb2YgdGhlIE1JREkgbWVzc2FnZSBmb3JtYXQsIHlvdSBzaG91bGQgbm90IHVzZSB0aGlzCiAgICogbWV0aG9kIGRpcmVjdGx5LiBJbnN0ZWFkLCB1c2Ugb25lIG9mIHRoZSBzaW1wbGVyIGhlbHBlciBtZXRob2RzOiBgcGxheU5vdGUoKWAsIGBzdG9wTm90ZSgpYCwKICAgKiBgc2VuZENvbnRyb2xDaGFuZ2UoKWAsIGBzZW5kU3lzdGVtTWVzc2FnZSgpYCwgZXRjLgogICAqCiAgICogRGV0YWlscyBvbiB0aGUgZm9ybWF0IG9mIE1JREkgbWVzc2FnZXMgYXJlIGF2YWlsYWJsZSBpbiB0aGUKICAgKiA8YSBocmVmPSJodHRwOi8vd3d3Lm1pZGkub3JnL3RlY2hzcGVjcy9taWRpbWVzc2FnZXMucGhwIj5zdW1tYXJ5IG9mIE1JREkgbWVzc2FnZXM8L2E+IG9mIHRoZQogICAqIE1JREkgTWFudWZhY3R1cmVycyBBc3NvY2lhdGlvbi4KICAgKgogICAqIEBtZXRob2Qgc2VuZAogICAqIEBjaGFpbmFibGUKICAgKgogICAqIEBwYXJhbSBzdGF0dXMge051bWJlcn0gVGhlIE1JREkgc3RhdHVzIGJ5dGUgb2YgdGhlIG1lc3NhZ2UgKDEyOC0yNTUpLgogICAqCiAgICogQHBhcmFtIFtkYXRhPVtdXSB7QXJyYXl9IEFuIGFycmF5IG9mIHVpbnRzIGZvciB0aGUgbWVzc2FnZS4gVGhlIG51bWJlciBvZiBkYXRhIGJ5dGVzIHZhcmllcwogICAqIGRlcGVuZGluZyBvbiB0aGUgc3RhdHVzIGJ5dGUuIEl0IGlzIHBlcmZlY3RseSBsZWdhbCB0byBzZW5kIG5vIGRhdGEgZm9yIHNvbWUgbWVzc2FnZSB0eXBlcyAodXNlCiAgICogdW5kZWZpbmVkIG9yIGFuIGVtcHR5IGFycmF5IGluIHRoaXMgY2FzZSkuIEVhY2ggYnl0ZSBtdXN0IGJlIGJldHdlZW4gMCBhbmQgMjU1LgogICAqCiAgICogQHBhcmFtIFt0aW1lc3RhbXA9MF0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB9IFRoZSB0aW1lc3RhbXAgYXQgd2hpY2ggdG8gc2VuZCB0aGUgbWVzc2FnZS4gWW91IGNhbgogICAqIHVzZSBgV2ViTWlkaS50aW1lYCB0byByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lc3RhbXAuIFRvIHNlbmQgaW1tZWRpYXRlbHksIGxlYXZlIGJsYW5rIG9yIHVzZQogICAqIDAuCiAgICoKICAgKiBAdGhyb3dzIHtSYW5nZUVycm9yfSBUaGUgc3RhdHVzIGJ5dGUgbXVzdCBiZSBhbiBpbnRlZ2VyIGJldHdlZW4gMTI4ICgweDgwKSBhbmQgMjU1ICgweEZGKS4KICAgKiBAdGhyb3dzIHtSYW5nZUVycm9yfSBEYXRhIGJ5dGVzIG11c3QgYmUgaW50ZWdlcnMgYmV0d2VlbiAwICgweDAwKSBhbmQgMjU1ICgweDdGKS4KICAgKgogICAqIEByZXR1cm4ge091dHB1dH0gUmV0dXJucyB0aGUgYE91dHB1dGAgb2JqZWN0IHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICovCgoKICBPdXRwdXQucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbiAoc3RhdHVzLCBkYXRhLCB0aW1lc3RhbXApIHsKICAgIGlmICghKHN0YXR1cyA+PSAxMjggJiYgc3RhdHVzIDw9IDI1NSkpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIlRoZSBzdGF0dXMgYnl0ZSBtdXN0IGJlIGFuIGludGVnZXIgYmV0d2VlbiAxMjggKDB4ODApIGFuZCAyNTUgKDB4RkYpLiIpOwogICAgfQoKICAgIGlmIChkYXRhID09PSB1bmRlZmluZWQpIGRhdGEgPSBbXTsKICAgIGlmICghQXJyYXkuaXNBcnJheShkYXRhKSkgZGF0YSA9IFtkYXRhXTsKICAgIHZhciBtZXNzYWdlID0gW107CiAgICBkYXRhLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgdmFyIHBhcnNlZCA9IE1hdGguZmxvb3IoaXRlbSk7IC8vIG1hbmRhdG9yeSBiZWNhdXNlIG9mICJudWxsIgoKICAgICAgaWYgKHBhcnNlZCA+PSAwICYmIHBhcnNlZCA8PSAyNTUpIHsKICAgICAgICBtZXNzYWdlLnB1c2gocGFyc2VkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigiRGF0YSBieXRlcyBtdXN0IGJlIGludGVnZXJzIGJldHdlZW4gMCAoMHgwMCkgYW5kIDI1NSAoMHhGRikuIik7CiAgICAgIH0KICAgIH0pOwoKICAgIHRoaXMuX21pZGlPdXRwdXQuc2VuZChbc3RhdHVzXS5jb25jYXQobWVzc2FnZSksIHBhcnNlRmxvYXQodGltZXN0YW1wKSB8fCAwKTsKCiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIFNlbmRzIGEgTUlESSAqc3lzdGVtIGV4Y2x1c2l2ZSogKHN5c2V4KSBtZXNzYWdlLiBUaGUgZ2VuZXJhdGVkIG1lc3NhZ2Ugd2lsbCBhdXRvbWF0aWNhbGx5IGJlCiAgICogcHJlcGVuZGVkIHdpdGggdGhlICpzeXNleCogYnl0ZSAoMHhGMCkgYW5kIHRlcm1pbmF0ZWQgd2l0aCB0aGUgKmVuZCBvZiBzeXNleCogYnl0ZSAoMHhGNykuCiAgICoKICAgKiBUbyB1c2UgdGhlIGBzZW5kU3lzZXgoKWAgbWV0aG9kLCBzeXN0ZW0gZXhjbHVzaXZlIG1lc3NhZ2Ugc3VwcG9ydCBtdXN0IGhhdmUgYmVlbiBlbmFibGVkLiBUbwogICAqIGRvIHNvLCB5b3UgbXVzdCBwYXNzIGB0cnVlYCBhcyB0aGUgc2Vjb25kIHBhcmFtZXRlciB0byBgV2ViTWlkaS5lbmFibGUoKWA6CiAgICoKICAgKiAgICAgV2ViTWlkaS5lbmFibGUoZnVuY3Rpb24gKGVycikgewogICAqICAgICAgICAgaWYgKGVycikgewogICAqICAgICAgICAgICAgIGNvbnNvbGUud2FybihlcnIpOwogICAqICAgICAgICAgfSBlbHNlIHsKICAgKiAgICAgICAgICAgICBjb25zb2xlLmxvZygiU3lzZXggaXMgZW5hYmxlZCEiKTsKICAgKiAgICAgICAgIH0KICAgKiAgICAgfSwgdHJ1ZSk7CiAgICoKICAgKiBOb3RlIHRoYXQsIGRlcGVuZGluZyBvbiBicm93c2VyLCB2ZXJzaW9uIGFuZCBwbGF0Zm9ybSwgaXQgbWF5IGJlIG5lY2Vzc2FyeSB0byBzZXJ2ZSB0aGUgcGFnZQogICAqIG92ZXIgSFRUUFMgdG8gZW5hYmxlIHN5c2V4IHN1cHBvcnQuCiAgICoKICAgKiAjIyMjIEV4YW1wbGVzCiAgICoKICAgKiBJZiB5b3Ugd2FudCB0byBzZW5kIGEgc3lzZXggbWVzc2FnZSB0byBhIEtvcmcgZGV2aWNlIGNvbm5lY3RlZCB0byB0aGUgZmlyc3Qgb3V0cHV0LCB5b3Ugd291bGQKICAgKiB1c2UgdGhlIGZvbGxvd2luZyBjb2RlOgogICAqCiAgICogICAgIFdlYk1pZGkub3V0cHV0c1swXS5zZW5kU3lzZXgoMHg0MiwgWzB4MSwgMHgyLCAweDMsIDB4NCwgMHg1XSk7CiAgICoKICAgKiBUaGUgcGFyYW1ldGVycyBjYW4gYmUgc3BlY2lmaWVkIHVzaW5nIGFueSBudW1iZXIgbm90YXRpb24gKGRlY2ltYWwsIGhleCwgYmluYXJ5LCBldGMuKS4KICAgKiBUaGVyZWZvcmUsIHRoZSBjb2RlIGJlbG93IGlzIGVxdWl2YWxlbnQgdG8gdGhlIGNvZGUgYWJvdmU6CiAgICoKICAgKiAgICAgV2ViTWlkaS5vdXRwdXRzWzBdLnNlbmRTeXNleCg2NiwgWzEsIDIsIDMsIDQsIDVdKTsKICAgKgogICAqIFRoZSBhYm92ZSBjb2RlIHNlbmRzIHRoZSBieXRlIHZhbHVlcyAxLCAyLCAzLCA0IGFuZCA1IHRvIEtvcmcgZGV2aWNlcyAoaGV4IDQyIGlzIHRoZSBzYW1lIGFzCiAgICogZGVjaW1hbCA2NikuCiAgICoKICAgKiBTb21lIG1hbnVmYWN0dXJlcnMgYXJlIGlkZW50aWZpZWQgdXNpbmcgMyBieXRlcy4gSW4gdGhpcyBjYXNlLCB5b3Ugd291bGQgdXNlIGEgMy1wb3NpdGlvbiBhcnJheQogICAqIGFzIHRoZSBmaXJzdCBwYXJhbWV0ZXIuIEZvciBleGFtcGxlLCB0byBzZW5kIHRoZSBzYW1lIHN5c2V4IG1lc3NhZ2UgdG8gYQogICAqICpOYXRpdmUgSW5zdHJ1bWVudHMqIGRldmljZToKICAgKgogICAqICAgICBXZWJNaWRpLm91dHB1dHNbMF0uc2VuZFN5c2V4KFsweDAwLCAweDIxLCAweDA5XSwgWzB4MSwgMHgyLCAweDMsIDB4NCwgMHg1XSk7CiAgICoKICAgKiBUaGVyZSBpcyBubyBsaW1pdCBmb3IgdGhlIGxlbmd0aCBvZiB0aGUgZGF0YSBhcnJheS4gSG93ZXZlciwgaXQgaXMgZ2VuZXJhbGx5IHN1Z2dlc3RlZCB0byBrZWVwCiAgICogc3lzdGVtIGV4Y2x1c2l2ZSBtZXNzYWdlcyB0byA2NEtiIG9yIGxlc3MuCiAgICoKICAgKiBAbWV0aG9kIHNlbmRTeXNleAogICAqIEBjaGFpbmFibGUKICAgKgogICAqIEBwYXJhbSBtYW51ZmFjdHVyZXIge051bWJlcnxBcnJheX0gQW4gdW5zaWduZWQgaW50ZWdlciBvciBhbiBhcnJheSBvZiB0aHJlZSB1bnNpZ25lZCBpbnRlZ2VycwogICAqIGJldHdlZW4gMCBhbmQgMTI3IHRoYXQgaWRlbnRpZnkgdGhlIHRhcmdldGVkIG1hbnVmYWN0dXJlci4gVGhlICpNSURJIE1hbnVmYWN0dXJlcnMgQXNzb2NpYXRpb24qCiAgICogbWFpbnRhaW5zIGEgZnVsbCBsaXN0IG9mCiAgICogW01hbnVmYWN0dXJlciBJRCBOdW1iZXJzXShodHRwczovL3d3dy5taWRpLm9yZy9zcGVjaWZpY2F0aW9ucy9pdGVtL21hbnVmYWN0dXJlci1pZC1udW1iZXJzKS4KICAgKgogICAqIEBwYXJhbSBbZGF0YT1bXV0ge0FycmF5fSBBbiBhcnJheSBvZiB1aW50cyBiZXR3ZWVuIDAgYW5kIDEyNy4gVGhpcyBpcyB0aGUgZGF0YSB5b3Ugd2lzaCB0bwogICAqIHRyYW5zZmVyLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zPXt9XQogICAqCiAgICogQHBhcmFtIHtET01IaWdoUmVzVGltZVN0YW1wfFN0cmluZ30gW29wdGlvbnMudGltZT11bmRlZmluZWRdIFRoaXMgdmFsdWUgY2FuIGJlIG9uZSBvZiB0d28KICAgKiB0aGluZ3MuIElmIHRoZSB2YWx1ZSBpcyBhIHN0cmluZyBzdGFydGluZyB3aXRoIHRoZSArIHNpZ24gYW5kIGZvbGxvd2VkIGJ5IGEgbnVtYmVyLCB0aGUgcmVxdWVzdAogICAqIHdpbGwgYmUgZGVsYXllZCBieSB0aGUgc3BlY2lmaWVkIG51bWJlciAoaW4gbWlsbGlzZWNvbmRzKS4gT3RoZXJ3aXNlLCB0aGUgdmFsdWUgaXMgY29uc2lkZXJlZCBhCiAgICogdGltZXN0YW1wIGFuZCB0aGUgcmVxdWVzdCB3aWxsIGJlIHNjaGVkdWxlZCBhdCB0aGF0IHRpbWVzdGFtcC4gVGhlIGBET01IaWdoUmVzVGltZVN0YW1wYCB2YWx1ZQogICAqIGlzIHJlbGF0aXZlIHRvIHRoZSBuYXZpZ2F0aW9uIHN0YXJ0IG9mIHRoZSBkb2N1bWVudC4gVG8gcmV0cmlldmUgdGhlIGN1cnJlbnQgdGltZSwgeW91IGNhbiB1c2UKICAgKiBgV2ViTWlkaS50aW1lYC4gSWYgYHRpbWVgIGlzIG5vdCBwcmVzZW50IG9yIGlzIHNldCB0byBhIHRpbWUgaW4gdGhlIHBhc3QsIHRoZSByZXF1ZXN0IGlzIHRvIGJlCiAgICogc2VudCBhcyBzb29uIGFzIHBvc3NpYmxlLgogICAqCiAgICogQHRocm93IFN5c2V4IG1lc3NhZ2Ugc3VwcG9ydCBtdXN0IGZpcnN0IGJlIGFjdGl2YXRlZC4KICAgKiBAdGhyb3cgVGhlIGRhdGEgYnl0ZXMgb2YgYSBzeXNleCBtZXNzYWdlIG11c3QgYmUgaW50ZWdlcnMgYmV0d2VlbiAwICgweDAwKSBhbmQgMTI3ICgweDdGKS4KICAgKgogICAqIEByZXR1cm4ge091dHB1dH0gUmV0dXJucyB0aGUgYE91dHB1dGAgb2JqZWN0IHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICovCgoKICBPdXRwdXQucHJvdG90eXBlLnNlbmRTeXNleCA9IGZ1bmN0aW9uIChtYW51ZmFjdHVyZXIsIGRhdGEsIG9wdGlvbnMpIHsKICAgIGlmICghd20uc3lzZXhFbmFibGVkKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiU3lzZXggbWVzc2FnZSBzdXBwb3J0IG11c3QgZmlyc3QgYmUgYWN0aXZhdGVkLiIpOwogICAgfQoKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgbWFudWZhY3R1cmVyID0gW10uY29uY2F0KG1hbnVmYWN0dXJlcik7CiAgICBkYXRhLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgaWYgKGl0ZW0gPCAwIHx8IGl0ZW0gPiAxMjcpIHsKICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigiVGhlIGRhdGEgYnl0ZXMgb2YgYSBzeXNleCBtZXNzYWdlIG11c3QgYmUgaW50ZWdlcnMgYmV0d2VlbiAwICgweDAwKSBhbmQgMTI3ICgweDdGKS4iKTsKICAgICAgfQogICAgfSk7CiAgICBkYXRhID0gbWFudWZhY3R1cmVyLmNvbmNhdChkYXRhLCB3bS5NSURJX1NZU1RFTV9NRVNTQUdFUy5zeXNleGVuZCk7CiAgICB0aGlzLnNlbmQod20uTUlESV9TWVNURU1fTUVTU0FHRVMuc3lzZXgsIGRhdGEsIHRoaXMuX3BhcnNlVGltZVBhcmFtZXRlcihvcHRpb25zLnRpbWUpKTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgLyoqCiAgICogU2VuZHMgYSAqTUlESSBUaW1lY29kZSBRdWFydGVyIEZyYW1lKiBtZXNzYWdlLiBQbGVhc2Ugbm90ZSB0aGF0IG5vIHByb2Nlc3NpbmcgaXMgYmVpbmcgZG9uZSBvbgogICAqIHRoZSBkYXRhLiBJdCBpcyB1cCB0byB0aGUgZGV2ZWxvcGVyIHRvIGZvcm1hdCB0aGUgZGF0YSBhY2NvcmRpbmcgdG8gdGhlCiAgICogW01JREkgVGltZWNvZGVdKGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL01JRElfdGltZWNvZGUpIGZvcm1hdC4KICAgKgogICAqIEBtZXRob2Qgc2VuZFRpbWVjb2RlUXVhcnRlckZyYW1lCiAgICogQGNoYWluYWJsZQogICAqCiAgICogQHBhcmFtIHZhbHVlIHtOdW1iZXJ9IFRoZSBxdWFydGVyIGZyYW1lIG1lc3NhZ2UgY29udGVudCAoaW50ZWdlciBiZXR3ZWVuIDAgYW5kIDEyNykuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dCiAgICoKICAgKiBAcGFyYW0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB8U3RyaW5nfSBbb3B0aW9ucy50aW1lPXVuZGVmaW5lZF0gVGhpcyB2YWx1ZSBjYW4gYmUgb25lIG9mIHR3bwogICAqIHRoaW5ncy4gSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHN0YXJ0aW5nIHdpdGggdGhlICsgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsIHRoZSByZXF1ZXN0CiAgICogd2lsbCBiZSBkZWxheWVkIGJ5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIChpbiBtaWxsaXNlY29uZHMpLiBPdGhlcndpc2UsIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEKICAgKiB0aW1lc3RhbXAgYW5kIHRoZSByZXF1ZXN0IHdpbGwgYmUgc2NoZWR1bGVkIGF0IHRoYXQgdGltZXN0YW1wLiBUaGUgYERPTUhpZ2hSZXNUaW1lU3RhbXBgIHZhbHVlCiAgICogaXMgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LiBUbyByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lLCB5b3UgY2FuIHVzZQogICAqIGBXZWJNaWRpLnRpbWVgLiBJZiBgdGltZWAgaXMgbm90IHByZXNlbnQgb3IgaXMgc2V0IHRvIGEgdGltZSBpbiB0aGUgcGFzdCwgdGhlIHJlcXVlc3QgaXMgdG8gYmUKICAgKiBzZW50IGFzIHNvb24gYXMgcG9zc2libGUuCiAgICoKICAgKiBAcmV0dXJuIHtPdXRwdXR9IFJldHVybnMgdGhlIGBPdXRwdXRgIG9iamVjdCBzbyBtZXRob2RzIGNhbiBiZSBjaGFpbmVkLgogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5zZW5kVGltZWNvZGVRdWFydGVyRnJhbWUgPSBmdW5jdGlvbiAodmFsdWUsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgdGhpcy5zZW5kKHdtLk1JRElfU1lTVEVNX01FU1NBR0VTLnRpbWVjb2RlLCB2YWx1ZSwgdGhpcy5fcGFyc2VUaW1lUGFyYW1ldGVyKG9wdGlvbnMudGltZSkpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBTZW5kcyBhICpTb25nIFBvc2l0aW9uKiBNSURJIG1lc3NhZ2UuIFRoZSB2YWx1ZSBpcyBleHByZXNzZWQgaW4gTUlESSBiZWF0cyAoYmV0d2VlbiAwIGFuZAogICAqIDE2MzgzKSB3aGljaCBhcmUgMTZ0aCBub3RlLiBQb3NpdGlvbiAwIGlzIGFsd2F5cyB0aGUgc3RhcnQgb2YgdGhlIHNvbmcuCiAgICoKICAgKiBAbWV0aG9kIHNlbmRTb25nUG9zaXRpb24KICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0gW3ZhbHVlPTBdIHtOdW1iZXJ9IFRoZSBNSURJIGJlYXQgdG8gY3VlIHRvIChpbnQgYmV0d2VlbiAwIGFuZCAxNjM4MykuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dCiAgICoKICAgKiBAcGFyYW0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB8U3RyaW5nfSBbb3B0aW9ucy50aW1lPXVuZGVmaW5lZF0gVGhpcyB2YWx1ZSBjYW4gYmUgb25lIG9mIHR3bwogICAqIHRoaW5ncy4gSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHN0YXJ0aW5nIHdpdGggdGhlICsgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsIHRoZSByZXF1ZXN0CiAgICogd2lsbCBiZSBkZWxheWVkIGJ5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIChpbiBtaWxsaXNlY29uZHMpLiBPdGhlcndpc2UsIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEKICAgKiB0aW1lc3RhbXAgYW5kIHRoZSByZXF1ZXN0IHdpbGwgYmUgc2NoZWR1bGVkIGF0IHRoYXQgdGltZXN0YW1wLiBUaGUgYERPTUhpZ2hSZXNUaW1lU3RhbXBgIHZhbHVlCiAgICogaXMgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LiBUbyByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lLCB5b3UgY2FuIHVzZQogICAqIGBXZWJNaWRpLnRpbWVgLiBJZiBgdGltZWAgaXMgbm90IHByZXNlbnQgb3IgaXMgc2V0IHRvIGEgdGltZSBpbiB0aGUgcGFzdCwgdGhlIHJlcXVlc3QgaXMgdG8gYmUKICAgKiBzZW50IGFzIHNvb24gYXMgcG9zc2libGUuCiAgICoKICAgKiBAcmV0dXJuIHtPdXRwdXR9IFJldHVybnMgdGhlIGBPdXRwdXRgIG9iamVjdCBzbyBtZXRob2RzIGNhbiBiZSBjaGFpbmVkLgogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5zZW5kU29uZ1Bvc2l0aW9uID0gZnVuY3Rpb24gKHZhbHVlLCBvcHRpb25zKSB7CiAgICB2YWx1ZSA9IE1hdGguZmxvb3IodmFsdWUpIHx8IDA7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHZhciBtc2IgPSB2YWx1ZSA+PiA3ICYgMHg3RjsKICAgIHZhciBsc2IgPSB2YWx1ZSAmIDB4N0Y7CiAgICB0aGlzLnNlbmQod20uTUlESV9TWVNURU1fTUVTU0FHRVMuc29uZ3Bvc2l0aW9uLCBbbXNiLCBsc2JdLCB0aGlzLl9wYXJzZVRpbWVQYXJhbWV0ZXIob3B0aW9ucy50aW1lKSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIFNlbmRzIGEgKlNvbmcgU2VsZWN0KiBNSURJIG1lc3NhZ2UuIEJld2FyZSB0aGF0IHNvbWUgZGV2aWNlcyB3aWxsIGRpc3BsYXkgcG9zaXRpb24gMCBhcwogICAqIHBvc2l0aW9uIDEgZm9yIHVzZXItZnJpZW5kbHluZXNzLgogICAqCiAgICogQG1ldGhvZCBzZW5kU29uZ1NlbGVjdAogICAqIEBjaGFpbmFibGUKICAgKgogICAqIEBwYXJhbSB2YWx1ZSB7TnVtYmVyfSBUaGUgbnVtYmVyIG9mIHRoZSBzb25nIHRvIHNlbGVjdCAoaW50ZWdlciBiZXR3ZWVuIDAgYW5kIDEyNykuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dCiAgICoKICAgKiBAcGFyYW0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB8U3RyaW5nfSBbb3B0aW9ucy50aW1lPXVuZGVmaW5lZF0gVGhpcyB2YWx1ZSBjYW4gYmUgb25lIG9mIHR3bwogICAqIHRoaW5ncy4gSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHN0YXJ0aW5nIHdpdGggdGhlICsgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsIHRoZSByZXF1ZXN0CiAgICogd2lsbCBiZSBkZWxheWVkIGJ5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIChpbiBtaWxsaXNlY29uZHMpLiBPdGhlcndpc2UsIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEKICAgKiB0aW1lc3RhbXAgYW5kIHRoZSByZXF1ZXN0IHdpbGwgYmUgc2NoZWR1bGVkIGF0IHRoYXQgdGltZXN0YW1wLiBUaGUgYERPTUhpZ2hSZXNUaW1lU3RhbXBgIHZhbHVlCiAgICogaXMgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LiBUbyByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lLCB5b3UgY2FuIHVzZQogICAqIGBXZWJNaWRpLnRpbWVgLiBJZiBgdGltZWAgaXMgbm90IHByZXNlbnQgb3IgaXMgc2V0IHRvIGEgdGltZSBpbiB0aGUgcGFzdCwgdGhlIHJlcXVlc3QgaXMgdG8gYmUKICAgKiBzZW50IGFzIHNvb24gYXMgcG9zc2libGUuCiAgICoKICAgKiBAdGhyb3dzIFRoZSBzb25nIG51bWJlciBtdXN0IGJlIGJldHdlZW4gMCBhbmQgMTI3LgogICAqCiAgICogQHJldHVybiB7T3V0cHV0fSBSZXR1cm5zIHRoZSBgT3V0cHV0YCBvYmplY3Qgc28gbWV0aG9kcyBjYW4gYmUgY2hhaW5lZC4KICAgKi8KCgogIE91dHB1dC5wcm90b3R5cGUuc2VuZFNvbmdTZWxlY3QgPSBmdW5jdGlvbiAodmFsdWUsIG9wdGlvbnMpIHsKICAgIHZhbHVlID0gTWF0aC5mbG9vcih2YWx1ZSk7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICBpZiAoISh2YWx1ZSA+PSAwICYmIHZhbHVlIDw9IDEyNykpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIlRoZSBzb25nIG51bWJlciBtdXN0IGJlIGJldHdlZW4gMCBhbmQgMTI3LiIpOwogICAgfQoKICAgIHRoaXMuc2VuZCh3bS5NSURJX1NZU1RFTV9NRVNTQUdFUy5zb25nc2VsZWN0LCBbdmFsdWVdLCB0aGlzLl9wYXJzZVRpbWVQYXJhbWV0ZXIob3B0aW9ucy50aW1lKSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIFNlbmRzIGEgKk1JREkgdHVuaW5nIHJlcXVlc3QqIHJlYWwtdGltZSBtZXNzYWdlLgogICAqCiAgICogTm90ZTogdGhlcmUgaXMgY3VycmVudGx5IGEgYnVnIGluIENocm9tZSJzIE1JREkgaW1wbGVtZW50YXRpb24uIElmIHlvdSB0cnkgdG8gdXNlIHRoaXMKICAgKiBmdW5jdGlvbiwgQ2hyb21lIHdpbGwgYWN0dWFsbHkgdGhyb3cgYSAiTWVzc2FnZSBpcyBpbmNvbXBsZXRlIiBlcnJvci4gVGhlIGJ1ZyBpcwogICAqIFtzY2hlZHVsZWQgdG8gYmUgZml4ZWRdKGh0dHBzOi8vYnVncy5jaHJvbWl1bS5vcmcvcC9jaHJvbWl1bS9pc3N1ZXMvZGV0YWlsP2lkPTYxMDExNikuCiAgICoKICAgKiBAbWV0aG9kIHNlbmRUdW5pbmdSZXF1ZXN0CiAgICogQGNoYWluYWJsZQogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zPXt9XQogICAqCiAgICogQHBhcmFtIHtET01IaWdoUmVzVGltZVN0YW1wfFN0cmluZ30gW29wdGlvbnMudGltZT11bmRlZmluZWRdIFRoaXMgdmFsdWUgY2FuIGJlIG9uZSBvZiB0d28KICAgKiB0aGluZ3MuIElmIHRoZSB2YWx1ZSBpcyBhIHN0cmluZyBzdGFydGluZyB3aXRoIHRoZSArIHNpZ24gYW5kIGZvbGxvd2VkIGJ5IGEgbnVtYmVyLCB0aGUgcmVxdWVzdAogICAqIHdpbGwgYmUgZGVsYXllZCBieSB0aGUgc3BlY2lmaWVkIG51bWJlciAoaW4gbWlsbGlzZWNvbmRzKS4gT3RoZXJ3aXNlLCB0aGUgdmFsdWUgaXMgY29uc2lkZXJlZCBhCiAgICogdGltZXN0YW1wIGFuZCB0aGUgcmVxdWVzdCB3aWxsIGJlIHNjaGVkdWxlZCBhdCB0aGF0IHRpbWVzdGFtcC4gVGhlIGBET01IaWdoUmVzVGltZVN0YW1wYCB2YWx1ZQogICAqIGlzIHJlbGF0aXZlIHRvIHRoZSBuYXZpZ2F0aW9uIHN0YXJ0IG9mIHRoZSBkb2N1bWVudC4gVG8gcmV0cmlldmUgdGhlIGN1cnJlbnQgdGltZSwgeW91IGNhbiB1c2UKICAgKiBgV2ViTWlkaS50aW1lYC4gSWYgYHRpbWVgIGlzIG5vdCBwcmVzZW50IG9yIGlzIHNldCB0byBhIHRpbWUgaW4gdGhlIHBhc3QsIHRoZSByZXF1ZXN0IGlzIHRvIGJlCiAgICogc2VudCBhcyBzb29uIGFzIHBvc3NpYmxlLgogICAqCiAgICogQHJldHVybiB7T3V0cHV0fSBSZXR1cm5zIHRoZSBgT3V0cHV0YCBvYmplY3Qgc28gbWV0aG9kcyBjYW4gYmUgY2hhaW5lZC4KICAgKi8KCgogIE91dHB1dC5wcm90b3R5cGUuc2VuZFR1bmluZ1JlcXVlc3QgPSBmdW5jdGlvbiAob3B0aW9ucykgewogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB0aGlzLnNlbmQod20uTUlESV9TWVNURU1fTUVTU0FHRVMudHVuaW5ncmVxdWVzdCwgdW5kZWZpbmVkLCB0aGlzLl9wYXJzZVRpbWVQYXJhbWV0ZXIob3B0aW9ucy50aW1lKSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIFNlbmRzIGEgKk1JREkgQ2xvY2sqIHJlYWwtdGltZSBtZXNzYWdlLiBBY2NvcmRpbmcgdG8gdGhlIHN0YW5kYXJkLCB0aGVyZSBhcmUgMjQgTUlESSBDbG9ja3MKICAgKiBmb3IgZXZlcnkgcXVhcnRlciBub3RlLgogICAqCiAgICogQG1ldGhvZCBzZW5kQ2xvY2sKICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dCiAgICoKICAgKiBAcGFyYW0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB8U3RyaW5nfSBbb3B0aW9ucy50aW1lPXVuZGVmaW5lZF0gVGhpcyB2YWx1ZSBjYW4gYmUgb25lIG9mIHR3bwogICAqIHRoaW5ncy4gSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHN0YXJ0aW5nIHdpdGggdGhlICsgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsIHRoZSByZXF1ZXN0CiAgICogd2lsbCBiZSBkZWxheWVkIGJ5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIChpbiBtaWxsaXNlY29uZHMpLiBPdGhlcndpc2UsIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEKICAgKiB0aW1lc3RhbXAgYW5kIHRoZSByZXF1ZXN0IHdpbGwgYmUgc2NoZWR1bGVkIGF0IHRoYXQgdGltZXN0YW1wLiBUaGUgYERPTUhpZ2hSZXNUaW1lU3RhbXBgIHZhbHVlCiAgICogaXMgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LiBUbyByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lLCB5b3UgY2FuIHVzZQogICAqIGBXZWJNaWRpLnRpbWVgLiBJZiBgdGltZWAgaXMgbm90IHByZXNlbnQgb3IgaXMgc2V0IHRvIGEgdGltZSBpbiB0aGUgcGFzdCwgdGhlIHJlcXVlc3QgaXMgdG8gYmUKICAgKiBzZW50IGFzIHNvb24gYXMgcG9zc2libGUuCiAgICoKICAgKiBAcmV0dXJuIHtPdXRwdXR9IFJldHVybnMgdGhlIGBPdXRwdXRgIG9iamVjdCBzbyBtZXRob2RzIGNhbiBiZSBjaGFpbmVkLgogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5zZW5kQ2xvY2sgPSBmdW5jdGlvbiAob3B0aW9ucykgewogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB0aGlzLnNlbmQod20uTUlESV9TWVNURU1fTUVTU0FHRVMuY2xvY2ssIHVuZGVmaW5lZCwgdGhpcy5fcGFyc2VUaW1lUGFyYW1ldGVyKG9wdGlvbnMudGltZSkpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBTZW5kcyBhICpTdGFydCogcmVhbC10aW1lIG1lc3NhZ2UuIEEgTUlESSBTdGFydCBtZXNzYWdlIHN0YXJ0cyB0aGUgcGxheWJhY2sgb2YgdGhlIGN1cnJlbnQKICAgKiBzb25nIGF0IGJlYXQgMC4gVG8gc3RhcnQgcGxheWJhY2sgZWxzZXdoZXJlIGluIHRoZSBzb25nLCB1c2UgdGhlIGBzZW5kQ29udGludWUoKWAgZnVuY3Rpb24uCiAgICoKICAgKiBAbWV0aG9kIHNlbmRTdGFydAogICAqIEBjaGFpbmFibGUKICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucz17fV0KICAgKgogICAqIEBwYXJhbSB7RE9NSGlnaFJlc1RpbWVTdGFtcHxTdHJpbmd9IFtvcHRpb25zLnRpbWU9dW5kZWZpbmVkXSBUaGlzIHZhbHVlIGNhbiBiZSBvbmUgb2YgdHdvCiAgICogdGhpbmdzLiBJZiB0aGUgdmFsdWUgaXMgYSBzdHJpbmcgc3RhcnRpbmcgd2l0aCB0aGUgKyBzaWduIGFuZCBmb2xsb3dlZCBieSBhIG51bWJlciwgdGhlIHJlcXVlc3QKICAgKiB3aWxsIGJlIGRlbGF5ZWQgYnkgdGhlIHNwZWNpZmllZCBudW1iZXIgKGluIG1pbGxpc2Vjb25kcykuIE90aGVyd2lzZSwgdGhlIHZhbHVlIGlzIGNvbnNpZGVyZWQgYQogICAqIHRpbWVzdGFtcCBhbmQgdGhlIHJlcXVlc3Qgd2lsbCBiZSBzY2hlZHVsZWQgYXQgdGhhdCB0aW1lc3RhbXAuIFRoZSBgRE9NSGlnaFJlc1RpbWVTdGFtcGAgdmFsdWUKICAgKiBpcyByZWxhdGl2ZSB0byB0aGUgbmF2aWdhdGlvbiBzdGFydCBvZiB0aGUgZG9jdW1lbnQuIFRvIHJldHJpZXZlIHRoZSBjdXJyZW50IHRpbWUsIHlvdSBjYW4gdXNlCiAgICogYFdlYk1pZGkudGltZWAuIElmIGB0aW1lYCBpcyBub3QgcHJlc2VudCBvciBpcyBzZXQgdG8gYSB0aW1lIGluIHRoZSBwYXN0LCB0aGUgcmVxdWVzdCBpcyB0byBiZQogICAqIHNlbnQgYXMgc29vbiBhcyBwb3NzaWJsZS4KICAgKgogICAqIEByZXR1cm4ge091dHB1dH0gUmV0dXJucyB0aGUgYE91dHB1dGAgb2JqZWN0IHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICovCgoKICBPdXRwdXQucHJvdG90eXBlLnNlbmRTdGFydCA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHRoaXMuc2VuZCh3bS5NSURJX1NZU1RFTV9NRVNTQUdFUy5zdGFydCwgdW5kZWZpbmVkLCB0aGlzLl9wYXJzZVRpbWVQYXJhbWV0ZXIob3B0aW9ucy50aW1lKSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIFNlbmRzIGEgKkNvbnRpbnVlKiByZWFsLXRpbWUgbWVzc2FnZS4gVGhpcyByZXN1bWVzIHNvbmcgcGxheWJhY2sgd2hlcmUgaXQgd2FzIHByZXZpb3VzbHkKICAgKiBzdG9wcGVkIG9yIHdoZXJlIGl0IHdhcyBsYXN0IGN1ZWQgd2l0aCBhIHNvbmcgcG9zaXRpb24gbWVzc2FnZS4gVG8gc3RhcnQgcGxheWJhY2sgZnJvbSB0aGUKICAgKiBzdGFydCwgdXNlIHRoZSBgc2VuZFN0YXJ0KClgIGZ1bmN0aW9uLgogICAqCiAgICogQG1ldGhvZCBzZW5kQ29udGludWUKICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dCiAgICoKICAgKiBAcGFyYW0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB8U3RyaW5nfSBbb3B0aW9ucy50aW1lPXVuZGVmaW5lZF0gVGhpcyB2YWx1ZSBjYW4gYmUgb25lIG9mIHR3bwogICAqIHRoaW5ncy4gSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHN0YXJ0aW5nIHdpdGggdGhlICsgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsIHRoZSByZXF1ZXN0CiAgICogd2lsbCBiZSBkZWxheWVkIGJ5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIChpbiBtaWxsaXNlY29uZHMpLiBPdGhlcndpc2UsIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEKICAgKiB0aW1lc3RhbXAgYW5kIHRoZSByZXF1ZXN0IHdpbGwgYmUgc2NoZWR1bGVkIGF0IHRoYXQgdGltZXN0YW1wLiBUaGUgYERPTUhpZ2hSZXNUaW1lU3RhbXBgIHZhbHVlCiAgICogaXMgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LiBUbyByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lLCB5b3UgY2FuIHVzZQogICAqIGBXZWJNaWRpLnRpbWVgLiBJZiBgdGltZWAgaXMgbm90IHByZXNlbnQgb3IgaXMgc2V0IHRvIGEgdGltZSBpbiB0aGUgcGFzdCwgdGhlIHJlcXVlc3QgaXMgdG8gYmUKICAgKiBzZW50IGFzIHNvb24gYXMgcG9zc2libGUuCiAgICoKICAgKiBAcmV0dXJuIHtXZWJNaWRpfSBSZXR1cm5zIHRoZSBgV2ViTWlkaWAgb2JqZWN0IHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICovCgoKICBPdXRwdXQucHJvdG90eXBlLnNlbmRDb250aW51ZSA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHRoaXMuc2VuZCh3bS5NSURJX1NZU1RFTV9NRVNTQUdFU1siY29udGludWUiXSwgdW5kZWZpbmVkLCB0aGlzLl9wYXJzZVRpbWVQYXJhbWV0ZXIob3B0aW9ucy50aW1lKSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIFNlbmRzIGEgKlN0b3AqIHJlYWwtdGltZSBtZXNzYWdlLiBUaGlzIHRlbGxzIHRoZSBkZXZpY2UgY29ubmVjdGVkIHRvIHRoaXMgcG9ydCB0byBzdG9wIHBsYXliYWNrCiAgICogaW1tZWRpYXRlbHkgKG9yIGF0IHRoZSBzY2hlZHVsZWQgdGltZSkuCiAgICoKICAgKiBAbWV0aG9kIHNlbmRTdG9wCiAgICogQGNoYWluYWJsZQogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zPXt9XQogICAqCiAgICogQHBhcmFtIHtET01IaWdoUmVzVGltZVN0YW1wfFN0cmluZ30gW29wdGlvbnMudGltZT11bmRlZmluZWRdIFRoaXMgdmFsdWUgY2FuIGJlIG9uZSBvZiB0d28KICAgKiB0aGluZ3MuIElmIHRoZSB2YWx1ZSBpcyBhIHN0cmluZyBzdGFydGluZyB3aXRoIHRoZSArIHNpZ24gYW5kIGZvbGxvd2VkIGJ5IGEgbnVtYmVyLCB0aGUgcmVxdWVzdAogICAqIHdpbGwgYmUgZGVsYXllZCBieSB0aGUgc3BlY2lmaWVkIG51bWJlciAoaW4gbWlsbGlzZWNvbmRzKS4gT3RoZXJ3aXNlLCB0aGUgdmFsdWUgaXMgY29uc2lkZXJlZCBhCiAgICogdGltZXN0YW1wIGFuZCB0aGUgcmVxdWVzdCB3aWxsIGJlIHNjaGVkdWxlZCBhdCB0aGF0IHRpbWVzdGFtcC4gVGhlIGBET01IaWdoUmVzVGltZVN0YW1wYCB2YWx1ZQogICAqIGlzIHJlbGF0aXZlIHRvIHRoZSBuYXZpZ2F0aW9uIHN0YXJ0IG9mIHRoZSBkb2N1bWVudC4gVG8gcmV0cmlldmUgdGhlIGN1cnJlbnQgdGltZSwgeW91IGNhbiB1c2UKICAgKiBgV2ViTWlkaS50aW1lYC4gSWYgYHRpbWVgIGlzIG5vdCBwcmVzZW50IG9yIGlzIHNldCB0byBhIHRpbWUgaW4gdGhlIHBhc3QsIHRoZSByZXF1ZXN0IGlzIHRvIGJlCiAgICogc2VudCBhcyBzb29uIGFzIHBvc3NpYmxlLgogICAqCiAgICogQHJldHVybiB7T3V0cHV0fSBSZXR1cm5zIHRoZSBgT3V0cHV0YCBvYmplY3Qgc28gbWV0aG9kcyBjYW4gYmUgY2hhaW5lZC4KICAgKi8KCgogIE91dHB1dC5wcm90b3R5cGUuc2VuZFN0b3AgPSBmdW5jdGlvbiAob3B0aW9ucykgewogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB0aGlzLnNlbmQod20uTUlESV9TWVNURU1fTUVTU0FHRVMuc3RvcCwgdW5kZWZpbmVkLCB0aGlzLl9wYXJzZVRpbWVQYXJhbWV0ZXIob3B0aW9ucy50aW1lKSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIFNlbmRzIGFuICpBY3RpdmUgU2Vuc2luZyogcmVhbC10aW1lIG1lc3NhZ2UuIFRoaXMgdGVsbHMgdGhlIGRldmljZSBjb25uZWN0ZWQgdG8gdGhpcyBwb3J0IHRoYXQKICAgKiB0aGUgY29ubmVjdGlvbiBpcyBzdGlsbCBnb29kLiBBY3RpdmUgc2Vuc2luZyBtZXNzYWdlcyBzaG91bGQgYmUgc2VudCBldmVyeSAzMDAgbXMgaWYgdGhlcmUgd2FzCiAgICogbm8gb3RoZXIgYWN0aXZpdHkgb24gdGhlIE1JREkgcG9ydC4KICAgKgogICAqIEBtZXRob2Qgc2VuZEFjdGl2ZVNlbnNpbmcKICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dCiAgICoKICAgKiBAcGFyYW0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB8U3RyaW5nfSBbb3B0aW9ucy50aW1lPXVuZGVmaW5lZF0gVGhpcyB2YWx1ZSBjYW4gYmUgb25lIG9mIHR3bwogICAqIHRoaW5ncy4gSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHN0YXJ0aW5nIHdpdGggdGhlICsgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsIHRoZSByZXF1ZXN0CiAgICogd2lsbCBiZSBkZWxheWVkIGJ5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIChpbiBtaWxsaXNlY29uZHMpLiBPdGhlcndpc2UsIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEKICAgKiB0aW1lc3RhbXAgYW5kIHRoZSByZXF1ZXN0IHdpbGwgYmUgc2NoZWR1bGVkIGF0IHRoYXQgdGltZXN0YW1wLiBUaGUgYERPTUhpZ2hSZXNUaW1lU3RhbXBgIHZhbHVlCiAgICogaXMgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LiBUbyByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lLCB5b3UgY2FuIHVzZQogICAqIGBXZWJNaWRpLnRpbWVgLiBJZiBgdGltZWAgaXMgbm90IHByZXNlbnQgb3IgaXMgc2V0IHRvIGEgdGltZSBpbiB0aGUgcGFzdCwgdGhlIHJlcXVlc3QgaXMgdG8gYmUKICAgKiBzZW50IGFzIHNvb24gYXMgcG9zc2libGUuCiAgICoKICAgKiBAcmV0dXJuIHtPdXRwdXR9IFJldHVybnMgdGhlIGBPdXRwdXRgIG9iamVjdCBzbyBtZXRob2RzIGNhbiBiZSBjaGFpbmVkLgogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5zZW5kQWN0aXZlU2Vuc2luZyA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHRoaXMuc2VuZCh3bS5NSURJX1NZU1RFTV9NRVNTQUdFUy5hY3RpdmVzZW5zaW5nLCBbXSwgdGhpcy5fcGFyc2VUaW1lUGFyYW1ldGVyKG9wdGlvbnMudGltZSkpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBTZW5kcyAqUmVzZXQqIHJlYWwtdGltZSBtZXNzYWdlLiBUaGlzIHRlbGxzIHRoZSBkZXZpY2UgY29ubmVjdGVkIHRvIHRoaXMgcG9ydCB0aGF0IGlzIHNob3VsZAogICAqIHJlc2V0IGl0c2VsZiB0byBhIGRlZmF1bHQgc3RhdGUuCiAgICoKICAgKiBAbWV0aG9kIHNlbmRSZXNldAogICAqIEBjaGFpbmFibGUKICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucz17fV0KICAgKgogICAqIEBwYXJhbSB7RE9NSGlnaFJlc1RpbWVTdGFtcHxTdHJpbmd9IFtvcHRpb25zLnRpbWU9dW5kZWZpbmVkXSBUaGlzIHZhbHVlIGNhbiBiZSBvbmUgb2YgdHdvCiAgICogdGhpbmdzLiBJZiB0aGUgdmFsdWUgaXMgYSBzdHJpbmcgc3RhcnRpbmcgd2l0aCB0aGUgKyBzaWduIGFuZCBmb2xsb3dlZCBieSBhIG51bWJlciwgdGhlIHJlcXVlc3QKICAgKiB3aWxsIGJlIGRlbGF5ZWQgYnkgdGhlIHNwZWNpZmllZCBudW1iZXIgKGluIG1pbGxpc2Vjb25kcykuIE90aGVyd2lzZSwgdGhlIHZhbHVlIGlzIGNvbnNpZGVyZWQgYQogICAqIHRpbWVzdGFtcCBhbmQgdGhlIHJlcXVlc3Qgd2lsbCBiZSBzY2hlZHVsZWQgYXQgdGhhdCB0aW1lc3RhbXAuIFRoZSBgRE9NSGlnaFJlc1RpbWVTdGFtcGAgdmFsdWUKICAgKiBpcyByZWxhdGl2ZSB0byB0aGUgbmF2aWdhdGlvbiBzdGFydCBvZiB0aGUgZG9jdW1lbnQuIFRvIHJldHJpZXZlIHRoZSBjdXJyZW50IHRpbWUsIHlvdSBjYW4gdXNlCiAgICogYFdlYk1pZGkudGltZWAuIElmIGB0aW1lYCBpcyBub3QgcHJlc2VudCBvciBpcyBzZXQgdG8gYSB0aW1lIGluIHRoZSBwYXN0LCB0aGUgcmVxdWVzdCBpcyB0byBiZQogICAqIHNlbnQgYXMgc29vbiBhcyBwb3NzaWJsZS4KICAgKgogICAqIEByZXR1cm4ge091dHB1dH0gUmV0dXJucyB0aGUgYE91dHB1dGAgb2JqZWN0IHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICovCgoKICBPdXRwdXQucHJvdG90eXBlLnNlbmRSZXNldCA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHRoaXMuc2VuZCh3bS5NSURJX1NZU1RFTV9NRVNTQUdFUy5yZXNldCwgdW5kZWZpbmVkLCB0aGlzLl9wYXJzZVRpbWVQYXJhbWV0ZXIob3B0aW9ucy50aW1lKSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIFNlbmRzIGEgTUlESSAqKm5vdGUgb2ZmKiogbWVzc2FnZSB0byB0aGUgc3BlY2lmaWVkIGNoYW5uZWwocykgZm9yIGEgc2luZ2xlIG5vdGUgb3IgbXVsdGlwbGUKICAgKiBzaW11bHRhbmVvdXMgbm90ZXMgKGNob3JkKS4gWW91IGNhbiBkZWxheSB0aGUgZXhlY3V0aW9uIG9mIHRoZSAqKm5vdGUgb2ZmKiogY29tbWFuZCBieSB1c2luZwogICAqIHRoZSBgdGltZWAgcHJvcGVydHkgb2YgdGhlIGBvcHRpb25zYCBwYXJhbWV0ZXIgKGluIG1pbGxpc2Vjb25kcykuCiAgICoKICAgKiBAbWV0aG9kIHN0b3BOb3RlCiAgICogQGNoYWluYWJsZQogICAqCiAgICogQHBhcmFtIG5vdGUge051bWJlcnxBcnJheXxTdHJpbmd9ICBUaGUgbm90ZShzKSB5b3Ugd2lzaCB0byBzdG9wLiBUaGUgbm90ZXMgY2FuIGJlIHNwZWNpZmllZCBpbgogICAqIG9uZSBvZiB0aHJlZSB3YXlzLiBUaGUgZmlyc3Qgd2F5IGlzIGJ5IHVzaW5nIHRoZSBNSURJIG5vdGUgbnVtYmVyIChhbiBpbnRlZ2VyIGJldHdlZW4gYDBgIGFuZAogICAqIGAxMjdgKS4gVGhlIHNlY29uZCB3YXkgaXMgYnkgdXNpbmcgdGhlIG5vdGUgbmFtZSBmb2xsb3dlZCBieSB0aGUgb2N0YXZlIChDMywgRyM0LCBGLTEsIERiNykuCiAgICogVGhlIG9jdGF2ZSByYW5nZSBzaG91bGQgYmUgYmV0d2VlbiAtMiBhbmQgOC4gVGhlIGxvd2VzdCBub3RlIGlzIEMtMiAoTUlESSBub3RlIG51bWJlciAwKSBhbmQKICAgKiB0aGUgaGlnaGVzdCBub3RlIGlzIEc4IChNSURJIG5vdGUgbnVtYmVyIDEyNykuIEl0IGlzIGFsc28gcG9zc2libGUgdG8gc3BlY2lmeSBhbiBhcnJheSBvZiBub3RlCiAgICogbnVtYmVycyBhbmQvb3IgbmFtZXMuIFRoZSBmaW5hbCB3YXkgaXMgdG8gdXNlIHRoZSBzcGVjaWFsIHZhbHVlIGBhbGxgIHRvIHNlbmQgYW4gImFsbG5vdGVzb2ZmIgogICAqIGNoYW5uZWwgbWVzc2FnZS4KICAgKgogICAqIEBwYXJhbSBbY2hhbm5lbD1hbGxdIHtOdW1iZXJ8QXJyYXl8U3RyaW5nfSBUaGUgTUlESSBjaGFubmVsIG51bWJlciAoYmV0d2VlbiBgMWAgYW5kIGAxNmApIG9yIGFuCiAgICogYXJyYXkgb2YgY2hhbm5lbCBudW1iZXJzLiBJZiB0aGUgc3BlY2lhbCB2YWx1ZSBgYWxsYCBpcyB1c2VkIChkZWZhdWx0KSwgdGhlIG1lc3NhZ2Ugd2lsbCBiZQogICAqIHNlbnQgdG8gYWxsIDE2IGNoYW5uZWxzLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zPXt9XQogICAqCiAgICogQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5yYXdWZWxvY2l0eT1mYWxzZV0gQ29udHJvbHMgd2hldGhlciB0aGUgcmVsZWFzZSB2ZWxvY2l0eSBpcyBzZXQgdXNpbmcKICAgKiBhbiBpbnRlZ2VyIGJldHdlZW4gYDBgIGFuZCBgMTI3YCAoYHRydWVgKSBvciBhIGRlY2ltYWwgbnVtYmVyIGJldHdlZW4gYDBgIGFuZCBgMWAgKGBmYWxzZWAsCiAgICogZGVmYXVsdCkuCiAgICoKICAgKiBAcGFyYW0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB8U3RyaW5nfSBbb3B0aW9ucy50aW1lPXVuZGVmaW5lZF0gVGhpcyB2YWx1ZSBjYW4gYmUgb25lIG9mIHR3bwogICAqIHRoaW5ncy4gSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHN0YXJ0aW5nIHdpdGggdGhlICsgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsIHRoZSByZXF1ZXN0CiAgICogd2lsbCBiZSBkZWxheWVkIGJ5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIChpbiBtaWxsaXNlY29uZHMpLiBPdGhlcndpc2UsIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEKICAgKiB0aW1lc3RhbXAgYW5kIHRoZSByZXF1ZXN0IHdpbGwgYmUgc2NoZWR1bGVkIGF0IHRoYXQgdGltZXN0YW1wLiBUaGUgYERPTUhpZ2hSZXNUaW1lU3RhbXBgIHZhbHVlCiAgICogaXMgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LiBUbyByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lLCB5b3UgY2FuIHVzZQogICAqIGBXZWJNaWRpLnRpbWVgLiBJZiBgdGltZWAgaXMgbm90IHByZXNlbnQgb3IgaXMgc2V0IHRvIGEgdGltZSBpbiB0aGUgcGFzdCwgdGhlIHJlcXVlc3QgaXMgdG8gYmUKICAgKiBzZW50IGFzIHNvb24gYXMgcG9zc2libGUuCiAgICoKICAgKiBAcGFyYW0ge051bWJlcn0gW29wdGlvbnMudmVsb2NpdHk9MC41XSBUaGUgdmVsb2NpdHkgYXQgd2hpY2ggdG8gcmVsZWFzZSB0aGUgbm90ZSAoYmV0d2VlbiBgMGAKICAgKiBhbmQgYDFgKS4gSWYgdGhlIGByYXdWZWxvY2l0eWAgb3B0aW9uIGlzIGB0cnVlYCwgdGhlIHZhbHVlIHNob3VsZCBiZSBzcGVjaWZpZWQgYXMgYW4gaW50ZWdlcgogICAqIGJldHdlZW4gYDBgIGFuZCBgMTI3YC4gQW4gaW52YWxpZCB2ZWxvY2l0eSB2YWx1ZSB3aWxsIHNpbGVudGx5IHRyaWdnZXIgdGhlIGRlZmF1bHQgb2YgYDAuNWAuCiAgICogTm90ZSB0aGF0IHdoZW4gdGhlIGZpcnN0IHBhcmFtZXRlciB0byBgc3RvcE5vdGUoKWAgaXMgYGFsbGAsIHRoZSByZWxlYXNlIHZlbG9jaXR5IGlzIHNpbGVudGx5CiAgICogaWdub3JlZC4KICAgKgogICAqIEByZXR1cm4ge091dHB1dH0gUmV0dXJucyB0aGUgYE91dHB1dGAgb2JqZWN0IHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICovCgoKICBPdXRwdXQucHJvdG90eXBlLnN0b3BOb3RlID0gZnVuY3Rpb24gKG5vdGUsIGNoYW5uZWwsIG9wdGlvbnMpIHsKICAgIGlmIChub3RlID09PSAiYWxsIikgewogICAgICByZXR1cm4gdGhpcy5zZW5kQ2hhbm5lbE1vZGUoImFsbG5vdGVzb2ZmIiwgMCwgY2hhbm5lbCwgb3B0aW9ucyk7CiAgICB9CgogICAgdmFyIG5WZWxvY2l0eSA9IDY0OwogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgaWYgKG9wdGlvbnMucmF3VmVsb2NpdHkpIHsKICAgICAgaWYgKCFpc05hTihvcHRpb25zLnZlbG9jaXR5KSAmJiBvcHRpb25zLnZlbG9jaXR5ID49IDAgJiYgb3B0aW9ucy52ZWxvY2l0eSA8PSAxMjcpIHsKICAgICAgICBuVmVsb2NpdHkgPSBvcHRpb25zLnZlbG9jaXR5OwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoIWlzTmFOKG9wdGlvbnMudmVsb2NpdHkpICYmIG9wdGlvbnMudmVsb2NpdHkgPj0gMCAmJiBvcHRpb25zLnZlbG9jaXR5IDw9IDEpIHsKICAgICAgICBuVmVsb2NpdHkgPSBvcHRpb25zLnZlbG9jaXR5ICogMTI3OwogICAgICB9CiAgICB9IC8vIFNlbmQgbm90ZSBvZmYgbWVzc2FnZXMKCgogICAgdGhpcy5fY29udmVydE5vdGVUb0FycmF5KG5vdGUpLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgd20udG9NSURJQ2hhbm5lbHMoY2hhbm5lbCkuZm9yRWFjaChmdW5jdGlvbiAoY2gpIHsKICAgICAgICB0aGlzLnNlbmQoKHdtLk1JRElfQ0hBTk5FTF9NRVNTQUdFUy5ub3Rlb2ZmIDw8IDQpICsgKGNoIC0gMSksIFtpdGVtLCBNYXRoLnJvdW5kKG5WZWxvY2l0eSldLCB0aGlzLl9wYXJzZVRpbWVQYXJhbWV0ZXIob3B0aW9ucy50aW1lKSk7CiAgICAgIH0uYmluZCh0aGlzKSk7CiAgICB9LmJpbmQodGhpcykpOwoKICAgIHJldHVybiB0aGlzOwogIH07CiAgLyoqCiAgICogUmVxdWVzdHMgdGhlIHBsYXliYWNrIG9mIGEgc2luZ2xlIG5vdGUgb3IgbXVsdGlwbGUgbm90ZXMgb24gdGhlIHNwZWNpZmllZCBjaGFubmVsKHMpLiBZb3UgY2FuCiAgICogZGVsYXkgdGhlIGV4ZWN1dGlvbiBvZiB0aGUgKipub3RlIG9uKiogY29tbWFuZCBieSB1c2luZyB0aGUgYHRpbWVgIHByb3BlcnR5IG9mIHRoZSBgb3B0aW9uc2AKICAgKiBwYXJhbWV0ZXIgKG1pbGxpc2Vjb25kcykuCiAgICoKICAgKiBJZiBubyBkdXJhdGlvbiBpcyBzcGVjaWZpZWQgaW4gdGhlIGBvcHRpb25zYCwgdGhlIG5vdGUgd2lsbCBwbGF5IHVudGlsIGEgbWF0Y2hpbmcgKipub3RlIG9mZioqCiAgICogaXMgc2VudC4gSWYgYSBkdXJhdGlvbiBpcyBzcGVjaWZpZWQsIGEgKipub3RlIG9mZioqIHdpbGwgYmUgYXV0b21hdGljYWxseSBzZW50IGFmdGVyIHNhaWQKICAgKiBkdXJhdGlvbi4KICAgKgogICAqIE5vdGU6IEFzIHBlciB0aGUgTUlESSBzdGFuZGFyZCwgYSAqKm5vdGUgb24qKiBldmVudCB3aXRoIGEgdmVsb2NpdHkgb2YgYDBgIGlzIGNvbnNpZGVyZWQgdG8gYmUKICAgKiBhICoqbm90ZSBvZmYqKi4KICAgKgogICAqIEBtZXRob2QgcGxheU5vdGUKICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0gbm90ZSB7TnVtYmVyfFN0cmluZ3xBcnJheX0gIFRoZSBub3RlKHMpIHlvdSB3aXNoIHRvIHBsYXkuIFRoZSBub3RlcyBjYW4gYmUgc3BlY2lmaWVkIGluCiAgICogb25lIG9mIHR3byB3YXlzLiBUaGUgZmlyc3Qgd2F5IGlzIGJ5IHVzaW5nIHRoZSBNSURJIG5vdGUgbnVtYmVyIChhbiBpbnRlZ2VyIGJldHdlZW4gMCBhbmQgMTI3KS4KICAgKiBUaGUgc2Vjb25kIHdheSBpcyBieSB1c2luZyB0aGUgbm90ZSBuYW1lIGZvbGxvd2VkIGJ5IHRoZSBvY3RhdmUgKEMzLCBHIzQsIEYtMSwgRGI3KS4gVGhlIG9jdGF2ZQogICAqIHJhbmdlIHNob3VsZCBiZSBiZXR3ZWVuIC0yIGFuZCA4LiBUaGUgbG93ZXN0IG5vdGUgaXMgQy0yIChNSURJIG5vdGUgbnVtYmVyIDApIGFuZCB0aGUgaGlnaGVzdAogICAqIG5vdGUgaXMgRzggKE1JREkgbm90ZSBudW1iZXIgMTI3KS4gSXQgaXMgYWxzbyBwb3NzaWJsZSB0byBzcGVjaWZ5IGFuIGFycmF5IG9mIG5vdGUgbnVtYmVycwogICAqIGFuZC9vciBuYW1lcy4KICAgKgogICAqIEBwYXJhbSBbY2hhbm5lbD1hbGxdIHtOdW1iZXJ8QXJyYXl8U3RyaW5nfSBUaGUgTUlESSBjaGFubmVsIG51bWJlciAoYmV0d2VlbiBgMWAgYW5kIGAxNmApIG9yIGFuCiAgICogYXJyYXkgb2YgY2hhbm5lbCBudW1iZXJzLiBJZiB0aGUgc3BlY2lhbCB2YWx1ZSAqKmFsbCoqIGlzIHVzZWQgKGRlZmF1bHQpLCB0aGUgbWVzc2FnZSB3aWxsIGJlCiAgICogc2VudCB0byBhbGwgMTYgY2hhbm5lbHMuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dCiAgICoKICAgKiBAcGFyYW0ge051bWJlcn0gW29wdGlvbnMuZHVyYXRpb249dW5kZWZpbmVkXSBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyAoaW50ZWdlcikgdG8gd2FpdAogICAqIGJlZm9yZSBzZW5kaW5nIGEgbWF0Y2hpbmcgKipub3RlIG9mZioqIGV2ZW50LiBJZiBsZWZ0IHVuZGVmaW5lZCwgb25seSBhICoqbm90ZSBvbioqIG1lc3NhZ2UgaXMKICAgKiBzZW50LgogICAqCiAgICogQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5yYXdWZWxvY2l0eT1mYWxzZV0gQ29udHJvbHMgd2hldGhlciB0aGUgYXR0YWNrIGFuZCByZWxlYXNlIHZlbG9jaXRpZXMKICAgKiBhcmUgc2V0IHVzaW5nIGludGVnZXJzIGJldHdlZW4gYDBgIGFuZCBgMTI3YCAoYHRydWVgKSBvciBhIGRlY2ltYWwgbnVtYmVyIGJldHdlZW4gYDBgIGFuZCBgMWAKICAgKiAoYGZhbHNlYCwgZGVmYXVsdCkuCiAgICoKICAgKiBAcGFyYW0ge051bWJlcn0gW29wdGlvbnMucmVsZWFzZT0wLjVdIFRoZSB2ZWxvY2l0eSBhdCB3aGljaCB0byByZWxlYXNlIHRoZSBub3RlIChiZXR3ZWVuIGAwYAogICAqIGFuZCBgMWApLiBJZiB0aGUgYHJhd1ZlbG9jaXR5YCBvcHRpb24gaXMgYHRydWVgLCB0aGUgdmFsdWUgc2hvdWxkIGJlIHNwZWNpZmllZCBhcyBhbiBpbnRlZ2VyCiAgICogYmV0d2VlbiBgMGAgYW5kIGAxMjdgLiBBbiBpbnZhbGlkIHZlbG9jaXR5IHZhbHVlIHdpbGwgc2lsZW50bHkgdHJpZ2dlciB0aGUgZGVmYXVsdCBvZiBgMC41YC4KICAgKiBUaGlzIGlzIG9ubHkgdXNlZCB3aXRoIHRoZSAqKm5vdGUgb2ZmKiogZXZlbnQgdHJpZ2dlcmVkIHdoZW4gYG9wdGlvbnMuZHVyYXRpb25gIGlzIHNldC4KICAgKgogICAqIEBwYXJhbSB7RE9NSGlnaFJlc1RpbWVTdGFtcHxTdHJpbmd9IFtvcHRpb25zLnRpbWU9dW5kZWZpbmVkXSBUaGlzIHZhbHVlIGNhbiBiZSBvbmUgb2YgdHdvCiAgICogdGhpbmdzLiBJZiB0aGUgdmFsdWUgaXMgYSBzdHJpbmcgc3RhcnRpbmcgd2l0aCB0aGUgKyBzaWduIGFuZCBmb2xsb3dlZCBieSBhIG51bWJlciwgdGhlIHJlcXVlc3QKICAgKiB3aWxsIGJlIGRlbGF5ZWQgYnkgdGhlIHNwZWNpZmllZCBudW1iZXIgKGluIG1pbGxpc2Vjb25kcykuIE90aGVyd2lzZSwgdGhlIHZhbHVlIGlzIGNvbnNpZGVyZWQgYQogICAqIHRpbWVzdGFtcCBhbmQgdGhlIHJlcXVlc3Qgd2lsbCBiZSBzY2hlZHVsZWQgYXQgdGhhdCB0aW1lc3RhbXAuIFRoZSBgRE9NSGlnaFJlc1RpbWVTdGFtcGAgdmFsdWUKICAgKiBpcyByZWxhdGl2ZSB0byB0aGUgbmF2aWdhdGlvbiBzdGFydCBvZiB0aGUgZG9jdW1lbnQuIFRvIHJldHJpZXZlIHRoZSBjdXJyZW50IHRpbWUsIHlvdSBjYW4gdXNlCiAgICogYFdlYk1pZGkudGltZWAuIElmIGB0aW1lYCBpcyBub3QgcHJlc2VudCBvciBpcyBzZXQgdG8gYSB0aW1lIGluIHRoZSBwYXN0LCB0aGUgcmVxdWVzdCBpcyB0byBiZQogICAqIHNlbnQgYXMgc29vbiBhcyBwb3NzaWJsZS4KICAgKgogICAqIEBwYXJhbSB7TnVtYmVyfSBbb3B0aW9ucy52ZWxvY2l0eT0wLjVdIFRoZSB2ZWxvY2l0eSBhdCB3aGljaCB0byBwbGF5IHRoZSBub3RlIChiZXR3ZWVuIGAwYCBhbmQKICAgKiBgMWApLiBJZiB0aGUgYHJhd1ZlbG9jaXR5YCBvcHRpb24gaXMgYHRydWVgLCB0aGUgdmFsdWUgc2hvdWxkIGJlIHNwZWNpZmllZCBhcyBhbiBpbnRlZ2VyCiAgICogYmV0d2VlbiBgMGAgYW5kIGAxMjdgLiBBbiBpbnZhbGlkIHZlbG9jaXR5IHZhbHVlIHdpbGwgc2lsZW50bHkgdHJpZ2dlciB0aGUgZGVmYXVsdCBvZiBgMC41YC4KICAgKgogICAqIEByZXR1cm4ge091dHB1dH0gUmV0dXJucyB0aGUgYE91dHB1dGAgb2JqZWN0IHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICovCgoKICBPdXRwdXQucHJvdG90eXBlLnBsYXlOb3RlID0gZnVuY3Rpb24gKG5vdGUsIGNoYW5uZWwsIG9wdGlvbnMpIHsKICAgIHZhciB0aW1lLAogICAgICAgIG5WZWxvY2l0eSA9IDY0OwogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgaWYgKG9wdGlvbnMucmF3VmVsb2NpdHkpIHsKICAgICAgaWYgKCFpc05hTihvcHRpb25zLnZlbG9jaXR5KSAmJiBvcHRpb25zLnZlbG9jaXR5ID49IDAgJiYgb3B0aW9ucy52ZWxvY2l0eSA8PSAxMjcpIHsKICAgICAgICBuVmVsb2NpdHkgPSBvcHRpb25zLnZlbG9jaXR5OwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoIWlzTmFOKG9wdGlvbnMudmVsb2NpdHkpICYmIG9wdGlvbnMudmVsb2NpdHkgPj0gMCAmJiBvcHRpb25zLnZlbG9jaXR5IDw9IDEpIHsKICAgICAgICBuVmVsb2NpdHkgPSBvcHRpb25zLnZlbG9jaXR5ICogMTI3OwogICAgICB9CiAgICB9CgogICAgdGltZSA9IHRoaXMuX3BhcnNlVGltZVBhcmFtZXRlcihvcHRpb25zLnRpbWUpOyAvLyBTZW5kIG5vdGUgb24gbWVzc2FnZXMKCiAgICB0aGlzLl9jb252ZXJ0Tm90ZVRvQXJyYXkobm90ZSkuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkgewogICAgICB3bS50b01JRElDaGFubmVscyhjaGFubmVsKS5mb3JFYWNoKGZ1bmN0aW9uIChjaCkgewogICAgICAgIHRoaXMuc2VuZCgod20uTUlESV9DSEFOTkVMX01FU1NBR0VTLm5vdGVvbiA8PCA0KSArIChjaCAtIDEpLCBbaXRlbSwgTWF0aC5yb3VuZChuVmVsb2NpdHkpXSwgdGltZSk7CiAgICAgIH0uYmluZCh0aGlzKSk7CiAgICB9LmJpbmQodGhpcykpOyAvLyBTZW5kIG5vdGUgb2ZmIG1lc3NhZ2VzIChvbmx5IGlmIGEgdmFsaWQgZHVyYXRpb24gaGFzIGJlZW4gZGVmaW5lZCkKCgogICAgaWYgKCFpc05hTihvcHRpb25zLmR1cmF0aW9uKSkgewogICAgICBpZiAob3B0aW9ucy5kdXJhdGlvbiA8PSAwKSB7CiAgICAgICAgb3B0aW9ucy5kdXJhdGlvbiA9IDA7CiAgICAgIH0KCiAgICAgIHZhciBuUmVsZWFzZSA9IDY0OwoKICAgICAgaWYgKG9wdGlvbnMucmF3VmVsb2NpdHkpIHsKICAgICAgICBpZiAoIWlzTmFOKG9wdGlvbnMucmVsZWFzZSkgJiYgb3B0aW9ucy5yZWxlYXNlID49IDAgJiYgb3B0aW9ucy5yZWxlYXNlIDw9IDEyNykgewogICAgICAgICAgblJlbGVhc2UgPSBvcHRpb25zLnJlbGVhc2U7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmICghaXNOYU4ob3B0aW9ucy5yZWxlYXNlKSAmJiBvcHRpb25zLnJlbGVhc2UgPj0gMCAmJiBvcHRpb25zLnJlbGVhc2UgPD0gMSkgewogICAgICAgICAgblJlbGVhc2UgPSBvcHRpb25zLnJlbGVhc2UgKiAxMjc7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLl9jb252ZXJ0Tm90ZVRvQXJyYXkobm90ZSkuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkgewogICAgICAgIHdtLnRvTUlESUNoYW5uZWxzKGNoYW5uZWwpLmZvckVhY2goZnVuY3Rpb24gKGNoKSB7CiAgICAgICAgICB0aGlzLnNlbmQoKHdtLk1JRElfQ0hBTk5FTF9NRVNTQUdFUy5ub3Rlb2ZmIDw8IDQpICsgKGNoIC0gMSksIFtpdGVtLCBNYXRoLnJvdW5kKG5SZWxlYXNlKV0sICh0aW1lIHx8IHdtLnRpbWUpICsgb3B0aW9ucy5kdXJhdGlvbik7CiAgICAgICAgfS5iaW5kKHRoaXMpKTsKICAgICAgfS5iaW5kKHRoaXMpKTsKICAgIH0KCiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIFNlbmRzIGEgTUlESSBga2V5IGFmdGVydG91Y2hgIG1lc3NhZ2UgdG8gdGhlIHNwZWNpZmllZCBjaGFubmVsKHMpIGF0IHRoZSBzY2hlZHVsZWQgdGltZS4gVGhpcwogICAqIGlzIGEga2V5LXNwZWNpZmljIGFmdGVydG91Y2guIEZvciBhIGNoYW5uZWwtd2lkZSBhZnRlcnRvdWNoIG1lc3NhZ2UsIHVzZQogICAqIHt7I2Nyb3NzTGluayAiV2ViTWlkaS9zZW5kQ2hhbm5lbEFmdGVydG91Y2g6bWV0aG9kIn19c2VuZENoYW5uZWxBZnRlcnRvdWNoKCl7ey9jcm9zc0xpbmt9fS4KICAgKgogICAqIEBtZXRob2Qgc2VuZEtleUFmdGVydG91Y2gKICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0gbm90ZSB7TnVtYmVyfFN0cmluZ3xBcnJheX0gIFRoZSBub3RlIGZvciB3aGljaCB5b3UgYXJlIHNlbmRpbmcgYW4gYWZ0ZXJ0b3VjaCB2YWx1ZS4gVGhlCiAgICogbm90ZXMgY2FuIGJlIHNwZWNpZmllZCBpbiBvbmUgb2YgdHdvIHdheXMuIFRoZSBmaXJzdCB3YXkgaXMgYnkgdXNpbmcgdGhlIE1JREkgbm90ZSBudW1iZXIgKGFuCiAgICogaW50ZWdlciBiZXR3ZWVuIDAgYW5kIDEyNykuIFRoZSBzZWNvbmQgd2F5IGlzIGJ5IHVzaW5nIHRoZSBub3RlIG5hbWUgZm9sbG93ZWQgYnkgdGhlIG9jdGF2ZQogICAqIChDMywgRyM0LCBGLTEsIERiNykuIFRoZSBvY3RhdmUgcmFuZ2Ugc2hvdWxkIGJlIGJldHdlZW4gLTIgYW5kIDguIFRoZSBsb3dlc3Qgbm90ZSBpcyBDLTIgKE1JREkKICAgKiBub3RlIG51bWJlciAwKSBhbmQgdGhlIGhpZ2hlc3Qgbm90ZSBpcyBHOCAoTUlESSBub3RlIG51bWJlciAxMjcpLiBJdCBpcyBhbHNvIHBvc3NpYmxlIHRvIHVzZQogICAqIGFuIGFycmF5IG9mIG5vdGUgbmFtZXMgYW5kL29yIG51bWJlcnMuCiAgICoKICAgKiBAcGFyYW0gW2NoYW5uZWw9YWxsXSB7TnVtYmVyfEFycmF5fFN0cmluZ30gVGhlIE1JREkgY2hhbm5lbCBudW1iZXIgKGJldHdlZW4gMSBhbmQgMTYpIG9yIGFuCiAgICogYXJyYXkgb2YgY2hhbm5lbCBudW1iZXJzLiBJZiB0aGUgc3BlY2lhbCB2YWx1ZSAiYWxsIiBpcyB1c2VkLCB0aGUgbWVzc2FnZSB3aWxsIGJlIHNlbnQgdG8gYWxsCiAgICogMTYgY2hhbm5lbHMuCiAgICoKICAgKiBAcGFyYW0ge051bWJlcn0gW3ByZXNzdXJlPTAuNV0gVGhlIHByZXNzdXJlIGxldmVsIHRvIHNlbmQgKGJldHdlZW4gMCBhbmQgMSkuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dCiAgICoKICAgKiBAcGFyYW0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB8U3RyaW5nfSBbb3B0aW9ucy50aW1lPXVuZGVmaW5lZF0gVGhpcyB2YWx1ZSBjYW4gYmUgb25lIG9mIHR3bwogICAqIHRoaW5ncy4gSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHN0YXJ0aW5nIHdpdGggdGhlICsgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsIHRoZSByZXF1ZXN0CiAgICogd2lsbCBiZSBkZWxheWVkIGJ5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIChpbiBtaWxsaXNlY29uZHMpLiBPdGhlcndpc2UsIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEKICAgKiB0aW1lc3RhbXAgYW5kIHRoZSByZXF1ZXN0IHdpbGwgYmUgc2NoZWR1bGVkIGF0IHRoYXQgdGltZXN0YW1wLiBUaGUgYERPTUhpZ2hSZXNUaW1lU3RhbXBgIHZhbHVlCiAgICogaXMgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LiBUbyByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lLCB5b3UgY2FuIHVzZQogICAqIGBXZWJNaWRpLnRpbWVgLiBJZiBgdGltZWAgaXMgbm90IHByZXNlbnQgb3IgaXMgc2V0IHRvIGEgdGltZSBpbiB0aGUgcGFzdCwgdGhlIHJlcXVlc3QgaXMgdG8gYmUKICAgKiBzZW50IGFzIHNvb24gYXMgcG9zc2libGUuCiAgICoKICAgKiBAdGhyb3dzIHtSYW5nZUVycm9yfSBUaGUgY2hhbm5lbCBtdXN0IGJlIGJldHdlZW4gMSBhbmQgMTYuCiAgICoKICAgKiBAcmV0dXJuIHtPdXRwdXR9IFJldHVybnMgdGhlIGBPdXRwdXRgIG9iamVjdCBzbyBtZXRob2RzIGNhbiBiZSBjaGFpbmVkLgogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5zZW5kS2V5QWZ0ZXJ0b3VjaCA9IGZ1bmN0aW9uIChub3RlLCBjaGFubmVsLCBwcmVzc3VyZSwgb3B0aW9ucykgewogICAgdmFyIHRoYXQgPSB0aGlzOwogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgaWYgKGNoYW5uZWwgPCAxIHx8IGNoYW5uZWwgPiAxNikgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigiVGhlIGNoYW5uZWwgbXVzdCBiZSBiZXR3ZWVuIDEgYW5kIDE2LiIpOwogICAgfQoKICAgIGlmIChpc05hTihwcmVzc3VyZSkgfHwgcHJlc3N1cmUgPCAwIHx8IHByZXNzdXJlID4gMSkgewogICAgICBwcmVzc3VyZSA9IDAuNTsKICAgIH0KCiAgICB2YXIgblByZXNzdXJlID0gTWF0aC5yb3VuZChwcmVzc3VyZSAqIDEyNyk7CgogICAgdGhpcy5fY29udmVydE5vdGVUb0FycmF5KG5vdGUpLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgd20udG9NSURJQ2hhbm5lbHMoY2hhbm5lbCkuZm9yRWFjaChmdW5jdGlvbiAoY2gpIHsKICAgICAgICB0aGF0LnNlbmQoKHdtLk1JRElfQ0hBTk5FTF9NRVNTQUdFUy5rZXlhZnRlcnRvdWNoIDw8IDQpICsgKGNoIC0gMSksIFtpdGVtLCBuUHJlc3N1cmVdLCB0aGF0Ll9wYXJzZVRpbWVQYXJhbWV0ZXIob3B0aW9ucy50aW1lKSk7CiAgICAgIH0pOwogICAgfSk7CgogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBTZW5kcyBhIE1JREkgYGNvbnRyb2wgY2hhbmdlYCBtZXNzYWdlIChhLmsuYS4gQ0MgbWVzc2FnZSkgdG8gdGhlIHNwZWNpZmllZCBjaGFubmVsKHMpIGF0IHRoZQogICAqIHNjaGVkdWxlZCB0aW1lLiBUaGUgY29udHJvbCBjaGFuZ2UgbWVzc2FnZSB0byBzZW5kIGNhbiBiZSBzcGVjaWZpZWQgbnVtZXJpY2FsbHkgb3IgYnkgdXNpbmcgb25lCiAgICogb2YgdGhlIGZvbGxvd2luZyBjb21tb24gbmFtZXM6CiAgICoKICAgKiAgKiBgYmFua3NlbGVjdGNvYXJzZWAgKCMwKQogICAqICAqIGBtb2R1bGF0aW9ud2hlZWxjb2Fyc2VgICgjMSkKICAgKiAgKiBgYnJlYXRoY29udHJvbGxlcmNvYXJzZWAgKCMyKQogICAqICAqIGBmb290Y29udHJvbGxlcmNvYXJzZWAgKCM0KQogICAqICAqIGBwb3J0YW1lbnRvdGltZWNvYXJzZWAgKCM1KQogICAqICAqIGBkYXRhZW50cnljb2Fyc2VgICgjNikKICAgKiAgKiBgdm9sdW1lY29hcnNlYCAoIzcpCiAgICogICogYGJhbGFuY2Vjb2Fyc2VgICgjOCkKICAgKiAgKiBgcGFuY29hcnNlYCAoIzEwKQogICAqICAqIGBleHByZXNzaW9uY29hcnNlYCAoIzExKQogICAqICAqIGBlZmZlY3Rjb250cm9sMWNvYXJzZWAgKCMxMikKICAgKiAgKiBgZWZmZWN0Y29udHJvbDJjb2Fyc2VgICgjMTMpCiAgICogICogYGdlbmVyYWxwdXJwb3Nlc2xpZGVyMWAgKCMxNikKICAgKiAgKiBgZ2VuZXJhbHB1cnBvc2VzbGlkZXIyYCAoIzE3KQogICAqICAqIGBnZW5lcmFscHVycG9zZXNsaWRlcjNgICgjMTgpCiAgICogICogYGdlbmVyYWxwdXJwb3Nlc2xpZGVyNGAgKCMxOSkKICAgKiAgKiBgYmFua3NlbGVjdGZpbmVgICgjMzIpCiAgICogICogYG1vZHVsYXRpb253aGVlbGZpbmVgICgjMzMpCiAgICogICogYGJyZWF0aGNvbnRyb2xsZXJmaW5lYCAoIzM0KQogICAqICAqIGBmb290Y29udHJvbGxlcmZpbmVgICgjMzYpCiAgICogICogYHBvcnRhbWVudG90aW1lZmluZWAgKCMzNykKICAgKiAgKiBgZGF0YWVudHJ5ZmluZWAgKCMzOCkKICAgKiAgKiBgdm9sdW1lZmluZWAgKCMzOSkKICAgKiAgKiBgYmFsYW5jZWZpbmVgICgjNDApCiAgICogICogYHBhbmZpbmVgICgjNDIpCiAgICogICogYGV4cHJlc3Npb25maW5lYCAoIzQzKQogICAqICAqIGBlZmZlY3Rjb250cm9sMWZpbmVgICgjNDQpCiAgICogICogYGVmZmVjdGNvbnRyb2wyZmluZWAgKCM0NSkKICAgKiAgKiBgaG9sZHBlZGFsYCAoIzY0KQogICAqICAqIGBwb3J0YW1lbnRvYCAoIzY1KQogICAqICAqIGBzdXN0ZW51dG9wZWRhbGAgKCM2NikKICAgKiAgKiBgc29mdHBlZGFsYCAoIzY3KQogICAqICAqIGBsZWdhdG9wZWRhbGAgKCM2OCkKICAgKiAgKiBgaG9sZDJwZWRhbGAgKCM2OSkKICAgKiAgKiBgc291bmR2YXJpYXRpb25gICgjNzApCiAgICogICogYHJlc29uYW5jZWAgKCM3MSkKICAgKiAgKiBgc291bmRyZWxlYXNldGltZWAgKCM3MikKICAgKiAgKiBgc291bmRhdHRhY2t0aW1lYCAoIzczKQogICAqICAqIGBicmlnaHRuZXNzYCAoIzc0KQogICAqICAqIGBzb3VuZGNvbnRyb2w2YCAoIzc1KQogICAqICAqIGBzb3VuZGNvbnRyb2w3YCAoIzc2KQogICAqICAqIGBzb3VuZGNvbnRyb2w4YCAoIzc3KQogICAqICAqIGBzb3VuZGNvbnRyb2w5YCAoIzc4KQogICAqICAqIGBzb3VuZGNvbnRyb2wxMGAgKCM3OSkKICAgKiAgKiBgZ2VuZXJhbHB1cnBvc2VidXR0b24xYCAoIzgwKQogICAqICAqIGBnZW5lcmFscHVycG9zZWJ1dHRvbjJgICgjODEpCiAgICogICogYGdlbmVyYWxwdXJwb3NlYnV0dG9uM2AgKCM4MikKICAgKiAgKiBgZ2VuZXJhbHB1cnBvc2VidXR0b240YCAoIzgzKQogICAqICAqIGByZXZlcmJsZXZlbGAgKCM5MSkKICAgKiAgKiBgdHJlbW9sb2xldmVsYCAoIzkyKQogICAqICAqIGBjaG9ydXNsZXZlbGAgKCM5MykKICAgKiAgKiBgY2VsZXN0ZWxldmVsYCAoIzk0KQogICAqICAqIGBwaGFzZXJsZXZlbGAgKCM5NSkKICAgKiAgKiBgZGF0YWJ1dHRvbmluY3JlbWVudGAgKCM5NikKICAgKiAgKiBgZGF0YWJ1dHRvbmRlY3JlbWVudGAgKCM5NykKICAgKiAgKiBgbm9ucmVnaXN0ZXJlZHBhcmFtZXRlcmNvYXJzZWAgKCM5OCkKICAgKiAgKiBgbm9ucmVnaXN0ZXJlZHBhcmFtZXRlcmZpbmVgICgjOTkpCiAgICogICogYHJlZ2lzdGVyZWRwYXJhbWV0ZXJjb2Fyc2VgICgjMTAwKQogICAqICAqIGByZWdpc3RlcmVkcGFyYW1ldGVyZmluZWAgKCMxMDEpCiAgICoKICAgKiBOb3RlOiBhcyB5b3UgY2FuIHNlZSBhYm92ZSwgbm90IGFsbCBjb250cm9sIGNoYW5nZSBtZXNzYWdlIGhhdmUgYSBtYXRjaGluZyBjb21tb24gbmFtZS4gVGhpcwogICAqIGRvZXMgbm90IG1lYW4geW91IGNhbm5vdCB1c2UgdGhlIG90aGVycy4gSXQgc2ltcGx5IG1lYW5zIHlvdSB3aWxsIG5lZWQgdG8gdXNlIHRoZWlyIG51bWJlcgogICAqIGluc3RlYWQgb2YgdGhlaXIgbmFtZS4KICAgKgogICAqIFRvIHZpZXcgYSBsaXN0IG9mIGFsbCBhdmFpbGFibGUgYGNvbnRyb2wgY2hhbmdlYCBtZXNzYWdlcywgcGxlYXNlIGNvbnN1bHQgIlRhYmxlIDMgLSBDb250cm9sCiAgICogQ2hhbmdlIE1lc3NhZ2VzIiBmcm9tIHRoZSBbTUlESSBNZXNzYWdlc10oCiAgICogaHR0cHM6Ly93d3cubWlkaS5vcmcvc3BlY2lmaWNhdGlvbnMvaXRlbS90YWJsZS0zLWNvbnRyb2wtY2hhbmdlLW1lc3NhZ2VzLWRhdGEtYnl0ZXMtMikKICAgKiBzcGVjaWZpY2F0aW9uLgogICAqCiAgICogQG1ldGhvZCBzZW5kQ29udHJvbENoYW5nZQogICAqIEBjaGFpbmFibGUKICAgKgogICAqIEBwYXJhbSBjb250cm9sbGVyIHtOdW1iZXJ8U3RyaW5nfSBUaGUgTUlESSBjb250cm9sbGVyIG51bWJlciAoMC0xMTkpIG9yIG5hbWUuCiAgICoKICAgKiBAcGFyYW0gW3ZhbHVlPTBdIHtOdW1iZXJ9IFRoZSB2YWx1ZSB0byBzZW5kICgwLTEyNykuCiAgICoKICAgKiBAcGFyYW0gW2NoYW5uZWw9YWxsXSB7TnVtYmVyfEFycmF5fFN0cmluZ30gVGhlIE1JREkgY2hhbm5lbCBudW1iZXIgKGJldHdlZW4gMSBhbmQgMTYpIG9yIGFuCiAgICogYXJyYXkgb2YgY2hhbm5lbCBudW1iZXJzLiBJZiB0aGUgc3BlY2lhbCB2YWx1ZSAiYWxsIiBpcyB1c2VkLCB0aGUgbWVzc2FnZSB3aWxsIGJlIHNlbnQgdG8gYWxsCiAgICogMTYgY2hhbm5lbHMuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dCiAgICoKICAgKiBAcGFyYW0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB8U3RyaW5nfSBbb3B0aW9ucy50aW1lPXVuZGVmaW5lZF0gVGhpcyB2YWx1ZSBjYW4gYmUgb25lIG9mIHR3bwogICAqIHRoaW5ncy4gSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHN0YXJ0aW5nIHdpdGggdGhlICsgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsIHRoZSByZXF1ZXN0CiAgICogd2lsbCBiZSBkZWxheWVkIGJ5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIChpbiBtaWxsaXNlY29uZHMpLiBPdGhlcndpc2UsIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEKICAgKiB0aW1lc3RhbXAgYW5kIHRoZSByZXF1ZXN0IHdpbGwgYmUgc2NoZWR1bGVkIGF0IHRoYXQgdGltZXN0YW1wLiBUaGUgYERPTUhpZ2hSZXNUaW1lU3RhbXBgIHZhbHVlCiAgICogaXMgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LiBUbyByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lLCB5b3UgY2FuIHVzZQogICAqIGBXZWJNaWRpLnRpbWVgLiBJZiBgdGltZWAgaXMgbm90IHByZXNlbnQgb3IgaXMgc2V0IHRvIGEgdGltZSBpbiB0aGUgcGFzdCwgdGhlIHJlcXVlc3QgaXMgdG8gYmUKICAgKiBzZW50IGFzIHNvb24gYXMgcG9zc2libGUuCiAgICoKICAgKiBAdGhyb3dzIHtSYW5nZUVycm9yfSBDb250cm9sbGVyIG51bWJlcnMgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDExOS4KICAgKiBAdGhyb3dzIHtSYW5nZUVycm9yfSBWYWx1ZSBtdXN0IGJlIGJldHdlZW4gMCBhbmQgMTI3LgogICAqCiAgICogQHJldHVybiB7T3V0cHV0fSBSZXR1cm5zIHRoZSBgT3V0cHV0YCBvYmplY3Qgc28gbWV0aG9kcyBjYW4gYmUgY2hhaW5lZC4KICAgKi8KCgogIE91dHB1dC5wcm90b3R5cGUuc2VuZENvbnRyb2xDaGFuZ2UgPSBmdW5jdGlvbiAoY29udHJvbGxlciwgdmFsdWUsIGNoYW5uZWwsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgIGlmICh0eXBlb2YgY29udHJvbGxlciA9PT0gInN0cmluZyIpIHsKICAgICAgY29udHJvbGxlciA9IHdtLk1JRElfQ09OVFJPTF9DSEFOR0VfTUVTU0FHRVNbY29udHJvbGxlcl07CiAgICAgIGlmIChjb250cm9sbGVyID09PSB1bmRlZmluZWQpIHRocm93IG5ldyBUeXBlRXJyb3IoIkludmFsaWQgY29udHJvbGxlciBuYW1lLiIpOwogICAgfSBlbHNlIHsKICAgICAgY29udHJvbGxlciA9IE1hdGguZmxvb3IoY29udHJvbGxlcik7CgogICAgICBpZiAoIShjb250cm9sbGVyID49IDAgJiYgY29udHJvbGxlciA8PSAxMTkpKSB7CiAgICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIkNvbnRyb2xsZXIgbnVtYmVycyBtdXN0IGJlIGJldHdlZW4gMCBhbmQgMTE5LiIpOwogICAgICB9CiAgICB9CgogICAgdmFsdWUgPSBNYXRoLmZsb29yKHZhbHVlKSB8fCAwOwoKICAgIGlmICghKHZhbHVlID49IDAgJiYgdmFsdWUgPD0gMTI3KSkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigiQ29udHJvbGxlciB2YWx1ZSBtdXN0IGJlIGJldHdlZW4gMCBhbmQgMTI3LiIpOwogICAgfQoKICAgIHdtLnRvTUlESUNoYW5uZWxzKGNoYW5uZWwpLmZvckVhY2goZnVuY3Rpb24gKGNoKSB7CiAgICAgIHRoaXMuc2VuZCgod20uTUlESV9DSEFOTkVMX01FU1NBR0VTLmNvbnRyb2xjaGFuZ2UgPDwgNCkgKyAoY2ggLSAxKSwgW2NvbnRyb2xsZXIsIHZhbHVlXSwgdGhpcy5fcGFyc2VUaW1lUGFyYW1ldGVyKG9wdGlvbnMudGltZSkpOwogICAgfS5iaW5kKHRoaXMpKTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgLyoqCiAgICogU2VsZWN0cyBhIE1JREkgcmVnaXN0ZXJlZCBwYXJhbWV0ZXIgc28gaXQgaXMgYWZmZWN0ZWQgYnkgZGF0YSBlbnRyeSwgZGF0YSBpbmNyZW1lbnQgYW5kIGRhdGEKICAgKiBkZWNyZW1lbnQgbWVzc2FnZXMuCiAgICoKICAgKiBAbWV0aG9kIF9zZWxlY3RSZWdpc3RlcmVkUGFyYW1ldGVyCiAgICogQHByb3RlY3RlZAogICAqCiAgICogQHBhcmFtIHBhcmFtZXRlciB7QXJyYXl9IEEgdHdvLXBvc2l0aW9uIGFycmF5IHNwZWNpZnlpbmcgdGhlIHR3byBjb250cm9sIGJ5dGVzICgweDY1LCAweDY0KQogICAqIHRoYXQgaWRlbnRpZnkgdGhlIHJlZ2lzdGVyZWQgcGFyYW1ldGVyLgogICAqIEBwYXJhbSBjaGFubmVsCiAgICogQHBhcmFtIHRpbWUKICAgKgogICAqIEByZXR1cm5zIHtPdXRwdXR9CiAgICovCgoKICBPdXRwdXQucHJvdG90eXBlLl9zZWxlY3RSZWdpc3RlcmVkUGFyYW1ldGVyID0gZnVuY3Rpb24gKHBhcmFtZXRlciwgY2hhbm5lbCwgdGltZSkgewogICAgdmFyIHRoYXQgPSB0aGlzOwogICAgcGFyYW1ldGVyWzBdID0gTWF0aC5mbG9vcihwYXJhbWV0ZXJbMF0pOwoKICAgIGlmICghKHBhcmFtZXRlclswXSA+PSAwICYmIHBhcmFtZXRlclswXSA8PSAxMjcpKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJUaGUgY29udHJvbDY1IHZhbHVlIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxMjciKTsKICAgIH0KCiAgICBwYXJhbWV0ZXJbMV0gPSBNYXRoLmZsb29yKHBhcmFtZXRlclsxXSk7CgogICAgaWYgKCEocGFyYW1ldGVyWzFdID49IDAgJiYgcGFyYW1ldGVyWzFdIDw9IDEyNykpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIlRoZSBjb250cm9sNjQgdmFsdWUgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDEyNyIpOwogICAgfQoKICAgIHdtLnRvTUlESUNoYW5uZWxzKGNoYW5uZWwpLmZvckVhY2goZnVuY3Rpb24gKCkgewogICAgICB0aGF0LnNlbmRDb250cm9sQ2hhbmdlKDB4NjUsIHBhcmFtZXRlclswXSwgY2hhbm5lbCwgewogICAgICAgIHRpbWU6IHRpbWUKICAgICAgfSk7CiAgICAgIHRoYXQuc2VuZENvbnRyb2xDaGFuZ2UoMHg2NCwgcGFyYW1ldGVyWzFdLCBjaGFubmVsLCB7CiAgICAgICAgdGltZTogdGltZQogICAgICB9KTsKICAgIH0pOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBTZWxlY3RzIGEgTUlESSBub24tcmVnaXN0ZXJlZCBwYXJhbWV0ZXIgc28gaXQgaXMgYWZmZWN0ZWQgYnkgZGF0YSBlbnRyeSwgZGF0YSBpbmNyZW1lbnQgYW5kCiAgICogZGF0YSBkZWNyZW1lbnQgbWVzc2FnZXMuCiAgICoKICAgKiBAbWV0aG9kIF9zZWxlY3ROb25SZWdpc3RlcmVkUGFyYW1ldGVyCiAgICogQHByb3RlY3RlZAogICAqCiAgICogQHBhcmFtIHBhcmFtZXRlciB7QXJyYXl9IEEgdHdvLXBvc2l0aW9uIGFycmF5IHNwZWNpZnlpbmcgdGhlIHR3byBjb250cm9sIGJ5dGVzICgweDYzLCAweDYyKQogICAqIHRoYXQgaWRlbnRpZnkgdGhlIHJlZ2lzdGVyZWQgcGFyYW1ldGVyLgogICAqIEBwYXJhbSBjaGFubmVsCiAgICogQHBhcmFtIHRpbWUKICAgKgogICAqIEByZXR1cm5zIHtPdXRwdXR9CiAgICovCgoKICBPdXRwdXQucHJvdG90eXBlLl9zZWxlY3ROb25SZWdpc3RlcmVkUGFyYW1ldGVyID0gZnVuY3Rpb24gKHBhcmFtZXRlciwgY2hhbm5lbCwgdGltZSkgewogICAgdmFyIHRoYXQgPSB0aGlzOwogICAgcGFyYW1ldGVyWzBdID0gTWF0aC5mbG9vcihwYXJhbWV0ZXJbMF0pOwoKICAgIGlmICghKHBhcmFtZXRlclswXSA+PSAwICYmIHBhcmFtZXRlclswXSA8PSAxMjcpKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJUaGUgY29udHJvbDYzIHZhbHVlIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxMjciKTsKICAgIH0KCiAgICBwYXJhbWV0ZXJbMV0gPSBNYXRoLmZsb29yKHBhcmFtZXRlclsxXSk7CgogICAgaWYgKCEocGFyYW1ldGVyWzFdID49IDAgJiYgcGFyYW1ldGVyWzFdIDw9IDEyNykpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIlRoZSBjb250cm9sNjIgdmFsdWUgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDEyNyIpOwogICAgfQoKICAgIHdtLnRvTUlESUNoYW5uZWxzKGNoYW5uZWwpLmZvckVhY2goZnVuY3Rpb24gKCkgewogICAgICB0aGF0LnNlbmRDb250cm9sQ2hhbmdlKDB4NjMsIHBhcmFtZXRlclswXSwgY2hhbm5lbCwgewogICAgICAgIHRpbWU6IHRpbWUKICAgICAgfSk7CiAgICAgIHRoYXQuc2VuZENvbnRyb2xDaGFuZ2UoMHg2MiwgcGFyYW1ldGVyWzFdLCBjaGFubmVsLCB7CiAgICAgICAgdGltZTogdGltZQogICAgICB9KTsKICAgIH0pOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBTZXRzIHRoZSB2YWx1ZSBvZiB0aGUgY3VycmVudGx5IHNlbGVjdGVkIE1JREkgcmVnaXN0ZXJlZCBwYXJhbWV0ZXIuCiAgICoKICAgKiBAbWV0aG9kIF9zZXRDdXJyZW50UmVnaXN0ZXJlZFBhcmFtZXRlcgogICAqIEBwcm90ZWN0ZWQKICAgKgogICAqIEBwYXJhbSBkYXRhIHtpbnR8QXJyYXl9CiAgICogQHBhcmFtIGNoYW5uZWwKICAgKiBAcGFyYW0gdGltZQogICAqCiAgICogQHJldHVybnMge091dHB1dH0KICAgKi8KCgogIE91dHB1dC5wcm90b3R5cGUuX3NldEN1cnJlbnRSZWdpc3RlcmVkUGFyYW1ldGVyID0gZnVuY3Rpb24gKGRhdGEsIGNoYW5uZWwsIHRpbWUpIHsKICAgIHZhciB0aGF0ID0gdGhpczsKICAgIGRhdGEgPSBbXS5jb25jYXQoZGF0YSk7CiAgICBkYXRhWzBdID0gTWF0aC5mbG9vcihkYXRhWzBdKTsKCiAgICBpZiAoIShkYXRhWzBdID49IDAgJiYgZGF0YVswXSA8PSAxMjcpKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJUaGUgbXNiIHZhbHVlIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxMjciKTsKICAgIH0KCiAgICB3bS50b01JRElDaGFubmVscyhjaGFubmVsKS5mb3JFYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgdGhhdC5zZW5kQ29udHJvbENoYW5nZSgweDA2LCBkYXRhWzBdLCBjaGFubmVsLCB7CiAgICAgICAgdGltZTogdGltZQogICAgICB9KTsKICAgIH0pOwogICAgZGF0YVsxXSA9IE1hdGguZmxvb3IoZGF0YVsxXSk7CgogICAgaWYgKGRhdGFbMV0gPj0gMCAmJiBkYXRhWzFdIDw9IDEyNykgewogICAgICB3bS50b01JRElDaGFubmVscyhjaGFubmVsKS5mb3JFYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICB0aGF0LnNlbmRDb250cm9sQ2hhbmdlKDB4MjYsIGRhdGFbMV0sIGNoYW5uZWwsIHsKICAgICAgICAgIHRpbWU6IHRpbWUKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBEZXNlbGVjdHMgdGhlIGN1cnJlbnRseSBhY3RpdmUgTUlESSByZWdpc3RlcmVkIHBhcmFtZXRlciBzbyBpdCBpcyBubyBsb25nZXIgYWZmZWN0ZWQgYnkgZGF0YQogICAqIGVudHJ5LCBkYXRhIGluY3JlbWVudCBhbmQgZGF0YSBkZWNyZW1lbnQgbWVzc2FnZXMuCiAgICoKICAgKiBDdXJyZW50IGJlc3QgcHJhY3RpY2UgcmVjb21tZW5kcyBkb2luZyB0aGF0IGFmdGVyIGVhY2ggY2FsbCB0bwogICAqIGBfc2V0Q3VycmVudFJlZ2lzdGVyZWRQYXJhbWV0ZXIoKWAuCiAgICoKICAgKiBAbWV0aG9kIF9kZXNlbGVjdFJlZ2lzdGVyZWRQYXJhbWV0ZXIKICAgKiBAcHJvdGVjdGVkCiAgICoKICAgKiBAcGFyYW0gY2hhbm5lbAogICAqIEBwYXJhbSB0aW1lCiAgICoKICAgKiBAcmV0dXJucyB7T3V0cHV0fQogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5fZGVzZWxlY3RSZWdpc3RlcmVkUGFyYW1ldGVyID0gZnVuY3Rpb24gKGNoYW5uZWwsIHRpbWUpIHsKICAgIHZhciB0aGF0ID0gdGhpczsKICAgIHdtLnRvTUlESUNoYW5uZWxzKGNoYW5uZWwpLmZvckVhY2goZnVuY3Rpb24gKCkgewogICAgICB0aGF0LnNlbmRDb250cm9sQ2hhbmdlKDB4NjUsIDB4N0YsIGNoYW5uZWwsIHsKICAgICAgICB0aW1lOiB0aW1lCiAgICAgIH0pOwogICAgICB0aGF0LnNlbmRDb250cm9sQ2hhbmdlKDB4NjQsIDB4N0YsIGNoYW5uZWwsIHsKICAgICAgICB0aW1lOiB0aW1lCiAgICAgIH0pOwogICAgfSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIFNldHMgdGhlIHNwZWNpZmllZCBNSURJIHJlZ2lzdGVyZWQgcGFyYW1ldGVyIHRvIHRoZSBkZXNpcmVkIHZhbHVlLiBUaGUgdmFsdWUgaXMgZGVmaW5lZCB3aXRoCiAgICogdXAgdG8gdHdvIGJ5dGVzIG9mIGRhdGEgdGhhdCBlYWNoIGNhbiBnbyBmcm9tIDAgdG8gMTI3LgogICAqCiAgICogPlVubGVzcyB5b3UgYXJlIHZlcnkgZmFtaWxpYXIgd2l0aCB0aGUgTUlESSBzdGFuZGFyZCB5b3UgcHJvYmFibHkgc2hvdWxkIGZhdm91ciBvbmUgb2YgdGhlCiAgICogPnNpbXBsZXIgdG8gdXNlIGZ1bmN0aW9ucyBzdWNoIGFzOiBgc2V0UGl0Y2hiZW5kUmFuZ2UoKWAsIGBzZXRNb2R1bGF0aW9uUmFuZ2UoKWAsCiAgICogPmBzZXRNYXN0ZXJUdW5pbmcoKWAsIGV0Yy4KICAgKgogICAqIE1JREkgcmVnaXN0ZXJlZCBwYXJhbWV0ZXJzIGV4dGVuZCB0aGUgb3JpZ2luYWwgbGlzdCBvZiBjb250cm9sIGNoYW5nZSBtZXNzYWdlcy4gQ3VycmVudGx5LAogICAqIHRoZXJlIGFyZSBvbmx5IGEgbGltaXRlZCBudW1iZXIgb2YgdGhlbS4gSGVyZSBhcmUgdGhlIG9yaWdpbmFsIHJlZ2lzdGVyZWQgcGFyYW1ldGVycyB3aXRoIHRoZQogICAqIGlkZW50aWZpZXIgdGhhdCBjYW4gYmUgdXNlZCBhcyB0aGUgZmlyc3QgcGFyYW1ldGVyIG9mIHRoaXMgZnVuY3Rpb246CiAgICoKICAgKiAgKiBQaXRjaGJlbmQgUmFuZ2UgKDB4MDAsIDB4MDApOiBgcGl0Y2hiZW5kcmFuZ2VgCiAgICogICogQ2hhbm5lbCBGaW5lIFR1bmluZyAoMHgwMCwgMHgwMSk6IGBjaGFubmVsZmluZXR1bmluZ2AKICAgKiAgKiBDaGFubmVsIENvYXJzZSBUdW5pbmcgKDB4MDAsIDB4MDIpOiBgY2hhbm5lbGNvYXJzZXR1bmluZ2AKICAgKiAgKiBUdW5pbmcgUHJvZ3JhbSAoMHgwMCwgMHgwMyk6IGB0dW5pbmdwcm9ncmFtYAogICAqICAqIFR1bmluZyBCYW5rICgweDAwLCAweDA0KTogYHR1bmluZ2JhbmtgCiAgICogICogTW9kdWxhdGlvbiBSYW5nZSAoMHgwMCwgMHgwNSk6IGBtb2R1bGF0aW9ucmFuZ2VgCiAgICoKICAgKiBOb3RlIHRoYXQgdGhlICoqVHVuaW5nIFByb2dyYW0qKiBhbmQgKipUdW5pbmcgQmFuayoqIHBhcmFtZXRlcnMgYXJlIHBhcnQgb2YgdGhlICpNSURJIFR1bmluZwogICAqIFN0YW5kYXJkKiwgd2hpY2ggaXMgbm90IHdpZGVseSBpbXBsZW1lbnRlZC4KICAgKgogICAqIEFub3RoZXIgc2V0IG9mIGV4dHJhIHBhcmFtZXRlcnMgaGF2ZSBiZWVuIGxhdGVyIGFkZGVkIGZvciAzRCBzb3VuZCBjb250cm9sbGVycy4gVGhleSBhcmU6CiAgICoKICAgKiAgKiBBemltdXRoIEFuZ2xlICgweDNELCAweDAwKTogYGF6aW11dGhhbmdsZWAKICAgKiAgKiBFbGV2YXRpb24gQW5nbGUgKDB4M0QsIDB4MDEpOiBgZWxldmF0aW9uYW5nbGVgCiAgICogICogR2FpbiAoMHgzRCwgMHgwMik6IGBnYWluYAogICAqICAqIERpc3RhbmNlIFJhdGlvICgweDNELCAweDAzKTogYGRpc3RhbmNlcmF0aW9gCiAgICogICogTWF4aW11bSBEaXN0YW5jZSAoMHgzRCwgMHgwNCk6IGBtYXhpbXVtZGlzdGFuY2VgCiAgICogICogTWF4aW11bSBEaXN0YW5jZSBHYWluICgweDNELCAweDA1KTogYG1heGltdW1kaXN0YW5jZWdhaW5gCiAgICogICogUmVmZXJlbmNlIERpc3RhbmNlIFJhdGlvICgweDNELCAweDA2KTogYHJlZmVyZW5jZWRpc3RhbmNlcmF0aW9gCiAgICogICogUGFuIFNwcmVhZCBBbmdsZSAoMHgzRCwgMHgwNyk6IGBwYW5zcHJlYWRhbmdsZWAKICAgKiAgKiBSb2xsIEFuZ2xlICgweDNELCAweDA4KTogYHJvbGxhbmdsZWAKICAgKgogICAqIEBtZXRob2Qgc2V0UmVnaXN0ZXJlZFBhcmFtZXRlcgogICAqIEBjaGFpbmFibGUKICAgKgogICAqIEBwYXJhbSBwYXJhbWV0ZXIge1N0cmluZ3xBcnJheX0gQSBzdHJpbmcgaWRlbnRpZnlpbmcgdGhlIHBhcmFtZXRlciJzIG5hbWUgKHNlZSBhYm92ZSkgb3IgYQogICAqIHR3by1wb3NpdGlvbiBhcnJheSBzcGVjaWZ5aW5nIHRoZSB0d28gY29udHJvbCBieXRlcyAoMHg2NSwgMHg2NCkgdGhhdCBpZGVudGlmeSB0aGUgcmVnaXN0ZXJlZAogICAqIHBhcmFtZXRlci4KICAgKgogICAqIEBwYXJhbSBbZGF0YT1bXV0ge051bWJlcnxBcnJheX0gQW4gc2luZ2xlIGludGVnZXIgb3IgYW4gYXJyYXkgb2YgaW50ZWdlcnMgd2l0aCBhIG1heGltdW0gbGVuZ3RoCiAgICogb2YgMiBzcGVjaWZ5aW5nIHRoZSBkZXNpcmVkIGRhdGEuCiAgICoKICAgKiBAcGFyYW0gW2NoYW5uZWw9YWxsXSB7TnVtYmVyfEFycmF5fFN0cmluZ30gVGhlIE1JREkgY2hhbm5lbCBudW1iZXIgKGJldHdlZW4gMSBhbmQgMTYpIG9yIGFuCiAgICogYXJyYXkgb2YgY2hhbm5lbCBudW1iZXJzLiBJZiB0aGUgc3BlY2lhbCB2YWx1ZSAiYWxsIiBpcyB1c2VkLCB0aGUgbWVzc2FnZSB3aWxsIGJlIHNlbnQgdG8gYWxsCiAgICogMTYgY2hhbm5lbHMuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dCiAgICoKICAgKiBAcGFyYW0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB8U3RyaW5nfSBbb3B0aW9ucy50aW1lPXVuZGVmaW5lZF0gVGhpcyB2YWx1ZSBjYW4gYmUgb25lIG9mIHR3bwogICAqIHRoaW5ncy4gSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHN0YXJ0aW5nIHdpdGggdGhlICsgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsIHRoZSByZXF1ZXN0CiAgICogd2lsbCBiZSBkZWxheWVkIGJ5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIChpbiBtaWxsaXNlY29uZHMpLiBPdGhlcndpc2UsIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEKICAgKiB0aW1lc3RhbXAgYW5kIHRoZSByZXF1ZXN0IHdpbGwgYmUgc2NoZWR1bGVkIGF0IHRoYXQgdGltZXN0YW1wLiBUaGUgYERPTUhpZ2hSZXNUaW1lU3RhbXBgIHZhbHVlCiAgICogaXMgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LiBUbyByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lLCB5b3UgY2FuIHVzZQogICAqIGBXZWJNaWRpLnRpbWVgLiBJZiBgdGltZWAgaXMgbm90IHByZXNlbnQgb3IgaXMgc2V0IHRvIGEgdGltZSBpbiB0aGUgcGFzdCwgdGhlIHJlcXVlc3QgaXMgdG8gYmUKICAgKiBzZW50IGFzIHNvb24gYXMgcG9zc2libGUuCiAgICoKICAgKiBAcmV0dXJucyB7T3V0cHV0fSBSZXR1cm5zIHRoZSBgT3V0cHV0YCBvYmplY3Qgc28gbWV0aG9kcyBjYW4gYmUgY2hhaW5lZC4KICAgKi8KCgogIE91dHB1dC5wcm90b3R5cGUuc2V0UmVnaXN0ZXJlZFBhcmFtZXRlciA9IGZ1bmN0aW9uIChwYXJhbWV0ZXIsIGRhdGEsIGNoYW5uZWwsIG9wdGlvbnMpIHsKICAgIHZhciB0aGF0ID0gdGhpczsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgIGlmICghQXJyYXkuaXNBcnJheShwYXJhbWV0ZXIpKSB7CiAgICAgIGlmICghd20uTUlESV9SRUdJU1RFUkVEX1BBUkFNRVRFUltwYXJhbWV0ZXJdKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgc3BlY2lmaWVkIHBhcmFtZXRlciBpcyBub3QgYXZhaWxhYmxlLiIpOwogICAgICB9CgogICAgICBwYXJhbWV0ZXIgPSB3bS5NSURJX1JFR0lTVEVSRURfUEFSQU1FVEVSW3BhcmFtZXRlcl07CiAgICB9CgogICAgd20udG9NSURJQ2hhbm5lbHMoY2hhbm5lbCkuZm9yRWFjaChmdW5jdGlvbiAoKSB7CiAgICAgIHRoYXQuX3NlbGVjdFJlZ2lzdGVyZWRQYXJhbWV0ZXIocGFyYW1ldGVyLCBjaGFubmVsLCBvcHRpb25zLnRpbWUpOwoKICAgICAgdGhhdC5fc2V0Q3VycmVudFJlZ2lzdGVyZWRQYXJhbWV0ZXIoZGF0YSwgY2hhbm5lbCwgb3B0aW9ucy50aW1lKTsKCiAgICAgIHRoYXQuX2Rlc2VsZWN0UmVnaXN0ZXJlZFBhcmFtZXRlcihjaGFubmVsLCBvcHRpb25zLnRpbWUpOwogICAgfSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIFNldHMgYSBub24tcmVnaXN0ZXJlZCBwYXJhbWV0ZXIgdG8gdGhlIHNwZWNpZmllZCB2YWx1ZS4gVGhlIE5SUE4gaXMgc2VsZWN0ZWQgYnkgcGFzc2luZyBpbiBhCiAgICogdHdvLXBvc2l0aW9uIGFycmF5IHNwZWNpZnlpbmcgdGhlIHZhbHVlcyBvZiB0aGUgdHdvIGNvbnRyb2wgYnl0ZXMuIFRoZSB2YWx1ZSBpcyBzcGVjaWZpZWQgYnkKICAgKiBwYXNzaW5nIGluIGFuIHNpbmdsZSBpbnRlZ2VyIChtb3N0IGNhc2VzKSBvciBhbiBhcnJheSBvZiB0d28gaW50ZWdlcnMuCiAgICoKICAgKiBOUlBOcyBhcmUgbm90IHN0YW5kYXJkaXplZCBpbiBhbnkgd2F5LiBFYWNoIG1hbnVmYWN0dXJlciBpcyBmcmVlIHRvIGltcGxlbWVudCB0aGVtIGFueSB3YXkKICAgKiB0aGV5IHNlZSBmaXQuIEZvciBleGFtcGxlLCBhY2NvcmRpbmcgdG8gdGhlIFJvbGFuZCBHUyBzcGVjaWZpY2F0aW9uLCB5b3UgY2FuIGNvbnRyb2wgdGhlCiAgICogKip2aWJyYXRvIHJhdGUqKiB1c2luZyBOUlBOICgxLCA4KS4gVGhlcmVmb3JlLCB0byBzZXQgdGhlICoqdmlicmF0byByYXRlKiogdmFsdWUgdG8gKioxMjMqKiB5b3UKICAgKiB3b3VsZCB1c2U6CiAgICoKICAgKiAgICAgV2ViTWlkaS5vdXRwdXRzWzBdLnNldE5vblJlZ2lzdGVyZWRQYXJhbWV0ZXIoWzEsIDhdLCAxMjMpOwogICAqCiAgICogT2J2aW91c2x5LCB5b3Ugc2hvdWxkIHNlbGVjdCBhIGNoYW5uZWwgc28gdGhlIG1lc3NhZ2UgaXMgbm90IHNlbnQgdG8gYWxsIGNoYW5uZWxzLiBGb3IKICAgKiBpbnN0YW5jZSwgdG8gc2VuZCB0byBjaGFubmVsIDEgb2YgdGhlIGZpcnN0IG91dHB1dCBwb3J0LCB5b3Ugd291bGQgdXNlOgogICAqCiAgICogICAgIFdlYk1pZGkub3V0cHV0c1swXS5zZXROb25SZWdpc3RlcmVkUGFyYW1ldGVyKFsxLCA4XSwgMTIzLCAxKTsKICAgKgogICAqIEluIHNvbWUgcmFyZXIgY2FzZXMsIHlvdSBuZWVkIHRvIHNlbmQgdHdvIHZhbHVlcyB3aXRoIHlvdXIgTlJQTiBtZXNzYWdlcy4gSW4gc3VjaCBjYXNlcywgeW91CiAgICogd291bGQgdXNlIGEgMi1wb3NpdGlvbiBhcnJheS4gRm9yIGV4YW1wbGUsIGZvciBpdHMgKipDbG9ja0JQTSoqIHBhcmFtZXRlciAoMiwgNjMpLCBOb3ZhdGlvbgogICAqIHVzZXMgYSAxNC1iaXQgdmFsdWUgdGhhdCBjb21iaW5lcyBhbiBNU0IgYW5kIGFuIExTQiAoNy1iaXQgdmFsdWVzKS4gU28sIGZvciBleGFtcGxlLCBpZiB0aGUKICAgKiB2YWx1ZSB0byBzZW5kIHdhcyAxMCwgeW91IGNvdWxkIHVzZToKICAgKgogICAqICAgICBXZWJNaWRpLm91dHB1dHNbMF0uc2V0Tm9uUmVnaXN0ZXJlZFBhcmFtZXRlcihbMiwgNjNdLCBbMCwgMTBdKTsKICAgKgogICAqIEZvciBmdXJ0aGVyIGltcGxlbWVudGF0aW9uIGRldGFpbHMsIHJlZmVyIHRvIHRoZSBtYW51ZmFjdHVyZXIicyBkb2N1bWVudGF0aW9uLgogICAqCiAgICogQG1ldGhvZCBzZXROb25SZWdpc3RlcmVkUGFyYW1ldGVyCiAgICogQGNoYWluYWJsZQogICAqCiAgICogQHBhcmFtIHBhcmFtZXRlciB7QXJyYXl9IEEgdHdvLXBvc2l0aW9uIGFycmF5IHNwZWNpZnlpbmcgdGhlIHR3byBjb250cm9sIGJ5dGVzICgweDYzLAogICAqIDB4NjIpIHRoYXQgaWRlbnRpZnkgdGhlIG5vbi1yZWdpc3RlcmVkIHBhcmFtZXRlci4KICAgKgogICAqIEBwYXJhbSBbZGF0YT1bXV0ge051bWJlcnxBcnJheX0gQW4gaW50ZWdlciBvciBhbiBhcnJheSBvZiBpbnRlZ2VycyB3aXRoIGEgbGVuZ3RoIG9mIDEgb3IgMgogICAqIHNwZWNpZnlpbmcgdGhlIGRlc2lyZWQgZGF0YS4KICAgKgogICAqIEBwYXJhbSBbY2hhbm5lbD1hbGxdIHtOdW1iZXJ8QXJyYXl8U3RyaW5nfSBUaGUgTUlESSBjaGFubmVsIG51bWJlciAoYmV0d2VlbiAxIGFuZCAxNikgb3IgYW4KICAgKiBhcnJheSBvZiBjaGFubmVsIG51bWJlcnMuIElmIHRoZSBzcGVjaWFsIHZhbHVlICJhbGwiIGlzIHVzZWQsIHRoZSBtZXNzYWdlIHdpbGwgYmUgc2VudCB0byBhbGwKICAgKiAxNiBjaGFubmVscy4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucz17fV0KICAgKgogICAqIEBwYXJhbSB7RE9NSGlnaFJlc1RpbWVTdGFtcHxTdHJpbmd9IFtvcHRpb25zLnRpbWU9dW5kZWZpbmVkXSBUaGlzIHZhbHVlIGNhbiBiZSBvbmUgb2YgdHdvCiAgICogdGhpbmdzLiBJZiB0aGUgdmFsdWUgaXMgYSBzdHJpbmcgc3RhcnRpbmcgd2l0aCB0aGUgKyBzaWduIGFuZCBmb2xsb3dlZCBieSBhIG51bWJlciwgdGhlIHJlcXVlc3QKICAgKiB3aWxsIGJlIGRlbGF5ZWQgYnkgdGhlIHNwZWNpZmllZCBudW1iZXIgKGluIG1pbGxpc2Vjb25kcykuIE90aGVyd2lzZSwgdGhlIHZhbHVlIGlzIGNvbnNpZGVyZWQgYQogICAqIHRpbWVzdGFtcCBhbmQgdGhlIHJlcXVlc3Qgd2lsbCBiZSBzY2hlZHVsZWQgYXQgdGhhdCB0aW1lc3RhbXAuIFRoZSBgRE9NSGlnaFJlc1RpbWVTdGFtcGAgdmFsdWUKICAgKiBpcyByZWxhdGl2ZSB0byB0aGUgbmF2aWdhdGlvbiBzdGFydCBvZiB0aGUgZG9jdW1lbnQuIFRvIHJldHJpZXZlIHRoZSBjdXJyZW50IHRpbWUsIHlvdSBjYW4gdXNlCiAgICogYFdlYk1pZGkudGltZWAuIElmIGB0aW1lYCBpcyBub3QgcHJlc2VudCBvciBpcyBzZXQgdG8gYSB0aW1lIGluIHRoZSBwYXN0LCB0aGUgcmVxdWVzdCBpcyB0byBiZQogICAqIHNlbnQgYXMgc29vbiBhcyBwb3NzaWJsZS4KICAgKgogICAqIEByZXR1cm5zIHtPdXRwdXR9IFJldHVybnMgdGhlIGBPdXRwdXRgIG9iamVjdCBzbyBtZXRob2RzIGNhbiBiZSBjaGFpbmVkLgogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5zZXROb25SZWdpc3RlcmVkUGFyYW1ldGVyID0gZnVuY3Rpb24gKHBhcmFtZXRlciwgZGF0YSwgY2hhbm5lbCwgb3B0aW9ucykgewogICAgdmFyIHRoYXQgPSB0aGlzOwogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgaWYgKCEocGFyYW1ldGVyWzBdID49IDAgJiYgcGFyYW1ldGVyWzBdIDw9IDEyNykgfHwgIShwYXJhbWV0ZXJbMV0gPj0gMCAmJiBwYXJhbWV0ZXJbMV0gPD0gMTI3KSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlBvc2l0aW9uIDAgYW5kIDEgb2YgdGhlIDItcG9zaXRpb24gcGFyYW1ldGVyIGFycmF5IG11c3QgYm90aCBiZSBiZXR3ZWVuIDAgYW5kIDEyNy4iKTsKICAgIH0KCiAgICBkYXRhID0gW10uY29uY2F0KGRhdGEpOwogICAgd20udG9NSURJQ2hhbm5lbHMoY2hhbm5lbCkuZm9yRWFjaChmdW5jdGlvbiAoKSB7CiAgICAgIHRoYXQuX3NlbGVjdE5vblJlZ2lzdGVyZWRQYXJhbWV0ZXIocGFyYW1ldGVyLCBjaGFubmVsLCBvcHRpb25zLnRpbWUpOwoKICAgICAgdGhhdC5fc2V0Q3VycmVudFJlZ2lzdGVyZWRQYXJhbWV0ZXIoZGF0YSwgY2hhbm5lbCwgb3B0aW9ucy50aW1lKTsKCiAgICAgIHRoYXQuX2Rlc2VsZWN0UmVnaXN0ZXJlZFBhcmFtZXRlcihjaGFubmVsLCBvcHRpb25zLnRpbWUpOwogICAgfSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIEluY3JlbWVudHMgdGhlIHNwZWNpZmllZCBNSURJIHJlZ2lzdGVyZWQgcGFyYW1ldGVyIGJ5IDEuIEZvciBtb3JlIHNwZWNpZmljIE1JREkgdXNhZ2UKICAgKiBpbmZvcm1hdGlvbiwgY2hlY2sgb3V0IFtSUC0xOF0oaHR0cDovL2Rldi5taWRpLm9yZy90ZWNoc3BlY3MvcnAxOC5waHApIHJlZ2FyZGluZyB0aGUgdXNhZ2Ugb2YKICAgKiBpbmNyZW1lbnQgYW5kIGRlY3JlbWVudCBjb250cm9sbGVycy4KICAgKgogICAqID5Vbmxlc3MgeW91IGFyZSB2ZXJ5IGZhbWlsaWFyIHdpdGggdGhlIE1JREkgc3RhbmRhcmQgeW91IHByb2JhYmx5IHNob3VsZCBmYXZvdXIgb25lIG9mIHRoZQogICAqID5zaW1wbGVyIHRvIHVzZSBmdW5jdGlvbnMgc3VjaCBhczogYHNldFBpdGNoYmVuZFJhbmdlKClgLCBgc2V0TW9kdWxhdGlvblJhbmdlKClgLAogICAqID5gc2V0TWFzdGVyVHVuaW5nKClgLCBldGMuCiAgICoKICAgKiBIZXJlIGlzIHRoZSBmdWxsIGxpc3Qgb2YgcGFyYW1ldGVyIG5hbWVzIHRoYXQgY2FuIGJlIHVzZWQgd2l0aCB0aGlzIGZ1bmN0aW9uOgogICAqCiAgICogICogUGl0Y2hiZW5kIFJhbmdlICgweDAwLCAweDAwKTogYHBpdGNoYmVuZHJhbmdlYAogICAqICAqIENoYW5uZWwgRmluZSBUdW5pbmcgKDB4MDAsIDB4MDEpOiBgY2hhbm5lbGZpbmV0dW5pbmdgCiAgICogICogQ2hhbm5lbCBDb2Fyc2UgVHVuaW5nICgweDAwLCAweDAyKTogYGNoYW5uZWxjb2Fyc2V0dW5pbmdgCiAgICogICogVHVuaW5nIFByb2dyYW0gKDB4MDAsIDB4MDMpOiBgdHVuaW5ncHJvZ3JhbWAKICAgKiAgKiBUdW5pbmcgQmFuayAoMHgwMCwgMHgwNCk6IGB0dW5pbmdiYW5rYAogICAqICAqIE1vZHVsYXRpb24gUmFuZ2UgKDB4MDAsIDB4MDUpOiBgbW9kdWxhdGlvbnJhbmdlYAogICAqICAqIEF6aW11dGggQW5nbGUgKDB4M0QsIDB4MDApOiBgYXppbXV0aGFuZ2xlYAogICAqICAqIEVsZXZhdGlvbiBBbmdsZSAoMHgzRCwgMHgwMSk6IGBlbGV2YXRpb25hbmdsZWAKICAgKiAgKiBHYWluICgweDNELCAweDAyKTogYGdhaW5gCiAgICogICogRGlzdGFuY2UgUmF0aW8gKDB4M0QsIDB4MDMpOiBgZGlzdGFuY2VyYXRpb2AKICAgKiAgKiBNYXhpbXVtIERpc3RhbmNlICgweDNELCAweDA0KTogYG1heGltdW1kaXN0YW5jZWAKICAgKiAgKiBNYXhpbXVtIERpc3RhbmNlIEdhaW4gKDB4M0QsIDB4MDUpOiBgbWF4aW11bWRpc3RhbmNlZ2FpbmAKICAgKiAgKiBSZWZlcmVuY2UgRGlzdGFuY2UgUmF0aW8gKDB4M0QsIDB4MDYpOiBgcmVmZXJlbmNlZGlzdGFuY2VyYXRpb2AKICAgKiAgKiBQYW4gU3ByZWFkIEFuZ2xlICgweDNELCAweDA3KTogYHBhbnNwcmVhZGFuZ2xlYAogICAqICAqIFJvbGwgQW5nbGUgKDB4M0QsIDB4MDgpOiBgcm9sbGFuZ2xlYAogICAqCiAgICogQG1ldGhvZCBpbmNyZW1lbnRSZWdpc3RlcmVkUGFyYW1ldGVyCiAgICogQGNoYWluYWJsZQogICAqCiAgICogQHBhcmFtIHBhcmFtZXRlciB7U3RyaW5nfEFycmF5fSBBIHN0cmluZyBpZGVudGlmeWluZyB0aGUgcGFyYW1ldGVyInMgbmFtZSAoc2VlIGFib3ZlKSBvciBhCiAgICogdHdvLXBvc2l0aW9uIGFycmF5IHNwZWNpZnlpbmcgdGhlIHR3byBjb250cm9sIGJ5dGVzICgweDY1LCAweDY0KSB0aGF0IGlkZW50aWZ5IHRoZSByZWdpc3RlcmVkCiAgICogcGFyYW1ldGVyLgogICAqCiAgICogQHBhcmFtIFtjaGFubmVsPWFsbF0ge3VpbnR8QXJyYXl8U3RyaW5nfSBUaGUgTUlESSBjaGFubmVsIG51bWJlciAoYmV0d2VlbiAxIGFuZCAxNikgb3IgYW4KICAgKiBhcnJheSBvZiBjaGFubmVsIG51bWJlcnMuIElmIHRoZSBzcGVjaWFsIHZhbHVlICJhbGwiIGlzIHVzZWQsIHRoZSBtZXNzYWdlIHdpbGwgYmUgc2VudCB0byBhbGwKICAgKiAxNiBjaGFubmVscy4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucz17fV0KICAgKgogICAqIEBwYXJhbSB7RE9NSGlnaFJlc1RpbWVTdGFtcHxTdHJpbmd9IFtvcHRpb25zLnRpbWU9dW5kZWZpbmVkXSBUaGlzIHZhbHVlIGNhbiBiZSBvbmUgb2YgdHdvCiAgICogdGhpbmdzLiBJZiB0aGUgdmFsdWUgaXMgYSBzdHJpbmcgc3RhcnRpbmcgd2l0aCB0aGUgKyBzaWduIGFuZCBmb2xsb3dlZCBieSBhIG51bWJlciwgdGhlIHJlcXVlc3QKICAgKiB3aWxsIGJlIGRlbGF5ZWQgYnkgdGhlIHNwZWNpZmllZCBudW1iZXIgKGluIG1pbGxpc2Vjb25kcykuIE90aGVyd2lzZSwgdGhlIHZhbHVlIGlzIGNvbnNpZGVyZWQgYQogICAqIHRpbWVzdGFtcCBhbmQgdGhlIHJlcXVlc3Qgd2lsbCBiZSBzY2hlZHVsZWQgYXQgdGhhdCB0aW1lc3RhbXAuIFRoZSBgRE9NSGlnaFJlc1RpbWVTdGFtcGAgdmFsdWUKICAgKiBpcyByZWxhdGl2ZSB0byB0aGUgbmF2aWdhdGlvbiBzdGFydCBvZiB0aGUgZG9jdW1lbnQuIFRvIHJldHJpZXZlIHRoZSBjdXJyZW50IHRpbWUsIHlvdSBjYW4gdXNlCiAgICogYFdlYk1pZGkudGltZWAuIElmIGB0aW1lYCBpcyBub3QgcHJlc2VudCBvciBpcyBzZXQgdG8gYSB0aW1lIGluIHRoZSBwYXN0LCB0aGUgcmVxdWVzdCBpcyB0byBiZQogICAqIHNlbnQgYXMgc29vbiBhcyBwb3NzaWJsZS4KICAgKgogICAqIEB0aHJvd3MgRXJyb3IgVGhlIHNwZWNpZmllZCBwYXJhbWV0ZXIgaXMgbm90IGF2YWlsYWJsZS4KICAgKgogICAqIEByZXR1cm5zIHtPdXRwdXR9IFJldHVybnMgdGhlIGBPdXRwdXRgIG9iamVjdCBzbyBtZXRob2RzIGNhbiBiZSBjaGFpbmVkLgogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5pbmNyZW1lbnRSZWdpc3RlcmVkUGFyYW1ldGVyID0gZnVuY3Rpb24gKHBhcmFtZXRlciwgY2hhbm5lbCwgb3B0aW9ucykgewogICAgdmFyIHRoYXQgPSB0aGlzOwogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgaWYgKCFBcnJheS5pc0FycmF5KHBhcmFtZXRlcikpIHsKICAgICAgaWYgKCF3bS5NSURJX1JFR0lTVEVSRURfUEFSQU1FVEVSW3BhcmFtZXRlcl0pIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBzcGVjaWZpZWQgcGFyYW1ldGVyIGlzIG5vdCBhdmFpbGFibGUuIik7CiAgICAgIH0KCiAgICAgIHBhcmFtZXRlciA9IHdtLk1JRElfUkVHSVNURVJFRF9QQVJBTUVURVJbcGFyYW1ldGVyXTsKICAgIH0KCiAgICB3bS50b01JRElDaGFubmVscyhjaGFubmVsKS5mb3JFYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgdGhhdC5fc2VsZWN0UmVnaXN0ZXJlZFBhcmFtZXRlcihwYXJhbWV0ZXIsIGNoYW5uZWwsIG9wdGlvbnMudGltZSk7CgogICAgICB0aGF0LnNlbmRDb250cm9sQ2hhbmdlKDB4NjAsIDAsIGNoYW5uZWwsIHsKICAgICAgICB0aW1lOiBvcHRpb25zLnRpbWUKICAgICAgfSk7CgogICAgICB0aGF0Ll9kZXNlbGVjdFJlZ2lzdGVyZWRQYXJhbWV0ZXIoY2hhbm5lbCwgb3B0aW9ucy50aW1lKTsKICAgIH0pOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBEZWNyZW1lbnRzIHRoZSBzcGVjaWZpZWQgTUlESSByZWdpc3RlcmVkIHBhcmFtZXRlciBieSAxLiBGb3IgbW9yZSBzcGVjaWZpYyBNSURJIHVzYWdlCiAgICogaW5mb3JtYXRpb24sIGNoZWNrIG91dCBbUlAtMThdKGh0dHA6Ly9kZXYubWlkaS5vcmcvdGVjaHNwZWNzL3JwMTgucGhwKSByZWdhcmRpbmcgdGhlIHVzYWdlIG9mCiAgICogaW5jcmVtZW50IGFuZCBkZWNyZW1lbnQgY29udHJvbGxlcnMuCiAgICoKICAgKiA+VW5sZXNzIHlvdSBhcmUgdmVyeSBmYW1pbGlhciB3aXRoIHRoZSBNSURJIHN0YW5kYXJkIHlvdSBwcm9iYWJseSBzaG91bGQgZmF2b3VyIG9uZSBvZiB0aGUKICAgKiA+c2ltcGxlciB0byB1c2UgZnVuY3Rpb25zIHN1Y2ggYXM6IGBzZXRQaXRjaGJlbmRSYW5nZSgpYCwgYHNldE1vZHVsYXRpb25SYW5nZSgpYCwKICAgKiA+YHNldE1hc3RlclR1bmluZygpYCwgZXRjLgogICAqCiAgICogSGVyZSBpcyB0aGUgZnVsbCBsaXN0IG9mIHBhcmFtZXRlciBuYW1lcyB0aGF0IGNhbiBiZSB1c2VkIHdpdGggdGhpcyBmdW5jdGlvbjoKICAgKgogICAqICAqIFBpdGNoYmVuZCBSYW5nZSAoMHgwMCwgMHgwMCk6IGBwaXRjaGJlbmRyYW5nZWAKICAgKiAgKiBDaGFubmVsIEZpbmUgVHVuaW5nICgweDAwLCAweDAxKTogYGNoYW5uZWxmaW5ldHVuaW5nYAogICAqICAqIENoYW5uZWwgQ29hcnNlIFR1bmluZyAoMHgwMCwgMHgwMik6IGBjaGFubmVsY29hcnNldHVuaW5nYAogICAqICAqIFR1bmluZyBQcm9ncmFtICgweDAwLCAweDAzKTogYHR1bmluZ3Byb2dyYW1gCiAgICogICogVHVuaW5nIEJhbmsgKDB4MDAsIDB4MDQpOiBgdHVuaW5nYmFua2AKICAgKiAgKiBNb2R1bGF0aW9uIFJhbmdlICgweDAwLCAweDA1KTogYG1vZHVsYXRpb25yYW5nZWAKICAgKiAgKiBBemltdXRoIEFuZ2xlICgweDNELCAweDAwKTogYGF6aW11dGhhbmdsZWAKICAgKiAgKiBFbGV2YXRpb24gQW5nbGUgKDB4M0QsIDB4MDEpOiBgZWxldmF0aW9uYW5nbGVgCiAgICogICogR2FpbiAoMHgzRCwgMHgwMik6IGBnYWluYAogICAqICAqIERpc3RhbmNlIFJhdGlvICgweDNELCAweDAzKTogYGRpc3RhbmNlcmF0aW9gCiAgICogICogTWF4aW11bSBEaXN0YW5jZSAoMHgzRCwgMHgwNCk6IGBtYXhpbXVtZGlzdGFuY2VgCiAgICogICogTWF4aW11bSBEaXN0YW5jZSBHYWluICgweDNELCAweDA1KTogYG1heGltdW1kaXN0YW5jZWdhaW5gCiAgICogICogUmVmZXJlbmNlIERpc3RhbmNlIFJhdGlvICgweDNELCAweDA2KTogYHJlZmVyZW5jZWRpc3RhbmNlcmF0aW9gCiAgICogICogUGFuIFNwcmVhZCBBbmdsZSAoMHgzRCwgMHgwNyk6IGBwYW5zcHJlYWRhbmdsZWAKICAgKiAgKiBSb2xsIEFuZ2xlICgweDNELCAweDA4KTogYHJvbGxhbmdsZWAKICAgKgogICAqIEBtZXRob2QgZGVjcmVtZW50UmVnaXN0ZXJlZFBhcmFtZXRlcgogICAqIEBjaGFpbmFibGUKICAgKgogICAqIEBwYXJhbSBwYXJhbWV0ZXIge1N0cmluZ3xBcnJheX0gQSBzdHJpbmcgaWRlbnRpZnlpbmcgdGhlIHBhcmFtZXRlciJzIG5hbWUgKHNlZSBhYm92ZSkgb3IgYQogICAqIHR3by1wb3NpdGlvbiBhcnJheSBzcGVjaWZ5aW5nIHRoZSB0d28gY29udHJvbCBieXRlcyAoMHg2NSwgMHg2NCkgdGhhdCBpZGVudGlmeSB0aGUgcmVnaXN0ZXJlZAogICAqIHBhcmFtZXRlci4KICAgKgogICAqIEBwYXJhbSBbY2hhbm5lbD1hbGxdIHtOdW1iZXJ8QXJyYXl8U3RyaW5nfSBUaGUgTUlESSBjaGFubmVsIG51bWJlciAoYmV0d2VlbiAxIGFuZCAxNikgb3IgYW4KICAgKiBhcnJheSBvZiBjaGFubmVsIG51bWJlcnMuIElmIHRoZSBzcGVjaWFsIHZhbHVlICJhbGwiIGlzIHVzZWQsIHRoZSBtZXNzYWdlIHdpbGwgYmUgc2VudCB0byBhbGwKICAgKiAxNiBjaGFubmVscy4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucz17fV0KICAgKgogICAqIEBwYXJhbSB7RE9NSGlnaFJlc1RpbWVTdGFtcHxTdHJpbmd9IFtvcHRpb25zLnRpbWU9dW5kZWZpbmVkXSBUaGlzIHZhbHVlIGNhbiBiZSBvbmUgb2YgdHdvCiAgICogdGhpbmdzLiBJZiB0aGUgdmFsdWUgaXMgYSBzdHJpbmcgc3RhcnRpbmcgd2l0aCB0aGUgKyBzaWduIGFuZCBmb2xsb3dlZCBieSBhIG51bWJlciwgdGhlIHJlcXVlc3QKICAgKiB3aWxsIGJlIGRlbGF5ZWQgYnkgdGhlIHNwZWNpZmllZCBudW1iZXIgKGluIG1pbGxpc2Vjb25kcykuIE90aGVyd2lzZSwgdGhlIHZhbHVlIGlzIGNvbnNpZGVyZWQgYQogICAqIHRpbWVzdGFtcCBhbmQgdGhlIHJlcXVlc3Qgd2lsbCBiZSBzY2hlZHVsZWQgYXQgdGhhdCB0aW1lc3RhbXAuIFRoZSBgRE9NSGlnaFJlc1RpbWVTdGFtcGAgdmFsdWUKICAgKiBpcyByZWxhdGl2ZSB0byB0aGUgbmF2aWdhdGlvbiBzdGFydCBvZiB0aGUgZG9jdW1lbnQuIFRvIHJldHJpZXZlIHRoZSBjdXJyZW50IHRpbWUsIHlvdSBjYW4gdXNlCiAgICogYFdlYk1pZGkudGltZWAuIElmIGB0aW1lYCBpcyBub3QgcHJlc2VudCBvciBpcyBzZXQgdG8gYSB0aW1lIGluIHRoZSBwYXN0LCB0aGUgcmVxdWVzdCBpcyB0byBiZQogICAqIHNlbnQgYXMgc29vbiBhcyBwb3NzaWJsZS4KICAgKgogICAqIEB0aHJvd3MgVHlwZUVycm9yIFRoZSBzcGVjaWZpZWQgcGFyYW1ldGVyIGlzIG5vdCBhdmFpbGFibGUuCiAgICoKICAgKiBAcmV0dXJucyB7T3V0cHV0fSBSZXR1cm5zIHRoZSBgT3V0cHV0YCBvYmplY3Qgc28gbWV0aG9kcyBjYW4gYmUgY2hhaW5lZC4KICAgKi8KCgogIE91dHB1dC5wcm90b3R5cGUuZGVjcmVtZW50UmVnaXN0ZXJlZFBhcmFtZXRlciA9IGZ1bmN0aW9uIChwYXJhbWV0ZXIsIGNoYW5uZWwsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgIGlmICghQXJyYXkuaXNBcnJheShwYXJhbWV0ZXIpKSB7CiAgICAgIGlmICghd20uTUlESV9SRUdJU1RFUkVEX1BBUkFNRVRFUltwYXJhbWV0ZXJdKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVGhlIHNwZWNpZmllZCBwYXJhbWV0ZXIgaXMgbm90IGF2YWlsYWJsZS4iKTsKICAgICAgfQoKICAgICAgcGFyYW1ldGVyID0gd20uTUlESV9SRUdJU1RFUkVEX1BBUkFNRVRFUltwYXJhbWV0ZXJdOwogICAgfQoKICAgIHdtLnRvTUlESUNoYW5uZWxzKGNoYW5uZWwpLmZvckVhY2goZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9zZWxlY3RSZWdpc3RlcmVkUGFyYW1ldGVyKHBhcmFtZXRlciwgY2hhbm5lbCwgb3B0aW9ucy50aW1lKTsKCiAgICAgIHRoaXMuc2VuZENvbnRyb2xDaGFuZ2UoMHg2MSwgMCwgY2hhbm5lbCwgewogICAgICAgIHRpbWU6IG9wdGlvbnMudGltZQogICAgICB9KTsKCiAgICAgIHRoaXMuX2Rlc2VsZWN0UmVnaXN0ZXJlZFBhcmFtZXRlcihjaGFubmVsLCBvcHRpb25zLnRpbWUpOwogICAgfS5iaW5kKHRoaXMpKTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgLyoqCiAgICogU2VuZHMgYSBwaXRjaCBiZW5kIHJhbmdlIG1lc3NhZ2UgdG8gdGhlIHNwZWNpZmllZCBjaGFubmVsKHMpIGF0IHRoZSBzY2hlZHVsZWQgdGltZSBzbyB0aGF0IHRoZXkKICAgKiBhZGp1c3QgdGhlIHJhbmdlIHVzZWQgYnkgdGhlaXIgcGl0Y2ggYmVuZCBsZXZlci4gVGhlIHJhbmdlIGNhbiBiZSBzcGVjaWZpZWQgd2l0aCB0aGUKICAgKiBgc2VtaXRvbmVzYCBwYXJhbWV0ZXIsIHRoZSBgY2VudHNgIHBhcmFtZXRlciBvciBieSBzcGVjaWZ5aW5nIGJvdGggcGFyYW1ldGVycyBhdCB0aGUgc2FtZSB0aW1lLgogICAqCiAgICogQG1ldGhvZCBzZXRQaXRjaEJlbmRSYW5nZQogICAqIEBjaGFpbmFibGUKICAgKgogICAqIEBwYXJhbSBbc2VtaXRvbmVzPTBdIHtOdW1iZXJ9IFRoZSBkZXNpcmVkIGFkanVzdG1lbnQgdmFsdWUgaW4gc2VtaXRvbmVzIChpbnRlZ2VyIGJldHdlZW4KICAgKiAwLTEyNykuIFdoaWxlIG5vdGhpbmcgaW1wb3NlcyB0aGF0IGluIHRoZSBzcGVjaWZpY2F0aW9uLCBpdCBpcyB2ZXJ5IGNvbW1vbiBmb3IgbWFudWZhY3R1cmVycyB0bwogICAqIGxpbWl0IHRoZSByYW5nZSB0byAyIG9jdGF2ZXMgKC0xMiBzZW1pdG9uZXMgdG8gMTIgc2VtaXRvbmVzKS4KICAgKgogICAqIEBwYXJhbSBbY2VudHM9MF0ge051bWJlcn0gVGhlIGRlc2lyZWQgYWRqdXN0bWVudCB2YWx1ZSBpbiBjZW50cyAoaW50ZWdlciBiZXR3ZWVuIDAtMTI3KS4KICAgKgogICAqIEBwYXJhbSBbY2hhbm5lbD1hbGxdIHtOdW1iZXJ8QXJyYXl8U3RyaW5nfSBUaGUgTUlESSBjaGFubmVsIG51bWJlciAoYmV0d2VlbiAxIGFuZCAxNikgb3IgYW4KICAgKiBhcnJheSBvZiBjaGFubmVsIG51bWJlcnMuIElmIHRoZSBzcGVjaWFsIHZhbHVlICJhbGwiIGlzIHVzZWQsIHRoZSBtZXNzYWdlIHdpbGwgYmUgc2VudCB0byBhbGwKICAgKiAxNiBjaGFubmVscy4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucz17fV0KICAgKgogICAqIEBwYXJhbSB7RE9NSGlnaFJlc1RpbWVTdGFtcHxTdHJpbmd9IFtvcHRpb25zLnRpbWU9dW5kZWZpbmVkXSBUaGlzIHZhbHVlIGNhbiBiZSBvbmUgb2YgdHdvCiAgICogdGhpbmdzLiBJZiB0aGUgdmFsdWUgaXMgYSBzdHJpbmcgc3RhcnRpbmcgd2l0aCB0aGUgKyBzaWduIGFuZCBmb2xsb3dlZCBieSBhIG51bWJlciwgdGhlIHJlcXVlc3QKICAgKiB3aWxsIGJlIGRlbGF5ZWQgYnkgdGhlIHNwZWNpZmllZCBudW1iZXIgKGluIG1pbGxpc2Vjb25kcykuIE90aGVyd2lzZSwgdGhlIHZhbHVlIGlzIGNvbnNpZGVyZWQgYQogICAqIHRpbWVzdGFtcCBhbmQgdGhlIHJlcXVlc3Qgd2lsbCBiZSBzY2hlZHVsZWQgYXQgdGhhdCB0aW1lc3RhbXAuIFRoZSBgRE9NSGlnaFJlc1RpbWVTdGFtcGAgdmFsdWUKICAgKiBpcyByZWxhdGl2ZSB0byB0aGUgbmF2aWdhdGlvbiBzdGFydCBvZiB0aGUgZG9jdW1lbnQuIFRvIHJldHJpZXZlIHRoZSBjdXJyZW50IHRpbWUsIHlvdSBjYW4gdXNlCiAgICogYFdlYk1pZGkudGltZWAuIElmIGB0aW1lYCBpcyBub3QgcHJlc2VudCBvciBpcyBzZXQgdG8gYSB0aW1lIGluIHRoZSBwYXN0LCB0aGUgcmVxdWVzdCBpcyB0byBiZQogICAqIHNlbnQgYXMgc29vbiBhcyBwb3NzaWJsZS4KICAgKgogICAqIEB0aHJvd3Mge1JhbmdlRXJyb3J9IFRoZSBzZW1pdG9uZXMgdmFsdWUgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDEyNy4KICAgKiBAdGhyb3dzIHtSYW5nZUVycm9yfSBUaGUgY2VudHMgdmFsdWUgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDEyNy4KICAgKgogICAqIEByZXR1cm4ge091dHB1dH0gUmV0dXJucyB0aGUgYE91dHB1dGAgb2JqZWN0IHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICovCgoKICBPdXRwdXQucHJvdG90eXBlLnNldFBpdGNoQmVuZFJhbmdlID0gZnVuY3Rpb24gKHNlbWl0b25lcywgY2VudHMsIGNoYW5uZWwsIG9wdGlvbnMpIHsKICAgIHZhciB0aGF0ID0gdGhpczsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgc2VtaXRvbmVzID0gTWF0aC5mbG9vcihzZW1pdG9uZXMpIHx8IDA7CgogICAgaWYgKCEoc2VtaXRvbmVzID49IDAgJiYgc2VtaXRvbmVzIDw9IDEyNykpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIlRoZSBzZW1pdG9uZXMgdmFsdWUgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDEyNyIpOwogICAgfQoKICAgIGNlbnRzID0gTWF0aC5mbG9vcihjZW50cykgfHwgMDsKCiAgICBpZiAoIShjZW50cyA+PSAwICYmIGNlbnRzIDw9IDEyNykpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIlRoZSBjZW50cyB2YWx1ZSBtdXN0IGJlIGJldHdlZW4gMCBhbmQgMTI3Iik7CiAgICB9CgogICAgd20udG9NSURJQ2hhbm5lbHMoY2hhbm5lbCkuZm9yRWFjaChmdW5jdGlvbiAoKSB7CiAgICAgIHRoYXQuc2V0UmVnaXN0ZXJlZFBhcmFtZXRlcigicGl0Y2hiZW5kcmFuZ2UiLCBbc2VtaXRvbmVzLCBjZW50c10sIGNoYW5uZWwsIHsKICAgICAgICB0aW1lOiBvcHRpb25zLnRpbWUKICAgICAgfSk7CiAgICB9KTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgLyoqCiAgICogU2VuZHMgYSBtb2R1bGF0aW9uIGRlcHRoIHJhbmdlIG1lc3NhZ2UgdG8gdGhlIHNwZWNpZmllZCBjaGFubmVsKHMpIHNvIHRoYXQgdGhleSBhZGp1c3QgdGhlCiAgICogZGVwdGggb2YgdGhlaXIgbW9kdWxhdGlvbiB3aGVlbCJzIHJhbmdlLiBUaGUgcmFuZ2UgY2FuIGJlIHNwZWNpZmllZCB3aXRoIHRoZSBgc2VtaXRvbmVzYAogICAqIHBhcmFtZXRlciwgdGhlIGBjZW50c2AgcGFyYW1ldGVyIG9yIGJ5IHNwZWNpZnlpbmcgYm90aCBwYXJhbWV0ZXJzIGF0IHRoZSBzYW1lIHRpbWUuCiAgICoKICAgKiBAbWV0aG9kIHNldE1vZHVsYXRpb25SYW5nZQogICAqIEBjaGFpbmFibGUKICAgKgogICAqIEBwYXJhbSBbc2VtaXRvbmVzPTBdIHtOdW1iZXJ9IFRoZSBkZXNpcmVkIGFkanVzdG1lbnQgdmFsdWUgaW4gc2VtaXRvbmVzIChpbnRlZ2VyIGJldHdlZW4KICAgKiAwLTEyNykuCiAgICoKICAgKiBAcGFyYW0gW2NlbnRzPTBdIHtOdW1iZXJ9IFRoZSBkZXNpcmVkIGFkanVzdG1lbnQgdmFsdWUgaW4gY2VudHMgKDAtMTI3KS4KICAgKgogICAqIEBwYXJhbSBbY2hhbm5lbD1hbGxdIHtOdW1iZXJ8QXJyYXl8U3RyaW5nfSBUaGUgTUlESSBjaGFubmVsIG51bWJlciAoYmV0d2VlbiAxIGFuZCAxNikgb3IgYW4KICAgKiBhcnJheSBvZiBjaGFubmVsIG51bWJlcnMuIElmIHRoZSBzcGVjaWFsIHZhbHVlICJhbGwiIGlzIHVzZWQsIHRoZSBtZXNzYWdlIHdpbGwgYmUgc2VudCB0byBhbGwKICAgKiAxNiBjaGFubmVscy4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucz17fV0KICAgKgogICAqIEBwYXJhbSB7RE9NSGlnaFJlc1RpbWVTdGFtcHxTdHJpbmd9IFtvcHRpb25zLnRpbWU9dW5kZWZpbmVkXSBUaGlzIHZhbHVlIGNhbiBiZSBvbmUgb2YgdHdvCiAgICogdGhpbmdzLiBJZiB0aGUgdmFsdWUgaXMgYSBzdHJpbmcgc3RhcnRpbmcgd2l0aCB0aGUgKyBzaWduIGFuZCBmb2xsb3dlZCBieSBhIG51bWJlciwgdGhlIHJlcXVlc3QKICAgKiB3aWxsIGJlIGRlbGF5ZWQgYnkgdGhlIHNwZWNpZmllZCBudW1iZXIgKGluIG1pbGxpc2Vjb25kcykuIE90aGVyd2lzZSwgdGhlIHZhbHVlIGlzIGNvbnNpZGVyZWQgYQogICAqIHRpbWVzdGFtcCBhbmQgdGhlIHJlcXVlc3Qgd2lsbCBiZSBzY2hlZHVsZWQgYXQgdGhhdCB0aW1lc3RhbXAuIFRoZSBgRE9NSGlnaFJlc1RpbWVTdGFtcGAgdmFsdWUKICAgKiBpcyByZWxhdGl2ZSB0byB0aGUgbmF2aWdhdGlvbiBzdGFydCBvZiB0aGUgZG9jdW1lbnQuIFRvIHJldHJpZXZlIHRoZSBjdXJyZW50IHRpbWUsIHlvdSBjYW4gdXNlCiAgICogYFdlYk1pZGkudGltZWAuIElmIGB0aW1lYCBpcyBub3QgcHJlc2VudCBvciBpcyBzZXQgdG8gYSB0aW1lIGluIHRoZSBwYXN0LCB0aGUgcmVxdWVzdCBpcyB0byBiZQogICAqIHNlbnQgYXMgc29vbiBhcyBwb3NzaWJsZS4KICAgKgogICAqIEB0aHJvd3Mge1JhbmdlRXJyb3J9IFRoZSBzZW1pdG9uZXMgdmFsdWUgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDEyNy4KICAgKiBAdGhyb3dzIHtSYW5nZUVycm9yfSBUaGUgY2VudHMgdmFsdWUgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDEyNy4KICAgKgogICAqIEByZXR1cm4ge091dHB1dH0gUmV0dXJucyB0aGUgYE91dHB1dGAgb2JqZWN0IHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICovCgoKICBPdXRwdXQucHJvdG90eXBlLnNldE1vZHVsYXRpb25SYW5nZSA9IGZ1bmN0aW9uIChzZW1pdG9uZXMsIGNlbnRzLCBjaGFubmVsLCBvcHRpb25zKSB7CiAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHNlbWl0b25lcyA9IE1hdGguZmxvb3Ioc2VtaXRvbmVzKSB8fCAwOwoKICAgIGlmICghKHNlbWl0b25lcyA+PSAwICYmIHNlbWl0b25lcyA8PSAxMjcpKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJUaGUgc2VtaXRvbmVzIHZhbHVlIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxMjciKTsKICAgIH0KCiAgICBjZW50cyA9IE1hdGguZmxvb3IoY2VudHMpIHx8IDA7CgogICAgaWYgKCEoY2VudHMgPj0gMCAmJiBjZW50cyA8PSAxMjcpKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJUaGUgY2VudHMgdmFsdWUgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDEyNyIpOwogICAgfQoKICAgIHdtLnRvTUlESUNoYW5uZWxzKGNoYW5uZWwpLmZvckVhY2goZnVuY3Rpb24gKCkgewogICAgICB0aGF0LnNldFJlZ2lzdGVyZWRQYXJhbWV0ZXIoIm1vZHVsYXRpb25yYW5nZSIsIFtzZW1pdG9uZXMsIGNlbnRzXSwgY2hhbm5lbCwgewogICAgICAgIHRpbWU6IG9wdGlvbnMudGltZQogICAgICB9KTsKICAgIH0pOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBTZW5kcyBhIG1hc3RlciB0dW5pbmcgbWVzc2FnZSB0byB0aGUgc3BlY2lmaWVkIGNoYW5uZWwocykuIFRoZSB2YWx1ZSBpcyBkZWNpbWFsIGFuZCBtdXN0IGJlCiAgICogbGFyZ2VyIHRoYW4gLTY1IHNlbWl0b25lcyBhbmQgc21hbGxlciB0aGFuIDY0IHNlbWl0b25lcy4KICAgKgogICAqID5CZWNhdXNlIG9mIHRoZSB3YXkgdGhlIE1JREkgc3BlY2lmaWNhdGlvbiB3b3JrcywgdGhlIGRlY2ltYWwgcG9ydGlvbiBvZiB0aGUgdmFsdWUgd2lsbCBiZQogICAqID5lbmNvZGVkIHdpdGggYSByZXNvbHV0aW9uIG9mIDE0Yml0LiBUaGUgaW50ZWdlciBwb3J0aW9uIG11c3QgYmUgYmV0d2VlbiAtNjQgYW5kIDYzCiAgICogPmluY2x1c2l2ZWx5LiBGb3IgdGhvc2UgZmFtaWxpYXIgd2l0aCB0aGUgTUlESSBwcm90b2NvbCwgdGhpcyBmdW5jdGlvbiBhY3R1YWxseSBnZW5lcmF0ZXMKICAgKiA+KipNYXN0ZXIgQ29hcnNlIFR1bmluZyoqIGFuZCAqKk1hc3RlciBGaW5lIFR1bmluZyoqIFJQTiBtZXNzYWdlcy4KICAgKgogICAqIEBtZXRob2Qgc2V0TWFzdGVyVHVuaW5nCiAgICogQGNoYWluYWJsZQogICAqCiAgICogQHBhcmFtIFt2YWx1ZT0wLjBdIHtOdW1iZXJ9IFRoZSBkZXNpcmVkIGRlY2ltYWwgYWRqdXN0bWVudCB2YWx1ZSBpbiBzZW1pdG9uZXMgKC02NSA8IHggPCA2NCkKICAgKgogICAqIEBwYXJhbSBbY2hhbm5lbD1hbGxdIHtOdW1iZXJ8QXJyYXl8U3RyaW5nfSBUaGUgTUlESSBjaGFubmVsIG51bWJlciAoYmV0d2VlbiAxIGFuZCAxNikgb3IgYW4KICAgKiBhcnJheSBvZiBjaGFubmVsIG51bWJlcnMuIElmIHRoZSBzcGVjaWFsIHZhbHVlICJhbGwiIGlzIHVzZWQsIHRoZSBtZXNzYWdlIHdpbGwgYmUgc2VudCB0byBhbGwKICAgKiAxNiBjaGFubmVscy4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucz17fV0KICAgKgogICAqIEBwYXJhbSB7RE9NSGlnaFJlc1RpbWVTdGFtcHxTdHJpbmd9IFtvcHRpb25zLnRpbWU9dW5kZWZpbmVkXSBUaGlzIHZhbHVlIGNhbiBiZSBvbmUgb2YgdHdvCiAgICogdGhpbmdzLiBJZiB0aGUgdmFsdWUgaXMgYSBzdHJpbmcgc3RhcnRpbmcgd2l0aCB0aGUgKyBzaWduIGFuZCBmb2xsb3dlZCBieSBhIG51bWJlciwgdGhlIHJlcXVlc3QKICAgKiB3aWxsIGJlIGRlbGF5ZWQgYnkgdGhlIHNwZWNpZmllZCBudW1iZXIgKGluIG1pbGxpc2Vjb25kcykuIE90aGVyd2lzZSwgdGhlIHZhbHVlIGlzIGNvbnNpZGVyZWQgYQogICAqIHRpbWVzdGFtcCBhbmQgdGhlIHJlcXVlc3Qgd2lsbCBiZSBzY2hlZHVsZWQgYXQgdGhhdCB0aW1lc3RhbXAuIFRoZSBgRE9NSGlnaFJlc1RpbWVTdGFtcGAgdmFsdWUKICAgKiBpcyByZWxhdGl2ZSB0byB0aGUgbmF2aWdhdGlvbiBzdGFydCBvZiB0aGUgZG9jdW1lbnQuIFRvIHJldHJpZXZlIHRoZSBjdXJyZW50IHRpbWUsIHlvdSBjYW4gdXNlCiAgICogYFdlYk1pZGkudGltZWAuIElmIGB0aW1lYCBpcyBub3QgcHJlc2VudCBvciBpcyBzZXQgdG8gYSB0aW1lIGluIHRoZSBwYXN0LCB0aGUgcmVxdWVzdCBpcyB0byBiZQogICAqIHNlbnQgYXMgc29vbiBhcyBwb3NzaWJsZS4KICAgKgogICAqIEB0aHJvd3Mge1JhbmdlRXJyb3J9IFRoZSB2YWx1ZSBtdXN0IGJlIGEgZGVjaW1hbCBudW1iZXIgYmV0d2VlbiBsYXJnZXIgdGhhbiAtNjUgYW5kIHNtYWxsZXIKICAgKiB0aGFuIDY0LgogICAqCiAgICogQHJldHVybiB7T3V0cHV0fSBSZXR1cm5zIHRoZSBgT3V0cHV0YCBvYmplY3Qgc28gbWV0aG9kcyBjYW4gYmUgY2hhaW5lZC4KICAgKi8KCgogIE91dHB1dC5wcm90b3R5cGUuc2V0TWFzdGVyVHVuaW5nID0gZnVuY3Rpb24gKHZhbHVlLCBjaGFubmVsLCBvcHRpb25zKSB7CiAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHZhbHVlID0gcGFyc2VGbG9hdCh2YWx1ZSkgfHwgMC4wOwoKICAgIGlmICh2YWx1ZSA8PSAtNjUgfHwgdmFsdWUgPj0gNjQpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIlRoZSB2YWx1ZSBtdXN0IGJlIGEgZGVjaW1hbCBudW1iZXIgbGFyZ2VyIHRoYW4gLTY1IGFuZCBzbWFsbGVyIHRoYW4gNjQuIik7CiAgICB9CgogICAgdmFyIGNvYXJzZSA9IE1hdGguZmxvb3IodmFsdWUpICsgNjQ7CiAgICB2YXIgZmluZSA9IHZhbHVlIC0gTWF0aC5mbG9vcih2YWx1ZSk7IC8vIENhbGN1bGF0ZSBNU0IgYW5kIExTQiBmb3IgZmluZSBhZGp1c3RtZW50ICgxNGJpdCByZXNvbHV0aW9uKQoKICAgIGZpbmUgPSBNYXRoLnJvdW5kKChmaW5lICsgMSkgLyAyICogMTYzODMpOwogICAgdmFyIG1zYiA9IGZpbmUgPj4gNyAmIDB4N0Y7CiAgICB2YXIgbHNiID0gZmluZSAmIDB4N0Y7CiAgICB3bS50b01JRElDaGFubmVscyhjaGFubmVsKS5mb3JFYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgdGhhdC5zZXRSZWdpc3RlcmVkUGFyYW1ldGVyKCJjaGFubmVsY29hcnNldHVuaW5nIiwgY29hcnNlLCBjaGFubmVsLCB7CiAgICAgICAgdGltZTogb3B0aW9ucy50aW1lCiAgICAgIH0pOwogICAgICB0aGF0LnNldFJlZ2lzdGVyZWRQYXJhbWV0ZXIoImNoYW5uZWxmaW5ldHVuaW5nIiwgW21zYiwgbHNiXSwgY2hhbm5lbCwgewogICAgICAgIHRpbWU6IG9wdGlvbnMudGltZQogICAgICB9KTsKICAgIH0pOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBTZXRzIHRoZSBNSURJIHR1bmluZyBwcm9ncmFtIHRvIHVzZS4gTm90ZSB0aGF0IHRoZSAqKlR1bmluZyBQcm9ncmFtKiogcGFyYW1ldGVyIGlzIHBhcnQgb2YgdGhlCiAgICogKk1JREkgVHVuaW5nIFN0YW5kYXJkKiwgd2hpY2ggaXMgbm90IHdpZGVseSBpbXBsZW1lbnRlZC4KICAgKgogICAqIEBtZXRob2Qgc2V0VHVuaW5nUHJvZ3JhbQogICAqIEBjaGFpbmFibGUKICAgKgogICAqIEBwYXJhbSB2YWx1ZSB7TnVtYmVyfSBUaGUgZGVzaXJlZCB0dW5pbmcgcHJvZ3JhbSAoMC0xMjcpLgogICAqCiAgICogQHBhcmFtIFtjaGFubmVsPWFsbF0ge051bWJlcnxBcnJheXxTdHJpbmd9IFRoZSBNSURJIGNoYW5uZWwgbnVtYmVyIChiZXR3ZWVuIDEgYW5kIDE2KSBvciBhbgogICAqIGFycmF5IG9mIGNoYW5uZWwgbnVtYmVycy4gSWYgdGhlIHNwZWNpYWwgdmFsdWUgImFsbCIgaXMgdXNlZCwgdGhlIG1lc3NhZ2Ugd2lsbCBiZSBzZW50IHRvIGFsbAogICAqIDE2IGNoYW5uZWxzLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zPXt9XQogICAqCiAgICogQHBhcmFtIHtET01IaWdoUmVzVGltZVN0YW1wfFN0cmluZ30gW29wdGlvbnMudGltZT11bmRlZmluZWRdIFRoaXMgdmFsdWUgY2FuIGJlIG9uZSBvZiB0d28KICAgKiB0aGluZ3MuIElmIHRoZSB2YWx1ZSBpcyBhIHN0cmluZyBzdGFydGluZyB3aXRoIHRoZSArIHNpZ24gYW5kIGZvbGxvd2VkIGJ5IGEgbnVtYmVyLCB0aGUgcmVxdWVzdAogICAqIHdpbGwgYmUgZGVsYXllZCBieSB0aGUgc3BlY2lmaWVkIG51bWJlciAoaW4gbWlsbGlzZWNvbmRzKS4gT3RoZXJ3aXNlLCB0aGUgdmFsdWUgaXMgY29uc2lkZXJlZCBhCiAgICogdGltZXN0YW1wIGFuZCB0aGUgcmVxdWVzdCB3aWxsIGJlIHNjaGVkdWxlZCBhdCB0aGF0IHRpbWVzdGFtcC4gVGhlIGBET01IaWdoUmVzVGltZVN0YW1wYCB2YWx1ZQogICAqIGlzIHJlbGF0aXZlIHRvIHRoZSBuYXZpZ2F0aW9uIHN0YXJ0IG9mIHRoZSBkb2N1bWVudC4gVG8gcmV0cmlldmUgdGhlIGN1cnJlbnQgdGltZSwgeW91IGNhbiB1c2UKICAgKiBgV2ViTWlkaS50aW1lYC4gSWYgYHRpbWVgIGlzIG5vdCBwcmVzZW50IG9yIGlzIHNldCB0byBhIHRpbWUgaW4gdGhlIHBhc3QsIHRoZSByZXF1ZXN0IGlzIHRvIGJlCiAgICogc2VudCBhcyBzb29uIGFzIHBvc3NpYmxlLgogICAqCiAgICogQHRocm93cyB7UmFuZ2VFcnJvcn0gVGhlIHByb2dyYW0gdmFsdWUgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDEyNy4KICAgKgogICAqIEByZXR1cm4ge091dHB1dH0gUmV0dXJucyB0aGUgYE91dHB1dGAgb2JqZWN0IHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICovCgoKICBPdXRwdXQucHJvdG90eXBlLnNldFR1bmluZ1Byb2dyYW0gPSBmdW5jdGlvbiAodmFsdWUsIGNoYW5uZWwsIG9wdGlvbnMpIHsKICAgIHZhciB0aGF0ID0gdGhpczsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgdmFsdWUgPSBNYXRoLmZsb29yKHZhbHVlKTsKCiAgICBpZiAoISh2YWx1ZSA+PSAwICYmIHZhbHVlIDw9IDEyNykpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIlRoZSBwcm9ncmFtIHZhbHVlIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxMjciKTsKICAgIH0KCiAgICB3bS50b01JRElDaGFubmVscyhjaGFubmVsKS5mb3JFYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgdGhhdC5zZXRSZWdpc3RlcmVkUGFyYW1ldGVyKCJ0dW5pbmdwcm9ncmFtIiwgdmFsdWUsIGNoYW5uZWwsIHsKICAgICAgICB0aW1lOiBvcHRpb25zLnRpbWUKICAgICAgfSk7CiAgICB9KTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgLyoqCiAgICogU2V0cyB0aGUgTUlESSB0dW5pbmcgYmFuayB0byB1c2UuIE5vdGUgdGhhdCB0aGUgKipUdW5pbmcgQmFuayoqIHBhcmFtZXRlciBpcyBwYXJ0IG9mIHRoZQogICAqICpNSURJIFR1bmluZyBTdGFuZGFyZCosIHdoaWNoIGlzIG5vdCB3aWRlbHkgaW1wbGVtZW50ZWQuCiAgICoKICAgKiBAbWV0aG9kIHNldFR1bmluZ0JhbmsKICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0gdmFsdWUge051bWJlcn0gVGhlIGRlc2lyZWQgdHVuaW5nIGJhbmsgKDAtMTI3KS4KICAgKgogICAqIEBwYXJhbSBbY2hhbm5lbD1hbGxdIHtOdW1iZXJ8QXJyYXl8U3RyaW5nfSBUaGUgTUlESSBjaGFubmVsIG51bWJlciAoYmV0d2VlbiAxIGFuZCAxNikgb3IgYW4KICAgKiBhcnJheSBvZiBjaGFubmVsIG51bWJlcnMuIElmIHRoZSBzcGVjaWFsIHZhbHVlICJhbGwiIGlzIHVzZWQsIHRoZSBtZXNzYWdlIHdpbGwgYmUgc2VudCB0byBhbGwKICAgKiAxNiBjaGFubmVscy4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucz17fV0KICAgKgogICAqIEBwYXJhbSB7RE9NSGlnaFJlc1RpbWVTdGFtcHxTdHJpbmd9IFtvcHRpb25zLnRpbWU9dW5kZWZpbmVkXSBUaGlzIHZhbHVlIGNhbiBiZSBvbmUgb2YgdHdvCiAgICogdGhpbmdzLiBJZiB0aGUgdmFsdWUgaXMgYSBzdHJpbmcgc3RhcnRpbmcgd2l0aCB0aGUgKyBzaWduIGFuZCBmb2xsb3dlZCBieSBhIG51bWJlciwgdGhlIHJlcXVlc3QKICAgKiB3aWxsIGJlIGRlbGF5ZWQgYnkgdGhlIHNwZWNpZmllZCBudW1iZXIgKGluIG1pbGxpc2Vjb25kcykuIE90aGVyd2lzZSwgdGhlIHZhbHVlIGlzIGNvbnNpZGVyZWQgYQogICAqIHRpbWVzdGFtcCBhbmQgdGhlIHJlcXVlc3Qgd2lsbCBiZSBzY2hlZHVsZWQgYXQgdGhhdCB0aW1lc3RhbXAuIFRoZSBgRE9NSGlnaFJlc1RpbWVTdGFtcGAgdmFsdWUKICAgKiBpcyByZWxhdGl2ZSB0byB0aGUgbmF2aWdhdGlvbiBzdGFydCBvZiB0aGUgZG9jdW1lbnQuIFRvIHJldHJpZXZlIHRoZSBjdXJyZW50IHRpbWUsIHlvdSBjYW4gdXNlCiAgICogYFdlYk1pZGkudGltZWAuIElmIGB0aW1lYCBpcyBub3QgcHJlc2VudCBvciBpcyBzZXQgdG8gYSB0aW1lIGluIHRoZSBwYXN0LCB0aGUgcmVxdWVzdCBpcyB0byBiZQogICAqIHNlbnQgYXMgc29vbiBhcyBwb3NzaWJsZS4KICAgKgogICAqIEB0aHJvd3Mge1JhbmdlRXJyb3J9IFRoZSBiYW5rIHZhbHVlIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxMjcuCiAgICoKICAgKiBAcmV0dXJuIHtPdXRwdXR9IFJldHVybnMgdGhlIGBPdXRwdXRgIG9iamVjdCBzbyBtZXRob2RzIGNhbiBiZSBjaGFpbmVkLgogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5zZXRUdW5pbmdCYW5rID0gZnVuY3Rpb24gKHZhbHVlLCBjaGFubmVsLCBvcHRpb25zKSB7CiAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHZhbHVlID0gTWF0aC5mbG9vcih2YWx1ZSkgfHwgMDsKCiAgICBpZiAoISh2YWx1ZSA+PSAwICYmIHZhbHVlIDw9IDEyNykpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIlRoZSBiYW5rIHZhbHVlIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxMjciKTsKICAgIH0KCiAgICB3bS50b01JRElDaGFubmVscyhjaGFubmVsKS5mb3JFYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgdGhhdC5zZXRSZWdpc3RlcmVkUGFyYW1ldGVyKCJ0dW5pbmdiYW5rIiwgdmFsdWUsIGNoYW5uZWwsIHsKICAgICAgICB0aW1lOiBvcHRpb25zLnRpbWUKICAgICAgfSk7CiAgICB9KTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgLyoqCiAgICogU2VuZHMgYSBNSURJIGBjaGFubmVsIG1vZGVgIG1lc3NhZ2UgdG8gdGhlIHNwZWNpZmllZCBjaGFubmVsKHMpLiBUaGUgY2hhbm5lbCBtb2RlIG1lc3NhZ2UgdG8KICAgKiBzZW5kIGNhbiBiZSBzcGVjaWZpZWQgbnVtZXJpY2FsbHkgb3IgYnkgdXNpbmcgb25lIG9mIHRoZSBmb2xsb3dpbmcgY29tbW9uIG5hbWVzOgogICAqCiAgICogICAqIGBhbGxzb3VuZG9mZmAgKCMxMjApCiAgICogICAqIGByZXNldGFsbGNvbnRyb2xsZXJzYCAoIzEyMSkKICAgKiAgICogYGxvY2FsY29udHJvbGAgKCMxMjIpCiAgICogICAqIGBhbGxub3Rlc29mZmAgKCMxMjMpCiAgICogICAqIGBvbW5pbW9kZW9mZmAgKCMxMjQpCiAgICogICAqIGBvbW5pbW9kZW9uYCAoIzEyNSkKICAgKiAgICogYG1vbm9tb2Rlb25gICgjMTI2KQogICAqICAgKiBgcG9seW1vZGVvbmAgKCMxMjcpCiAgICoKICAgKiBJdCBzaG91bGQgYmUgbm90ZWQgdGhhdCwgcGVyIHRoZSBNSURJIHNwZWNpZmljYXRpb24sIG9ubHkgYGxvY2FsY29udHJvbGAgYW5kIGBtb25vbW9kZW9uYCBtYXkKICAgKiByZXF1aXJlIGEgdmFsdWUgdGhhdCJzIG5vdCB6ZXJvLiBGb3IgdGhhdCByZWFzb24sIHRoZSBgdmFsdWVgIHBhcmFtZXRlciBpcyBvcHRpb25hbCBhbmQKICAgKiBkZWZhdWx0cyB0byAwLgogICAqCiAgICogQG1ldGhvZCBzZW5kQ2hhbm5lbE1vZGUKICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0gY29tbWFuZCB7TnVtYmVyfFN0cmluZ30gVGhlIG51bWVyaWNhbCBpZGVudGlmaWVyIG9mIHRoZSBjaGFubmVsIG1vZGUgbWVzc2FnZSAoaW50ZWdlcgogICAqIGJldHdlZW4gMTIwLTEyNykgb3IgaXRzIG5hbWUgYXMgYSBzdHJpbmcuCiAgICogQHBhcmFtIFt2YWx1ZT0wXSB7TnVtYmVyfSBUaGUgdmFsdWUgdG8gc2VuZCAoaW50ZWdlciBiZXR3ZWVuIDAtMTI3KS4KICAgKiBAcGFyYW0gW2NoYW5uZWw9YWxsXSB7TnVtYmVyfEFycmF5fFN0cmluZ30gVGhlIE1JREkgY2hhbm5lbCBudW1iZXIgKGJldHdlZW4gMSBhbmQgMTYpIG9yIGFuCiAgICogYXJyYXkgb2YgY2hhbm5lbCBudW1iZXJzLiBJZiB0aGUgc3BlY2lhbCB2YWx1ZSAiYWxsIiBpcyB1c2VkLCB0aGUgbWVzc2FnZSB3aWxsIGJlIHNlbnQgdG8gYWxsCiAgICogMTYgY2hhbm5lbHMuCiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zPXt9XQogICAqIEBwYXJhbSB7RE9NSGlnaFJlc1RpbWVTdGFtcHxTdHJpbmd9IFtvcHRpb25zLnRpbWU9dW5kZWZpbmVkXSBUaGlzIHZhbHVlIGNhbiBiZSBvbmUgb2YgdHdvCiAgICogdGhpbmdzLiBJZiB0aGUgdmFsdWUgaXMgYSBzdHJpbmcgc3RhcnRpbmcgd2l0aCB0aGUgKyBzaWduIGFuZCBmb2xsb3dlZCBieSBhIG51bWJlciwgdGhlIHJlcXVlc3QKICAgKiB3aWxsIGJlIGRlbGF5ZWQgYnkgdGhlIHNwZWNpZmllZCBudW1iZXIgKGluIG1pbGxpc2Vjb25kcykuIE90aGVyd2lzZSwgdGhlIHZhbHVlIGlzIGNvbnNpZGVyZWQgYQogICAqIHRpbWVzdGFtcCBhbmQgdGhlIHJlcXVlc3Qgd2lsbCBiZSBzY2hlZHVsZWQgYXQgdGhhdCB0aW1lc3RhbXAuIFRoZSBgRE9NSGlnaFJlc1RpbWVTdGFtcGAgdmFsdWUKICAgKiBpcyByZWxhdGl2ZSB0byB0aGUgbmF2aWdhdGlvbiBzdGFydCBvZiB0aGUgZG9jdW1lbnQuIFRvIHJldHJpZXZlIHRoZSBjdXJyZW50IHRpbWUsIHlvdSBjYW4gdXNlCiAgICogYFdlYk1pZGkudGltZWAuIElmIGB0aW1lYCBpcyBub3QgcHJlc2VudCBvciBpcyBzZXQgdG8gYSB0aW1lIGluIHRoZSBwYXN0LCB0aGUgcmVxdWVzdCBpcyB0byBiZQogICAqIHNlbnQgYXMgc29vbiBhcyBwb3NzaWJsZS4KICAgKgogICAqIEB0aHJvd3Mge1R5cGVFcnJvcn0gSW52YWxpZCBjaGFubmVsIG1vZGUgbWVzc2FnZSBuYW1lLgogICAqIEB0aHJvd3Mge1JhbmdlRXJyb3J9IENoYW5uZWwgbW9kZSBjb250cm9sbGVyIG51bWJlcnMgbXVzdCBiZSBiZXR3ZWVuIDEyMCBhbmQgMTI3LgogICAqIEB0aHJvd3Mge1JhbmdlRXJyb3J9IFZhbHVlIG11c3QgYmUgYW4gaW50ZWdlciBiZXR3ZWVuIDAgYW5kIDEyNy4KICAgKgogICAqIEByZXR1cm4ge091dHB1dH0gUmV0dXJucyB0aGUgYE91dHB1dGAgb2JqZWN0IHNvIG1ldGhvZHMgY2FuIGJlIGNoYWluZWQuCiAgICoKICAgKi8KCgogIE91dHB1dC5wcm90b3R5cGUuc2VuZENoYW5uZWxNb2RlID0gZnVuY3Rpb24gKGNvbW1hbmQsIHZhbHVlLCBjaGFubmVsLCBvcHRpb25zKSB7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICBpZiAodHlwZW9mIGNvbW1hbmQgPT09ICJzdHJpbmciKSB7CiAgICAgIGNvbW1hbmQgPSB3bS5NSURJX0NIQU5ORUxfTU9ERV9NRVNTQUdFU1tjb21tYW5kXTsKCiAgICAgIGlmICghY29tbWFuZCkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkludmFsaWQgY2hhbm5lbCBtb2RlIG1lc3NhZ2UgbmFtZS4iKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY29tbWFuZCA9IE1hdGguZmxvb3IoY29tbWFuZCk7CgogICAgICBpZiAoIShjb21tYW5kID49IDEyMCAmJiBjb21tYW5kIDw9IDEyNykpIHsKICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigiQ2hhbm5lbCBtb2RlIG51bWVyaWNhbCBpZGVudGlmaWVycyBtdXN0IGJlIGJldHdlZW4gMTIwIGFuZCAxMjcuIik7CiAgICAgIH0KICAgIH0KCiAgICB2YWx1ZSA9IE1hdGguZmxvb3IodmFsdWUpIHx8IDA7CgogICAgaWYgKHZhbHVlIDwgMCB8fCB2YWx1ZSA+IDEyNykgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigiVmFsdWUgbXVzdCBiZSBhbiBpbnRlZ2VyIGJldHdlZW4gMCBhbmQgMTI3LiIpOwogICAgfQoKICAgIHdtLnRvTUlESUNoYW5uZWxzKGNoYW5uZWwpLmZvckVhY2goZnVuY3Rpb24gKGNoKSB7CiAgICAgIHRoaXMuc2VuZCgod20uTUlESV9DSEFOTkVMX01FU1NBR0VTLmNoYW5uZWxtb2RlIDw8IDQpICsgKGNoIC0gMSksIFtjb21tYW5kLCB2YWx1ZV0sIHRoaXMuX3BhcnNlVGltZVBhcmFtZXRlcihvcHRpb25zLnRpbWUpKTsKICAgIH0uYmluZCh0aGlzKSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIFNlbmRzIGEgTUlESSBgcHJvZ3JhbSBjaGFuZ2VgIG1lc3NhZ2UgdG8gdGhlIHNwZWNpZmllZCBjaGFubmVsKHMpIGF0IHRoZSBzY2hlZHVsZWQgdGltZS4KICAgKgogICAqIEBtZXRob2Qgc2VuZFByb2dyYW1DaGFuZ2UKICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0gcHJvZ3JhbSB7TnVtYmVyfSBUaGUgTUlESSBwYXRjaCAocHJvZ3JhbSkgbnVtYmVyICgwLTEyNykKICAgKgogICAqIEBwYXJhbSBbY2hhbm5lbD1hbGxdIHtOdW1iZXJ8QXJyYXl8U3RyaW5nfSBUaGUgTUlESSBjaGFubmVsIG51bWJlciAoYmV0d2VlbiAxIGFuZCAxNikgb3IgYW4KICAgKiBhcnJheSBvZiBjaGFubmVsIG51bWJlcnMuIElmIHRoZSBzcGVjaWFsIHZhbHVlICJhbGwiIGlzIHVzZWQsIHRoZSBtZXNzYWdlIHdpbGwgYmUgc2VudCB0byBhbGwKICAgKiAxNiBjaGFubmVscy4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucz17fV0KICAgKgogICAqIEBwYXJhbSB7RE9NSGlnaFJlc1RpbWVTdGFtcHxTdHJpbmd9IFtvcHRpb25zLnRpbWU9dW5kZWZpbmVkXSBUaGlzIHZhbHVlIGNhbiBiZSBvbmUgb2YgdHdvCiAgICogdGhpbmdzLiBJZiB0aGUgdmFsdWUgaXMgYSBzdHJpbmcgc3RhcnRpbmcgd2l0aCB0aGUgKyBzaWduIGFuZCBmb2xsb3dlZCBieSBhIG51bWJlciwgdGhlIHJlcXVlc3QKICAgKiB3aWxsIGJlIGRlbGF5ZWQgYnkgdGhlIHNwZWNpZmllZCBudW1iZXIgKGluIG1pbGxpc2Vjb25kcykuIE90aGVyd2lzZSwgdGhlIHZhbHVlIGlzIGNvbnNpZGVyZWQgYQogICAqIHRpbWVzdGFtcCBhbmQgdGhlIHJlcXVlc3Qgd2lsbCBiZSBzY2hlZHVsZWQgYXQgdGhhdCB0aW1lc3RhbXAuIFRoZSBgRE9NSGlnaFJlc1RpbWVTdGFtcGAgdmFsdWUKICAgKiBpcyByZWxhdGl2ZSB0byB0aGUgbmF2aWdhdGlvbiBzdGFydCBvZiB0aGUgZG9jdW1lbnQuIFRvIHJldHJpZXZlIHRoZSBjdXJyZW50IHRpbWUsIHlvdSBjYW4gdXNlCiAgICogYFdlYk1pZGkudGltZWAuIElmIGB0aW1lYCBpcyBub3QgcHJlc2VudCBvciBpcyBzZXQgdG8gYSB0aW1lIGluIHRoZSBwYXN0LCB0aGUgcmVxdWVzdCBpcyB0byBiZQogICAqIHNlbnQgYXMgc29vbiBhcyBwb3NzaWJsZS4KICAgKgogICAqIEB0aHJvd3Mge1JhbmdlRXJyb3J9IFByb2dyYW0gbnVtYmVycyBtdXN0IGJlIGJldHdlZW4gMCBhbmQgMTI3LgogICAqCiAgICogQHJldHVybiB7T3V0cHV0fSBSZXR1cm5zIHRoZSBgT3V0cHV0YCBvYmplY3Qgc28gbWV0aG9kcyBjYW4gYmUgY2hhaW5lZC4KICAgKgogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5zZW5kUHJvZ3JhbUNoYW5nZSA9IGZ1bmN0aW9uIChwcm9ncmFtLCBjaGFubmVsLCBvcHRpb25zKSB7CiAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHByb2dyYW0gPSBNYXRoLmZsb29yKHByb2dyYW0pOwoKICAgIGlmIChpc05hTihwcm9ncmFtKSB8fCBwcm9ncmFtIDwgMCB8fCBwcm9ncmFtID4gMTI3KSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJQcm9ncmFtIG51bWJlcnMgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDEyNy4iKTsKICAgIH0KCiAgICB3bS50b01JRElDaGFubmVscyhjaGFubmVsKS5mb3JFYWNoKGZ1bmN0aW9uIChjaCkgewogICAgICB0aGF0LnNlbmQoKHdtLk1JRElfQ0hBTk5FTF9NRVNTQUdFUy5wcm9ncmFtY2hhbmdlIDw8IDQpICsgKGNoIC0gMSksIFtwcm9ncmFtXSwgdGhhdC5fcGFyc2VUaW1lUGFyYW1ldGVyKG9wdGlvbnMudGltZSkpOwogICAgfSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIC8qKgogICAqIFNlbmRzIGEgTUlESSBgY2hhbm5lbCBhZnRlcnRvdWNoYCBtZXNzYWdlIHRvIHRoZSBzcGVjaWZpZWQgY2hhbm5lbChzKS4gRm9yIGtleS1zcGVjaWZpYwogICAqIGFmdGVydG91Y2gsIHlvdSBzaG91bGQgaW5zdGVhZCB1c2UgYHNlbmRLZXlBZnRlcnRvdWNoKClgLgogICAqCiAgICogQG1ldGhvZCBzZW5kQ2hhbm5lbEFmdGVydG91Y2gKICAgKiBAY2hhaW5hYmxlCiAgICoKICAgKiBAcGFyYW0gW3ByZXNzdXJlPTAuNV0ge051bWJlcn0gVGhlIHByZXNzdXJlIGxldmVsIChiZXR3ZWVuIDAgYW5kIDEpLiBBbiBpbnZhbGlkIHByZXNzdXJlIHZhbHVlCiAgICogd2lsbCBzaWxlbnRseSB0cmlnZ2VyIHRoZSBkZWZhdWx0IGJlaGF2aW91ci4KICAgKgogICAqIEBwYXJhbSBbY2hhbm5lbD1hbGxdIHtOdW1iZXJ8QXJyYXl8U3RyaW5nfSAgVGhlIE1JREkgY2hhbm5lbCBudW1iZXIgKGJldHdlZW4gMSBhbmQgMTYpIG9yCiAgICogYW4gYXJyYXkgb2YgY2hhbm5lbCBudW1iZXJzLiBJZiB0aGUgc3BlY2lhbCB2YWx1ZSAiYWxsIiBpcyB1c2VkLCB0aGUgbWVzc2FnZSB3aWxsIGJlIHNlbnQgdG8KICAgKiBhbGwgMTYgY2hhbm5lbHMuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dCiAgICoKICAgKiBAcGFyYW0ge0RPTUhpZ2hSZXNUaW1lU3RhbXB8U3RyaW5nfSBbb3B0aW9ucy50aW1lPXVuZGVmaW5lZF0gVGhpcyB2YWx1ZSBjYW4gYmUgb25lIG9mIHR3bwogICAqIHRoaW5ncy4gSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHN0YXJ0aW5nIHdpdGggdGhlICsgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsIHRoZSByZXF1ZXN0CiAgICogd2lsbCBiZSBkZWxheWVkIGJ5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIChpbiBtaWxsaXNlY29uZHMpLiBPdGhlcndpc2UsIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEKICAgKiB0aW1lc3RhbXAgYW5kIHRoZSByZXF1ZXN0IHdpbGwgYmUgc2NoZWR1bGVkIGF0IHRoYXQgdGltZXN0YW1wLiBUaGUgYERPTUhpZ2hSZXNUaW1lU3RhbXBgIHZhbHVlCiAgICogaXMgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LiBUbyByZXRyaWV2ZSB0aGUgY3VycmVudCB0aW1lLCB5b3UgY2FuIHVzZQogICAqIGBXZWJNaWRpLnRpbWVgLiBJZiBgdGltZWAgaXMgbm90IHByZXNlbnQgb3IgaXMgc2V0IHRvIGEgdGltZSBpbiB0aGUgcGFzdCwgdGhlIHJlcXVlc3QgaXMgdG8gYmUKICAgKiBzZW50IGFzIHNvb24gYXMgcG9zc2libGUuCiAgICoKICAgKiBAcmV0dXJuIHtPdXRwdXR9IFJldHVybnMgdGhlIGBPdXRwdXRgIG9iamVjdCBzbyBtZXRob2RzIGNhbiBiZSBjaGFpbmVkLgogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5zZW5kQ2hhbm5lbEFmdGVydG91Y2ggPSBmdW5jdGlvbiAocHJlc3N1cmUsIGNoYW5uZWwsIG9wdGlvbnMpIHsKICAgIHZhciB0aGF0ID0gdGhpczsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgcHJlc3N1cmUgPSBwYXJzZUZsb2F0KHByZXNzdXJlKTsKCiAgICBpZiAoaXNOYU4ocHJlc3N1cmUpIHx8IHByZXNzdXJlIDwgMCB8fCBwcmVzc3VyZSA+IDEpIHsKICAgICAgcHJlc3N1cmUgPSAwLjU7CiAgICB9CgogICAgdmFyIG5QcmVzc3VyZSA9IE1hdGgucm91bmQocHJlc3N1cmUgKiAxMjcpOwogICAgd20udG9NSURJQ2hhbm5lbHMoY2hhbm5lbCkuZm9yRWFjaChmdW5jdGlvbiAoY2gpIHsKICAgICAgdGhhdC5zZW5kKCh3bS5NSURJX0NIQU5ORUxfTUVTU0FHRVMuY2hhbm5lbGFmdGVydG91Y2ggPDwgNCkgKyAoY2ggLSAxKSwgW25QcmVzc3VyZV0sIHRoYXQuX3BhcnNlVGltZVBhcmFtZXRlcihvcHRpb25zLnRpbWUpKTsKICAgIH0pOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvKioKICAgKiBTZW5kcyBhIE1JREkgYHBpdGNoIGJlbmRgIG1lc3NhZ2UgdG8gdGhlIHNwZWNpZmllZCBjaGFubmVsKHMpIGF0IHRoZSBzY2hlZHVsZWQgdGltZS4KICAgKgogICAqIEBtZXRob2Qgc2VuZFBpdGNoQmVuZAogICAqIEBjaGFpbmFibGUKICAgKgogICAqIEBwYXJhbSBiZW5kIHtOdW1iZXJ9IFRoZSBpbnRlbnNpdHkgbGV2ZWwgb2YgdGhlIGJlbmQgKGJldHdlZW4gLTEgYW5kIDEpLiBBIHZhbHVlIG9mIHplcm8gbWVhbnMKICAgKiBubyBiZW5kLgogICAqCiAgICogQHBhcmFtIFtjaGFubmVsPWFsbF0ge051bWJlcnxBcnJheXxTdHJpbmd9ICBUaGUgTUlESSBjaGFubmVsIG51bWJlciAoYmV0d2VlbiAxIGFuZCAxNikgb3IgYW4KICAgKiBhcnJheSBvZiBjaGFubmVsIG51bWJlcnMuIElmIHRoZSBzcGVjaWFsIHZhbHVlICJhbGwiIGlzIHVzZWQsIHRoZSBtZXNzYWdlIHdpbGwgYmUgc2VudCB0byBhbGwKICAgKiAxNiBjaGFubmVscy4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucz17fV0KICAgKgogICAqIEBwYXJhbSB7RE9NSGlnaFJlc1RpbWVTdGFtcHxTdHJpbmd9IFtvcHRpb25zLnRpbWU9dW5kZWZpbmVkXSBUaGlzIHZhbHVlIGNhbiBiZSBvbmUgb2YgdHdvCiAgICogdGhpbmdzLiBJZiB0aGUgdmFsdWUgaXMgYSBzdHJpbmcgc3RhcnRpbmcgd2l0aCB0aGUgKyBzaWduIGFuZCBmb2xsb3dlZCBieSBhIG51bWJlciwgdGhlIHJlcXVlc3QKICAgKiB3aWxsIGJlIGRlbGF5ZWQgYnkgdGhlIHNwZWNpZmllZCBudW1iZXIgKGluIG1pbGxpc2Vjb25kcykuIE90aGVyd2lzZSwgdGhlIHZhbHVlIGlzIGNvbnNpZGVyZWQgYQogICAqIHRpbWVzdGFtcCBhbmQgdGhlIHJlcXVlc3Qgd2lsbCBiZSBzY2hlZHVsZWQgYXQgdGhhdCB0aW1lc3RhbXAuIFRoZSBgRE9NSGlnaFJlc1RpbWVTdGFtcGAgdmFsdWUKICAgKiBpcyByZWxhdGl2ZSB0byB0aGUgbmF2aWdhdGlvbiBzdGFydCBvZiB0aGUgZG9jdW1lbnQuIFRvIHJldHJpZXZlIHRoZSBjdXJyZW50IHRpbWUsIHlvdSBjYW4gdXNlCiAgICogYFdlYk1pZGkudGltZWAuIElmIGB0aW1lYCBpcyBub3QgcHJlc2VudCBvciBpcyBzZXQgdG8gYSB0aW1lIGluIHRoZSBwYXN0LCB0aGUgcmVxdWVzdCBpcyB0byBiZQogICAqIHNlbnQgYXMgc29vbiBhcyBwb3NzaWJsZS4KICAgKgogICAqIEB0aHJvd3Mge1JhbmdlRXJyb3J9IFBpdGNoIGJlbmQgdmFsdWUgbXVzdCBiZSBiZXR3ZWVuIC0xIGFuZCAxLgogICAqCiAgICogQHJldHVybiB7T3V0cHV0fSBSZXR1cm5zIHRoZSBgT3V0cHV0YCBvYmplY3Qgc28gbWV0aG9kcyBjYW4gYmUgY2hhaW5lZC4KICAgKi8KCgogIE91dHB1dC5wcm90b3R5cGUuc2VuZFBpdGNoQmVuZCA9IGZ1bmN0aW9uIChiZW5kLCBjaGFubmVsLCBvcHRpb25zKSB7CiAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICBpZiAoaXNOYU4oYmVuZCkgfHwgYmVuZCA8IC0xIHx8IGJlbmQgPiAxKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJQaXRjaCBiZW5kIHZhbHVlIG11c3QgYmUgYmV0d2VlbiAtMSBhbmQgMS4iKTsKICAgIH0KCiAgICB2YXIgbkxldmVsID0gTWF0aC5yb3VuZCgoYmVuZCArIDEpIC8gMiAqIDE2MzgzKTsKICAgIHZhciBtc2IgPSBuTGV2ZWwgPj4gNyAmIDB4N0Y7CiAgICB2YXIgbHNiID0gbkxldmVsICYgMHg3RjsKICAgIHdtLnRvTUlESUNoYW5uZWxzKGNoYW5uZWwpLmZvckVhY2goZnVuY3Rpb24gKGNoKSB7CiAgICAgIHRoYXQuc2VuZCgod20uTUlESV9DSEFOTkVMX01FU1NBR0VTLnBpdGNoYmVuZCA8PCA0KSArIChjaCAtIDEpLCBbbHNiLCBtc2JdLCB0aGF0Ll9wYXJzZVRpbWVQYXJhbWV0ZXIob3B0aW9ucy50aW1lKSk7CiAgICB9KTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgLyoqCiAgICogUmV0dXJucyBhIHRpbWVzdGFtcCwgcmVsYXRpdmUgdG8gdGhlIG5hdmlnYXRpb24gc3RhcnQgb2YgdGhlIGRvY3VtZW50LCBkZXJpdmVkIGZyb20gdGhlIGB0aW1lYAogICAqIHBhcmFtZXRlci4gSWYgdGhlIHBhcmFtZXRlciBpcyBhIHN0cmluZyBzdGFydGluZyB3aXRoIHRoZSAiKyIgc2lnbiBhbmQgZm9sbG93ZWQgYnkgYSBudW1iZXIsCiAgICogdGhlIHJlc3VsdGluZyB2YWx1ZSB3aWxsIGJlIHRoZSBzdW0gb2YgdGhlIGN1cnJlbnQgdGltZXN0YW1wIHBsdXMgdGhhdCBudW1iZXIuIE90aGVyd2lzZSwgdGhlCiAgICogdmFsdWUgd2lsbCBiZSByZXR1cm5lZCBhcyBpcy4KICAgKgogICAqIElmIHRoZSBjYWxjdWxhdGVkIHJldHVybiB2YWx1ZSBpcyAwLCBsZXNzIHRoYW4gemVybyBvciBhbiBvdGhlcndpc2UgaW52YWxpZCB2YWx1ZSwgYHVuZGVmaW5lZGAKICAgKiB3aWxsIGJlIHJldHVybmVkLgogICAqCiAgICogQG1ldGhvZCBfcGFyc2VUaW1lUGFyYW1ldGVyCiAgICogQHBhcmFtIFt0aW1lXSB7TnVtYmVyfFN0cmluZ30KICAgKiBAcmV0dXJuIERPTUhpZ2hSZXNUaW1lU3RhbXAKICAgKiBAcHJvdGVjdGVkCiAgICovCgoKICBPdXRwdXQucHJvdG90eXBlLl9wYXJzZVRpbWVQYXJhbWV0ZXIgPSBmdW5jdGlvbiAodGltZSkgewogICAgdmFyIHZhbHVlLAogICAgICAgIHBhcnNlZCA9IHBhcnNlRmxvYXQodGltZSk7CgogICAgaWYgKHR5cGVvZiB0aW1lID09PSAic3RyaW5nIiAmJiB0aW1lLnN1YnN0cmluZygwLCAxKSA9PT0gIisiKSB7CiAgICAgIGlmIChwYXJzZWQgJiYgcGFyc2VkID4gMCkgdmFsdWUgPSB3bS50aW1lICsgcGFyc2VkOwogICAgfSBlbHNlIHsKICAgICAgaWYgKHBhcnNlZCA+IHdtLnRpbWUpIHZhbHVlID0gcGFyc2VkOwogICAgfQoKICAgIHJldHVybiB2YWx1ZTsKICB9OwogIC8qKgogICAqIENvbnZlcnRzIGFuIGlucHV0IHZhbHVlICh3aGljaCBjYW4gYmUgYSB1aW50LCBhIHN0cmluZyBvciBhbiBhcnJheSBvZiB0aGUgcHJldmlvdXMgdHdvKSB0byBhbgogICAqIGFycmF5IG9mIE1JREkgbm90ZSBudW1iZXJzLgogICAqCiAgICogQG1ldGhvZCBfY29udmVydE5vdGVUb0FycmF5CiAgICogQHBhcmFtIFtub3RlXSB7TnVtYmVyfEFycmF5fFN0cmluZ30KICAgKiBAcmV0dXJucyB7QXJyYXl9CiAgICogQHByb3RlY3RlZAogICAqLwoKCiAgT3V0cHV0LnByb3RvdHlwZS5fY29udmVydE5vdGVUb0FycmF5ID0gZnVuY3Rpb24gKG5vdGUpIHsKICAgIHZhciBub3RlcyA9IFtdOwoKICAgIGlmICghQXJyYXkuaXNBcnJheShub3RlKSkgewogICAgICBub3RlID0gW25vdGVdOwogICAgfQoKICAgIG5vdGUuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkgewogICAgICBub3Rlcy5wdXNoKHdtLmd1ZXNzTm90ZU51bWJlcihpdGVtKSk7CiAgICB9KTsKICAgIHJldHVybiBub3RlczsKICB9OyAvLyBDaGVjayBpZiBSZXF1aXJlSlMvQU1EIGlzIHVzZWQuIElmIGl0IGlzLCB1c2UgaXQgdG8gZGVmaW5lIG91ciBtb2R1bGUgaW5zdGVhZCBvZgogIC8vIHBvbGx1dGluZyB0aGUgZ2xvYmFsIHNwYWNlLgoKCiAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgX3R5cGVvZihkZWZpbmUuYW1kKSA9PT0gIm9iamVjdCIpIHsKICAgIGRlZmluZShbXSwgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gd207CiAgICB9KTsKICB9IGVsc2UgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICJ1bmRlZmluZWQiICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHdtOwogIH0gZWxzZSB7CiAgICBpZiAoIXNjb3BlLldlYk1pZGkpIHsKICAgICAgc2NvcGUuV2ViTWlkaSA9IHdtOwogICAgfQogIH0KfSkodGhpcyk7"},{"version":3,"sources":["/Users/huntermedlen/Programming/music-trainer/frontend/src/webmidi.js"],"names":["scope","WebMidi","prototype","_singleton","Error","_inputs","_outputs","_userHandlers","_stateChangeQueue","_processingStateChange","_midiInterfaceEvents","_nrpnBuffer","_nrpnEventsEnabled","_nrpnTypes","_notes","_semitones","C","D","E","F","G","A","B","Object","defineProperties","MIDI_SYSTEM_MESSAGES","value","sysex","timecode","songposition","songselect","tuningrequest","sysexend","clock","start","stop","activesensing","reset","midimessage","unknownsystemmessage","writable","enumerable","configurable","MIDI_CHANNEL_MESSAGES","noteoff","noteon","keyaftertouch","controlchange","channelmode","nrpn","programchange","channelaftertouch","pitchbend","MIDI_REGISTERED_PARAMETER","pitchbendrange","channelfinetuning","channelcoarsetuning","tuningprogram","tuningbank","modulationrange","azimuthangle","elevationangle","gain","distanceratio","maximumdistance","maximumdistancegain","referencedistanceratio","panspreadangle","rollangle","MIDI_CONTROL_CHANGE_MESSAGES","bankselectcoarse","modulationwheelcoarse","breathcontrollercoarse","footcontrollercoarse","portamentotimecoarse","dataentrycoarse","volumecoarse","balancecoarse","pancoarse","expressioncoarse","effectcontrol1coarse","effectcontrol2coarse","generalpurposeslider1","generalpurposeslider2","generalpurposeslider3","generalpurposeslider4","bankselectfine","modulationwheelfine","breathcontrollerfine","footcontrollerfine","portamentotimefine","dataentryfine","volumefine","balancefine","panfine","expressionfine","effectcontrol1fine","effectcontrol2fine","holdpedal","portamento","sustenutopedal","softpedal","legatopedal","hold2pedal","soundvariation","resonance","soundreleasetime","soundattacktime","brightness","soundcontrol6","soundcontrol7","soundcontrol8","soundcontrol9","soundcontrol10","generalpurposebutton1","generalpurposebutton2","generalpurposebutton3","generalpurposebutton4","reverblevel","tremololevel","choruslevel","celestelevel","phaserlevel","databuttonincrement","databuttondecrement","nonregisteredparametercoarse","nonregisteredparameterfine","registeredparametercoarse","registeredparameterfine","MIDI_NRPN_MESSAGES","entrymsb","entrylsb","increment","decrement","paramlsb","parammsb","nullactiveparameter","MIDI_CHANNEL_MODE_MESSAGES","allsoundoff","resetallcontrollers","localcontrol","allnotesoff","omnimodeoff","omnimodeon","monomodeon","polymodeon","octaveOffset","supported","get","navigator","enabled","undefined","bind","inputs","outputs","sysexEnabled","nrpnEventsEnabled","set","nrpnTypes","time","performance","now","wm","enable","callback","requestMIDIAccess","then","midiAccess","events","promises","promiseTimeout","_resetInterfaceUserHandlers","onstatechange","e","push","values","input","next","done","open","output","onPortsOpen","clearTimeout","_updateInputsAndOutputs","_onInterfaceStateChange","call","forEach","event","setTimeout","Promise","all","err","console","warn","disable","addListener","type","listener","TypeError","indexOf","hasListener","o","length","removeListener","splice","toMIDIChannels","channel","channels","Array","isArray","map","ch","parseInt","filter","getInputById","id","String","i","getOutputById","getInputByName","name","getOctave","number","Math","floor","getOutputByName","guessNoteNumber","toFixed","round","noteNameToNumber","matches","match","RangeError","semitones","toUpperCase","octave","result","toLowerCase","_updateInputs","_updateOutputs","remove","updated","_midiInput","nInput","add","j","Input","_midiOutput","nOutput","Output","timestamp","timeStamp","port","state","connection","manufacturer","handler","midiInput","that","system","_initializeUserHandlers","onmidimessage","_onMidiMessage","item","on","constructor","every","chNum","listeners","l","prop1","hasOwnProperty","prop2","target","data","_parseChannelEvent","_parseNrpnEvent","_parseSystemEvent","command","channelBufferIndex","data1","data2","ccEvent","controller","getCcNameByNumber","rawData","ev","nrpnNumber","nrpnValue","nrpnControllerType","nrpnEvent","note","velocity","rawVelocity","getChannelModeByNumber","cc","status","cm","song","midiOutput","send","message","parsed","concat","parseFloat","sendSysex","options","_parseTimeParameter","sendTimecodeQuarterFrame","sendSongPosition","msb","lsb","sendSongSelect","sendTuningRequest","sendClock","sendStart","sendContinue","sendStop","sendActiveSensing","sendReset","stopNote","sendChannelMode","nVelocity","isNaN","_convertNoteToArray","playNote","duration","nRelease","release","sendKeyAftertouch","pressure","nPressure","sendControlChange","_selectRegisteredParameter","parameter","_selectNonRegisteredParameter","_setCurrentRegisteredParameter","_deselectRegisteredParameter","setRegisteredParameter","setNonRegisteredParameter","incrementRegisteredParameter","decrementRegisteredParameter","setPitchBendRange","cents","setModulationRange","setMasterTuning","coarse","fine","setTuningProgram","setTuningBank","sendProgramChange","program","sendChannelAftertouch","sendPitchBend","bend","nLevel","substring","notes","define","amd","module","exports"],"mappings":"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","sourcesContent":["(function(scope) {\n\n  \"use strict\";\n\n  /**\n   * The `WebMidi` object makes it easier to work with the Web MIDI API. Basically, it simplifies\n   * two things: sending outgoing MIDI messages and reacting to incoming MIDI messages.\n   *\n   * Sending MIDI messages is done via an `Output` object. All available outputs can be accessed in\n   * the `WebMidi.outputs` array. There is one `Output` object for each output port available on\n   * your system. Similarly, reacting to MIDI messages as they are coming in is simply a matter of\n   * adding a listener to an `Input` object. Similarly, all inputs can be found in the\n   * `WebMidi.inputs` array.\n   *\n   * Please note that a single hardware device might create more than one input and/or output ports.\n   *\n   * #### Sending messages\n   *\n   * To send MIDI messages, you simply need to call the desired method (`playNote()`,\n   * `sendPitchBend()`, `stopNote()`, etc.) from an `Output` object and pass in the appropriate\n   * parameters. All the native MIDI communication will be handled for you. The only additional\n   * thing that needs to be done is to first enable `WebMidi`. Here is an example:\n   *\n   *      WebMidi.enable(function(err) {\n   *        if (err) console.log(\"An error occurred\", err);\n   *        WebMidi.outputs[0].playNote(\"C3\");\n   *      });\n   *\n   * The code above, calls the `WebMidi.enable()` method. Upon success, this method executes the\n   * callback function specified as a parameter. In this case, the callback calls the `playnote()`\n   * function to play a 3rd octave C on the first available output port.\n   *\n   * #### Receiving messages\n   *\n   * Receiving messages is just as easy. You simply have to set a callback function to be triggered\n   * when a specific MIDI message is received. For example, here\"s how to listen for pitch bend\n   * events on the first input port:\n   *\n   *      WebMidi.enable(function(err) {\n   *        if (err) console.log(\"An error occurred\", err);\n   *\n   *        WebMidi.inputs[0].addListener(\"pitchbend\", \"all\", function(e) {\n   *          console.log(\"Pitch value: \" + e.value);\n   *        });\n   *\n   *      });\n   *\n   * As you can see, this library is much easier to use than the native Web MIDI API. No need to\n   * manually craft or decode binary MIDI messages anymore!\n   *\n   * @class WebMidi\n   * @static\n   *\n   * @throws Error WebMidi is a singleton, it cannot be instantiated directly.\n   *\n   * @todo  Switch away from yuidoc (deprecated) to be able to serve doc over https\n   * @todo  Yuidoc does not allow multiple exceptions (@throws) for a single method ?!\n   *\n   */\n  function WebMidi() {\n\n    // Singleton. Prevent instantiation through WebMidi.__proto__.constructor()\n    if (WebMidi.prototype._singleton) {\n      throw new Error(\"WebMidi is a singleton, it cannot be instantiated directly.\");\n    }\n    WebMidi.prototype._singleton = this;\n\n    // MIDI inputs and outputs\n    this._inputs = [];\n    this._outputs = [];\n\n    // Object to hold all user-defined handlers for interface-wide events (connected, disconnected,\n    // etc.)\n    this._userHandlers = {};\n\n    // Array of statechange events to process. These events must be parsed synchronously so they do\n    // not override each other.\n    this._stateChangeQueue = [];\n\n    // Indicates whether we are currently processing a statechange event (in which case new events\n    // are to be queued).\n    this._processingStateChange = false;\n\n    // Events triggered at the interface level (WebMidi)\n    this._midiInterfaceEvents = [\"connected\", \"disconnected\"];\n\n    // the current nrpns being constructed, by channel\n    this._nrpnBuffer = [[],[],[],[], [],[],[],[], [],[],[],[], [],[],[],[]];\n\n    // Enable/Disable NRPN event dispatch\n    this._nrpnEventsEnabled = true;\n\n    // NRPN message types\n    this._nrpnTypes = [\"entry\", \"increment\", \"decrement\"];\n\n    // Notes and semitones for note guessing\n    this._notes = [\"C\", \"C#\", \"D\", \"D#\", \"E\", \"F\", \"F#\", \"G\", \"G#\", \"A\", \"A#\", \"B\"];\n    this._semitones = {C: 0, D: 2, E: 4, F: 5, G: 7, A: 9, B: 11 };\n\n    // Define some \"static\" properties\n    Object.defineProperties(this, {\n\n      /**\n       * [read-only] List of valid MIDI system messages and matching hexadecimal values.\n       *\n       * Note: values 249 and 253 are actually dispatched by the Web MIDI API but I do not know what\n       * they are used for. They are not part of the online\n       * [MIDI 1.0 spec](http://www.midi.org/techspecs/midimessages.php).\n       *\n       * @property MIDI_SYSTEM_MESSAGES\n       * @type Object\n       * @static\n       *\n       * @since 2.0.0\n       */\n      MIDI_SYSTEM_MESSAGES: {\n        value: {\n\n          // System common messages\n          sysex: 0xF0,            // 240\n          timecode: 0xF1,         // 241\n          songposition: 0xF2,     // 242\n          songselect: 0xF3,       // 243\n          tuningrequest: 0xF6,    // 246\n          sysexend: 0xF7,         // 247 (never actually received - simply ends a sysex)\n\n          // System real-time messages\n          clock: 0xF8,            // 248\n          start: 0xFA,            // 250\n          continue: 0xFB,         // 251\n          stop: 0xFC,             // 252\n          activesensing: 0xFE,    // 254\n          reset: 0xFF,            // 255\n\n          // Custom WebMidi.js messages\n          midimessage: 0,\n          unknownsystemmessage: -1\n        },\n        writable: false,\n        enumerable: true,\n        configurable: false\n      },\n\n      /**\n       * [read-only] An object containing properties for each MIDI channel messages and their\n       * associated hexadecimal value.\n       *\n       * @property MIDI_CHANNEL_MESSAGES\n       * @type Object\n       * @static\n       *\n       * @since 2.0.0\n       */\n      MIDI_CHANNEL_MESSAGES: {\n        value: {\n          noteoff: 0x8,           // 8\n          noteon: 0x9,            // 9\n          keyaftertouch: 0xA,     // 10\n          controlchange: 0xB,     // 11\n          channelmode: 0xB,       // 11\n          nrpn: 0xB,              // 11\n          programchange: 0xC,     // 12\n          channelaftertouch: 0xD, // 13\n          pitchbend: 0xE          // 14\n        },\n        writable: false,\n        enumerable: true,\n        configurable: false\n      },\n\n      /**\n       * [read-only] An object containing properties for each registered parameters and their\n       * associated pair of hexadecimal values. MIDI registered parameters extend the original list\n       * of control change messages (a.k.a. CC messages). Currently, there are only a limited number\n       * of them.\n       *\n       * @property MIDI_REGISTERED_PARAMETER\n       * @type Object\n       * @static\n       *\n       * @since 2.0.0\n       */\n      MIDI_REGISTERED_PARAMETER: {\n        value: {\n          pitchbendrange: [0x00, 0x00],\n          channelfinetuning: [0x00, 0x01],\n          channelcoarsetuning: [0x00, 0x02],\n          tuningprogram: [0x00, 0x03],\n          tuningbank: [0x00, 0x04],\n          modulationrange: [0x00, 0x05],\n\n          azimuthangle: [0x3D, 0x00],\n          elevationangle: [0x3D, 0x01],\n          gain: [0x3D, 0x02],\n          distanceratio: [0x3D, 0x03],\n          maximumdistance: [0x3D, 0x04],\n          maximumdistancegain: [0x3D, 0x05],\n          referencedistanceratio: [0x3D, 0x06],\n          panspreadangle: [0x3D, 0x07],\n          rollangle: [0x3D, 0x08]\n        },\n        writable: false,\n        enumerable: true,\n        configurable: false\n      },\n\n      /**\n       * [read-only] An object containing properties for each MIDI control change messages (a.k.a.\n       * CC messages) and their associated hexadecimal value.\n       *\n       * @property MIDI_CONTROL_CHANGE_MESSAGES\n       * @type Object\n       * @static\n       *\n       * @since 2.0.0\n       */\n      MIDI_CONTROL_CHANGE_MESSAGES: {\n        value: {\n          bankselectcoarse: 0,\n          modulationwheelcoarse: 1,\n          breathcontrollercoarse: 2,\n          footcontrollercoarse: 4,\n          portamentotimecoarse: 5,\n          dataentrycoarse: 6,\n          volumecoarse: 7,\n          balancecoarse: 8,\n          pancoarse: 10,\n          expressioncoarse: 11,\n          effectcontrol1coarse: 12,\n          effectcontrol2coarse: 13,\n          generalpurposeslider1: 16,\n          generalpurposeslider2: 17,\n          generalpurposeslider3: 18,\n          generalpurposeslider4: 19,\n          bankselectfine: 32,\n          modulationwheelfine: 33,\n          breathcontrollerfine: 34,\n          footcontrollerfine: 36,\n          portamentotimefine: 37,\n          dataentryfine: 38,\n          volumefine: 39,\n          balancefine: 40,\n          panfine: 42,\n          expressionfine: 43,\n          effectcontrol1fine: 44,\n          effectcontrol2fine: 45,\n          holdpedal: 64,\n          portamento: 65,\n          sustenutopedal: 66,\n          softpedal: 67,\n          legatopedal: 68,\n          hold2pedal: 69,\n          soundvariation: 70,\n          resonance: 71,\n          soundreleasetime: 72,\n          soundattacktime: 73,\n          brightness: 74,\n          soundcontrol6: 75,\n          soundcontrol7: 76,\n          soundcontrol8: 77,\n          soundcontrol9: 78,\n          soundcontrol10: 79,\n          generalpurposebutton1: 80,\n          generalpurposebutton2: 81,\n          generalpurposebutton3: 82,\n          generalpurposebutton4: 83,\n          reverblevel: 91,\n          tremololevel: 92,\n          choruslevel: 93,\n          celestelevel: 94,\n          phaserlevel: 95,\n          databuttonincrement: 96,\n          databuttondecrement: 97,\n          nonregisteredparametercoarse: 98,\n          nonregisteredparameterfine: 99,\n          registeredparametercoarse: 100,\n          registeredparameterfine: 101\n        },\n        writable: false,\n        enumerable: true,\n        configurable: false\n      },\n\n      /**\n       * [read-only] An object containing properties for MIDI control change messages\n       * that make up NRPN messages\n       *\n       * @property MIDI_NRPN_MESSAGES\n       * @type Object\n       * @static\n       *\n       * @since 2.0.0\n       */\n      MIDI_NRPN_MESSAGES: {\n        value: {\n          entrymsb: 6,\n          entrylsb: 38,\n          increment: 96,\n          decrement: 97,\n          paramlsb: 98,\n          parammsb: 99,\n          nullactiveparameter: 127\n        },\n        writable: false,\n        enumerable: true,\n        configurable: false\n      },\n\n      /**\n       * [read-only] List of MIDI channel mode messages as defined in the official MIDI\n       * specification.\n       *\n       * @property MIDI_CHANNEL_MODE_MESSAGES\n       * @type Object\n       * @static\n       *\n       * @since 2.0.0\n       */\n      MIDI_CHANNEL_MODE_MESSAGES: {\n        value: {\n          allsoundoff: 120,\n          resetallcontrollers: 121,\n          localcontrol: 122,\n          allnotesoff: 123,\n          omnimodeoff: 124,\n          omnimodeon: 125,\n          monomodeon: 126,\n          polymodeon: 127\n        },\n        writable: false,\n        enumerable: true,\n        configurable: false\n      },\n\n      /**\n       * An integer to offset the octave both in inbound and outbound messages. By default, middle C\n       * (MIDI note number 60) is placed on the 4th octave (C4).\n       *\n       * If, for example, `octaveOffset` is set to 2, MIDI note number 60 will be reported as C6. If\n       * `octaveOffset` is set to -1, MIDI note number 60 will be reported as C3.\n       *\n       * @property octaveOffset\n       * @type Number\n       * @static\n       *\n       * @since 2.1\n       */\n      octaveOffset: {\n        value: 0,\n        writable: true,\n        enumerable: true,\n        configurable: false\n      }\n\n    });\n\n    // Define getters/setters\n    Object.defineProperties(this, {\n\n      /**\n       * [read-only] Indicates whether the environment supports the Web MIDI API or not.\n       *\n       * Note: in environments that do not offer built-in MIDI support, this will report true if the\n       * `navigator.requestMIDIAccess` function is available. For example, if you have installed\n       * WebMIDIAPIShim but no plugin, this property will be true even though actual support might\n       * not be there.\n       *\n       * @property supported\n       * @type Boolean\n       * @static\n       */\n      supported: {\n        enumerable: true,\n        get: function() {\n          return \"requestMIDIAccess\" in navigator;\n        }\n      },\n\n      /**\n       * [read-only] Indicates whether the interface to the host\"s MIDI subsystem is currently\n       * enabled.\n       *\n       * @property enabled\n       * @type Boolean\n       * @static\n       */\n      enabled: {\n        enumerable: true,\n        get: function() {\n          return this.interface !== undefined;\n        }.bind(this)\n      },\n\n      /**\n       * [read-only] An array of all currently available MIDI input ports.\n       *\n       * @property inputs\n       * @type {Array}\n       * @static\n       */\n      inputs: {\n        enumerable: true,\n        get: function() {\n          return this._inputs;\n        }.bind(this)\n      },\n\n      /**\n       * [read-only] An array of all currently available MIDI output ports.\n       *\n       * @property outputs\n       * @type {Array}\n       * @static\n       */\n      outputs: {\n        enumerable: true,\n        get: function() {\n          return this._outputs;\n        }.bind(this)\n      },\n\n      /**\n       * [read-only] Indicates whether the interface to the host\"s MIDI subsystem is currently\n       * active.\n       *\n       * @property sysexEnabled\n       * @type Boolean\n       * @static\n       */\n      sysexEnabled: {\n        enumerable: true,\n        get: function() {\n          return !!(this.interface && this.interface.sysexEnabled);\n        }.bind(this)\n      },\n\n      /**\n       * [read-only] Indicates whether WebMidi should dispatch Non-Registered\n       * Parameter Number events (which are generally groups of CC messages)\n       * If correct sequences of CC messages are received, NRPN events will\n       * fire. The first out of order NRPN CC will fall through the collector\n       * logic and all CC messages buffered will be discarded as incomplete.\n       *\n       * @property nrpnEventsEnabled\n       * @type Boolean\n       * @static\n       */\n      nrpnEventsEnabled: {\n        enumerable: true,\n        get: function() {\n          return !!(this._nrpnEventsEnabled);\n        }.bind(this),\n        set: function(enabled) {\n          this._nrpnEventsEnabled = enabled;\n          return this._nrpnEventsEnabled;\n        }\n      },\n\n      /**\n       * [read-only] NRPN message types\n       *\n       * @property nrpnTypes\n       * @type Array\n       * @static\n       */\n      nrpnTypes: {\n        enumerable: true,\n        get: function() {\n          return this._nrpnTypes;\n        }.bind(this)\n      },\n\n      /**\n       * [read-only] Current MIDI performance time in milliseconds. This can be used to queue events\n       * in the future.\n       *\n       * @property time\n       * @type DOMHighResTimeStamp\n       * @static\n       */\n      time: {\n        enumerable: true,\n        get: function() {\n          return performance.now();\n        }\n      }\n\n    });\n\n  }\n\n  // WebMidi is a singleton so we instantiate it ourselves and keep it in a var for internal\n  // reference.\n  var wm = new WebMidi();\n\n  /**\n   * Checks if the Web MIDI API is available and then tries to connect to the host's MIDI subsystem.\n   * This is an asynchronous operation. When it's done, the specified handler callback will be\n   * executed. If an error occurred, the callback function will receive an `Error` object as its\n   * sole parameter.\n   *\n   * To enable the use of system exclusive messages, the `sysex` parameter should be set to true.\n   * However, under some environments (e.g. Jazz-Plugin), the sysex parameter is ignored and sysex\n   * is always enabled.\n   *\n   * Warning: starting with Chrome v77, the Web MIDI API must be hosted on a secure origin\n   * (`https://`, `localhost` or `file:///`) and the user will always be prompted to authorize the\n   * operation (no matter if `sysex` is requested or not).\n   *\n   * @method enable\n   * @static\n   *\n   * @param [callback] {Function} A function to execute upon success. This function will receive an\n   * `Error` object upon failure to enable the Web MIDI API.\n   * @param [sysex=false] {Boolean} Whether to enable MIDI system exclusive messages or not.\n   *\n   * @throws Error The Web MIDI API is not supported by your browser.\n   * @throws Error Jazz-Plugin must be installed to use WebMIDIAPIShim.\n   */\n  WebMidi.prototype.enable = function(callback, sysex) {\n\n    // Why are you not using a Promise-based API for the enable() method?\n    //\n    // Short answer: because of IE.\n    //\n    // Long answer:\n    //\n    // IE 11 and below still do not support promises. Therefore, WebMIDIAPIShim has to implement a\n    // simple Promise look-alike object to handle the call to requestMIDIAccess(). This look-alike\n    // is not a fully-fledged Promise object. It does not support using catch() for example. This\n    // means that, to provide a real Promise-based interface for the enable() method, we would need\n    // to add a dependency in the form of a Promise polyfill. So, to keep things simpler, we will\n    // stick to the good old callback based enable() function.\n\n    if (this.enabled) return;\n\n    if ( !this.supported) {\n\n      if (typeof callback === \"function\") {\n        callback( new Error(\"The Web MIDI API is not supported by your browser.\") );\n      }\n\n      return;\n\n    }\n\n    navigator.requestMIDIAccess({sysex: sysex}).then(\n\n      function(midiAccess) {\n\n        var events = [],\n          promises = [],\n          promiseTimeout;\n\n        this.interface = midiAccess;\n        this._resetInterfaceUserHandlers();\n\n        // We setup a temporary `statechange` handler that will catch all events triggered while we\n        // setup. Those events will be re-triggered after calling the user\"s callback. This will\n        // allow the user to listen to \"connected\" events which can be very convenient.\n        this.interface.onstatechange = function (e) {\n          events.push(e);\n        };\n\n        // Here we manually open the inputs and outputs. Usually, this is optional. When the ports\n        // are not explicitely opened, they will be opened automatically (and asynchonously) by\n        // setting a listener on `midimessage` (MIDIInput) or calling `send()` (MIDIOutput).\n        // However, we do not want that here. We want to be sure that \"connected\" events will be\n        // available in the user\"s callback. So, what we do is open all input and output ports and\n        // wait until all promises are resolved. Then, we re-trigger the events after the user\"s\n        // callback has been executed. This seems like the most sensible and practical way.\n        var inputs = midiAccess.inputs.values();\n        for (var input = inputs.next(); input && !input.done; input = inputs.next()) {\n          promises.push(input.value.open());\n        }\n\n        var outputs = midiAccess.outputs.values();\n        for (var output = outputs.next(); output && !output.done; output = outputs.next()) {\n          promises.push(output.value.open());\n        }\n\n        // Since this library might be used in environments without support for promises (such as\n        // Jazz-Midi) or in environments that are not properly opening the ports (such as Web MIDI\n        // Browser), we fall back to a timer-based approach if the promise-based approach fails.\n        function onPortsOpen() {\n\n          clearTimeout(promiseTimeout);\n\n          this._updateInputsAndOutputs();\n          this.interface.onstatechange = this._onInterfaceStateChange.bind(this);\n\n          // We execute the callback and then re-trigger the statechange events.\n          if (typeof callback === \"function\") { callback.call(this); }\n\n          events.forEach(function (event) {\n            this._onInterfaceStateChange(event);\n          }.bind(this));\n\n        }\n\n        promiseTimeout = setTimeout(onPortsOpen.bind(this), 200);\n\n        if (Promise) {\n          Promise\n            .all(promises)\n            .catch(function(err) { console.warn(err); })\n            .then(onPortsOpen.bind(this));\n        }\n\n        // When MIDI access is requested, all input and output ports have their \"state\" set to\n        // \"connected\". However, the value of their \"connection\" property is \"closed\".\n        //\n        // A `MIDIInput` becomes `open` when you explicitely call its `open()` method or when you\n        // assign a listener to its `onmidimessage` property. A `MIDIOutput` becomes `open` when you\n        // use the `send()` method or when you can explicitely call its `open()` method.\n        //\n        // Calling `_updateInputsAndOutputs()` attaches listeners to all inputs. As per the spec,\n        // this triggers a `statechange` event on MIDIAccess.\n\n      }.bind(this),\n\n      function (err) {\n        if (typeof callback === \"function\") { callback.call(this, err); }\n      }.bind(this)\n\n    );\n\n  };\n\n  /**\n   * Completely disables `WebMidi` by unlinking the MIDI subsystem\"s interface and destroying all\n   * `Input` and `Output` objects that may be available. This also means that any listener that may\n   * have been defined on `Input` or `Output` objects will be destroyed.\n   *\n   * @method disable\n   * @static\n   *\n   * @since 2.0.0\n   */\n  WebMidi.prototype.disable = function() {\n\n    if ( !this.supported ) {\n      throw new Error(\"The Web MIDI API is not supported by your browser.\");\n    }\n\n    if (this.interface) this.interface.onstatechange = undefined;\n    this.interface = undefined; // also resets enabled, sysexEnabled, nrpnEventsEnabled\n    this._inputs = [];\n    this._outputs = [];\n    this._nrpnEventsEnabled = true;\n    this._resetInterfaceUserHandlers();\n\n  };\n\n  /**\n   * Adds an event listener on the `WebMidi` object that will trigger a function callback when the\n   * specified event happens.\n   *\n   * WebMidi must be enabled before adding event listeners.\n   *\n   * Currently, only one event is being dispatched by the `WebMidi` object:\n   *\n   *    * {{#crossLink \"WebMidi/statechange:event\"}}statechange{{/crossLink}}\n   *\n   * @method addListener\n   * @static\n   * @chainable\n   *\n   * @param type {String} The type of the event.\n   *\n   * @param listener {Function} A callback function to execute when the specified event is detected.\n   * This function will receive an event parameter object. For details on this object\"s properties,\n   * check out the documentation for the various events (links above).\n   *\n   * @throws {Error} WebMidi must be enabled before adding event listeners.\n   * @throws {TypeError} The specified event type is not supported.\n   * @throws {TypeError} The \"listener\" parameter must be a function.\n   *\n   * @return {WebMidi} Returns the `WebMidi` object so methods can be chained.\n   */\n  WebMidi.prototype.addListener = function(type, listener) {\n\n    if (!this.enabled) {\n      throw new Error(\"WebMidi must be enabled before adding event listeners.\");\n    }\n\n    if (typeof listener !== \"function\") {\n      throw new TypeError(\"The 'listener' parameter must be a function.\");\n    }\n\n    if (this._midiInterfaceEvents.indexOf(type) >= 0) {\n      this._userHandlers[type].push(listener);\n    } else {\n      throw new TypeError(\"The specified event type is not supported.\");\n    }\n\n    return this;\n\n  };\n\n  /**\n   * Checks if the specified event type is already defined to trigger the specified listener\n   * function.\n   *\n   * @method hasListener\n   * @static\n   *\n   * @param {String} type The type of the event.\n   * @param {Function} listener The callback function to check for.\n   *\n   * @throws {Error} WebMidi must be enabled before checking event listeners.\n   * @throws {TypeError} The \"listener\" parameter must be a function.\n   * @throws {TypeError} The specified event type is not supported.\n   *\n   * @return {Boolean} Boolean value indicating whether or not a callback is already defined for\n   * this event type.\n   */\n  WebMidi.prototype.hasListener = function(type, listener) {\n\n    if (!this.enabled) {\n      throw new Error(\"WebMidi must be enabled before checking event listeners.\");\n    }\n\n    if (typeof listener !== \"function\") {\n      throw new TypeError(\"The 'listener' parameter must be a function.\");\n    }\n\n    if (this._midiInterfaceEvents.indexOf(type) >= 0) {\n\n      for (var o = 0; o < this._userHandlers[type].length; o++) {\n        if (this._userHandlers[type][o] === listener) {\n          return true;\n        }\n      }\n\n    } else {\n      throw new TypeError(\"The specified event type is not supported.\");\n    }\n\n    return false;\n\n  };\n\n  /**\n   * Removes the specified listener(s). If the `listener` parameter is left undefined, all listeners\n   * for the specified `type` will be removed. If both the `listener` and the `type` parameters are\n   * omitted, all listeners attached to the `WebMidi` object will be removed.\n   *\n   * @method removeListener\n   * @static\n   * @chainable\n   *\n   * @param {String} [type] The type of the event.\n   * @param {Function} [listener] The callback function to check for.\n   *\n   * @throws {Error} WebMidi must be enabled before removing event listeners.\n   * @throws {TypeError} The \"listener\" parameter must be a function.\n   * @throws {TypeError} The specified event type is not supported.\n   *\n   * @return {WebMidi} The `WebMidi` object for easy method chaining.\n   */\n  WebMidi.prototype.removeListener = function(type, listener) {\n\n    if (!this.enabled) {\n      throw new Error(\"WebMidi must be enabled before removing event listeners.\");\n    }\n\n    if (listener !== undefined && typeof listener !== \"function\") {\n      throw new TypeError(\"The 'listener' parameter must be a function.\");\n    }\n\n    if (this._midiInterfaceEvents.indexOf(type) >= 0) {\n\n      if (listener) {\n\n        for (var o = 0; o < this._userHandlers[type].length; o++) {\n          if (this._userHandlers[type][o] === listener) {\n            this._userHandlers[type].splice(o, 1);\n          }\n        }\n\n      } else {\n        this._userHandlers[type] = [];\n      }\n\n    } else if (type === undefined) {\n\n      this._resetInterfaceUserHandlers();\n\n    } else {\n      throw new TypeError(\"The specified event type is not supported.\");\n    }\n\n    return this;\n\n  };\n\n  /**\n   * Returns a sanitized array of valid MIDI channel numbers (1-16). The parameter should be one of\n   * the following:\n   *\n   * * a single integer\n   * * an array of integers\n   * * the special value `\"all\"`\n   * * the special value `\"none\"`\n   *\n   * Passing `\"all\"` or `undefined` as a parameter to this function results in all channels being\n   * returned (1-16). Passing `\"none\"` results in no channel being returned (as an empty array).\n   *\n   * Note: parameters that cannot successfully be parsed to integers between 1 and 16 are silently\n   * ignored.\n   *\n   * @method toMIDIChannels\n   * @static\n   *\n   * @param [channel=\"all\"] {Number|Array|\"all\"|\"none\"}\n   * @returns {Array} An array of 0 or more valid MIDI channel numbers\n   */\n  WebMidi.prototype.toMIDIChannels = function(channel) {\n\n    var channels;\n\n    if (channel === \"all\" || channel === undefined) {\n      channels = [\"all\"];\n    } else if (channel === \"none\") {\n      channels = [];\n      return channels;\n    } else if (!Array.isArray(channel)) {\n      channels = [channel];\n    } else {\n      channels = channel;\n    }\n\n    // In order to preserve backwards-compatibility, we let this assignment as it is.\n    if (channels.indexOf(\"all\") > -1) {\n      channels = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16];\n    }\n\n    return channels\n      .map(function(ch) {\n        return parseInt(ch);\n      })\n      .filter(function(ch) {\n        return (ch >= 1 && ch <= 16);\n      });\n\n  };\n\n  /**\n   *\n   * Returns the `Input` object that matches the specified ID string or `false` if no matching input\n   * is found. As per the Web MIDI API specification, IDs are strings (not integers).\n   *\n   * Please note that IDs change from one host to another. For example, Chrome does not use the same\n   * kind of IDs as Jazz-Plugin.\n   *\n   * @method getInputById\n   * @static\n   *\n   * @param id {String} The ID string of the port. IDs can be viewed by looking at the\n   * `WebMidi.inputs` array.\n   *\n   * @returns {Input|false} A MIDIInput port matching the specified ID string. If no matching port\n   * can be found, the method returns `false`.\n   *\n   * @throws Error WebMidi is not enabled.\n   *\n   * @since 2.0.0\n   */\n  WebMidi.prototype.getInputById = function(id) {\n\n    if (!this.enabled) throw new Error(\"WebMidi is not enabled.\");\n\n    id = String(id);\n\n    for (var i = 0; i < this.inputs.length; i++) {\n      if (this.inputs[i].id === id) return this.inputs[i];\n    }\n\n    return false;\n\n  };\n\n  /**\n   * Returns the `Output` object that matches the specified ID string or `false` if no matching\n   * output is found. As per the Web MIDI API specification, IDs are strings (not integers).\n   *\n   * Please note that IDs change from one host to another. For example, Chrome does not use the same\n   * kind of IDs as Jazz-Plugin.\n   *\n   * @method getOutputById\n   * @static\n   *\n   * @param id {String} The ID string of the port. IDs can be viewed by looking at the\n   * `WebMidi.outputs` array.\n   *\n   * @returns {Output|false} A MIDIOutput port matching the specified ID string. If no matching port\n   * can be found, the method returns `false`.\n   *\n   * @throws Error WebMidi is not enabled.\n   *\n   * @since 2.0.0\n   */\n  WebMidi.prototype.getOutputById = function(id) {\n\n    if (!this.enabled) throw new Error(\"WebMidi is not enabled.\");\n\n    id = String(id);\n\n    for (var i = 0; i < this.outputs.length; i++) {\n      if (this.outputs[i].id === id) return this.outputs[i];\n    }\n\n    return false;\n\n  };\n\n  /**\n   * Returns the first MIDI `Input` whose name *contains* the specified string.\n   *\n   * Please note that the port names change from one host to another. For example, Chrome does\n   * not report port names in the same way as the Jazz-Plugin does.\n   *\n   * @method getInputByName\n   * @static\n   *\n   * @param name {String} The name of a MIDI input port such as those visible in the\n   * `WebMidi.inputs` array.\n   *\n   * @returns {Input|False} The `Input` that was found or `false` if no input matched the specified\n   * name.\n   *\n   * @throws Error WebMidi is not enabled.\n   * @throws TypeError The name must be a string.\n   *\n   * @since 2.0.0\n   */\n  WebMidi.prototype.getInputByName = function(name) {\n\n    if (!this.enabled) {\n      throw new Error(\"WebMidi is not enabled.\");\n    }\n\n    for (var i = 0; i < this.inputs.length; i++) {\n      if (~this.inputs[i].name.indexOf(name)) { return this.inputs[i]; }\n    }\n\n    return false;\n\n  };\n\n  /**\n   * Returns the octave number for the specified MIDI note number (0-127). By default, the value is\n   * based on middle C (note number 60) being placed on the 4th octave (C4). However, by using the\n   * <a href=\"#property_octaveOffset\">octaveOffset</a> property, you can offset the result as much\n   * as you want.\n   *\n   * @method getOctave\n   * @static\n   *\n   * @param number {Number} An integer representing a valid MIDI note number (between 0 and 127).\n   *\n   * @returns {Number} The octave (as a signed integer) or `undefined`.\n   *\n   * @since 2.0.0-rc.6\n   */\n  WebMidi.prototype.getOctave = function(number) {\n\n    if (number != null && number >= 0 && number <= 127) {\n      return Math.floor(Math.floor(number) / 12 - 1) + Math.floor(wm.octaveOffset);\n    }\n\n  };\n\n  /**\n   * Returns the first MIDI `Output` that matches the specified name.\n   *\n   * Please note that the port names change from one host to another. For example, Chrome does\n   * not report port names in the same way as the Jazz-Plugin does.\n   *\n   * @method getOutputByName\n   * @static\n   *\n   * @param name {String} The name of a MIDI output port such as those visible in the\n   * `WebMidi.outputs` array.\n   *\n   * @returns {Output|False} The `Output` that was found or `false` if no output matched the\n   * specified name.\n   *\n   * @throws Error WebMidi is not enabled.\n   *\n   * @since 2.0.0\n   */\n  WebMidi.prototype.getOutputByName = function(name) {\n\n    if (!this.enabled) {\n      throw new Error(\"WebMidi is not enabled.\");\n    }\n\n    for (var i = 0; i < this.outputs.length; i++) {\n      if (~this.outputs[i].name.indexOf(name)) { return this.outputs[i]; }\n    }\n\n    return false;\n\n  };\n\n  /**\n   * Returns a valid MIDI note number (0-127) given the specified input. The input usually is a note\n   * name (C3, F#4, D-2, G8, etc.). If an integer between 0 and 127, it will simply be returned as\n   * is.\n   *\n   * @method guessNoteNumber\n   * @static\n   *\n   * @param input {Number|String} A string to extract the note number from. An integer can also be\n   * used, in which case it will simply be returned (if between 0 and 127).\n   * @throws {Error} Invalid input value\n   * @returns {Number} A valid MIDI note number (0-127).\n   */\n  WebMidi.prototype.guessNoteNumber = function(input) {\n\n    var output = false;\n\n    if (input && input.toFixed && input >= 0 && input <= 127) {         // uint\n      output = Math.round(input);\n    } else if (parseInt(input) >= 0 && parseInt(input) <= 127) {        // uint as string\n      output = parseInt(input);\n    } else if (typeof input === \"string\" || input instanceof String) {  // string\n      output = this.noteNameToNumber(input);\n    }\n\n    if (output === false) throw new Error(\"Invalid input value (\" + input + \").\");\n    return output;\n\n  };\n\n  /**\n   * Returns a MIDI note number matching the note name passed in the form of a string parameter. The\n   * note name must include the octave number. The name can also optionally include a sharp (#),\n   * a double sharp (##), a flat (b) or a double flat (bb) symbol: C5, G4, D#-1, F0, Gb7, Eb-1,\n   * Abb4, B##6, etc.\n   *\n   * Note that, in converting note names to numbers, C4 is considered to be middle C (MIDI note\n   * number 60) as per the scientific pitch notation standard.\n   *\n   * Also note that the resulting note number is offset by the `octaveOffset` value (if not zero).\n   * For example, if you pass in \"C4\" and the `octaveOffset` value is 2 the resulting MIDI note\n   * number will be 36.\n   *\n   * @method noteNameToNumber\n   * @static\n   *\n   * @param name {String} The name of the note in the form of a letter, followed by an optional \"#\",\n   * \"##\", \"b\" or \"bb\" followed by the octave number.\n   *\n   * @throws {RangeError} Invalid note name.\n   * @throws {RangeError} Invalid note name or note outside valid range.\n   * @return {Number} The MIDI note number (between 0 and 127)\n   */\n  WebMidi.prototype.noteNameToNumber = function(name) {\n\n    if (typeof name !== \"string\") name = \"\";\n\n    var matches = name.match(/([CDEFGAB])(#{0,2}|b{0,2})(-?\\d+)/i);\n    if(!matches) throw new RangeError(\"Invalid note name.\");\n\n    var semitones = wm._semitones[matches[1].toUpperCase()];\n    var octave = parseInt(matches[3]);\n    var result = ((octave + 1 - Math.floor(wm.octaveOffset)) * 12) + semitones;\n\n\n    if (matches[2].toLowerCase().indexOf(\"b\") > -1) {\n      result -= matches[2].length;\n    } else if (matches[2].toLowerCase().indexOf(\"#\") > -1) {\n      result += matches[2].length;\n    }\n\n    if (result < 0 || result > 127) {\n      throw new RangeError(\"Invalid note name or note outside valid range.\");\n    }\n\n    return result;\n\n  };\n\n  /**\n   * @method _updateInputsAndOutputs\n   * @static\n   * @protected\n   */\n  WebMidi.prototype._updateInputsAndOutputs = function() {\n    this._updateInputs();\n    this._updateOutputs();\n  };\n\n  /**\n   * @method _updateInputs\n   * @static\n   * @protected\n   */\n  WebMidi.prototype._updateInputs = function() {\n\n    // Check for items to remove from the existing array (because they are no longer being reported\n    // by the MIDI back-end).\n    for (var i = 0; i < this._inputs.length; i++) {\n\n      var remove = true;\n\n      var updated = this.interface.inputs.values();\n      for (var input = updated.next(); input && !input.done; input = updated.next()) {\n        if (this._inputs[i]._midiInput === input.value) {\n          remove = false;\n          break;\n        }\n      }\n\n      if (remove) {\n        this._inputs.splice(i, 1);\n      }\n\n    }\n\n    // Check for items to add in the existing inputs array because they just appeared in the MIDI\n    // back-end inputs list. We must check for the existence of this.interface because it might\n    // have been closed via WebMidi.disable().\n    this.interface && this.interface.inputs.forEach(function (nInput) {\n\n      var add = true;\n\n      for (var j = 0; j < this._inputs.length; j++) {\n        if (this._inputs[j]._midiInput === nInput) {\n          add = false;\n        }\n      }\n\n      if (add) {\n        this._inputs.push( new Input(nInput) );\n      }\n\n    }.bind(this));\n\n  };\n\n  /**\n   * @method _updateOutputs\n   * @static\n   * @protected\n   */\n  WebMidi.prototype._updateOutputs = function() {\n\n    // Check for items to remove from the existing array (because they are no longer being reported\n    // by the MIDI back-end).\n    for (var i = 0; i < this._outputs.length; i++) {\n\n      var remove = true;\n\n      var updated = this.interface.outputs.values();\n      for (var output = updated.next(); output && !output.done; output = updated.next()) {\n        if (this._outputs[i]._midiOutput === output.value) {\n          remove = false;\n          break;\n        }\n      }\n\n      if (remove) {\n        this._outputs.splice(i, 1);\n      }\n\n    }\n\n    // Check for items to add in the existing inputs array because they just appeared in the MIDI\n    // back-end outputs list. We must check for the existence of this.interface because it might\n    // have been closed via WebMidi.disable().\n    this.interface && this.interface.outputs.forEach(function (nOutput) {\n\n      var add = true;\n\n      for (var j = 0; j < this._outputs.length; j++) {\n        if (this._outputs[j]._midiOutput === nOutput) {\n          add = false;\n        }\n      }\n\n      if (add) {\n        this._outputs.push( new Output(nOutput) );\n      }\n\n    }.bind(this));\n\n  };\n\n  /**\n   * @method _onInterfaceStateChange\n   * @static\n   * @protected\n   */\n  WebMidi.prototype._onInterfaceStateChange = function(e) {\n\n    this._updateInputsAndOutputs();\n\n    /**\n     * Event emitted when a MIDI port becomes available. This event is typically fired whenever a\n     * MIDI device is plugged in. Please note that it may fire several times if a device possesses\n     * multiple input/output ports.\n     *\n     * @event connected\n     * @param {Object} event\n     * @param {Number} event.timestamp The timestamp when the event occurred (in milliseconds since\n     * the epoch).\n     * @param {String} event.type The type of event that occurred.\n     * @param {String} event.port The actual `Input` or `Output` object associated to the event.\n     */\n\n    /**\n     * Event emitted when a MIDI port becomes unavailable. This event is typically fired whenever a\n     * MIDI device is unplugged. Please note that it may fire several times if a device possesses\n     * multiple input/output ports.\n     *\n     * @event disconnected\n     * @param {Object} event\n     * @param {Number} event.timestamp The timestamp when the event occurred (in milliseconds since\n     * the epoch).\n     * @param {String} event.type The type of event that occurred.\n     * @param {String} event.port An generic object containing details about the port that triggered\n     * the event.\n     */\n    var event = {\n      timestamp: e.timeStamp,\n      type: e.port.state\n    };\n\n    if (this.interface && e.port.state === \"connected\") {\n\n      if (e.port.type === \"output\") {\n        event.port = this.getOutputById(e.port.id);\n      } else if (e.port.type === \"input\") {\n        event.port = this.getInputById(e.port.id);\n      }\n\n    } else {\n\n      event.port = {\n        connection: \"closed\",\n        id: e.port.id,\n        manufacturer: e.port.manufacturer,\n        name: e.port.name,\n        state: e.port.state,\n        type: e.port.type\n      };\n\n    }\n\n    this._userHandlers[e.port.state].forEach(function (handler) {\n      handler(event);\n    });\n\n  };\n\n  /**\n   * @method _resetInterfaceUserHandlers\n   * @static\n   * @protected\n   */\n  WebMidi.prototype._resetInterfaceUserHandlers = function() {\n\n    for (var i = 0; i < this._midiInterfaceEvents.length; i++) {\n      this._userHandlers[this._midiInterfaceEvents[i]] = [];\n    }\n\n  };\n\n  /**\n   * The `Input` object represents a MIDI input port on the host system. This object is created by\n   * the MIDI subsystem and cannot be instantiated directly.\n   *\n   * You will find all available `Input` objects in the `WebMidi.inputs` array.\n   *\n   * @class Input\n   * @param {MIDIInput} midiInput `MIDIInput` object\n   */\n  function Input(midiInput) {\n\n    var that = this;\n\n    // User-defined handlers list\n    this._userHandlers = { channel: {}, system: {} };\n\n    // Reference to the actual MIDIInput object\n    this._midiInput = midiInput;\n\n    Object.defineProperties(this, {\n\n      /**\n       * [read-only] Status of the MIDI port\"s connection (`pending`, `open` or `closed`)\n       *\n       * @property connection\n       * @type String\n       */\n      connection: {\n        enumerable: true,\n        get: function () {\n          return that._midiInput.connection;\n        }\n      },\n\n      /**\n       * [read-only] ID string of the MIDI port. The ID is host-specific. Do not expect the same ID\n       * on different platforms. For example, Google Chrome and the Jazz-Plugin report completely\n       * different IDs for the same port.\n       *\n       * @property id\n       * @type String\n       */\n      id: {\n        enumerable: true,\n        get: function () {\n          return that._midiInput.id;\n        }\n      },\n\n      /**\n       * [read-only] Name of the manufacturer of the device that makes this port available.\n       *\n       * @property manufacturer\n       * @type String\n       */\n      manufacturer: {\n        enumerable: true,\n        get: function () {\n          return that._midiInput.manufacturer;\n        }\n      },\n\n      /**\n       * [read-only] Name of the MIDI port\n       *\n       * @property name\n       * @type String\n       */\n      name: {\n        enumerable: true,\n        get: function () {\n          return that._midiInput.name;\n        }\n      },\n\n      /**\n       * [read-only] State of the MIDI port (`connected` or `disconnected`)\n       *\n       * @property state\n       * @type String\n       */\n      state: {\n        enumerable: true,\n        get: function () {\n          return that._midiInput.state;\n        }\n      },\n\n      /**\n       * [read-only] Type of the MIDI port (`input`)\n       *\n       * @property type\n       * @type String\n       */\n      type: {\n        enumerable: true,\n        get: function () {\n          return that._midiInput.type;\n        }\n      }\n\n    });\n\n    this._initializeUserHandlers();\n    this._midiInput.onmidimessage = this._onMidiMessage.bind(this);\n\n  }\n\n  /**\n   * Adds an event listener to the `Input` that will trigger a function callback when the specified\n   * event happens. The events that are dispatched can be channel-specific or Input-wide.\n   *\n   * Here is a list of events that are dispatched by `Input` objects and that can be listened to.\n   *\n   * Channel-specific MIDI events:\n   *\n   *    * {{#crossLink \"Input/noteoff:event\"}}noteoff{{/crossLink}}\n   *    * {{#crossLink \"Input/noteon:event\"}}noteon{{/crossLink}}\n   *    * {{#crossLink \"Input/keyaftertouch:event\"}}keyaftertouch{{/crossLink}}\n   *    * {{#crossLink \"Input/controlchange:event\"}}controlchange{{/crossLink}}\n   *    * {{#crossLink \"Input/nrpn:event\"}}nrpn{{/crossLink}}\n   *    * {{#crossLink \"Input/channelmode:event\"}}channelmode{{/crossLink}}\n   *    * {{#crossLink \"Input/programchange:event\"}}programchange{{/crossLink}}\n   *    * {{#crossLink \"Input/channelaftertouch:event\"}}channelaftertouch{{/crossLink}}\n   *    * {{#crossLink \"Input/pitchbend:event\"}}pitchbend{{/crossLink}}\n   *\n   * Input-wide MIDI events:\n   *\n   *    * {{#crossLink \"Input/sysex:event\"}}sysex{{/crossLink}}\n   *    * {{#crossLink \"Input/timecode:event\"}}timecode{{/crossLink}}\n   *    * {{#crossLink \"Input/songposition:event\"}}songposition{{/crossLink}}\n   *    * {{#crossLink \"Input/songselect:event\"}}songselect{{/crossLink}}\n   *    * {{#crossLink \"Input/tuningrequest:event\"}}tuningrequest{{/crossLink}}\n   *    * {{#crossLink \"Input/clock:event\"}}clock{{/crossLink}}\n   *    * {{#crossLink \"Input/start:event\"}}start{{/crossLink}}\n   *    * {{#crossLink \"Input/continue:event\"}}continue{{/crossLink}}\n   *    * {{#crossLink \"Input/stop:event\"}}stop{{/crossLink}}\n   *    * {{#crossLink \"Input/activesensing:event\"}}activesensing{{/crossLink}}\n   *    * {{#crossLink \"Input/reset:event\"}}reset{{/crossLink}}\n   *    * {{#crossLink \"Input/midimessage:event\"}}midimessage{{/crossLink}}\n   *    * {{#crossLink \"Input/unknownsystemmessage:event\"}}unknownsystemmessage{{/crossLink}}\n   *\n   * For device-wide events, the `channel` parameter will be silently ignored. You can simply use\n   * `undefined` in that case.\n   *\n   * If you want to view all incoming MIDI traffic, you can listen to the input-wide `midimessage`\n   * event. This event is dispatched for every single message that is received on that input.\n   *\n   * @method addListener\n   * @chainable\n   *\n   * @param type {String} The type of the event.\n   *\n   * @param channel {Number|Array|String} The MIDI channel to listen on (integer between 1 and 16).\n   * You can also specify an array of channel numbers or the value \"all\" (or leave it undefined for\n   * input-wide events).\n   *\n   * @param listener {Function} A callback function to execute when the specified event is detected.\n   * This function will receive an event parameter object. For details on this object\"s properties,\n   * check out the documentation for the various events (links above).\n   *\n   * @throws {RangeError} The \"channel\" parameter is invalid.\n   * @throws {TypeError} The \"listener\" parameter must be a function.\n   * @throws {TypeError} The specified event type is not supported.\n   *\n   * @return {WebMidi} Returns the `WebMidi` object so methods can be chained.\n   */\n  Input.prototype.addListener = function(type, channel, listener) {\n\n    var that = this;\n\n    if (channel === undefined) { channel = \"all\"; }\n    if (!Array.isArray(channel)) { channel = [channel]; }\n\n    // Check if channel entries are valid\n    channel.forEach(function(item){\n      if (item !== \"all\" && !(item >= 1 && item <= 16)) {\n        throw new RangeError(\n          \"The 'channel' parameter is invalid.\"\n        );\n      }\n    });\n\n    if (typeof listener !== \"function\") {\n      throw new TypeError(\"The 'listener' parameter must be a function.\");\n    }\n\n    if (wm.MIDI_SYSTEM_MESSAGES[type] !== undefined) {\n\n      if (!this._userHandlers.system[type]) this._userHandlers.system[type] = [];\n      this._userHandlers.system[type].push(listener);\n\n    } else if (wm.MIDI_CHANNEL_MESSAGES[type] !== undefined) {\n\n      // If \"all\" is present anywhere in the channel array, use all 16 channels\n      if (channel.indexOf(\"all\") > -1) {\n        channel = [];\n        for (var j = 1; j <= 16; j++) { channel.push(j); }\n      }\n\n      if (!this._userHandlers.channel[type]) { this._userHandlers.channel[type] = []; }\n\n      // Push all channel listeners in the array\n      channel.forEach(function(ch){\n\n        if (!that._userHandlers.channel[type][ch]) {\n          that._userHandlers.channel[type][ch] = [];\n        }\n\n        that._userHandlers.channel[type][ch].push(listener);\n\n      });\n\n    } else {\n      throw new TypeError(\"The specified event type is not supported.\");\n    }\n\n    return this;\n\n  };\n\n  /**\n   * This is an alias to the {{#crossLink \"Input/addListener\"}}Input.addListener(){{/crossLink}}\n   * function.\n   *\n   * @method on\n   * @since 2.0.0\n   */\n  Input.prototype.on = Input.prototype.addListener;\n\n  /**\n   * Checks if the specified event type is already defined to trigger the listener function on the\n   * specified channel(s). If more than one channel is specified, the function will return `true`\n   * only if all channels have the listener defined.\n   *\n   * For device-wide events (`sysex`, `start`, etc.), the `channel` parameter is silently ignored.\n   * We suggest you use `undefined` in such cases.\n   *\n   * @method hasListener\n   *\n   * @param type {String} The type of the event.\n   * @param channel {Number|Array|String} The MIDI channel to check on (between 1 and 16). You\n   * can also specify an array of channel numbers or the string \"all\".\n   * @param listener {Function} The callback function to check for.\n   *\n   * @throws {TypeError} The \"listener\" parameter must be a function.\n   *\n   * @return {Boolean} Boolean value indicating whether or not the channel(s) already have this\n   * listener defined.\n   */\n  Input.prototype.hasListener = function(type, channel, listener) {\n\n    var that = this;\n\n    if (typeof listener !== \"function\") {\n      throw new TypeError(\"The 'listener' parameter must be a function.\");\n    }\n\n    if (channel === undefined) { channel = \"all\"; }\n    if (channel.constructor !== Array) { channel = [channel]; }\n\n    if (wm.MIDI_SYSTEM_MESSAGES[type] !== undefined) {\n\n      for (var o = 0; o < this._userHandlers.system[type].length; o++) {\n        if (this._userHandlers.system[type][o] === listener) { return true; }\n      }\n\n    } else if (wm.MIDI_CHANNEL_MESSAGES[type] !== undefined) {\n\n      // If \"all\" is present anywhere in the channel array, use all 16 channels\n      if (channel.indexOf(\"all\") > -1) {\n        channel = [];\n        for (var j = 1; j <= 16; j++) { channel.push(j); }\n      }\n\n      if (!this._userHandlers.channel[type]) { return false; }\n\n      // Go through all specified channels\n      return channel.every(function(chNum) {\n        var listeners = that._userHandlers.channel[type][chNum];\n        return listeners && listeners.indexOf(listener) > -1;\n      });\n\n    }\n\n    return false;\n\n  };\n\n  /**\n   * Removes the specified listener from the specified channel(s). If the `listener` parameter is\n   * left undefined, all listeners for the specified `type` will be removed from all channels. If\n   * the `channel` is also omitted, all listeners of the specified type will be removed from all\n   * channels. If no parameters are defined, all listeners attached to any channel of the `Input`\n   * will be removed.\n   *\n   * For device-wide events (`sysex`, `start`, etc.), the `channel` parameter is silently ignored.\n   * You can use `undefined` in such cases.\n   *\n   * @method removeListener\n   * @chainable\n   *\n   * @param [type] {String} The type of the event.\n   * @param [channel] {Number|String|Array} The MIDI channel(s) to check on. It can be a uint\n   * (between 1 and 16) an array of channel numbers or the special value \"all\".\n   * @param [listener] {Function} The callback function to check for.\n   *\n   * @throws {TypeError} The specified event type is not supported.\n   * @throws {TypeError} The \"listener\" parameter must be a function..\n   *\n   * @return {Input} The `Input` object for easy method chaining.\n   */\n  Input.prototype.removeListener = function(type, channel, listener) {\n\n    var that = this;\n\n    if (listener !== undefined && typeof listener !== \"function\") {\n      throw new TypeError(\"The 'listener' parameter must be a function.\");\n    }\n\n    if (channel === undefined) { channel = \"all\"; }\n    if (channel.constructor !== Array) { channel = [channel]; }\n\n    if (wm.MIDI_SYSTEM_MESSAGES[type] !== undefined) {\n\n      if (listener === undefined) {\n\n        this._userHandlers.system[type] = [];\n\n      } else {\n\n        for (var o = 0; o < this._userHandlers.system[type].length; o++) {\n          if (this._userHandlers.system[type][o] === listener) {\n            this._userHandlers.system[type].splice(o, 1);\n          }\n        }\n\n      }\n\n    } else if (wm.MIDI_CHANNEL_MESSAGES[type] !== undefined) {\n\n      // If \"all\" is present anywhere in the channel array, use all 16 channels\n      if (channel.indexOf(\"all\") > -1) {\n        channel = [];\n        for (var j = 1; j <= 16; j++) { channel.push(j); }\n      }\n\n      if (!this._userHandlers.channel[type]) { return this; }\n\n      // Go through all specified channels\n      channel.forEach(function(chNum) {\n        var listeners = that._userHandlers.channel[type][chNum];\n        if (!listeners) { return; }\n\n        if (listener === undefined) {\n          that._userHandlers.channel[type][chNum] = [];\n        } else {\n          for (var l = 0; l < listeners.length; l++) {\n            if (listeners[l] === listener) { listeners.splice(l, 1); }\n          }\n        }\n\n      });\n\n    } else if (type === undefined) {\n      this._initializeUserHandlers();\n    } else {\n      throw new TypeError(\"The specified event type is not supported.\");\n    }\n\n    return this;\n\n  };\n\n  /**\n   * @method _initializeUserHandlers\n   * @protected\n   */\n  Input.prototype._initializeUserHandlers = function() {\n\n    for (var prop1 in wm.MIDI_CHANNEL_MESSAGES) {\n      if (wm.MIDI_CHANNEL_MESSAGES.hasOwnProperty(prop1)) {\n        this._userHandlers.channel[prop1] = {};\n      }\n    }\n\n    for (var prop2 in wm.MIDI_SYSTEM_MESSAGES) {\n      if (wm.MIDI_SYSTEM_MESSAGES.hasOwnProperty(prop2)) {\n        this._userHandlers.system[prop2] = [];\n      }\n    }\n\n  };\n\n  /**\n   * @method _onMidiMessage\n   * @protected\n   */\n  Input.prototype._onMidiMessage = function(e) {\n\n    // Execute \"midimessage\" listeners (if any)\n    if (this._userHandlers.system[\"midimessage\"].length > 0) {\n\n      var event = {\n        target: this,\n        data: e.data,\n        timestamp: e.timeStamp,\n        type: \"midimessage\"\n      };\n\n      /**\n       * Event emitted when a MIDI message is received. This should be used primarily for debugging\n       * purposes.\n       *\n       * @event midimessage\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {uint} event.timestamp The timestamp when the event occurred (in milliseconds since\n       * the [Unix Epoch](https://en.wikipedia.org/wiki/Unix_time)).\n       * @param {String} event.type The type of event that occurred.\n       * @since 2.1\n       */\n      this._userHandlers.system[\"midimessage\"].forEach(\n        function(callback) { callback(event); }\n      );\n\n    }\n\n    if (e.data[0] < 240) {          // channel-specific message\n      this._parseChannelEvent(e);\n      this._parseNrpnEvent(e);\n    } else if (e.data[0] <= 255) {  // system message\n      this._parseSystemEvent(e);\n    }\n\n  };\n\n  /**\n   * Parses channel events and constructs NRPN message parts in valid sequences.\n   * Keeps a separate NRPN buffer for each channel.\n   * Emits an event after it receives the final CC parts msb 127 lsb 127.\n   * If a message is incomplete and other messages are received before\n   * the final 127 bytes, the incomplete message is cleared.\n   * @method _parseNrpnEvent\n   * @param e Event\n   * @protected\n   */\n  Input.prototype._parseNrpnEvent = function(e) {\n\n    var command = e.data[0] >> 4;\n    var channelBufferIndex = (e.data[0] & 0xf); // use this for index of channel in _nrpnBuffer\n    var channel = channelBufferIndex + 1;\n    var data1, data2;\n\n    if (e.data.length > 1) {\n      data1 = e.data[1];\n      data2 = e.data.length > 2 ? e.data[2] : undefined;\n    }\n\n    // nrpn disabled\n    if(!wm.nrpnEventsEnabled) {\n      return;\n    }\n\n    // nrpn enabled, message not valid for nrpn\n    if(\n      !(\n        command === wm.MIDI_CHANNEL_MESSAGES.controlchange &&\n        (\n          (data1 >= wm.MIDI_NRPN_MESSAGES.increment && data1 <= wm.MIDI_NRPN_MESSAGES.parammsb) ||\n          data1 === wm.MIDI_NRPN_MESSAGES.entrymsb ||\n          data1 === wm.MIDI_NRPN_MESSAGES.entrylsb\n        )\n      )\n    ) {\n      return;\n    }\n\n    // set up a CC event to parse as NRPN part\n    var ccEvent = {\n      target: this,\n      type: \"controlchange\",\n      data: e.data,\n      timestamp: e.timeStamp,\n      channel: channel,\n      controller: {\n        number: data1,\n        name: this.getCcNameByNumber(data1)\n      },\n      value: data2\n    };\n    if(\n      // if we get a starting MSB(CC99 - 0-126) vs an end MSB(CC99 - 127)\n      // destroy inclomplete NRPN and begin building again\n      ccEvent.controller.number === wm.MIDI_NRPN_MESSAGES.parammsb &&\n      ccEvent.value != wm.MIDI_NRPN_MESSAGES.nullactiveparameter\n    ) {\n      wm._nrpnBuffer[channelBufferIndex] = [];\n      wm._nrpnBuffer[channelBufferIndex][0] = ccEvent;\n    } else if(\n      // add the param LSB\n      wm._nrpnBuffer[channelBufferIndex].length === 1 &&\n        ccEvent.controller.number === wm.MIDI_NRPN_MESSAGES.paramlsb\n    ) {\n      wm._nrpnBuffer[channelBufferIndex].push(ccEvent);\n\n    } else if(\n      // add data inc/dec or value MSB for 14bit\n      wm._nrpnBuffer[channelBufferIndex].length === 2 &&\n        (ccEvent.controller.number === wm.MIDI_NRPN_MESSAGES.increment ||\n         ccEvent.controller.number === wm.MIDI_NRPN_MESSAGES.decrement ||\n         ccEvent.controller.number === wm.MIDI_NRPN_MESSAGES.entrymsb)\n    ) {\n      wm._nrpnBuffer[channelBufferIndex].push(ccEvent);\n\n    } else if(\n      // if we have a value MSB, only add an LSB to pair with that\n      wm._nrpnBuffer[channelBufferIndex].length === 3 &&\n        wm._nrpnBuffer[channelBufferIndex][2].number === wm.MIDI_NRPN_MESSAGES.entrymsb &&\n        ccEvent.controller.number === wm.MIDI_NRPN_MESSAGES.entrylsb\n    ) {\n      wm._nrpnBuffer[channelBufferIndex].push(ccEvent);\n\n    } else if(\n      // add an end MSB(CC99 - 127)\n      wm._nrpnBuffer[channelBufferIndex].length >= 3 &&\n      wm._nrpnBuffer[channelBufferIndex].length <= 4 &&\n        ccEvent.controller.number === wm.MIDI_NRPN_MESSAGES.parammsb &&\n        ccEvent.value === wm.MIDI_NRPN_MESSAGES.nullactiveparameter\n    ) {\n      wm._nrpnBuffer[channelBufferIndex].push(ccEvent);\n\n    } else if(\n      // add an end LSB(CC99 - 127)\n      wm._nrpnBuffer[channelBufferIndex].length >= 4 &&\n      wm._nrpnBuffer[channelBufferIndex].length <= 5 &&\n        ccEvent.controller.number === wm.MIDI_NRPN_MESSAGES.paramlsb &&\n        ccEvent.value === wm.MIDI_NRPN_MESSAGES.nullactiveparameter\n    ) {\n      wm._nrpnBuffer[channelBufferIndex].push(ccEvent);\n      // now we have a full inc or dec NRPN message, lets create that event!\n\n      var rawData = [];\n\n      wm._nrpnBuffer[channelBufferIndex].forEach(function(ev) {\n        rawData.push(ev.data);\n      });\n\n      var nrpnNumber = (wm._nrpnBuffer[channelBufferIndex][0].value<<7) |\n        (wm._nrpnBuffer[channelBufferIndex][1].value);\n      var nrpnValue = wm._nrpnBuffer[channelBufferIndex][2].value;\n      if(wm._nrpnBuffer[channelBufferIndex].length === 6) {\n        nrpnValue = (wm._nrpnBuffer[channelBufferIndex][2].value<<7) |\n          (wm._nrpnBuffer[channelBufferIndex][3].value);\n      }\n      var nrpnControllerType = \"\";\n      switch (wm._nrpnBuffer[channelBufferIndex][2].controller.number) {\n      case wm.MIDI_NRPN_MESSAGES.entrymsb:\n        nrpnControllerType = wm._nrpnTypes[0];\n        break;\n      case wm.MIDI_NRPN_MESSAGES.increment:\n        nrpnControllerType = wm._nrpnTypes[1];\n        break;\n      case wm.MIDI_NRPN_MESSAGES.decrement:\n        nrpnControllerType = wm._nrpnTypes[2];\n        break;\n      default:\n        throw new Error(\"The NPRN type was unidentifiable.\");\n      }\n\n      /**\n       * Event emitted when a valid NRPN message sequence has been received on a specific device and\n       * channel.\n       *\n       * @event nrpn\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Array} event.data The raw MIDI message as arrays of 8 bit values( Uint8Array ).\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {uint} event.channel The channel where the event occurred (between 1 and 16).\n       * @param {String} event.type The type of event that occurred.\n       * @param {Object} event.controller\n       * @param {uint} event.controller.number The number of the NRPN.\n       * @param {String} event.controller.name The usual name or function of the controller.\n       * @param {uint} event.value The value received (between 0 and 65535).\n       */\n\n      var nrpnEvent = {\n        timestamp: ccEvent.timestamp,\n        channel: ccEvent.channel,\n        type: \"nrpn\",\n        data: rawData,\n        controller: {\n          number: nrpnNumber,\n          type: nrpnControllerType,\n          name: \"Non-Registered Parameter \" + nrpnNumber\n        },\n        value: nrpnValue\n      };\n\n      // now we are done building an NRPN, so clear the NRPN buffer for this channel\n      wm._nrpnBuffer[channelBufferIndex] = [];\n      // If some callbacks have been defined for this event, on that device and channel, execute\n      // them.\n      if (\n        this._userHandlers.channel[nrpnEvent.type] &&\n        this._userHandlers.channel[nrpnEvent.type][nrpnEvent.channel]\n      ) {\n        this._userHandlers.channel[nrpnEvent.type][nrpnEvent.channel].forEach(\n          function(callback) { callback(nrpnEvent); }\n        );\n      }\n    } else {\n      // something didn't match, clear the incomplete NRPN message by\n      wm._nrpnBuffer[channelBufferIndex] = [];\n    }\n  };\n\n  /**\n   * @method _parseChannelEvent\n   * @param e Event\n   * @protected\n   */\n  Input.prototype._parseChannelEvent = function(e) {\n\n    var command = e.data[0] >> 4;\n    var channel = (e.data[0] & 0xf) + 1;\n    var data1, data2;\n\n    if (e.data.length > 1) {\n      data1 = e.data[1];\n      data2 = e.data.length > 2 ? e.data[2] : undefined;\n    }\n\n    // Returned event\n    var event = {\n      target: this,\n      data: e.data,\n      timestamp: e.timeStamp,\n      channel: channel\n    };\n\n    if (\n      command === wm.MIDI_CHANNEL_MESSAGES.noteoff ||\n      (command === wm.MIDI_CHANNEL_MESSAGES.noteon && data2 === 0)\n    ) {\n\n      /**\n       * Event emitted when a note off MIDI message has been received on a specific device and\n       * channel.\n       *\n       * @event noteoff\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {uint} event.channel The channel where the event occurred (between 1 and 16).\n       * @param {String} event.type The type of event that occurred.\n       * @param {Object} event.note\n       * @param {uint} event.note.number The MIDI note number.\n       * @param {String} event.note.name The usual note name (C, C#, D, D#, etc.).\n       * @param {uint} event.note.octave The octave (between -2 and 8).\n       * @param {Number} event.velocity The release velocity (between 0 and 1).\n       * @param {Number} event.rawVelocity The attack velocity expressed as a 7-bit integer (between\n       * 0 and 127).\n       */\n      event.type = \"noteoff\";\n      event.note = {\n        number: data1,\n        name: wm._notes[data1 % 12],\n        octave: wm.getOctave(data1)\n      };\n      event.velocity = data2 / 127;\n      event.rawVelocity = data2;\n\n    } else if (command === wm.MIDI_CHANNEL_MESSAGES.noteon) {\n\n      /**\n       * Event emitted when a note on MIDI message has been received on a specific device and\n       * channel.\n       *\n       * @event noteon\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {uint} event.channel The channel where the event occurred (between 1 and 16).\n       * @param {String} event.type The type of event that occurred.\n       * @param {Object} event.note\n       * @param {uint} event.note.number The MIDI note number.\n       * @param {String} event.note.name The usual note name (C, C#, D, D#, etc.).\n       * @param {uint} event.note.octave The octave (between -2 and 8).\n       * @param {Number} event.velocity The attack velocity (between 0 and 1).\n       * @param {Number} event.rawVelocity The attack velocity expressed as a 7-bit integer (between\n       * 0 and 127).\n       */\n      event.type = \"noteon\";\n      event.note = {\n        number: data1,\n        name: wm._notes[data1 % 12],\n        octave: wm.getOctave(data1)\n      };\n      event.velocity = data2 / 127;\n      event.rawVelocity = data2;\n\n    } else if (command === wm.MIDI_CHANNEL_MESSAGES.keyaftertouch) {\n\n      /**\n       * Event emitted when a key-specific aftertouch MIDI message has been received on a specific\n       * device and channel.\n       *\n       * @event keyaftertouch\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {uint} event.channel The channel where the event occurred (between 1 and 16).\n       * @param {String} event.type The type of event that occurred.\n       * @param {Object} event.note\n       * @param {uint} event.note.number The MIDI note number.\n       * @param {String} event.note.name The usual note name (C, C#, D, D#, etc.).\n       * @param {uint} event.note.octave The octave (between -2 and 8).\n       * @param {Number} event.value The aftertouch amount (between 0 and 1).\n       */\n      event.type = \"keyaftertouch\";\n      event.note = {\n        number: data1,\n        name: wm._notes[data1 % 12],\n        octave: wm.getOctave(data1)\n      };\n      event.value = data2 / 127;\n\n    } else if (\n      command === wm.MIDI_CHANNEL_MESSAGES.controlchange &&\n      data1 >= 0 && data1 <= 119\n    ) {\n\n      /**\n       * Event emitted when a control change MIDI message has been received on a specific device and\n       * channel.\n       *\n       * @event controlchange\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {uint} event.channel The channel where the event occurred (between 1 and 16).\n       * @param {String} event.type The type of event that occurred.\n       * @param {Object} event.controller\n       * @param {uint} event.controller.number The number of the controller.\n       * @param {String} event.controller.name The usual name or function of the controller.\n       * @param {uint} event.value The value received (between 0 and 127).\n       */\n      event.type = \"controlchange\";\n      event.controller = {\n        number: data1,\n        name: this.getCcNameByNumber(data1)\n      };\n      event.value = data2;\n\n    } else if (\n      command === wm.MIDI_CHANNEL_MESSAGES.channelmode &&\n      data1 >= 120 && data1 <= 127\n    ) {\n\n      /**\n       * Event emitted when a channel mode MIDI message has been received on a specific device and\n       * channel.\n       *\n       * @event channelmode\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {uint} event.channel The channel where the event occurred (between 1 and 16).\n       * @param {String} event.type The type of event that occurred.\n       * @param {Object} event.controller\n       * @param {uint} event.controller.number The number of the controller.\n       * @param {String} event.controller.name The usual name or function of the controller.\n       * @param {uint} event.value The value received (between 0 and 127).\n       */\n      event.type = \"channelmode\";\n      event.controller = {\n        number: data1,\n        name: this.getChannelModeByNumber(data1)\n      };\n      event.value = data2;\n\n    } else if (command === wm.MIDI_CHANNEL_MESSAGES.programchange) {\n\n      /**\n       * Event emitted when a program change MIDI message has been received on a specific device and\n       * channel.\n       *\n       * @event programchange\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {uint} event.channel The channel where the event occurred (between 1 and 16).\n       * @param {String} event.type The type of event that occurred.\n       * @param {uint} event.value The value received (between 0 and 127).\n       */\n      event.type = \"programchange\";\n      event.value = data1;\n\n    } else if (command === wm.MIDI_CHANNEL_MESSAGES.channelaftertouch) {\n\n      /**\n       * Event emitted when a channel-wide aftertouch MIDI message has been received on a specific\n       * device and channel.\n       *\n       * @event channelaftertouch\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {uint} event.channel The channel where the event occurred (between 1 and 16).\n       * @param {String} event.type The type of event that occurred.\n       * @param {Number} event.value The aftertouch value received (between 0 and 1).\n       */\n      event.type = \"channelaftertouch\";\n      event.value = data1 / 127;\n\n    } else if (command === wm.MIDI_CHANNEL_MESSAGES.pitchbend) {\n\n      /**\n       * Event emitted when a pitch bend MIDI message has been received on a specific device and\n       * channel.\n       *\n       * @event pitchbend\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {uint} event.channel The channel where the event occurred (between 1 and 16).\n       * @param {String} event.type The type of event that occurred.\n       * @param {Number} event.value The pitch bend value received (between -1 and 1).\n       */\n      event.type = \"pitchbend\";\n      event.value = ((data2 << 7) + data1 - 8192) / 8192;\n    } else {\n      event.type = \"unknownchannelmessage\";\n    }\n\n    // If some callbacks have been defined for this event, on that device and channel, execute them.\n    if (\n      this._userHandlers.channel[event.type] &&\n      this._userHandlers.channel[event.type][channel]\n    ) {\n\n      this._userHandlers.channel[event.type][channel].forEach(\n        function(callback) { callback(event); }\n      );\n    }\n\n  };\n\n  /**\n   * Returns the name of a control change message matching the specified number. If no match is\n   * found, the function returns `undefined`.\n   *\n   * @method getCcNameByNumber\n   *\n   * @param number {Number} The number of the control change message.\n   * @returns {String|undefined} The matching control change name or `undefined`.\n   *\n   * @throws RangeError The control change number must be between 0 and 119.\n   *\n   * @since 2.0.0\n   */\n  Input.prototype.getCcNameByNumber = function(number) {\n\n    number = Math.floor(number);\n\n    if ( !(number >= 0 && number <= 119) ) {\n      throw new RangeError(\"The control change number must be between 0 and 119.\");\n    }\n\n    for (var cc in wm.MIDI_CONTROL_CHANGE_MESSAGES) {\n\n      if (\n        wm.MIDI_CONTROL_CHANGE_MESSAGES.hasOwnProperty(cc) &&\n        number === wm.MIDI_CONTROL_CHANGE_MESSAGES[cc]\n      ) {\n        return cc;\n      }\n\n    }\n\n    return undefined;\n\n  };\n\n  /**\n   * Returns the channel mode name matching the specified number. If no match is found, the function\n   * returns `undefined`.\n   *\n   * @method getChannelModeByNumber\n   *\n   * @param number {Number} The number of the channel mode message.\n   * @returns {String|undefined} The matching channel mode message\"s name or `undefined`;\n   *\n   * @throws RangeError The channel mode number must be between 120 and 127.\n   *\n   * @since 2.0.0\n   */\n  Input.prototype.getChannelModeByNumber = function(number) {\n\n    number = Math.floor(number);\n\n    if ( !(number >= 120 && status <= 127) ) {\n      throw new RangeError(\"The control change number must be between 120 and 127.\");\n    }\n\n    for (var cm in wm.MIDI_CHANNEL_MODE_MESSAGES) {\n\n      if (\n        wm.MIDI_CHANNEL_MODE_MESSAGES.hasOwnProperty(cm) &&\n        number === wm.MIDI_CHANNEL_MODE_MESSAGES[cm]\n      ) {\n        return cm;\n      }\n\n    }\n\n  };\n\n  /**\n   * @method _parseSystemEvent\n   * @protected\n   */\n  Input.prototype._parseSystemEvent = function(e) {\n\n    var command = e.data[0];\n\n    // Returned event\n    var event = {\n      target: this,\n      data: e.data,\n      timestamp: e.timeStamp\n    };\n\n    if (command === wm.MIDI_SYSTEM_MESSAGES.sysex) {\n\n      /**\n       * Event emitted when a system exclusive MIDI message has been received. You should note that,\n       * to receive `sysex` events, you must call the `WebMidi.enable()` method with a second\n       * parameter set to `true`:\n       *\n       *     WebMidi.enable(function(err) {\n       *\n       *        if (err) {\n       *          console.log(\"WebMidi could not be enabled.\");\n       *        }\n       *\n       *        var input = WebMidi.inputs[0];\n       *\n       *        input.addListener(\"sysex\", \"all\", function (e) {\n       *          console.log(e);\n       *        });\n       *\n       *     }, true);\n       *\n       * @event sysex\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {String} event.type The type of event that occurred.\n       *\n       */\n      event.type = \"sysex\";\n\n    } else if (command === wm.MIDI_SYSTEM_MESSAGES.timecode) {\n\n      /**\n       * Event emitted when a system MIDI time code quarter frame message has been received.\n       *\n       * @event timecode\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {String} event.type The type of event that occurred.\n       */\n      event.type = \"timecode\";\n\n    } else if (command === wm.MIDI_SYSTEM_MESSAGES.songposition) {\n\n      /**\n       * Event emitted when a system song position pointer MIDI message has been received.\n       *\n       * @event songposition\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {String} event.type The type of event that occurred.\n       */\n      event.type = \"songposition\";\n\n    } else if (command === wm.MIDI_SYSTEM_MESSAGES.songselect) {\n\n      /**\n       * Event emitted when a system song select MIDI message has been received.\n       *\n       * @event songselect\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {String} event.type The type of event that occurred.\n       * @param {String} event.song Song (or sequence) number to select.\n       */\n      event.type = \"songselect\";\n      event.song = e.data[1];\n\n    } else if (command === wm.MIDI_SYSTEM_MESSAGES.tuningrequest) {\n\n      /**\n       * Event emitted when a system tune request MIDI message has been received.\n       *\n       * @event tuningrequest\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data     The raw MIDI message as an array of 8 bit\n       *                                    values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {String} event.type         The type of event that occurred.\n       */\n      event.type = \"tuningrequest\";\n\n    } else if (command === wm.MIDI_SYSTEM_MESSAGES.clock) {\n\n      /**\n       * Event emitted when a system timing clock MIDI message has been received.\n       *\n       * @event clock\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data     The raw MIDI message as an array of 8 bit\n       *                                    values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {String} event.type         The type of event that occurred.\n       */\n      event.type = \"clock\";\n\n    } else if (command === wm.MIDI_SYSTEM_MESSAGES.start) {\n\n      /**\n       * Event emitted when a system start MIDI message has been received.\n       *\n       * @event start\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data     The raw MIDI message as an array of 8 bit\n       *                                    values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {String} event.type         The type of event that occurred.\n       */\n      event.type = \"start\";\n\n    } else if (command === wm.MIDI_SYSTEM_MESSAGES.continue) {\n\n      /**\n       * Event emitted when a system continue MIDI message has been received.\n       *\n       * @event continue\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data     The raw MIDI message as an array of 8 bit\n       *                                    values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {String} event.type         The type of event that occurred.\n       */\n      event.type = \"continue\";\n\n    } else if (command === wm.MIDI_SYSTEM_MESSAGES.stop) {\n\n      /**\n       * Event emitted when a system stop MIDI message has been received.\n       *\n       * @event stop\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data     The raw MIDI message as an array of 8 bit\n       *                                    values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {String} event.type         The type of event that occurred.\n       */\n      event.type = \"stop\";\n\n    } else if (command === wm.MIDI_SYSTEM_MESSAGES.activesensing) {\n\n      /**\n       * Event emitted when a system active sensing MIDI message has been received.\n       *\n       * @event activesensing\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data     The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {String} event.type         The type of event that occurred.\n       */\n      event.type = \"activesensing\";\n\n    } else if (command === wm.MIDI_SYSTEM_MESSAGES.reset) {\n\n      /**\n       * Event emitted when a system reset MIDI message has been received.\n       *\n       * @event reset\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data     The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {String} event.type         The type of event that occurred.\n       */\n      event.type = \"reset\";\n\n    } else {\n\n      /**\n       * Event emitted when an unknown system MIDI message has been received. It could be, for\n       * example, one of the undefined/reserved messages.\n       *\n       * @event unknownsystemmessage\n       *\n       * @param {Object} event\n       * @param {Input} event.target The `Input` that triggered the event.\n       * @param {Uint8Array} event.data The raw MIDI message as an array of 8 bit values.\n       * @param {Number} event.timestamp The time when the event occurred (in milliseconds)\n       * @param {String} event.type The type of event that occurred.\n       */\n      event.type = \"unknownsystemmessage\";\n\n    }\n\n    // If some callbacks have been defined for this event, execute them.\n    if (this._userHandlers.system[event.type]) {\n      this._userHandlers.system[event.type].forEach(\n        function(callback) { callback(event); }\n      );\n    }\n\n  };\n\n  /**\n   * The `Output` object represents a MIDI output port on the host system. This object is created by\n   * the MIDI subsystem and cannot be instantiated directly.\n   *\n   * You will find all available `Output` objects in the `WebMidi.outputs` array.\n   *\n   * @class Output\n   * @param {MIDIOutput} midiOutput Actual `MIDIOutput` object as defined by the MIDI subsystem\n   */\n  function Output(midiOutput) {\n\n    var that = this;\n\n    this._midiOutput = midiOutput;\n\n    Object.defineProperties(this, {\n\n      /**\n       * [read-only] Status of the MIDI port\"s connection\n       *\n       * @property connection\n       * @type String\n       */\n      connection: {\n        enumerable: true,\n        get: function () {\n          return that._midiOutput.connection;\n        }\n      },\n\n      /**\n       * [read-only] ID string of the MIDI port\n       *\n       * @property id\n       * @type String\n       */\n      id: {\n        enumerable: true,\n        get: function () {\n          return that._midiOutput.id;\n        }\n      },\n\n      /**\n       * [read-only] Manufacturer of the device to which this port belongs\n       *\n       * @property manufacturer\n       * @type String\n       */\n      manufacturer: {\n        enumerable: true,\n        get: function () {\n          return that._midiOutput.manufacturer;\n        }\n      },\n\n      /**\n       * [read-only] Name of the MIDI port\n       *\n       * @property name\n       * @type String\n       */\n      name: {\n        enumerable: true,\n        get: function () {\n          return that._midiOutput.name;\n        }\n      },\n\n      /**\n       * [read-only] State of the MIDI port\n       *\n       * @property state\n       * @type String\n       */\n      state: {\n        enumerable: true,\n        get: function () {\n          return that._midiOutput.state;\n        }\n      },\n\n      /**\n       * [read-only] Type of the MIDI port (`output`)\n       *\n       * @property state\n       * @type String\n       */\n      type: {\n        enumerable: true,\n        get: function () {\n          return that._midiOutput.type;\n        }\n      }\n\n    });\n\n  }\n\n  /**\n   * Sends a MIDI message on the MIDI output port, at the scheduled timestamp.\n   *\n   * Unless, you are familiar with the details of the MIDI message format, you should not use this\n   * method directly. Instead, use one of the simpler helper methods: `playNote()`, `stopNote()`,\n   * `sendControlChange()`, `sendSystemMessage()`, etc.\n   *\n   * Details on the format of MIDI messages are available in the\n   * <a href=\"http://www.midi.org/techspecs/midimessages.php\">summary of MIDI messages</a> of the\n   * MIDI Manufacturers Association.\n   *\n   * @method send\n   * @chainable\n   *\n   * @param status {Number} The MIDI status byte of the message (128-255).\n   *\n   * @param [data=[]] {Array} An array of uints for the message. The number of data bytes varies\n   * depending on the status byte. It is perfectly legal to send no data for some message types (use\n   * undefined or an empty array in this case). Each byte must be between 0 and 255.\n   *\n   * @param [timestamp=0] {DOMHighResTimeStamp} The timestamp at which to send the message. You can\n   * use `WebMidi.time` to retrieve the current timestamp. To send immediately, leave blank or use\n   * 0.\n   *\n   * @throws {RangeError} The status byte must be an integer between 128 (0x80) and 255 (0xFF).\n   * @throws {RangeError} Data bytes must be integers between 0 (0x00) and 255 (0x7F).\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.send = function(status, data, timestamp) {\n\n    if ( !(status >= 128 && status <= 255) ) {\n      throw new RangeError(\"The status byte must be an integer between 128 (0x80) and 255 (0xFF).\");\n    }\n\n    if (data === undefined) data = [];\n    if ( !Array.isArray(data) ) data = [data];\n\n    var message = [];\n\n    data.forEach(function(item){\n\n      var parsed = Math.floor(item); // mandatory because of \"null\"\n\n      if (parsed >= 0 && parsed <= 255) {\n        message.push(parsed);\n      } else {\n        throw new RangeError(\"Data bytes must be integers between 0 (0x00) and 255 (0xFF).\");\n      }\n\n    });\n\n    this._midiOutput.send([status].concat(message), parseFloat(timestamp) || 0);\n\n    return this;\n\n  };\n\n  /**\n   * Sends a MIDI *system exclusive* (sysex) message. The generated message will automatically be\n   * prepended with the *sysex* byte (0xF0) and terminated with the *end of sysex* byte (0xF7).\n   *\n   * To use the `sendSysex()` method, system exclusive message support must have been enabled. To\n   * do so, you must pass `true` as the second parameter to `WebMidi.enable()`:\n   *\n   *     WebMidi.enable(function (err) {\n   *         if (err) {\n   *             console.warn(err);\n   *         } else {\n   *             console.log(\"Sysex is enabled!\");\n   *         }\n   *     }, true);\n   *\n   * Note that, depending on browser, version and platform, it may be necessary to serve the page\n   * over HTTPS to enable sysex support.\n   *\n   * #### Examples\n   *\n   * If you want to send a sysex message to a Korg device connected to the first output, you would\n   * use the following code:\n   *\n   *     WebMidi.outputs[0].sendSysex(0x42, [0x1, 0x2, 0x3, 0x4, 0x5]);\n   *\n   * The parameters can be specified using any number notation (decimal, hex, binary, etc.).\n   * Therefore, the code below is equivalent to the code above:\n   *\n   *     WebMidi.outputs[0].sendSysex(66, [1, 2, 3, 4, 5]);\n   *\n   * The above code sends the byte values 1, 2, 3, 4 and 5 to Korg devices (hex 42 is the same as\n   * decimal 66).\n   *\n   * Some manufacturers are identified using 3 bytes. In this case, you would use a 3-position array\n   * as the first parameter. For example, to send the same sysex message to a\n   * *Native Instruments* device:\n   *\n   *     WebMidi.outputs[0].sendSysex([0x00, 0x21, 0x09], [0x1, 0x2, 0x3, 0x4, 0x5]);\n   *\n   * There is no limit for the length of the data array. However, it is generally suggested to keep\n   * system exclusive messages to 64Kb or less.\n   *\n   * @method sendSysex\n   * @chainable\n   *\n   * @param manufacturer {Number|Array} An unsigned integer or an array of three unsigned integers\n   * between 0 and 127 that identify the targeted manufacturer. The *MIDI Manufacturers Association*\n   * maintains a full list of\n   * [Manufacturer ID Numbers](https://www.midi.org/specifications/item/manufacturer-id-numbers).\n   *\n   * @param [data=[]] {Array} An array of uints between 0 and 127. This is the data you wish to\n   * transfer.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throw Sysex message support must first be activated.\n   * @throw The data bytes of a sysex message must be integers between 0 (0x00) and 127 (0x7F).\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendSysex = function(manufacturer, data, options) {\n\n    if (!wm.sysexEnabled) {\n      throw new Error(\"Sysex message support must first be activated.\");\n    }\n\n    options = options || {};\n\n    manufacturer = [].concat(manufacturer);\n\n    data.forEach(function(item){\n      if (item < 0 || item > 127) {\n        throw new RangeError(\n          \"The data bytes of a sysex message must be integers between 0 (0x00) and 127 (0x7F).\"\n        );\n      }\n    });\n\n    data = manufacturer.concat(data, wm.MIDI_SYSTEM_MESSAGES.sysexend);\n    this.send(wm.MIDI_SYSTEM_MESSAGES.sysex, data, this._parseTimeParameter(options.time));\n\n    return this;\n\n  };\n\n  /**\n   * Sends a *MIDI Timecode Quarter Frame* message. Please note that no processing is being done on\n   * the data. It is up to the developer to format the data according to the\n   * [MIDI Timecode](https://en.wikipedia.org/wiki/MIDI_timecode) format.\n   *\n   * @method sendTimecodeQuarterFrame\n   * @chainable\n   *\n   * @param value {Number} The quarter frame message content (integer between 0 and 127).\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendTimecodeQuarterFrame = function(value, options) {\n    options = options || {};\n    this.send(wm.MIDI_SYSTEM_MESSAGES.timecode, value, this._parseTimeParameter(options.time));\n    return this;\n  };\n\n  /**\n   * Sends a *Song Position* MIDI message. The value is expressed in MIDI beats (between 0 and\n   * 16383) which are 16th note. Position 0 is always the start of the song.\n   *\n   * @method sendSongPosition\n   * @chainable\n   *\n   * @param [value=0] {Number} The MIDI beat to cue to (int between 0 and 16383).\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendSongPosition = function(value, options) {\n\n    value = Math.floor(value) || 0;\n\n    options = options || {};\n\n    var msb = (value >> 7) & 0x7F;\n    var lsb = value & 0x7F;\n\n    this.send(\n      wm.MIDI_SYSTEM_MESSAGES.songposition,\n      [msb, lsb],\n      this._parseTimeParameter(options.time)\n    );\n    return this;\n\n  };\n\n  /**\n   * Sends a *Song Select* MIDI message. Beware that some devices will display position 0 as\n   * position 1 for user-friendlyness.\n   *\n   * @method sendSongSelect\n   * @chainable\n   *\n   * @param value {Number} The number of the song to select (integer between 0 and 127).\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws The song number must be between 0 and 127.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendSongSelect = function(value, options) {\n\n    value = Math.floor(value);\n\n    options = options || {};\n\n    if ( !(value >= 0 && value <= 127) ) {\n      throw new RangeError(\"The song number must be between 0 and 127.\");\n    }\n\n    this.send(wm.MIDI_SYSTEM_MESSAGES.songselect, [value], this._parseTimeParameter(options.time));\n\n    return this;\n\n  };\n\n  /**\n   * Sends a *MIDI tuning request* real-time message.\n   *\n   * Note: there is currently a bug in Chrome\"s MIDI implementation. If you try to use this\n   * function, Chrome will actually throw a \"Message is incomplete\" error. The bug is\n   * [scheduled to be fixed](https://bugs.chromium.org/p/chromium/issues/detail?id=610116).\n   *\n   * @method sendTuningRequest\n   * @chainable\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendTuningRequest = function(options) {\n    options = options || {};\n    this.send(\n      wm.MIDI_SYSTEM_MESSAGES.tuningrequest,\n      undefined,\n      this._parseTimeParameter(options.time)\n    );\n    return this;\n  };\n\n  /**\n   * Sends a *MIDI Clock* real-time message. According to the standard, there are 24 MIDI Clocks\n   * for every quarter note.\n   *\n   * @method sendClock\n   * @chainable\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendClock = function(options) {\n    options = options || {};\n    this.send(wm.MIDI_SYSTEM_MESSAGES.clock, undefined, this._parseTimeParameter(options.time));\n    return this;\n  };\n\n  /**\n   * Sends a *Start* real-time message. A MIDI Start message starts the playback of the current\n   * song at beat 0. To start playback elsewhere in the song, use the `sendContinue()` function.\n   *\n   * @method sendStart\n   * @chainable\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendStart = function(options) {\n    options = options || {};\n    this.send(wm.MIDI_SYSTEM_MESSAGES.start, undefined, this._parseTimeParameter(options.time));\n    return this;\n  };\n\n  /**\n   * Sends a *Continue* real-time message. This resumes song playback where it was previously\n   * stopped or where it was last cued with a song position message. To start playback from the\n   * start, use the `sendStart()` function.\n   *\n   * @method sendContinue\n   * @chainable\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @return {WebMidi} Returns the `WebMidi` object so methods can be chained.\n   */\n  Output.prototype.sendContinue = function(options) {\n    options = options || {};\n    this.send(wm.MIDI_SYSTEM_MESSAGES.continue, undefined, this._parseTimeParameter(options.time));\n    return this;\n  };\n\n  /**\n   * Sends a *Stop* real-time message. This tells the device connected to this port to stop playback\n   * immediately (or at the scheduled time).\n   *\n   * @method sendStop\n   * @chainable\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendStop = function(options) {\n    options = options || {};\n    this.send(wm.MIDI_SYSTEM_MESSAGES.stop, undefined, this._parseTimeParameter(options.time));\n    return this;\n  };\n\n  /**\n   * Sends an *Active Sensing* real-time message. This tells the device connected to this port that\n   * the connection is still good. Active sensing messages should be sent every 300 ms if there was\n   * no other activity on the MIDI port.\n   *\n   * @method sendActiveSensing\n   * @chainable\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendActiveSensing = function(options) {\n    options = options || {};\n    this.send(\n      wm.MIDI_SYSTEM_MESSAGES.activesensing,\n      [],\n      this._parseTimeParameter(options.time)\n    );\n    return this;\n  };\n\n  /**\n   * Sends *Reset* real-time message. This tells the device connected to this port that is should\n   * reset itself to a default state.\n   *\n   * @method sendReset\n   * @chainable\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendReset = function(options) {\n    options = options || {};\n    this.send(wm.MIDI_SYSTEM_MESSAGES.reset, undefined, this._parseTimeParameter(options.time));\n    return this;\n  };\n\n  /**\n   * Sends a MIDI **note off** message to the specified channel(s) for a single note or multiple\n   * simultaneous notes (chord). You can delay the execution of the **note off** command by using\n   * the `time` property of the `options` parameter (in milliseconds).\n   *\n   * @method stopNote\n   * @chainable\n   *\n   * @param note {Number|Array|String}  The note(s) you wish to stop. The notes can be specified in\n   * one of three ways. The first way is by using the MIDI note number (an integer between `0` and\n   * `127`). The second way is by using the note name followed by the octave (C3, G#4, F-1, Db7).\n   * The octave range should be between -2 and 8. The lowest note is C-2 (MIDI note number 0) and\n   * the highest note is G8 (MIDI note number 127). It is also possible to specify an array of note\n   * numbers and/or names. The final way is to use the special value `all` to send an \"allnotesoff\"\n   * channel message.\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between `1` and `16`) or an\n   * array of channel numbers. If the special value `all` is used (default), the message will be\n   * sent to all 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {Boolean} [options.rawVelocity=false] Controls whether the release velocity is set using\n   * an integer between `0` and `127` (`true`) or a decimal number between `0` and `1` (`false`,\n   * default).\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @param {Number} [options.velocity=0.5] The velocity at which to release the note (between `0`\n   * and `1`). If the `rawVelocity` option is `true`, the value should be specified as an integer\n   * between `0` and `127`. An invalid velocity value will silently trigger the default of `0.5`.\n   * Note that when the first parameter to `stopNote()` is `all`, the release velocity is silently\n   * ignored.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.stopNote = function(note, channel, options) {\n\n    if (note === \"all\") {\n      return this.sendChannelMode(\"allnotesoff\", 0, channel, options);\n    }\n\n    var nVelocity = 64;\n\n    options = options || {};\n\n    if (options.rawVelocity) {\n\n      if (!isNaN(options.velocity) && options.velocity >= 0 && options.velocity <= 127) {\n        nVelocity = options.velocity;\n      }\n\n    } else {\n\n      if (!isNaN(options.velocity) && options.velocity >= 0 && options.velocity <= 1) {\n        nVelocity = options.velocity * 127;\n      }\n\n    }\n\n    // Send note off messages\n    this._convertNoteToArray(note).forEach(function(item) {\n\n      wm.toMIDIChannels(channel).forEach(function(ch) {\n\n        this.send(\n          (wm.MIDI_CHANNEL_MESSAGES.noteoff << 4) + (ch - 1),\n          [item, Math.round(nVelocity)],\n          this._parseTimeParameter(options.time)\n        );\n\n      }.bind(this));\n\n    }.bind(this));\n\n    return this;\n\n  };\n\n  /**\n   * Requests the playback of a single note or multiple notes on the specified channel(s). You can\n   * delay the execution of the **note on** command by using the `time` property of the `options`\n   * parameter (milliseconds).\n   *\n   * If no duration is specified in the `options`, the note will play until a matching **note off**\n   * is sent. If a duration is specified, a **note off** will be automatically sent after said\n   * duration.\n   *\n   * Note: As per the MIDI standard, a **note on** event with a velocity of `0` is considered to be\n   * a **note off**.\n   *\n   * @method playNote\n   * @chainable\n   *\n   * @param note {Number|String|Array}  The note(s) you wish to play. The notes can be specified in\n   * one of two ways. The first way is by using the MIDI note number (an integer between 0 and 127).\n   * The second way is by using the note name followed by the octave (C3, G#4, F-1, Db7). The octave\n   * range should be between -2 and 8. The lowest note is C-2 (MIDI note number 0) and the highest\n   * note is G8 (MIDI note number 127). It is also possible to specify an array of note numbers\n   * and/or names.\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between `1` and `16`) or an\n   * array of channel numbers. If the special value **all** is used (default), the message will be\n   * sent to all 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {Number} [options.duration=undefined] The number of milliseconds (integer) to wait\n   * before sending a matching **note off** event. If left undefined, only a **note on** message is\n   * sent.\n   *\n   * @param {Boolean} [options.rawVelocity=false] Controls whether the attack and release velocities\n   * are set using integers between `0` and `127` (`true`) or a decimal number between `0` and `1`\n   * (`false`, default).\n   *\n   * @param {Number} [options.release=0.5] The velocity at which to release the note (between `0`\n   * and `1`). If the `rawVelocity` option is `true`, the value should be specified as an integer\n   * between `0` and `127`. An invalid velocity value will silently trigger the default of `0.5`.\n   * This is only used with the **note off** event triggered when `options.duration` is set.\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @param {Number} [options.velocity=0.5] The velocity at which to play the note (between `0` and\n   * `1`). If the `rawVelocity` option is `true`, the value should be specified as an integer\n   * between `0` and `127`. An invalid velocity value will silently trigger the default of `0.5`.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.playNote = function(note, channel, options) {\n\n    var time,\n      nVelocity = 64;\n\n    options = options || {};\n\n    if (options.rawVelocity) {\n\n      if (!isNaN(options.velocity) && options.velocity >= 0 && options.velocity <= 127) {\n        nVelocity = options.velocity;\n      }\n\n    } else {\n\n      if (!isNaN(options.velocity) && options.velocity >= 0 && options.velocity <= 1) {\n        nVelocity = options.velocity * 127;\n      }\n\n    }\n\n    time = this._parseTimeParameter(options.time);\n\n    // Send note on messages\n    this._convertNoteToArray(note).forEach(function(item) {\n\n      wm.toMIDIChannels(channel).forEach(function(ch) {\n        this.send(\n          (wm.MIDI_CHANNEL_MESSAGES.noteon << 4) + (ch - 1),\n          [item, Math.round(nVelocity)],\n          time\n        );\n      }.bind(this));\n\n    }.bind(this));\n\n\n    // Send note off messages (only if a valid duration has been defined)\n    if (!isNaN(options.duration)) {\n\n      if (options.duration <= 0) { options.duration = 0; }\n\n      var nRelease = 64;\n\n      if (options.rawVelocity) {\n\n        if (!isNaN(options.release) && options.release >= 0 && options.release <= 127) {\n          nRelease = options.release;\n        }\n\n      } else {\n\n        if (!isNaN(options.release) && options.release >= 0 && options.release <= 1) {\n          nRelease = options.release * 127;\n        }\n\n      }\n\n      this._convertNoteToArray(note).forEach(function(item) {\n\n        wm.toMIDIChannels(channel).forEach(function(ch) {\n\n          this.send(\n            (wm.MIDI_CHANNEL_MESSAGES.noteoff << 4) + (ch - 1),\n            [item, Math.round(nRelease)],\n            (time || wm.time) + options.duration\n          );\n        }.bind(this));\n\n      }.bind(this));\n\n    }\n\n    return this;\n\n  };\n\n  /**\n   * Sends a MIDI `key aftertouch` message to the specified channel(s) at the scheduled time. This\n   * is a key-specific aftertouch. For a channel-wide aftertouch message, use\n   * {{#crossLink \"WebMidi/sendChannelAftertouch:method\"}}sendChannelAftertouch(){{/crossLink}}.\n   *\n   * @method sendKeyAftertouch\n   * @chainable\n   *\n   * @param note {Number|String|Array}  The note for which you are sending an aftertouch value. The\n   * notes can be specified in one of two ways. The first way is by using the MIDI note number (an\n   * integer between 0 and 127). The second way is by using the note name followed by the octave\n   * (C3, G#4, F-1, Db7). The octave range should be between -2 and 8. The lowest note is C-2 (MIDI\n   * note number 0) and the highest note is G8 (MIDI note number 127). It is also possible to use\n   * an array of note names and/or numbers.\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Number} [pressure=0.5] The pressure level to send (between 0 and 1).\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws {RangeError} The channel must be between 1 and 16.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendKeyAftertouch = function(note, channel, pressure, options) {\n\n    var that = this;\n\n    options = options || {};\n\n    if (channel < 1 || channel > 16) {\n      throw new RangeError(\"The channel must be between 1 and 16.\");\n    }\n\n    if (isNaN(pressure) || pressure < 0 || pressure > 1) {\n      pressure = 0.5;\n    }\n\n    var nPressure = Math.round(pressure * 127);\n\n    this._convertNoteToArray(note).forEach(function(item) {\n\n      wm.toMIDIChannels(channel).forEach(function(ch) {\n        that.send(\n          (wm.MIDI_CHANNEL_MESSAGES.keyaftertouch << 4) + (ch - 1),\n          [item, nPressure],\n          that._parseTimeParameter(options.time)\n        );\n      });\n\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Sends a MIDI `control change` message (a.k.a. CC message) to the specified channel(s) at the\n   * scheduled time. The control change message to send can be specified numerically or by using one\n   * of the following common names:\n   *\n   *  * `bankselectcoarse` (#0)\n   *  * `modulationwheelcoarse` (#1)\n   *  * `breathcontrollercoarse` (#2)\n   *  * `footcontrollercoarse` (#4)\n   *  * `portamentotimecoarse` (#5)\n   *  * `dataentrycoarse` (#6)\n   *  * `volumecoarse` (#7)\n   *  * `balancecoarse` (#8)\n   *  * `pancoarse` (#10)\n   *  * `expressioncoarse` (#11)\n   *  * `effectcontrol1coarse` (#12)\n   *  * `effectcontrol2coarse` (#13)\n   *  * `generalpurposeslider1` (#16)\n   *  * `generalpurposeslider2` (#17)\n   *  * `generalpurposeslider3` (#18)\n   *  * `generalpurposeslider4` (#19)\n   *  * `bankselectfine` (#32)\n   *  * `modulationwheelfine` (#33)\n   *  * `breathcontrollerfine` (#34)\n   *  * `footcontrollerfine` (#36)\n   *  * `portamentotimefine` (#37)\n   *  * `dataentryfine` (#38)\n   *  * `volumefine` (#39)\n   *  * `balancefine` (#40)\n   *  * `panfine` (#42)\n   *  * `expressionfine` (#43)\n   *  * `effectcontrol1fine` (#44)\n   *  * `effectcontrol2fine` (#45)\n   *  * `holdpedal` (#64)\n   *  * `portamento` (#65)\n   *  * `sustenutopedal` (#66)\n   *  * `softpedal` (#67)\n   *  * `legatopedal` (#68)\n   *  * `hold2pedal` (#69)\n   *  * `soundvariation` (#70)\n   *  * `resonance` (#71)\n   *  * `soundreleasetime` (#72)\n   *  * `soundattacktime` (#73)\n   *  * `brightness` (#74)\n   *  * `soundcontrol6` (#75)\n   *  * `soundcontrol7` (#76)\n   *  * `soundcontrol8` (#77)\n   *  * `soundcontrol9` (#78)\n   *  * `soundcontrol10` (#79)\n   *  * `generalpurposebutton1` (#80)\n   *  * `generalpurposebutton2` (#81)\n   *  * `generalpurposebutton3` (#82)\n   *  * `generalpurposebutton4` (#83)\n   *  * `reverblevel` (#91)\n   *  * `tremololevel` (#92)\n   *  * `choruslevel` (#93)\n   *  * `celestelevel` (#94)\n   *  * `phaserlevel` (#95)\n   *  * `databuttonincrement` (#96)\n   *  * `databuttondecrement` (#97)\n   *  * `nonregisteredparametercoarse` (#98)\n   *  * `nonregisteredparameterfine` (#99)\n   *  * `registeredparametercoarse` (#100)\n   *  * `registeredparameterfine` (#101)\n   *\n   * Note: as you can see above, not all control change message have a matching common name. This\n   * does not mean you cannot use the others. It simply means you will need to use their number\n   * instead of their name.\n   *\n   * To view a list of all available `control change` messages, please consult \"Table 3 - Control\n   * Change Messages\" from the [MIDI Messages](\n   * https://www.midi.org/specifications/item/table-3-control-change-messages-data-bytes-2)\n   * specification.\n   *\n   * @method sendControlChange\n   * @chainable\n   *\n   * @param controller {Number|String} The MIDI controller number (0-119) or name.\n   *\n   * @param [value=0] {Number} The value to send (0-127).\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws {RangeError} Controller numbers must be between 0 and 119.\n   * @throws {RangeError} Value must be between 0 and 127.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendControlChange = function(controller, value, channel, options) {\n\n    options = options || {};\n\n    if (typeof controller === \"string\") {\n\n      controller = wm.MIDI_CONTROL_CHANGE_MESSAGES[controller];\n      if (controller === undefined) throw new TypeError(\"Invalid controller name.\");\n\n    } else {\n\n      controller = Math.floor(controller);\n      if ( !(controller >= 0 && controller <= 119) ) {\n        throw new RangeError(\"Controller numbers must be between 0 and 119.\");\n      }\n\n    }\n\n    value = Math.floor(value) || 0;\n    if ( !(value >= 0 && value <= 127) ) {\n      throw new RangeError(\"Controller value must be between 0 and 127.\");\n    }\n\n    wm.toMIDIChannels(channel).forEach(function(ch) {\n      this.send(\n        (wm.MIDI_CHANNEL_MESSAGES.controlchange << 4) + (ch - 1),\n        [controller, value],\n        this._parseTimeParameter(options.time)\n      );\n    }.bind(this));\n\n    return this;\n\n  };\n\n  /**\n   * Selects a MIDI registered parameter so it is affected by data entry, data increment and data\n   * decrement messages.\n   *\n   * @method _selectRegisteredParameter\n   * @protected\n   *\n   * @param parameter {Array} A two-position array specifying the two control bytes (0x65, 0x64)\n   * that identify the registered parameter.\n   * @param channel\n   * @param time\n   *\n   * @returns {Output}\n   */\n  Output.prototype._selectRegisteredParameter = function(parameter, channel, time) {\n\n    var that = this;\n\n    parameter[0] = Math.floor(parameter[0]);\n    if ( !(parameter[0] >= 0 && parameter[0] <= 127) ) {\n      throw new RangeError(\"The control65 value must be between 0 and 127\");\n    }\n\n    parameter[1] = Math.floor(parameter[1]);\n    if ( !(parameter[1] >= 0 && parameter[1] <= 127) ) {\n      throw new RangeError(\"The control64 value must be between 0 and 127\");\n    }\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      that.sendControlChange(0x65, parameter[0], channel, {time: time});\n      that.sendControlChange(0x64, parameter[1], channel, {time: time});\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Selects a MIDI non-registered parameter so it is affected by data entry, data increment and\n   * data decrement messages.\n   *\n   * @method _selectNonRegisteredParameter\n   * @protected\n   *\n   * @param parameter {Array} A two-position array specifying the two control bytes (0x63, 0x62)\n   * that identify the registered parameter.\n   * @param channel\n   * @param time\n   *\n   * @returns {Output}\n   */\n  Output.prototype._selectNonRegisteredParameter = function(parameter, channel, time) {\n\n    var that = this;\n\n    parameter[0] = Math.floor(parameter[0]);\n    if ( !(parameter[0] >= 0 && parameter[0] <= 127) ) {\n      throw new RangeError(\"The control63 value must be between 0 and 127\");\n    }\n\n    parameter[1] = Math.floor(parameter[1]);\n    if ( !(parameter[1] >= 0 && parameter[1] <= 127) ) {\n      throw new RangeError(\"The control62 value must be between 0 and 127\");\n    }\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      that.sendControlChange(0x63, parameter[0], channel, {time: time});\n      that.sendControlChange(0x62, parameter[1], channel, {time: time});\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Sets the value of the currently selected MIDI registered parameter.\n   *\n   * @method _setCurrentRegisteredParameter\n   * @protected\n   *\n   * @param data {int|Array}\n   * @param channel\n   * @param time\n   *\n   * @returns {Output}\n   */\n  Output.prototype._setCurrentRegisteredParameter = function(data, channel, time) {\n\n    var that = this;\n\n    data = [].concat(data);\n\n    data[0] = Math.floor(data[0]);\n    if ( !(data[0] >= 0 && data[0] <= 127) ) {\n      throw new RangeError(\"The msb value must be between 0 and 127\");\n    }\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      that.sendControlChange(0x06, data[0], channel, {time: time});\n    });\n\n    data[1] = Math.floor(data[1]);\n    if(data[1] >= 0 && data[1] <= 127) {\n      wm.toMIDIChannels(channel).forEach(function() {\n        that.sendControlChange(0x26, data[1], channel, {time: time});\n      });\n    }\n\n    return this;\n\n  };\n\n  /**\n   * Deselects the currently active MIDI registered parameter so it is no longer affected by data\n   * entry, data increment and data decrement messages.\n   *\n   * Current best practice recommends doing that after each call to\n   * `_setCurrentRegisteredParameter()`.\n   *\n   * @method _deselectRegisteredParameter\n   * @protected\n   *\n   * @param channel\n   * @param time\n   *\n   * @returns {Output}\n   */\n  Output.prototype._deselectRegisteredParameter = function(channel, time) {\n\n    var that = this;\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      that.sendControlChange(0x65, 0x7F, channel, {time: time});\n      that.sendControlChange(0x64, 0x7F, channel, {time: time});\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Sets the specified MIDI registered parameter to the desired value. The value is defined with\n   * up to two bytes of data that each can go from 0 to 127.\n   *\n   * >Unless you are very familiar with the MIDI standard you probably should favour one of the\n   * >simpler to use functions such as: `setPitchbendRange()`, `setModulationRange()`,\n   * >`setMasterTuning()`, etc.\n   *\n   * MIDI registered parameters extend the original list of control change messages. Currently,\n   * there are only a limited number of them. Here are the original registered parameters with the\n   * identifier that can be used as the first parameter of this function:\n   *\n   *  * Pitchbend Range (0x00, 0x00): `pitchbendrange`\n   *  * Channel Fine Tuning (0x00, 0x01): `channelfinetuning`\n   *  * Channel Coarse Tuning (0x00, 0x02): `channelcoarsetuning`\n   *  * Tuning Program (0x00, 0x03): `tuningprogram`\n   *  * Tuning Bank (0x00, 0x04): `tuningbank`\n   *  * Modulation Range (0x00, 0x05): `modulationrange`\n   *\n   * Note that the **Tuning Program** and **Tuning Bank** parameters are part of the *MIDI Tuning\n   * Standard*, which is not widely implemented.\n   *\n   * Another set of extra parameters have been later added for 3D sound controllers. They are:\n   *\n   *  * Azimuth Angle (0x3D, 0x00): `azimuthangle`\n   *  * Elevation Angle (0x3D, 0x01): `elevationangle`\n   *  * Gain (0x3D, 0x02): `gain`\n   *  * Distance Ratio (0x3D, 0x03): `distanceratio`\n   *  * Maximum Distance (0x3D, 0x04): `maximumdistance`\n   *  * Maximum Distance Gain (0x3D, 0x05): `maximumdistancegain`\n   *  * Reference Distance Ratio (0x3D, 0x06): `referencedistanceratio`\n   *  * Pan Spread Angle (0x3D, 0x07): `panspreadangle`\n   *  * Roll Angle (0x3D, 0x08): `rollangle`\n   *\n   * @method setRegisteredParameter\n   * @chainable\n   *\n   * @param parameter {String|Array} A string identifying the parameter\"s name (see above) or a\n   * two-position array specifying the two control bytes (0x65, 0x64) that identify the registered\n   * parameter.\n   *\n   * @param [data=[]] {Number|Array} An single integer or an array of integers with a maximum length\n   * of 2 specifying the desired data.\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @returns {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.setRegisteredParameter = function(parameter, data, channel, options) {\n\n    var that = this;\n\n    options = options || {};\n\n    if ( !Array.isArray(parameter) ) {\n      if ( !wm.MIDI_REGISTERED_PARAMETER[parameter]) {\n        throw new Error(\"The specified parameter is not available.\");\n      }\n      parameter = wm.MIDI_REGISTERED_PARAMETER[parameter];\n    }\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      that._selectRegisteredParameter(parameter, channel, options.time);\n      that._setCurrentRegisteredParameter(data, channel, options.time);\n      that._deselectRegisteredParameter(channel, options.time);\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Sets a non-registered parameter to the specified value. The NRPN is selected by passing in a\n   * two-position array specifying the values of the two control bytes. The value is specified by\n   * passing in an single integer (most cases) or an array of two integers.\n   *\n   * NRPNs are not standardized in any way. Each manufacturer is free to implement them any way\n   * they see fit. For example, according to the Roland GS specification, you can control the\n   * **vibrato rate** using NRPN (1, 8). Therefore, to set the **vibrato rate** value to **123** you\n   * would use:\n   *\n   *     WebMidi.outputs[0].setNonRegisteredParameter([1, 8], 123);\n   *\n   * Obviously, you should select a channel so the message is not sent to all channels. For\n   * instance, to send to channel 1 of the first output port, you would use:\n   *\n   *     WebMidi.outputs[0].setNonRegisteredParameter([1, 8], 123, 1);\n   *\n   * In some rarer cases, you need to send two values with your NRPN messages. In such cases, you\n   * would use a 2-position array. For example, for its **ClockBPM** parameter (2, 63), Novation\n   * uses a 14-bit value that combines an MSB and an LSB (7-bit values). So, for example, if the\n   * value to send was 10, you could use:\n   *\n   *     WebMidi.outputs[0].setNonRegisteredParameter([2, 63], [0, 10]);\n   *\n   * For further implementation details, refer to the manufacturer\"s documentation.\n   *\n   * @method setNonRegisteredParameter\n   * @chainable\n   *\n   * @param parameter {Array} A two-position array specifying the two control bytes (0x63,\n   * 0x62) that identify the non-registered parameter.\n   *\n   * @param [data=[]] {Number|Array} An integer or an array of integers with a length of 1 or 2\n   * specifying the desired data.\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @returns {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.setNonRegisteredParameter = function(parameter, data, channel, options) {\n\n    var that = this;\n\n    options = options || {};\n\n    if (\n      !(parameter[0] >= 0 && parameter[0] <= 127) ||\n      !(parameter[1] >= 0 && parameter[1] <= 127)\n    ) {\n      throw new Error(\n        \"Position 0 and 1 of the 2-position parameter array must both be between 0 and 127.\"\n      );\n    }\n\n    data = [].concat(data);\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      that._selectNonRegisteredParameter(parameter, channel, options.time);\n      that._setCurrentRegisteredParameter(data, channel, options.time);\n      that._deselectRegisteredParameter(channel, options.time);\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Increments the specified MIDI registered parameter by 1. For more specific MIDI usage\n   * information, check out [RP-18](http://dev.midi.org/techspecs/rp18.php) regarding the usage of\n   * increment and decrement controllers.\n   *\n   * >Unless you are very familiar with the MIDI standard you probably should favour one of the\n   * >simpler to use functions such as: `setPitchbendRange()`, `setModulationRange()`,\n   * >`setMasterTuning()`, etc.\n   *\n   * Here is the full list of parameter names that can be used with this function:\n   *\n   *  * Pitchbend Range (0x00, 0x00): `pitchbendrange`\n   *  * Channel Fine Tuning (0x00, 0x01): `channelfinetuning`\n   *  * Channel Coarse Tuning (0x00, 0x02): `channelcoarsetuning`\n   *  * Tuning Program (0x00, 0x03): `tuningprogram`\n   *  * Tuning Bank (0x00, 0x04): `tuningbank`\n   *  * Modulation Range (0x00, 0x05): `modulationrange`\n   *  * Azimuth Angle (0x3D, 0x00): `azimuthangle`\n   *  * Elevation Angle (0x3D, 0x01): `elevationangle`\n   *  * Gain (0x3D, 0x02): `gain`\n   *  * Distance Ratio (0x3D, 0x03): `distanceratio`\n   *  * Maximum Distance (0x3D, 0x04): `maximumdistance`\n   *  * Maximum Distance Gain (0x3D, 0x05): `maximumdistancegain`\n   *  * Reference Distance Ratio (0x3D, 0x06): `referencedistanceratio`\n   *  * Pan Spread Angle (0x3D, 0x07): `panspreadangle`\n   *  * Roll Angle (0x3D, 0x08): `rollangle`\n   *\n   * @method incrementRegisteredParameter\n   * @chainable\n   *\n   * @param parameter {String|Array} A string identifying the parameter\"s name (see above) or a\n   * two-position array specifying the two control bytes (0x65, 0x64) that identify the registered\n   * parameter.\n   *\n   * @param [channel=all] {uint|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws Error The specified parameter is not available.\n   *\n   * @returns {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.incrementRegisteredParameter = function(parameter, channel, options) {\n\n    var that = this;\n\n    options = options || {};\n\n    if ( !Array.isArray(parameter) ) {\n      if ( !wm.MIDI_REGISTERED_PARAMETER[parameter]) {\n        throw new Error(\"The specified parameter is not available.\");\n      }\n      parameter = wm.MIDI_REGISTERED_PARAMETER[parameter];\n    }\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      that._selectRegisteredParameter(parameter, channel, options.time);\n      that.sendControlChange(0x60, 0, channel, {time: options.time});\n      that._deselectRegisteredParameter(channel, options.time);\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Decrements the specified MIDI registered parameter by 1. For more specific MIDI usage\n   * information, check out [RP-18](http://dev.midi.org/techspecs/rp18.php) regarding the usage of\n   * increment and decrement controllers.\n   *\n   * >Unless you are very familiar with the MIDI standard you probably should favour one of the\n   * >simpler to use functions such as: `setPitchbendRange()`, `setModulationRange()`,\n   * >`setMasterTuning()`, etc.\n   *\n   * Here is the full list of parameter names that can be used with this function:\n   *\n   *  * Pitchbend Range (0x00, 0x00): `pitchbendrange`\n   *  * Channel Fine Tuning (0x00, 0x01): `channelfinetuning`\n   *  * Channel Coarse Tuning (0x00, 0x02): `channelcoarsetuning`\n   *  * Tuning Program (0x00, 0x03): `tuningprogram`\n   *  * Tuning Bank (0x00, 0x04): `tuningbank`\n   *  * Modulation Range (0x00, 0x05): `modulationrange`\n   *  * Azimuth Angle (0x3D, 0x00): `azimuthangle`\n   *  * Elevation Angle (0x3D, 0x01): `elevationangle`\n   *  * Gain (0x3D, 0x02): `gain`\n   *  * Distance Ratio (0x3D, 0x03): `distanceratio`\n   *  * Maximum Distance (0x3D, 0x04): `maximumdistance`\n   *  * Maximum Distance Gain (0x3D, 0x05): `maximumdistancegain`\n   *  * Reference Distance Ratio (0x3D, 0x06): `referencedistanceratio`\n   *  * Pan Spread Angle (0x3D, 0x07): `panspreadangle`\n   *  * Roll Angle (0x3D, 0x08): `rollangle`\n   *\n   * @method decrementRegisteredParameter\n   * @chainable\n   *\n   * @param parameter {String|Array} A string identifying the parameter\"s name (see above) or a\n   * two-position array specifying the two control bytes (0x65, 0x64) that identify the registered\n   * parameter.\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws TypeError The specified parameter is not available.\n   *\n   * @returns {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.decrementRegisteredParameter = function(parameter, channel, options) {\n\n    options = options || {};\n\n    if ( !Array.isArray(parameter) ) {\n      if ( !wm.MIDI_REGISTERED_PARAMETER[parameter]) {\n        throw new TypeError(\"The specified parameter is not available.\");\n      }\n      parameter = wm.MIDI_REGISTERED_PARAMETER[parameter];\n    }\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      this._selectRegisteredParameter(parameter, channel, options.time);\n      this.sendControlChange(0x61, 0, channel, {time: options.time});\n      this._deselectRegisteredParameter(channel, options.time);\n    }.bind(this));\n\n    return this;\n\n  };\n\n  /**\n   * Sends a pitch bend range message to the specified channel(s) at the scheduled time so that they\n   * adjust the range used by their pitch bend lever. The range can be specified with the\n   * `semitones` parameter, the `cents` parameter or by specifying both parameters at the same time.\n   *\n   * @method setPitchBendRange\n   * @chainable\n   *\n   * @param [semitones=0] {Number} The desired adjustment value in semitones (integer between\n   * 0-127). While nothing imposes that in the specification, it is very common for manufacturers to\n   * limit the range to 2 octaves (-12 semitones to 12 semitones).\n   *\n   * @param [cents=0] {Number} The desired adjustment value in cents (integer between 0-127).\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws {RangeError} The semitones value must be between 0 and 127.\n   * @throws {RangeError} The cents value must be between 0 and 127.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.setPitchBendRange = function(semitones, cents, channel, options) {\n\n    var that = this;\n\n    options = options || {};\n\n    semitones = Math.floor(semitones) || 0;\n    if ( !(semitones >= 0 && semitones <= 127) ) {\n      throw new RangeError(\"The semitones value must be between 0 and 127\");\n    }\n\n    cents = Math.floor(cents) || 0;\n    if ( !(cents >= 0 && cents <= 127) ) {\n      throw new RangeError(\"The cents value must be between 0 and 127\");\n    }\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      that.setRegisteredParameter(\n        \"pitchbendrange\", [semitones, cents], channel, {time: options.time}\n      );\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Sends a modulation depth range message to the specified channel(s) so that they adjust the\n   * depth of their modulation wheel\"s range. The range can be specified with the `semitones`\n   * parameter, the `cents` parameter or by specifying both parameters at the same time.\n   *\n   * @method setModulationRange\n   * @chainable\n   *\n   * @param [semitones=0] {Number} The desired adjustment value in semitones (integer between\n   * 0-127).\n   *\n   * @param [cents=0] {Number} The desired adjustment value in cents (0-127).\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws {RangeError} The semitones value must be between 0 and 127.\n   * @throws {RangeError} The cents value must be between 0 and 127.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.setModulationRange = function(semitones, cents, channel, options) {\n\n    var that = this;\n\n    options = options || {};\n\n    semitones = Math.floor(semitones) || 0;\n    if ( !(semitones >= 0 && semitones <= 127) ) {\n      throw new RangeError(\"The semitones value must be between 0 and 127\");\n    }\n\n    cents = Math.floor(cents) || 0;\n    if ( !(cents >= 0 && cents <= 127) ) {\n      throw new RangeError(\"The cents value must be between 0 and 127\");\n    }\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      that.setRegisteredParameter(\n        \"modulationrange\", [semitones, cents], channel, {time: options.time}\n      );\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Sends a master tuning message to the specified channel(s). The value is decimal and must be\n   * larger than -65 semitones and smaller than 64 semitones.\n   *\n   * >Because of the way the MIDI specification works, the decimal portion of the value will be\n   * >encoded with a resolution of 14bit. The integer portion must be between -64 and 63\n   * >inclusively. For those familiar with the MIDI protocol, this function actually generates\n   * >**Master Coarse Tuning** and **Master Fine Tuning** RPN messages.\n   *\n   * @method setMasterTuning\n   * @chainable\n   *\n   * @param [value=0.0] {Number} The desired decimal adjustment value in semitones (-65 < x < 64)\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws {RangeError} The value must be a decimal number between larger than -65 and smaller\n   * than 64.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.setMasterTuning = function(value, channel, options) {\n\n    var that = this;\n\n    options = options || {};\n\n    value = parseFloat(value) || 0.0;\n\n    if (value <= -65 || value >= 64) {\n      throw new RangeError(\n        \"The value must be a decimal number larger than -65 and smaller than 64.\"\n      );\n    }\n\n    var coarse = Math.floor(value) + 64;\n    var fine = value - Math.floor(value);\n\n    // Calculate MSB and LSB for fine adjustment (14bit resolution)\n    fine = Math.round((fine + 1) / 2 * 16383);\n    var msb = (fine >> 7) & 0x7F;\n    var lsb = fine & 0x7F;\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      that.setRegisteredParameter(\"channelcoarsetuning\", coarse, channel, {time: options.time});\n      that.setRegisteredParameter(\"channelfinetuning\", [msb, lsb], channel, {time: options.time});\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Sets the MIDI tuning program to use. Note that the **Tuning Program** parameter is part of the\n   * *MIDI Tuning Standard*, which is not widely implemented.\n   *\n   * @method setTuningProgram\n   * @chainable\n   *\n   * @param value {Number} The desired tuning program (0-127).\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws {RangeError} The program value must be between 0 and 127.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.setTuningProgram = function(value, channel, options) {\n\n    var that = this;\n\n    options = options || {};\n\n    value = Math.floor(value);\n    if ( !(value >= 0 && value <= 127) ) {\n      throw new RangeError(\"The program value must be between 0 and 127\");\n    }\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      that.setRegisteredParameter(\"tuningprogram\", value, channel, {time: options.time});\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Sets the MIDI tuning bank to use. Note that the **Tuning Bank** parameter is part of the\n   * *MIDI Tuning Standard*, which is not widely implemented.\n   *\n   * @method setTuningBank\n   * @chainable\n   *\n   * @param value {Number} The desired tuning bank (0-127).\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws {RangeError} The bank value must be between 0 and 127.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.setTuningBank = function(value, channel, options) {\n\n    var that = this;\n\n    options = options || {};\n\n    value = Math.floor(value) || 0;\n    if ( !(value >= 0 && value <= 127) ) {\n      throw new RangeError(\"The bank value must be between 0 and 127\");\n    }\n\n    wm.toMIDIChannels(channel).forEach(function() {\n      that.setRegisteredParameter(\"tuningbank\", value, channel, {time: options.time});\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Sends a MIDI `channel mode` message to the specified channel(s). The channel mode message to\n   * send can be specified numerically or by using one of the following common names:\n   *\n   *   * `allsoundoff` (#120)\n   *   * `resetallcontrollers` (#121)\n   *   * `localcontrol` (#122)\n   *   * `allnotesoff` (#123)\n   *   * `omnimodeoff` (#124)\n   *   * `omnimodeon` (#125)\n   *   * `monomodeon` (#126)\n   *   * `polymodeon` (#127)\n   *\n   * It should be noted that, per the MIDI specification, only `localcontrol` and `monomodeon` may\n   * require a value that\"s not zero. For that reason, the `value` parameter is optional and\n   * defaults to 0.\n   *\n   * @method sendChannelMode\n   * @chainable\n   *\n   * @param command {Number|String} The numerical identifier of the channel mode message (integer\n   * between 120-127) or its name as a string.\n   * @param [value=0] {Number} The value to send (integer between 0-127).\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   * @param {Object} [options={}]\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws {TypeError} Invalid channel mode message name.\n   * @throws {RangeError} Channel mode controller numbers must be between 120 and 127.\n   * @throws {RangeError} Value must be an integer between 0 and 127.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   *\n   */\n  Output.prototype.sendChannelMode = function(command, value, channel, options) {\n\n    options = options || {};\n\n    if (typeof command === \"string\") {\n\n      command = wm.MIDI_CHANNEL_MODE_MESSAGES[command];\n\n      if (!command) {\n        throw new TypeError(\"Invalid channel mode message name.\");\n      }\n\n    } else {\n\n      command = Math.floor(command);\n\n      if ( !(command >= 120 && command <= 127) ) {\n        throw new RangeError(\"Channel mode numerical identifiers must be between 120 and 127.\");\n      }\n\n    }\n\n    value = Math.floor(value) || 0;\n\n    if (value < 0 || value > 127) {\n      throw new RangeError(\"Value must be an integer between 0 and 127.\");\n    }\n\n    wm.toMIDIChannels(channel).forEach(function(ch) {\n\n      this.send(\n        (wm.MIDI_CHANNEL_MESSAGES.channelmode << 4) + (ch - 1),\n        [command, value],\n        this._parseTimeParameter(options.time)\n      );\n\n    }.bind(this));\n\n    return this;\n\n  };\n\n  /**\n   * Sends a MIDI `program change` message to the specified channel(s) at the scheduled time.\n   *\n   * @method sendProgramChange\n   * @chainable\n   *\n   * @param program {Number} The MIDI patch (program) number (0-127)\n   *\n   * @param [channel=all] {Number|Array|String} The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws {RangeError} Program numbers must be between 0 and 127.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   *\n   */\n  Output.prototype.sendProgramChange = function(program, channel, options) {\n\n    var that = this;\n\n    options = options || {};\n\n    program = Math.floor(program);\n    if (isNaN(program) || program < 0 || program > 127) {\n      throw new RangeError(\"Program numbers must be between 0 and 127.\");\n    }\n\n    wm.toMIDIChannels(channel).forEach(function(ch) {\n      that.send(\n        (wm.MIDI_CHANNEL_MESSAGES.programchange << 4) + (ch - 1),\n        [program],\n        that._parseTimeParameter(options.time)\n      );\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Sends a MIDI `channel aftertouch` message to the specified channel(s). For key-specific\n   * aftertouch, you should instead use `sendKeyAftertouch()`.\n   *\n   * @method sendChannelAftertouch\n   * @chainable\n   *\n   * @param [pressure=0.5] {Number} The pressure level (between 0 and 1). An invalid pressure value\n   * will silently trigger the default behaviour.\n   *\n   * @param [channel=all] {Number|Array|String}  The MIDI channel number (between 1 and 16) or\n   * an array of channel numbers. If the special value \"all\" is used, the message will be sent to\n   * all 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendChannelAftertouch = function(pressure, channel, options) {\n\n    var that = this;\n\n    options = options || {};\n\n    pressure = parseFloat(pressure);\n    if (isNaN(pressure) || pressure < 0 || pressure > 1) { pressure = 0.5; }\n\n    var nPressure = Math.round(pressure * 127);\n\n    wm.toMIDIChannels(channel).forEach(function(ch) {\n      that.send(\n        (wm.MIDI_CHANNEL_MESSAGES.channelaftertouch << 4) + (ch - 1),\n        [nPressure],\n        that._parseTimeParameter(options.time)\n      );\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Sends a MIDI `pitch bend` message to the specified channel(s) at the scheduled time.\n   *\n   * @method sendPitchBend\n   * @chainable\n   *\n   * @param bend {Number} The intensity level of the bend (between -1 and 1). A value of zero means\n   * no bend.\n   *\n   * @param [channel=all] {Number|Array|String}  The MIDI channel number (between 1 and 16) or an\n   * array of channel numbers. If the special value \"all\" is used, the message will be sent to all\n   * 16 channels.\n   *\n   * @param {Object} [options={}]\n   *\n   * @param {DOMHighResTimeStamp|String} [options.time=undefined] This value can be one of two\n   * things. If the value is a string starting with the + sign and followed by a number, the request\n   * will be delayed by the specified number (in milliseconds). Otherwise, the value is considered a\n   * timestamp and the request will be scheduled at that timestamp. The `DOMHighResTimeStamp` value\n   * is relative to the navigation start of the document. To retrieve the current time, you can use\n   * `WebMidi.time`. If `time` is not present or is set to a time in the past, the request is to be\n   * sent as soon as possible.\n   *\n   * @throws {RangeError} Pitch bend value must be between -1 and 1.\n   *\n   * @return {Output} Returns the `Output` object so methods can be chained.\n   */\n  Output.prototype.sendPitchBend = function(bend, channel, options) {\n\n    var that = this;\n\n    options = options || {};\n\n    if (isNaN(bend) || bend < -1 || bend > 1) {\n      throw new RangeError(\"Pitch bend value must be between -1 and 1.\");\n    }\n\n    var nLevel = Math.round((bend + 1) / 2 * 16383);\n    var msb = (nLevel >> 7) & 0x7F;\n    var lsb = nLevel & 0x7F;\n\n    wm.toMIDIChannels(channel).forEach(function(ch) {\n      that.send(\n        (wm.MIDI_CHANNEL_MESSAGES.pitchbend << 4) + (ch - 1),\n        [lsb, msb],\n        that._parseTimeParameter(options.time)\n      );\n    });\n\n    return this;\n\n  };\n\n  /**\n   * Returns a timestamp, relative to the navigation start of the document, derived from the `time`\n   * parameter. If the parameter is a string starting with the \"+\" sign and followed by a number,\n   * the resulting value will be the sum of the current timestamp plus that number. Otherwise, the\n   * value will be returned as is.\n   *\n   * If the calculated return value is 0, less than zero or an otherwise invalid value, `undefined`\n   * will be returned.\n   *\n   * @method _parseTimeParameter\n   * @param [time] {Number|String}\n   * @return DOMHighResTimeStamp\n   * @protected\n   */\n  Output.prototype._parseTimeParameter = function(time) {\n\n    var value,\n      parsed = parseFloat(time);\n\n    if (typeof time === \"string\" && time.substring(0, 1) === \"+\") {\n      if (parsed && parsed > 0) value = wm.time + parsed;\n    } else {\n      if (parsed > wm.time) value = parsed;\n    }\n\n    return value;\n\n  };\n\n  /**\n   * Converts an input value (which can be a uint, a string or an array of the previous two) to an\n   * array of MIDI note numbers.\n   *\n   * @method _convertNoteToArray\n   * @param [note] {Number|Array|String}\n   * @returns {Array}\n   * @protected\n   */\n  Output.prototype._convertNoteToArray = function(note) {\n\n    var notes = [];\n\n    if ( !Array.isArray(note) ) { note = [note]; }\n\n    note.forEach(function(item) {\n      notes.push(wm.guessNoteNumber(item));\n    });\n\n    return notes;\n\n  };\n\n  // Check if RequireJS/AMD is used. If it is, use it to define our module instead of\n  // polluting the global space.\n  if ( typeof define === \"function\" && typeof define.amd === \"object\") {\n    define([], function () {\n      return wm;\n    });\n  } else if (typeof module !== \"undefined\" && module.exports) {\n    module.exports = wm;\n  } else {\n    if (!scope.WebMidi) { scope.WebMidi = wm; }\n  }\n\n}(this));\n"]}]}